var O1e=Object.defineProperty,M1e=Object.defineProperties;var P1e=Object.getOwnPropertyDescriptors;var gO=Object.getOwnPropertySymbols;var Zq=Object.prototype.hasOwnProperty,Qq=Object.prototype.propertyIsEnumerable;var Yq=(e,t,i)=>t in e?O1e(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,I=(e,t)=>{for(var i in t||(t={}))Zq.call(t,i)&&Yq(e,i,t[i]);if(gO)for(var i of gO(t))Qq.call(t,i)&&Yq(e,i,t[i]);return e},me=(e,t)=>M1e(e,P1e(t));var n4=(e,t)=>{var i={};for(var r in e)Zq.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(e!=null&&gO)for(var r of gO(e))t.indexOf(r)<0&&Qq.call(e,r)&&(i[r]=e[r]);return i};function u(e,t,i,r){var s,n=arguments.length,o=n<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,i):r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}var Jq,Kq;let Hf;var eW,tW;(Jq=globalThis.dojoConfig)!=null&&Jq.has||(Kq=globalThis.esriConfig)!=null&&Kq.has?Hf=I(I({},(eW=globalThis.dojoConfig)==null?void 0:eW.has),(tW=globalThis.esriConfig)==null?void 0:tW.has):Hf={};function ue(e){return typeof Hf[e]=="function"?Hf[e]=Hf[e](globalThis):Hf[e]}ue.add=(e,t,i,r)=>((r||Hf[e]===void 0)&&(Hf[e]=t),i&&ue(e)),ue.cache=Hf,ue.add("esri-deprecation-warnings",!0),(()=>{var e;ue.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const t=typeof window!="undefined"&&typeof location!="undefined"&&typeof document!="undefined"&&window.location===location&&window.document===document;if(ue.add("host-browser",t),ue.add("host-node",typeof globalThis.process=="object"&&((e=globalThis.process.versions)==null?void 0:e.node)&&globalThis.process.versions.v8),ue.add("dom",t),ue("host-browser")){const i=navigator,r=i.userAgent,s=i.appVersion,n=parseFloat(s);if(ue.add("wp",parseFloat(r.split("Windows Phone")[1])||void 0),ue.add("msapp",parseFloat(r.split("MSAppHost/")[1])||void 0),ue.add("khtml",s.includes("Konqueror")?n:void 0),ue.add("edge",parseFloat(r.split("Edge/")[1])||void 0),ue.add("opr",parseFloat(r.split("OPR/")[1])||void 0),ue.add("webkit",!ue("wp")&&!ue("edge")&&parseFloat(r.split("WebKit/")[1])||void 0),ue.add("chrome",!ue("edge")&&!ue("opr")&&parseFloat(r.split("Chrome/")[1])||void 0),ue.add("android",!ue("wp")&&parseFloat(r.split("Android ")[1])||void 0),ue.add("safari",!s.includes("Safari")||ue("wp")||ue("chrome")||ue("android")||ue("edge")||ue("opr")?void 0:parseFloat(s.split("Version/")[1])),ue.add("mac",s.includes("Macintosh")),!ue("wp")&&r.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=r.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));ue.add(o,l),ue.add("ios",l)}ue.add("trident",parseFloat(s.split("Trident/")[1])||void 0),ue("webkit")||(!r.includes("Gecko")||ue("wp")||ue("khtml")||ue("trident")||ue("edge")||ue.add("mozilla",n),ue("mozilla")&&ue.add("ff",parseFloat(r.split("Firefox/")[1]||r.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const e=navigator.userAgent,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(e),i=/iPhone/i.test(e);t&&ue.add("esri-mobile",t),i&&ue.add("esri-iPhone",i),ue.add("esri-geolocation",!!navigator.geolocation)}ue.add("esri-canvas-svg-support",!ue("trident")),ue.add("esri-wasm","WebAssembly"in globalThis),ue.add("esri-shared-array-buffer",()=>{const e="SharedArrayBuffer"in globalThis,t=globalThis.crossOriginIsolated===!1;return e&&!t}),ue.add("esri-atomics","Atomics"in globalThis),ue.add("esri-workers","Worker"in globalThis),ue.add("web-feat:cache","caches"in globalThis),ue.add("esri-workers-arraybuffer-transfer",!ue("safari")||Number(ue("safari"))>=12),ue.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),ue.add("featurelayer-simplify-payload-size-factors",[1,1,4]),ue.add("featurelayer-snapshot-enabled",!0),ue.add("featurelayer-snapshot-point-min-threshold",8e4),ue.add("featurelayer-snapshot-point-max-threshold",4e5),ue.add("featurelayer-snapshot-point-coverage",.1),ue.add("featurelayer-advanced-symbols",!1),ue.add("featurelayer-pbf",!0),ue.add("featurelayer-pbf-statistics",!1),ue.add("feature-layers-workers",!0),ue.add("feature-polyline-generalization-factor",1),ue.add("mapview-transitions-duration",200),ue.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),ue.add("mapserver-pbf-enabled",!1),ue("host-webworker")||ue("host-browser")&&(ue.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),ue.add("esri-image-decode",()=>{if("decode"in new Image){const e=new Image;return e.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void e.decode().then(()=>{ue.add("esri-image-decode",!0,!0,!0)}).catch(()=>{ue.add("esri-image-decode",!1,!0,!0)})}return!1}),ue.add("esri-url-encodes-apostrophe",()=>{const e=window.document.createElement("a");return e.href="?'",e.href.includes("?%27")}))})();const iW=new Set;function I1e(e,t,i=!1){i&&iW.has(t)||(i&&iW.add(t),e.warn(`\u{1F6D1} DEPRECATED - ${t}`))}function tw(e,t,i={}){if(ue("esri-deprecation-warnings")){const{moduleName:r}=i;jx(e,`Function: ${(r?r+"::":"")+t+"()"}`,i)}}function $1e(e,t,i={}){if(ue("esri-deprecation-warnings")){const{moduleName:r}=i;jx(e,`Property: ${(r?r+"::":"")+t}`,i)}}function jx(e,t,i={}){if(ue("esri-deprecation-warnings")){const{replacement:r,version:s,see:n,warnOnce:o}=i;let a=t;r&&(a+=`
	\u{1F6E0}\uFE0F Replacement: ${r}`),s&&(a+=`
	\u2699\uFE0F Version: ${s}`),n&&(a+=`
	\u{1F517} See ${n} for more details.`),I1e(e,a,o)}}const Tg=null;function _(e){return e!=null}function O(e){return e==null}function Sut(e){return e===void 0}function oo(e,t){return _(e)?t(e):Tg}function Eut(e){return e}function D1e(e,t){if(O(e))throw new Error(t);return e}function gt(e,t){return _(e)?e:typeof t=="function"?t():t}function Aut(e,t){return _(e)?e:t}function it(e){return _(e)&&e.destroy(),null}function et(e){return _(e)&&e.dispose(),null}function Ys(e){return _(e)&&e.remove(),null}function xu(e){return _(e)&&e.abort(),null}function Wi(e){return _(e)&&e.release(),null}function Cut(e,t){return _(e)&&_(t)?e.equals(t):e===t}function L1e(e){return null}function Rut(e,t){const i=new Array;return e.forEach(r=>{const s=t(r);_(s)&&i.push(s)}),i}function Out(e,t){const i=new Array;for(const r of e)i.push(Qa(r,null,t));return i}function Mut(e,t){for(const i of e)oo(i,t)}function Qa(e,t,i){return _(e)?i(e):t}function Put(e){return e.filter(t=>_(t))}function bs(e,...t){let i=e;for(let r=0;r<t.length&&i;++r)i=i[t[r]];return i}function Iut(e){return e}class nu{constructor(t=1){this._seed=t}set seed(t){this._seed=t==null?Math.random()*nu._m:t}getInt(){return this._seed=(nu._a*this._seed+nu._c)%nu._m,this._seed}getFloat(){return this.getInt()/(nu._m-1)}getIntRange(t,i){return Math.round(this.getFloatRange(t,i))}getFloatRange(t,i){const r=i-t;return t+this.getInt()/nu._m*r}}nu._m=2147483647,nu._a=48271,nu._c=0;function wL(e,t){return t?e.filter((i,r,s)=>s.findIndex(t.bind(null,i))===r):e.filter((i,r,s)=>s.indexOf(i)===r)}function J_(e,t,i){if(O(e)&&O(t))return!0;if(O(e)||O(t)||e.length!==t.length)return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function N1e(e,t,i){let r,s;return i?(r=t.filter(n=>!e.some(o=>i(o,n))),s=e.filter(n=>!t.some(o=>i(o,n)))):(r=t.filter(n=>!e.includes(n)),s=e.filter(n=>!t.includes(n))),{added:r,removed:s}}function F1e(e){return e&&typeof e.length=="number"}function $ut(e,t){const i=e.length;if(i===0)return[];const r=[];for(let s=0;s<i;s+=t)r.push(e.slice(s,s+t));return r}const U1e=!!Array.prototype.fill;function Dut(e,t){if(U1e)return new Array(e).fill(t);const i=new Array(e);for(let r=0;r<e;r++)i[r]=t;return i}function k1e(e,t){t===void 0&&(t=e,e=0);const i=new Array(t-e);for(let r=e;r<t;r++)i[r-e]=r;return i}function z1e(e,t,i){const r=e.length;let s=0,n=r-1;for(;s<n;){const a=s+Math.floor((n-s)/2);t>e[a]?s=a+1:n=a}const o=e[s];return i?t>=e[r-1]?-1:o===t?s:s-1:o===t?s:-1}function Lut(e){return e.reduce((t,i)=>t.concat(i||[]),[])}class ese{constructor(){this.last=0}}const tse=new ese;function ise(e,t,i,r){r=r||tse;const s=Math.max(0,r.last-10);for(let o=s;o<i;++o)if(e[o]===t)return r.last=o,o;const n=Math.min(s,i);for(let o=0;o<n;++o)if(e[o]===t)return r.last=o,o;return-1}function xL(e,t,i,r){const s=i==null?e.length:i,n=ise(e,t,s,r);if(n!==-1)return e[n]=e[s-1],i==null&&e.pop(),t}const Lu=new Set;function B1e(e,t,i=e.length,r=t.length,s,n){if(r===0||i===0)return i;Lu.clear();for(let a=0;a<r;++a)Lu.add(t[a]);s=s||tse;const o=Math.max(0,s.last-10);for(let a=o;a<i;++a)if(Lu.has(e[a])&&(n&&n.push(e[a]),Lu.delete(e[a]),e[a]=e[i-1],--i,--a,Lu.size===0||i===0))return Lu.clear(),i;for(let a=0;a<o;++a)if(Lu.has(e[a])&&(n&&n.push(e[a]),Lu.delete(e[a]),e[a]=e[i-1],--i,--a,Lu.size===0||i===0))return Lu.clear(),i;return Lu.clear(),i}function V1e(e){return e?(rW.seed=e,()=>rW.getFloat()):Math.random}function Nut(e,t){const i=V1e(t);for(let r=e.length-1;r>0;r--){const s=Math.floor(i()*(r+1)),n=e[r];e[r]=e[s],e[s]=n}return e}const rW=new nu;function I9(e,t){const i=e.indexOf(t);return i!==-1?(e.splice(i,1),t):null}function G1e(e,t){if(e.forEach)e.forEach(t);else for(let i=0;i<e.length;i++)t(e[i],i,e)}function $9(e,t,i){if(e.slice)return e.slice(t,i);t===void 0?t=0:(t<0&&(t+=e.length),t=Math.min(e.length,Math.max(0,t))),i===void 0?i=e.length:(i<0&&(i+=e.length),i=Math.min(e.length,Math.max(0,i)));const r=Math.max(0,i-t),s=new e.constructor(r);for(let n=0;n<r;n++)s[n]=e[t+n];return s}function RS(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}function j1e(e){return e instanceof Int8Array||e&&e.constructor&&e.constructor.name==="Int8Array"}function a_(e){return e instanceof Uint8Array||e&&e.constructor&&e.constructor.name==="Uint8Array"}function H1e(e){return e instanceof Uint8ClampedArray||e&&e.constructor&&e.constructor.name==="Uint8ClampedArray"}function q1e(e){return e instanceof Int16Array||e&&e.constructor&&e.constructor.name==="Int16Array"}function r$(e){return e instanceof Uint16Array||e&&e.constructor&&e.constructor.name==="Uint16Array"}function W1e(e){return e instanceof Int32Array||e&&e.constructor&&e.constructor.name==="Int32Array"}function s$(e){return e instanceof Uint32Array||e&&e.constructor&&e.constructor.name==="Uint32Array"}function rse(e){return e instanceof Float32Array||e&&e.constructor&&e.constructor.name==="Float32Array"}function sse(e){return e instanceof Float64Array||e&&e.constructor&&e.constructor.name==="Float64Array"}function X1e(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}function yO(e){return O(e)?0:128+e.buffer.byteLength+64}function nse(e,t){let i;if(t)for(i in e)e.hasOwnProperty(i)&&(e[i]===void 0?delete e[i]:e[i]instanceof Object&&nse(e[i],!0));else for(i in e)e.hasOwnProperty(i)&&e[i]===void 0&&delete e[i];return e}function se(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=cse(e);if(_(t))return t;if(ose(e))return e.clone();if(ase(e))return e.map(se);if(lse(e))return e.clone();const i={};for(const r of Object.getOwnPropertyNames(e))i[r]=se(e[r]);return i}function Wk(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=cse(e);if(_(t))return t;if(ase(e)){let i=!0;const r=e.map(s=>{const n=Wk(s);return s!=null&&n==null&&(i=!1),n});return i?r:null}if(ose(e))return e.clone();if(!lse(e)){const i=new(Object.getPrototypeOf(e)).constructor;for(const r of Object.getOwnPropertyNames(e)){const s=e[r],n=Wk(s);if(s!=null&&n==null)return null;i[r]=n}return i}return null}function ose(e){return typeof e.clone=="function"}function ase(e){return typeof e.map=="function"&&typeof e.forEach=="function"}function lse(e){return typeof e.notifyChange=="function"&&typeof e.watch=="function"}function cse(e){if(j1e(e)||a_(e)||H1e(e)||q1e(e)||r$(e)||W1e(e)||s$(e)||rse(e)||sse(e))return $9(e);if(e instanceof Date)return new Date(e.getTime());if(e instanceof ArrayBuffer)return e.slice(0,e.byteLength);if(e instanceof Map){const t=new Map;return e.forEach((i,r)=>{t.set(r,se(i))}),t}if(e instanceof Set){const t=new Set;return e.forEach(i=>{t.add(se(i))}),t}return null}function TL(e,t){return e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t)||typeof(e||{}).getTime=="function"&&typeof(t||{}).getTime=="function"&&e.getTime()===t.getTime()||!1}function use(e,t,i=!1){return dse(e,t,i)}function YT(e,t){if(t!=null)return t[e]||hse(e.split("."),!1,t)}function cc(e,t,i){const r=e.split("."),s=r.pop(),n=hse(r,!0,i);n&&s&&(n[s]=t)}function hse(e,t,i){let r=i;for(const s of e){if(r==null)return;if(!(s in r)){if(!t)return;r[s]={}}r=r[s]}return r}function dse(e,t,i){return t?Object.keys(t).reduce(function(r,s){let n=r[s],o=t[s];return n===o?r:n===void 0?(r[s]=se(o),r):(Array.isArray(o)||Array.isArray(r)?(n=n?Array.isArray(n)?r[s]=n.concat():r[s]=[n]:r[s]=[],o&&(Array.isArray(o)||(o=[o]),i?o.forEach(a=>{n.indexOf(a)===-1&&n.push(a)}):r[s]=o.concat())):o&&typeof o=="object"?r[s]=dse(n,o,i):r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=o),r)},e||{}):e}var sW;const zi={apiKey:void 0,applicationUrl:(sW=globalThis.location)==null?void 0:sW.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(use(zi,globalThis.esriConfig,!0),delete zi.has),!zi.assetsPath){const e="4.23.2";zi.assetsPath=`https://js.arcgis.com/${e.slice(0,-2)}/@arcgis/core/assets`}zi.baseUrl&&console.warn("[esri.config]","baseUrl has been replaced by assetsPath"),Object.defineProperty(zi,"baseUrl",{set(){console.warn("[esri.config]","baseUrl has been replaced by assetsPath")}}),zi.request.corsEnabledServers=[],zi.request.corsEnabledServers.push=function(){return console.warn("[esri.config]","request.corsEnabledServers is not supported and will be removed in a future release. See http://esriurl.com/cors8664"),0};const Y1e=/\{([^\}]+)\}/g;function nW(e){return e==null?"":e}function ap(e,t){return e.replace(Y1e,typeof t=="object"?(i,r)=>nW(YT(r,t)):(i,r)=>nW(t(r)))}function pse(e,t){return e.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,i=>t&&t.indexOf(i)!==-1?i:`\\${i}`)}function D9(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}function Fut(e){return new DOMParser().parseFromString(e||"","text/html").body.innerText||""}const oW={info:0,warn:1,error:2,none:3};class he{constructor(t){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},t.level!=null&&(this.level=t.level),t.writer!=null&&(this.writer=t.writer),this._module=t.module,he._loggers[this.module]=this;const i=this.module.lastIndexOf(".");i!==-1&&(this._parent=he.getLogger(this.module.slice(0,i)))}get module(){return this._module}get parent(){return this._parent}error(...t){this._log("error","always",...t)}warn(...t){this._log("warn","always",...t)}info(...t){this._log("info","always",...t)}errorOnce(...t){this._log("error","once",...t)}warnOnce(...t){this._log("warn","once",...t)}infoOnce(...t){this._log("info","once",...t)}errorOncePerTick(...t){this._log("error","oncePerTick",...t)}warnOncePerTick(...t){this._log("warn","oncePerTick",...t)}infoOncePerTick(...t){this._log("info","oncePerTick",...t)}get test(){const t=this;return{loggedMessages:t._loggedMessages,clearLoggedWarnings:()=>t._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(t={}){const i=he._loggers;return he._loggers=t,i},set throttlingDisabled(t){he._throttlingDisabled=t}}}static getLogger(t){let i=he._loggers[t];return i||(i=new he({module:t})),i}_log(t,i,...r){if(!!this._matchLevel(t)){if(i!=="always"&&!he._throttlingDisabled){const s=this._argsToKey(r),n=this._loggedMessages[t].get(s);if(i==="once"&&n!=null||i==="oncePerTick"&&n&&n>=he._tickCounter)return;this._loggedMessages[t].set(s,he._tickCounter),he._scheduleTickCounterIncrement()}for(const s of zi.log.interceptors)if(s(t,this.module,...r))return;this._inheritedWriter()(t,this.module,...r)}}_parentWithMember(t,i){let r=this;for(;_(r);){const s=r[t];if(_(s))return s;r=r.parent}return i}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(t,i,...r){console[t](`[${i}]`,...r)}_matchLevel(t){const i=zi.log.level?zi.log.level:"warn";return oW[this._parentWithMember("level",i)]<=oW[t]}_argsToKey(...t){const i=(r,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]";return D9(JSON.stringify(t,i))}static _scheduleTickCounterIncrement(){he._tickCounterScheduled||(he._tickCounterScheduled=!0,Promise.resolve().then(()=>{he._tickCounter++,he._tickCounterScheduled=!1}))}}he._loggers={},he._tickCounter=0,he._tickCounterScheduled=!1,he._throttlingDisabled=!1;function Hx(e){return Sm(()=>e.forEach(t=>_(t)&&t.remove()))}function Sm(e){return{remove:()=>{e&&(e(),e=void 0)}}}function Z1e(e,t){const i=setTimeout(e,t);return Sm(()=>clearTimeout(i))}function Ta(e){return e?e.__accessor__?e.__accessor__:e.propertyInvalidated?e:null:null}function Q1e(e,t){return e!=null&&e.metadatas&&e.metadatas[t]!=null}function c3(e,t,i){return i?n$(e,t,{policy:i,path:""}):n$(e,t,null)}function n$(e,t,i){return t?Object.keys(t).reduce(function(r,s){let n=null,o="merge";if(i&&(n=i.path?`${i.path}.${s}`:s,o=i.policy(n)),o==="replace")return r[s]=t[s],r;if(r[s]===void 0)return r[s]=se(t[s]),r;let a=r[s],l=t[s];if(a===l)return r;if(Array.isArray(l)||Array.isArray(r))a=a?Array.isArray(a)?r[s]=a.concat():r[s]=[a]:r[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.indexOf(c)===-1&&a.push(c)}));else if(l&&typeof l=="object")if(i){const c=i.path;i.path=n,r[s]=n$(a,l,i),i.path=c}else r[s]=n$(a,l,null);else r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=l);return r},e||{}):e}function fse(e){return Array.isArray(e)?e:e.split(".")}function aW(e){return e.indexOf(",")>-1?e.split(",").map(t=>t.trim()):[e.trim()]}function J1e(e){if(Array.isArray(e)){const t=[];for(const i of e)t.push(...aW(i));return t}return aW(e)}function mse(e,t,i,r){const s=J1e(t);if(s.length!==1){const n=s.map(o=>r(e,o,i));return Hx(n)}return r(e,s[0],i)}function L9(e){let t=!1;return()=>{t||(t=!0,e())}}function gse(e,t){const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const s=parseInt(i,10);if(!isNaN(s))return Array.isArray(t)?t[s]:t.getItemAt(s)}const r=Ta(t);return Q1e(r,i)?r.get(i):t[i]}function yse(e,t,i){if(e==null)return e;const r=gse(t[i],e);return!r&&i<t.length-1?void 0:i===t.length-1?r:yse(r,t,i+1)}function fR(e,t,i=0){return typeof t=="string"&&t.indexOf(".")===-1?gse(t,e):yse(e,fse(t),i)}function o$(e,t){return fR(e,t)}function lW(e,t){return fR(t,e)!==void 0}var Yd;(function(e){e[e.INITIALIZING=0]="INITIALIZING",e[e.CONSTRUCTING=1]="CONSTRUCTING",e[e.CONSTRUCTED=2]="CONSTRUCTED"})(Yd||(Yd={}));class cW{constructor(t){this.autoDestroy=!1,this.properties=t}}function mR(e){let t=e.constructor.__accessorMetadata__;const i=Object.prototype.hasOwnProperty.call(e.constructor,"__accessorMetadata__");if(t){if(!i){const r=Object.create(t.properties),s=t.autoDestroy;for(const n in r)r[n]=se(r[n]);t=new cW(r),t.autoDestroy=s,Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0})}}else t=new cW({}),Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0});return e.constructor.__accessorMetadata__}function K1e(e){return mR(e).properties}function SL(e,t){const i=K1e(e);let r=i[t];return r||(r=i[t]={}),r}function ebe(e,t){return c3(e,t,ibe)}const tbe=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function ibe(e){return tbe.test(e)?"replace":"merge"}function rbe(e){return e&&e.release&&typeof e.release=="function"}function sbe(e){return e&&e.acquire&&typeof e.acquire=="function"}class Gr{constructor(t,i,r,s=1,n=0){if(this.ctor=t,this.acquireFunction=i,this.releaseFunction=r,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this.ctor)for(let o=0;o<n;o++)this._pool[o]=new this.ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...t){let i;if(Gr.test.disabled)i=new this.ctor;else{if(this._pool.length===0){const r=this.allocationSize;for(let s=0;s<r;s++)this._pool[s]=new this.ctor}i=this._pool.pop()}return this.acquireFunction?this.acquireFunction(i,...t):sbe(i)&&i.acquire(...t),i}release(t){t&&!Gr.test.disabled&&(this.releaseFunction?this.releaseFunction(t):rbe(t)&&t.release(),this._pool.push(t))}prune(t=this._initialSize){if(!(t>=this._pool.length)){for(let i=t;i<this._pool.length;++i){const r=this._pool[i];this._dispose(r)}this._pool.length=t}}_dispose(t){t.dispose&&typeof t.dispose=="function"&&t.dispose()}}Gr.test={disabled:!1};var oi;(function(e){e[e.DEFAULTS=0]="DEFAULTS",e[e.COMPUTED=1]="COMPUTED",e[e.SERVICE=2]="SERVICE",e[e.PORTAL_ITEM=3]="PORTAL_ITEM",e[e.WEB_SCENE=4]="WEB_SCENE",e[e.WEB_MAP=5]="WEB_MAP",e[e.USER=6]="USER"})(oi||(oi={}));const Xk=oi.USER+1;function wy(e){switch(e){case"defaults":return oi.DEFAULTS;case"service":return oi.SERVICE;case"portal-item":return oi.PORTAL_ITEM;case"web-scene":return oi.WEB_SCENE;case"web-map":return oi.WEB_MAP;case"user":return oi.USER}}function a$(e){switch(e){case oi.DEFAULTS:return"defaults";case oi.SERVICE:return"service";case oi.PORTAL_ITEM:return"portal-item";case oi.WEB_SCENE:return"web-scene";case oi.WEB_MAP:return"web-map";case oi.USER:return"user"}return void 0}function nbe(e){return a$(e)}var Ki;(function(e){e[e.Dirty=1]="Dirty",e[e.Overriden=2]="Overriden",e[e.Computing=4]="Computing",e[e.NonNullable=8]="NonNullable",e[e.HasDefaultValue=16]="HasDefaultValue",e[e.DepTrackingInitialized=32]="DepTrackingInitialized",e[e.AutoTracked=64]="AutoTracked",e[e.ExplicitlyTracking=128]="ExplicitlyTracking"})(Ki||(Ki={}));let l$,V2=[];const obe=he.getLogger("esri.core.Accessor");function Vt(e){l$!==void 0&&l$.onObservableAccessed(e)}let u3=!1,h3=!1;function cm(e,t,i){if(u3)return N9(e,t,i);vse(e);const r=t.call(i);return _se(),r}function abe(e,t){return cm(void 0,e,t)}function N9(e,t,i){const r=u3;u3=!0,vse(e);let s=null;try{s=t.call(i)}catch(n){h3&&obe.error(n)}return _se(),u3=r,s}function vse(e){l$=e,V2.push(e)}function _se(){const e=V2.pop();l$=V2.length>0?V2[V2.length-1]:void 0,e!==void 0&&e.onTrackingEnd()}function bse(e,t){if(t.flags&Ki.DepTrackingInitialized)return;const i=h3;h3=!1,t.flags&Ki.AutoTracked?N9(t,t.metadata.get,e):wse(e,t),h3=i}const lbe=[];function wse(e,t){t.flags&Ki.ExplicitlyTracking||(t.flags|=Ki.ExplicitlyTracking,N9(t,()=>{const i=t.metadata.dependsOn||lbe;for(const r of i)if(typeof r=="string"&&r.indexOf(".")===-1)uW(e,r,!1);else{const s=fse(r);for(let n=0,o=e;n<s.length&&o!=null&&typeof o=="object";++n)o=uW(o,s[n],n!==s.length-1)}}),t.flags&=~Ki.ExplicitlyTracking)}function uW(e,t,i){const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const o=parseInt(r,10);if(!isNaN(o))return Array.isArray(e)?e[o]:e.getItemAt(o)}const s=Ta(e),n=s==null?void 0:s.properties.get(r);return n&&(Vt(n),bse(e,n)),i?e[r]:void 0}class xse{constructor(t,i){this._observers=t,this._observer=i}remove(){I9(this._observers,this._observer)}}class hW{constructor(t,i,r){this.properties=t,this.propertyName=i,this.metadata=r,this._observers=null,this._accessed=null,this._handles=null,this.flags=Ki.Dirty|(r.nonNullable?Ki.NonNullable:0)|(r.hasOwnProperty("value")?Ki.HasDefaultValue:0)|(r.get===void 0?Ki.DepTrackingInitialized:0)|(r.dependsOn===void 0?Ki.AutoTracked:0)}destroy(){this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){Vt(this);const t=this.properties.store,i=this.propertyName,r=this.flags,s=t.get(i);if(r&Ki.Computing||~r&Ki.Dirty&&t.has(i))return s;this.flags|=Ki.Computing;const n=this.properties.host;let o;r&Ki.AutoTracked?o=cm(this,this.metadata.get,n):(wse(n,this),o=this.metadata.get.call(n)),t.set(i,o,oi.COMPUTED);const a=t.get(i);return a===s?this.flags&=~Ki.Dirty:abe(this.commit,this),this.flags&=~Ki.Computing,a}onObservableAccessed(t){t!==this&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(t)||this._accessed.push(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=Ki.DepTrackingInitialized;const t=this._accessed;if(t===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let r=0;r<t.length;++r)i.push(t[r].observe(this));t.length=0}observe(t){return this._observers===null&&(this._observers=[]),this._observers.includes(t)||this._observers.push(t),new xse(this._observers,t)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){~this.flags&Ki.Overriden&&(this.flags|=Ki.Dirty);const t=this._observers;if(t!==null)for(let i=0;i<t.length;++i)t[i].onInvalidated()}commit(){this.flags&=~Ki.Dirty,this.onCommitted()}onCommitted(){if(this._observers===null)return;const t=this._observers.slice();for(let i=0;i<t.length;++i)t[i].onCommitted()}_clearObservationHandles(){const t=this._handles;if(t!==null){for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}}class F9{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new F9;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,se(r))}),i}get(t){return this._values.get(t)}originOf(){return oi.USER}keys(){return[...this._values.keys()]}set(t,i){this._values.set(t,i)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}function vO(e,t,i){return e!==void 0}function dW(e,t,i,r){return e!==void 0&&(!(i==null&&e.flags&Ki.NonNullable)||(r.lifecycle,Yd.INITIALIZING,!1))}function cbe(e){return e&&typeof e.destroy=="function"}he.getLogger("esri.core.accessorSupport.Properties");class ube{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=Yd.INITIALIZING,this.store=new F9,this._origin=oi.USER;const i=this.host.constructor.__accessorMetadata__,r=i.properties;for(const s in r){const n=new hW(this,s,r[s]);this.properties.set(s,n)}this.metadatas=r,this._autoDestroy=i.autoDestroy}initialize(){this.lifecycle=Yd.CONSTRUCTING}constructed(){this.lifecycle=Yd.CONSTRUCTED}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[t,i]of this.properties){const r=this.internalGet(t);r&&cbe(r)&&(r.destroy(),~i.flags&Ki.NonNullable&&this._internalSet(i,null)),i.destroy()}else for(const[t,i]of this.properties)i.destroy()}get initialized(){return this.lifecycle!==Yd.INITIALIZING}get(t){const i=this.properties.get(t);if(i.metadata.get)return i.getComputed();Vt(i);const r=this.store;return r.has(t)?r.get(t):i.metadata.value}originOf(t){const i=this.store.originOf(t);if(i===void 0){const r=this.properties.get(t);if(r!==void 0&&r.flags&Ki.HasDefaultValue)return"defaults"}return a$(i)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const i=this.properties.get(t);if(vO(i))return this.store.has(t)?this.store.get(t):i.metadata.value}internalSet(t,i){const r=this.properties.get(t);vO(r)&&this._internalSet(r,i)}getDependsInfo(t,i,r){const s=this.properties.get(i);if(!vO(s))return"";const n=new Set,o=cm({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(t)});let a=`${r}${t.declaredClass.split(".").pop()}.${i}: ${o}
`;if(n.size===0)return a;r+="  ";for(const l of n){if(!(l instanceof hW))continue;const c=l.properties.host,h=l.propertyName,p=Ta(c);a+=p?p.getDependsInfo(c,h,r):`${r}${h}: undefined
`}return a}setAtOrigin(t,i,r){const s=this.properties.get(t);if(vO(s))return this._setAtOrigin(s,i,r)}isOverridden(t){const i=this.properties.get(t);return i!==void 0&&!!(i.flags&Ki.Overriden)}clearOverride(t){const i=this.properties.get(t);i!==void 0&&i.flags&Ki.Overriden&&(i.flags&=~Ki.Overriden,i.notifyChange())}override(t,i){const r=this.properties.get(t);if(!dW(r,t,i,this))return;const s=r.metadata.cast;if(s){const n=this._cast(s,i),{valid:o,value:a}=n;if(o4.release(n),!o)return;i=a}r.flags|=Ki.Overriden,this._internalSet(r,i)}set(t,i){const r=this.properties.get(t);if(!dW(r,t,i,this))return;const s=r.metadata.cast;if(s){const o=this._cast(s,i),{valid:a,value:l}=o;if(o4.release(o),!a)return;i=l}const n=r.metadata.set;n?n.call(this.host,i):this._internalSet(r,i)}setDefaultOrigin(t){this._origin=wy(t)}getDefaultOrigin(){return a$(this._origin)}notifyChange(t){const i=this.properties.get(t);i!==void 0&&i.notifyChange()}invalidate(t){const i=this.properties.get(t);i!==void 0&&i.invalidate()}commit(t){const i=this.properties.get(t);i!==void 0&&i.commit()}_internalSet(t,i){const r=this.lifecycle!==Yd.INITIALIZING?this._origin:oi.DEFAULTS;this._setAtOrigin(t,i,r)}_setAtOrigin(t,i,r){const s=this.store,n=t.propertyName;s.has(n,r)&&TL(i,s.get(n))&&~t.flags&Ki.Overriden&&r===s.originOf(n)||(t.invalidate(),s.set(n,i,r),t.commit(),bse(this.host,t))}_cast(t,i){const r=o4.acquire();return r.valid=!0,r.value=i,t&&(r.value=t.call(this.host,i,r)),r}}class hbe{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const o4=new Gr(hbe);function dbe(e,t){return e.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,function(i,r){if(r==="")return"$";const s=YT(r,t),n=s==null?"":s;if(n===void 0)throw new Error(`could not find key "${r}" in template`);return n.toString()})}class EL{constructor(t,i,r){this.name=t,this.details=r,this.message=void 0,this instanceof EL&&(this.message=i&&dbe(i,r)||"")}toString(){return"["+this.name+"]: "+this.message}}class Q extends EL{constructor(t,i,r){if(super(t,i,r),!(this instanceof Q))return new Q(t,i,r)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(t,i)=>{if(i&&typeof i=="object"&&typeof i.toJSON=="function")return i;try{return se(i)}catch{return"[object]"}}))}}catch(t){throw he.getLogger("esri.core.Error").error(t),t}return{name:this.name,message:this.message,details:this.details}}static fromJSON(t){return new Q(t.name,t.message,t.details)}}Q.prototype.type="error";function c$(e,t,i){if(e&&t)if(typeof t=="object")for(const r of Object.getOwnPropertyNames(t))c$(e,r,t[r]);else{if(t.indexOf(".")!==-1){const s=t.split("."),n=s.splice(s.length-1,1)[0];return void c$(o$(e,s),n,i)}const r=e.__accessor__;r!=null&&pbe(t,r),e[t]=i}}function pbe(e,t){if(ue("esri-unknown-property-errors")&&!fbe(e,t))throw new Q("set:unknown-property",mbe(e,t))}function fbe(e,t){return t.metadatas[e]!=null}function mbe(e,t){return"setting unknown property '"+e+"' on instance of "+t.host.declaredClass}he.getLogger("esri.core.accessorSupport.set");function gbe(e){e.length=0}class Ja{constructor(t=50,i=50){this._pool=new Gr(Array,void 0,gbe,i,t)}acquire(){return this._pool.acquire()}release(t){this._pool.release(t)}prune(){this._pool.prune(0)}static acquire(){return a4.acquire()}static release(t){return a4.release(t)}static prune(){a4.prune()}}const a4=new Ja(100);class Tse extends Gr{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=L1e(this._set)}acquire(...t){const i=super.acquire(...t);return this._set.delete(i),i}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}const _O=[];function qx(e){_O.push(e),_O.length===1&&queueMicrotask(()=>{const t=_O.slice();_O.length=0;for(const i of t)i()})}const ybe=29;class Vy{constructor(t,i=ybe){this.name=t,this._counter=0,this._items=new Array(i)}record(t){this._items[++this._counter%this._items.length]=t}get median(){return this._items.slice().sort((t,i)=>t-i)[Math.floor(this._items.length/2)]}get average(){return this._items.reduce((t,i)=>t+i,0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}var Yk;(function(e){const t=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const g=n[h-1];if(l(g,f)<=0)break;n[c-1]=g,c=h}n[c-1]=f},i=(n,o)=>n<o?-1:n>o?1:0;function r(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l),yield}}e.sort=r,e.iterableSort=s})(Yk||(Yk={}));const pW=Yk,vbe=1.5,_be=1.1;class $t{constructor(t){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new ese,t&&(t.initialSize&&(this.data=new Array(t.initialSize)),t.allocator&&(this._allocator=t.allocator),t.deallocator!==void 0&&(this._deallocator=t.deallocator),t.shrink&&(this._shrink=()=>fW(this)))}toArray(){return this.data.slice(0,this.length)}filter(t){const i=new Array;for(let r=0;r<this._length;r++){const s=this.data[r];t(s)&&i.push(s)}return i}getItemAt(t){if(!(t<0||t>=this._length))return this.data[t]}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let i=t;i<this._length;++i)this.data[i]=this._deallocator(this.data[i]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,i=t.length){for(let r=0;r<i;r++)this.data[this._length++]=t[r]}fill(t,i){for(let r=0;r<i;r++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}unshift(t){this.data.unshift(t),this._length++,fW(this)}pop(){if(this.length===0)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}remove(t){const i=ise(this.data,t,this.length,this._hint);if(i!==-1)return this.data.splice(i,1),this.length=this.length-1,t}removeUnordered(t){const i=xL(this.data,t,this.length,this._hint);return i!==void 0&&(this.length=this.length-1),this._shrink(),i}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,i=t.length,r){this.length=B1e(this.data,t,this.length,i,this._hint,r),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(t,i){t>=this.length||i>=this.length||t===i||([this.data[t],this.data[i]]=[this.data[i],this.data[t]])}sort(t){pW.sort(this.data,0,this.length,t)}iterableSort(t){return pW.iterableSort(this.data,0,this.length,t)}some(t,i){for(let r=0;r<this.length;++r)if(t.call(i,this.data[r],r,this.data))return!0;return!1}filterInPlace(t,i){let r=0;for(let s=0;s<this._length;++s){const n=this.data[s];t.call(i,n,s,this.data)&&(this.data[s]=this.data[r],this.data[r]=n,r++)}if(this._deallocator)for(let s=r;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=r,this._shrink(),this}forAll(t,i){const r=this.length,s=this.data;for(let n=0;n<r;++n)t.call(i,s[n],n,s)}forEach(t,i){for(let r=0;r<this.length;++r)t.call(i,this.data[r],r,this.data)}map(t,i){const r=new Array(this.length);for(let s=0;s<this.length;++s)r[s]=t.call(i,this.data[s],s,this.data);return r}reduce(t,i){let r=i;for(let s=0;s<this.length;++s)r=t(r,this.data[s],s,this.data);return r}has(t){const i=this.length,r=this.data;for(let s=0;s<i;++s)if(r[s]===t)return!0;return!1}}function fW(e){e.data.length>vbe*e.length&&(e.data.length=Math.floor(e.length*_be))}function bbe(e){return{setTimeout:(t,i)=>{const r=e.setTimeout(t,i);return{remove:()=>e.clearTimeout(r)}}}}const AL=bbe(globalThis);function CL(e){return e&&(typeof e.on=="function"||typeof e.addEventListener=="function")}function gR(e,t,i){if(!CL(e))throw new TypeError("target is not a Evented or EventTarget object");if("on"in e)return e.on(t,i);if(Array.isArray(t)){const r=t.slice();for(const s of r)e.addEventListener(s,i);return{remove(){for(const s of r)e.removeEventListener(s,i)}}}return e.addEventListener(t,i),{remove(){e.removeEventListener(t,i)}}}function Sse(e,t,i){if(!CL(e))throw new TypeError("target is not a Evented or EventTarget object");if("once"in e)return e.once(t,i);const r=gR(e,t,s=>{r.remove(),i.call(e,s)});return{remove(){r.remove()}}}const wbe={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function l_({key:e}){return wbe[e]||e}function U9(e){return Promise.all(e)}function k9(e){return new Promise((t,i)=>{try{e(t,i)}catch(r){Promise.resolve().then(()=>i(r))}})}function pi(e="Aborted"){return new Q("AbortError",e)}function Jt(e,t="Aborted"){if(Ls(e))throw pi(t)}function RL(e){return _(e)?"aborted"in e?e:e.signal:e}function Ls(e){const t=RL(e);return _(t)&&t.aborted}function Em(e){if(vr(e))throw e}function Zk(e){if(!vr(e))throw e}function co(e,t){const i=RL(e);if(!O(i)){if(!i.aborted)return Sse(i,"abort",()=>t());t()}}function OL(e,t){const i=RL(e);if(!O(i))return Jt(i),Sse(i,"abort",()=>t(pi()))}function Ese(e,t){const i=RL(t);return O(i)?e:new Promise((r,s)=>{let n=co(t,()=>s(pi()));const o=()=>n=Ys(n);e.then(o,o),e.then(r,s)})}function vr(e){return e&&e.name==="AbortError"}function Qk(e){return e.catch(t=>{if(!vr(t))throw t})}function Uut(e,t=he.getLogger("esri")){return e.catch(i=>{vr(i)||t.error(i)})}function Jy(){let e=null;const t=new Promise((i,r)=>{e={promise:void 0,resolve:i,reject:r}});return e.promise=t,e}function Sa(e){if(!e)return;if(typeof e.forEach!="function"){const i=Object.keys(e);return Sa(i.map(r=>e[r])).then(r=>{const s={};return i.forEach((n,o)=>s[n]=r[o]),s})}const t=e;return k9(i=>{const r=[];let s=t.length;s===0&&i(r),t.forEach(n=>{const o={promise:n||Promise.resolve(n)};r.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&i(r)})})})}function xbe(e){return Sa(e).then(t=>t.filter(i=>!!i.value).map(i=>i.value))}function mW(e){return Promise.reject(e)}function Zw(e){return Promise.resolve(e)}function Wx(e,t,i){const r=new AbortController;return co(i,()=>r.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(t)},e);co(r,()=>{o&&(clearTimeout(o),n(pi()))})})}function _c(e){return e&&typeof e.then=="function"}function Jk(e){return _c(e)?e:Promise.resolve(e)}function Ase(e,t=-1){let i,r,s,n,o=null;const a=(...l)=>{if(i){r=l,n&&n.reject(pi()),n=Jy();const f=n.promise;if(o){const g=o;o=null,g.abort()}return f}if(s=n||Jy(),n=null,t>0){const f=new AbortController;i=Jk(e(...l,f.signal));const g=i;Wx(t).then(()=>{i===g&&(n?f.abort():o=f)})}else i=1,i=Jk(e(...l));const c=()=>{const f=r;r=s=i=o=null,f!=null&&a(...f)},h=i,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function um(){let e,t;const i=new Promise((s,n)=>{e=s,t=n}),r=s=>{e(s)};return r.resolve=s=>e(s),r.reject=s=>t(s),r.timeout=(s,n)=>AL.setTimeout(()=>r.reject(n),s),r.promise=i,r}function kut(e,t){return e.then(t,t)}function yR(e,t){let i,r=new AbortController;const s=e(r.signal);let n={promise:s,finished:!1,abort:()=>{r&&(r.abort(),r=null)}};const o=()=>{n&&(n.finished=!0,n=null),_(i)&&(i.remove(),i=null),r=null};return s.then(o,o),i=co(t,()=>{_(n)&&n.abort()}),n}function zut(e){return Promise.resolve().then(()=>{Jt(e)})}function Cse(e){return 1e3*e}function Rse(e){return .001*e}class Tbe{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class Sbe{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let Kk=0,ez=0;const OS={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},tz=["prepare","preRender","render","postRender","update","finish"],iz=[],K_=new $t;class Ebe{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const u$={frameTasks:K_,willDispatch:!1,clearFrameTasks:Abe,dispatch:Pse,executeFrameTasks:Rbe};function vR(e){const t=new Sbe(e);return iz.push(t),u$.willDispatch||(u$.willDispatch=!0,qx(Pse)),t}function e1(e){const t=new Tbe(e);return K_.push(t),h$==null&&(Kk=performance.now(),h$=requestAnimationFrame(Ose)),new Ebe(t)}let h$=null;function Abe(e=!1){K_.forAll(t=>{t.removed=!0}),e&&Mse()}function Cbe(e){ez=Math.max(0,e)}function Ose(){const e=performance.now();h$=null,h$=K_.length>0?requestAnimationFrame(Ose):null,u$.executeFrameTasks(e)}function Rbe(e){const t=e-Kk;Kk=e;const i=ez>0?ez:1e3/60,r=Math.max(0,t-i);for(let s=0;s<tz.length;s++){const n=performance.now(),o=tz[s];K_.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(OS.time=e,OS.deltaTime=a.ticks===0?0:t,OS.elapsedFrameTime=performance.now()-e,OS.frameDuration=i-r,(l=a.phases[o])==null||l.call(a,OS)))}),Obe[s].record(performance.now()-n)}Mse(),Mbe.record(performance.now()-e)}const bO=new $t;function Mse(){K_.forAll(e=>{e.removed&&bO.push(e)}),K_.removeUnorderedMany(bO.data,bO.length),bO.clear()}function Pse(){for(;iz.length;){const e=iz.shift();e.isActive&&e.callback()}u$.willDispatch=!1}function But(e=1,t){const i=um(),r=()=>{Ls(t)?i.reject(pi()):e===0?i():(--e,qx(()=>r()))};return r(),i.promise}const Obe=tz.map(e=>new Vy(e)),Mbe=new Vy("total");function Ise(e,t){for(const i of e.entries())if(t(i[0]))return!0;return!1}let Pbe=0;const Ibe=0;function va(){return++Pbe}class ML{constructor(t){this._notify=t,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const t=this._invalidCount;if(t===1)return this._invalidCount=0,void this._notify();this._invalidCount=t>0?t-1:0}onObservableAccessed(t){this._accessed.includes(t)||this._accessed.push(t)}onTrackingEnd(){const t=this._handles,i=this._accessed;for(let r=0;r<i.length;++r)t.push(i[r].observe(this));i.length=0}clear(){const t=this._handles;for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}let _x=!1;const d$=[];function $se(e,t){let i=new ML(n),r=null,s=!1;function n(){if(!i||s)return;if(_x)return void Nse(n);const a=r;i.clear(),_x=!0,s=!0,r=cm(i,e),s=!1,_x=!1,t(r,a),Fse()}function o(){i&&(i.destroy(),i=null,r=null)}return s=!0,r=cm(i,e),s=!1,{remove:o}}function Dse(e,t){let i=new ML(s),r=null;function s(){t(r,o)}function n(){i&&(i.destroy(),i=null),r=null}function o(){return i?(i.clear(),r=cm(i,e),r):null}return o(),{remove:n}}function Lse(e){let t=new ML(r),i=!1;function r(){t&&!i&&(_x?Nse(r):(t.clear(),_x=!0,i=!0,cm(t,e),i=!1,_x=!1,Fse()))}function s(){t&&(t.destroy(),t=null)}return i=!0,cm(t,e),i=!1,{remove:s}}function Nse(e){d$.includes(e)||d$.unshift(e)}function Fse(){for(;d$.length;)d$.pop()()}var iA;(function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"})(iA||(iA={}));class WA{constructor(){this.uid=va(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(t,i,r,s,n){return this.pool.acquire(iA.Untracked,t,i,r,s,n,TL)}static acquireTracked(t,i,r,s){return this.pool.acquire(iA.Tracked,t,i,r,null,null,s)}notify(t,i){this.type===iA.Untracked?this.callback.call(this.target,t,i,this.path,this.target):this.callback.call(null,t,i)}acquire(t,i,r,s,n,o,a){this.uid=va(),this.removed=!1,this.type=t,this.oldValue=i,this.callback=r,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=va(),this.removed=!0}}WA.pool=new Tse(WA);const d3=new Ja,Qf=new Set;let p$;function f$(e){Qf.delete(e),Qf.add(e),p$||(p$=vR(Lbe))}function $be(e){if(e.removed)return;const t=e.oldValue,i=e.getValue();e.equals(t,i)||(e.oldValue=i,e.notify(i,t))}function Dbe(e){for(const t of Qf.values())t.target===e&&(t.removed=!0)}function Lbe(){let e=10;for(;p$&&e--;){p$=null;const t=Nbe(),i=d3.acquire();for(const r of t){const s=r.uid;$be(r),s===r.uid&&r.removed&&i.push(r)}for(const r of Qf)r.removed&&(i.push(r),Qf.delete(r));for(const r of i)WA.pool.release(r);d3.release(i),d3.release(t),rz.forEach(r=>r())}}function Nbe(){const e=d3.acquire();e.length=Qf.size;let t=0;for(const i of Qf)e[t]=i,++t;return Qf.clear(),e}const rz=new Set;function Use(e){return rz.add(e),{remove(){rz.delete(e)}}}function Fbe(e,t,i){let r=mse(e,t,i,(s,n,o)=>{let a,l,c=Dse(()=>fR(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?r.remove():(a||(a=WA.acquireUntracked(h,o,p,s,n),l=a.uid),f$(a))});return{remove:L9(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,f$(a)),a=null),r=c=null})}});return r}function Ube(e,t,i){const r=mse(e,t,i,(s,n,o)=>{let a=!1;return $se(()=>fR(s,n),(l,c)=>{s.__accessor__.destroyed?r.remove():a||(a=!0,TL(c,l)||o.call(s,l,c,n,s),a=!1)})});return r}function kbe(e,t,i,r=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:r?Ube(e,t,i):Fbe(e,t,i)}function zbe(e,t,i){let r,s,n=Dse(e,(o,a)=>{r&&r.uid!==s?n.remove():(r||(r=WA.acquireTracked(o,t,a,i),s=r.uid),f$(r))});return{remove:L9(()=>{n.remove(),r&&(r.uid!==s||r.removed||(r.removed=!0,f$(r)),r=null),n=null})}}function Bbe(e,t,i){let r=!1;return $se(e,(s,n)=>{r||(r=!0,i(n,s)||t(s,n),r=!1)})}function Vbe(e,t,i=!1,r=TL){return i?Bbe(e,t,r):zbe(e,t,r)}function gW(e){return Ise(Qf,t=>t.oldValue===e)}function Vr(e,t){for(const[i,r]of e)if(t(r,i))return!0;return!1}function Vut(e,t){for(const[i,r]of e)if(t(r,i))return r;return null}function kse(e,t,i){const r=e.get(t);if(r!==void 0)return r;const s=i();return e.set(t,s),s}const bx=he.getLogger("esri.core.Accessor");function Gbe(e){return e==null?e:new Date(e)}function jbe(e){return e==null?e:!!e}function _R(e){return e==null?e:e.toString()}function ou(e){return e==null?e:(e=parseFloat(e),isNaN(e)?0:e)}function z9(e){return e==null?e:Math.round(parseFloat(e))}function zse(e){return e&&e.constructor&&e.constructor.__accessorMetadata__!==void 0}function m$(e,t){return t!=null&&e&&!(t instanceof e)}function Bse(e){return e&&"isCollection"in e}function yW(e){return e&&e.Type?typeof e.Type=="function"?e.Type:e.Type.base:null}function Hbe(e,t){if(!t||!t.constructor||!Bse(t.constructor))return sz(e,t)?t:new e(t);const i=yW(e.prototype.itemType),r=yW(t.constructor.prototype.itemType);return i?r?i===r?t:i.prototype.isPrototypeOf(r.prototype)?new e(t):(sz(e,t),t):new e(t):t}function sz(e,t){return!!zse(t)&&(bx.error("Accessor#set","Assigning an instance of '"+(t.declaredClass||"unknown")+"' which is not a subclass of '"+PL(e)+"'"),!0)}function Xx(e,t){return t==null?t:Bse(e)?Hbe(e,t):m$(e,t)?sz(e,t)?t:new e(t):t}function PL(e){return e&&e.prototype&&e.prototype.declaredClass||"unknown"}const qbe=new WeakMap;function Wbe(e){switch(e){case Number:return ou;case mr:return z9;case Boolean:return jbe;case String:return _R;case Date:return Gbe;default:return kse(qbe,e,()=>Xx.bind(null,e))}}function ns(e,t){const i=Wbe(e);return arguments.length===1?i:i(t)}function XA(e,t,i){return arguments.length===1?XA.bind(null,e):t&&(Array.isArray(t)?t.map(r=>e(r,i)):[e(t,i)])}function Xbe(e,t){return arguments.length===1?XA(ns.bind(null,e)):XA(ns.bind(null,e),t)}function Vse(e,t,i){return t!==0&&Array.isArray(i)?i.map(r=>Vse(e,t-1,r)):e(i)}function g$(e,t,i){if(arguments.length===2)return g$.bind(null,e,t);if(!i)return i;let r=t,s=i=Vse(e,t,i);for(;r>0&&Array.isArray(s);)r--,s=s[0];if(s!==void 0)for(let n=0;n<r;n++)i=[i];return i}function Ybe(e,t,i){return arguments.length===2?g$(ns.bind(null,e),t):g$(ns.bind(null,e),t,i)}function Gse(e){return!!Array.isArray(e)&&!e.some(t=>{const i=typeof t;return!(i==="string"||i==="number"||i==="function"&&e.length>1)})}function nz(e,t){if(arguments.length===2)return nz(e).call(null,t);const i=new Set,r=e.filter(a=>typeof a!="function"),s=e.filter(a=>typeof a=="function");for(const a of e)typeof a!="string"&&typeof a!="number"||i.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(i.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!m$(a,p))?a:(h&&r.length?(n||(n=r.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),bx.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>PL(p)).join(", ")),bx.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):bx.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function Fh(e,t){if(arguments.length===2)return Fh(e).call(null,t);const i={},r=[],s=[];for(const l in e.typeMap){const c=e.typeMap[l];i[l]=ns(c),r.push(PL(c)),s.push(l)}const n=()=>`'${r.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof e.key=="string"?l=>l[e.key]:e.key;return l=>{if(e.base&&!m$(e.base,l)||l==null)return l;const c=a(l)||e.defaultKeyValue,h=i[c];if(!h)return bx.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!m$(e.typeMap[c],l))return l;if(typeof e.key=="string"&&!zse(l)){const p={};for(const f in l)f!==e.key&&(p[f]=l[f]);return h(p)}return h(l)}}class mr{}const Gut={native:e=>({type:"native",value:e}),array:e=>({type:"array",value:e}),oneOf:e=>({type:"one-of",values:e})};function Zbe(e){if(!e||!("type"in e))return!1;switch(e.type){case"native":case"array":case"one-of":return!0}return!1}function jse(e){switch(e.type){case"native":return ns(e.value);case"array":return XA(jse(e.value));case"one-of":return Qbe(e);default:return null}}function Qbe(e){let t=null;return(i,r)=>az(i,e)?i:(t==null&&(t=oz(e)),bx.error("Accessor#set",`Invalid property value, value needs to be of type ${t}`),r&&(r.valid=!1),null)}function oz(e){switch(e.type){case"native":switch(e.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case mr:return"integer";case Date:return"date";default:return PL(e.value)}case"array":return`array of ${oz(e.value)}`;case"one-of":{const t=e.values.map(i=>oz(i));return`one of ${t.slice(0,t.length-1)} or ${t[t.length-1]}`}}return"unknown"}function az(e,t){if(e==null)return!0;switch(t.type){case"native":switch(t.value){case Number:case mr:return typeof e=="number";case Boolean:return typeof e=="boolean";case String:return typeof e=="string"}return e instanceof t.value;case"array":return!!Array.isArray(e)&&!e.some(i=>!az(i,t.value));case"one-of":return t.values.some(i=>az(e,i))}}function d(e={}){return(t,i)=>{if(t===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${t.name}.${i}. Accessor does not support static properties.`);const r=Object.getOwnPropertyDescriptor(t,i),s=SL(t,i);r&&(r.get||r.set?(s.get=r.get||s.get,s.set=r.set||s.set):"value"in r&&("value"in e&&he.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${i}" on "${t.constructor.name}" already defined in the metadata`,e),s.value=e.value=r.value)),e.readOnly!=null&&(s.readOnly=e.readOnly);const n=e.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=o$(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=o$(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){p!==void 0?this._override(i,p):this._clearOverride(i)}:function(p){c$(this,l,p)})}const o=e.type,a=e.types;s.cast||(o?s.cast=Jbe(o):a&&(Array.isArray(a)?s.cast=XA(Fh(a[0])):s.cast=Fh(a))),e.range&&(s.cast=Kbe(s.cast,e.range)),ebe(s,e)}}function Hse(e,t,i){const r=SL(e,i);r.json||(r.json={});let s=r.json;return t!==void 0&&(s.origins||(s.origins={}),s.origins[t]||(s.origins[t]={}),s=s.origins[t]),s}function Jbe(e){let t=0,i=e;if(Zbe(e))return jse(e);for(;Array.isArray(i)&&i.length===1&&typeof i[0]!="string"&&typeof i[0]!="number";)i=i[0],t++;const r=i;if(Gse(r))return t===0?nz(r):g$(nz(r),t);if(t===1)return Xbe(r);if(t>1)return Ybe(r,t);const s=e;return s.from?s.from:ns(s)}function Kbe(e,t){return i=>{let r=+e(i);return t.step!=null&&(r=Math.round(r/t.step)*t.step),t.min!=null&&(r=Math.max(t.min,r)),t.max!=null&&(r=Math.min(t.max,r)),r}}function ewe(e){if(e.json&&e.json.origins){const t=e.json.origins,i={"web-document":["web-scene","web-map"]};for(const r in i)if(t[r]){const s=t[r];i[r].forEach(n=>{t[n]=s}),delete t[r]}}}class uc extends EL{constructor(t,i,r){if(super(t,i,r),!(this instanceof uc))return new uc(t,i,r)}}uc.prototype.type="warning";function qse(e){return!!e&&e.prototype&&e.prototype.declaredClass&&e.prototype.declaredClass.indexOf("esri.core.Collection")===0}const lz=he.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function vW(e,t,i){var r,s;e&&(!i&&!t.read||(r=t.read)!=null&&r.reader||((s=t.read)==null?void 0:s.enabled)===!1||rwe(e)&&cc("read.reader",ZT(e),t))}function ZT(e){var t;const i=(t=e.ndimArray)!=null?t:0;if(i>1)return iwe(e);if(i===1)return _W(e);if("type"in e&&Xse(e.type)){var r,s;const n=(r=e.type.prototype)==null||(s=r.itemType)==null?void 0:s.Type,o=_W(typeof n=="function"?{type:n}:{types:n});return(a,l,c)=>{const h=o(a,l,c);return h&&new e.type(h)}}return B9(e)}function B9(e){return"type"in e?twe(e.type):swe(e.types)}function twe(e){return e.prototype.read?(t,i,r)=>{if(t==null)return t;const s=typeof t;if(s!=="object")return void lz.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${s}'`);const n=new e;return n.read(t,r),n}:e.fromJSON}function Wse(e,t,i,r){return r!==0&&Array.isArray(t)?t.map(s=>Wse(e,s,i,r-1)):e(t,void 0,i)}function iwe(e){var t;const i=B9(e),r=Wse.bind(null,i),s=(t=e.ndimArray)!=null?t:0;return(n,o,a)=>{if(n==null)return n;n=r(n,a,s);let l=s,c=n;for(;l>0&&Array.isArray(c);)l--,c=c[0];if(c!==void 0)for(let h=0;h<l;h++)n=[n];return n}}function _W(e){const t=B9(e);return(i,r,s)=>{if(i==null)return i;if(Array.isArray(i)){const o=[];for(const a of i){const l=t(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=t(i,void 0,s);return n!==void 0?[n]:void 0}}function Xse(e){if(!qse(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&(typeof t.Type=="function"?V9(t.Type):Yse(t.Type))}function rwe(e){return"types"in e?Yse(e.types):V9(e.type)}function V9(e){return!Array.isArray(e)&&!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||Xse(e))}function Yse(e){for(const t in e.typeMap)if(!V9(e.typeMap[t]))return!1;return!0}function swe(e){var t;let i=null;const r=(t=e.errorContext)!=null?t:"type";return(s,n,o)=>{if(s==null)return s;const a=typeof s;if(a!=="object")return void lz.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);i||(i=nwe(e));const l=e.key;if(typeof l!="string")return;const c=s[l],h=c?i[c]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!h){const f=`Type '${c||"unknown"}' is not supported`;return o&&o.messages&&s&&o.messages.push(new uc(`${r}:unsupported`,f,{definition:s,context:o})),void lz.error(f)}const p=new h;return p.read(s,o),p}}function nwe(e){const t={};for(const s in e.typeMap){var i,r;const n=e.typeMap[s],o=mR(n.prototype);if(typeof e.key=="function")continue;const a=o.properties[e.key];if(!a)continue;(i=a.json)!=null&&i.type&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(t[a.json.type[0]]=n);const l=(r=a.json)==null?void 0:r.write;if(!l||!l.writer){t[s]=n;continue}const c=l.target,h=typeof c=="string"?c:e.key,p={};l.writer(s,p,h),p[h]&&(t[p[h]]=n)}return t}function owe(e){if(e.json||(e.json={}),wW(e.json),xW(e.json),bW(e.json),e.json.origins)for(const t in e.json.origins)wW(e.json.origins[t]),xW(e.json.origins[t]),bW(e.json.origins[t]);return!0}function bW(e){e.name&&(e.read&&typeof e.read=="object"?e.read.source===void 0&&(e.read.source=e.name):e.read={source:e.name},e.write&&typeof e.write=="object"?e.write.target===void 0&&(e.write.target=e.name):e.write={target:e.name})}function wW(e){typeof e.read=="boolean"?e.read={enabled:e.read}:typeof e.read=="function"?e.read={enabled:!0,reader:e.read}:e.read&&typeof e.read=="object"&&e.read.enabled===void 0&&(e.read.enabled=!0)}function xW(e){typeof e.write=="boolean"?e.write={enabled:e.write}:typeof e.write=="function"?e.write={enabled:!0,writer:e.write}:e.write&&typeof e.write=="object"&&e.write.enabled===void 0&&(e.write.enabled=!0)}const awe=he.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer");function TW(e,t){var i;if(!t.write||t.write.writer||t.write.enabled===!1&&!t.write.overridePolicy)return;const r=(i=e==null?void 0:e.ndimArray)!=null?i:0;e&&(r===1||"type"in e&&qse(e.type))?t.write.writer=uwe:r>1?t.write.writer=hwe(r):t.types?Array.isArray(t.types)?t.write.writer=cwe(t.types[0]):t.write.writer=lwe(t.types):t.write.writer=YA}function lwe(e){return(t,i,r,s)=>t?Zse(t,e,s)?YA(t,i,r,s):void 0:YA(t,i,r,s)}function Zse(e,t,i){for(const n in t.typeMap)if(e instanceof t.typeMap[n])return!0;if(i!=null&&i.messages){var r,s;const n=(r=t.errorContext)!=null?r:"type",o=`Values of type '${(s=typeof t.key!="function"?e[t.key]:e.declaredClass)!=null?s:"Unknown"}' cannot be written`;i&&i.messages&&e&&i.messages.push(new Q(`${n}:unsupported`,o,{definition:e,context:i})),awe.error(o)}return!1}function cwe(e){return(t,i,r,s)=>!t||!Array.isArray(t)?YA(t,i,r,s):YA(t.filter(n=>Zse(n,e,s)),i,r,s)}function YA(e,t,i,r){cc(i,y$(e,r),t)}function y$(e,t){return e&&typeof e.write=="function"?e.write({},t):e&&typeof e.toJSON=="function"?e.toJSON():typeof e=="number"?v$(e):e}function v$(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function uwe(e,t,i,r){let s;e===null?s=null:e&&typeof e.map=="function"?(s=e.map(n=>y$(n,r)),typeof s.toArray=="function"&&(s=s.toArray())):s=[y$(e,r)],cc(i,s,t)}function Qse(e,t,i){return i!==0&&Array.isArray(e)?e.map(r=>Qse(r,t,i-1)):y$(e,t)}function hwe(e){return function(t,i,r,s){let n;if(t===null)n=null;else{n=Qse(t,s,e);let o=e,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}cc(r,n,i)}}function cz(e,t){return G9(e,"read",t)}function Jse(e,t){return G9(e,"write",t)}function G9(e,t,i){let r=e&&e.json;if(e&&e.json&&e.json.origins&&i){const s=e.json.origins[i.origin];s&&(t==="any"||t in s)&&(r=s)}return r}function dwe(e){const t=pwe(e);if(e.json.origins)for(const i in e.json.origins){const r=e.json.origins[i],s=r.types?fwe(r):t;vW(s,r,!1),r.types&&!r.write&&e.json.write&&e.json.write.enabled&&(r.write=I({},e.json.write)),TW(s,r)}vW(t,e.json,!0),TW(t,e.json)}function pwe(e){return e.json.types?uz(e.json):e.type?Kse(e):uz(e)}function fwe(e){return e.type?Kse(e):uz(e)}function Kse(e){if(!e.type)return;let t=0,i=e.type;for(;Array.isArray(i)&&!Gse(i);)i=i[0],t++;return{type:i,ndimArray:t}}function uz(e){if(!e.types)return;let t=0,i=e.types;for(;Array.isArray(i);)i=i[0],t++;return{types:i,ndimArray:t}}function mwe(e){owe(e)&&(ewe(e),dwe(e))}const l4=new Set,c4=new Set;function P(e){return t=>{t.prototype.declaredClass=e,ywe(t);const i=[],r=[];let s=t.prototype;for(;s;)s.hasOwnProperty("initialize")&&!l4.has(s.initialize)&&(l4.add(s.initialize),i.push(s.initialize)),s.hasOwnProperty("destroy")&&!c4.has(s.destroy)&&(c4.add(s.destroy),r.push(s.destroy)),s=Object.getPrototypeOf(s);l4.clear(),c4.clear();class n extends t{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(i.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=i.length-1;l>=0;l--)i[l].call(this)}}),r.length){let l=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0;for(let c=0;c<r.length;c++)r[c].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=mR(t.prototype),n.prototype.declaredClass=e,n}}function gwe(e,t){return t.get==null?function(){const i=this.__accessor__.properties.get(e);if(i===void 0)return;Vt(i);const r=this.__accessor__.store;return r.has(e)?r.get(e):i.metadata.value}:function(){const i=this.__accessor__.properties.get(e);if(i!==void 0)return i.getComputed()}}function ywe(e){const t=e.prototype,i=mR(t).properties,r={};for(const s of Object.getOwnPropertyNames(i)){const n=i[s];mwe(n),r[s]={enumerable:!0,configurable:!0,get:gwe(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===Yd.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(e.prototype,r)}function vwe(e){if(e==null)return{value:e};if(Array.isArray(e))return{type:[e[0]],value:null};switch(typeof e){case"object":return e.constructor&&e.constructor.__accessorMetadata__||e instanceof Date?{type:e.constructor,value:e}:e;case"boolean":return{type:Boolean,value:e};case"string":return{type:String,value:e};case"number":return{type:Number,value:e};case"function":return{type:e,value:null};default:return}}class we{constructor(...t){if(this.constructor===we)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new ube(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:i,declaredClass:r,constructor:s}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}mR(o.prototype);for(const a in t){const l=t[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:t[a]}for(const a in i){const l=vwe(i[a]);d(l)(o.prototype,a)}return P(r)(o)}postscript(t){const i=this.__accessor__,r=i.ctorArgs||t;i.initialize(),r&&(this.set(r),i.ctorArgs=null),i.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(Dbe(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&this.__accessor__.lifecycle===Yd.CONSTRUCTED||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return o$(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}isInstanceOf(t){return tw(he.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof t}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,i){return c$(this,t,i),this}watch(t,i,r){return kbe(this,t,i,r)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,i){return this.__accessor__.override(t,i)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.notifyChange(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,i){return this.__accessor__.internalSet(t,i),this}}he.getLogger("esri.core.Clonable");const bp=e=>{let t=class extends e{clone(){const i=D1e(Ta(this),"unable to clone instance of non-accessor class"),r=i.metadatas,s=i.store,n={},o=new Map;for(const c in r){const h=r[c],p=s==null?void 0:s.originOf(c),f=h.clonable;if(h.readOnly||f===!1||p!==oi.USER&&p!==oi.DEFAULTS&&p!==oi.WEB_MAP&&p!==oi.WEB_SCENE)continue;const g=this[c];let y=null;y=typeof f=="function"?f(g):f==="reference"?g:Wk(g),g!=null&&y==null||(p===oi.DEFAULTS?o.set(c,y):n[c]=y)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){var l;const c=(l=Ta(a))==null?void 0:l.store;if(c)for(const[h,p]of o)c.set(h,p,oi.DEFAULTS)}return a}};return t=u([P("esri.core.Clonable")],t),t};let SW=class extends bp(we){};SW=u([P("esri.core.Clonable")],SW);class j9{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new j9;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,se(r.value),r.origin)}),i}get(t,i){i=this._normalizeOrigin(i);const r=this._values.get(t);return i==null||(r==null?void 0:r.origin)===i?r==null?void 0:r.value:void 0}originOf(t){var i,r;return(i=(r=this._values.get(t))==null?void 0:r.origin)!=null?i:oi.USER}keys(t){t=this._normalizeOrigin(t);const i=[...this._values.keys()];return t==null?i:i.filter(r=>{var s;return((s=this._values.get(r))==null?void 0:s.origin)===t})}set(t,i,r){if((r=this._normalizeOrigin(r))===oi.DEFAULTS){const s=this._values.get(t);if(s&&s.origin!=null&&s.origin>r)return}this._values.set(t,new _we(i,r))}delete(t,i){var r;(i=this._normalizeOrigin(i))!=null&&((r=this._values.get(t))==null?void 0:r.origin)!==i||this._values.delete(t)}has(t,i){var r;return(i=this._normalizeOrigin(i))!=null?((r=this._values.get(t))==null?void 0:r.origin)===i:this._values.has(t)}forEach(t){this._values.forEach(({value:i},r)=>t(i,r))}_normalizeOrigin(t){if(t!=null)return t===oi.DEFAULTS?t:oi.USER}}class _we{constructor(t,i){this.value=t,this.origin=i}}function ene(e,t,i){t.keys().forEach(s=>{i.set(s,t.get(s),oi.DEFAULTS)});const r=e.metadatas;Object.keys(r).forEach(s=>{e.internalGet(s)&&i.set(s,e.internalGet(s),oi.DEFAULTS)})}function bwe(e,t,i){if(!e||!e.read||e.read.enabled===!1||!e.read.source)return!1;const r=e.read.source;if(typeof r=="string"){if(r===t||r.indexOf(".")>-1&&r.indexOf(t)===0&&lW(r,i))return!0}else for(const s of r)if(s===t||s.indexOf(".")>-1&&s.indexOf(t)===0&&lW(s,i))return!0;return!1}function wwe(e){return e&&(!e.read||e.read.enabled!==!1&&!e.read.source)}function xwe(e,t,i,r,s){let n=cz(t[i],s);wwe(n)&&(e[i]=!0);for(const o of Object.getOwnPropertyNames(t))n=cz(t[o],s),bwe(n,i,r)&&(e[o]=!0)}function Twe(e,t,i,r){const s=i.metadatas,n=G9(s[t],"any",r),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(e,t,r):o;a!==void 0&&i.set(t,a)}const tne={origin:"service"};function ine(e,t,i=tne){if(!t||typeof t!="object")return;const r=Ta(e),s=r.metadatas,n={};for(const o of Object.getOwnPropertyNames(t))xwe(n,s,o,t,i);r.setDefaultOrigin(i.origin);for(const o of Object.getOwnPropertyNames(n)){const a=cz(s[o],i).read,l=a&&a.source;let c;c=l&&typeof l=="string"?fR(t,l):t[o],a&&a.reader&&(c=a.reader.call(e,c,t,i)),c!==void 0&&r.set(o,c)}if(!i||!i.ignoreDefaults){r.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||Twe(e,o,r,i)}r.setDefaultOrigin("user")}function Swe(e,t,i,r=tne){var s;const n=me(I({},r),{messages:[]});i(n),(s=n.messages)==null||s.forEach(o=>{o.type!=="warning"||e.loaded?r&&r.messages&&r.messages.push(o):e.loadWarnings.push(o)})}const Ewe=he.getLogger("esri.core.accessorSupport.write");function Awe(e,t,i,r,s){var n,o;const a={};return(n=t.write)==null||(o=n.writer)==null||o.call(e,r,a,i,s),a}function rne(e,t,i,r,s,n){if(!r||!r.write)return!1;const o=e.get(i);if(!s&&r.write.overridePolicy){const a=r.write.overridePolicy.call(e,o,i,n);a!==void 0&&(s=a)}if(s||(s=r.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new Q("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return a&&n&&n.messages?n.messages.push(a):a&&!n&&Ewe.error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||(!t.store.multipleOriginsSupported||t.store.originOf(i)===oi.DEFAULTS)&&Cwe(e,i,n,r,o)||!s.ignoreOrigin&&n&&n.origin&&t.store.multipleOriginsSupported&&t.store.originOf(i)<wy(n.origin))}function Cwe(e,t,i,r,s){const n=r.default;if(n===void 0)return!1;if(r.defaultEquals!=null)return r.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(e,t,i);return J_(o,s)}return!1}return n===s}function Rwe(e,t,i,r){const s=Ta(e),n=s.metadatas,o=Jse(n[t],r);return!!o&&rne(e,s,t,o,i,r)}function sne(e,t,i){if(e&&typeof e.toJSON=="function"&&(!e.toJSON.isDefaultToJSON||!e.write))return c3(t,e.toJSON());const r=Ta(e),s=r.metadatas;for(const a in s){const l=Jse(s[a],i);if(!rne(e,r,a,l,void 0,i))continue;const c=e.get(a),h=Awe(e,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,i);var n,o;Object.keys(h).length>0&&(t=c3(t,h),i!=null&&(n=i.resources)!=null&&(o=n.pendingOperations)!=null&&o.length&&Promise.all(i.resources.pendingOperations).then(()=>c3(t,h)),i&&i.writtenProperties&&i.writtenProperties.push({target:e,propName:a,oldOrigin:nbe(r.store.originOf(a)),newOrigin:i.origin}))}return t}const bR=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ta(this),s=r.store,n=new j9;r.store=n,ene(r,s,n)}read(i,r){ine(this,i,r)}write(i={},r){return sne(this,i,r)}toJSON(i){return this.write({},i)}static fromJSON(i,r){return Owe.call(this,i,r)}};return t=u([P("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function Owe(e,t){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const i=new this;return i.read(e,t),i}let ve=class extends bR(we){};ve=u([P("esri.core.JSONSupport")],ve);function M(){return[0,0,0]}function Ts(e){return[e[0],e[1],e[2]]}function je(e,t,i){return[e,t,i]}function aa(e){const t=M(),i=Math.min(3,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function H9(e,t){return new Float64Array(e,t,3)}function nne(){return M()}function one(){return je(1,1,1)}function ane(){return je(1,0,0)}function lne(){return je(0,1,0)}function q9(){return je(0,0,1)}const cl=nne(),Kd=one(),Mwe=ane(),Pwe=lne(),cne=q9();Object.freeze({__proto__:null,create:M,clone:Ts,fromValues:je,fromArray:aa,createView:H9,zeros:nne,ones:one,unitX:ane,unitY:lne,unitZ:q9,ZEROS:cl,ONES:Kd,UNIT_X:Mwe,UNIT_Y:Pwe,UNIT_Z:cne});const wt=1e-6,Sh=Math.random,Iwe=Math.PI/180,$we=180/Math.PI;function IL(e){return e*Iwe}function Dwe(e){return e*$we}function Lwe(e,t){return Math.abs(e-t)<=wt*Math.max(1,Math.abs(e),Math.abs(t))}Object.freeze({__proto__:null,EPSILON:wt,RANDOM:Sh,toRadian:IL,toDegree:Dwe,equals:Lwe});function Pe(e){const t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)}function ne(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function oe(e,t,i,r){return e[0]=t,e[1]=i,e[2]=r,e}function pe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function de(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function W9(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function _$(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function Nwe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function Fwe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function une(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function hne(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function Uwe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function ae(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function hz(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function xi(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)}function ko(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function Fo(e){const t=e[0],i=e[1],r=e[2];return t*t+i*i+r*r}function lo(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function kwe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function be(e,t){const i=t[0],r=t[1],s=t[2];let n=i*i+r*r+s*s;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function _e(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function dt(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];return e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o,e}function Ss(e,t,i,r){const s=t[0],n=t[1],o=t[2];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e}function zwe(e,t,i,r,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return e[0]=t[0]*a+i[0]*l+r[0]*c+s[0]*h,e[1]=t[1]*a+i[1]*l+r[1]*c+s[1]*h,e[2]=t[2]*a+i[2]*l+r[2]*c+s[2]*h,e}function Bwe(e,t,i,r,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return e[0]=t[0]*c+i[0]*h+r[0]*p+s[0]*f,e[1]=t[1]*c+i[1]*h+r[1]*p+s[1]*f,e[2]=t[2]*c+i[2]*h+r[2]*p+s[2]*f,e}function Vwe(e,t){t=t||1;const i=2*Sh()*Math.PI,r=2*Sh()-1,s=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*s,e[1]=Math.sin(i)*s,e[2]=r*t,e}function Ue(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12],e[1]=i[1]*r+i[5]*s+i[9]*n+i[13],e[2]=i[2]*r+i[6]*s+i[10]*n+i[14],e}function rl(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=r*i[0]+s*i[3]+n*i[6],e[1]=r*i[1]+s*i[4]+n*i[7],e[2]=r*i[2]+s*i[5]+n*i[8],e}function Ky(e,t,i){const r=i[0],s=i[1],n=i[2],o=i[3],a=t[0],l=t[1],c=t[2];let h=s*c-n*l,p=n*a-r*c,f=r*l-s*a,g=s*f-n*p,y=n*h-r*f,v=r*p-s*h;const b=2*o;return h*=b,p*=b,f*=b,g*=2,y*=2,v*=2,e[0]=a+h+g,e[1]=l+p+y,e[2]=c+f+v,e}function Gwe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function jwe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function Hwe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function qwe(e,t){ne(wO,e),ne(xO,t),be(wO,wO),be(xO,xO);const i=_e(wO,xO);return i>1?0:i<-1?Math.PI:Math.acos(i)}const wO=M(),xO=M();function Wwe(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function sl(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Yx(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=t[0],o=t[1],a=t[2];return Math.abs(i-n)<=wt*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=wt*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=wt*Math.max(1,Math.abs(s),Math.abs(a))}function Am(e,t,i){const r=i[0]-t[0],s=i[1]-t[1],n=i[2]-t[2];let o=r*r+s*s+n*n;return o>0?(o=1/Math.sqrt(o),e[0]=r*o,e[1]=s*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)}const lp=de,Xwe=W9,Ywe=_$,X9=xi,Y9=ko,Z9=Pe,dz=Fo,EW=Object.freeze({__proto__:null,length:Pe,copy:ne,set:oe,add:pe,subtract:de,multiply:W9,divide:_$,ceil:Nwe,floor:Fwe,min:une,max:hne,round:Uwe,scale:ae,scaleAndAdd:hz,distance:xi,squaredDistance:ko,squaredLength:Fo,negate:lo,inverse:kwe,normalize:be,dot:_e,cross:dt,lerp:Ss,hermite:zwe,bezier:Bwe,random:Vwe,transformMat4:Ue,transformMat3:rl,transformQuat:Ky,rotateX:Gwe,rotateY:jwe,rotateZ:Hwe,angle:qwe,str:Wwe,exactEquals:sl,equals:Yx,direction:Am,sub:lp,mul:Xwe,div:Ywe,dist:X9,sqrDist:Y9,len:Z9,sqrLen:dz});function fa(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function zo(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function Q9(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function dne(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function pne(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function fne(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function Zwe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function Qwe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Jwe(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e}function Kwe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e}function exe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function wR(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function txe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}function mne(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(i*i+r*r+s*s+n*n)}function b$(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return i*i+r*r+s*s+n*n}function J9(e){const t=e[0],i=e[1],r=e[2],s=e[3];return Math.sqrt(t*t+i*i+r*r+s*s)}function K9(e){const t=e[0],i=e[1],r=e[2],s=e[3];return t*t+i*i+r*r+s*s}function ixe(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function rxe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function gne(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*i+r*r+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=s*o,e[3]=n*o),e}function yne(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function eG(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e[3]=a+r*(i[3]-a),e}function sxe(e,t){let i,r,s,n,o,a;t=t||1;do i=2*Sh()-1,r=2*Sh()-1,o=i*i+r*r;while(o>=1);do s=2*Sh()-1,n=2*Sh()-1,a=s*s+n*n;while(a>=1);const l=Math.sqrt((1-o)/a);return e[0]=t*i,e[1]=t*r,e[2]=t*s*l,e[3]=t*n*l,e}function bu(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12]*o,e[1]=i[1]*r+i[5]*s+i[9]*n+i[13]*o,e[2]=i[2]*r+i[6]*s+i[10]*n+i[14]*o,e[3]=i[3]*r+i[7]*s+i[11]*n+i[15]*o,e}function nxe(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2],c=i[3],h=c*r+a*n-l*s,p=c*s+l*r-o*n,f=c*n+o*s-a*r,g=-o*r-a*s-l*n;return e[0]=h*c+g*-o+p*-l-f*-a,e[1]=p*c+g*-a+f*-o-h*-l,e[2]=f*c+g*-l+h*-a-p*-o,e[3]=t[3],e}function oxe(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function t1(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function vne(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=wt*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=wt*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=wt*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=wt*Math.max(1,Math.abs(n),Math.abs(c))}const axe=dne,lxe=pne,cxe=fne,uxe=mne,hxe=b$,dxe=J9,pxe=K9,_ne=Object.freeze({__proto__:null,copy:fa,set:zo,add:Q9,subtract:dne,multiply:pne,divide:fne,ceil:Zwe,floor:Qwe,min:Jwe,max:Kwe,round:exe,scale:wR,scaleAndAdd:txe,distance:mne,squaredDistance:b$,length:J9,squaredLength:K9,negate:ixe,inverse:rxe,normalize:gne,dot:yne,lerp:eG,random:sxe,transformMat4:bu,transformQuat:nxe,str:oxe,exactEquals:t1,equals:vne,sub:axe,mul:lxe,div:cxe,dist:uxe,sqrDist:hxe,len:dxe,sqrLen:pxe}),AW=new Float32Array(1);function Zx(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}function ze(e,t,i){return Math.min(Math.max(e,t),i)}function Qx(e){return(e&e-1)==0}function jut(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Hut(e){return 10**Math.ceil(Math.LOG10E*Math.log(e))}function qt(e,t,i){return e+(t-e)*i}function Ct(e){return e*Math.PI/180}function pl(e){return 180*e/Math.PI}function pz(e,t=1e-6){return(e<0?-1:1)/Math.max(Math.abs(e),t)}function Es(e){return Math.acos(ze(e,-1,1))}function Uh(e){return Math.asin(ze(e,-1,1))}function fxe(e,t,i=1e-6){if(isNaN(e)||isNaN(t))return!1;if(e===t)return!0;const r=Math.abs(e-t),s=Math.abs(e),n=Math.abs(t);if(e===0||t===0||s<1e-12&&n<1e-12){if(r>.01*i)return!1}else if(r/(s+n)>i)return!1;return!0}function u4(e,t,i=1e-6){return isNaN(e)||isNaN(t)?!1:(e>t?e-t:t-e)<=i}function mxe(e){return bne(Math.max(-fz,Math.min(e,fz)))}function bne(e){return AW[0]=e,AW[0]}function Jx(e,t,i){const r=ze((i-e)/(t-e),0,1);return r*r*(3-2*r)}function CW(e,t){const i=Pe(e),r=Uh(e[2]/i),s=Math.atan2(e[1]/i,e[0]/i);return oe(t,i,r,s),t}function qut(e,t,i){return zo(e,t[0],t[1],t[2],t[3]*i)}const fz=bne(34028234663852886e22),gxe=Object.prototype.toString;function yxe(e){const t="__accessorMetadata__"in e?ns(e):e;return function(...i){if(i.push(t),typeof i[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return vxe.apply(this,i)}}function vxe(e,t,i,r){SL(e,t).cast=r}function _xe(e){return function(t,i){SL(t,e).cast=t[i]}}function It(...e){if(e.length!==3||typeof e[1]!="string")return e.length===1&&gxe.call(e[0])==="[object Function]"?yxe(e[0]):e.length===1&&typeof e[0]=="string"?_xe(e[0]):void 0}function Fe(e,t,i){let r,s;return t===void 0||Array.isArray(t)?(s=e,i=t,r=[void 0]):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;r.forEach(l=>{const c=Hse(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],i&&(c.read.source=(c.read.source||[]).concat(i))})}}function Ge(e,t,i){let r,s;return t===void 0?(s=e,r=[void 0]):typeof t!="string"?(s=e,r=[void 0],i=t):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;for(const l of r){const c=Hse(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),i&&(c.write.target=i),c.write.writer=a[o]}}}var pu;(function(e){e[e.CGCS2000=4490]="CGCS2000",e[e.GCSMARS2000=104971]="GCSMARS2000",e[e.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",e[e.GCSMOON2000=104903]="GCSMOON2000"})(pu||(pu={}));let m;const D={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22332:0,22391:0,22392:0,22700:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102962:0,102963:0,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(m=2e3;m<=2045;m++)D[m]=0;for(m=2056;m<=2065;m++)D[m]=0;for(m=2067;m<=2135;m++)D[m]=0;for(m=2137;m<=2154;m++)D[m]=0;for(m=2161;m<=2170;m++)D[m]=0;for(m=2172;m<=2193;m++)D[m]=0;for(m=2195;m<=2198;m++)D[m]=0;for(m=2200;m<=2203;m++)D[m]=0;for(m=2205;m<=2217;m++)D[m]=0;for(m=2222;m<=2224;m++)D[m]=1;for(m=2225;m<=2250;m++)D[m]=2;for(m=2251;m<=2253;m++)D[m]=1;for(m=2257;m<=2264;m++)D[m]=2;for(m=2274;m<=2279;m++)D[m]=2;for(m=2280;m<=2282;m++)D[m]=1;for(m=2283;m<=2289;m++)D[m]=2;for(m=2290;m<=2292;m++)D[m]=0;for(m=2308;m<=2313;m++)D[m]=0;for(m=2315;m<=2491;m++)D[m]=0;for(m=2494;m<=2866;m++)D[m]=0;for(m=2867;m<=2869;m++)D[m]=1;for(m=2870;m<=2888;m++)D[m]=2;for(m=2891;m<=2895;m++)D[m]=2;for(m=2896;m<=2898;m++)D[m]=1;for(m=2902;m<=2908;m++)D[m]=2;for(m=2915;m<=2920;m++)D[m]=2;for(m=2921;m<=2923;m++)D[m]=1;for(m=2924;m<=2930;m++)D[m]=2;for(m=2931;m<=2962;m++)D[m]=0;for(m=2964;m<=2968;m++)D[m]=2;for(m=2969;m<=2973;m++)D[m]=0;for(m=2975;m<=2991;m++)D[m]=0;for(m=2995;m<=3051;m++)D[m]=0;for(m=3054;m<=3079;m++)D[m]=0;for(m=3081;m<=3088;m++)D[m]=0;for(m=3092;m<=3101;m++)D[m]=0;for(m=3106;m<=3138;m++)D[m]=0;for(m=3146;m<=3151;m++)D[m]=0;for(m=3153;m<=3166;m++)D[m]=0;for(m=3168;m<=3172;m++)D[m]=0;for(m=3174;m<=3203;m++)D[m]=0;for(m=3294;m<=3358;m++)D[m]=0;for(m=3367;m<=3403;m++)D[m]=0;for(m=3408;m<=3416;m++)D[m]=0;for(m=3417;m<=3438;m++)D[m]=2;for(m=3441;m<=3446;m++)D[m]=2;for(m=3447;m<=3450;m++)D[m]=0;for(m=3451;m<=3459;m++)D[m]=2;for(m=3460;m<=3478;m++)D[m]=0;for(m=3554;m<=3559;m++)D[m]=0;for(m=3560;m<=3570;m++)D[m]=2;for(m=3571;m<=3581;m++)D[m]=0;for(m=3594;m<=3597;m++)D[m]=0;for(m=3601;m<=3604;m++)D[m]=0;for(m=3637;m<=3639;m++)D[m]=0;for(m=3665;m<=3667;m++)D[m]=0;for(m=3693;m<=3695;m++)D[m]=0;for(m=3701;m<=3727;m++)D[m]=0;for(m=3728;m<=3739;m++)D[m]=2;for(m=3740;m<=3751;m++)D[m]=0;for(m=3753;m<=3760;m++)D[m]=2;for(m=3761;m<=3773;m++)D[m]=0;for(m=3775;m<=3777;m++)D[m]=0;for(m=3779;m<=3781;m++)D[m]=0;for(m=3783;m<=3785;m++)D[m]=0;for(m=3788;m<=3791;m++)D[m]=0;for(m=3797;m<=3802;m++)D[m]=0;for(m=3814;m<=3816;m++)D[m]=0;for(m=3825;m<=3829;m++)D[m]=0;for(m=3832;m<=3841;m++)D[m]=0;for(m=3844;m<=3852;m++)D[m]=0;for(m=3873;m<=3885;m++)D[m]=0;for(m=3890;m<=3893;m++)D[m]=0;for(m=3907;m<=3912;m++)D[m]=0;for(m=3942;m<=3950;m++)D[m]=0;for(m=3968;m<=3970;m++)D[m]=0;for(m=3973;m<=3976;m++)D[m]=0;for(m=3986;m<=3989;m++)D[m]=0;for(m=3994;m<=3997;m++)D[m]=0;for(m=4048;m<=4051;m++)D[m]=0;for(m=4056;m<=4063;m++)D[m]=0;for(m=4093;m<=4096;m++)D[m]=0;for(m=4390;m<=4398;m++)D[m]=0;for(m=4399;m<=4413;m++)D[m]=2;for(m=4418;m<=4433;m++)D[m]=2;for(m=4455;m<=4457;m++)D[m]=2;for(m=4484;m<=4489;m++)D[m]=0;for(m=4491;m<=4554;m++)D[m]=0;for(m=4568;m<=4589;m++)D[m]=0;for(m=4652;m<=4656;m++)D[m]=0;for(m=4766;m<=4800;m++)D[m]=0;for(m=5014;m<=5016;m++)D[m]=0;for(m=5069;m<=5072;m++)D[m]=0;for(m=5105;m<=5130;m++)D[m]=0;for(m=5173;m<=5188;m++)D[m]=0;for(m=5253;m<=5259;m++)D[m]=0;for(m=5269;m<=5275;m++)D[m]=0;for(m=5292;m<=5311;m++)D[m]=0;for(m=5329;m<=5331;m++)D[m]=0;for(m=5343;m<=5349;m++)D[m]=0;for(m=5355;m<=5357;m++)D[m]=0;for(m=5387;m<=5389;m++)D[m]=0;for(m=5459;m<=5463;m++)D[m]=0;for(m=5479;m<=5482;m++)D[m]=0;for(m=5518;m<=5520;m++)D[m]=0;for(m=5530;m<=5539;m++)D[m]=0;for(m=5550;m<=5552;m++)D[m]=0;for(m=5562;m<=5583;m++)D[m]=0;for(m=5623;m<=5625;m++)D[m]=2;for(m=5631;m<=5639;m++)D[m]=0;for(m=5649;m<=5653;m++)D[m]=0;for(m=5663;m<=5680;m++)D[m]=0;for(m=5682;m<=5685;m++)D[m]=0;for(m=5875;m<=5877;m++)D[m]=0;for(m=5896;m<=5899;m++)D[m]=0;for(m=5921;m<=5940;m++)D[m]=0;for(m=6050;m<=6125;m++)D[m]=0;for(m=6244;m<=6275;m++)D[m]=0;for(m=6328;m<=6348;m++)D[m]=0;for(m=6350;m<=6356;m++)D[m]=0;for(m=6366;m<=6372;m++)D[m]=0;for(m=6381;m<=6387;m++)D[m]=0;for(m=6393;m<=6404;m++)D[m]=0;for(m=6480;m<=6483;m++)D[m]=0;for(m=6511;m<=6514;m++)D[m]=0;for(m=6579;m<=6581;m++)D[m]=0;for(m=6619;m<=6624;m++)D[m]=0;for(m=6625;m<=6627;m++)D[m]=2;for(m=6628;m<=6632;m++)D[m]=0;for(m=6634;m<=6637;m++)D[m]=0;for(m=6669;m<=6692;m++)D[m]=0;for(m=6707;m<=6709;m++)D[m]=0;for(m=6720;m<=6723;m++)D[m]=0;for(m=6732;m<=6738;m++)D[m]=0;for(m=6931;m<=6933;m++)D[m]=0;for(m=6956;m<=6959;m++)D[m]=0;for(m=7005;m<=7007;m++)D[m]=0;for(m=7057;m<=7070;m++)D[m]=2;for(m=7074;m<=7082;m++)D[m]=0;for(m=7109;m<=7118;m++)D[m]=0;for(m=7119;m<=7127;m++)D[m]=1;for(m=7374;m<=7376;m++)D[m]=0;for(m=7528;m<=7586;m++)D[m]=0;for(m=7587;m<=7645;m++)D[m]=2;for(m=7692;m<=7696;m++)D[m]=0;for(m=7755;m<=7787;m++)D[m]=0;for(m=7791;m<=7795;m++)D[m]=0;for(m=7799;m<=7801;m++)D[m]=0;for(m=7803;m<=7805;m++)D[m]=0;for(m=7825;m<=7831;m++)D[m]=0;for(m=7845;m<=7859;m++)D[m]=0;for(m=8013;m<=8032;m++)D[m]=0;for(m=8065;m<=8068;m++)D[m]=1;for(m=8518;m<=8529;m++)D[m]=2;for(m=8533;m<=8536;m++)D[m]=2;for(m=8538;m<=8540;m++)D[m]=2;for(m=8677;m<=8679;m++)D[m]=0;for(m=8836;m<=8840;m++)D[m]=0;for(m=8857;m<=8859;m++)D[m]=0;for(m=8908;m<=8910;m++)D[m]=0;for(m=9154;m<=9159;m++)D[m]=0;for(m=9205;m<=9218;m++)D[m]=0;for(m=9271;m<=9273;m++)D[m]=0;for(m=9295;m<=9297;m++)D[m]=0;for(m=9356;m<=9360;m++)D[m]=0;for(m=9404;m<=9407;m++)D[m]=0;for(m=9476;m<=9482;m++)D[m]=0;for(m=9487;m<=9494;m++)D[m]=0;for(m=9697;m<=9699;m++)D[m]=0;for(m=20002;m<=20032;m++)D[m]=0;for(m=20062;m<=20092;m++)D[m]=0;for(m=20135;m<=20138;m++)D[m]=0;for(m=20248;m<=20258;m++)D[m]=0;for(m=20348;m<=20358;m++)D[m]=0;for(m=20436;m<=20440;m++)D[m]=0;for(m=20822;m<=20824;m++)D[m]=0;for(m=20904;m<=20932;m++)D[m]=0;for(m=20934;m<=20936;m++)D[m]=0;for(m=21004;m<=21032;m++)D[m]=0;for(m=21035;m<=21037;m++)D[m]=0;for(m=21095;m<=21097;m++)D[m]=0;for(m=21148;m<=21150;m++)D[m]=0;for(m=21207;m<=21264;m++)D[m]=0;for(m=21307;m<=21364;m++)D[m]=0;for(m=21413;m<=21423;m++)D[m]=0;for(m=21453;m<=21463;m++)D[m]=0;for(m=21473;m<=21483;m++)D[m]=0;for(m=21780;m<=21782;m++)D[m]=0;for(m=21891;m<=21894;m++)D[m]=0;for(m=21896;m<=21899;m++)D[m]=0;for(m=22171;m<=22177;m++)D[m]=0;for(m=22181;m<=22187;m++)D[m]=0;for(m=22191;m<=22197;m++)D[m]=0;for(m=22234;m<=22236;m++)D[m]=0;for(m=22521;m<=22525;m++)D[m]=0;for(m=22991;m<=22994;m++)D[m]=0;for(m=23028;m<=23038;m++)D[m]=0;for(m=23830;m<=23853;m++)D[m]=0;for(m=23866;m<=23872;m++)D[m]=0;for(m=23877;m<=23884;m++)D[m]=0;for(m=23886;m<=23894;m++)D[m]=0;for(m=23946;m<=23948;m++)D[m]=0;for(m=24311;m<=24313;m++)D[m]=0;for(m=24342;m<=24347;m++)D[m]=0;for(m=24370;m<=24374;m++)D[m]=10;for(m=24375;m<=24381;m++)D[m]=0;for(m=24718;m<=24721;m++)D[m]=0;for(m=24817;m<=24821;m++)D[m]=0;for(m=24877;m<=24882;m++)D[m]=0;for(m=24891;m<=24893;m++)D[m]=0;for(m=25391;m<=25395;m++)D[m]=0;for(m=25828;m<=25838;m++)D[m]=0;for(m=26191;m<=26195;m++)D[m]=0;for(m=26391;m<=26393;m++)D[m]=0;for(m=26701;m<=26722;m++)D[m]=0;for(m=26729;m<=26799;m++)D[m]=2;for(m=26801;m<=26803;m++)D[m]=2;for(m=26811;m<=26813;m++)D[m]=2;for(m=26847;m<=26870;m++)D[m]=2;for(m=26891;m<=26899;m++)D[m]=0;for(m=26901;m<=26923;m++)D[m]=0;for(m=26929;m<=26946;m++)D[m]=0;for(m=26948;m<=26998;m++)D[m]=0;for(m=27037;m<=27040;m++)D[m]=0;for(m=27205;m<=27232;m++)D[m]=0;for(m=27258;m<=27260;m++)D[m]=0;for(m=27391;m<=27398;m++)D[m]=0;for(m=27561;m<=27564;m++)D[m]=0;for(m=27571;m<=27574;m++)D[m]=0;for(m=27581;m<=27584;m++)D[m]=0;for(m=27591;m<=27594;m++)D[m]=0;for(m=28191;m<=28193;m++)D[m]=0;for(m=28348;m<=28358;m++)D[m]=0;for(m=28402;m<=28432;m++)D[m]=0;for(m=28462;m<=28492;m++)D[m]=0;for(m=29118;m<=29122;m++)D[m]=0;for(m=29168;m<=29172;m++)D[m]=0;for(m=29177;m<=29185;m++)D[m]=0;for(m=29187;m<=29195;m++)D[m]=0;for(m=29900;m<=29903;m++)D[m]=0;for(m=30161;m<=30179;m++)D[m]=0;for(m=30491;m<=30494;m++)D[m]=0;for(m=30729;m<=30732;m++)D[m]=0;for(m=31251;m<=31259;m++)D[m]=0;for(m=31265;m<=31268;m++)D[m]=0;for(m=31275;m<=31279;m++)D[m]=0;for(m=31281;m<=31297;m++)D[m]=0;for(m=31461;m<=31469;m++)D[m]=0;for(m=31491;m<=31495;m++)D[m]=0;for(m=31917;m<=31922;m++)D[m]=0;for(m=31965;m<=32e3;m++)D[m]=0;for(m=32001;m<=32003;m++)D[m]=2;for(m=32005;m<=32031;m++)D[m]=2;for(m=32033;m<=32060;m++)D[m]=2;for(m=32064;m<=32067;m++)D[m]=2;for(m=32074;m<=32077;m++)D[m]=2;for(m=32081;m<=32086;m++)D[m]=0;for(m=32107;m<=32130;m++)D[m]=0;for(m=32133;m<=32158;m++)D[m]=0;for(m=32164;m<=32167;m++)D[m]=2;for(m=32180;m<=32199;m++)D[m]=0;for(m=32201;m<=32260;m++)D[m]=0;for(m=32301;m<=32360;m++)D[m]=0;for(m=32601;m<=32662;m++)D[m]=0;for(m=32664;m<=32667;m++)D[m]=2;for(m=32701;m<=32761;m++)D[m]=0;for(m=53001;m<=53004;m++)D[m]=0;for(m=53008;m<=53019;m++)D[m]=0;for(m=53021;m<=53032;m++)D[m]=0;for(m=53034;m<=53037;m++)D[m]=0;for(m=53042;m<=53046;m++)D[m]=0;for(m=53074;m<=53080;m++)D[m]=0;for(m=54001;m<=54004;m++)D[m]=0;for(m=54008;m<=54019;m++)D[m]=0;for(m=54021;m<=54032;m++)D[m]=0;for(m=54034;m<=54037;m++)D[m]=0;for(m=54042;m<=54046;m++)D[m]=0;for(m=54048;m<=54053;m++)D[m]=0;for(m=54074;m<=54080;m++)D[m]=0;for(m=54098;m<=54101;m++)D[m]=0;for(m=102001;m<=102040;m++)D[m]=0;for(m=102042;m<=102063;m++)D[m]=0;for(m=102065;m<=102067;m++)D[m]=0;for(m=102070;m<=102117;m++)D[m]=0;for(m=102122;m<=102216;m++)D[m]=0;for(m=102221;m<=102377;m++)D[m]=0;for(m=102382;m<=102388;m++)D[m]=0;for(m=102389;m<=102398;m++)D[m]=2;for(m=102399;m<=102444;m++)D[m]=0;for(m=102445;m<=102447;m++)D[m]=2;for(m=102448;m<=102458;m++)D[m]=0;for(m=102459;m<=102468;m++)D[m]=2;for(m=102469;m<=102499;m++)D[m]=0;for(m=102500;m<=102519;m++)D[m]=1;for(m=102520;m<=102524;m++)D[m]=0;for(m=102525;m<=102529;m++)D[m]=2;for(m=102530;m<=102588;m++)D[m]=0;for(m=102590;m<=102598;m++)D[m]=0;for(m=102601;m<=102603;m++)D[m]=0;for(m=102605;m<=102628;m++)D[m]=0;for(m=102629;m<=102646;m++)D[m]=2;for(m=102648;m<=102700;m++)D[m]=2;for(m=102701;m<=102703;m++)D[m]=0;for(m=102707;m<=102730;m++)D[m]=2;for(m=102733;m<=102758;m++)D[m]=2;for(m=102767;m<=102900;m++)D[m]=0;for(m=102901;m<=102933;m++)D[m]=2;for(m=102934;m<=102950;m++)D[m]=13;for(m=102951;m<=102960;m++)D[m]=0;for(m=102965;m<=102969;m++)D[m]=0;for(m=102971;m<=102973;m++)D[m]=0;for(m=102975;m<=102989;m++)D[m]=0;for(m=102990;m<=102992;m++)D[m]=1;for(m=102997;m<=103002;m++)D[m]=0;for(m=103003;m<=103008;m++)D[m]=2;for(m=103009;m<=103011;m++)D[m]=0;for(m=103012;m<=103014;m++)D[m]=2;for(m=103019;m<=103021;m++)D[m]=0;for(m=103022;m<=103024;m++)D[m]=2;for(m=103029;m<=103031;m++)D[m]=0;for(m=103032;m<=103034;m++)D[m]=2;for(m=103065;m<=103068;m++)D[m]=0;for(m=103074;m<=103076;m++)D[m]=0;for(m=103077;m<=103079;m++)D[m]=1;for(m=103080;m<=103082;m++)D[m]=0;for(m=103083;m<=103085;m++)D[m]=2;for(m=103090;m<=103093;m++)D[m]=0;for(m=103097;m<=103099;m++)D[m]=0;for(m=103100;m<=103102;m++)D[m]=2;for(m=103107;m<=103109;m++)D[m]=0;for(m=103110;m<=103112;m++)D[m]=2;for(m=103113;m<=103116;m++)D[m]=0;for(m=103117;m<=103120;m++)D[m]=2;for(m=103153;m<=103157;m++)D[m]=0;for(m=103158;m<=103162;m++)D[m]=2;for(m=103163;m<=103165;m++)D[m]=0;for(m=103166;m<=103168;m++)D[m]=1;for(m=103169;m<=103171;m++)D[m]=2;for(m=103186;m<=103188;m++)D[m]=0;for(m=103189;m<=103191;m++)D[m]=2;for(m=103192;m<=103195;m++)D[m]=0;for(m=103196;m<=103199;m++)D[m]=2;for(m=103200;m<=103224;m++)D[m]=0;for(m=103225;m<=103227;m++)D[m]=1;for(m=103232;m<=103237;m++)D[m]=0;for(m=103238;m<=103243;m++)D[m]=2;for(m=103244;m<=103246;m++)D[m]=0;for(m=103247;m<=103249;m++)D[m]=2;for(m=103254;m<=103256;m++)D[m]=0;for(m=103257;m<=103259;m++)D[m]=2;for(m=103264;m<=103266;m++)D[m]=0;for(m=103267;m<=103269;m++)D[m]=2;for(m=103300;m<=103375;m++)D[m]=0;for(m=103381;m<=103383;m++)D[m]=0;for(m=103384;m<=103386;m++)D[m]=1;for(m=103387;m<=103389;m++)D[m]=0;for(m=103390;m<=103392;m++)D[m]=2;for(m=103397;m<=103399;m++)D[m]=0;for(m=103400;m<=103471;m++)D[m]=2;for(m=103476;m<=103478;m++)D[m]=0;for(m=103479;m<=103481;m++)D[m]=2;for(m=103486;m<=103488;m++)D[m]=0;for(m=103489;m<=103491;m++)D[m]=2;for(m=103492;m<=103495;m++)D[m]=0;for(m=103496;m<=103499;m++)D[m]=2;for(m=103528;m<=103543;m++)D[m]=0;for(m=103544;m<=103548;m++)D[m]=2;for(m=103549;m<=103551;m++)D[m]=0;for(m=103552;m<=103554;m++)D[m]=1;for(m=103555;m<=103557;m++)D[m]=2;for(m=103558;m<=103560;m++)D[m]=0;for(m=103571;m<=103573;m++)D[m]=0;for(m=103574;m<=103576;m++)D[m]=2;for(m=103577;m<=103580;m++)D[m]=0;for(m=103581;m<=103583;m++)D[m]=2;for(m=103595;m<=103694;m++)D[m]=0;for(m=103696;m<=103699;m++)D[m]=0;for(m=103700;m<=103793;m++)D[m]=2;for(m=103794;m<=103872;m++)D[m]=0;for(m=103900;m<=103971;m++)D[m]=2;const bxe={102113:!0,102100:!0,3857:!0,3785:!0},wxe={102113:!0,102100:!0,3857:!0,3785:!0,4326:!0},RW='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',TO=[-20037508342788905e-9,20037508342788905e-9],SO=[-20037508342787e-6,20037508342787e-6],wne={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:TO,origin:SO,dx:1e-5},102100:{wkTemplate:RW,valid:TO,origin:SO,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:TO,origin:SO,dx:1e-5},3857:{wkTemplate:RW,valid:TO,origin:SO,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function bc(e,t){return!O(e)&&!O(t)&&(e===t||(e.wkid!=null||t.wkid!=null?e.wkid===t.wkid||i1(e)&&i1(t)||t.latestWkid!=null&&e.wkid===t.latestWkid||e.latestWkid!=null&&t.wkid===e.latestWkid:!(!e.wkt||!t.wkt)&&e.wkt.toUpperCase()===t.wkt.toUpperCase()))}function Gy(e){return hc(e)&&e.wkid?wne[e.wkid]:null}function xne(e){return!!hc(e)&&(e.wkid?D[e.wkid]==null:!!e.wkt&&!!/^\s*GEOGCS/i.test(e.wkt))}function ZA(e){return!(wp(e)||xp(e))}function QA(e){return hc(e)&&e.wkid===4326}function Tne(e){return hc(e)&&e.wkid===pu.CGCS2000}function i1(e){return hc(e)&&e.wkid!=null&&bxe[e.wkid]===!0}function Sne(e){return hc(e)&&e.wkid===32662}function tG(e){return e===pu.GCSMARS2000||e===pu.GCSMARS2000_SPHERE}function wp(e){return hc(e)&&e.wkid!=null&&tG(e.wkid)}function iG(e){return e===pu.GCSMOON2000}function xp(e){return hc(e)&&e.wkid!=null&&iG(e.wkid)}function xxe(e){return hc(e)&&e.wkid!=null&&wxe[e.wkid]===!0}function hc(e){return _(e)&&(e.wkid!=null&&e.wkid>=2e3||e.wkt!=null)}const Txe={wkid:4326,wkt:ap(wne[4326].wkTemplate,{Central_Meridian:"0.0"})},Sxe={wkid:102100,latestWkid:3857},Exe={wkid:32662};var vd;let Zi=vd=class extends ve{constructor(e){super(e),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}static fromJSON(e){if(!e)return null;if(e.wkid){if(e.wkid===102100)return vd.WebMercator;if(e.wkid===4326)return vd.WGS84}const t=new vd;return t.read(e),t}normalizeCtorArgs(e){return e&&typeof e=="object"?e:{[typeof e=="string"?"wkt":"wkid"]:e}}get isWGS84(){return QA(this)}get isWebMercator(){return i1(this)}get isGeographic(){return xne(this)}get isWrappable(){return xxe(this)}writeWkt(e,t){this.wkid||(t.wkt=e)}clone(){if(this===vd.WGS84)return vd.WGS84;if(this===vd.WebMercator)return vd.WebMercator;const e=new vd;return this.wkid!=null?(e.wkid=this.wkid,this.latestWkid!=null&&(e.latestWkid=this.latestWkid),this.vcsWkid!=null&&(e.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(e.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(e.wkt=this.wkt),this.imageCoordinateSystem&&(e.imageCoordinateSystem=se(this.imageCoordinateSystem)),e}equals(e){if(e==null)return!1;if(this.imageCoordinateSystem||e.imageCoordinateSystem){if(this.imageCoordinateSystem==null||e.imageCoordinateSystem==null)return!1;const{id:t,referenceServiceName:i}=e.imageCoordinateSystem,{geodataXform:r}=e.imageCoordinateSystem,s=this.imageCoordinateSystem;return t==null||r?JSON.stringify(s)===JSON.stringify(e.imageCoordinateSystem):i?s.id===t&&s.referenceServiceName===i:s.id===t}return bc(this,e)}toJSON(e){return this.write(void 0,e)}};Zi.GCS_NAD_1927=null,Zi.WGS84=null,Zi.WebMercator=null,Zi.PlateCarree=null,u([d({readOnly:!0})],Zi.prototype,"isWGS84",null),u([d({readOnly:!0})],Zi.prototype,"isWebMercator",null),u([d({readOnly:!0})],Zi.prototype,"isGeographic",null),u([d({readOnly:!0})],Zi.prototype,"isWrappable",null),u([d({type:mr,json:{write:!0}})],Zi.prototype,"latestWkid",void 0),u([d({type:mr,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],Zi.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],Zi.prototype,"wkt",void 0),u([Ge("wkt"),Ge("web-scene","wkt")],Zi.prototype,"writeWkt",null),u([d({type:mr,json:{write:!0}})],Zi.prototype,"vcsWkid",void 0),u([d({type:mr,json:{write:!0}})],Zi.prototype,"latestVcsWkid",void 0),u([d()],Zi.prototype,"imageCoordinateSystem",void 0),Zi=vd=u([P("esri.geometry.SpatialReference")],Zi),Zi.prototype.toJSON.isDefaultToJSON=!0,Zi.GCS_NAD_1927=new Zi({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),Zi.WGS84=new Zi(Txe),Zi.WebMercator=new Zi(Sxe),Zi.PlateCarree=new Zi(Exe),Object.freeze&&(Object.freeze(Zi.GCS_NAD_1927),Object.freeze(Zi.WGS84),Object.freeze(Zi.WebMercator));const tt=Zi;let _d=class extends ve{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=tt.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,t){if(e instanceof tt)return e;if(e!=null){const i=new tt;return i.read(e,t),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,t){this.cache[e]=t}};u([d()],_d.prototype,"type",void 0),u([d({readOnly:!0})],_d.prototype,"cache",null),u([d({readOnly:!0})],_d.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],_d.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],_d.prototype,"hasZ",void 0),u([d({type:tt,json:{write:!0}})],_d.prototype,"spatialReference",void 0),u([Fe("spatialReference")],_d.prototype,"readSpatialReference",null),_d=u([P("esri.geometry.Geometry")],_d);const fl=_d;function Axe(e,t,i,r){var s;return e.x=e.x+t,e.y=e.y+i,r!=null&&(e.z=((s=e.z)!=null?s:0)+r),e}function Cxe(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.hasZ&&t.hasZ?e.z-t.z:0;return Math.sqrt(i*i+r*r+s*s)}class rG{constructor(t,i,r,s){this.semiMajorAxis=t,this.flattening=i,this.outerAtmosphereRimWidth=r;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}}const ai=new rG(6378137,1/298.257223563,3e5,.006694379990137799),ip=new rG(3396190,1/169.8944472236118,23e4),hm=new rG(1737400,0,0),Rxe=57.29577951308232,Oxe=.017453292519943;function OW(e){return e*Rxe}function MW(e){return e*Oxe}function PW(e){return e/ai.radius}function w$(e){return Math.PI/2-2*Math.atan(Math.exp(-e/ai.radius))}function mz(e){return e.wkid!=null||e.wkt!=null}const h4=[0,0];function x$(e,t,i,r,s){const n=e,o=s;if(o.spatialReference=i,"x"in n&&"x"in o)[o.x,o.y]=t(n.x,n.y,h4,r);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=t(n.xmin,n.ymin,h4,r),[o.xmax,o.ymax]=t(n.xmax,n.ymax,h4,r);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(t(p[f][0],p[f][1],[0,0],r)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=t(a[c][0],a[c][1],[0,0],r),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function Jf(e,t){const i=e&&(mz(e)?e:e.spatialReference),r=t&&(mz(t)?t:t.spatialReference);return!(e&&"type"in e&&e.type==="mesh"||t&&"type"in t&&t.type==="mesh"||!i||!r)&&(!!bc(r,i)||i1(r)&&QA(i)||i1(i)&&QA(r))}function z1(e,t){if(O(e))return null;const i=e.spatialReference,r=t&&(mz(t)?t:t.spatialReference);return Jf(i,r)?bc(i,r)?se(e):i1(r)?x$(e,Qw,tt.WebMercator,!1,se(e)):QA(r)?x$(e,rA,tt.WGS84,!1,se(e)):null:null}function Qw(e,t,i=[0,0]){t>89.99999?t=89.99999:t<-89.99999&&(t=-89.99999);const r=MW(t);return i[0]=MW(e)*ai.radius,i[1]=ai.halfSemiMajorAxis*Math.log((1+Math.sin(r))/(1-Math.sin(r))),i}function rA(e,t,i=[0,0],r=!1){const s=OW(e/ai.radius);return i[0]=r?s:s-360*Math.floor((s+180)/360),i[1]=OW(Math.PI/2-2*Math.atan(Math.exp(-t/ai.radius))),i}function Kf(e,t=!1,i=se(e)){return x$(e,Qw,tt.WebMercator,t,i)}function G2(e,t=!1,i=se(e)){return x$(e,rA,tt.WGS84,t,i)}var p3;const MS=[0,0];function IW(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}const EO=he.getLogger("esri.geometry.Point");let Qo=p3=class extends fl{constructor(...e){super(...e),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}static copy(e,t){t._set("x",e._get("x")),t._set("y",e._get("y")),t._set("z",e._get("z")),t._set("m",e._get("m"));const i=e._get("spatialReference");t._set("spatialReference",Object.isFrozen(i)?i:i.clone())}normalizeCtorArgs(e,t,i,r,s){let n;if(Array.isArray(e))n=e,s=t,e=n[0],t=n[1],i=n[2],r=n[3];else if(e&&typeof e=="object"){if(n=e,e=n.x!=null?n.x:n.longitude,t=n.y!=null?n.y:n.latitude,i=n.z,r=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new tt(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)EO.warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)EO.warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=Qw(n.longitude,n.latitude,MS);e=a[0],t=a[1]}}}else IW(i)?(s=i,i=null):IW(r)&&(s=r,r=null);const o={x:e,y:t};return o.x==null&&o.y!=null?EO.warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&EO.warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),i!=null&&(o.z=i),r!=null&&(o.m=r),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(e){e!==(this._get("m")!==void 0)&&(this._set("m",e?0:void 0),this._set("hasM",e))}get hasZ(){return this.z!==void 0}set hasZ(e){e!==(this._get("z")!==void 0)&&(this._set("z",e?0:void 0),this._set("hasZ",e))}get latitude(){const{spatialReference:e,x:t,y:i}=this;if(e){if(e.isWebMercator)return rA(t,i,MS)[1];if(e.isGeographic)return i}return null}set latitude(e){const{spatialReference:t,x:i}=this;t&&(t.isWebMercator?this._set("y",Qw(i,e,MS)[1]):t.isGeographic&&this._set("y",e),this._set("latitude",e))}get longitude(){const{x:e,y:t,spatialReference:i}=this;if(i){if(i.isWebMercator)return rA(e,t,MS)[0];if(i.isGeographic)return e}return null}set longitude(e){const{y:t,spatialReference:i}=this;i&&(i.isWebMercator?this._set("x",Qw(e,t,MS)[0]):i.isGeographic&&this._set("x",e),this._set("longitude",e))}writeX(e,t,i){t[i]=isNaN(e)?"NaN":e}readX(e){return typeof e=="string"?NaN:e}clone(){const e=new p3;return e.x=this.x,e.y=this.y,e.z=this.z,e.m=this.m,e.spatialReference=this.spatialReference,e}copy(e){return p3.copy(e,this),this}equals(e){if(O(e))return!1;const{x:t,y:i,z:r,m:s,spatialReference:n}=this,{z:o,m:a}=e;let{x:l,y:c,spatialReference:h}=e;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=Qw(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=rA(l,c),h=n}return t===l&&i===c&&r===o&&s===a&&n.wkid===h.wkid}offset(e,t,i){return Axe(this,e,t,i)}normalize(){if(!this.spatialReference)return this;const e=Gy(this.spatialReference);if(!e)return this;let t=this.x;const[i,r]=e.valid,s=2*r;let n;return t>r?(n=Math.ceil(Math.abs(t-r)/s),t-=n*s):t<i&&(n=Math.ceil(Math.abs(t-i)/s),t+=n*s),this._set("x",t),this}distance(e){return Cxe(this,e)}toArray(){const e=this.hasZ,t=this.hasM;return e&&t?[this.x,this.y,this.z,this.m]:e?[this.x,this.y,this.z]:t?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],Qo.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Qo.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Qo.prototype,"hasZ",null),u([d({type:Number})],Qo.prototype,"latitude",null),u([d({type:Number})],Qo.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),It(e=>isNaN(e)?e:ou(e))],Qo.prototype,"x",void 0),u([Ge("x")],Qo.prototype,"writeX",null),u([Fe("x")],Qo.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],Qo.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Qo.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],Qo.prototype,"m",void 0),Qo=p3=u([P("esri.geometry.Point")],Qo),Qo.prototype.toJSON.isDefaultToJSON=!0;const Ke=Qo;function r1(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],i=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],r=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}function Mxe(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),s=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return oe(e,i,r,s),e}function Wut(e,t,i){i=i||e;const r=_e(e,t);oe(i,e[0]-r*t[0],e[1]-r*t[1],e[2]-r*t[2]),be(i,i)}function Xut(e,t,i){Math.abs(e[0])>Math.abs(e[1])?oe(t,0,1,0):oe(t,1,0,0),dt(i,e,t),be(t,t),dt(t,i,e),be(i,i)}function AO(e,t,i,r,s,n){const o=e+(t-e)*s;return o+(i+(r-i)*s-o)*n}function Pxe(e,t,i,r=M()){const s=Pe(e),n=Pe(t),o=_e(e,t)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-i)*s+i*n)/Math.sin(a),c=l/s*Math.sin((1-i)*a),h=l/n*Math.sin(i*a);return ae(S_,e,c),ae(E_,t,h),pe(r,S_,E_)}return Ss(r,e,t,i)}function Yut(e,t,i,r=M(),s=M()){const n=Pe(e),o=Pe(t),a=_e(e,t)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(i*l),p=Math.sin((1-i)*l),f=(1-i)*n+i*o;{const g=f/c,y=g/o*h;ae(S_,e,g/n*p),ae(E_,t,y),pe(r,S_,E_)}{const g=1/n*(-Math.cos((1-i)*l)*l*f+p*(-n+o));ae(S_,e,g);const y=1/o*(Math.cos(i*l)*l*f+h*(-n+o));ae(E_,t,y),pe(s,S_,E_),ae(s,s,1/c)}return s}return Ss(r,e,t,i),de(s,t,e),be(s,s),s}function d4(e,t,i){e=be(S_,e),t=be(E_,t);const r=Es(_e(e,t));if(i){const s=dt($xe,e,t);if(_e(s,i)<0)return-r}return r}function f3(e){const t=e.length;return function(i){if(i<=e[0][0])return e[0][1];if(i>=e[t-1][0])return e[t-1][1];let r=1;for(;i>e[r][0];)r++;const s=e[r-1][0],n=e[r][0],o=(n-i)/(n-s);return o*e[r-1][1]+(1-o)*e[r][1]}}class e0{constructor(t,i){this.min=t,this.max=i,this.range=i-t}ndiff(t,i=0){return Math.ceil((t-i)/this.range)*this.range+i}_normalize(t,i,r,s=0,n=!1){return(r-=s)<t?r+=this.ndiff(t-r):r>i&&(r-=this.ndiff(r-i)),n&&r===i&&(r=t),r+s}normalize(t,i=0,r=!1){return this._normalize(this.min,this.max,t,i,r)}clamp(t,i=0){return ze(t-i,this.min,this.max)+i}monotonic(t,i,r){return t<i?i:i+this.ndiff(t-i,r)}minimalMonotonic(t,i,r){return this._normalize(t,t+this.range,i,r)}center(t,i,r){return i=this.monotonic(t,i,r),this.normalize((t+i)/2,r)}diff(t,i,r){return this.monotonic(t,i,r)-t}shortestSignedDiff(t,i){t=this.normalize(t);const r=(i=this.normalize(i))-t,s=i<t?this.minimalMonotonic(t,i)-t:i-this.minimalMonotonic(i,t);return Math.abs(r)<Math.abs(s)?r:s}contains(t,i,r){return i=this.minimalMonotonic(t,i),(r=this.minimalMonotonic(t,r))>t&&r<i}}function Zut(e,t,i,r){de($W,t,e),de(DW,i,e),dt(r,$W,DW),be(r,r),r[3]=-_e(e,r)}const $W=M(),DW=M();function sG(e){for(const t in e){const i=e[t];i instanceof Function&&(e[t]=i.bind(e))}return e}const Ixe=sG(new e0(0,2*Math.PI)),t0=sG(new e0(-Math.PI,Math.PI)),nG=sG(new e0(0,360)),$xe=M(),S_=M(),E_=M();let ef=class extends bp(ve){constructor(...e){super(...e),this.position=new Ke([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,t,i,r){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const s={position:e};return t!=null&&(s.heading=t),i!=null&&(s.tilt=i),r!=null&&(s.fov=r),s}return e}writePosition(e,t,i,r){const s=e.clone();s.x=ou(e.x||0),s.y=ou(e.y||0),s.z=e.hasZ?ou(e.z||0):e.z,t[i]=s.write({},r)}readPosition(e,t){const i=new Ke;return i.read(e,t),i.x=ou(i.x||0),i.y=ou(i.y||0),i.z=i.hasZ?ou(i.z||0):i.z,i}equals(e){return!!e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:Ke,json:{write:{isRequired:!0}}})],ef.prototype,"position",void 0),u([Ge("position")],ef.prototype,"writePosition",null),u([Fe("position")],ef.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),It(e=>nG.normalize(ou(e)))],ef.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),It(e=>ze(ou(e),-180,180))],ef.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],ef.prototype,"fov",void 0),ef=u([P("esri.Camera")],ef);const ml=ef,p4=[0,0];function xR(e,t){return!!_(t)&&sa(e,t.x,t.y,t.z)}function Qut(e,t){if(!t.points||t.points.length)return!1;for(const i of t.points)if(!Kx(e,i))return!1;return!0}function Dxe(e,t){const{xmin:i,ymin:r,zmin:s,xmax:n,ymax:o,zmax:a}=t;return e.hasZ&&t.hasZ?sa(e,i,r,s)&&sa(e,i,o,s)&&sa(e,n,o,s)&&sa(e,n,r,s)&&sa(e,i,r,a)&&sa(e,i,o,a)&&sa(e,n,o,a)&&sa(e,n,r,a):sa(e,i,r)&&sa(e,i,o)&&sa(e,n,o)&&sa(e,n,r)}function Kx(e,t){return sa(e,t[0],t[1])}function Lxe(e,t){return sa(e,t[0],t[1],t[2])}function sa(e,t,i,r){return t>=e.xmin&&t<=e.xmax&&i>=e.ymin&&i<=e.ymax&&(r==null||!e.hasZ||r>=e.zmin&&r<=e.zmax)}function Nxe(e,t){return p4[1]=t.y,p4[0]=t.x,Ene(e,p4)}function Ene(e,t){return Fxe(e.rings,t)}function Fxe(e,t){if(!e)return!1;if(Uxe(e))return LW(!1,e,t);let i=!1;for(let r=0,s=e.length;r<s;r++)i=LW(i,e[r],t);return i}function Uxe(e){return!Array.isArray(e[0][0])}function LW(e,t,i){const[r,s]=i;let n=e,o=0;for(let a=0,l=t.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=t[a],[p,f]=t[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<r&&(n=!n)}return n}function kxe(e,t){return xR(e,t)}function zxe(e,t){const i=e.hasZ&&t.hasZ;let r,s,n;if(e.xmin<=t.xmin){if(r=t.xmin,e.xmax<r)return!1}else if(r=e.xmin,t.xmax<r)return!1;if(e.ymin<=t.ymin){if(s=t.ymin,e.ymax<s)return!1}else if(s=e.ymin,t.ymax<s)return!1;if(i&&t.hasZ){if(e.zmin<=t.zmin){if(n=t.zmin,e.zmax<n)return!1}else if(n=e.zmin,t.zmax<n)return!1}return!0}function Bxe(e,t){const{points:i,hasZ:r}=t,s=r?Lxe:Kx;for(const n of i)if(s(e,n))return!0;return!1}const s1=[0,0],n1=[0,0],o1=[0,0],a1=[0,0],Vxe=[s1,n1,o1,a1],Ane=[[o1,s1],[s1,n1],[n1,a1],[a1,o1]];function Gxe(e,t){s1[0]=e.xmin,s1[1]=e.ymax,n1[0]=e.xmax,n1[1]=e.ymax,o1[0]=e.xmin,o1[1]=e.ymin,a1[0]=e.xmax,a1[1]=e.ymin;for(const i of Vxe)if(Ene(t,i))return!0;for(const i of t.rings){if(!i.length)continue;let r=i[0];if(Kx(e,r))return!0;for(let s=1;s<i.length;s++){const n=i[s];if(Kx(e,n)||Cne(r,n,Ane))return!0;r=n}}return!1}function jxe(e,t){s1[0]=e.xmin,s1[1]=e.ymax,n1[0]=e.xmax,n1[1]=e.ymax,o1[0]=e.xmin,o1[1]=e.ymin,a1[0]=e.xmax,a1[1]=e.ymin;const i=t.paths;for(const r of i){if(!i.length)continue;let s=r[0];if(Kx(e,s))return!0;for(let n=1;n<r.length;n++){const o=r[n];if(Kx(e,o)||Cne(s,o,Ane))return!0;s=o}}return!1}const wn=[0,0];function Hxe(e){for(let t=0;t<e.length;t++){const i=e[t];for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1];for(let a=t+1;a<e.length;a++)for(let l=0;l<e[a].length-1;l++){const c=e[a][l],h=e[a][l+1];if(gz(n,o,c,h,wn)&&!(wn[0]===n[0]&&wn[1]===n[1]||wn[0]===c[0]&&wn[1]===c[1]||wn[0]===o[0]&&wn[1]===o[1]||wn[0]===h[0]&&wn[1]===h[1]))return!0}}const r=i.length;if(!(r<=4))for(let s=0;s<r-3;s++){let n=r-1;s===0&&(n=r-2);const o=i[s],a=i[s+1];for(let l=s+2;l<n;l++){const c=i[l],h=i[l+1];if(gz(o,a,c,h,wn)&&!(wn[0]===o[0]&&wn[1]===o[1]||wn[0]===c[0]&&wn[1]===c[1]||wn[0]===a[0]&&wn[1]===a[1]||wn[0]===h[0]&&wn[1]===h[1]))return!0}}}return!1}function Cne(e,t,i){for(let r=0;r<i.length;r++)if(gz(e,t,i[r][0],i[r][1]))return!0;return!1}function gz(e,t,i,r,s){const[n,o]=e,[a,l]=t,[c,h]=i,[p,f]=r,g=p-c,y=n-c,v=a-n,b=f-h,w=o-h,S=l-o,T=b*v-g*S;if(T===0)return!1;const A=(g*w-b*y)/T,C=(v*w-S*y)/T;return A>=0&&A<=1&&C>=0&&C<=1&&(s&&(s[0]=n+A*(a-n),s[1]=o+A*(l-o)),!0)}function qxe(e){switch(e){case"esriGeometryEnvelope":case"extent":return zxe;case"esriGeometryMultipoint":case"multipoint":return Bxe;case"esriGeometryPoint":case"point":return kxe;case"esriGeometryPolygon":case"polygon":return Gxe;case"esriGeometryPolyline":case"polyline":return jxe}}var Uc;function Wxe(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}function Gm(e,t,i){return t==null?i:i==null?t:e(t,i)}let tn=Uc=class extends fl{constructor(...e){super(...e),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(e,t,i,r,s){return Wxe(e)?{spatialReference:e,xmin:0,ymin:0,xmax:0,ymax:0}:typeof e=="object"?(e.spatialReference=e.spatialReference==null?tt.WGS84:e.spatialReference,e):{xmin:e,ymin:t,xmax:i,ymax:r,spatialReference:s==null?tt.WGS84:s}}static fromBounds(e,t){return new Uc({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}static fromPoint(e){return new Uc({xmin:e.x,ymin:e.y,zmin:e.z,xmax:e.x,ymax:e.y,zmax:e.z,spatialReference:e.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const e=new Ke({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(e.z=.5*(this.zmin+this.zmax)),this.hasM&&(e.m=.5*(this.mmin+this.mmax)),e}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(e){const t=this.center;return e.z!=null&&this.hasZ?this.offset(e.x-t.x,e.y-t.y,e.z-t.z):this.offset(e.x-t.x,e.y-t.y)}clone(){const e=new Uc;return e.xmin=this.xmin,e.ymin=this.ymin,e.xmax=this.xmax,e.ymax=this.ymax,e.spatialReference=this.spatialReference,this.zmin!=null&&(e.zmin=this.zmin,e.zmax=this.zmax),this.mmin!=null&&(e.mmin=this.mmin,e.mmax=this.mmax),e}contains(e){if(!e)return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&Jf(t,i)&&(e=t.isWebMercator?Kf(e):G2(e,!0)),e.type==="point"?xR(this,e):e.type==="extent"&&Dxe(this,e)}equals(e){if(this===e)return!0;if(O(e))return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&Jf(t,i)&&(e=t.isWebMercator?Kf(e):G2(e,!0)),this.xmin===e.xmin&&this.ymin===e.ymin&&this.zmin===e.zmin&&this.mmin===e.mmin&&this.xmax===e.xmax&&this.ymax===e.ymax&&this.zmax===e.zmax&&this.mmax===e.mmax}expand(e){const t=.5*(1-e),i=this.width*t,r=this.height*t;if(this.xmin+=i,this.ymin+=r,this.xmax-=i,this.ymax-=r,this.hasZ){const s=(this.zmax-this.zmin)*t;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*t;this.mmin+=s,this.mmax-=s}return this}intersects(e){if(O(e))return!1;e.type==="mesh"&&(e=e.extent);const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&Jf(t,i)&&(e=t.isWebMercator?Kf(e):G2(e,!0)),qxe(e.type)(this,e)}normalize(){const e=this._normalize(!1,!0);return Array.isArray(e)?e:[e]}offset(e,t,i){return this.xmin+=e,this.ymin+=t,this.xmax+=e,this.ymax+=t,i!=null&&(this.zmin+=i,this.zmax+=i),this}shiftCentralMeridian(){return this._normalize(!0)}union(e){return this===e||(this.xmin=Math.min(this.xmin,e.xmin),this.ymin=Math.min(this.ymin,e.ymin),this.xmax=Math.max(this.xmax,e.xmax),this.ymax=Math.max(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=Gm(Math.min,this.zmin,e.zmin),this.zmax=Gm(Math.max,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=Gm(Math.min,this.mmin,e.mmin),this.mmax=Gm(Math.max,this.mmax,e.mmax))),this}intersection(e){return this===e?this:O(e)||!this.intersects(e)?null:(this.xmin=Math.max(this.xmin,e.xmin),this.ymin=Math.max(this.ymin,e.ymin),this.xmax=Math.min(this.xmax,e.xmax),this.ymax=Math.min(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=Gm(Math.max,this.zmin,e.zmin),this.zmax=Gm(Math.min,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=Gm(Math.max,this.mmin,e.mmin),this.mmax=Gm(Math.min,this.mmax,e.mmax)),this)}toJSON(e){return this.write({},e)}_shiftCM(e=Gy(this.spatialReference)){if(!e||!this.spatialReference)return this;const t=this.spatialReference,i=this._getCM(e);if(i){const r=t.isWebMercator?G2(i):i;this.xmin-=i.x,this.xmax-=i.x,t.isWebMercator||(r.x=this._normalizeX(r.x,e).x),this.spatialReference=new tt(ap(t.isWGS84?e.altTemplate:e.wkTemplate,{Central_Meridian:r.x}))}return this}_getCM(e){let t=null;const[i,r]=e.valid,s=this.xmin,n=this.xmax;return s>=i&&s<=r&&n>=i&&n<=r||(t=this.center),t}_normalize(e,t,i){const r=this.spatialReference;if(!r)return this;if(!(i=i||Gy(r)))return this;const s=this._getParts(i).map(a=>a.extent);if(s.length<2)return s[0]||this;if(s.length>2)return e?this._shiftCM(i):this.set({xmin:i.valid[0],xmax:i.valid[1]});if(e)return this._shiftCM(i);if(t)return s;let n=!0,o=!0;return s.forEach(a=>{a.hasZ||(n=!1),a.hasM||(o=!1)}),{rings:s.map(a=>{const l=[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]];if(n){const c=(a.zmax-a.zmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}if(o){const c=(a.mmax-a.mmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}return l}),hasZ:n,hasM:o,spatialReference:r}}_getParts(e){let t=this.cache._parts;if(!t){t=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;e=e||Gy(o);const[p,f]=e.valid;h=this._normalizeX(this.xmin,e);const g=h.x,y=h.frameId;h=this._normalizeX(this.xmax,e);const v=h.x,b=h.frameId,w=g===v&&a>0;if(a>2*f){const S=new Uc(l<c?g:v,s,f,n,o),T=new Uc(p,s,l<c?v:g,n,o),A=new Uc(0,s,f,n,o),C=new Uc(p,s,0,n,o),R=[],L=[];S.contains(A)&&R.push(y),S.contains(C)&&L.push(y),T.contains(A)&&R.push(b),T.contains(C)&&L.push(b);for(let U=y+1;U<b;U++)R.push(U),L.push(U);t.push({extent:S,frameIds:[y]},{extent:T,frameIds:[b]},{extent:A,frameIds:R},{extent:C,frameIds:L})}else g>v||w?t.push({extent:new Uc(g,s,f,n,o),frameIds:[y]},{extent:new Uc(p,s,v,n,o),frameIds:[b]}):t.push({extent:new Uc(g,s,v,n,o),frameIds:[y]});this.cache._parts=t}const i=this.hasZ,r=this.hasM;if(i||r){const s={};i&&(s.zmin=this.zmin,s.zmax=this.zmax),r&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<t.length;n++)t[n].extent.set(s)}return t}_normalizeX(e,t){const[i,r]=t.valid,s=2*r;let n,o=0;return e>r?(n=Math.ceil(Math.abs(e-r)/s),e-=n*s,o=n):e<i&&(n=Math.ceil(Math.abs(e-i)/s),e+=n*s,o=-n),{x:e,frameId:o}}};u([d({readOnly:!0})],tn.prototype,"cache",null),u([d({readOnly:!0})],tn.prototype,"center",null),u([d({readOnly:!0})],tn.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],tn.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],tn.prototype,"hasZ",null),u([d({readOnly:!0})],tn.prototype,"height",null),u([d({readOnly:!0})],tn.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],tn.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],tn.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],tn.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],tn.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],tn.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],tn.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],tn.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],tn.prototype,"zmax",void 0),tn=Uc=u([P("esri.geometry.Extent")],tn),tn.prototype.toJSON.isDefaultToJSON=!0;const Zt=tn;function eT(e,t,i=!1){let{hasM:r,hasZ:s}=e;Array.isArray(t)?t.length!==4||r||s?t.length===3&&i&&!r?(s=!0,r=!1):t.length===3&&r&&s&&(r=!1,s=!1):(r=!0,s=!0):(s=!s&&t.hasZ&&(!r||t.hasM),r=!r&&t.hasM&&(!s||t.hasZ)),e.hasZ=s,e.hasM=r}var yz;function NW(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}function Xxe(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}let Sg=yz=class extends fl{constructor(...e){super(...e),this.points=[],this.type="multipoint"}normalizeCtorArgs(e,t){if(!e&&!t)return null;const i={};Array.isArray(e)?(i.points=e,i.spatialReference=t):Xxe(e)?i.spatialReference=e:(e.points&&(i.points=e.points),e.spatialReference&&(i.spatialReference=e.spatialReference),e.hasZ&&(i.hasZ=e.hasZ),e.hasM&&(i.hasM=e.hasM));const r=i.points&&i.points[0];return r&&(i.hasZ===void 0&&i.hasM===void 0?(i.hasZ=r.length>2,i.hasM=!1):i.hasZ===void 0?i.hasZ=r.length>3:i.hasM===void 0&&(i.hasM=r.length>3)),i}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const e=this.points;if(!e.length)return null;const t=new Zt,i=this.hasZ,r=this.hasM,s=i?3:2,n=e[0],o=NW(Math.min),a=NW(Math.max);let l,c,h,p,[f,g]=n,[y,v]=n;for(let b=0,w=e.length;b<w;b++){const S=e[b],[T,A]=S;if(f=o(f,T),g=o(g,A),y=a(y,T),v=a(v,A),i&&S.length>2){const C=S[2];l=o(l,C),h=a(h,C)}if(r&&S.length>s){const C=S[s];c=o(c,C),p=a(p,C)}}return t.xmin=f,t.ymin=g,t.xmax=y,t.ymax=v,t.spatialReference=this.spatialReference,i?(t.zmin=l,t.zmax=h):(t.zmin=null,t.zmax=null),r?(t.mmin=c,t.mmax=p):(t.mmin=null,t.mmax=null),t}writePoints(e,t){t.points=se(this.points)}addPoint(e){return eT(this,e),Array.isArray(e)?this.points.push(e):this.points.push(e.toArray()),this.notifyChange("points"),this}clone(){const e={points:se(this.points),spatialReference:this.spatialReference};return this.hasZ&&(e.hasZ=!0),this.hasM&&(e.hasM=!0),new yz(e)}getPoint(e){if(!this._validateInputs(e))return null;const t=this.points[e],i={x:t[0],y:t[1],spatialReference:this.spatialReference};let r=2;return this.hasZ&&(i.z=t[2],r=3),this.hasM&&(i.m=t[r]),new Ke(i)}removePoint(e){if(!this._validateInputs(e))return null;const t=new Ke(this.points.splice(e,1)[0],this.spatialReference);return this.notifyChange("points"),t}setPoint(e,t){return this._validateInputs(e)?(eT(this,t),Array.isArray(t)||(t=t.toArray()),this.points[e]=t,this.notifyChange("points"),this):this}toJSON(e){return this.write({},e)}_validateInputs(e){return e!=null&&e>=0&&e<this.points.length}};u([d({readOnly:!0})],Sg.prototype,"cache",null),u([d()],Sg.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],Sg.prototype,"points",void 0),u([Ge("points")],Sg.prototype,"writePoints",null),Sg=yz=u([P("esri.geometry.Multipoint")],Sg),Sg.prototype.toJSON.isDefaultToJSON=!0;const B1=Sg;function oG(e,t){const i=t[0]-e[0],r=t[1]-e[1];if(e.length>2&&t.length>2){const s=e[2]-t[2];return Math.sqrt(i*i+r*r+s*s)}return Math.sqrt(i*i+r*r)}function Rne(e,t,i){const r=e[0]+i*(t[0]-e[0]),s=e[1]+i*(t[1]-e[1]);return e.length>2&&t.length>2?[r,s,e[2]+i*(t[2]-e[2])]:[r,s]}function Yxe(e,t){return Rne(e,t,.5)}function One(e){const t=e.length;let i=0;for(let r=0;r<t-1;++r)i+=oG(e[r],e[r+1]);return i}function Mne(e,t){if(t<=0)return e[0];const i=e.length;let r=0;for(let s=0;s<i-1;++s){const n=oG(e[s],e[s+1]);if(t-r<n){const o=(t-r)/n;return Rne(e[s],e[s+1],o)}r+=n}return e[i-1]}function aG(e,t,i){const r=e.length;let s=0,n=0,o=0;for(let a=0;a<r;a++){const l=e[a],c=e[(a+1)%r];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&i&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&t&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function Jut(e){return e?e.hasZ?[e.xmax-e.xmin/2,e.ymax-e.ymin/2,e.zmax-e.zmin/2]:[e.xmax-e.xmin/2,e.ymax-e.ymin/2]:null}function Zxe(e){return e?Pne(e.rings,e.hasZ):null}function Pne(e,t){if(!e||!e.length)return null;const i=[],r=[],s=t?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=e.length;n<o;n++){const a=Qxe(e[n],t,s);a&&r.push(a)}if(r.sort((n,o)=>{let a=n[2]-o[2];return a===0&&t&&(a=n[4]-o[4]),a}),r.length&&(i[0]=r[0][0],i[1]=r[0][1],t&&(i[2]=r[0][3]),(i[0]<s[0]||i[0]>s[1]||i[1]<s[2]||i[1]>s[3]||t&&(i[2]<s[4]||i[2]>s[5]))&&(i.length=0)),!i.length){const n=e[0]&&e[0].length?Jxe(e[0],t):null;if(!n)return null;i[0]=n[0],i[1]=n[1],t&&n.length>2&&(i[2]=n[2])}return i}function Qxe(e,t,i){let r=0,s=0,n=0,o=0,a=0;const l=e.length?e[0][0]:0,c=e.length?e[0][1]:0,h=e.length&&t?e[0][2]:0;for(let f=0;f<e.length;f++){const g=e[f],y=e[(f+1)%e.length],[v,b,w]=g,S=v-l,T=b-c,A=t?w-h:void 0,[C,R,L]=y,U=C-l,N=R-c,z=t?L-h:void 0,V=S*N-U*T;if(o+=V,r+=(S+U)*V,s+=(T+N)*V,t&&g.length>2&&y.length>2){const B=S*z-U*A;n+=(A+z)*B,a+=B}v<i[0]&&(i[0]=v),v>i[1]&&(i[1]=v),b<i[2]&&(i[2]=b),b>i[3]&&(i[3]=b),t&&(w<i[4]&&(i[4]=w),w>i[5]&&(i[5]=w))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[r/(6*o)+l,s/(6*o)+c,o];return t&&(i[4]===i[5]||a===0?(p[3]=(i[4]+i[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function Jxe(e,t){const i=t?[0,0,0]:[0,0],r=t?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=e.length;l<c-1;l++){const h=e[l],p=e[l+1];if(h&&p){i[0]=h[0],i[1]=h[1],r[0]=p[0],r[1]=p[1],t&&h.length>2&&p.length>2&&(i[2]=h[2],r[2]=p[2]);const f=oG(i,r);if(f){s+=f;const g=Yxe(h,p);n+=f*g[0],o+=f*g[1],t&&g.length>2&&(a+=f*g[2])}}}return s>0?t?[n/s,o/s,a/s]:[n/s,o/s]:e.length?e[0]:null}function Ine(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function $ne(e){return e.points!==void 0}function Dne(e){return e.x!==void 0&&e.y!==void 0}function Lne(e){return e.paths!==void 0}function Nne(e){return e.rings!==void 0}function Fne(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}const xy=Fne(Math.min),Ty=Fne(Math.max);function Kut(e,t){return Lne(t)?tT(e,t.paths,!1,!1):Nne(t)?tT(e,t.rings,!1,!1):$ne(t)?lG(e,t.points,!1,!1,!1,!1):Ine(t)?Une(e,t):(Dne(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.x,e[3]=t.y),e)}function eht(e,t){return Lne(t)?tT(e,t.paths,!0,!1):Nne(t)?tT(e,t.rings,!0,!1):$ne(t)?lG(e,t.points,!0,!1,!0,!1):Ine(t)?Une(e,t,!0,!1,!0,!1):(Dne(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.z,e[3]=t.x,e[4]=t.y,e[5]=t.z),e)}function tT(e,t,i,r){const s=i?3:2;if(!t.length||!t[0].length)return null;let n,o,a,l,[c,h]=t[0][0],[p,f]=t[0][0];for(let g=0;g<t.length;g++){const y=t[g];for(let v=0;v<y.length;v++){const b=y[v],[w,S]=b;if(c=xy(c,w),h=xy(h,S),p=Ty(p,w),f=Ty(f,S),i&&b.length>2){const T=b[2];n=xy(n,T),o=Ty(o,T)}if(r&&b.length>s){const T=b[s];a=xy(n,T),l=Ty(o,T)}}}return i?r?(e[0]=c,e[1]=h,e[2]=n,e[3]=a,e[4]=p,e[5]=f,e[6]=o,e[7]=l,e.length=8,e):(e[0]=c,e[1]=h,e[2]=n,e[3]=p,e[4]=f,e[5]=o,e.length=6,e):r?(e[0]=c,e[1]=h,e[2]=a,e[3]=p,e[4]=f,e[5]=l,e.length=6,e):(e[0]=c,e[1]=h,e[2]=p,e[3]=f,e.length=4,e)}function Une(e,t,i,r,s,n){const o=t.xmin,a=t.xmax,l=t.ymin,c=t.ymax;let h=t.zmin,p=t.zmax,f=t.mmin,g=t.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,g=g||0,e[0]=o,e[1]=l,e[2]=h,e[3]=f,e[4]=a,e[5]=c,e[6]=p,e[7]=g,e):(e[0]=o,e[1]=l,e[2]=h,e[3]=a,e[4]=c,e[5]=p,e)):n?(f=f||0,g=g||0,e[0]=o,e[1]=l,e[2]=f,e[3]=a,e[4]=c,e[5]=g,e):(e[0]=o,e[1]=l,e[2]=a,e[3]=c,e)}function lG(e,t,i,r,s,n){const o=i?3:2,a=r&&n,l=i&&s;if(!t.length||!t[0].length)return null;let c,h,p,f,[g,y]=t[0],[v,b]=t[0];for(let w=0;w<t.length;w++){const S=t[w],[T,A]=S;if(g=xy(g,T),y=xy(y,A),v=Ty(v,T),b=Ty(b,A),l&&S.length>2){const C=S[2];c=xy(c,C),h=Ty(h,C)}if(a&&S.length>o){const C=S[o];p=xy(c,C),f=Ty(h,C)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,e[0]=g,e[1]=y,e[2]=c,e[3]=p,e[4]=v,e[5]=b,e[6]=h,e[7]=f,e):(e[0]=g,e[1]=y,e[2]=c,e[3]=v,e[4]=b,e[5]=h,e)):n?(p=p||0,f=f||0,e[0]=g,e[1]=y,e[2]=p,e[3]=v,e[4]=b,e[5]=f,e):(e[0]=g,e[1]=y,e[2]=v,e[3]=b,e)}function Kxe(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function eTe(e){return e.points!==void 0}function tTe(e){return e.x!==void 0&&e.y!==void 0}function iTe(e){return e.paths!==void 0}function rTe(e){return e.rings!==void 0}const cG=[];function kne(e,t,i,r){return{xmin:e,ymin:t,xmax:i,ymax:r}}function zne(e,t,i,r,s,n){return{xmin:e,ymin:t,zmin:i,xmax:r,ymax:s,zmax:n}}function Bne(e,t,i,r,s,n){return{xmin:e,ymin:t,mmin:i,xmax:r,ymax:s,mmax:n}}function Vne(e,t,i,r,s,n,o,a){return{xmin:e,ymin:t,zmin:i,mmin:r,xmax:s,ymax:n,zmax:o,mmax:a}}function uG(e,t=!1,i=!1){return t?i?Vne(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]):zne(e[0],e[1],e[2],e[3],e[4],e[5]):i?Bne(e[0],e[1],e[2],e[3],e[4],e[5]):kne(e[0],e[1],e[2],e[3])}function tht(e){return e?Kxe(e)?e:tTe(e)?nTe(e):rTe(e)?Gne(e):iTe(e)?jne(e):eTe(e)?sTe(e):null:null}function sTe(e){const{hasZ:t,hasM:i,points:r}=e;return uG(lG(cG,r,t,i),t,i)}function nTe(e){const{x:t,y:i,z:r,m:s}=e,n=s!=null;return r!=null?n?Vne(t,i,r,s,t,i,r,s):zne(t,i,r,t,i,r):n?Bne(t,i,s,t,i,s):kne(t,i,t,i)}function Gne(e){const{hasZ:t,hasM:i,rings:r}=e,s=tT(cG,r,t,i);return s?uG(s,t,i):null}function jne(e){const{hasZ:t,hasM:i,paths:r}=e,s=tT(cG,r,t,i);return s?uG(s,t,i):null}var m3;function FW(e){return!Array.isArray(e[0])}let bd=m3=class extends fl{constructor(...e){super(...e),this.rings=[],this.type="polygon"}static fromExtent(e){const t=e.clone().normalize(),i=e.spatialReference;let r=!1,s=!1;for(const o of t)o.hasZ&&(r=!0),o.hasM&&(s=!0);const n={rings:t.map(function(o){const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(r&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:i};return r&&(n.hasZ=!0),s&&(n.hasM=!0),new m3(n)}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.rings?e.rings:null,t||(e.spatialReference?t=e.spatialReference:e.rings||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||tt.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=n.length>3):i===void 0?i=r?n.length>3:n.length>2:r===void 0&&(r=i?n.length>3:n.length>2)),{rings:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const e=Zxe(this);if(!e||isNaN(e[0])||isNaN(e[1])||this.hasZ&&isNaN(e[2]))return null;const t=new Ke;return t.x=e[0],t.y=e[1],t.spatialReference=this.spatialReference,this.hasZ&&(t.z=e[2]),t}get extent(){const{spatialReference:e}=this,t=Gne(this);if(!t)return null;const i=new Zt(t);return i.spatialReference=e,i}get isSelfIntersecting(){return Hxe(this.rings)}writeRings(e,t){t.rings=se(this.rings)}addRing(e){if(!e)return;const t=this.rings,i=t.length;if(FW(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("rings"),this}clone(){const e=new m3;return e.spatialReference=this.spatialReference,e.rings=se(this.rings),e.hasZ=this.hasZ,e.hasM=this.hasM,e}equals(e){if(this===e)return!0;if(O(e))return!1;const t=this.spatialReference,i=e.spatialReference;if(_(t)!==_(i)||_(t)&&_(i)&&!t.equals(i)||this.rings.length!==e.rings.length)return!1;const r=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=e.rings[s];if(!J_(n,o,r))return!1}return!0}contains(e){if(!e)return!1;const t=z1(e,this.spatialReference);return Nxe(this,_(t)?t:e)}isClockwise(e){let t;return t=FW(e)?e.map(i=>this.hasZ?this.hasM?[i.x,i.y,i.z,i.m]:[i.x,i.y,i.z]:[i.x,i.y]):e,aG(t,this.hasM,this.hasZ)}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.rings[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new Ke(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new Ke(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new Ke(i[0],i[1],i[2],i[3],this.spatialReference):new Ke(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(eT(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e].splice(t,0,i),this.notifyChange("rings"),this):this}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new Ke(this.rings[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("rings"),i}removeRing(e){if(!this._validateInputs(e,null))return null;const t=this.rings.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new Ke(s,i));return this.notifyChange("rings"),r}setPoint(e,t,i){return this._validateInputs(e,t)?(eT(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e][t]=i,this.notifyChange("rings"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.rings.length)return!1;if(t!=null){const r=this.rings[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],bd.prototype,"cache",null),u([d({readOnly:!0})],bd.prototype,"centroid",null),u([d({readOnly:!0})],bd.prototype,"extent",null),u([d({readOnly:!0})],bd.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],bd.prototype,"rings",void 0),u([Ge("rings")],bd.prototype,"writeRings",null),bd=m3=u([P("esri.geometry.Polygon")],bd),bd.prototype.toJSON.isDefaultToJSON=!0;const dc=bd;var vz;function oTe(e){return!Array.isArray(e[0])}let Eg=vz=class extends fl{constructor(...e){super(...e),this.paths=[],this.type="polyline"}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.paths?e.paths:null,t||(e.spatialReference?t=e.spatialReference:e.paths||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||tt.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=!1):i===void 0?i=!r&&n.length>3:r===void 0&&(r=!i&&n.length>3)),{paths:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:e}=this,t=jne(this);if(!t)return null;const i=new Zt(t);return i.spatialReference=e,i}writePaths(e,t){t.paths=se(this.paths)}addPath(e){if(!e)return;const t=this.paths,i=t.length;if(oTe(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("paths"),this}clone(){const e=new vz;return e.spatialReference=this.spatialReference,e.paths=se(this.paths),e.hasZ=this.hasZ,e.hasM=this.hasM,e}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.paths[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new Ke(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new Ke(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new Ke(i[0],i[1],i[2],i[3],this.spatialReference):new Ke(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(eT(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e].splice(t,0,i),this.notifyChange("paths"),this):this}removePath(e){if(!this._validateInputs(e,null))return null;const t=this.paths.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new Ke(s,i));return this.notifyChange("paths"),r}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new Ke(this.paths[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("paths"),i}setPoint(e,t,i){return this._validateInputs(e,t)?(eT(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e][t]=i,this.notifyChange("paths"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.paths.length)return!1;if(t!=null){const r=this.paths[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],Eg.prototype,"cache",null),u([d({readOnly:!0})],Eg.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Eg.prototype,"paths",void 0),u([Ge("paths")],Eg.prototype,"writePaths",null),Eg=vz=u([P("esri.geometry.Polyline")],Eg),Eg.prototype.toJSON.isDefaultToJSON=!0;const tc=Eg;class si{constructor(t,i={ignoreUnknown:!1,useNumericKeys:!1}){this.jsonToAPI=t,this.options=i,this.apiValues=[],this.jsonValues=[],this.apiToJSON=this._invertMap(t),this.apiValues=this._getKeysSorted(this.apiToJSON),this.jsonValues=this._getKeysSorted(this.jsonToAPI),this.read=r=>this.fromJSON(r),this.write=(r,s,n)=>{const o=this.toJSON(r);o!==void 0&&cc(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(t){if(this.apiToJSON.hasOwnProperty(t)){const i=this.apiToJSON[t];return this.options.useNumericKeys?+i:i}return this.options.ignoreUnknown?void 0:t}fromJSON(t){return this.jsonToAPI.hasOwnProperty(t)?this.jsonToAPI[t]:this.options.ignoreUnknown?void 0:t}_invertMap(t){const i={};for(const r in t)i[t[r]]=r;return i}_getKeysSorted(t){const i=[];for(const r in t)i.push(r);return i.sort(),i}}function po(){return function(e,t){return new si(e,I({ignoreUnknown:!0},t))}}const Hne=po()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),UW=po()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function qne(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function hG(e){return e.points!==void 0}function dG(e){return e.x!==void 0&&e.y!==void 0}function pG(e){return e.paths!==void 0}function k_(e){return e.rings!==void 0}function dm(e){return O(e)?null:e instanceof fl?e:dG(e)?Ke.fromJSON(e):pG(e)?tc.fromJSON(e):k_(e)?dc.fromJSON(e):hG(e)?B1.fromJSON(e):qne(e)?Zt.fromJSON(e):null}function x0(e){return e?dG(e)?"esriGeometryPoint":pG(e)?"esriGeometryPolyline":k_(e)?"esriGeometryPolygon":qne(e)?"esriGeometryEnvelope":hG(e)?"esriGeometryMultipoint":null:null}const aTe={esriGeometryPoint:Ke,esriGeometryPolyline:tc,esriGeometryPolygon:dc,esriGeometryEnvelope:Zt,esriGeometryMultipoint:B1};function Wne(e){return e&&aTe[e]||null}const V1={base:fl,key:"type",typeMap:{extent:Zt,multipoint:B1,point:Ke,polyline:tc,polygon:dc}};Fh(V1);class wx{constructor(){this._emitter=new wx.EventEmitter(this)}emit(t,i){return this._emitter.emit(t,i)}on(t,i){return this._emitter.on(t,i)}once(t,i){return this._emitter.once(t,i)}hasEventListener(t){return this._emitter.hasEventListener(t)}}(function(e){class t{constructor(s=null){this.target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this.target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return Hx(a)}if(s.indexOf(",")>-1)throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}e.EventEmitter=t,e.EventedMixin=r=>{let s=class extends r{constructor(){super(...arguments),this._emitter=new t}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([P("esri.core.Evented")],s),s};let i=class extends we{constructor(){super(...arguments),this._emitter=new wx.EventEmitter(this)}destroy(){this._emitter.clear()}emit(r,s){return this._emitter.emit(r,s)}on(r,s){return this._emitter.on(r,s)}once(r,s){return this._emitter.once(r,s)}hasEventListener(r){return this._emitter.hasEventListener(r)}};i=u([P("esri.core.Evented")],i),e.EventedAccessor=i})(wx||(wx={}));const wr=wx;var Si;(function(e){e[e.ADD=1]="ADD",e[e.REMOVE=2]="REMOVE",e[e.MOVE=4]="MOVE"})(Si||(Si={}));function fG(e){return(t,i)=>{t[i]=e}}class lTe{constructor(){this._observers=[]}observe(t){return this._observers.includes(t)||this._observers.push(t),new xse(this._observers,t)}notify(){const t=this._observers.slice();for(let i=0;i<t.length;++i){const r=t[i];r.onInvalidated(),r.onCommitted()}}}var Ff;class cTe{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(t){this.defaultPrevented=!1,this.item=t}}const Ec=new Gr(cTe,void 0,e=>{e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1}),uTe=()=>{};function f4(e){return e?e instanceof c_?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function m4(e){if(e&&e.length)return e[0]}function hTe(e,t,i,r){const s=Math.min(e.length-i,t.length-r);let n=0;for(;n<s&&e[i+n]===t[r+n];)n++;return n}function Xne(e,t,i,r){t&&t.forEach((s,n,o)=>{e.push(s),Xne(e,i.call(r,s,n,o),i,r)})}const jm=new Set,Hm=new Set,qm=new Set,g4=new Map;let dTe=0,c_=Ff=class extends wr.EventedAccessor{constructor(e){super(e),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new lTe,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:dTe++})}static isCollection(e){return e!=null&&e instanceof Ff}normalizeCtorArgs(e){return e?Array.isArray(e)||e instanceof Ff?{items:e}:e:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return Vt(this._observable),this._items}set items(e){this._emitBeforeChanges(Si.ADD)||(this._splice(0,this.length,f4(e)),this._emitAfterChanges(Si.ADD))}hasEventListener(e){return e==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(e)}on(e,t){if(e==="change"){const i=this._chgListeners,r={removed:!1,callback:t};return i.push(r),this._notifications&&this._notifications.push({listeners:i.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=uTe,r.removed=!0,i.splice(i.indexOf(r),1)}}}return this._emitter.on(e,t)}once(e,t){const i=this.on(e,t);return{remove(){i.remove()}}}add(e,t){if(Vt(this._observable),this._emitBeforeChanges(Si.ADD))return this;const i=this.getNextIndex(t!=null?t:null);return this._splice(i,0,[e]),this._emitAfterChanges(Si.ADD),this}addMany(e,t=this._items.length){if(Vt(this._observable),!e||!e.length)return this;if(this._emitBeforeChanges(Si.ADD))return this;const i=this.getNextIndex(t);return this._splice(i,0,f4(e)),this._emitAfterChanges(Si.ADD),this}at(e){if(Vt(this._observable),(e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this._items[e]}removeAll(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Si.REMOVE))return[];const e=this._splice(0,this.length)||[];return this._emitAfterChanges(Si.REMOVE),e}clone(){return Vt(this._observable),this._createNewInstance({items:this._items.map(se)})}concat(...e){Vt(this._observable);const t=e.map(f4);return this._createNewInstance({items:this._items.concat(...t)})}drain(e,t){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Si.REMOVE))return;const i=this._splice(0,this.length),r=i.length;for(let s=0;s<r;s++)e.call(t,i[s],s,i);this._emitAfterChanges(Si.REMOVE)}every(e,t){return Vt(this._observable),this._items.every(e,t)}filter(e,t){let i;return Vt(this._observable),i=arguments.length===2?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})}find(e,t){return Vt(this._observable),this._items.find(e,t)}findIndex(e,t){return Vt(this._observable),this._items.findIndex(e,t)}flatten(e,t){Vt(this._observable);const i=[];return Xne(i,this,e,t),new Ff(i)}forEach(e,t){return Vt(this._observable),this._items.forEach(e,t)}getItemAt(e){return Vt(this._observable),this._items[e]}getNextIndex(e){Vt(this._observable);const t=this.length;return(e=e==null?t:e)<0?e=0:e>t&&(e=t),e}includes(e,t=0){return Vt(this._observable),this._items.includes(e,t)}indexOf(e,t=0){return Vt(this._observable),this._items.indexOf(e,t)}join(e=","){return Vt(this._observable),this._items.join(e)}lastIndexOf(e,t=this.length-1){return Vt(this._observable),this._items.lastIndexOf(e,t)}map(e,t){Vt(this._observable);const i=this._items.map(e,t);return new Ff({items:i})}reorder(e,t=this.length-1){Vt(this._observable);const i=this.indexOf(e);if(i!==-1){if(t<0?t=0:t>=this.length&&(t=this.length-1),i!==t){if(this._emitBeforeChanges(Si.MOVE))return e;this._splice(i,1),this._splice(t,0,[e]),this._emitAfterChanges(Si.MOVE)}return e}}pop(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Si.REMOVE))return;const e=m4(this._splice(this.length-1,1));return this._emitAfterChanges(Si.REMOVE),e}push(...e){return Vt(this._observable),this._emitBeforeChanges(Si.ADD)||(this._splice(this.length,0,e),this._emitAfterChanges(Si.ADD)),this.length}reduce(e,t){Vt(this._observable);const i=this._items;return arguments.length===2?i.reduce(e,t):i.reduce(e)}reduceRight(e,t){Vt(this._observable);const i=this._items;return arguments.length===2?i.reduceRight(e,t):i.reduceRight(e)}remove(e){return Vt(this._observable),this.removeAt(this.indexOf(e))}removeAt(e){if(Vt(this._observable),e<0||e>=this.length||this._emitBeforeChanges(Si.REMOVE))return;const t=m4(this._splice(e,1));return this._emitAfterChanges(Si.REMOVE),t}removeMany(e){if(Vt(this._observable),!e||!e.length||this._emitBeforeChanges(Si.REMOVE))return[];const t=e instanceof Ff?e.toArray():e,i=this._items,r=[],s=t.length;for(let n=0;n<s;n++){const o=t[n],a=i.indexOf(o);if(a>-1){const l=1+hTe(t,i,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&r.push.apply(r,c),n+=l-1}}return this._emitAfterChanges(Si.REMOVE),r}reverse(){if(Vt(this._observable),this._emitBeforeChanges(Si.MOVE))return this;const e=this._splice(0,this.length);return e&&(e.reverse(),this._splice(0,0,e)),this._emitAfterChanges(Si.MOVE),this}shift(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Si.REMOVE))return;const e=m4(this._splice(0,1));return this._emitAfterChanges(Si.REMOVE),e}slice(e=0,t=this.length){return Vt(this._observable),this._createNewInstance({items:this._items.slice(e,t)})}some(e,t){return Vt(this._observable),this._items.some(e,t)}sort(e){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Si.MOVE))return this;const t=this._splice(0,this.length);return arguments.length?t.sort(e):t.sort(),this._splice(0,0,t),this._emitAfterChanges(Si.MOVE),this}splice(e,t,...i){Vt(this._observable);const r=(t?Si.REMOVE:0)|(i.length?Si.ADD:0);if(this._emitBeforeChanges(r))return[];const s=this._splice(e,t,i)||[];return this._emitAfterChanges(r),s}toArray(){return Vt(this._observable),this._items.slice()}toJSON(){return Vt(this._observable),this.toArray()}toLocaleString(){return Vt(this._observable),this._items.toLocaleString()}toString(){return Vt(this._observable),this._items.toString()}unshift(...e){return Vt(this._observable),!e.length||this._emitBeforeChanges(Si.ADD)||(this._splice(0,0,e),this._emitAfterChanges(Si.ADD)),this.length}_createNewInstance(e){return new this.constructor(e)}_splice(e,t,i){const r=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=vR(()=>this._dispatchChange())),t){if(o=r.splice(e,t),this.hasEventListener("before-remove")){const a=Ec.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),r.splice(e,0,n),e+=1,l-=1,c-=1);Ec.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=Ec.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);Ec.release(a)}}if(i&&i.length){if(s){const h=[];for(const p of i){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}i=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=e===this.length;if(a||l){const h=Ec.acquire();h.target=this,h.cancellable=!0;const p=Ec.acquire();p.target=this,p.cancellable=!1;for(const f of i)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),p.reset(f),this.emit("after-add",p));Ec.release(p),Ec.release(h)}else{if(c)for(const h of i)r.push(h);else r.splice(e,0,...i);this._set("length",r.length)}}return(i&&i.length||o&&o.length)&&this._notifyChangeEvent(i,o),o}_emitBeforeChanges(e){let t=!1;if(this.hasEventListener("before-changes")){const i=Ec.acquire();i.target=this,i.cancellable=!0,i.type=e,this.emit("before-changes",i),t=i.defaultPrevented,Ec.release(i)}return t}_emitAfterChanges(e){if(this.hasEventListener("after-changes")){const t=Ec.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),Ec.release(t)}this._observable.notify()}_notifyChangeEvent(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const e=this._notifications;this._notifications=null;for(const t of e){const i=t.changes;jm.clear(),Hm.clear(),qm.clear();for(const{added:l,removed:c}of i){if(l)if(qm.size===0&&Hm.size===0)for(const h of l)jm.add(h);else for(const h of l)Hm.has(h)?(qm.add(h),Hm.delete(h)):qm.has(h)||jm.add(h);if(c)if(qm.size===0&&jm.size===0)for(const h of c)Hm.add(h);else for(const h of c)jm.has(h)?jm.delete(h):(qm.delete(h),Hm.add(h))}const r=Ja.acquire();jm.forEach(l=>{r.push(l)});const s=Ja.acquire();Hm.forEach(l=>{s.push(l)});const n=this._items,o=t.items,a=Ja.acquire();if(qm.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),t.listeners&&(r.length||s.length||a.length)){const l={target:this,added:r,removed:s,moved:a},c=t.listeners.length;for(let h=0;h<c;h++){const p=t.listeners[h];p.removed||p.callback.call(this,l)}}Ja.release(r),Ja.release(s),Ja.release(a)}jm.clear(),Hm.clear(),qm.clear()}};c_.ofType=e=>{if(!e)return Ff;if(g4.has(e))return g4.get(e);let t=null;if(typeof e=="function")t=e.prototype.declaredClass;else if(e.base)t=e.base.prototype.declaredClass;else for(const r in e.typeMap){const s=e.typeMap[r].prototype.declaredClass;t?t+=` | ${s}`:t=s}let i=class extends Ff{};return u([fG({Type:e,ensureType:typeof e=="function"?ns(e):Fh(e)})],i.prototype,"itemType",void 0),i=u([P(`esri.core.Collection<${t}>`)],i),g4.set(e,i),i},u([d()],c_.prototype,"length",void 0),u([d()],c_.prototype,"items",null),c_=Ff=u([P("esri.core.Collection")],c_);const pt=c_;var iT;function pTe(e,t){switch(e.type){case"range":{const i="range"in e?e.range[0]:e.minValue,r="range"in e?e.range[1]:e.maxValue;if(+t<i||+t>r)return iT.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(e.codedValues==null||e.codedValues.every(i=>i==null||i.code!==t))return iT.INVALID_CODED_VALUE}return null}(function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(iT||(iT={}));let y4;function cp(){return y4||(y4=(async()=>{const e=await import("./arcadeUtils.89120371.js").then(function(t){return t.q});return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),y4}const fTe=(e,t,i)=>TR.create(e,t,i,null,["$feature"]),mTe=(e,t,i)=>TR.create(e,t,i,null,["$feature","$view"]),gTe=(e,t,i,r)=>TR.create(e,t,i,r,["$feature","$view"]);class TR{constructor(t,i,r,s,n,o,a,l){this.script=t,this.evaluate=n;const c=Array.isArray(a)?a:a.fields;this.fields=c,this._syntaxTree=s,this._arcade=i,this._arcadeDictionary=r,this._arcadeFeature=o,this._spatialReference=l,this._referencesGeometry=i.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(t,i,r,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await cp(),h=tt.fromJSON(i),p=a.parseScript(t,o),f=n.reduce((C,R)=>me(I({},C),{[R]:null}),{});let g=null;_(s)&&(g=new c(s),g.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p)&&a.enableGeometrySupport(),v=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),b=a.scriptIsAsync(p)&&a.enableAsyncSupport(),w={vars:f,spatialReference:h,useAsync:!!b},S=new c;S.immutable=!1,S.setField("scale",0);const T=a.compileScript(p,w),A=C=>("$view"in C&&C.$view&&(S.setField("scale",C.$view.scale),C.$view=S),g&&(C.$config=g),T({vars:C,spatialReference:h}));return await Promise.all([y,v,b]),new TR(t,a,c,p,A,new l,r,h)}repurposeFeature(t){return t.geometry&&!t.geometry.spatialReference&&(t.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(t.geometry,t.attributes,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(t){return this._arcade.referencesMember(this._syntaxTree,t)}referencesFunction(t){return this._arcade.referencesFunction(this._syntaxTree,t)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)}}const yTe=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],vTe=["field","normalizationField"];function kW(e,t){if(e!=null&&t!=null){for(const i of Array.isArray(e)?e:[e])if(zW(yTe,i,t),"visualVariables"in i&&i.visualVariables)for(const r of i.visualVariables)zW(vTe,r,t)}}function zW(e,t,i){if(e)for(const r of e){const s=YT(r,t),n=s&&typeof s!="function"&&i.get(s);n&&cc(r,n.name,t)}}function Yne(e,t){if(e!=null&&t!=null&&t.fields.length)if("startField"in e){const i=t.get(e.startField),r=t.get(e.endField);e.startField=i&&i.name||null,e.endField=r&&r.name||null}else{const i=t.get(e.startTimeField),r=t.get(e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=r&&r.name||null}}const v4=new Set;function Zne(e,t){return e&&t?(v4.clear(),JA(v4,e,t),Array.from(v4).sort()):[]}function JA(e,t,i){var r;if(i)if(t!=null&&(r=t.fields)!=null&&r.length)if(i.includes("*"))for(const{name:s}of t.fields)e.add(s);else for(const s of i)wu(e,t,s);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const s of i)e.add(s)}}function wu(e,t,i){if(typeof i=="string")if(t){const r=t.get(i);r&&e.add(r.name)}else e.add(i)}function iht(e,t){return O(t)||O(e)?[]:t.includes("*")?e.fields.map(i=>i.name):t}async function pc(e,t,i){var r;if(!i)return;const{arcadeUtils:s}=await cp(),n=s.extractFieldNames(i,t==null||(r=t.fields)==null?void 0:r.map(o=>o.name));for(const o of n)wu(e,t,o)}async function Qne(e,t,i){if(i&&i!=="1=1"){const r=(await import("./WhereClause.184162be.js")).WhereClause.create(i,t);if(!r.isStandardized)throw new Q("fieldUtils:collectFilterFields","Where clause is not standardized");JA(e,t,r.fieldNames)}}function _Te({displayField:e,fields:t}){return e||(t&&t.length?_4(t,"name-or-title")||_4(t,"unique-identifier")||_4(t,"type-or-category")||bTe(t):null)}function bTe(e){for(const t of e){if(!t||!t.name)continue;const i=t.name.toLowerCase();if(i.indexOf("name")>-1||i.indexOf("title")>-1)return t.name}return null}function _4(e,t){for(const i of e)if(i&&i.valueType&&i.valueType===t)return i.name;return null}async function rht(e,t){if(!t)return;const i=YT("elevationInfo.featureExpressionInfo",t);return i?i.collectRequiredFields(e,t.fieldsIndex):void 0}async function wTe(e,t,i){i.outStatistic.onStatisticValueExpression?pc(e,t,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}async function sht(e,t,i){var r,s;if(!t||!i||i.type!=="cluster")return;const n=[];if((r=i.popupTemplate)!=null&&r.expressionInfos&&n.push(...i.popupTemplate.expressionInfos.map(o=>pc(e,t.fieldsIndex,o.expression))),Array.isArray((s=i.popupTemplate)==null?void 0:s.content)){const o=i.popupTemplate.content;for(const a of o)a.type==="expression"&&a.expressionInfo&&n.push(pc(e,t.fieldsIndex,a.expressionInfo.expression))}i.fields&&n.push(...i.fields.map(o=>wTe(e,t.fieldsIndex,o))),await Promise.all(n)}async function nht(e,t,i){t&&(t.timeInfo&&_(i)&&i.timeExtent&&JA(e,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.floorInfo&&JA(e,t.fieldsIndex,[t.floorInfo.floorField]),_(i)&&_(i.where)&&await Qne(e,t.fieldsIndex,i.where))}async function oht(e,t,i){t&&i&&await Promise.all(i.map(r=>xTe(e,t,r)))}async function xTe(e,t,i){t&&i&&(i.valueExpression?await pc(e,t.fieldsIndex,i.valueExpression):i.field&&wu(e,t.fieldsIndex,i.field))}function aht(e){if(!e)return[];const t="editFieldsInfo"in e&&e.editFieldsInfo;return t?Zne(e.fieldsIndex,[t&&t.creatorField,t&&t.creationDateField,t&&t.editorField,t&&t.editDateField]):[]}async function lht(e,t){const{labelingInfo:i,fieldsIndex:r}=t;i&&i.length&&await Promise.all(i.map(s=>TTe(e,r,s)))}async function TTe(e,t,i){if(!i)return;const r=i.getLabelExpression(),s=i.where;if(r.type==="arcade")await pc(e,t,r.expression);else{const n=r.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{wu(e,t,o.slice(1,-1))})}await Qne(e,t,s)}function STe(e){const t=e.defaultValue;return t!==void 0&&eoe(e,t)?t:e.nullable?null:void 0}function Jne(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function ETe(e){return e===null||Jne(e)}const mG="isInteger"in Number?Number.isInteger:e=>typeof e=="number"&&isFinite(e)&&Math.floor(e)===e;function ATe(e){return e===null||mG(e)}function Kne(e){return e!=null&&typeof e=="string"}function CTe(e){return e===null||Kne(e)}function RTe(){return!0}function eoe(e,t){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?ATe:mG;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?ETe:Jne;break;case"string":case"esriFieldTypeString":i=e.nullable?CTe:Kne;break;default:i=RTe}return arguments.length===1?i:i(t)}const OTe=["integer","small-integer","single","double"],MTe=new Set([...OTe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function $L(e){return e!=null&&MTe.has(e.type)}function cht(e){return e!=null&&(e.type==="string"||e.type==="esriFieldTypeString")}var T$,S$;function uht(e){return e==null||typeof e=="number"&&isNaN(e)?null:e}function hht(e,t){return e.nullable&&t===null?null:$L(e)&&!PTe(e.type,Number(t))?T$.OUT_OF_RANGE:eoe(e,t)?e.domain?pTe(e.domain,t):null:S$.INVALID_TYPE}function PTe(e,t){const i=typeof e=="string"?toe(e):e;return!!i&&(i.isInteger?mG(t)&&t>=i.min&&t<=i.max:t>=i.min&&t<=i.max)}function toe(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return ITe;case"esriFieldTypeInteger":case"integer":return $Te;case"esriFieldTypeSingle":case"single":return DTe;case"esriFieldTypeDouble":case"double":return LTe}}(function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(T$||(T$={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(S$||(S$={}));const ITe={min:-32768,max:32767,isInteger:!0},$Te={min:-2147483648,max:2147483647,isInteger:!0},DTe={min:-34e37,max:12e37,isInteger:!1},LTe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function dht(e,t,i){switch(e){case iT.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case iT.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case S$.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${t.name}, type: ${t.type}, nullable: ${t.nullable}`;case T$.OUT_OF_RANGE:{const{min:r,max:s}=toe(t.type);return`Value ${i} is out of range for the number type - field: ${t.name}, type: ${t.type}, value range is ${r} to ${s}`}}}function NTe(e,t){return!FTe(e,t,null)}function FTe(e,t,i){if(!t||!t.attributes||!e){if(_(i))for(const n of e)i.add(n);return!0}const r=t.attributes;let s=!1;for(const n of e)if(!(n in r)){if(s=!0,!_(i))break;i.add(n)}return s}let g3=class extends ve{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression"],readOnly:!0,json:{read:!1,write:!0}})],g3.prototype,"type",void 0),g3=u([P("esri.popup.content.Content")],g3);const G1=g3;var _z;let fv=_z=class extends G1{constructor(e){super(e),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new _z({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],fv.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],fv.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],fv.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],fv.prototype,"type",void 0),fv=_z=u([P("esri.popup.content.AttachmentsContent")],fv);const KA=fv;var bz;let mv=bz=class extends G1{constructor(e){super(e),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new bz({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?se(this.outFields):null})}};u([d()],mv.prototype,"creator",void 0),u([d()],mv.prototype,"destroyer",void 0),u([d()],mv.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],mv.prototype,"type",void 0),mv=bz=u([P("esri.popup.content.CustomContent")],mv);const UTe=mv;var wz;let iw=wz=class extends ve{constructor(e){super(e),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new wz({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],iw.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],iw.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],iw.prototype,"returnType",void 0),iw=wz=u([P("esri.popup.ElementExpressionInfo")],iw);const ioe=iw;var xz;let j2=xz=class extends G1{constructor(e){super(e),this.expressionInfo=null,this.type="expression"}clone(){var e;return new xz({expressionInfo:(e=this.expressionInfo)==null?void 0:e.clone()})}};u([d({type:ioe,json:{write:!0}})],j2.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],j2.prototype,"type",void 0),j2=xz=u([P("esri.popup.content.ExpressionContent")],j2);const gG=j2;function ht(e,t={}){var i;const r=e instanceof si?e:new si(e,t),s={type:(i=t==null?void 0:t.ignoreUnknown)==null||i?r.apiValues:String,json:{type:r.jsonValues,read:(t==null||!t.readOnly)&&{reader:r.read},write:{writer:r.write}}};return(t==null?void 0:t.readOnly)!==void 0&&(s.readOnly=!!t.readOnly),(t==null?void 0:t.default)!==void 0&&(s.json.default=t.default),(t==null?void 0:t.name)!==void 0&&(s.json.name=t.name),d(s)}const eC=po()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});eC.toJSON.bind(eC);eC.fromJSON.bind(eC);var BW,VW,GW;let kTe,sA;const jW=(BW=(VW=globalThis.esriConfig)==null?void 0:VW.locale)!=null?BW:(GW=globalThis.dojoConfig)==null?void 0:GW.locale;function roe(){var e,t;return(e=jW!=null?jW:(t=globalThis.navigator)==null?void 0:t.language)!=null?e:"en"}function sc(){return sA===void 0&&(sA=roe()),sA}const nA=[];function zTe(e){return nA.push(e),{remove(){nA.splice(nA.indexOf(e),1)}}}const Tz=[];function yG(e){return Tz.push(e),{remove(){nA.splice(Tz.indexOf(e),1)}}}function BTe(){var e;const t=(e=kTe)!=null?e:roe();sA!==t&&(sA=t,[...Tz].forEach(i=>{i.call(null,t)}),[...nA].forEach(i=>{i.call(null,t)}))}globalThis.addEventListener==null||globalThis.addEventListener("languagechange",BTe);const Kh={year:"numeric",month:"numeric",day:"numeric"},PS={year:"numeric",month:"long",day:"numeric"},IS={year:"numeric",month:"short",day:"numeric"},$S={year:"numeric",month:"long",weekday:"long",day:"numeric"},kc={hour:"numeric",minute:"numeric"},Nu=me(I({},kc),{second:"numeric"}),vG={"short-date":Kh,"short-date-short-time":I(I({},Kh),kc),"short-date-short-time-24":me(I(I({},Kh),kc),{hour12:!1}),"short-date-long-time":I(I({},Kh),Nu),"short-date-long-time-24":me(I(I({},Kh),Nu),{hour12:!1}),"short-date-le":Kh,"short-date-le-short-time":I(I({},Kh),kc),"short-date-le-short-time-24":me(I(I({},Kh),kc),{hour12:!1}),"short-date-le-long-time":I(I({},Kh),Nu),"short-date-le-long-time-24":me(I(I({},Kh),Nu),{hour12:!1}),"long-month-day-year":PS,"long-month-day-year-short-time":I(I({},PS),kc),"long-month-day-year-short-time-24":me(I(I({},PS),kc),{hour12:!1}),"long-month-day-year-long-time":I(I({},PS),Nu),"long-month-day-year-long-time-24":me(I(I({},PS),Nu),{hour12:!1}),"day-short-month-year":IS,"day-short-month-year-short-time":I(I({},IS),kc),"day-short-month-year-short-time-24":me(I(I({},IS),kc),{hour12:!1}),"day-short-month-year-long-time":I(I({},IS),Nu),"day-short-month-year-long-time-24":me(I(I({},IS),Nu),{hour12:!1}),"long-date":$S,"long-date-short-time":I(I({},$S),kc),"long-date-short-time-24":me(I(I({},$S),kc),{hour12:!1}),"long-date-long-time":I(I({},$S),Nu),"long-date-long-time-24":me(I(I({},$S),Nu),{hour12:!1}),"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":kc,"long-time":Nu},tC=po()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});tC.apiValues;tC.toJSON.bind(tC);tC.fromJSON.bind(tC);const VTe={ar:"ar-u-nu-latn-ca-gregory"};let y3=new WeakMap,soe=vG["short-date-short-time"];function GTe(e){const t=e||soe;if(!y3.has(t)){const i=sc(),r=VTe[sc()]||i;y3.set(t,new Intl.DateTimeFormat(r,t))}return y3.get(t)}function _G(e){return vG[e]||null}function pm(e,t){return GTe(t).format(e)}yG(()=>{y3=new WeakMap,soe=vG["short-date-short-time"]});const jTe={ar:"ar-u-nu-latn"};let v3=new WeakMap,noe={};function HTe(e){const t=e||noe;if(!v3.has(t)){const i=sc(),r=jTe[sc()]||i;v3.set(t,new Intl.NumberFormat(r,e))}return v3.get(t)}function ooe(e={}){const t={};return e.digitSeparator!=null&&(t.useGrouping=e.digitSeparator),e.places!=null&&(t.minimumFractionDigits=t.maximumFractionDigits=e.places),t}function fm(e,t){return HTe(t).format(e)}yG(()=>{v3=new WeakMap,noe={}});var Sz;let gv=Sz=class extends ve{constructor(e){super(e),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new Sz({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(e){return this.dateFormat?pm(e,I(I({},_G(this.dateFormat)),this.dateTimeFormatOptions)):fm(e,ooe(this))}};u([ht(eC)],gv.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],gv.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],gv.prototype,"digitSeparator",void 0),u([d({type:mr,json:{write:!0}})],gv.prototype,"places",void 0),gv=Sz=u([P("esri.popup.support.FieldInfoFormat")],gv);const oA=gv;var Ez;let Wu=Ez=class extends ve{constructor(e){super(e),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new Ez({fieldName:this.fieldName,format:this.format?se(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Wu.prototype,"fieldName",void 0),u([d({type:oA,json:{write:!0}})],Wu.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],Wu.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],Wu.prototype,"label",void 0),u([ht(new si({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],Wu.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],Wu.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Wu.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],Wu.prototype,"visible",void 0),Wu=Ez=u([P("esri.popup.FieldInfo")],Wu);const SR=Wu;var Az;let tf=Az=class extends G1{constructor(e){super(e),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(e,t){t.fieldInfos=e&&e.map(i=>i.toJSON())}clone(){return new Az(se({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],tf.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],tf.prototype,"description",void 0),u([d({type:[SR]})],tf.prototype,"fieldInfos",void 0),u([Ge("fieldInfos")],tf.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],tf.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],tf.prototype,"type",void 0),tf=Az=u([P("esri.popup.content.FieldsContent")],tf);const rT=tf;let yv=class extends ve{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],yv.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],yv.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],yv.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],yv.prototype,"type",void 0),yv=u([P("esri.popup.content.mixins.MediaInfo")],yv);const bG=yv;var Cz;let H2=Cz=class extends we{constructor(e){super(e),this.tooltip=null,this.value=null}clone(){return new Cz({tooltip:this.tooltip,value:this.value})}};u([d()],H2.prototype,"tooltip",void 0),u([d()],H2.prototype,"value",void 0),H2=Cz=u([P("esri.popup.content.support.ChartMediaInfoValueSeries")],H2);const aoe=H2;var Rz;let vv=Rz=class extends ve{constructor(e){super(e),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new Rz({fields:se(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],vv.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],vv.prototype,"normalizeField",void 0),u([d({type:[aoe],json:{read:!1}})],vv.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],vv.prototype,"tooltipField",void 0),vv=Rz=u([P("esri.popup.content.support.ChartMediaInfoValue")],vv);const qTe=vv;let q2=class extends bG{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],q2.prototype,"type",void 0),u([d({type:qTe,json:{write:!0}})],q2.prototype,"value",void 0),q2=u([P("esri.popup.content.mixins.ChartMediaInfo")],q2);const DL=q2,LL=po()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var Oz;let _3=Oz=class extends DL{constructor(e){super(e),this.type="bar-chart"}clone(){return new Oz({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:LL.write}})],_3.prototype,"type",void 0),_3=Oz=u([P("esri.popup.content.BarChartMediaInfo")],_3);const loe=_3;var Mz;let b3=Mz=class extends DL{constructor(e){super(e),this.type="column-chart"}clone(){return new Mz({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:LL.write}})],b3.prototype,"type",void 0),b3=Mz=u([P("esri.popup.content.ColumnChartMediaInfo")],b3);const coe=b3;var Pz;let W2=Pz=class extends ve{constructor(e){super(e),this.linkURL=null,this.sourceURL=null}clone(){return new Pz({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],W2.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],W2.prototype,"sourceURL",void 0),W2=Pz=u([P("esri.popup.content.support.ImageMediaInfoValue")],W2);const WTe=W2;var Iz;let rw=Iz=class extends bG{constructor(e){super(e),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new Iz({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],rw.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],rw.prototype,"type",void 0),u([d({type:WTe,json:{write:!0}})],rw.prototype,"value",void 0),rw=Iz=u([P("esri.popup.content.ImageMediaInfo")],rw);const uoe=rw;var $z;let w3=$z=class extends DL{constructor(e){super(e),this.type="line-chart"}clone(){return new $z({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:LL.write}})],w3.prototype,"type",void 0),w3=$z=u([P("esri.popup.content.LineChartMediaInfo")],w3);const hoe=w3;var Dz;let x3=Dz=class extends DL{constructor(e){super(e),this.type="pie-chart"}clone(){return new Dz({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:LL.write}})],x3.prototype,"type",void 0),x3=Dz=u([P("esri.popup.content.PieChartMediaInfo")],x3);const doe=x3,poe={base:bG,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":loe,"column-chart":coe,"line-chart":hoe,"pie-chart":doe,image:uoe}};var Lz;let Xu=Lz=class extends G1{constructor(e){super(e),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(e){return e&&e.map(t=>t.type==="image"?uoe.fromJSON(t):t.type==="barchart"?loe.fromJSON(t):t.type==="columnchart"?coe.fromJSON(t):t.type==="linechart"?hoe.fromJSON(t):t.type==="piechart"?doe.fromJSON(t):void 0).filter(Boolean)}writeMediaInfos(e,t){t.mediaInfos=e&&e.map(i=>i.toJSON())}clone(){return new Lz(se({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],Xu.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],Xu.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Xu.prototype,"description",void 0),u([d({types:[poe]})],Xu.prototype,"mediaInfos",void 0),u([Fe("mediaInfos")],Xu.prototype,"readMediaInfos",null),u([Ge("mediaInfos")],Xu.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],Xu.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],Xu.prototype,"type",void 0),Xu=Lz=u([P("esri.popup.content.MediaContent")],Xu);const iC=Xu;var Nz;let X2=Nz=class extends G1{constructor(e){super(e),this.text=null,this.type="text"}clone(){return new Nz({text:this.text})}};u([d({type:String,json:{write:!0}})],X2.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],X2.prototype,"type",void 0),X2=Nz=u([P("esri.popup.content.TextContent")],X2);const sT=X2,XTe={base:null,key:"type",typeMap:{attachment:KA,media:iC,text:sT,expression:gG,field:rT}};var Fz;let _v=Fz=class extends ve{constructor(e){super(e),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new Fz({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],_v.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],_v.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],_v.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],_v.prototype,"returnType",void 0),_v=Fz=u([P("esri.popup.ExpressionInfo")],_v);const foe=_v;var Uz;let Y2=Uz=class extends ve{constructor(e){super(e),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new Uz({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],Y2.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],Y2.prototype,"showNoDataRecords",void 0),Y2=Uz=u([P("esri.popup.LayerOptions")],Y2);const YTe=Y2;var kz;let Z2=kz=class extends ve{constructor(e){super(e),this.field=null,this.order=null}clone(){return new kz({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],Z2.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],Z2.prototype,"order",void 0),Z2=kz=u([P("esri.popup.support.RelatedRecordsInfoFieldOrder")],Z2);const moe=Z2;var zz;let Q2=zz=class extends ve{constructor(e){super(e),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new zz({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?se(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],Q2.prototype,"showRelatedRecords",void 0),u([d({type:[moe],json:{write:!0}})],Q2.prototype,"orderByFields",void 0),Q2=zz=u([P("esri.popup.RelatedRecordsInfo")],Q2);const ZTe=Q2;let QTe=0;const NL=e=>{let t=class extends e{constructor(...i){super(...i),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+QTe++})}};return t=u([P("esri.core.Identifiable")],t),t};let HW=class extends NL(class{}){};HW=u([P("esri.core.Identifiable")],HW);var Bz;let Yu=Bz=class extends NL(we){constructor(e){super(e),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new Bz({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],Yu.prototype,"active",void 0),u([d()],Yu.prototype,"className",void 0),u([d()],Yu.prototype,"disabled",void 0),u([d()],Yu.prototype,"id",void 0),u([d()],Yu.prototype,"indicator",void 0),u([d()],Yu.prototype,"title",void 0),u([d()],Yu.prototype,"type",void 0),u([d()],Yu.prototype,"visible",void 0),Yu=Bz=u([P("esri.support.actions.ActionBase")],Yu);const FL=Yu;var Vz;let T3=Vz=class extends FL{constructor(e){super(e),this.image=null,this.type="button"}clone(){return new Vz({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],T3.prototype,"image",void 0),T3=Vz=u([P("esri.support.Action.ActionButton")],T3);const QT=T3;var Gz;let J2=Gz=class extends FL{constructor(e){super(e),this.image=null,this.type="toggle",this.value=!1}clone(){return new Gz({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],J2.prototype,"image",void 0),u([d()],J2.prototype,"value",void 0),J2=Gz=u([P("esri.support.Action.ActionToggle")],J2);const goe=J2;var jz;const JTe=pt.ofType({key:"type",defaultKeyValue:"button",base:FL,typeMap:{button:QT,toggle:goe}}),KTe={base:G1,key:"type",typeMap:{media:iC,custom:UTe,text:sT,attachments:KA,fields:rT,expression:gG}},yoe="esri.PopupTemplate",eSe=he.getLogger(yoe),tSe=["attachments","fields","media","text","expression"];let Us=jz=class extends ve{constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title="",this.relatedRecordsInfo=null}castContent(e){return Array.isArray(e)?e.map(t=>Fh(KTe,t)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||_c(e)?e:(eSe.error("content error","unsupported content value",{value:e}),null)}readContent(e,t){const{popupElements:i}=t;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(t):this._readPopupInfo(t)}writeContent(e,t,i,r){typeof e!="string"?Array.isArray(e)&&(t.popupElements=e.filter(s=>tSe.indexOf(s.type)!==-1).map(s=>s&&s.toJSON(r)),t.popupElements.forEach(s=>{s.type==="attachments"?this._writeAttachmentContent(t):s.type==="media"?this._writeMediaContent(s,t):s.type==="text"&&this._writeTextContent(s,t)})):t.description=e}writeFieldInfos(e,t,i,r){const{content:s}=this,n=Array.isArray(s)?s:null;if(e){const o=n?n.filter(l=>l.type==="fields"):[],a=o.length&&o.every(l=>{var c;return(c=l.fieldInfos)==null?void 0:c.length});t.fieldInfos=e.filter(Boolean).map(l=>{const c=l.toJSON(r);return a&&(c.visible=!1),c})}if(n)for(const o of n)o.type==="fields"&&this._writeFieldsContent(o,t)}writeLayerOptions(e,t,i,r){t[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(r)}writeTitle(e,t){t.title=e||""}clone(){const{actions:e}=this,t=e?se(e.toArray()):[];return new jz({actions:t,content:Array.isArray(this.content)?se(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?se(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?se(this.fieldInfos):null,layerOptions:this.layerOptions?se(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?se(this.outFields):null,overwriteActions:this.overwriteActions,returnGeometry:this.returnGeometry,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?se(this.relatedRecordsInfo):null})}async collectRequiredFields(e,t){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,t,[...i,...this._getContentExpressionInfos(this.content,i)]),JA(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const t=new Set;return await this.collectRequiredFields(t,e),[...t].sort()}_writeFieldsContent(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=se(e.fieldInfos);Array.isArray(t.fieldInfos)?i.forEach(r=>{const s=t.fieldInfos.find(n=>n.fieldName.toLowerCase()===r.fieldName.toLowerCase());s?s.visible=!0:t.fieldInfos.push(r)}):t.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeTextContent(e,t){!t.description&&e.text&&(t.description=e.text)}_writeMediaContent(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=se(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...i]:t.mediaInfos=i}_readPopupInfoElements({description:e,mediaInfos:t,popupElements:i}){const r={description:!1,mediaInfos:!1};return i.map(s=>s.type==="media"?(s.mediaInfos||!t||r.mediaInfos||(s.mediaInfos=t,r.mediaInfos=!0),iC.fromJSON(s)):s.type==="text"?(s.text||!e||r.description||(s.text=e,r.description=!0),sT.fromJSON(s)):s.type==="attachments"?KA.fromJSON(s):s.type==="fields"?rT.fromJSON(s):s.type==="expression"?gG.fromJSON(s):void 0).filter(Boolean)}_readPopupInfo({description:e,mediaInfos:t,showAttachments:i}){const r=[];return e?r.push(new sT({text:e})):r.push(new rT),Array.isArray(t)&&t.length&&r.push(iC.fromJSON({mediaInfos:t})),i&&r.push(KA.fromJSON({displayType:"auto"})),r.length?r:e}_getContentElementFields(e){const t=e==null?void 0:e.type;if(t==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(t==="custom")return e.outFields||[];if(t==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos||this.fieldInfos)];if(t==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((r,s)=>[...r,...this._getMediaInfoFields(s)],[])]}return t==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:t,title:i,value:r}=e,s=r||{},{fields:n=[],normalizeField:o,tooltipField:a,sourceURL:l,linkURL:c}=s,h=[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(l),...this._extractFieldNames(c),...n];return o&&h.push(o),a&&h.push(a),h}_getContentExpressionInfos(e,t){return Array.isArray(e)?e.reduce((i,r)=>[...i,...r.type==="expression"&&r.expressionInfo?[r.expressionInfo]:[]],t):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((t,i)=>[...t,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,t,i){i&&await Promise.all(i.map(r=>pc(e,t,r.expression)))}_getFieldInfoFields(e){return e?e.filter(t=>t.visible===void 0||!!t.visible).map(t=>t.fieldName).filter(t=>t.indexOf("relationships/")===-1&&t.indexOf("expression/")===-1):[]}_getActionsFields(e){return e?e.toArray().reduce((t,i)=>[...t,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:t,title:i,type:r}=e,s=r==="button"||r==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(s)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const t=/{[^}]*}/g,i=e.match(t);if(!i)return[];const r=/\{(\w+):.+\}/,s=i.filter(n=>!(n.indexOf("{relationships/")===0||n.indexOf("{expression/")===0)).map(n=>n.replace(r,"{$1}"));return s?s.map(n=>n.slice(1,-1)):[]}};u([d({type:JTe})],Us.prototype,"actions",void 0),u([d()],Us.prototype,"content",void 0),u([It("content")],Us.prototype,"castContent",null),u([Fe("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments"])],Us.prototype,"readContent",null),u([Ge("content",{popupElements:{type:pt.ofType(XTe)},showAttachments:{type:Boolean},mediaInfos:{type:pt.ofType(poe)},description:{type:String}})],Us.prototype,"writeContent",null),u([d({type:[foe],json:{write:!0}})],Us.prototype,"expressionInfos",void 0),u([d({type:[SR]})],Us.prototype,"fieldInfos",void 0),u([Ge("fieldInfos")],Us.prototype,"writeFieldInfos",null),u([d({type:YTe})],Us.prototype,"layerOptions",void 0),u([Ge("layerOptions")],Us.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],Us.prototype,"lastEditInfoEnabled",void 0),u([d()],Us.prototype,"outFields",void 0),u([d()],Us.prototype,"overwriteActions",void 0),u([d()],Us.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],Us.prototype,"title",void 0),u([Ge("title")],Us.prototype,"writeTitle",null),u([d({type:ZTe,json:{write:!0}})],Us.prototype,"relatedRecordsInfo",void 0),Us=jz=u([P(yoe)],Us);const UL=Us,E$={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function voe(e){return E$[e]||E$[e.toLowerCase()]}function wG(e){var t;return(t=E$[e])!=null?t:E$[e.toLowerCase()]}function iSe(e){return[...wG(e)]}function b4(e,t,i){i<0&&++i,i>1&&--i;const r=6*i;return r<1?e+(t-e)*r:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}function _oe(e,t,i,r=1){const s=(e%360+360)%360/360,n=i<=.5?i*(t+1):i+t-i*t,o=2*i-n;return[Math.round(255*b4(o,n,s+1/3)),Math.round(255*b4(o,n,s)),Math.round(255*b4(o,n,s-1/3)),r]}function rSe(e){const t=e.length>5,i=t?8:4,r=(1<<i)-1,s=t?1:17,n=t?e.length===9:e.length===5;let o=Number("0x"+e.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&r,o>>=i,a[3]=s*l/255),l=o&r,o>>=i,a[2]=s*l,l=o&r,o>>=i,a[1]=s*l,l=o&r,o>>=i,a[0]=s*l,a}function CO(e){return ze(z9(e),0,255)}function RO(e,t,i){return e=Number(e),isNaN(e)?i:e<t?t:e>i?i:e}class $s{constructor(t){this.r=255,this.g=255,this.b=255,this.a=1,t&&this.setColor(t)}static blendColors(t,i,r,s=new $s){return s.r=Math.round(t.r+(i.r-t.r)*r),s.g=Math.round(t.g+(i.g-t.g)*r),s.b=Math.round(t.b+(i.b-t.b)*r),s.a=t.a+(i.a-t.a)*r,s._sanitize()}static fromRgb(t,i){const r=t.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(r){const s=r[2].split(/\s*,\s*/),n=r[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),$s.fromArray(a,i)}return $s.fromArray(s.map(a=>parseFloat(a)),i)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return $s.fromArray(_oe(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),i)}return null}static fromHex(t,i=new $s){if(t.length!==4&&t.length!==7||t[0]!=="#")return null;const r=t.length===4?4:8,s=(1<<r)-1;let n=Number("0x"+t.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=r,i[o]=r===4?17*a:a}),i.a=1,i)}static fromArray(t,i=new $s){return i._set(Number(t[0]),Number(t[1]),Number(t[2]),Number(t[3])),isNaN(i.a)&&(i.a=1),i._sanitize()}static fromString(t,i){const r=voe(t)?wG(t):null;return r&&$s.fromArray(r,i)||$s.fromRgb(t,i)||$s.fromHex(t,i)}static fromJSON(t){return t&&new $s([t[0],t[1],t[2],t[3]/255])}static toUnitRGB(t){return _(t)?[t.r/255,t.g/255,t.b/255]:null}static toUnitRGBA(t){return _(t)?[t.r/255,t.g/255,t.b/255,t.a!=null?t.a:1]:null}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(t){if(typeof t=="string")$s.fromString(t,this);else if(Array.isArray(t))$s.fromArray(t,this);else{var i,r,s,n;this._set((i=t.r)!=null?i:0,(r=t.g)!=null?r:0,(s=t.b)!=null?s:0,(n=t.a)!=null?n:1),t instanceof $s||this._sanitize()}return this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const t=this.r.toString(16),i=this.g.toString(16),r=this.b.toString(16);return`#${t.length<2?"0"+t:t}${i.length<2?"0"+i:i}${r.length<2?"0"+r:r}`}toCss(t=!1){const i=this.r+", "+this.g+", "+this.b;return t?`rgba(${i}, ${this.a})`:`rgb(${i})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(t=$s.AlphaMode.ALWAYS){const i=CO(this.r),r=CO(this.g),s=CO(this.b);return t===$s.AlphaMode.ALWAYS||this.a!==1?[i,r,s,CO(255*this.a)]:[i,r,s]}clone(){return new $s(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(t){return _(t)&&t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a}_sanitize(){return this.r=Math.round(RO(this.r,0,255)),this.g=Math.round(RO(this.g,0,255)),this.b=Math.round(RO(this.b,0,255)),this.a=RO(this.a,0,1),this}_set(t,i,r,s){this.r=t,this.g=i,this.b=r,this.a=s}}$s.prototype.declaredClass="esri.Color",function(e){var t;(t=e.AlphaMode||(e.AlphaMode={}))[t.ALWAYS=0]="ALWAYS",t[t.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}($s||($s={}));const Qe=$s,qW=new si({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let sSe=0,sw=class extends ve{constructor(e){super(e),this.id="sym"+sSe++,this.type=null,this.color=new Qe([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,t){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:qW.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:qW.write}}})],sw.prototype,"type",void 0),u([d({type:Qe,json:{write:{allowNull:!0}}})],sw.prototype,"color",void 0),u([Fe("color")],sw.prototype,"readColor",null),sw=u([P("esri.symbols.Symbol")],sw);const _l=sw;var Hz;let Ag=Hz=class extends _l{constructor(e){super(e),this.data=null,this.type="cim"}readData(e,t){return t}writeData(e,t){if(e)for(const i in e)t[i]=e[i]}async collectRequiredFields(e,t){if(this.data.type==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const r=i.map(s=>{const n=s.valueExpressionInfo;return pc(e,t,n.expression)});await Promise.all(r)}}}clone(){return new Hz({data:se(this.data)})}hash(){return D9(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],Ag.prototype,"color",void 0),u([d({json:{write:!0}})],Ag.prototype,"data",void 0),u([Fe("data",["symbol"])],Ag.prototype,"readData",null),u([Ge("data",{})],Ag.prototype,"writeData",null),u([ht({CIMSymbolReference:"cim"},{readOnly:!0})],Ag.prototype,"type",void 0),Ag=Hz=u([P("esri.symbols.CIMSymbol")],Ag);const JT=Ag;let nw=class extends ve{constructor(e){super(e),this.enabled=!0,this.type=null}writeEnabled(e,t,i){e||(t[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],nw.prototype,"enabled",void 0),u([Ge("enabled")],nw.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],nw.prototype,"type",void 0),nw=u([P("esri.symbols.Symbol3DLayer")],nw);const Tp=nw,nSe=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,oSe="screenUtils.toPt: input not recognized!",boe=96;function ao(e){return e?e/72*boe:0}function kh(e){return e?72*e/boe:0}function Bi(e){if(typeof e=="string"){const t=e.match(nSe);if(t){const i=Number(t[1]),r=t[3]&&t[3].toLowerCase(),s=e.charAt(0)==="-",n=r==="px"?kh(i):i;return s?-n:n}return console.warn(oSe),null}return e}function zh(e=0,t=0){return{x:e,y:t}}function Cr(e=0,t=0){return[e,t]}function aSe(e=0,t=0){return[e,t]}function Nn(e=0,t=0,i=0){return[e,t,i]}function zf(e,t){return t?(t[0]=e.x,t[1]=e.y,t.length>2&&(t[2]=0),t):[e.x,e.y]}function xG(e){const t=z9(100*(1-e));return Math.max(0,Math.min(t,100))}function rC(e){const t=1-e/100;return Math.max(0,Math.min(t,1))}function lSe(e,t){const i=t.transparency!=null?rC(t.transparency):1,r=t.color;return r&&Array.isArray(r)?new Qe([r[0]||0,r[1]||0,r[2]||0,i]):null}function cSe(e,t){t.color=e.toJSON().slice(0,3);const i=xG(e.a);i!==0&&(t.transparency=i)}const Cm={type:Qe,json:{type:[mr],default:null,read:{source:["color","transparency"],reader:lSe},write:{target:{color:{type:[mr]},transparency:{type:mr}},writer:cSe}}},up={type:Number,cast:Bi,json:{write:!0}};let bv=class extends ve{constructor(e){super(e),this.color=new Qe([0,0,0,1]),this.extensionLength=0,this.size=kh(1)}clone(){}cloneProperties(){return{color:se(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],bv.prototype,"type",void 0),u([d(Cm)],bv.prototype,"color",void 0),u([d(me(I({},up),{json:{write:{overridePolicy:e=>({enabled:!!e})}}}))],bv.prototype,"extensionLength",void 0),u([d(up)],bv.prototype,"size",void 0),bv=u([P("esri.symbols.edges.Edges3D")],bv);const TG=bv;var qz;let S3=qz=class extends TG{constructor(e){super(e),this.type="sketch"}clone(){return new qz(this.cloneProperties())}};u([ht({sketch:"sketch"},{readOnly:!0})],S3.prototype,"type",void 0),S3=qz=u([P("esri.symbols.edges.SketchEdges3D")],S3);const uSe=S3;var Wz;let E3=Wz=class extends TG{constructor(e){super(e),this.type="solid"}clone(){return new Wz(this.cloneProperties())}};u([ht({solid:"solid"},{readOnly:!0})],E3.prototype,"type",void 0),E3=Wz=u([P("esri.symbols.support.SolidEdges3D")],E3);const hSe=E3,woe={types:{key:"type",base:TG,typeMap:{solid:hSe,sketch:uSe}},json:{write:!0}};var Xz;let nc=Xz=class extends ve{constructor(e){super(e),this.color=null}clone(){const e={color:_(this.color)?this.color.clone():null};return new Xz(e)}};u([d(Cm)],nc.prototype,"color",void 0),nc=Xz=u([P("esri.symbols.support.Symbol3DMaterial")],nc);var Yz;let Cg=Yz=class extends Tp{constructor(e){super(e),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new Yz({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([ht({Extrude:"extrude"},{readOnly:!0})],Cg.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],Cg.prototype,"size",void 0),u([d({type:nc,json:{write:!0}})],Cg.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Cg.prototype,"castShadows",void 0),u([d(woe)],Cg.prototype,"edges",void 0),Cg=Yz=u([P("esri.symbols.ExtrudeSymbol3DLayer")],Cg);const SG=Cg;let K2=class extends _l{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([ht({esriSLS:"simple-line"},{readOnly:!0})],K2.prototype,"type",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],K2.prototype,"width",void 0),K2=u([P("esri.symbols.LineSymbol")],K2);const dSe=K2,pSe=["begin","end","begin-end"],xoe=["arrow","circle","square","diamond","cross","x"];var Zz;let wd=Zz=class extends ve{constructor(e){super(e),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(e,t,i,r){(r==null?void 0:r.origin)==="web-map"?t[i]="arrow":t[i]=e}set color(e){this._set("color",e)}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}writeColor(e,t,i,r){(r==null?void 0:r.origin)==="web-map"||(t[i]=e)}clone(){return new Zz({color:se(this.color),placement:this.placement,style:this.style})}hash(){var e;return`${this.placement}.${(e=this.color)==null?void 0:e.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],wd.prototype,"placement",void 0),u([ht({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],wd.prototype,"type",void 0),u([d({type:xoe})],wd.prototype,"style",void 0),u([Ge("style")],wd.prototype,"writeStyle",null),u([d({type:Qe,value:null,json:{write:{allowNull:!0}}})],wd.prototype,"color",null),u([Fe("color")],wd.prototype,"readColor",null),u([Ge("color")],wd.prototype,"writeColor",null),wd=Zz=u([P("esri.symbols.LineSymbolMarker")],wd);const fSe=wd;var Qz;const w4=new si({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let rf=Qz=class extends dSe{constructor(...e){super(...e),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(e,t,i,r,s,n){if(e&&typeof e!="string")return e;const o={};return e!=null&&(o.style=e),t!=null&&(o.color=t),i!=null&&(o.width=Bi(i)),r!=null&&(o.cap=r),s!=null&&(o.join=s),n!=null&&(o.miterLimit=Bi(n)),o}clone(){var e;return new Qz({color:se(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(e=this.marker)==null?void 0:e.clone()})}hash(){var e,t;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(t=this.marker)==null?void 0:t.hash()}`}};u([ht({esriSLS:"simple-line"},{readOnly:!0})],rf.prototype,"type",void 0),u([d({type:w4.apiValues,json:{read:w4.read,write:w4.write}})],rf.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],rf.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],rf.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":fSe}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],rf.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],rf.prototype,"miterLimit",void 0),rf=Qz=u([P("esri.symbols.SimpleLineSymbol")],rf);const Xh=rf;let eE=class extends _l{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Xh}},json:{default:null,write:!0}})],eE.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],eE.prototype,"type",void 0),eE=u([P("esri.symbols.FillSymbol")],eE);const Toe=eE;let A3=class extends ve{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],A3.prototype,"type",void 0),A3=u([P("esri.symbols.patterns.LinePattern3D")],A3);const Soe=A3,mSe=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var Jz;const gSe=po()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let tE=Jz=class extends Soe{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new Jz(e)}};u([d({type:["style"]})],tE.prototype,"type",void 0),u([ht(gSe),d({type:mSe})],tE.prototype,"style",void 0),tE=Jz=u([P("esri.symbols.patterns.LineStylePattern3D")],tE);const EG=tE;let C3=class extends ve{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],C3.prototype,"type",void 0),C3=u([P("esri.symbols.patterns.Pattern3D")],C3);const Eoe=C3,ySe=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var Kz;let iE=Kz=class extends Eoe{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new Kz(e)}};u([d({type:["style"]})],iE.prototype,"type",void 0),u([d({type:ySe,json:{read:!0,write:!0}})],iE.prototype,"style",void 0),iE=Kz=u([P("esri.symbols.patterns.StylePattern3D")],iE);const Aoe=iE,vSe={types:{key:"type",base:Eoe,typeMap:{style:Aoe}},json:{write:!0}},Coe={types:{key:"type",base:Soe,typeMap:{style:EG}},json:{write:!0}},aA=new Qe("white");new Qe("black");const _Se=new Qe([255,255,255,0]);function bSe(e){return e.r===0&&e.g===0&&e.b===0}var e6;let lA=e6=class extends nc{constructor(e){super(e),this.colorMixMode=null}clone(){const e={color:_(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new e6(e)}};u([ht({multiply:"multiply",replace:"replace",tint:"tint"})],lA.prototype,"colorMixMode",void 0),lA=e6=u([P("esri.symbols.support.Symbol3DFillMaterial")],lA);function Dt(e=ASe){return[e[0],e[1],e[2],e[3]]}function pht(e){return[e[0],e[1],e[2],e[3]]}function i0(e,t){return e!==t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e}function wSe(e,t,i,r,s=Dt()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Roe(e,t=Dt()){return t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax,t}function kL(e,t){return new Zt({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}function Ooe(e,t){t[0]<e[0]&&(e[0]=t[0]),t[0]>e[2]&&(e[2]=t[0]),t[1]<e[1]&&(e[1]=t[1]),t[1]>e[3]&&(e[3]=t[1])}function jy(e,t,i){if(O(t))i0(i,e);else if("length"in t)i6(t)?(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[2]),i[3]=Math.max(e[3],t[3])):t.length!==2&&t.length!==3||(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[0]),i[3]=Math.max(e[3],t[1]));else switch(t.type){case"extent":i[0]=Math.min(e[0],t.xmin),i[1]=Math.min(e[1],t.ymin),i[2]=Math.max(e[2],t.xmax),i[3]=Math.max(e[3],t.ymax);break;case"point":i[0]=Math.min(e[0],t.x),i[1]=Math.min(e[1],t.y),i[2]=Math.max(e[2],t.x),i[3]=Math.max(e[3],t.y)}}function x4(e,t,i=e){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3];for(let l=0;l<r;l++){const c=t[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return i[0]=s,i[1]=n,i[2]=o,i[3]=a,i}function t6(e){for(let t=0;t<4;t++)if(!isFinite(e[t]))return!1;return!0}function Bf(e){return O(e)||e[0]>=e[2]?0:e[2]-e[0]}function l1(e){return e[1]>=e[3]?0:e[3]-e[1]}function fht(e){return Bf(e)*l1(e)}function AG(e,t=[0,0]){return t[0]=(e[0]+e[2])/2,t[1]=(e[1]+e[3])/2,t}function CG(e,t){return Moe(e,t[0],t[1])}function xSe(e,t){const i=t[3],r=.5*(e[0]+e[2]),s=Math.abs(t[0]-r),n=.5*(e[2]-e[0]);if(s>i+n)return!1;const o=.5*(e[1]+e[3]),a=.5*(e[3]-e[1]),l=Math.abs(t[1]-o);if(l>i+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=i*i}function mht(e,t,i){const r=e[0],s=e[1],n=e[2],o=e[3],{x:a,y:l}=t,{x:c,y:h}=i,p=(b,w)=>(h-l)*b+(a-c)*w+(c*l-a*h)<0,f=p(r,o),g=p(n,o),y=p(n,s),v=p(r,s);return!(f===g&&g===y&&y===v&&v===f||a<r&&c<r||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function ght(e,t){return Moe(e,t.x,t.y)}function Moe(e,t,i){return t>=e[0]&&i>=e[1]&&t<=e[2]&&i<=e[3]}function TSe(e,t,i){return t[0]>=e[0]-i&&t[1]>=e[1]-i&&t[0]<=e[2]+i&&t[1]<=e[3]+i}function zL(e,t){return Math.max(t[0],e[0])<=Math.min(t[2],e[2])&&Math.max(t[1],e[1])<=Math.min(t[3],e[3])}function WW(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}function R3(e,t,i){if(O(t))return i0(i,e);const r=t[0],s=t[1],n=t[2],o=t[3];return i[0]=ze(e[0],r,n),i[1]=ze(e[1],s,o),i[2]=ze(e[2],r,n),i[3]=ze(e[3],s,o),i}function SSe(e,t){const i=(e[0]+e[2])/2,r=(e[1]+e[3])/2,s=Math.max(Math.abs(t[0]-i)-Bf(e)/2,0),n=Math.max(Math.abs(t[1]-r)-l1(e)/2,0);return Math.sqrt(s*s+n*n)}function A$(e,t,i,r=e){return r[0]=e[0]+t,r[1]=e[1]+i,r[2]=e[2]+t,r[3]=e[3]+i,r}function Tu(e){return e?i0(e,XW):Dt(XW)}function i6(e){return e!=null&&e.length===4}function ESe(e){return!(Bf(e)!==0&&isFinite(e[0])||l1(e)!==0&&isFinite(e[1]))}function z_(e,t){return i6(e)&&i6(t)?e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]:e===t}const yht=[-1/0,-1/0,1/0,1/0],XW=[1/0,1/0,-1/0,-1/0],ASe=[0,0,0,0];function os(e=Doe){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function c1(e,t,i,r,s,n,o=os()){return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function nT(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e[4]=Math.max(e[4],t[4]),e[5]=Math.max(e[5],t[5])}function CSe(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[3]=Math.max(e[3],t[2]),e[4]=Math.max(e[4],t[3])}function hp(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}function ic(e,t,i=0,r=t.length/3){let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];for(let h=0;h<r;h++)s=Math.min(s,t[i+3*h]),n=Math.min(n,t[i+3*h+1]),o=Math.min(o,t[i+3*h+2]),a=Math.max(a,t[i+3*h]),l=Math.max(l,t[i+3*h+1]),c=Math.max(c,t[i+3*h+2]);e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function RSe(e,t,i,r){e[0]=Math.min(e[0],e[0]+t),e[3]=Math.max(e[3],e[3]+t),e[1]=Math.min(e[1],e[1]+i),e[4]=Math.max(e[4],e[4]+i),e[2]=Math.min(e[2],e[2]+r),e[5]=Math.max(e[5],e[5]+r)}function T4(e,t,i){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];if(i)for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function OSe(e){for(let t=0;t<6;t++)if(!isFinite(e[t]))return!1;return!0}function KT(e){return e[0]>=e[3]?0:e[3]-e[0]}function eS(e){return e[1]>=e[4]?0:e[4]-e[1]}function j1(e){return e[2]>=e[5]?0:e[5]-e[2]}function MSe(e){const t=KT(e),i=j1(e),r=eS(e);return Math.sqrt(t*t+i*i+r*r)}function Eh(e,t=[0,0,0]){return t[0]=e[0]+KT(e)/2,t[1]=e[1]+eS(e)/2,t[2]=e[2]+j1(e)/2,t}function OO(e,t=[0,0,0]){return t[0]=KT(e),t[1]=eS(e),t[2]=j1(e),t}function PSe(e){return Math.max(KT(e),j1(e),eS(e))}function RG(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5]}function vht(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[3]<=e[3]&&t[4]<=e[4]&&t[5]<=e[5]}function ISe(e,t){return Math.max(t[0],e[0])<=Math.min(t[3],e[3])&&Math.max(t[1],e[1])<=Math.min(t[4],e[4])&&Math.max(t[2],e[2])<=Math.min(t[5],e[5])}function Ah(e,t){return!!O(t)||ISe(e,t)}function Poe(e,t,i,r,s=e){return s[0]=e[0]+t,s[1]=e[1]+i,s[2]=e[2]+r,s[3]=e[3]+t,s[4]=e[4]+i,s[5]=e[5]+r,s}function Ioe(e,t,i=e){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i!==e&&(i[3]=e[3],i[4]=e[4],i[5]=e[5]),i}function $oe(e,t,i=e){return i[3]=t[0],i[4]=t[1],i[5]=t[2],i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),e}function BL(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function Ui(e){return e?BL(e,ZW):os(ZW)}function OG(e,t){return t||(t=Dt()),t[0]=e[0],t[1]=e[1],t[2]=e[3],t[3]=e[4],t}function _ht(e,t){return e[0]=t[0],e[1]=t[1],e[2]=Number.NEGATIVE_INFINITY,e[3]=t[2],e[4]=t[3],e[5]=Number.POSITIVE_INFINITY,e}function YW(e){return e.length===6}function VL(e){return KT(e)===0&&eS(e)===0&&j1(e)===0}function bht(e,t,i){if(O(e)||O(t))return e===t;if(!YW(e)||!YW(t))return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function $Se(e,t,i,r,s,n){return c1(e,t,i,r,s,n,DSe)}const wht=[-1/0,-1/0,-1/0,1/0,1/0,1/0],ZW=[1/0,1/0,1/0,-1/0,-1/0,-1/0],Doe=[0,0,0,0,0,0],DSe=os();function S4(e,{isPrimitive:t,width:i,depth:r,height:s}){const n=t?10:1;if(i==null&&s==null&&r==null)return[n*e[0],n*e[1],n*e[2]];const o=je(i,r,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/e[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=e[l]*a);return o}const LSe=c1(-.5,-.5,-.5,.5,.5,.5),NSe=c1(-.5,-.5,0,.5,.5,1),FSe=c1(-.5,-.5,0,.5,.5,.5);function USe(e){switch(e){case"sphere":case"cube":case"diamond":return LSe;case"cylinder":case"cone":case"inverted-cone":return NSe;case"tetrahedron":return FSe;default:return}}const MG=["butt","square","round"],kSe=[...MG,"none"],Loe=["miter","bevel","round"];var r6;let wv=r6=class extends ve{constructor(e){super(e),this.color=new Qe([0,0,0,1]),this.size=kh(1),this.pattern=null,this.patternCap="butt"}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size,pattern:_(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new r6(e)}};u([d(Cm)],wv.prototype,"color",void 0),u([d(up)],wv.prototype,"size",void 0),u([d(Coe)],wv.prototype,"pattern",void 0),u([d({type:MG,json:{default:"butt",write:{overridePolicy(){return{enabled:_(this.pattern)}}}}})],wv.prototype,"patternCap",void 0),wv=r6=u([P("esri.symbols.support.Symbol3DOutline")],wv);var O3;let sf=O3=class extends Tp{constructor(e){super(e),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const e={edges:_(this.edges)?this.edges.clone():null,enabled:this.enabled,material:_(this.material)?this.material.clone():null,pattern:_(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:_(this.outline)?this.outline.clone():null};return new O3(e)}static fromSimpleFillSymbol(e){var t,i,r,s,n,o;const a=e.outline&&e.outline.style&&e.outline.style!=="inside-frame"&&e.outline.style!=="solid"?new EG({style:e.outline.style}):null,l={size:(t=(i=e.outline)==null?void 0:i.width)!=null?t:0,color:((r=(s=e.outline)==null?void 0:s.color)!=null?r:aA).clone(),pattern:a};return a&&(n=e.outline)!=null&&n.cap&&(l.patternCap=e.outline.cap),new O3({material:new lA({color:((o=e.color)!=null?o:_Se).clone()}),pattern:e.style&&e.style!=="solid"?new Aoe({style:e.style}):null,outline:l})}};u([ht({Fill:"fill"},{readOnly:!0})],sf.prototype,"type",void 0),u([d({type:lA,json:{write:!0}})],sf.prototype,"material",void 0),u([d(vSe)],sf.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],sf.prototype,"castShadows",void 0),u([d({type:wv,json:{write:!0}})],sf.prototype,"outline",void 0),u([d(woe)],sf.prototype,"edges",void 0),sf=O3=u([P("esri.symbols.FillSymbol3DLayer")],sf);const ER=sf,zSe=["none","underline","line-through"],BSe=["normal","italic","oblique"],VSe=["normal","lighter","bold","bolder"],Noe={type:Number,cast:e=>{const t=ou(e);return t===0?1:ze(t,.1,4)},nonNullable:!0},GSe=["left","right","center","justify"],jSe=["left","right","center"],HSe=["baseline","top","middle","bottom"],qSe={type:GSe,nonNullable:!0},WSe={type:jSe,nonNullable:!0},Foe={type:HSe,nonNullable:!0};var s6;let nf=s6=class extends ve{constructor(e){super(e),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(e){return Bi(e)}clone(){return new s6({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:zSe,json:{default:"none",write:!0}})],nf.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],nf.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.textSymbol3D})}}})],nf.prototype,"size",void 0),u([It("size")],nf.prototype,"castSize",null),u([d({type:BSe,json:{default:"normal",write:!0}})],nf.prototype,"style",void 0),u([d({type:VSe,json:{default:"normal",write:!0}})],nf.prototype,"weight",void 0),nf=s6=u([P("esri.symbols.Font")],nf);const GL=nf,XSe=he.getLogger("esri.core.urlUtils"),tS=zi.request,QW="esri/config: esriConfig.request.proxyUrl is not set.",Uoe=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,koe=/^\s*http:/i,YSe=/^\s*https:/i,ZSe=/^\s*file:/i,QSe=/:\d+$/,JSe=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,KSe=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),e2e=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class xx{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let i=this.uri.match(KSe);this.scheme=i[2]||(i[1]?"":null),this.authority=i[4]||(i[3]?"":null),this.path=i[5],this.query=i[7]||(i[6]?"":null),this.fragment=i[9]||(i[8]?"":null),this.authority!=null&&(i=this.authority.match(e2e),this.user=i[3]||null,this.password=i[4]||null,this.host=i[6]||i[7],this.port=i[9]||null)}toString(){return this.uri}}const MO={},t2e=new xx(zi.applicationUrl);let Uo=t2e;const i2e=r2e();let PG=i2e;const zoe=()=>Uo,xht=()=>PG;function r2e(){const e=Uo.path,t=e.substring(0,e.lastIndexOf(e.split("/")[e.split("/").length-1]));return`${`${Uo.scheme}://${Uo.host}${Uo.port!=null?`:${Uo.port}`:""}`}${t}`}function Gn(e){const t={path:null,query:null},i=new xx(e),r=e.indexOf("?");return i.query===null?t.path=e:(t.path=e.substring(0,r),t.query=Boe(i.query)),i.fragment&&(t.hash=i.fragment,i.query===null&&(t.path=t.path.substring(0,t.path.length-(i.fragment.length+1)))),t}function Boe(e){const t=e.split("&"),i={};for(const r of t){if(!r)continue;const s=r.indexOf("=");let n,o;s<0?(n=decodeURIComponent(r),o=""):(n=decodeURIComponent(r.slice(0,s)),o=decodeURIComponent(r.slice(s+1)));let a=i[n];typeof a=="string"&&(a=i[n]=[a]),Array.isArray(a)?a.push(o):i[n]=o}return i}function JW(e){return e&&typeof e=="object"&&"toJSON"in e&&typeof e.toJSON=="function"}function sC(e,t){return e?t&&typeof t=="function"?Object.keys(e).map(i=>encodeURIComponent(i)+"="+encodeURIComponent(t(i,e[i]))).join("&"):Object.keys(e).map(i=>{const r=e[i];if(r==null)return"";const s=encodeURIComponent(i)+"=",n=t&&t[i];return n?s+encodeURIComponent(n(r)):Array.isArray(r)?r.map(o=>JW(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):JW(r)?s+encodeURIComponent(JSON.stringify(r)):s+encodeURIComponent(r)}).filter(i=>i).join("&"):""}function s2e(e=!1){let t,i=tS.proxyUrl;if(typeof e=="string"){t=h2e(e);const r=jL(e);r&&(i=r.proxyUrl)}else t=!!e;if(!i)throw XSe.warn(QW),new Q("urlutils:proxy-not-set",QW);return t&&n6()&&(i=NG(i)),Gn(i)}function n2e(e){const t=jL(e);let i,r;if(t){const s=IG(t.proxyUrl);i=s.path,r=s.query?Boe(s.query):null}if(i){const s=Gn(e);e=i+"?"+s.path;const n=sC(I(I({},r),s.query));n&&(e=`${e}?${n}`)}return e}const DS={path:"",query:""};function IG(e){const t=e.indexOf("?");return t!==-1?(DS.path=e.slice(0,t),DS.query=e.slice(t+1)):(DS.path=e,DS.query=null),DS}function Voe(e){return e=(e=R$(e=y2e(e=IG(e).path),!0)).toLowerCase()}function o2e(e){const t={proxyUrl:e.proxyUrl,urlPrefix:Voe(e.urlPrefix)},i=tS.proxyRules,r=t.urlPrefix;let s=i.length;for(let n=0;n<i.length;n++){const o=i[n].urlPrefix;if(r.indexOf(o)===0){if(r.length===o.length)return-1;s=n;break}o.indexOf(r)===0&&(s=n+1)}return i.splice(s,0,t),s}function jL(e){const t=tS.proxyRules,i=Voe(e);for(let r=0;r<t.length;r++)if(i.indexOf(t[r].urlPrefix)===0)return t[r]}function Goe(e,t){return e=KW(e),t=KW(t),R$(e)===R$(t)}function KW(e){const t=(e=Ih(e)).indexOf("/sharing");return t>0?e.substring(0,t):e.replace(/\/+$/,"")}function joe(e){const t=r=>r==null||r instanceof RegExp&&r.test(e)||typeof r=="string"&&e.startsWith(r),i=tS.interceptors;if(i){for(const r of i)if(Array.isArray(r.urls)){if(r.urls.some(t))return r}else if(t(r.urls))return r}return null}function C$(e,t,i=!1){const r=a6(e),s=a6(t);return!(!i&&r.scheme!==s.scheme)&&r.host!=null&&s.host!=null&&r.host.toLowerCase()===s.host.toLowerCase()&&r.port===s.port}function $G(e){if(typeof e=="string"){if(!oc(e))return!0;e=a6(e)}if(C$(e,Uo))return!0;const t=tS.trustedServers||[];for(let i=0;i<t.length;i++){const r=a2e(t[i]);for(let s=0;s<r.length;s++)if(C$(e,r[s]))return!0}return!1}function a2e(e){return MO[e]||(LG(e)||dp(e)?MO[e]=[new xx(yu(e))]:MO[e]=[new xx(`http://${e}`),new xx(`https://${e}`)]),MO[e]}function yu(e,t=PG,i){return dp(e)?i&&i.preserveProtocolRelative?e:Uo.scheme==="http"&&Uo.authority===iS(e).slice(2)?`http:${e}`:`https:${e}`:LG(e)?e:r0(e[0]==="/"?m2e(t):t,e)}function DG(e,t=PG,i){if(!oc(e))return e;const r=Ih(e),s=r.toLowerCase(),n=Ih(t).toLowerCase().replace(/\/+$/,""),o=i?Ih(i).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return e;const a=(p,f,g)=>(g=p.indexOf(f,g))===-1?p.length:g;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return e;e=r.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)e=`../${e}`;else e=`./${e}`;return e}function Ih(e){return e=b2e(e=_2e(e=v2e(e=yu(e=e.trim()))))}function r0(...e){const t=e.filter(_);if(!t||!t.length)return;const i=[];if(oc(t[0])){const s=t[0],n=s.indexOf("//");n!==-1&&(i.push(s.slice(0,n+1)),p2e(t[0])&&(i[0]+="/"),t[0]=s.slice(n+2))}else t[0][0]==="/"&&i.push("");const r=t.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<r.length;s++){const n=r[s];n===".."&&i.length>0&&i[i.length-1]!==".."?i.pop():(!n&&s===r.length-1||n&&(n!=="."||i.length===0))&&i.push(n)}return i.join("/")}function iS(e,t=!1){if(oT(e)||Sp(e))return null;let i=e.indexOf("://");if(i===-1&&dp(e))i=2;else{if(i===-1)return null;i+=3}const r=e.indexOf("/",i);return r!==-1&&(e=e.slice(0,r)),t&&(e=R$(e,!0)),e}function oc(e){return dp(e)||LG(e)}function oT(e){return e!=null&&e.slice(0,5)==="blob:"}function Sp(e){return e.slice(0,5)==="data:"}function Hoe(e){const t=HL(e);if(!t||!t.isBase64)return null;const i=atob(t.data),r=new Uint8Array(i.length);for(let s=0;s<i.length;s++)r[s]=i.charCodeAt(s);return r.buffer}function Tht(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const l2e=/^data:(.*?)(;base64)?,(.*)$/;function HL(e){const t=e.match(l2e);if(!t)return null;const[,i,r,s]=t;return{mediaType:i,isBase64:!!r,data:s}}function qoe(e){return e.isBase64?`data:${e.mediaType};base64,${e.data}`:`data:${e.mediaType},${e.data}`}function Sht(e,t){c2e(e,t)||u2e(e,t)}function c2e(e,t){if(!e)return!1;const i=document.createElement("a");if(!("download"in i))return!1;const r=URL.createObjectURL(e);return i.download=t,i.href=r,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),!0}function u2e(e,t){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(e,t)}function dp(e){return e!=null&&e!==void 0&&e[0]==="/"&&e[1]==="/"}function LG(e){return Uoe.test(e)}function h2e(e){return YSe.test(e)||Uo.scheme==="https"&&dp(e)}function d2e(e){return koe.test(e)||Uo.scheme==="http"&&dp(e)}function p2e(e){return ZSe.test(e)}function NG(e){return dp(e)?`https:${e}`:e.replace(koe,"https:")}function f2e(){return Uo.scheme==="http"}function n6(){return Uo.scheme==="https"}function R$(e,t=!1){return dp(e)?e.slice(2):(e=e.replace(Uoe,""),t&&e.length>1&&e[0]==="/"&&e[1]==="/"&&(e=e.slice(2)),e)}function m2e(e){const t=e.indexOf("//"),i=e.indexOf("/",t+2);return i===-1?e:e.slice(0,i)}function g2e(e){let t=0;if(oc(e)){const r=e.indexOf("//");r!==-1&&(t=r+2)}const i=e.lastIndexOf("/");return i<t?e:e.slice(0,i+1)}function Eht(e,t){if(!e)return"";const i=Gn(e).path.replace(/\/+$/,""),r=i.substring(i.lastIndexOf("/")+1);if(t==null||!t.length)return r;const s=new RegExp(`.(${t.join("|")})$`,"ig");return r.replace(s,"")}function y2e(e){return e&&e[e.length-1]==="/"?e:`${e}/`}function Woe(e){return e.replace(/\/+$/,"")}function v2e(e){if(/^https?:\/\//i.test(e)){const t=IG(e);e=(e=t.path.replace(/\/{2,}/g,"/")).replace("/","//"),t.query&&(e+=`?${t.query}`)}return e}function _2e(e){return e.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function b2e(e){const t=tS.httpsDomains;if(!d2e(e))return e;const i=e.indexOf("/",7);let r;if(r=i===-1?e:e.slice(0,i),r=r.toLowerCase().slice(7),QSe.test(r)){if(!r.endsWith(":80"))return e;r=r.slice(0,-3),e=e.replace(":80","")}return f2e()&&r===Uo.authority&&!JSe.test(e)||(n6()&&r===Uo.authority||t&&t.some(s=>r===s||r.endsWith(`.${s}`))||n6()&&!jL(e))&&(e=NG(e)),e}function o6(e,t,i){if(!(t&&i&&e&&oc(e)))return e;const r=e.indexOf("//"),s=e.indexOf("/",r+2),n=e.indexOf(":",r+2),o=Math.min(s<0?e.length:s,n<0?e.length:n);return e.slice(r+2,o).toLowerCase()!==t.toLowerCase()?e:`${e.slice(0,r+2)}${i}${e.slice(o)}`}function a6(e){return typeof e=="string"?new xx(yu(e)):(e.scheme||(e.scheme=Uo.scheme),e)}function FG(e){return x2e.test(e)}function Xoe(e,t){const i=Gn(e),r=Object.keys(i.query||{});return r.length>0&&t&&t.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),i.path}function Yoe(e,t,i){const r=Gn(e),s=r.query||{};return s[t]=String(i),`${r.path}?${sC(s)}`}function eX(e,t){const i=Gn(e),r=i.query||{};for(const n in t)r[n]=t[n];const s=sC(r);return s?`${i.path}?${s}`:i.path}function Aht(e){if(O(e))return null;const t=e.match(w2e);return t?t[1]:null}const w2e=/.*?\.([^\/]*)$/,x2e=/(^data:image\/svg|\.svg$)/i;function rS(e,t){const i=t&&t.url&&t.url.path;if(e&&i&&(e=yu(e,i,{preserveProtocolRelative:!0}),t.portalItem&&t.readResourcePaths)){const r=DG(e,t.portalItem.itemUrl);S2e.test(r)&&t.readResourcePaths.push(t.portalItem.resourceFromPath(r).path)}return l6(e,t&&t.portal)}function u1(e,t,i=nC.YES){if(!e)return e;!oc(e)&&t&&t.blockedRelativeUrls&&t.blockedRelativeUrls.push(e);let r=yu(e);if(t){const s=t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.rootPath||t.url&&t.url.path;if(s){const n=l6(s,t.portal);r=DG(l6(r,t.portal),n,n),r!==e&&t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.writtenUrls.push(r)}}return r=A2e(r,t&&t.portal),oc(r)&&(r=Ih(r)),t!=null&&t.resources&&t!=null&&t.portalItem&&!oc(r)&&!Sp(r)&&i===nC.YES&&t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r)}),r}function UG(e,t,i){return rS(e,i)}function s0(e,t,i,r){const s=u1(e,r);s!==void 0&&(t[i]=s)}const T2e=/\/items\/([^\/]+)\/resources\//,S2e=/^\.\/resources\//;function E2e(e){const t=_(e)?e.match(T2e):null;return _(t)?t[1]:null}function A2e(e,t){return t&&!t.isPortal&&t.urlKey&&t.customBaseUrl?o6(e,`${t.urlKey}.${t.customBaseUrl}`,t.portalHostname):e}function l6(e,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return e;const i=`${t.urlKey}.${t.customBaseUrl}`,r=zoe();return C$(r,`${r.scheme}://${i}`)?o6(e,t.portalHostname,i):o6(e,i,t.portalHostname)}var nC;(function(e){e[e.YES=0]="YES",e[e.NO=1]="NO"})(nC||(nC={}));const Cht=Object.freeze({__proto__:null,fromJSON:rS,toJSON:u1,read:UG,write:s0,itemIdFromResourceUrl:E2e,get MarkKeep(){return nC}});var c6;const C2e=po()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let xv=c6=class extends ve{constructor(e){super(e)}readHref(e,t,i){return e?rS(e,i):t.dataURI}writeHref(e,t,i,r){e&&(Sp(e)?t.dataURI=e:(t.href=u1(e,r),oc(t.href)&&(t.href=Ih(t.href))))}clone(){return new c6({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],xv.prototype,"href",void 0),u([Fe("href")],xv.prototype,"readHref",null),u([Ge("href",{href:{type:String},dataURI:{type:String}})],xv.prototype,"writeHref",null),u([ht(C2e)],xv.prototype,"primitive",void 0),xv=c6=u([P("esri.symbols.support.IconSymbol3DLayerResource")],xv);const R2e="circle";var u6;let Jw=u6=class extends we{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new u6({x:this.x,y:this.y})}};u([d({type:Number})],Jw.prototype,"x",void 0),u([d({type:Number})],Jw.prototype,"y",void 0),Jw=u6=u([P("esri.symbols.support.Symbol3DAnchorPosition2D")],Jw);var h6;let rE=h6=class extends ve{constructor(e){super(e),this.color=new Qe([0,0,0,1]),this.size=kh(1)}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size};return new h6(e)}};u([d(Cm)],rE.prototype,"color",void 0),u([d(up)],rE.prototype,"size",void 0),rE=h6=u([P("esri.symbols.support.Symbol3DIconOutline")],rE);var ow;const O2e=he.getLogger("esri.symbols.IconSymbol3DLayer");let xd=ow=class extends Tp{constructor(e){super(e),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=void 0,this.outline=void 0}clone(){return new ow({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,outline:_(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(e){const t=e.color||aA,i=tX(e),r=e.outline&&e.outline.width>0?{size:e.outline.width,color:(e.outline.color||aA).clone()}:null;return new ow({size:e.size,resource:{primitive:P2e(e.style)},material:{color:t},outline:r,anchor:i?"relative":void 0,anchorPosition:i})}static fromPictureMarkerSymbol(e){const t=!e.color||bSe(e.color)?aA:e.color,i=tX(e);return new ow({size:e.width<=e.height?e.height:e.width,resource:{href:e.url},material:{color:t.clone()},anchor:i?"relative":void 0,anchorPosition:i})}static fromCIMSymbol(e){return new ow({resource:{href:qoe({mediaType:"application/json",data:JSON.stringify(e.data)})}})}};function tX(e){const t="width"in e?e.width:e.size,i="height"in e?e.height:e.size,r=iX(e.xoffset),s=iX(e.yoffset);return(r||s)&&t&&i?{x:-r/t,y:s/i}:null}function iX(e){return isFinite(e)?e:0}u([d({type:nc,json:{write:!0}})],xd.prototype,"material",void 0),u([d({type:xv,json:{write:!0}})],xd.prototype,"resource",void 0),u([ht({Icon:"icon"},{readOnly:!0})],xd.prototype,"type",void 0),u([d(up)],xd.prototype,"size",void 0),u([ht({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],xd.prototype,"anchor",void 0),u([d({type:Jw,json:{type:[Number],read:{reader:e=>new Jw({x:e[0],y:e[1]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],xd.prototype,"anchorPosition",void 0),u([d({type:rE,json:{write:!0}})],xd.prototype,"outline",void 0),xd=ow=u([P("esri.symbols.IconSymbol3DLayer")],xd);const M2e={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function P2e(e){return M2e[e]||(O2e.warn(`${e} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const qf=xd;function h1(e,t,i=pt){return t||(t=new i),t===e||(t.removeAll(),I2e(e)?t.addMany(e):e&&t.add(e)),t}function Zoe(e){return e}function I2e(e){return e&&(Array.isArray(e)||"items"in e&&Array.isArray(e.items))}const Qoe="20220325",Joe="bd365f30c3ec9889ec50c6d6f51a1c6ac3877d35",Koe="4.23",$2e={async request(e,t){var i;const{default:r}=await Promise.resolve().then(function(){return W2e}),s=e.options,n=s.responseType;s.signal=t==null?void 0:t.signal,s.responseType=n==="native"||n==="native-request-init"?"native-request-init":["blob","json","text"].includes(n)&&(i=joe(e.url))!=null&&i.after?n:"array-buffer";const o=await r(e.url,s),a={data:o.data,ssl:o.ssl};switch(o.requestOptions.responseType){case"native-request-init":return delete a.data.signal,a;case"blob":a.data=await a.data.arrayBuffer();break;case"json":a.data=new TextEncoder().encode(JSON.stringify(a.data)).buffer;break;case"text":a.data=new TextEncoder().encode(a.data).buffer}return{result:a,transferList:[a.data]}}};let ws;function Rht(e){ws=e}function D2e(e){const t=ws&&ws.findCredential(e);return t&&t.token?Yoe(e,"token",t.token):e}ue("host-webworker")||(ue("edge")||ue("trident"))&&console.warn("Deprecated browser - see http://esriurl.com/oldbrowser");const L2e=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function eae(e){const t=iS(e,!0);return t&&t.endsWith(".arcgis.com")&&!L2e.includes(t)&&!e.endsWith("/sharing/rest/generateToken")}function tae(e,t,i=!1,r){return new Promise((s,n)=>{if(Ls(r))return void n(rX());let o=()=>{c(),n(new Error(`Unable to load ${t}`))},a=()=>{const h=e;c(),s(h)},l=()=>{if(!e)return;const h=e;c(),h.src="",n(rX())};const c=()=>{ue("esri-image-decode")||(e.removeEventListener("error",o),e.removeEventListener("load",a)),o=null,a=null,e=null,_(r)&&r.removeEventListener("abort",l),l=null,i&&URL.revokeObjectURL(t)};_(r)&&r.addEventListener("abort",l),ue("esri-image-decode")?e.decode().then(a,o):(e.addEventListener("error",o),e.addEventListener("load",a))})}function rX(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function Ci(e,t){var i;const r=Sp(e),s=oT(e);s||r||(e=Ih(e));const n={url:e,requestOptions:I({},t)};let o=joe(e);if(o){const h=await G2e(o,n);if(h!=null)return{data:h,getHeader:kG,requestOptions:n.requestOptions,url:n.url};o.after||o.error||(o=null)}if(e=n.url,(t=n.requestOptions).responseType==="image"){if(ue("host-webworker")||ue("host-node"))throw Ch("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n)}else if(r)throw Ch("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+t.responseType),n);if(t.method==="head"){if(t.body)throw Ch("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),n);if(r||s)throw Ch("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),n)}if(await z2e(),O$)return O$.execute(e,t);const a=new AbortController;co(t,()=>a.abort());const l={controller:a,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:o,params:n,redoRequest:!1,useIdentity:If.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},c=await H2e(l);return(i=o)==null||i.after==null||i.after(c),c}let O$;const If=zi.request,iae="FormData"in globalThis,N2e=[499,498,403,401],F2e=["COM_0056","COM_0057","SB_0008"],U2e=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],kG=()=>null,d6=Symbol();function k2e(e){const t=iS(e);t&&!Ci._corsServers.includes(t)&&Ci._corsServers.push(t)}function sX(e){const t=iS(e);return!t||t.endsWith(".arcgis.com")||Ci._corsServers.includes(t)||$G(t)}function Ch(e,t,i,r){let s="Error";const n={url:i.url,requestOptions:i.requestOptions,getHeader:kG,ssl:!1};if(t instanceof Q)return t.details?(t.details=se(t.details),t.details.url=i.url,t.details.requestOptions=i.requestOptions):t.details=n,t;if(t){const o=r&&(c=>r.headers.get(c)),a=r&&r.status,l=t.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(t.httpCode!=null?t.httpCode:t.code)||a||0,n.subCode=t.subcode,n.messageCode=t.messageCode,typeof t.details=="string"?n.messages=[t.details]:n.messages=t.details,n.raw=d6 in t?t[d6]:t}return vr(t)?pi():new Q(e,s,n)}async function z2e(){ue("host-webworker")?O$||(O$=await import("./request.009b340d.js")):Ci._abortableFetch||(Ci._abortableFetch=globalThis.fetch.bind(globalThis))}async function p6(){ws||await import("./IdentityManager.55b10d39.js")}async function B2e(e){const t=e.params.url,i=e.params.requestOptions,r=e.controller.signal,s=i.body;let n=null,o=null,a=null;if(iae&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(o=s,n=new FormData(o))),typeof s=="string"&&(a=s),e.fetchOptions={cache:i.cacheBust&&!Ci._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:i.headers||{},method:i.method==="head"?"HEAD":"GET",mode:"cors",redirect:"follow",signal:r},(n||a)&&(e.fetchOptions.body=n||a),i.authMode==="anonymous"&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(t)||i.query&&i.query.token||n&&n.get&&n.get("token")||o&&o.elements.token),!e.hasToken&&zi.apiKey&&eae(t)&&(i.query||(i.query={}),i.query.token=zi.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!rae(t)&&!Ls(r)){let l;i.authMode==="immediate"?(await p6(),l=await ws.getCredential(t,{signal:r}),e.credential=l):i.authMode==="no-prompt"?(await p6(),l=await ws.getCredential(t,{prompt:!1,signal:r}).catch(()=>{}),e.credential=l):ws&&(l=ws.findCredential(t)),l&&(e.credentialToken=l.token,e.useSSL=!!l.ssl)}}function rae(e){return U2e.some(t=>t.test(e))}async function V2e(e){let t=e.params.url;const i=e.params.requestOptions,r=e.fetchOptions,s=oT(t)||Sp(t),n=i.responseType||"json",o=s?0:i.timeout!=null?i.timeout:If.timeout;let a=!1;if(!s){e.useSSL&&(t=NG(t)),i.cacheBust&&r.cache==="default"&&(t=Yoe(t,"request.preventCache",Date.now()));let f=I({},i.query);e.credentialToken&&(f.token=e.credentialToken);let g=sC(f);ue("esri-url-encodes-apostrophe")&&(g=g.replace(/'/g,"%27"));const y=t.length+1+g.length;let v;a=i.method==="delete"||i.method==="post"||i.method==="put"||!!i.body||y>If.maxUrlLength;const b=i.useProxy||!!jL(t);if(b){const w=s2e(t);v=w.path,!a&&v.length+1+y>If.maxUrlLength&&(a=!0),w.query&&(f=I(I({},w.query),f))}if(r.method==="HEAD"&&(a||b)){if(a)throw y>If.maxUrlLength?Ch("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params):Ch("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params);if(b)throw Ch("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(a?(r.method=i.method==="delete"?"DELETE":i.method==="put"?"PUT":"POST",i.body?t=eX(t,f):(r.body=sC(f),r.headers["Content-Type"]="application/x-www-form-urlencoded")):t=eX(t,f),b&&(e.useProxy=!0,t=`${v}?${t}`),f.token&&iae&&r.body instanceof FormData){const w=r.body;w.set?w.set("token",f.token):w.append("token",f.token)}if(i.hasOwnProperty("withCredentials"))e.withCredentials=i.withCredentials;else if(!C$(t,zoe())){if($G(t))e.withCredentials=!0;else if(ws){const w=ws.findServerInfo(t);w&&w.webTierAuth&&(e.withCredentials=!0)}}e.withCredentials&&(r.credentials="include")}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,e.controller.abort()},o));try{if(i.responseType==="native-request-init")c=r,c.url=t;else if(i.responseType!=="image"||r.cache!=="default"||r.method!=="GET"||a||j2e(i.headers)||!s&&!e.useProxy&&If.proxyUrl&&!sX(t)){if(l=await Ci._abortableFetch(t,r),e.useProxy||k2e(t),i.responseType==="native")c=l;else if(r.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=nX(c,"application/xml");break;case"document":c=nX(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const g=await new Response(c).json();g.error&&(c=g)}catch{}}n==="image"&&c instanceof Blob&&(c=await oX(URL.createObjectURL(c),e,!0))}}else c=await l.text()}else c=await oX(t,e)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):pi("Request canceled");if(!(!l&&f instanceof TypeError&&If.proxyUrl)||i.body||i.method==="delete"||i.method==="head"||i.method==="post"||i.method==="put"||e.useProxy||sX(t))throw f;e.redoRequest=!0,o2e({proxyUrl:If.proxyUrl,urlPrefix:iS(t)})}finally{h&&clearTimeout(h)}return[l,c]}async function G2e(e,t){if(e.responseData!=null)return e.responseData;if(e.headers&&(t.requestOptions.headers=I(I({},t.requestOptions.headers),e.headers)),e.query&&(t.requestOptions.query=I(I({},t.requestOptions.query),e.query)),e.before){let i,r;try{r=await e.before(t)}catch(s){i=Ch("request:interceptor",s,t)}if((r instanceof Error||r instanceof Q)&&(i=Ch("request:interceptor",r,t)),i)throw e.error&&e.error(i),i;return r}}function j2e(e){if(e){for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0}return!1}function nX(e,t){let i;try{i=new DOMParser().parseFromString(e,t)}catch{}if(!i||i.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return i}async function H2e(e){var t,i;let r,s;await B2e(e);try{do[r,s]=await V2e(e);while(!await q2e(e,r,s))}catch(a){const l=Ch("request:server",a,e.params,r);throw l.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(l),l}const n=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!e.hasToken&&!e.credentialToken&&(t=s)!=null&&(i=t.user)!=null&&i.username&&!$G(n)){const a=iS(n,!0);a&&If.trustedServers.push(a)}const o=e.credential;if(o&&ws){const a=ws.findServerInfo(o.server);let l=a&&a.owningSystemUrl;if(l){l=l.replace(/\/?$/,"/sharing");const c=ws.findCredential(l,o.userId);c&&ws._getIdenticalSvcIdx(l,c)===-1&&c.resources.unshift(l)}}return{data:s,getHeader:r?a=>r.headers.get(a):kG,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}async function q2e(e,t,i){if(e.redoRequest)return e.redoRequest=!1,!1;const r=e.params.requestOptions;if(!t||r.responseType==="native"||r.responseType==="native-request-init")return!0;let s,n,o,a;if(!t.ok)throw s=new Error(`Unable to load ${t.url} status: ${t.status}`),s[d6]=i,s;i!=null&&i.error&&(s=i.error),s&&(n=Number(s.code),o=s.hasOwnProperty("subcode")?Number(s.subcode):null,a=s.messageCode,a=a&&a.toUpperCase());const l=r.authMode;if(n===403&&(o===4||s.message&&s.message.toLowerCase().indexOf("ssl")>-1&&s.message.toLowerCase().indexOf("permission")===-1)){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&(l!=="no-prompt"||n===498)&&N2e.indexOf(n)!==-1&&!rae(e.params.url)&&(n!==403||F2e.indexOf(a)===-1&&(o==null||o===2&&e.credentialToken))){await p6();try{const c=await ws.getCredential(e.params.url,{error:Ch("request:server",s,e.params),prompt:l!=="no-prompt",signal:e.controller.signal,token:e.credentialToken});return e.credential=c,e.credentialToken=c.token,e.useSSL=e.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return e.credential=null,e.credentialToken=null,!1;s=c}}if(s)throw s;return!0}function oX(e,t,i=!1){const r=t.controller.signal,s=new Image;return t.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,tae(s,e,i,r)}Ci._abortableFetch=null,Ci._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var W2e=Object.freeze(Object.defineProperty({__proto__:null,default:Ci},Symbol.toStringTag,{value:"Module"})),ty;(function(e){e[e.PENDING=0]="PENDING",e[e.RESOLVED=1]="RESOLVED",e[e.REJECTED=2]="REJECTED"})(ty||(ty={}));class X2e{constructor(t){this.instance=t,this._resolver=Jy(),this._status=ty.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=ty.RESOLVED,this._cleanUp()},()=>{this._status=ty.REJECTED,this._cleanUp()})}addResolvingPromise(t){this._resolvingPromises.push(t),this._tryResolve()}isResolved(){return this._status===ty.RESOLVED}isRejected(){return this._status===ty.REJECTED}isFulfilled(){return this._status!==ty.PENDING}abort(){this._resolver.reject(pi())}when(t,i){return this._resolver.promise.then(t,i)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const t=Jy(),i=[...this._resolvingPromises,t.promise],r=this._allPromise=Promise.all(i);r.then(()=>{this.isFulfilled()||this._allPromise!==r||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==r||vr(s)||this._resolver.reject(s)}),t.resolve()}}const AR=e=>{let t=class extends e{constructor(...i){super(...i),this._promiseProps=new X2e(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(i,r){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(i,r)}catch(i){return this.when(null,i)}addResolvingPromise(i){i&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in i?i.when():i)}};return t=u([P("esri.core.Promise")],t),t};let M$=class extends AR(we){};M$=u([P("esri.core.Promise")],M$);const Y2e="not-loaded",Z2e="loading",Q2e="failed",aX="loaded",sae=e=>{let t=class extends e{constructor(...i){super(...i),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(r=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=OL(n,l);this.destroyed&&l(new Q("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===Y2e){this._set("loadStatus",Z2e);const a=this._loadController=new AbortController;s({signal:a.signal}),co(a.signal,()=>{this._promiseProps.abort()})}return r(),o}})),this.when(()=>{this._set("loadStatus",aX),this._loadController=null},r=>{this._set("loadStatus",Q2e),this._set("loadError",r),this._loadController=null})}get loaded(){return this.loadStatus===aX}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var i;return this.isFulfilled()||(this._set("loadError",new Q("load:cancelled","Cancelled")),(i=this._loadController)==null||i.abort()),this}};return u([d({readOnly:!0})],t.prototype,"loaded",null),u([d({readOnly:!0})],t.prototype,"loadError",void 0),u([d({clonable:!1})],t.prototype,"loadStatus",void 0),u([d({type:[uc],readOnly:!0})],t.prototype,"loadWarnings",null),t=u([P("esri.core.Loadable")],t),t};let sE=class extends sae(M$){};sE=u([P("esri.core.Loadable")],sE),function(e){function t(i){return!(!i||!i.load)}e.LoadableMixin=sae,e.isLoadable=t}(sE||(sE={}));const mm=sE;var f6;const J2e=new si({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let zc=f6=class extends we{constructor(e){super(e),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(e){e!=="asc"&&e!=="desc"||this._set("sortOrder",e)}clone(){return new f6({categories:this.categories?se(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(e,t){let i,r;if(this.categories&&(i=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o)),this.extent){const o=z1(this.extent,tt.WGS84);_(o)&&(r=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&e.extraQuery&&(s="("+s+")"+e.extraQuery);const n={categories:i,bbox:r,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>J2e.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:I(I({},t),n)}}};u([d()],zc.prototype,"categories",void 0),u([d()],zc.prototype,"disableExtraQuery",void 0),u([d({type:Zt})],zc.prototype,"extent",void 0),u([d()],zc.prototype,"filter",void 0),u([d()],zc.prototype,"num",void 0),u([d()],zc.prototype,"query",void 0),u([d()],zc.prototype,"sortField",void 0),u([d()],zc.prototype,"sortOrder",null),u([d()],zc.prototype,"start",void 0),zc=f6=u([P("esri.portal.PortalQueryParams")],zc);const Vf=zc;let Tv=class extends we{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],Tv.prototype,"nextQueryParams",void 0),u([d()],Tv.prototype,"queryParams",void 0),u([d()],Tv.prototype,"results",void 0),u([d()],Tv.prototype,"total",void 0),Tv=u([P("esri.portal.PortalQueryResult")],Tv);const K2e=Tv;let of=class extends ve{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new Q("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],of.prototype,"created",void 0),u([d()],of.prototype,"id",void 0),u([d()],of.prototype,"portal",void 0),u([d()],of.prototype,"title",void 0),u([d({readOnly:!0})],of.prototype,"url",null),u([d()],of.prototype,"username",void 0),of=u([P("esri.portal.PortalFolder")],of);const eEe=of;let rn=class extends ve{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return this.portal._request(this.url+"/categorySchema",e).then(t=>{const i=t.categorySchema||[];return i.some(r=>r.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return this.portal._request(this.url+"/users",e)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}toJSON(){throw new Q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,t){let i=ns(Vf,e);return parseFloat(this.portal.currentVersion)>5?(i=i||new Vf,this.portal._queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",t)):(i=i?i.clone():new Vf,i.query="group:"+this.id+(i.query?" "+i.query:""),this.portal.queryItems(i,t))}_fetchCategorySchemaSet(e,t){return this.portal._fetchSelf(this.portal.authMode,!0,t).then(i=>{const r=i.contentCategorySetsGroupQuery;if(r){const s=new Vf;return s.disableExtraQuery=!0,s.num=1,s.query=r,this.portal.queryGroups(s,t)}throw new Q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(i=>{if(i.total){const r=i.results[0],s=new Vf;return s.num=1,s.query=`typekeywords:"${e}"`,r.queryItems(s,t)}throw new Q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(i=>i.total?i.results[0].fetchData("json",t).then(r=>{const s=r&&r.categorySchema;return s&&s.length?s:[]}):[])}};u([d()],rn.prototype,"access",void 0),u([d({type:Date})],rn.prototype,"created",void 0),u([d()],rn.prototype,"description",void 0),u([d()],rn.prototype,"id",void 0),u([d()],rn.prototype,"isInvitationOnly",void 0),u([d({type:Date})],rn.prototype,"modified",void 0),u([d()],rn.prototype,"owner",void 0),u([d()],rn.prototype,"portal",void 0),u([d()],rn.prototype,"snippet",void 0),u([d()],rn.prototype,"sortField",void 0),u([d()],rn.prototype,"sortOrder",void 0),u([d()],rn.prototype,"tags",void 0),u([d()],rn.prototype,"thumbnail",void 0),u([d({readOnly:!0})],rn.prototype,"thumbnailUrl",null),u([d()],rn.prototype,"title",void 0),u([d({readOnly:!0})],rn.prototype,"url",null),rn=u([P("esri.portal.PortalGroup")],rn);const m6=rn;var tEe=Object.freeze(Object.defineProperty({__proto__:null,default:m6},Symbol.toStringTag,{value:"Module"})),g6;let xr=g6=class extends ve{constructor(...e){super(...e),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userContentUrl(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}`:null}get url(){const e=this.get("portal.restUrl");return e?`${e}/community/users/${this.username}`:null}addItem(e){const t=e&&e.item,i=e&&e.data,r=e&&e.folder,s={method:"post"};t&&(s.query=t.createPostQuery(),i!=null&&(typeof i=="string"?s.query.text=i:typeof i=="object"&&(s.query.text=JSON.stringify(i))));let n=this.userContentUrl;return r&&(n+="/"+(typeof r=="string"?r:r.id)),this.portal._request(n+"/addItem",s).then(o=>(t.id=o.id,t.portal=this.portal,t.loaded?t.reload():t.load()))}deleteItem(e){let t=this.userContentUrl;return e.ownerFolder&&(t+="/"+e.ownerFolder),this.portal._request(t+`/items/${e.id}/delete`,{method:"post"}).then(()=>{e.id=null,e.portal=null})}deleteItems(e){const t=this.userContentUrl+"/deleteItems",i=e.map(r=>r.id);if(i.length){const r={method:"post",query:{items:i.join(",")}};return this.portal._request(t,r).then(()=>{e.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const e={query:{num:1}};return this.portal._request(this.userContentUrl,e).then(t=>{let i;return i=t&&t.folders?t.folders.map(r=>{const s=eEe.fromJSON(r);return s.portal=this.portal,s}):[],i})}fetchGroups(){return this.portal._request(this.url).then(e=>{let t;return t=e&&e.groups?e.groups.map(i=>{const r=m6.fromJSON(i);return r.portal=this.portal,r}):[],t})}fetchItems(e){e||(e={});let t,i=this.userContentUrl;return e.folder&&(i+="/"+e.folder.id),Promise.resolve().then(function(){return Zde}).then(({default:r})=>{t=r;const s={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal._request(i,{query:s})}).then(r=>{let s;return r&&r.items?(s=r.items.map(n=>{const o=t.fromJSON(n);return o.portal=this.portal,o}),Promise.all(s.map(n=>n.load())).catch(n=>n).then(()=>({items:s,nextStart:r.nextStart,total:r.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal._request(this.url+"/tags").then(e=>e.tags)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}queryFavorites(e){return this.favGroupId?(this._favGroup||(this._favGroup=new m6({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(e)):Promise.reject(new Q("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new Q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new g6;return t.sourceJSON=e,t.read(e),t}};u([d()],xr.prototype,"access",void 0),u([d({type:Date})],xr.prototype,"created",void 0),u([d()],xr.prototype,"culture",void 0),u([d()],xr.prototype,"description",void 0),u([d()],xr.prototype,"email",void 0),u([d()],xr.prototype,"favGroupId",void 0),u([d()],xr.prototype,"fullName",void 0),u([d({type:Date})],xr.prototype,"modified",void 0),u([d()],xr.prototype,"orgId",void 0),u([d()],xr.prototype,"portal",void 0),u([d()],xr.prototype,"preferredView",void 0),u([d()],xr.prototype,"privileges",void 0),u([d()],xr.prototype,"region",void 0),u([d()],xr.prototype,"role",void 0),u([d()],xr.prototype,"roleId",void 0),u([d()],xr.prototype,"sourceJSON",void 0),u([d()],xr.prototype,"thumbnail",void 0),u([d({readOnly:!0})],xr.prototype,"thumbnailUrl",null),u([d()],xr.prototype,"units",void 0),u([d({readOnly:!0})],xr.prototype,"userContentUrl",null),u([d({readOnly:!0})],xr.prototype,"url",null),u([d()],xr.prototype,"username",void 0),u([d()],xr.prototype,"userType",void 0),xr=g6=u([P("esri.portal.PortalUser")],xr);const zG=xr;var iEe=Object.freeze(Object.defineProperty({__proto__:null,default:zG},Symbol.toStringTag,{value:"Module"})),Ml;let E4;const lX={PortalGroup:()=>Promise.resolve().then(function(){return tEe}),PortalItem:()=>Promise.resolve().then(function(){return Zde}),PortalUser:()=>Promise.resolve().then(function(){return iEe})};let Ne=Ml=class extends bR(mm){constructor(e){super(e),this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=zi.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(e){return typeof e=="string"?{url:e}:e}destroy(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)}readAuthorizedCrossOriginDomains(e){if(e)for(const t of e)zi.request.trustedServers.indexOf(t)===-1&&zi.request.trustedServers.push(t);return e}readDefaultBasemap(e){return this._readBasemap(e)}readDefaultDevBasemap(e){return this._readBasemap(e)}readDefaultVectorBasemap(e){return this._readBasemap(e)}get extraQuery(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get restUrl(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}get stylesGroupQuery(){return $1e(he.getLogger(this.declaredClass),"stylesGroupQuery",{replacement:"stylesGroupQuery3d",version:"4.21"}),this.stylesGroupQuery3d}get thumbnailUrl(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}readUrlKey(e){return e&&e.toLowerCase()}readUser(e){let t=null;return e&&(t=zG.fromJSON(e),t.portal=this),t}load(e){const t=Promise.resolve().then(function(){return Hke}).then(({default:i})=>{Jt(e),E4=i}).then(()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,e)).then(i=>{if(ws){const r=ws;this.credential=r.findCredential(this.restUrl),this.credential||this.authMode!==Ml.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=r.on("credential-create",()=>{r.findCredential(this.restUrl)&&this._signIn()}))}this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}async createClosestFacilityTask(){tw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/closestFacility",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("closestFacility");return new(await import("./ClosestFacilityTask.14e8cb9a.js")).default(e)}async createElevationLayers(){await this.load();const e=this._getHelperService("defaultElevationLayers"),t=(await import("./ElevationLayer.5c81880d.js")).default;return e?e.map(i=>new t({id:i.id,url:i.url})):[]}async createGeometryService(){tw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/geometryService",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("geometry");return new(await import("./GeometryService.92f54ea8.js")).default({url:e})}async createPrintTask(){tw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/print",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("printTask");return new(await import("./PrintTask.cef7cd80.js")).default(e)}async createRouteTask(){tw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/route",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("route");return new(await import("./RouteTask.180fcf34.js")).default(e)}async createServiceAreaTask(){tw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/serviceArea",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("serviceArea");return new(await import("./ServiceAreaTask.f3a5f338.js")).default(e)}fetchBasemaps(e,t){const i=new Vf;return i.query=e||(zi.apiKey&&eae(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),i.disableExtraQuery=!0,this.queryGroups(i,t).then(r=>{if(i.num=100,i.query='type:"Web Map" -type:"Web Application"',r.total){const s=r.results[0];return i.sortField=s.sortField||"name",i.sortOrder=s.sortOrder||"desc",s.queryItems(i,t)}return null}).then(r=>{let s;return s=r&&r.total?r.results.filter(n=>n.type==="Web Map").map(n=>new E4({portalItem:n})):[],s})}fetchCategorySchema(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then(t=>t.categorySchema):Ls(e)?Promise.reject(pi()):Promise.resolve([])}fetchFeaturedGroups(e){const t=this.featuredGroups,i=new Vf;if(i.num=100,i.sortField="title",t&&t.length){const r=[];for(const s of t)r.push(`(title:"${s.title}" AND owner:${s.owner})`);return i.query=r.join(" OR "),this.queryGroups(i,e).then(s=>s.results)}return Ls(e)?Promise.reject(pi()):Promise.resolve([])}fetchRegions(e){var t;const i=((t=this.user)==null?void 0:t.culture)||this.culture||sc();return this._request(this.restUrl+"/portals/regions",me(I({},e),{query:{culture:i}}))}fetchSettings(e){var t;const i=((t=this.user)==null?void 0:t.culture)||this.culture||sc();return this._request(this.restUrl+"/portals/self/settings",me(I({},e),{query:{culture:i}}))}static getDefault(){return Ml._default&&!Ml._default.destroyed||(Ml._default=new Ml),Ml._default}queryGroups(e,t){return this._queryPortal("/community/groups",e,"PortalGroup",t)}queryItems(e,t){return this._queryPortal("/search",e,"PortalItem",t)}queryUsers(e,t){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",t)}toJSON(){throw new Q("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Ml({sourceJSON:e})}_getHelperService(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new Q("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t}_getHelperServiceUrl(e){const t=this._getHelperService(e);if(!t.url)throw new Q("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return t.url}_fetchSelf(e=this.authMode,t=!1,i){const r=this.restUrl+"/portals/self",s=I({authMode:e,query:{culture:sc().toLowerCase()}},i);return s.authMode==="auto"&&(s.authMode="no-prompt"),t&&(s.query.default=!0),this._request(r,s)}_queryPortal(e,t,i,r){const s=ns(Vf,t),n=o=>this._request(this.restUrl+e,I(I({},s.toRequestOptions(this)),r)).then(a=>{const l=s.clone();return l.start=a.nextStart,new K2e({nextQueryParams:l,queryParams:s,total:a.total,results:Ml._resultsToTypedArray(o,{portal:this},a,r)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(Em(l),a)));return i&&lX[i]?lX[i]().then(({default:o})=>(Jt(r),n(o))):n()}_signIn(){if(this.authMode===Ml.AUTH_MODE_ANONYMOUS)return Promise.reject(new Q("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const e=t=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(t||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=t,this._fetchSelf("immediate"))):this.user&&this.credential===t?null:(this.credential=t,this._fetchSelf("immediate"))).then(i=>{i&&(this.sourceJSON=i,this.read(i))});return ws?ws.getCredential(this.restUrl).then(t=>e(t)):e(this.credential)}_normalizeSSL(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")}_normalizeUrl(e){const t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.indexOf("?")>-1?"&":"?")+"token="+t:e)}_requestToTypedArray(e,t,i){return this._request(e,t).then(r=>{const s=Ml._resultsToTypedArray(i,{portal:this},r);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():r)).then(()=>s,()=>s)})}_readBasemap(e){if(e){const t=E4.fromJSON(e);return t.portalItem={portal:this},t}return null}_request(e,t={}){const i=I({f:"json"},t.query),{authMode:r=this.authMode===Ml.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=t,c={authMode:r,body:s,cacheBust:n,method:o,query:i,responseType:a,timeout:0,signal:l};return Ci(this._normalizeSSL(e),c).then(h=>h.data)}static _resultsToTypedArray(e,t,i,r){let s;if(i){const n=_(r)?r.signal:null;s=i.listings||i.notifications||i.userInvitations||i.tags||i.items||i.groups||i.comments||i.provisions||i.results||i.relatedItems||i,(e||t)&&(s=s.map(o=>{const a=Object.assign(e?e.fromJSON(o):o,t);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};Ne.AUTH_MODE_ANONYMOUS="anonymous",Ne.AUTH_MODE_AUTO="auto",Ne.AUTH_MODE_IMMEDIATE="immediate",u([d()],Ne.prototype,"access",void 0),u([d()],Ne.prototype,"allSSL",void 0),u([d()],Ne.prototype,"authMode",void 0),u([d()],Ne.prototype,"authorizedCrossOriginDomains",void 0),u([Fe("authorizedCrossOriginDomains")],Ne.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],Ne.prototype,"basemapGalleryGroupQuery",void 0),u([d()],Ne.prototype,"bingKey",void 0),u([d()],Ne.prototype,"canListApps",void 0),u([d()],Ne.prototype,"canListData",void 0),u([d()],Ne.prototype,"canListPreProvisionedItems",void 0),u([d()],Ne.prototype,"canProvisionDirectPurchase",void 0),u([d()],Ne.prototype,"canSearchPublic",void 0),u([d()],Ne.prototype,"canShareBingPublic",void 0),u([d()],Ne.prototype,"canSharePublic",void 0),u([d()],Ne.prototype,"canSignInArcGIS",void 0),u([d()],Ne.prototype,"canSignInIDP",void 0),u([d()],Ne.prototype,"colorSetsGroupQuery",void 0),u([d()],Ne.prototype,"commentsEnabled",void 0),u([d({type:Date})],Ne.prototype,"created",void 0),u([d()],Ne.prototype,"credential",void 0),u([d()],Ne.prototype,"culture",void 0),u([d()],Ne.prototype,"currentVersion",void 0),u([d()],Ne.prototype,"customBaseUrl",void 0),u([d()],Ne.prototype,"defaultBasemap",void 0),u([Fe("defaultBasemap")],Ne.prototype,"readDefaultBasemap",null),u([d()],Ne.prototype,"defaultDevBasemap",void 0),u([Fe("defaultDevBasemap")],Ne.prototype,"readDefaultDevBasemap",null),u([d({type:Zt})],Ne.prototype,"defaultExtent",void 0),u([d()],Ne.prototype,"defaultVectorBasemap",void 0),u([Fe("defaultVectorBasemap")],Ne.prototype,"readDefaultVectorBasemap",null),u([d()],Ne.prototype,"description",void 0),u([d()],Ne.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],Ne.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],Ne.prototype,"extraQuery",null),u([d()],Ne.prototype,"featuredGroups",void 0),u([d()],Ne.prototype,"featuredItemsGroupQuery",void 0),u([d()],Ne.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],Ne.prototype,"livingAtlasGroupQuery",void 0),u([d()],Ne.prototype,"hasCategorySchema",void 0),u([d()],Ne.prototype,"helpBase",void 0),u([d()],Ne.prototype,"helperServices",void 0),u([d()],Ne.prototype,"helpMap",void 0),u([d()],Ne.prototype,"homePageFeaturedContent",void 0),u([d()],Ne.prototype,"homePageFeaturedContentCount",void 0),u([d()],Ne.prototype,"httpPort",void 0),u([d()],Ne.prototype,"httpsPort",void 0),u([d()],Ne.prototype,"id",void 0),u([d()],Ne.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],Ne.prototype,"isOrganization",null),u([d()],Ne.prototype,"isPortal",void 0),u([d()],Ne.prototype,"isReadOnly",void 0),u([d()],Ne.prototype,"layerTemplatesGroupQuery",void 0),u([d()],Ne.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],Ne.prototype,"modified",void 0),u([d()],Ne.prototype,"name",void 0),u([d()],Ne.prototype,"portalHostname",void 0),u([d()],Ne.prototype,"portalMode",void 0),u([d()],Ne.prototype,"portalProperties",void 0),u([d()],Ne.prototype,"region",void 0),u([d({readOnly:!0})],Ne.prototype,"restUrl",null),u([d()],Ne.prototype,"rotatorPanels",void 0),u([d()],Ne.prototype,"showHomePageDescription",void 0),u([d()],Ne.prototype,"sourceJSON",void 0),u([d()],Ne.prototype,"staticImagesUrl",void 0),u([d({readOnly:!0,json:{read:!1}})],Ne.prototype,"stylesGroupQuery",null),u([d({json:{name:"2DStylesGroupQuery"}})],Ne.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],Ne.prototype,"stylesGroupQuery3d",void 0),u([d()],Ne.prototype,"supportsHostedServices",void 0),u([d()],Ne.prototype,"symbolSetsGroupQuery",void 0),u([d()],Ne.prototype,"templatesGroupQuery",void 0),u([d()],Ne.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ne.prototype,"thumbnailUrl",null),u([d()],Ne.prototype,"units",void 0),u([d()],Ne.prototype,"url",void 0),u([d()],Ne.prototype,"urlKey",void 0),u([Fe("urlKey")],Ne.prototype,"readUrlKey",null),u([d()],Ne.prototype,"user",void 0),u([Fe("user")],Ne.prototype,"readUser",null),u([d()],Ne.prototype,"useStandardizedQuery",void 0),u([d()],Ne.prototype,"useVectorBasemaps",void 0),u([d()],Ne.prototype,"vectorBasemapGalleryGroupQuery",void 0),Ne=Ml=u([P("esri.portal.Portal")],Ne);const gl=Ne;let Sv=class extends bp(ve){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return _(e)&&e.placement===this.placement&&e.style===this.style&&(O(this.color)&&O(e.color)||_(this.color)&&_(e.color)&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],Sv.prototype,"type",void 0),u([d({type:pSe,json:{default:"begin-end",write:!0}})],Sv.prototype,"placement",void 0),u([d({type:xoe,json:{default:"arrow",write:!0}})],Sv.prototype,"style",void 0),u([d({type:Qe,json:{type:[mr],default:null,write:!0}})],Sv.prototype,"color",void 0),Sv=u([P("esri.symbols.LineStyleMarker3D")],Sv);const y6=Sv;var M3;let Td=M3=class extends Tp{constructor(e){super(e),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=kh(1),this.pattern=null,this.marker=null}clone(){const e={enabled:this.enabled,material:_(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:_(this.pattern)?this.pattern.clone():null,marker:_(this.marker)?this.marker.clone():null};return new M3(e)}static fromSimpleLineSymbol(e){var t,i,r;const s={enabled:!0,size:(t=e.width)!=null?t:kh(1),cap:e.cap||"butt",join:e.join||"miter",pattern:e.style&&e.style!=="inside-frame"?new EG({style:e.style}):null,material:new nc({color:(e.color||aA).clone()}),marker:e.marker?new y6({placement:e.marker.placement,style:e.marker.style,color:(i=(r=e.marker.color)==null?void 0:r.clone())!=null?i:null}):null};return new M3(s)}};u([d({type:nc,json:{write:!0}})],Td.prototype,"material",void 0),u([ht({Line:"line"},{readOnly:!0})],Td.prototype,"type",void 0),u([d({type:Loe,json:{write:!0,default:"miter"}})],Td.prototype,"join",void 0),u([d({type:MG,json:{write:!0,default:"butt"}})],Td.prototype,"cap",void 0),u([d(up)],Td.prototype,"size",void 0),u([d(Coe)],Td.prototype,"pattern",void 0),u([d({types:{key:"type",base:y6,typeMap:{style:y6}},json:{write:!0}})],Td.prototype,"marker",void 0),Td=M3=u([P("esri.symbols.LineSymbol3DLayer")],Td);const sS=Td;var v6;const rEe=po()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let nE=v6=class extends ve{clone(){return new v6({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:UG,write:s0}})],nE.prototype,"href",void 0),u([ht(rEe)],nE.prototype,"primitive",void 0),nE=v6=u([P("esri.symbols.support.ObjectSymbol3DLayerResource")],nE);const nae="sphere";var _6;let u_=_6=class extends we{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new _6({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],u_.prototype,"x",void 0),u([d({type:Number})],u_.prototype,"y",void 0),u([d({type:Number})],u_.prototype,"z",void 0),u_=_6=u([P("esri.symbols.support.Symbol3DAnchorPosition3D")],u_);var b6;let _o=b6=class extends Tp{constructor(e){super(e),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new b6({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:nc,json:{write:!0}})],_o.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],_o.prototype,"castShadows",void 0),u([d({type:nE,json:{write:!0}})],_o.prototype,"resource",void 0),u([ht({Object:"object"},{readOnly:!0})],_o.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"depth",void 0),u([ht({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],_o.prototype,"anchor",void 0),u([d({type:u_,json:{type:[Number],read:{reader:e=>new u_({x:e[0],y:e[1],z:e[2]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y,e.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],_o.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],_o.prototype,"roll",void 0),u([d({readOnly:!0})],_o.prototype,"isPrimitive",null),_o=b6=u([P("esri.symbols.ObjectSymbol3DLayer")],_o);const qL=_o;var w6;let Jo=w6=class extends Tp{constructor(e){super(e),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(e,t){return e!=null?e:t.height==null&&t.size!=null?t.size:void 0}readHeight(e,t){return e!=null?e:t.width==null&&t.size!=null?t.size:void 0}clone(){return new w6({enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:nc,json:{write:!0}})],Jo.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Jo.prototype,"castShadows",void 0),u([ht({Path:"path"},{readOnly:!0})],Jo.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],Jo.prototype,"profile",void 0),u([d({type:Loe,json:{write:!0,default:"miter"}})],Jo.prototype,"join",void 0),u([d({type:kSe,json:{write:!0,default:"butt"}})],Jo.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],Jo.prototype,"width",void 0),u([Fe("width",["width","size","height"])],Jo.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],Jo.prototype,"height",void 0),u([Fe("height",["height","size","width"])],Jo.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],Jo.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],Jo.prototype,"profileRotation",void 0),Jo=w6=u([P("esri.symbols.PathSymbol3DLayer")],Jo);const BG=Jo;var x6;let Kw=x6=class extends ve{constructor(){super(...arguments),this.color=new Qe([0,0,0,1]),this.size=0}clone(){const e={color:se(this.color),size:this.size};return new x6(e)}};u([d(Cm)],Kw.prototype,"color",void 0),u([d(up)],Kw.prototype,"size",void 0),Kw=x6=u([P("esri.symbols.support.Symbol3DHalo")],Kw);let cA=class extends bp(ve){constructor(e){super(e),this.color=null}};u([d(Cm)],cA.prototype,"color",void 0),cA=u([P("esri.symbols.support.Symbol3DTextBackground")],cA);var P3;let La=P3=class extends Tp{constructor(e){super(e),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(e){_(e)&&_(this._userSize)&&(e.size=this._userSize),this._set("font",e)}writeFont(e,t,i,r){const s=me(I({},r),{textSymbol3D:!0});t.font=e.write({},s),delete t.font.size}get size(){return _(this._userSize)?this._userSize:_(this.font)&&this.font.size!=null?this.font.size:9}set size(e){this._userSize=e,_(this.font)&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const e=new P3({enabled:this.enabled,font:this.font&&se(this.font),halo:this.halo&&se(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:_(this.material)?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:se(this.background)});return e._userSize=this._userSize,e}static fromTextSymbol(e){return new P3({font:_(e.font)?e.font.clone():new GL,halo:sEe(e.haloColor,e.haloSize),horizontalAlignment:e.horizontalAlignment,lineHeight:e.lineHeight,material:e.color?new nc({color:e.color.clone()}):null,text:e.text,verticalAlignment:e.verticalAlignment,background:e.backgroundColor?new cA({color:e.backgroundColor.clone()}):null})}};function sEe(e,t){return e&&t>0?new Kw({color:se(e),size:t}):null}u([d({type:GL,json:{write:!0}})],La.prototype,"font",null),u([Ge("font")],La.prototype,"writeFont",null),u([d({type:Kw,json:{write:!0}})],La.prototype,"halo",void 0),u([d(me(I({},WSe),{json:{default:"center",write:!0}}))],La.prototype,"horizontalAlignment",void 0),u([d(me(I({},Noe),{json:{default:1,write:!0}}))],La.prototype,"lineHeight",void 0),u([d({type:nc,json:{write:!0}})],La.prototype,"material",void 0),u([d({type:cA,json:{write:!0}})],La.prototype,"background",void 0),u([d(up)],La.prototype,"size",null),u([d({type:String,json:{write:!0}})],La.prototype,"text",void 0),u([ht({Text:"text"},{readOnly:!0})],La.prototype,"type",void 0),u([d(me(I({},Foe),{json:{default:"baseline",write:!0}}))],La.prototype,"verticalAlignment",void 0),La=P3=u([P("esri.symbols.TextSymbol3DLayer")],La);const H1=La;var T6;let Rg=T6=class extends Tp{constructor(e){super(e),this.color=S6.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new T6({color:se(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Qe,nonNullable:!0,json:{type:[mr],write:(e,t,i)=>t[i]=e.toArray(Qe.AlphaMode.UNLESS_OPAQUE),default:()=>S6.clone(),defaultEquals:e=>e.toCss(!0)===S6.toCss(!0)}})],Rg.prototype,"color",void 0),u([ht({Water:"water"},{readOnly:!0})],Rg.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],Rg.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],Rg.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],Rg.prototype,"waveStrength",void 0),Rg=T6=u([P("esri.symbols.WaterSymbol3DLayer")],Rg);const S6=new Qe([0,119,190]),VG=Rg;var E6;let Ev=E6=class extends we{constructor(){super(...arguments),this.portal=null}clone(){return new E6({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],Ev.prototype,"name",void 0),u([d({type:String})],Ev.prototype,"styleUrl",void 0),u([d({type:String})],Ev.prototype,"styleName",void 0),u([d({type:gl})],Ev.prototype,"portal",void 0),Ev=E6=u([P("esri.symbols.support.StyleOrigin")],Ev);const A6=Ev;var C6;let uA=C6=class extends we{clone(){return new C6({url:this.url})}};u([d({type:String})],uA.prototype,"url",void 0),uA=C6=u([P("esri.symbols.support.Thumbnail")],uA);const oae={icon:qf,object:qL,line:sS,path:BG,fill:ER,extrude:SG,text:H1,water:VG},nEe=pt.ofType({base:Tp,key:"type",typeMap:oae,errorContext:"symbol-layer"}),oEe=he.getLogger("esri.symbols.Symbol3D");let Sd=class extends _l{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const t=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=t&&t.type||pt;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.initialized&&oEe.error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){h1(e,this._get("symbolLayers"))}readStyleOrigin(e,t,i){if(e.styleUrl&&e.name){const r=rS(e.styleUrl,i);return new A6({styleUrl:r,name:e.name})}if(e.styleName&&e.name)return new A6({portal:i&&i.portal||gl.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new uc("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,t,i,r){if(e.styleUrl&&e.name){let s=u1(e.styleUrl,r);oc(s)&&(s=Ih(s)),t.styleOrigin={styleUrl:s,name:e.name}}else e.styleName&&e.name&&(e.portal&&r&&r.portal&&!Goe(e.portal.restUrl,r.portal.restUrl)?r&&r.messages&&r.messages.push(new uc("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):t.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof Tp||e&&oae[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],Sd.prototype,"color",null),u([d({type:nEe,nonNullable:!0,json:{write:!0}}),It(Zoe)],Sd.prototype,"symbolLayers",null),u([d({type:A6})],Sd.prototype,"styleOrigin",void 0),u([Fe("styleOrigin")],Sd.prototype,"readStyleOrigin",null),u([Ge("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],Sd.prototype,"writeStyleOrigin",null),u([d({type:uA,json:{read:!1}})],Sd.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],Sd.prototype,"type",void 0),Sd=u([P("esri.symbols.Symbol3D")],Sd);const nS=Sd;let oE=class extends ve{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],oE.prototype,"type",void 0),u([d({readOnly:!0})],oE.prototype,"visible",void 0),oE=u([P("esri.symbols.callouts.Callout3D")],oE);const aae=oE;var R6;let hA=R6=class extends ve{constructor(){super(...arguments),this.color=new Qe("white")}clone(){return new R6({color:se(this.color)})}};u([d(Cm)],hA.prototype,"color",void 0),hA=R6=u([P("esri.symbols.callouts.LineCallout3DBorder")],hA);const lae=hA;Object.freeze({__proto__:null,get LineCallout3DBorder(){return hA},default:lae});var O6;let Og=O6=class extends aae{constructor(e){super(e),this.type="line",this.color=new Qe([0,0,0,1]),this.size=kh(1),this.border=null}get visible(){return this.size>0&&_(this.color)&&this.color.a>0}clone(){return new O6({color:se(this.color),size:this.size,border:se(this.border)})}};u([ht({line:"line"},{readOnly:!0})],Og.prototype,"type",void 0),u([d(Cm)],Og.prototype,"color",void 0),u([d(up)],Og.prototype,"size",void 0),u([d({type:lae,json:{write:!0}})],Og.prototype,"border",void 0),u([d({readOnly:!0})],Og.prototype,"visible",null),Og=O6=u([P("esri.symbols.callouts.LineCallout3D")],Og);const aEe=Og;function GG(e){if(!e)return!1;const t=e.verticalOffset;return!!t&&!(t.screenLength<=0||t.maxWorldLength<=0)}function cae(e){if(!e||!e.supportsCallout||!e.supportsCallout())return!1;const t=e.callout;return!!t&&!!t.visible&&!!GG(e)}function jG(e){return e.type==="point-3d"||e.type==="label-3d"}function uae(e){const{horizontalAlignment:t}=e;return t==="center"||t==="justify"}const hae={types:{key:"type",base:aae,typeMap:{line:aEe}},json:{write:!0}};var M6;let h_=M6=class extends ve{constructor(){super(...arguments),this.screenLength=0,this.minWorldLength=0}clone(){return new M6({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(up)],h_.prototype,"screenLength",void 0),u([d({type:Number,json:{write:!0,default:0}})],h_.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],h_.prototype,"maxWorldLength",void 0),h_=M6=u([P("esri.symbols.support.Symbol3DVerticalOffset")],h_);var I3;const dae=pt.ofType({base:null,key:"type",typeMap:{text:H1}});let Mg=I3=class extends nS{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new dae,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return cae(this)}hasVisibleVerticalOffset(){return GG(this)}clone(){return new I3({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail),callout:se(this.callout),verticalOffset:se(this.verticalOffset)})}static fromTextSymbol(e){return new I3({symbolLayers:[H1.fromTextSymbol(e)]})}};u([d({type:h_,json:{write:!0}})],Mg.prototype,"verticalOffset",void 0),u([d(hae)],Mg.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],Mg.prototype,"styleOrigin",void 0),u([d({type:dae})],Mg.prototype,"symbolLayers",void 0),u([ht({LabelSymbol3D:"label-3d"},{readOnly:!0})],Mg.prototype,"type",void 0),Mg=I3=u([P("esri.symbols.LabelSymbol3D")],Mg);const WL=Mg;var $3;const pae=pt.ofType({base:null,key:"type",typeMap:{line:sS,path:BG}}),lEe=pt.ofType({base:null,key:"type",typeMap:{line:sS,path:BG}});let aE=$3=class extends nS{constructor(e){super(e),this.symbolLayers=new pae,this.type="line-3d"}clone(){return new $3({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromSimpleLineSymbol(e){return new $3({symbolLayers:[sS.fromSimpleLineSymbol(e)]})}};u([d({type:pae,json:{type:lEe}})],aE.prototype,"symbolLayers",void 0),u([ht({LineSymbol3D:"line-3d"},{readOnly:!0})],aE.prototype,"type",void 0),aE=$3=u([P("esri.symbols.LineSymbol3D")],aE);const XL=aE;let Pg=class extends _l{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],Pg.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],Pg.prototype,"type",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Pg.prototype,"xoffset",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Pg.prototype,"yoffset",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Bi(e),json:{write:!0}})],Pg.prototype,"size",void 0),Pg=u([P("esri.symbols.MarkerSymbol")],Pg);const fae=Pg;var P6;const mae=pt.ofType({base:null,key:"type",typeMap:{fill:ER}});let lE=P6=class extends nS{constructor(e){super(e),this.symbolLayers=new mae,this.type="mesh-3d"}clone(){return new P6({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}};u([d({type:mae})],lE.prototype,"symbolLayers",void 0),u([ht({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],lE.prototype,"type",void 0),lE=P6=u([P("esri.symbols.MeshSymbol3D")],lE);const HG=lE;function cEe(e,t,i){return t.imageData?qoe({mediaType:t.contentType||"image/png",isBase64:!0,data:t.imageData}):gae(t.url,i)}function gae(e,t){return hEe(t)&&!oc(e)&&t.layer.parsedUrl?r0(t.layer.parsedUrl.path,"images",e):rS(e,t)}function uEe(e,t,i,r){if(Sp(e)){const s=HL(e);t.contentType=s.mediaType,t.imageData=s.data,i&&i.imageData===t.imageData&&i.url&&s0(i.url,t,"url",r)}else s0(e,t,"url",r)}const yae={json:{read:{source:["imageData","url"],reader:cEe},write:{writer(e,t,i,r){uEe(e,t,this.source,r)}}}},vae={readOnly:!0,json:{read:{source:["imageData","url"],reader(e,t,i){const r={};return t.imageData&&(r.imageData=t.imageData),t.contentType&&(r.contentType=t.contentType),t.url&&(r.url=gae(t.url,i)),r}}}};function hEe(e){return e&&(e.origin==="service"||e.origin==="portal-item")&&e.layer&&(e.layer.type==="feature"||e.layer.type==="stream")}var I6;let Bc=I6=class extends Toe{constructor(...e){super(...e),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string"&&e.imageData==null)return e;const s={};return e&&(s.url=e),t&&(s.outline=t),i!=null&&(s.width=Bi(i)),r!=null&&(s.height=Bi(r)),s}clone(){const e=new I6({color:se(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return e._set("source",se(this.source)),e}hash(){var e;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([ht({esriPFS:"picture-fill"},{readOnly:!0})],Bc.prototype,"type",void 0),u([d(yae)],Bc.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],Bc.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],Bc.prototype,"yscale",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Bc.prototype,"width",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Bc.prototype,"height",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Bc.prototype,"xoffset",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Bc.prototype,"yoffset",void 0),u([d(vae)],Bc.prototype,"source",void 0),Bc=I6=u([P("esri.symbols.PictureFillSymbol")],Bc);const _ae=Bc;var $6;let Zu=$6=class extends fae{constructor(...e){super(...e),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string"&&e.imageData==null)return e;const r={};return e&&(r.url=e),t!=null&&(r.width=Bi(t)),i!=null&&(r.height=Bi(i)),r}readHeight(e,t){return t.size||e}readWidth(e,t){return t.size||e}clone(){const e=new $6({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return e._set("source",se(this.source)),e}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],Zu.prototype,"color",void 0),u([ht({esriPMS:"picture-marker"},{readOnly:!0})],Zu.prototype,"type",void 0),u([d(yae)],Zu.prototype,"url",void 0),u([d(vae)],Zu.prototype,"source",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Zu.prototype,"height",void 0),u([Fe("height",["height","size"])],Zu.prototype,"readHeight",null),u([d({type:Number,cast:Bi,json:{write:!0}})],Zu.prototype,"width",void 0),u([d({json:{write:!1}})],Zu.prototype,"size",void 0),Zu=$6=u([P("esri.symbols.PictureMarkerSymbol")],Zu);const YL=Zu;var Ig;const bae=pt.ofType({base:null,key:"type",typeMap:{icon:qf,object:qL,text:H1}});let Av=Ig=class extends nS{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.symbolLayers=new bae,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const e of this.symbolLayers.items)switch(e.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return cae(this)}hasVisibleVerticalOffset(){return GG(this)}clone(){return new Ig({verticalOffset:se(this.verticalOffset),callout:se(this.callout),styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromSimpleMarkerSymbol(e){return new Ig({symbolLayers:[qf.fromSimpleMarkerSymbol(e)]})}static fromPictureMarkerSymbol(e){return new Ig({symbolLayers:[qf.fromPictureMarkerSymbol(e)]})}static fromCIMSymbol(e){var t,i;return((t=e.data)==null||(i=t.symbol)==null?void 0:i.type)!=="CIMPointSymbol"?null:e.data.symbol.callout?new Ig({symbolLayers:[qf.fromCIMSymbol(e)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}):new Ig({symbolLayers:[qf.fromCIMSymbol(e)]})}static fromTextSymbol(e){return new Ig({symbolLayers:[H1.fromTextSymbol(e)]})}};u([d({type:h_,json:{write:!0}})],Av.prototype,"verticalOffset",void 0),u([d(hae)],Av.prototype,"callout",void 0),u([d({type:bae,json:{origins:{"web-scene":{write:!0}}}})],Av.prototype,"symbolLayers",void 0),u([ht({PointSymbol3D:"point-3d"},{readOnly:!0})],Av.prototype,"type",void 0),Av=Ig=u([P("esri.symbols.PointSymbol3D")],Av);const Sy=Av;var cE;const wae=pt.ofType({base:null,key:"type",typeMap:{extrude:SG,fill:ER,icon:qf,line:sS,object:qL,text:H1,water:VG}}),dEe=pt.ofType({base:null,key:"type",typeMap:{extrude:SG,fill:ER,icon:qf,line:sS,object:qL,water:VG}});let aw=cE=class extends nS{constructor(e){super(e),this.symbolLayers=new wae,this.type="polygon-3d"}writeSymbolLayers(e,t,i,r){const s=e.filter(n=>n.type!=="text");if(r&&r.messages&&s.length<e.length){const n=e.find(o=>o.type==="text");r.messages.push(new Q("symbol-layer:unsupported","Symbol layers of type 'text' cannot be persisted in PolygonSymbol3D",{symbolLayer:n}))}t[i]=s.map(n=>n.write({},r)).toArray()}clone(){return new cE({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromJSON(e){const t=new cE;if(t.read(e),t.symbolLayers.length===2&&t.symbolLayers.getItemAt(0).type==="fill"&&t.symbolLayers.getItemAt(1).type==="line"){const i=t.symbolLayers.getItemAt(0),r=t.symbolLayers.getItemAt(1);!r.enabled||e.symbolLayers&&e.symbolLayers[1]&&e.symbolLayers[1].enable===!1||(i.outline={size:r.size,color:_(r.material)?r.material.color:null}),t.symbolLayers.removeAt(1)}return t}static fromSimpleFillSymbol(e){return new cE({symbolLayers:[ER.fromSimpleFillSymbol(e)]})}};u([d({type:wae,json:{type:dEe}})],aw.prototype,"symbolLayers",void 0),u([Ge("web-scene","symbolLayers")],aw.prototype,"writeSymbolLayers",null),u([ht({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],aw.prototype,"type",void 0),aw=cE=u([P("esri.symbols.PolygonSymbol3D")],aw);const CR=aw;var D6;const A4=new si({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let Cv=D6=class extends Toe{constructor(...e){super(...e),this.color=new Qe([0,0,0,.25]),this.outline=new Xh,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.style=e),t&&(r.outline=t),i&&(r.color=i),r}clone(){return new D6({color:se(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],Cv.prototype,"color",void 0),u([d()],Cv.prototype,"outline",void 0),u([ht({esriSFS:"simple-fill"},{readOnly:!0})],Cv.prototype,"type",void 0),u([d({type:A4.apiValues,json:{read:A4.read,write:A4.write}})],Cv.prototype,"style",void 0),Cv=D6=u([P("esri.symbols.SimpleFillSymbol")],Cv);const q1=Cv;var L6;const C4=new si({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let Ed=L6=class extends fae{constructor(...e){super(...e),this.color=new Qe([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new Xh}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string")return e;const s={};return e&&(s.style=e),t!=null&&(s.size=Bi(t)),i&&(s.outline=i),r&&(s.color=r),s}writeColor(e,t){e&&this.style!=="x"&&this.style!=="cross"&&(t.color=e.toJSON()),e===null&&(t.color=null)}set path(e){this.style="path",this._set("path",e)}clone(){return new L6({angle:this.angle,color:se(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var e;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(e=this.outline)==null?void 0:e.hash()}`}};u([d()],Ed.prototype,"color",void 0),u([Ge("color")],Ed.prototype,"writeColor",null),u([ht({esriSMS:"simple-marker"},{readOnly:!0})],Ed.prototype,"type",void 0),u([d()],Ed.prototype,"size",void 0),u([d({type:C4.apiValues,json:{read:C4.read,write:C4.write}})],Ed.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],Ed.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Xh}},json:{default:null,write:!0}})],Ed.prototype,"outline",void 0),Ed=L6=u([P("esri.symbols.SimpleMarkerSymbol")],Ed);const oS=Ed;var N6;let Mr=N6=class extends _l{constructor(...e){super(...e),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new GL,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.text=e),t&&(r.font=t),i&&(r.color=i),r}writeLineWidth(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}castLineWidth(e){return Bi(e)}writeLineHeight(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}clone(){return new N6({angle:this.angle,backgroundColor:se(this.backgroundColor),borderLineColor:se(this.borderLineColor),borderLineSize:this.borderLineSize,color:se(this.color),font:this.font&&this.font.clone(),haloColor:se(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${this.color.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Qe,json:{write:!0}})],Mr.prototype,"backgroundColor",void 0),u([d({type:Qe,json:{write:!0}})],Mr.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0}})],Mr.prototype,"borderLineSize",void 0),u([d({type:GL,json:{write:!0}})],Mr.prototype,"font",void 0),u([d(me(I({},qSe),{json:{write:!0}}))],Mr.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],Mr.prototype,"kerning",void 0),u([d({type:Qe,json:{write:!0}})],Mr.prototype,"haloColor",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Mr.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],Mr.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],Mr.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],Mr.prototype,"text",void 0),u([ht({esriTS:"text"},{readOnly:!0})],Mr.prototype,"type",void 0),u([d(me(I({},Foe),{json:{write:!0}}))],Mr.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Mr.prototype,"xoffset",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Mr.prototype,"yoffset",void 0),u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],Mr.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],Mr.prototype,"width",void 0),u([d({type:Number})],Mr.prototype,"lineWidth",void 0),u([Ge("lineWidth")],Mr.prototype,"writeLineWidth",null),u([It("lineWidth")],Mr.prototype,"castLineWidth",null),u([d(Noe)],Mr.prototype,"lineHeight",void 0),u([Ge("lineHeight")],Mr.prototype,"writeLineHeight",null),Mr=N6=u([P("esri.symbols.TextSymbol")],Mr);const aS=Mr;var F6;const pEe=he.getLogger("esri.symbols.WebStyleSymbol");let Ad=F6=class extends _l{constructor(e){super(e),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}read(e,t){this.portal=t?t.portal:void 0,super.read(e,t)}clone(){return new F6({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(e){return this._fetchSymbol("webRef",e)}fetchCIMSymbol(e){return this._fetchSymbol("cimRef",e)}async _fetchSymbol(e,t){const i=await fEe();Jt(t);const r=i.resolveWebStyleSymbol(this,{portal:this.portal},e,t);return r.catch(s=>{pEe.error("#fetchSymbol()","Failed to create symbol from style",s)}),r}};function fEe(){return import("./webStyleSymbolUtils.3ae42cc0.js")}u([d({json:{write:!1}})],Ad.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Ad.prototype,"styleName",void 0),u([d({type:gl,json:{write:!1}})],Ad.prototype,"portal",void 0),u([d({type:String,json:{read:UG,write:s0}})],Ad.prototype,"styleUrl",void 0),u([d({type:uA,json:{read:!1}})],Ad.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],Ad.prototype,"name",void 0),u([ht({styleSymbolReference:"web-style"},{readOnly:!0})],Ad.prototype,"type",void 0),Ad=F6=u([P("esri.symbols.WebStyleSymbol")],Ad);const W1=Ad;function qG(e){if(!e)return!1;switch(e.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function oC(e){if(!e)return!1;switch(e.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const B_={base:_l,key:"type",typeMap:{"simple-fill":q1,"picture-fill":_ae,"picture-marker":YL,"simple-line":Xh,"simple-marker":oS,text:aS,"label-3d":WL,"line-3d":XL,"mesh-3d":HG,"point-3d":Sy,"polygon-3d":CR,"web-style":W1,cim:JT},errorContext:"symbol"},mEe={base:_l,key:"type",typeMap:{"picture-marker":YL,"simple-marker":oS,text:aS,"web-style":W1,cim:JT},errorContext:"symbol"},gEe=ZT({types:B_}),xae={base:_l,key:"type",typeMap:{"simple-fill":q1,"picture-fill":_ae,"picture-marker":YL,"simple-line":Xh,"simple-marker":oS,text:aS,"line-3d":XL,"mesh-3d":HG,"point-3d":Sy,"polygon-3d":CR,"web-style":W1,cim:JT},errorContext:"symbol"},yEe={base:_l,key:"type",typeMap:{text:aS,"label-3d":WL},errorContext:"symbol"},cX={base:_l,key:"type",typeMap:{"line-3d":XL,"mesh-3d":HG,"point-3d":Sy,"polygon-3d":CR,"web-style":W1,cim:JT},errorContext:"symbol"},vEe={base:_l,key:"type",typeMap:{"label-3d":WL},errorContext:"symbol"},Tae=Fh(B_);function _Ee(e){if(!e)return null;const t={};for(const i in e){const r=dm(e[i]);r&&(t[i]=r)}return Object.keys(t).length!==0?t:null}function bEe(e){if(!_(e))return null;const t={};for(const i in e){const r=e[i];r&&(t[i]=r.toJSON())}return Object.keys(t).length!==0?t:null}let Na=class extends bp(ve){constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:va(),configurable:!0})}normalizeCtorArgs(e,t,i,r){return e&&!e.declaredClass?e:{geometry:e,symbol:t,attributes:i,popupTemplate:r}}set aggregateGeometries(e){const t=this._get("aggregateGeometries");JSON.stringify(t)!==JSON.stringify(e)&&this._set("aggregateGeometries",e)}set attributes(e){const t=this._get("attributes");t!==e&&(this._set("attributes",e),this._notifyLayer("attributes",t,e))}set geometry(e){const t=this._get("geometry");t!==e&&(this._set("geometry",e),this._notifyLayer("geometry",t,e))}set symbol(e){const t=this._get("symbol");t!==e&&(this._set("symbol",e),this._notifyLayer("symbol",t,e))}set visible(e){const t=this._get("visible");t!==e&&(this._set("visible",e),this._notifyLayer("visible",t,e))}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;for(const t of[this.sourceLayer,this.layer])if(t){if("popupTemplate"in t&&t.popupTemplate)return t.popupTemplate;if(e&&"defaultPopupTemplate"in t&&_(t.defaultPopupTemplate))return t.defaultPopupTemplate}return null}getAttribute(e){return this.attributes&&this.attributes[e]}setAttribute(e,t){if(this.attributes){const i=this.getAttribute(e);this.attributes[e]=t,this._notifyLayer("attributes",i,t,e)}else this.attributes={[e]:t},this._notifyLayer("attributes",void 0,t,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:bEe(this.aggregateGeometries),geometry:_(this.geometry)?this.geometry.toJSON():null,symbol:_(this.symbol)?this.symbol.toJSON():null,attributes:I({},this.attributes),popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(){_(this.geometry)&&this.geometry.type==="mesh"&&this._notifyLayer("transform",this.geometry.transform,this.geometry.transform)}_notifyLayer(e,t,i,r){if(!this.layer||!("graphicChanged"in this.layer))return;const s={graphic:this,property:e,oldValue:t,newValue:i};e==="attributes"&&(s.attributeName=r),this.layer.graphicChanged(s)}};u([d({value:null,json:{read:_Ee}})],Na.prototype,"aggregateGeometries",null),u([d({value:null})],Na.prototype,"attributes",null),u([d({value:null,types:V1,json:{read:dm}})],Na.prototype,"geometry",null),u([d({type:Boolean})],Na.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],Na.prototype,"layer",void 0),u([d({type:UL})],Na.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],Na.prototype,"sourceLayer",void 0),u([d({value:null,types:B_})],Na.prototype,"symbol",null),u([d({type:Boolean,value:!0})],Na.prototype,"visible",null),Na=u([P("esri.Graphic")],Na),function(e){e.generateUID=va}(Na||(Na={}));const Bo=Na;function Oht(e){}function wEe(e){return()=>e}function ZL(e,t,i){return Sa(e.map((r,s)=>t.apply(i,[r,s])))}function xEe(e,t,i){return Sa(e.map((r,s)=>t.apply(i,[r,s]))).then(r=>r.map(s=>s.value))}function Bh(e){return O(e)?Zw():e.then(t=>({ok:!0,value:t})).catch(t=>({ok:!1,error:t}))}function Mht(e){return e.then(t=>({ok:!0,value:t})).catch(t=>(Em(t),{ok:!1,error:t}))}function Pht(e){if(e.ok===!0)return e.value;throw e.error}async function Sae(e,t){return await e.load(),TEe(e,t)}async function TEe(e,t){const i=[],r=(...n)=>{for(const o of n)O(o)||(Array.isArray(o)?r(...o):pt.isCollection(o)?o.forEach(a=>r(a)):mm.isLoadable(o)&&i.push(o))};t(r);let s=null;if(await xEe(i,async n=>{(await Bh(SEe(n)?n.loadAll():n.load())).ok!==!1||s||(s=n)}),s)throw s.loadError;return e}function SEe(e){return"loadAll"in e&&typeof e.loadAll=="function"}var U6;let D3=U6=class extends ve{constructor(e){super(e),this.type="none"}clone(){return new U6({type:this.type})}};u([ht({none:"none",stayAbove:"stay-above"})],D3.prototype,"type",void 0),D3=U6=u([P("esri.ground.NavigationConstraint")],D3);var k6;const uX=he.getLogger("esri.Ground");let af=k6=class extends bR(mm){constructor(e){super(e),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new pt;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type!=="elevation"&&r.type!=="base-elevation"&&uX.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},i=r=>{r.parent=null};this.layers.on("after-add",r=>t(r.item)),this.layers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{uX.error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)t.destroy();this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=I({},e)).resourceInfo),e}set layers(e){this._set("layers",h1(e,this._get("layers")))}writeLayers(e,t,i,r){const s=[];e&&(r=me(I({},r),{layerContainerType:"ground"}),e.forEach(n=>{if("write"in n){const o={};wEe(n)().write(o,r)&&s.push(o)}else r&&r.messages&&r.messages.push(new Q("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),t.layers=s}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return Sae(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.a5a9beed.js");Jt(t);const r=new i,s=this.layers.filter(hX).toArray();return r.queryAll(s,e,t)}async createElevationSampler(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.a5a9beed.js");Jt(t);const r=new i,s=this.layers.filter(hX).toArray();return r.createSamplerAll(s,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:se(this.surfaceColor),navigationConstraint:se(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new k6({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve(null)}_loadLayersFromJSON(e,t,i){const r=t&&t.origin||"web-scene",s=t&&t.portal||null,n=t&&t.url||null;return import("./layersCreator.61465506.js").then(({populateOperationalLayers:o})=>{Jt(i);const a=[];if(e.layers&&Array.isArray(e.layers)){const l={context:{origin:r,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,e.layers,l))}return Sa(a)}).then(()=>{})}};function EEe(e){return e&&"createElevationSampler"in e}function hX(e){return e.type==="elevation"||EEe(e)}u([d({json:{read:!1}})],af.prototype,"layers",null),u([Ge("layers")],af.prototype,"writeLayers",null),u([d({readOnly:!0})],af.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:mr,read:{reader:rC,source:"transparency"},write:{writer:(e,t)=>{t.transparency=xG(e)},target:"transparency"}}})],af.prototype,"opacity",void 0),u([d({type:Qe,json:{type:[mr],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],af.prototype,"surfaceColor",void 0),u([d({type:D3,json:{write:!0}})],af.prototype,"navigationConstraint",void 0),af=k6=u([P("esri.Ground")],af);const aC=af;var z6;let $g=z6=class extends ve{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new z6({rotation:this.rotation,scale:this.scale,targetGeometry:_(this.targetGeometry)?this.targetGeometry.clone():null,camera:_(this.camera)?this.camera.clone():null})}};function R4(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:R4}}}}})],$g.prototype,"rotation",void 0),u([It("rotation")],$g.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:R4}}}}})],$g.prototype,"scale",void 0),u([d({types:V1,json:{read:dm,write:!0,origins:{"web-scene":{read:dm,write:{overridePolicy:R4}}}}})],$g.prototype,"targetGeometry",void 0),u([d({type:ml,json:{write:!0}})],$g.prototype,"camera",void 0),$g=z6=u([P("esri.Viewpoint")],$g);const Vh=$g;function QL(e){return typeof e=="string"?document.getElementById(e):e}function Eae(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function dX(e,t){const i=t.parentNode;i&&i.insertBefore(e,t)}function pX(e,t){for(;;){const i=e.firstChild;if(!i)break;t.appendChild(i)}}function Iht(e){const t=[];return function*(){yield*t;for(const i of e)t.push(i),yield i}}function $ht(e,t){for(const i of e)if(i!=null&&t(i))return i}function AEe(e){return e!=null&&typeof e[Symbol.iterator]=="function"}function Nt(e,t,i={}){return WG(e,t,i,Aae)}function JL(e,t,i={}){return WG(e,t,i,Cae)}function WG(e,t,i={},r){let s=null;const n=i.once?(o,a)=>{r(o)&&(Ys(s),t(o,a))}:(o,a)=>{r(o)&&t(o,a)};if(s=Vbe(e,n,i.sync,i.equals),i.initial){const o=e();n(o,o)}return s}function Tx(e,t,i,r={}){let s=null,n=null,o=null;function a(){s&&n&&(n.remove(),r.onListenerRemove==null||r.onListenerRemove(s),s=null,n=null)}function l(h){r.once&&r.once&&Ys(o),i(h)}const c=Nt(e,(h,p)=>{a(),CL(h)&&(s=h,n=gR(h,t,l),r.onListenerAdd==null||r.onListenerAdd(h))},{sync:r.sync,initial:!0});return o=Sm(()=>{c.remove(),a()}),o}function P$(e,t){return CEe(e,Cae,t)}function CEe(e,t,i){if(Ls(i))return Promise.reject(pi());const r=e();if(t!=null&&t(r))return Promise.resolve(r);let s=null;function n(){s=Ys(s)}return new Promise((o,a)=>{s=Hx([co(i,()=>{n(),a(pi())}),WG(e,l=>{n(),o(l)},{sync:!1,once:!0},t!=null?t:Aae)])})}function Aae(e){return!0}function Cae(e){return!!e}const ph={sync:!0},un={initial:!0},Yl={sync:!0,initial:!0};var _a;(function(e){e[e.HANDSHAKE=0]="HANDSHAKE",e[e.OPEN=1]="OPEN",e[e.OPENED=2]="OPENED",e[e.RESPONSE=3]="RESPONSE",e[e.INVOKE=4]="INVOKE",e[e.ABORT=5]="ABORT",e[e.CLOSE=6]="CLOSE",e[e.OPEN_PORT=7]="OPEN_PORT",e[e.ON=8]="ON"})(_a||(_a={}));let REe=0;function Rae(){return REe++}function OEe(e){return e&&typeof e=="object"&&("result"in e||"transferList"in e)}function I$(e){return e?typeof e=="string"?JSON.stringify({name:"message",message:e}):e.toJSON?JSON.stringify(e):JSON.stringify({name:e.name,message:e.message,details:e.details||{stack:e.stack}}):null}function Oae(e,t,i,r){if(t.type===_a.OPEN_PORT)return void e.postMessage(t,[t.port]);if(t.type!==_a.INVOKE&&t.type!==_a.RESPONSE)return void e.postMessage(t);let s;OEe(i)?(s=fX(i.transferList),t.data=i.result):(s=fX(r),t.data=i),s?e.postMessage(t,s):e.postMessage(t)}function lC(e){if(!e)return null;const t=e.data;return t?typeof t=="string"?JSON.parse(t):t:null}function fX(e){if(!e||!e.length)return null;if(ue("esri-workers-arraybuffer-transfer"))return e;const t=e.filter(i=>!MEe(i));return t.length?t:null}function MEe(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}const PEe={statsWorker:()=>import("./statsWorker.55180366.js"),geometryEngineWorker:()=>import("./geometryEngineWorker.49a69fdc.js"),CSVSourceWorker:()=>import("./CSVSourceWorker.dc0a7bed.js"),EdgeProcessingWorker:()=>Promise.resolve().then(function(){return $lt}),ElevationSamplerWorker:()=>import("./ElevationSamplerWorker.2fd354ef.js"),FeatureServiceSnappingSourceWorker:()=>import("./FeatureServiceSnappingSourceWorker.7aea508f.js"),GeoJSONSourceWorker:()=>import("./GeoJSONSourceWorker.58923aeb.js"),LercWorker:()=>import("./LercWorker.f6b1bcc8.js"),MemorySourceWorker:()=>import("./MemorySourceWorker.ab757f29.js"),PBFDecoderWorker:()=>import("./PBFDecoderWorker.08ae5e11.js"),Pipeline:()=>import("./Pipeline.395d44aa.js").then(function(e){return e.P}),PointCloudWorker:()=>import("./PointCloudWorker.61954296.js"),RasterWorker:()=>import("./RasterWorker.ed9593d2.js"),SceneLayerWorker:()=>import("./SceneLayerWorker.2fc0c6ad.js").then(function(e){return e.S}),WFSSourceWorker:()=>import("./WFSSourceWorker.c56946d8.js"),WorkerTileHandler:()=>import("./WorkerTileHandler.bca39041.js")},{CLOSE:mX,ABORT:gX,INVOKE:yX,RESPONSE:LS,OPEN_PORT:vX,ON:IEe}=_a;class $Ee{constructor(t){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=t,this._timer=null,this._process=this._process.bind(this)}push(t){t.type===_a.ABORT?this._cancelledJobIds.add(t.jobId):(this._invokeMessages.push(t),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const t of this._invokeMessages)this._cancelledJobIds.has(t.jobId)||this._invoke(t);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class el{constructor(t,i){this._port=t,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new $Ee(r=>this._onInvokeMessage(r)),this._client=i.client,this._onMessage=this._onMessage.bind(this),this._channel=i.channel,this._schedule=i.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}static connect(t){const i=new MessageChannel;let r;r=typeof t=="function"?new t:"default"in t&&typeof t.default=="function"?new t.default:t;const s=new el(i.port1,{channel:i,client:r});return typeof r=="object"&&"remoteClient"in r&&(r.remoteClient=s),el.clients.set(s,r),i.port2}static loadWorker(t){const i=PEe[t];return i?i():Promise.resolve(null)}close(){this._post({type:mX}),this._close()}isBusy(){return this._outJobs.size>0}invoke(t,i,r){const s=r&&r.signal,n=r&&r.transferList;if(!this._port)return Promise.reject(new Q("worker:port-closed",`Cannot call invoke('${t}'), port is closed`,{methodName:t,data:i}));const o=Rae();return new Promise((a,l)=>{const c=OL(s,()=>{var p;const f=this._outJobs.get(o);f&&(this._outJobs.delete(o),(p=f.abortHandle)==null||p.remove(),this._post({type:gX,jobId:o}),l(pi()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:t};this._outJobs.set(o,h),this._post({type:yX,jobId:o,methodName:t,abortable:s!=null},i,n)})}on(t,i){const r=new MessageChannel;function s(n){i(n.data)}return this._port.postMessage({type:_a.ON,eventType:t,port:r.port2},[r.port2]),r.port1.addEventListener("message",s),r.port1.start(),{remove(){r.port1.postMessage({type:_a.CLOSE}),r.port1.close(),r.port1.removeEventListener("message",s)}}}openPort(){const t=new MessageChannel;return this._post({type:vX,port:t.port2}),t.port1}_close(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(t=>{var i;(i=t.abortHandle)==null||i.remove(),t.reject(pi(`Worker closing, aborting job calling '${t.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(t){_(this._schedule)?this._schedule(()=>this._processMessage(t)):this._processMessage(t)}_processMessage(t){const i=lC(t);if(i)switch(i.type){case LS:this._onResponseMessage(i);break;case yX:this._invokeQueue.push(i);break;case gX:this._onAbortMessage(i);break;case mX:this._onCloseMessage();break;case vX:this._onOpenPortMessage(i);break;case IEe:this._onOnMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);this._invokeQueue.push(t),s&&(s.controller&&s.controller.abort(),i.delete(r))}_onCloseMessage(){const t=this._client;this._close(),t&&"destroy"in t&&el.clients.get(this)===t&&t.destroy(),el.clients.delete(this),t&&t.remoteClient&&(t.remoteClient=null)}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[i];try{if(!h&&i&&i.indexOf(".")!==-1){const p=i.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${i} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:LS,jobId:r,error:I$(p)})}_c(l)?(a.set(r,{controller:o,promise:l}),l.then(p=>{a.has(r)&&(a.delete(r),this._post({type:LS,jobId:r},p))},p=>{a.has(r)&&(a.delete(r),vr(p)||this._post({type:LS,jobId:r,error:I$(p||{message:`Error encountered at method ${i}`})}))})):this._post({type:LS,jobId:r},l)}_onOpenPortMessage(t){new el(t.port,{client:this._client})}_onOnMessage(t){const{port:i}=t,r=this._client.on(t.eventType,n=>{i.postMessage(n)}),s=gR(t.port,"message",n=>{lC(n).type===_a.CLOSE&&(s.remove(),r.remove(),i.close())})}_onResponseMessage(t){var i;const{jobId:r,error:s,data:n}=t,o=this._outJobs;if(!o.has(r))return;const a=o.get(r);o.delete(r),(i=a.abortHandle)==null||i.remove(),s?a.reject(Q.fromJSON(JSON.parse(s))):a.resolve(n)}_post(t,i,r){return Oae(this._port,t,i,r)}}el.kernelInfo={revision:Joe,version:Koe,buildDate:Qoe},el.clients=new Map;const DEe=he.getLogger("esri.core.workers.Connection");class LEe{constructor(){this._clients=new Array,this._clientPromises=new Array,this._clientIdx=0}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(t,i){return new Promise((r,s)=>{let n=!0;const o=a=>{Jt(i.signal),n&&(n=!1,a())};this._clients.length=t.length,this._clientPromises.length=t.length;for(let a=0;a<t.length;++a){const l=t[a];_c(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new el(c,i),o(r),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new el(l,i),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(r))}})}broadcast(t,i,r){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a.invoke(t,i,r))}return s}close(){for(const t of this._clientPromises)t.then(i=>i.close());this._clients.length=0,this._clientPromises.length=0}getAvailableClient(){let t;for(let i=0;i<this._clients.length;++i){const r=this._clients[i];if(r){if(!r.isBusy())return Promise.resolve(r)}else t=t||[],t.push(this._clientPromises[i])}return t?Promise.race(t):(this._clientIdx=(this._clientIdx+1)%this._clients.length,Promise.resolve(this._clients[this._clientIdx]))}invoke(t,i,r){let s=null;return Array.isArray(r)?(DEe.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:r}):s=r,this.closed?Promise.reject(new Error("Connection closed")):this.getAvailableClient().then(n=>n.invoke(t,i,s))}on(t,i){return Promise.all(this._clientPromises).then(()=>Hx(this._clients.map(r=>r.on(t,i))))}openPorts(){return new Promise(t=>{const i=new Array(this._clientPromises.length);let r=i.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{i[s]=n.openPort(),--r==0&&t(i)})})}get test(){return{numClients:this._clients.length}}}const NEe=he.getLogger("esri.assets");function FEe(e,t){return Ci(ui(e),t)}function ui(e){if(!zi.assetsPath)throw NEe.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new Q("assets:path-not-set","config.assetsPath is not set");return r0(zi.assetsPath,e)}const Mae=he.getLogger("esri.intl");function lf(e,t,i={}){const{format:r={}}=i;return ap(e,s=>UEe(s,t,r))}function UEe(e,t,i){let r,s;const n=e.indexOf(":");if(n===-1?r=e.trim():(r=e.slice(0,n).trim(),s=e.slice(n+1).trim()),!r)return"";const o=YT(r,t);if(o==null)return"";const a=i[s]||i[r];return a?kEe(o,a):s?zEe(o,s):XG(o)}function kEe(e,t){switch(t.type){case"date":return pm(e,t.intlOptions);case"number":return fm(e,t.intlOptions);default:return Mae.warn("missing format descriptor for key {key}"),XG(e)}}function zEe(e,t){switch(t.toLowerCase()){case"dateformat":return pm(e);case"numberformat":return fm(e);default:return Mae.warn(`inline format is unsupported since 4.12: ${t}`),/^(dateformat|datestring)/i.test(t)?pm(e):/^numberformat/i.test(t)?fm(e):XG(e)}}function XG(e){switch(typeof e){case"string":return e;case"number":return fm(e);case"boolean":return""+e;default:return e instanceof Date?pm(e):""}}const _X=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,BEe={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function bX(e){var t;return(t=BEe[e])!=null&&t}const uE=[],Sx=new Map;function wX(e){for(const t of Sx.keys())Iae(e.pattern,t)&&Sx.delete(t)}function VEe(e){return uE.includes(e)||(wX(e),uE.unshift(e)),{remove(){const t=uE.indexOf(e);t>-1&&(uE.splice(t,1),wX(e))}}}async function Pae(e){const t=sc();Sx.has(e)||Sx.set(e,jEe(e,t));const i=Sx.get(e);return await HEe.add(i),i}function GEe(e){if(!_X.test(e))return null;const[,t,i]=_X.exec(e),r=t+(i?"-"+i.toUpperCase():"");return bX(r)?r:bX(t)?t:null}async function jEe(e,t){const i=[];for(const r of uE)if(Iae(r.pattern,e))try{return await r.fetchMessageBundle(e,t)}catch(s){i.push(s)}throw i.length?new Q("intl:message-bundle-error",`Errors occurred while loading "${e}"`,{errors:i}):new Q("intl:no-message-bundle-loader",`No loader found for message bundle "${e}"`)}function Iae(e,t){return typeof e=="string"?t.startsWith(e):e.test(t)}yG(()=>{Sx.clear()});const HEe=new class{constructor(){this._numLoading=0}async waitForAll(){this._dfd&&await this._dfd.promise}add(e){return this._increase(),e.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=Jy())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function qEe(e,t,i,r){const s=t.exec(i);if(!s)throw new Q("esri-intl:invalid-bundle",`Bundle id "${i}" is not compatible with the pattern "${t}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=GEe(r),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await xX(e(c))}catch(p){if(c===l)throw new Q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:p});try{h=await xX(e(l))}catch(f){throw new Q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:f})}}return h}async function xX(e){if(_(TX.fetchBundleAsset))return TX.fetchBundleAsset(e);const t=await Ci(e,{responseType:"text"});return JSON.parse(t.data)}class WEe{constructor({base:t="",pattern:i,location:r=new URL(window.location.href)}){let s;s=typeof r=="string"?n=>new URL(n,new URL(r,window.location.href)).href:r instanceof URL?n=>new URL(n,r).href:r,this.pattern=typeof i=="string"?new RegExp(`^${i}`):i,this.getAssetUrl=s,t=t?t.endsWith("/")?t:t+"/":"",this.matcher=new RegExp(`^${t}(?:(.*)/)?(.*)$`)}fetchMessageBundle(t,i){return qEe(this.getAssetUrl,this.matcher,t,i)}}function XEe(e){return new WEe(e)}const TX={};VEe(XEe({pattern:"esri/",location:ui}));const SX={};function YEe(e,t){for(const i of e)if(i.name===t.name)return;e.push(t)}function ZEe(e){var t;const i={async:e.async,isDebug:e.isDebug,locale:e.locale,baseUrl:e.baseUrl,has:I({},e.has),map:I({},e.map),packages:e.packages&&e.packages.concat()||[],paths:I({},e.paths)};return e.hasOwnProperty("async")||(i.async=!0),e.hasOwnProperty("isDebug")||(i.isDebug=!1),e.baseUrl||(i.baseUrl=SX.baseUrl),(t=SX.packages)==null||t.forEach(r=>{YEe(i.packages,r)}),i}class QEe{constructor(){const t=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(i=>{this[i]=(...r)=>t[i](...r)})}}class L3{constructor(){this._dispatcher=new QEe,this._workerPostMessage({type:_a.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(t){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=t,t&&this.addEventListener("message",t)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(t){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=t,t&&this.addEventListener("messageerror",t)}get onerror(){return this._onerrorHandler}set onerror(t){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=t,t&&this.addEventListener("error",t)}postMessage(t){qx(()=>{this._workerMessageHandler(new MessageEvent("message",{data:t}))})}dispatchEvent(t){return this._dispatcher.dispatchEvent(t)}addEventListener(t,i,r){this._dispatcher.addEventListener(t,i,r)}removeEventListener(t,i,r){this._dispatcher.removeEventListener(t,i,r)}_workerPostMessage(t){qx(()=>{this.dispatchEvent(new MessageEvent("message",{data:t}))})}async _workerMessageHandler(t){const i=lC(t);if(i&&i.type===_a.OPEN){const{modulePath:r,jobId:s}=i;let n=await el.loadWorker(r);n||(n=await import(r));const o=el.connect(n);this._workerPostMessage({type:_a.OPENED,jobId:s,data:o})}}}const B6=he.getLogger("esri.core.workers"),{HANDSHAKE:JEe}=_a,KEe='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,buildDate:r,version:t}=configuration.kernelInfo,{revision:n,buildDate:i,version:s}=e.kernelInfo;o!==n&&console.warn(`[esri.core.workers] Version mismatch detected between ArcGIS API for JavaScript and assets:\\nAPI version: ${t} [Date: ${r}, Revision: ${o.slice(0,8)}]\nAssets version: ${s} [Date: ${i}, Revision: ${n.slice(0,8)}]`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let e;function t(o){const t=e.connect(o);self.postMessage({type:2,jobId:r,data:t},[t])}"function"==typeof define&&define.amd?require([workerPath],(r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((r=>(e=r.default,checkWorkerRevision(e),e.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),e=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(e),e.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const e=outgoing.get(r);outgoing.delete(r),o.error?e.reject(JSON.parse(o.error)):e.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let PO,IO;const EX="Failed to create Worker. Fallback to execute module in main thread";async function eAe(){if(!ue("esri-workers")||(ue("mozilla"),0))return AX(new L3);if(!PO&&!IO)try{const t=KEe.replace('"{CONFIGURATION}"',`'${tAe()}'`);PO=URL.createObjectURL(new Blob([t],{type:"text/javascript"}))}catch(t){IO=t||{}}let e;if(PO)try{e=new Worker(PO,{name:"esri-worker-"+iAe++})}catch{B6.warn(EX,IO),e=new L3}else B6.warn(EX,IO),e=new L3;return AX(e)}async function AX(e){return new Promise(t=>{function i(s){const n=lC(s);n&&n.type===JEe&&(e.removeEventListener("message",i),e.removeEventListener("error",r),t(e))}function r(s){s.preventDefault(),e.removeEventListener("message",i),e.removeEventListener("error",r),B6.warn("Failed to create Worker. Fallback to execute module in main thread",s),(e=new L3).addEventListener("message",i),e.addEventListener("error",r)}e.addEventListener("message",i),e.addEventListener("error",r)})}function tAe(){let e;if(zi.default!=null){const s=I({},zi);delete s.default,e=JSON.parse(JSON.stringify(s))}else e=JSON.parse(JSON.stringify(zi));e.assetsPath=yu(e.assetsPath),e.request.interceptors=[],e.log.interceptors=[],e.locale=sc(),e.has={"esri-csp-restrictions":ue("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":ue("esri-2d-update-debug"),"esri-2d-query-centroid-enabled":ue("esri-2d-query-centroid-enabled"),"featurelayer-pbf":ue("featurelayer-pbf"),"featurelayer-simplify-thresholds":ue("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":ue("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":ue("featurelayer-simplify-mobile-factor"),"esri-atomics":ue("esri-atomics"),"esri-shared-array-buffer":ue("esri-shared-array-buffer"),"esri-tiles-debug":ue("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":ue("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":ue("feature-polyline-generalization-factor"),"host-webworker":1},e.workers.loaderUrl&&(e.workers.loaderUrl=yu(e.workers.loaderUrl)),e.workers.workerPath?e.workers.workerPath=yu(e.workers.workerPath):e.workers.workerPath=yu(ui("esri/core/workers/RemoteClient.js")),e.workers.useDynamicImport=!1;const t=zi.workers.loaderConfig,i=ZEe({baseUrl:t==null?void 0:t.baseUrl,locale:sc(),has:I({"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1},t==null?void 0:t.has),map:I({},t==null?void 0:t.map),paths:I({},t==null?void 0:t.paths),packages:(t==null?void 0:t.packages)||[]}),r={version:Koe,buildDate:Qoe,revision:Joe};return JSON.stringify({esriConfig:e,loaderConfig:i,kernelInfo:r})}let iAe=0;const rAe=he.getLogger("esri.core.workers"),{ABORT:CX,INVOKE:sAe,OPEN:nAe,OPENED:oAe,RESPONSE:NS}=_a;class YG{constructor(t,i){this._outJobs=new Map,this._inJobs=new Map,this.worker=t,this.id=i,t.addEventListener("message",this._onMessage.bind(this)),t.addEventListener("error",r=>{r.preventDefault(),rAe.error(r)})}static async create(t){const i=await eAe();return new YG(i,t)}terminate(){this.worker.terminate()}async open(t,i={}){const{signal:r}=i,s=Rae();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:OL(r,()=>{this._outJobs.delete(s),this._post({type:CX,jobId:s})})};this._outJobs.set(s,a),this._post({type:nAe,jobId:s,modulePath:t})})}_onMessage(t){const i=lC(t);if(i)switch(i.type){case oAe:this._onOpenedMessage(i);break;case NS:this._onResponseMessage(i);break;case CX:this._onAbortMessage(i);break;case sAe:this._onInvokeMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);s&&(s.controller&&s.controller.abort(),i.delete(r))}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs,l=$2e[i];let c;try{if(typeof l!="function")throw new TypeError(`${i} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:NS,jobId:r,error:I$(h)})}_c(c)?(a.set(r,{controller:o,promise:c}),c.then(h=>{a.has(r)&&(a.delete(r),this._post({type:NS,jobId:r},h))},h=>{a.has(r)&&(a.delete(r),h||(h={message:"Error encountered at method"+i}),vr(h)||this._post({type:NS,jobId:r,error:I$(h||{message:`Error encountered at method ${i}`})}))})):this._post({type:NS,jobId:r},c)}_onOpenedMessage(t){var i;const{jobId:r,data:s}=t,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),(i=n.abortHandle)==null||i.remove(),n.resolve(s))}_onResponseMessage(t){var i;const{jobId:r,error:s,data:n}=t,o=this._outJobs.get(r);o&&(this._outJobs.delete(r),(i=o.abortHandle)==null||i.remove(),s?o.reject(Q.fromJSON(JSON.parse(s))):o.resolve(n))}_post(t,i,r){return Oae(this.worker,t,i,r)}}let A_=ue("esri-workers-debug")?1:ue("host-browser")?navigator.hardwareConcurrency-1:0;A_||(A_=ue("safari")&&ue("mac")||ue("trident")?7:2);let RX=0;const N3=[];function aAe(){Dae()}async function $O(e,t){const i=new LEe;return await i.open(e,t),i}async function $ae(e,t={}){if(typeof e!="string")throw new Q("workers:undefined-module","modulePath is missing");let i=t.strategy||"distributed";if(ue("host-webworker")&&!ue("esri-workers")&&(i="local"),i==="local"){let r=await el.loadWorker(e);r||(r=await import(e)),Jt(t.signal);const s=t.client||r;return $O([el.connect(r)],me(I({},t),{client:s}))}if(await Dae(),Jt(t.signal),i==="dedicated"){const r=RX++%A_;return $O([await N3[r].open(e,t)],t)}if(t.maxNumWorkers&&t.maxNumWorkers>0){const r=Math.min(t.maxNumWorkers,A_);if(r<A_){const s=new Array(r);for(let n=0;n<r;++n){const o=RX++%A_;s[n]=N3[o].open(e,t)}return $O(s,t)}}return $O(N3.map(r=>r.open(e,t)),t)}let DO=null;async function Dae(){if(DO)return DO;new AbortController;const e=[];for(let t=0;t<A_;t++){const i=YG.create(t).then(r=>(N3[t]=r,r));e.push(i)}return DO=Promise.all(e),DO}let F3=class extends we{constructor(e){super(e),this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(t=>{e+=t.length}),e}add(e,t){if(!this._isHandle(e)&&!Array.isArray(e)&&!pt.isCollection(e))return this;const i=this._getOrCreateGroup(t);return Array.isArray(e)||pt.isCollection(e)?e.forEach(r=>this._isHandle(r)&&i.push(r)):i.push(e),this.notifyChange("size"),this}forEach(e,t){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&t&&i.forEach(t)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(Array.isArray(e)||pt.isCollection(e))return e.forEach(this.remove,this),this;if(!this.has(e))return this;const t=this._getGroup(e);for(let i=0;i<t.length;i++)t[i].remove();return this._deleteGroup(e),this.notifyChange("size"),this}removeAll(){return this._groups.forEach(e=>{for(let t=0;t<e.length;t++)e[t].remove()}),this._groups.clear(),this.notifyChange("size"),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const t=[];return this._groups.set(this._ensureGroupKey(e),t),t}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_deleteGroup(e){return this._groups.delete(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}};u([d({readOnly:!0})],F3.prototype,"size",null),F3=u([P("esri.core.Handles")],F3);const Bt=F3;let rp=class extends we{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new Bt,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(e,t,i={}){return this._installWatch(e,t,i,Nt)}addWhen(e,t,i={}){return this._installWatch(e,t,i,JL)}addOnCollectionChange(e,t,{initial:i=!1}={}){const r=++this.handleId;return this.handles.add([Tx(e,"after-changes",this._createSyncUpdatingCallback(),ph),Tx(e,"change",t,{onListenerAdd:i?s=>t({added:s.toArray(),removed:[]}):void 0})],r),{remove:()=>this.handles.remove(r)}}addPromise(e){if(O(e))return e;const t=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(this.pendingPromises.size!==0||this.handles.has(LO)||this._set("updating",!1))}},t),this.pendingPromises.add(e),this._set("updating",!0);const i=()=>this.handles.remove(t);return e.then(i,i),e}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}_installWatch(e,t,i={},r){const s=++this.handleId;i.sync||this._installSyncUpdatingWatch(e,s);const n=r(e,t,i);return this.handles.add(n,s),{remove:()=>this.handles.remove(s)}}_installSyncUpdatingWatch(e,t){const i=this._createSyncUpdatingCallback(),r=Nt(e,i,{sync:!0,equals:()=>!1});return this.handles.add(r,t),r}_createSyncUpdatingCallback(){return()=>{this.handles.remove(LO),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(vR(()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(LO))}),LO)}}};u([d({readOnly:!0})],rp.prototype,"updating",void 0),rp=u([P("esri.views.support.WatchUpdatingTracking")],rp);const LO=-42;var OX;(function(e){e[e.NONE=0]="NONE",e[e.SYNC=1]="SYNC",e[e.INIT=2]="INIT"})(OX||(OX={}));const Rm=e=>{let t=class extends e{destroy(){var i,r;this.destroyed||((i=this._get("handles"))==null||i.destroy(),(r=this._get("updatingHandles"))==null||r.destroy())}get handles(){return this._get("handles")||new Bt}get updatingHandles(){return this._get("updatingHandles")||new rp}};return u([d({readOnly:!0})],t.prototype,"handles",null),u([d({readOnly:!0})],t.prototype,"updatingHandles",null),t=u([P("esri.core.HandleOwner")],t),t};let aT=class extends Rm(we){};aT=u([P("esri.core.HandleOwner")],aT);he.getLogger("esri.core.support.OwningCollection");let dA=class extends Rm(pt){constructor(e){super(e),this.handles.add([this.on("before-add",t=>{O(t.item)&&t.preventDefault()}),this.on("after-add",t=>this._own(t.item)),this.on("after-remove",t=>this._release(t.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(pt.ofType(this.itemType.Type))(e):new pt(e)}};function V6(e,t){return{type:e,cast:Zoe,set(i){const r=h1(i,this._get(t),e);r.owner=this,this._set(t,r)}}}u([d()],dA.prototype,"owner",null),dA=u([P("esri.core.support.OwningCollection")],dA);function ZG(e){return new tt({wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${e.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`})}const Lae=ZG(ai),$$=ZG(ip),D$=ZG(hm),lAe=new tt({wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${ai.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`});function KL(e){return e&&(wp(e)||e===$$)?$$:e&&(xp(e)||e===D$)?D$:Lae}function di(e){return e&&(wp(e)||e===$$)?ip:e&&(xp(e)||e===D$)?hm:ai}function Dht(e){return tG(e)?ip:iG(e)?hm:ai}const Nae=39.37,cAe=ai.radius*Math.PI/200,Fae=/UNIT\[([^\]]+)\]\]$/i,V_=D,Uae=/UNIT\[([^\]]+)\]/i,uAe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),hAe=po()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),ed=e=>e*e,Wm=e=>e*e*e,cC={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:ed(.001)},"square-centimeters":{inBaseUnits:ed(.01)},"square-decimeters":{inBaseUnits:ed(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:ed(1e3)},"square-inches":{inBaseUnits:ed(.0254)},"square-feet":{inBaseUnits:ed(.3048)},"square-yards":{inBaseUnits:ed(.9144)},"square-miles":{inBaseUnits:ed(1609.344)},"square-us-feet":{inBaseUnits:ed(1200/3937)},acres:{inBaseUnits:.0015625*ed(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*Wm(.001)},"cubic-centimeters":{inBaseUnits:1e3*Wm(.01)},"cubic-decimeters":{inBaseUnits:1e3*Wm(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*Wm(1e3)},"cubic-inches":{inBaseUnits:1e3*Wm(.0254)},"cubic-feet":{inBaseUnits:1e3*Wm(.3048)},"cubic-yards":{inBaseUnits:1e3*Wm(.9144)},"cubic-miles":{inBaseUnits:1e3*Wm(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},dAe=function(){const e={};for(const t in cC)for(const i in cC[t].units)e[i]=t;return e}();function pAe(e,t,i){return e*cC[i].units[t].inBaseUnits}function fAe(e,t,i){return e/cC[i].units[t].inBaseUnits}function G6(e){const t=dAe[e];if(t)return t;throw new Error("unknown type")}function MX(e,t=null){return t=t||G6(e),cC[t].baseUnit===e}function gs(e,t,i){if(t===i)return e;const r=G6(t);if(r!==G6(i))throw new Error("incompatible units");const s=MX(t,r)?e:pAe(e,t,r);return MX(i,r)?s:fAe(s,i,r)}function mAe(e,t){return gs(e,t,"meters")<3e3?"meters":"kilometers"}function gAe(e,t){return gs(e,t,"meters")<1e5?"meters":"kilometers"}function yAe(e,t){return gs(e,t,"feet")<1e3?"feet":"miles"}function vAe(e,t){return gs(e,t,"feet")<1e5?"feet":"miles"}function Lht(e,t){return gs(e,t,"square-meters")<3e6?"square-meters":"square-kilometers"}function Nht(e,t){return gs(e,t,"square-feet")<1e6?"square-feet":"square-miles"}function _Ae(e,t,i){return gs(e,t,"meters")/(i*Math.PI/180)}function kae(e){return hAe.fromJSON(e.toLowerCase())||null}function lT(e){if(e&&typeof e=="object"&&!ZA(e))return 1;const t=bl(e);return t>1e5?1:t}function bAe(e){return bl(e)>=(e instanceof tt?di(e).metersPerDegree:1e5)?"meters":Bae(e)}function bl(e,t=ai.metersPerDegree){return wAe(e,!0)||t}function wAe(e,t=!1){let i,r,s=null;if(e!=null&&(typeof e=="object"?(i=e.wkid,r=e.wkt):typeof e=="number"?i=e:typeof e=="string"&&(r=e)),i){if(tG(i))return ip.metersPerDegree;if(iG(i))return hm.metersPerDegree;s=V_.values[V_[i]],!s&&t&&uAe.has(i)&&(s=cAe)}else r&&(Gae(r)?s=PX(Fae.exec(r),s):Vae(r)&&(s=PX(Uae.exec(r),s)));return s}function PX(e,t){return e&&e[1]?zae(e[1]):t}function zae(e){return parseFloat(e.split(",")[1])}function Bae(e){let t,i,r=null;if(e!=null&&(typeof e=="object"?(t=e.wkid,i=e.wkt):typeof e=="number"?t=e:typeof e=="string"&&(i=e)),t)r=V_.units[V_[t]];else if(i){const s=Gae(i)?Fae:Vae(i)?Uae:null;if(s){const n=s.exec(i);n&&n[1]&&(r=TAe(n[1]))}}return _(r)?kae(r):null}function Vae(e){return/^GEOCCS/i.test(e)}function Gae(e){return/^PROJCS/i.test(e)}const xAe=1e-7;function TAe(e){const t=/[\\"\\']{1}([^\\"\\']+)/.exec(e);let i=t&&t[1];if(!i||V_.units.indexOf(i)===-1){const r=zae(e);i=null;const s=V_.values;for(let n=0;n<s.length;++n)if(Math.abs(r-s[n])<xAe){i=V_.units[n];break}}return i}function Fht(e){if(!e)return null;switch(Bae(e)){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric";case null:case void 0:return null}return null}const jae={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},Hae={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},SAe=po()(jae),EAe=po()(Hae);po()(I(I({},jae),Hae));var hE;const L$=po()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),qae=L$.jsonValues.slice();xL(qae,"orthometric");const pA=po()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let Qu=hE=class extends ve{constructor(e){super(e),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(e,t,i){return L$.write(e,t,i)}readHeightModel(e,t,i){return L$.read(e)||(i&&i.messages&&i.messages.push(AAe(e,{context:i})),null)}readHeightUnit(e,t,i){return pA.read(e)||(i&&i.messages&&i.messages.push(IX(e,{context:i})),null)}readHeightUnitService(e,t,i){return kae(e)||pA.read(e)||(i&&i.messages&&i.messages.push(IX(e,{context:i})),null)}readVertCRS(e,t){return t.vertCRS||t.ellipsoid||t.geoid}clone(){return new hE({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(e){return!!e&&(this===e||this.heightModel===e.heightModel&&this.heightUnit===e.heightUnit&&this.vertCRS===e.vertCRS)}static deriveUnitFromSR(e,t){const i=bAe(t);return new hE({heightModel:e.heightModel,heightUnit:i,vertCRS:e.vertCRS})}write(e,t){return t=I({origin:"web-scene"},t),super.write(e,t)}static fromJSON(e){if(!e)return null;const t=new hE;return t.read(e,{origin:"web-scene"}),t}};function IX(e,t){return new uc("height-unit:unsupported",`Height unit of value '${e}' is not supported`,t)}function AAe(e,t){return new uc("height-model:unsupported",`Height model of value '${e}' is not supported`,t)}u([d({type:L$.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:qae,default:"ellipsoidal"}}}})],Qu.prototype,"heightModel",void 0),u([Ge("web-scene","heightModel")],Qu.prototype,"writeHeightModel",null),u([Fe(["web-scene","service"],"heightModel")],Qu.prototype,"readHeightModel",null),u([d({type:pA.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:pA.jsonValues,write:pA.write}}}})],Qu.prototype,"heightUnit",void 0),u([Fe("web-scene","heightUnit")],Qu.prototype,"readHeightUnit",null),u([Fe("service","heightUnit")],Qu.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],Qu.prototype,"vertCRS",void 0),u([Fe("service","vertCRS",["vertCRS","ellipsoid","geoid"])],Qu.prototype,"readVertCRS",null),Qu=hE=u([P("esri.geometry.HeightModelInfo")],Qu);const lS=Qu;function Lr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ep(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e[9]=h,e[10]=p,e[11]=f,e[12]=g,e[13]=y,e[14]=v,e[15]=b,e}function pp(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ea(e,t){if(e===t){const i=t[1],r=t[2],s=t[3],n=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=s,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function hr(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15],S=i*a-r*o,T=i*l-s*o,A=i*c-n*o,C=r*l-s*a,R=r*c-n*a,L=s*c-n*l,U=h*v-p*y,N=h*b-f*y,z=h*w-g*y,V=p*b-f*v,B=p*w-g*v,J=f*w-g*b;let Z=S*J-T*B+A*V+C*z-R*N+L*U;return Z?(Z=1/Z,e[0]=(a*J-l*B+c*V)*Z,e[1]=(s*B-r*J-n*V)*Z,e[2]=(v*L-b*R+w*C)*Z,e[3]=(f*R-p*L-g*C)*Z,e[4]=(l*z-o*J-c*N)*Z,e[5]=(i*J-s*z+n*N)*Z,e[6]=(b*A-y*L-w*T)*Z,e[7]=(h*L-f*A+g*T)*Z,e[8]=(o*B-a*z+c*U)*Z,e[9]=(r*z-i*B-n*U)*Z,e[10]=(y*R-v*A+w*S)*Z,e[11]=(p*A-h*R-g*S)*Z,e[12]=(a*N-o*V-l*U)*Z,e[13]=(i*V-r*N+s*U)*Z,e[14]=(v*T-y*C-b*S)*Z,e[15]=(h*C-p*T+f*S)*Z,e):null}function CAe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15];return e[0]=a*(f*w-g*b)-p*(l*w-c*b)+v*(l*g-c*f),e[1]=-(r*(f*w-g*b)-p*(s*w-n*b)+v*(s*g-n*f)),e[2]=r*(l*w-c*b)-a*(s*w-n*b)+v*(s*c-n*l),e[3]=-(r*(l*g-c*f)-a*(s*g-n*f)+p*(s*c-n*l)),e[4]=-(o*(f*w-g*b)-h*(l*w-c*b)+y*(l*g-c*f)),e[5]=i*(f*w-g*b)-h*(s*w-n*b)+y*(s*g-n*f),e[6]=-(i*(l*w-c*b)-o*(s*w-n*b)+y*(s*c-n*l)),e[7]=i*(l*g-c*f)-o*(s*g-n*f)+h*(s*c-n*l),e[8]=o*(p*w-g*v)-h*(a*w-c*v)+y*(a*g-c*p),e[9]=-(i*(p*w-g*v)-h*(r*w-n*v)+y*(r*g-n*p)),e[10]=i*(a*w-c*v)-o*(r*w-n*v)+y*(r*c-n*a),e[11]=-(i*(a*g-c*p)-o*(r*g-n*p)+h*(r*c-n*a)),e[12]=-(o*(p*b-f*v)-h*(a*b-l*v)+y*(a*f-l*p)),e[13]=i*(p*b-f*v)-h*(r*b-s*v)+y*(r*f-s*p),e[14]=-(i*(a*b-l*v)-o*(r*b-s*v)+y*(r*l-s*a)),e[15]=i*(a*f-l*p)-o*(r*f-s*p)+h*(r*l-s*a),e}function RAe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11],g=e[12],y=e[13],v=e[14],b=e[15];return(t*o-i*n)*(p*b-f*v)-(t*a-r*n)*(h*b-f*y)+(t*l-s*n)*(h*v-p*y)+(i*a-r*o)*(c*b-f*g)-(i*l-s*o)*(c*v-p*g)+(r*l-s*a)*(c*y-h*g)}function ur(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=t[9],g=t[10],y=t[11],v=t[12],b=t[13],w=t[14],S=t[15];let T=i[0],A=i[1],C=i[2],R=i[3];return e[0]=T*r+A*a+C*p+R*v,e[1]=T*s+A*l+C*f+R*b,e[2]=T*n+A*c+C*g+R*w,e[3]=T*o+A*h+C*y+R*S,T=i[4],A=i[5],C=i[6],R=i[7],e[4]=T*r+A*a+C*p+R*v,e[5]=T*s+A*l+C*f+R*b,e[6]=T*n+A*c+C*g+R*w,e[7]=T*o+A*h+C*y+R*S,T=i[8],A=i[9],C=i[10],R=i[11],e[8]=T*r+A*a+C*p+R*v,e[9]=T*s+A*l+C*f+R*b,e[10]=T*n+A*c+C*g+R*w,e[11]=T*o+A*h+C*y+R*S,T=i[12],A=i[13],C=i[14],R=i[15],e[12]=T*r+A*a+C*p+R*v,e[13]=T*s+A*l+C*f+R*b,e[14]=T*n+A*c+C*g+R*w,e[15]=T*o+A*h+C*y+R*S,e}function Vo(e,t,i){const r=i[0],s=i[1],n=i[2];let o,a,l,c,h,p,f,g,y,v,b,w;return t===e?(e[12]=t[0]*r+t[4]*s+t[8]*n+t[12],e[13]=t[1]*r+t[5]*s+t[9]*n+t[13],e[14]=t[2]*r+t[6]*s+t[10]*n+t[14],e[15]=t[3]*r+t[7]*s+t[11]*n+t[15]):(o=t[0],a=t[1],l=t[2],c=t[3],h=t[4],p=t[5],f=t[6],g=t[7],y=t[8],v=t[9],b=t[10],w=t[11],e[0]=o,e[1]=a,e[2]=l,e[3]=c,e[4]=h,e[5]=p,e[6]=f,e[7]=g,e[8]=y,e[9]=v,e[10]=b,e[11]=w,e[12]=o*r+h*s+y*n+t[12],e[13]=a*r+p*s+v*n+t[13],e[14]=l*r+f*s+b*n+t[14],e[15]=c*r+g*s+w*n+t[15]),e}function eN(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function nl(e,t,i,r){let s,n,o,a,l,c,h,p,f,g,y,v,b,w,S,T,A,C,R,L,U,N,z,V,B=r[0],J=r[1],Z=r[2],te=Math.sqrt(B*B+J*J+Z*Z);return te<wt?null:(te=1/te,B*=te,J*=te,Z*=te,s=Math.sin(i),n=Math.cos(i),o=1-n,a=t[0],l=t[1],c=t[2],h=t[3],p=t[4],f=t[5],g=t[6],y=t[7],v=t[8],b=t[9],w=t[10],S=t[11],T=B*B*o+n,A=J*B*o+Z*s,C=Z*B*o-J*s,R=B*J*o-Z*s,L=J*J*o+n,U=Z*J*o+B*s,N=B*Z*o+J*s,z=J*Z*o-B*s,V=Z*Z*o+n,e[0]=a*T+p*A+v*C,e[1]=l*T+f*A+b*C,e[2]=c*T+g*A+w*C,e[3]=h*T+y*A+S*C,e[4]=a*R+p*L+v*U,e[5]=l*R+f*L+b*U,e[6]=c*R+g*L+w*U,e[7]=h*R+y*L+S*U,e[8]=a*N+p*z+v*V,e[9]=l*N+f*z+b*V,e[10]=c*N+g*z+w*V,e[11]=h*N+y*z+S*V,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function cT(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+c*r,e[5]=o*s+h*r,e[6]=a*s+p*r,e[7]=l*s+f*r,e[8]=c*s-n*r,e[9]=h*s-o*r,e[10]=p*s-a*r,e[11]=f*s-l*r,e}function tN(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-c*r,e[1]=o*s-h*r,e[2]=a*s-p*r,e[3]=l*s-f*r,e[8]=n*r+c*s,e[9]=o*r+h*s,e[10]=a*r+p*s,e[11]=l*r+f*s,e}function uT(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[4],h=t[5],p=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s+c*r,e[1]=o*s+h*r,e[2]=a*s+p*r,e[3]=l*s+f*r,e[4]=c*s-n*r,e[5]=h*s-o*r,e[6]=p*s-a*r,e[7]=f*s-l*r,e}function iN(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function OAe(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function yl(e,t,i){let r,s,n,o=i[0],a=i[1],l=i[2],c=Math.sqrt(o*o+a*a+l*l);return c<wt?null:(c=1/c,o*=c,a*=c,l*=c,r=Math.sin(t),s=Math.cos(t),n=1-s,e[0]=o*o*n+s,e[1]=a*o*n+l*r,e[2]=l*o*n-a*r,e[3]=0,e[4]=o*a*n-l*r,e[5]=a*a*n+s,e[6]=l*a*n+o*r,e[7]=0,e[8]=o*l*n+a*r,e[9]=a*l*n-o*r,e[10]=l*l*n+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function Wae(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function MAe(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Xae(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Yae(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=r+r,l=s+s,c=n+n,h=r*a,p=r*l,f=r*c,g=s*l,y=s*c,v=n*c,b=o*a,w=o*l,S=o*c;return e[0]=1-(g+v),e[1]=p+S,e[2]=f-w,e[3]=0,e[4]=p-S,e[5]=1-(h+v),e[6]=y+b,e[7]=0,e[8]=f+w,e[9]=y-b,e[10]=1-(h+g),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function PAe(e,t){const i=IAe,r=-t[0],s=-t[1],n=-t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=r*r+s*s+n*n+o*o;return p>0?(i[0]=2*(a*o+h*r+l*n-c*s)/p,i[1]=2*(l*o+h*s+c*r-a*n)/p,i[2]=2*(c*o+h*n+a*s-l*r)/p):(i[0]=2*(a*o+h*r+l*n-c*s),i[1]=2*(l*o+h*s+c*r-a*n),i[2]=2*(c*o+h*n+a*s-l*r)),Yae(e,t,i),e}const IAe=M();function $Ae(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function DAe(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return e[0]=Math.sqrt(i*i+r*r+s*s),e[1]=Math.sqrt(n*n+o*o+a*a),e[2]=Math.sqrt(l*l+c*c+h*h),e}function LAe(e,t){const i=t[0]+t[5]+t[10];let r=0;return i>0?(r=2*Math.sqrt(i+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r),e}function NAe(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,g=s*h,y=n*c,v=n*h,b=o*h,w=a*l,S=a*c,T=a*h,A=r[0],C=r[1],R=r[2];return e[0]=(1-(y+b))*A,e[1]=(f+T)*A,e[2]=(g-S)*A,e[3]=0,e[4]=(f-T)*C,e[5]=(1-(p+b))*C,e[6]=(v+w)*C,e[7]=0,e[8]=(g+S)*R,e[9]=(v-w)*R,e[10]=(1-(p+y))*R,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function FAe(e,t,i,r,s){const n=t[0],o=t[1],a=t[2],l=t[3],c=n+n,h=o+o,p=a+a,f=n*c,g=n*h,y=n*p,v=o*h,b=o*p,w=a*p,S=l*c,T=l*h,A=l*p,C=r[0],R=r[1],L=r[2],U=s[0],N=s[1],z=s[2],V=(1-(v+w))*C,B=(g+A)*C,J=(y-T)*C,Z=(g-A)*R,te=(1-(f+w))*R,ie=(b+S)*R,$=(y+T)*L,F=(b-S)*L,k=(1-(f+v))*L;return e[0]=V,e[1]=B,e[2]=J,e[3]=0,e[4]=Z,e[5]=te,e[6]=ie,e[7]=0,e[8]=$,e[9]=F,e[10]=k,e[11]=0,e[12]=i[0]+U-(V*U+Z*N+$*z),e[13]=i[1]+N-(B*U+te*N+F*z),e[14]=i[2]+z-(J*U+ie*N+k*z),e[15]=1,e}function UAe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return e[0]=1-p-y,e[1]=h+w,e[2]=f-b,e[3]=0,e[4]=h-w,e[5]=1-c-y,e[6]=g+v,e[7]=0,e[8]=f+b,e[9]=g-v,e[10]=1-c-p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Zae(e,t,i,r,s,n,o){const a=1/(i-t),l=1/(s-r),c=1/(n-o);return e[0]=2*n*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(s+r)*l,e[10]=(o+n)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*n*2*c,e[15]=0,e}function kAe(e,t,i,r,s){const n=1/Math.tan(t/2);let o;return e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,s!=null&&s!==1/0?(o=1/(r-s),e[10]=(s+r)*o,e[14]=2*s*r*o):(e[10]=-1,e[14]=-2*r),e}function zAe(e,t,i,r){const s=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(o-a)*l*.5,e[9]=(s-n)*c*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function QG(e,t,i,r,s,n,o){const a=1/(t-i),l=1/(r-s),c=1/(n-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(s+r)*l,e[14]=(o+n)*c,e[15]=1,e}function rN(e,t,i,r){let s,n,o,a,l,c,h,p,f,g;const y=t[0],v=t[1],b=t[2],w=r[0],S=r[1],T=r[2],A=i[0],C=i[1],R=i[2];return Math.abs(y-A)<wt&&Math.abs(v-C)<wt&&Math.abs(b-R)<wt?pp(e):(h=y-A,p=v-C,f=b-R,g=1/Math.sqrt(h*h+p*p+f*f),h*=g,p*=g,f*=g,s=S*f-T*p,n=T*h-w*f,o=w*p-S*h,g=Math.sqrt(s*s+n*n+o*o),g?(g=1/g,s*=g,n*=g,o*=g):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,g=Math.sqrt(a*a+l*l+c*c),g?(g=1/g,a*=g,l*=g,c*=g):(a=0,l=0,c=0),e[0]=s,e[1]=a,e[2]=h,e[3]=0,e[4]=n,e[5]=l,e[6]=p,e[7]=0,e[8]=o,e[9]=c,e[10]=f,e[11]=0,e[12]=-(s*y+n*v+o*b),e[13]=-(a*y+l*v+c*b),e[14]=-(h*y+p*v+f*b),e[15]=1,e)}function Qae(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=r[0],l=r[1],c=r[2];let h=s-i[0],p=n-i[1],f=o-i[2],g=h*h+p*p+f*f;g>0&&(g=1/Math.sqrt(g),h*=g,p*=g,f*=g);let y=l*f-c*p,v=c*h-a*f,b=a*p-l*h;return g=y*y+v*v+b*b,g>0&&(g=1/Math.sqrt(g),y*=g,v*=g,b*=g),e[0]=y,e[1]=v,e[2]=b,e[3]=0,e[4]=p*b-f*v,e[5]=f*y-h*b,e[6]=h*v-p*y,e[7]=0,e[8]=h,e[9]=p,e[10]=f,e[11]=0,e[12]=s,e[13]=n,e[14]=o,e[15]=1,e}function BAe(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function VAe(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2+e[9]**2+e[10]**2+e[11]**2+e[12]**2+e[13]**2+e[14]**2+e[15]**2)}function GAe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e}function Jae(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}function jAe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e}function HAe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e[9]=t[9]+i[9]*r,e[10]=t[10]+i[10]*r,e[11]=t[11]+i[11]*r,e[12]=t[12]+i[12]*r,e[13]=t[13]+i[13]*r,e[14]=t[14]+i[14]*r,e[15]=t[15]+i[15]*r,e}function qAe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function j6(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],g=e[11],y=e[12],v=e[13],b=e[14],w=e[15],S=t[0],T=t[1],A=t[2],C=t[3],R=t[4],L=t[5],U=t[6],N=t[7],z=t[8],V=t[9],B=t[10],J=t[11],Z=t[12],te=t[13],ie=t[14],$=t[15];return Math.abs(i-S)<=wt*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(r-T)<=wt*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(s-A)<=wt*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(n-C)<=wt*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(o-R)<=wt*Math.max(1,Math.abs(o),Math.abs(R))&&Math.abs(a-L)<=wt*Math.max(1,Math.abs(a),Math.abs(L))&&Math.abs(l-U)<=wt*Math.max(1,Math.abs(l),Math.abs(U))&&Math.abs(c-N)<=wt*Math.max(1,Math.abs(c),Math.abs(N))&&Math.abs(h-z)<=wt*Math.max(1,Math.abs(h),Math.abs(z))&&Math.abs(p-V)<=wt*Math.max(1,Math.abs(p),Math.abs(V))&&Math.abs(f-B)<=wt*Math.max(1,Math.abs(f),Math.abs(B))&&Math.abs(g-J)<=wt*Math.max(1,Math.abs(g),Math.abs(J))&&Math.abs(y-Z)<=wt*Math.max(1,Math.abs(y),Math.abs(Z))&&Math.abs(v-te)<=wt*Math.max(1,Math.abs(v),Math.abs(te))&&Math.abs(b-ie)<=wt*Math.max(1,Math.abs(b),Math.abs(ie))&&Math.abs(w-$)<=wt*Math.max(1,Math.abs(w),Math.abs($))}function JG(e){const t=wt,i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const WAe=ur,XAe=Jae;Object.freeze({__proto__:null,copy:Lr,set:Ep,identity:pp,transpose:Ea,invert:hr,adjoint:CAe,determinant:RAe,multiply:ur,translate:Vo,scale:eN,rotate:nl,rotateX:cT,rotateY:tN,rotateZ:uT,fromTranslation:iN,fromScaling:OAe,fromRotation:yl,fromXRotation:Wae,fromYRotation:MAe,fromZRotation:Xae,fromRotationTranslation:Yae,fromQuat2:PAe,getTranslation:$Ae,getScaling:DAe,getRotation:LAe,fromRotationTranslationScale:NAe,fromRotationTranslationScaleOrigin:FAe,fromQuat:UAe,frustum:Zae,perspective:kAe,perspectiveFromFieldOfView:zAe,ortho:QG,lookAt:rN,targetTo:Qae,str:BAe,frob:VAe,add:GAe,subtract:Jae,multiplyScalar:jAe,multiplyScalarAndAdd:HAe,exactEquals:qAe,equals:j6,isOrthoNormal:JG,mul:WAe,sub:XAe});let O4,re=null;function Kae(){return!!re}function YAe(){return!!ue("esri-wasm")}function ele(){return O4||(O4=import("./pe-wasm.1d1b20e7.js").then(e=>e.p).then(({default:e})=>e({locateFile:t=>ui(`esri/geometry/support/${t}`)})).then(e=>{ile(e)}),O4)}var H6,Ir,q6;(function(e){function t(n,o,a){re.ensureCache.prepare();const l=d_(a),c=a===l,h=re.ensureFloat64(l),p=re._pe_geog_to_proj(re.getPointer(n),o,h);return p&&fy(a,o,h,c),p}function i(n,o,a,l){switch(l){case Ir.PE_TRANSFORM_P_TO_G:return r(n,o,a);case Ir.PE_TRANSFORM_G_TO_P:return t(n,o,a)}return 0}function r(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){re.ensureCache.prepare();const c=d_(a),h=a===c,p=re.ensureFloat64(c),f=re._pe_proj_to_geog_center(re.getPointer(n),o,p,l);return f&&fy(a,o,p,h),f}e.geogToProj=t,e.projGeog=i,e.projToGeog=r,e.projToGeogCenter=s})(H6||(H6={})),function(e){function t(){e.PE_BUFFER_MAX=re.PeDefs.prototype.PE_BUFFER_MAX,e.PE_NAME_MAX=re.PeDefs.prototype.PE_NAME_MAX,e.PE_MGRS_MAX=re.PeDefs.prototype.PE_MGRS_MAX,e.PE_USNG_MAX=re.PeDefs.prototype.PE_USNG_MAX,e.PE_DD_MAX=re.PeDefs.prototype.PE_DD_MAX,e.PE_DDM_MAX=re.PeDefs.prototype.PE_DDM_MAX,e.PE_DMS_MAX=re.PeDefs.prototype.PE_DMS_MAX,e.PE_UTM_MAX=re.PeDefs.prototype.PE_UTM_MAX,e.PE_PARM_MAX=re.PeDefs.prototype.PE_PARM_MAX,e.PE_TYPE_NONE=re.PeDefs.prototype.PE_TYPE_NONE,e.PE_TYPE_GEOGCS=re.PeDefs.prototype.PE_TYPE_GEOGCS,e.PE_TYPE_PROJCS=re.PeDefs.prototype.PE_TYPE_PROJCS,e.PE_TYPE_GEOGTRAN=re.PeDefs.prototype.PE_TYPE_GEOGTRAN,e.PE_TYPE_COORDSYS=re.PeDefs.prototype.PE_TYPE_COORDSYS,e.PE_TYPE_UNIT=re.PeDefs.prototype.PE_TYPE_UNIT,e.PE_TYPE_LINUNIT=re.PeDefs.prototype.PE_TYPE_LINUNIT,e.PE_STR_OPTS_NONE=re.PeDefs.prototype.PE_STR_OPTS_NONE,e.PE_STR_AUTH_NONE=re.PeDefs.prototype.PE_STR_AUTH_NONE,e.PE_STR_AUTH_TOP=re.PeDefs.prototype.PE_STR_AUTH_TOP,e.PE_STR_NAME_CANON=re.PeDefs.prototype.PE_STR_NAME_CANON,e.PE_PARM_X0=re.PeDefs.prototype.PE_PARM_X0,e.PE_PARM_ND=re.PeDefs.prototype.PE_PARM_ND,e.PE_TRANSFORM_1_TO_2=re.PeDefs.prototype.PE_TRANSFORM_1_TO_2,e.PE_TRANSFORM_2_TO_1=re.PeDefs.prototype.PE_TRANSFORM_2_TO_1,e.PE_TRANSFORM_P_TO_G=re.PeDefs.prototype.PE_TRANSFORM_P_TO_G,e.PE_TRANSFORM_G_TO_P=re.PeDefs.prototype.PE_TRANSFORM_G_TO_P,e.PE_HORIZON_RECT=re.PeDefs.prototype.PE_HORIZON_RECT,e.PE_HORIZON_POLY=re.PeDefs.prototype.PE_HORIZON_POLY,e.PE_HORIZON_LINE=re.PeDefs.prototype.PE_HORIZON_LINE,e.PE_HORIZON_DELTA=re.PeDefs.prototype.PE_HORIZON_DELTA}e.init=t}(Ir||(Ir={})),function(e){const t={},i={},r=g=>{if(g){const y=g.getType();switch(y){case Ir.PE_TYPE_GEOGCS:g=re.castObject(g,re.PeGeogcs);break;case Ir.PE_TYPE_PROJCS:g=re.castObject(g,re.PeProjcs);break;case Ir.PE_TYPE_GEOGTRAN:g=re.castObject(g,re.PeGeogtran);break;default:y&Ir.PE_TYPE_UNIT&&(g=re.castObject(g,re.PeUnit))}}return g};function s(){re.PeFactory.prototype.initialize(null)}function n(g){return o(Ir.PE_TYPE_COORDSYS,g)}function o(g,y){let v=null,b=t[g];if(b||(b={},t[g]=b),b.hasOwnProperty(String(y)))v=b[y];else{const w=re.PeFactory.prototype.factoryByType(g,y);re.compare(w,re.NULL)||(v=w,b[y]=v)}return v=r(v),v}function a(g,y){let v=null,b=i[g];if(b||(b={},i[g]=b),b.hasOwnProperty(y))v=b[y];else{const w=re.PeFactory.prototype.fromString(g,y);re.compare(w,re.NULL)||(v=w,b[y]=v)}return v=r(v),v}function l(g){return o(Ir.PE_TYPE_GEOGCS,g)}function c(g){return o(Ir.PE_TYPE_GEOGTRAN,g)}function h(g){return re.PeFactory.prototype.getCode(g)}function p(g){return o(Ir.PE_TYPE_PROJCS,g)}function f(g){return o(Ir.PE_TYPE_UNIT,g)}e.initialize=s,e.coordsys=n,e.factoryByType=o,e.fromString=a,e.geogcs=l,e.geogtran=c,e.getCode=h,e.projcs=p,e.unit=f}(q6||(q6={}));let tle=null;var N$,W6,X6,Y6,F$,Z6,U$,k$,Q6;function ile(e){function t(n,o,a){n[o]=a(n[o])}re=e,Ir.init(),N$.init(),F$.init(),U$.init(),k$.init(),tle=class extends re.PeGCSExtent{destroy(){re.destroy(this)}};const i=[re.PeDatum,re.PeGeogcs,re.PeGeogtran,re.PeObject,re.PeParameter,re.PePrimem,re.PeProjcs,re.PeSpheroid,re.PeUnit];for(const n of i)t(n.prototype,"getName",o=>function(){return o.call(this,new Array(Ir.PE_NAME_MAX))});for(const n of[re.PeGeogtran,re.PeProjcs])t(n.prototype,"getParameters",o=>function(){const a=new Array(Ir.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=re.getValue(l,"*");a[c]=h?re.wrapPointer(h,re.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});t(re.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return fy(a,o,n.call(this)),a}),t(re.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=re._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+o*p,re.PeGTlistExtendedGTs))}}return a}});const r=re._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=l.getNump();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+r*p,re.PeHorizon))}}return o.set(n,a),a};t(re.PeProjcs.prototype,"horizonGcsGenerate",s),t(re.PeProjcs.prototype,"horizonPcsGenerate",s),re.PeObject.prototype.toString=function(n=Ir.PE_STR_OPTS_NONE){re.ensureCache.prepare();const o=re.getPointer(this),a=re.ensureInt8(new Array(Ir.PE_BUFFER_MAX));return re.UTF8ToString(re._pe_object_to_string_ext(o,n,a))}}function Lp(e){if(!e)return;const t=re.getClass(e);if(!t)return;const i=re.getCache(t);if(!i)return;const r=re.getPointer(e);r&&delete i[r]}function NO(e,t){const i=[],r=new Array(t);for(let s=0;s<e;s++)i.push(re.ensureInt8(r));return i}function d_(e){let t;return Array.isArray(e[0])?(t=[],e.forEach(i=>{t.push(i[0],i[1])})):t=e,t}function fy(e,t,i,r=!1){if(r)for(let s=0;s<2*t;s++)e[s]=re.getValue(i+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=e.length===0;for(let n=0;n<t;n++)s&&(e[n]=new Array(2)),e[n][0]=re.getValue(i,"double"),e[n][1]=re.getValue(i+Float64Array.BYTES_PER_ELEMENT,"double"),i+=2*Float64Array.BYTES_PER_ELEMENT}}(function(e){let t;function i(){e.PE_GTLIST_OPTS_COMMON=re.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,t=re._pe_getPeGTlistExtendedEntrySize()}function r(s,n,o,a,l,c){let h=null;const p=new re.PeInteger(c);try{const f=re.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const g=re.getPointer(f);for(let y=1;y<c;y++)h.push(re.wrapPointer(g+t*y,re.PeGTlistExtendedEntry))}}finally{re.destroy(p)}return h}e.init=i,e.getGTlist=r})(N$||(N$={})),function(e){function t(i){if(i&&i.length){for(const r of i)Lp(r),r.getEntries().forEach(s=>{Lp(s);const n=s.getGeogtran();Lp(n),n.getParameters().forEach(Lp),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{Lp(o);const a=o.getDatum();Lp(a),Lp(a.getSpheroid()),Lp(o.getPrimem()),Lp(o.getUnit())})});re.PeGTlistExtendedEntry.prototype.Delete(i[0])}}e.destroy=t}(W6||(W6={})),function(e){function t(i,r,s,n,o){re.ensureCache.prepare();const a=d_(s),l=s===a,c=re.ensureFloat64(a);let h=0;n&&(h=re.ensureFloat64(n));const p=re._pe_geog_to_geog(re.getPointer(i),r,c,h,o);return p&&fy(s,r,c,l),p}e.geogToGeog=t}(X6||(X6={})),function(e){const t=(c,h,p,f,g,y)=>{let v,b;switch(re.ensureCache.prepare(),c){case"dd":v=re._pe_geog_to_dd,b=Ir.PE_DD_MAX;break;case"ddm":v=re._pe_geog_to_ddm,b=Ir.PE_DDM_MAX;break;case"dms":v=re._pe_geog_to_dms,b=Ir.PE_DMS_MAX}let w=0;h&&(w=re.getPointer(h));const S=d_(f),T=re.ensureFloat64(S),A=NO(p,b),C=v(w,p,T,g,re.ensureInt32(A));if(C)for(let R=0;R<p;R++)y[R]=re.UTF8ToString(A[R]);return C},i=(c,h,p,f,g)=>{let y;switch(re.ensureCache.prepare(),c){case"dd":y=re._pe_dd_to_geog;break;case"ddm":y=re._pe_ddm_to_geog;break;case"dms":y=re._pe_dms_to_geog}let v=0;h&&(v=re.getPointer(h));const b=f.map(A=>re.ensureString(A)),w=re.ensureInt32(b),S=re.ensureFloat64(new Array(2*p)),T=y(v,p,w,S);return T&&fy(g,p,S),T};function r(c,h,p,f,g){return t("dms",c,h,p,f,g)}function s(c,h,p,f){return i("dms",c,h,p,f)}function n(c,h,p,f,g){return t("ddm",c,h,p,f,g)}function o(c,h,p,f){return i("ddm",c,h,p,f)}function a(c,h,p,f,g){return t("dd",c,h,p,f,g)}function l(c,h,p,f){return i("dd",c,h,p,f)}e.geogToDms=r,e.dmsToGeog=s,e.geogToDdm=n,e.ddmToGeog=o,e.geogToDd=a,e.ddToGeog=l}(Y6||(Y6={})),function(e){function t(){e.PE_MGRS_STYLE_NEW=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,e.PE_MGRS_STYLE_OLD=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,e.PE_MGRS_STYLE_AUTO=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,e.PE_MGRS_180_ZONE_1_PLUS=re.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,e.PE_MGRS_ADD_SPACES=re.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function i(s,n,o,a,l,c,h){re.ensureCache.prepare();let p=0;s&&(p=re.getPointer(s));const f=d_(o),g=re.ensureFloat64(f),y=NO(n,Ir.PE_MGRS_MAX),v=re.ensureInt32(y),b=re._pe_geog_to_mgrs_extended(p,n,g,a,l,c,v);if(b)for(let w=0;w<n;w++)h[w]=re.UTF8ToString(y[w]);return b}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),g=re._pe_mgrs_to_geog_extended(c,n,p,a,f);return g&&fy(l,n,f),g}e.init=t,e.geogToMgrsExtended=i,e.mgrsToGeogExtended=r}(F$||(F$={})),function(e){function t(r,s,n,o,a,l,c){re.ensureCache.prepare();let h=0;r&&(h=re.getPointer(r));const p=d_(n),f=re.ensureFloat64(p),g=NO(s,Ir.PE_MGRS_MAX),y=re.ensureInt32(g),v=re._pe_geog_to_usng(h,s,f,o,a,l,y);if(v)for(let b=0;b<s;b++)c[b]=re.UTF8ToString(g[b]);return v}function i(r,s,n,o){re.ensureCache.prepare();let a=0;r&&(a=re.getPointer(r));const l=n.map(f=>re.ensureString(f)),c=re.ensureInt32(l),h=re.ensureFloat64(new Array(2*s)),p=re._pe_usng_to_geog(a,s,c,h);return p&&fy(o,s,h),p}e.geogToUsng=t,e.usngToGeog=i}(Z6||(Z6={})),function(e){function t(){e.PE_UTM_OPTS_NONE=re.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,e.PE_UTM_OPTS_ADD_SPACES=re.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,e.PE_UTM_OPTS_NS=re.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function i(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=d_(o),p=re.ensureFloat64(h),f=NO(n,Ir.PE_UTM_MAX),g=re.ensureInt32(f),y=re._pe_geog_to_utm(c,n,p,a,g);if(y)for(let v=0;v<n;v++)l[v]=re.UTF8ToString(f[v]);return y}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),g=re._pe_utm_to_geog(c,n,p,a,f);return g&&fy(l,n,f),g}e.init=t,e.geogToUtm=i,e.utmToGeog=r}(U$||(U$={})),function(e){const t=new Map;function i(){e.PE_PCSINFO_OPTION_NONE=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,e.PE_PCSINFO_OPTION_DOMAIN=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,e.PE_POLE_OUTSIDE_BOUNDARY=re.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,e.PE_POLE_POINT=re.PePCSInfo.prototype.PE_POLE_POINT}function r(s,n=e.PE_PCSINFO_OPTION_DOMAIN){let o,a;return t.has(s)&&(a=t.get(s),a[n]&&(o=a[n])),o||(o=re.PePCSInfo.prototype.generate(s,n),a||(a=[],t.set(s,a)),a[n]=o),o}e.init=i,e.generate=r}(k$||(k$={})),function(e){function t(){return re.PeVersion.prototype.version_string()}e.versionString=t}(Q6||(Q6={}));const ZAe=Object.freeze({__proto__:null,get _pe(){return re},isLoaded:Kae,isSupported:YAe,load:ele,get PeCSTransformations(){return H6},get PeDefs(){return Ir},get PeFactory(){return q6},get PeGCSExtent(){return tle},get PeGTlistExtended(){return N$},get PeGTlistExtendedEntry(){return W6},get PeGTTransformations(){return X6},get PeNotationDms(){return Y6},get PeNotationMgrs(){return F$},get PeNotationUsng(){return Z6},get PeNotationUtm(){return U$},get PePCSInfo(){return k$},get PeVersion(){return Q6},_init:ile}),Uht=Math.PI/180,kht=/SPHEROID\[([^\]]+)]/i,Xm=ai.radius,Fu=ai.eccentricitySquared,QAe={a1:Xm*Fu,a2:Xm*Fu*Xm*Fu,a3:Xm*Fu*Fu/2,a4:Xm*Fu*Xm*Fu*2.5,a5:Xm*Fu+Xm*Fu*Fu/2,a6:1-Fu},zht={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:ai.radius,f:ai.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:hm.radius,f:hm.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:ip.radius,f:ip.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:ip.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let FO=0;class Ex{constructor(t=null){this.uid=FO++,t?(this._wkt=t.wkt!==void 0?t.wkt:null,this._wkid=t.wkid!==void 0?t.wkid:-1,this._isInverse=t.isInverse!==void 0&&t.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}static fromGE(t){const i=new Ex;return i._wkt=t.wkt,i._wkid=t.wkid,i._isInverse=t.isInverse,i}get wkt(){return this._wkt}set wkt(t){this._wkt=t,this.uid=FO++}get wkid(){return this._wkid}set wkid(t){this._wkid=t,this.uid=FO++}get isInverse(){return this._isInverse}set isInverse(t){this._isInverse=t,this.uid=FO++}getInverse(){const t=new Ex;return t._wkt=this.wkt,t._wkid=this._wkid,t._isInverse=!this.isInverse,t}}class Ey{constructor(t){if(this.steps=[],this._cached_projection={},this._chain="",this._gtlistentry=null,t&&t.steps)for(const i of t.steps)i instanceof Ex?this.steps.push(i):this.steps.push(new Ex({wkid:i.wkid,wkt:i.wkt,isInverse:i.isInverse}))}static cacheKey(t,i){return[t.wkid!==void 0&&t.wkid!==null?t.wkid.toString():"-1",t.wkt!==void 0&&t.wkt!==null?t.wkt.toString():"",i.wkid!==void 0&&i.wkid!==null?i.wkid.toString():"-1",i.wkt!==void 0&&i.wkt!==null?i.wkt.toString():""].join(",")}static fromGE(t){const i=new Ey;let r="";for(const s of t.steps){const n=Ex.fromGE(s);i.steps.push(n),r+=n.uid.toString()+","}return i._cached_projection={},i._gtlistentry=null,i._chain=r,i}getInverse(){const t=new Ey;t.steps=[];for(let i=this.steps.length-1;i>=0;i--){const r=this.steps[i];t.steps.push(r.getInverse())}return t}getGTListEntry(){let t="";for(const i of this.steps)t+=i.uid.toString()+",";return t!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=t),this._gtlistentry}assignCachedGe(t,i,r){this._cached_projection[Ey.cacheKey(t,i)]=r}getCachedGeTransformation(t,i){let r="";for(const n of this.steps)r+=n.uid.toString()+",";r!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=r);const s=this._cached_projection[Ey.cacheKey(t,i)];return s===void 0?null:s}}function KG(e,t,i){if(O(t)||O(i)||i.vcsWkid||bc(t,i))return null;const r=lT(t)/lT(i);if(r===1)return null;switch(e){case"point":case"esriGeometryPoint":return s=>JAe(s,r);case"polyline":case"esriGeometryPolyline":return s=>eCe(s,r);case"polygon":case"esriGeometryPolygon":return s=>KAe(s,r);case"multipoint":case"esriGeometryMultipoint":return s=>tCe(s,r);case"extent":case"esriGeometryExtent":return s=>iCe(s,r);default:return null}}function JAe(e,t){e&&e.z!=null&&(e.z*=t)}function KAe(e,t){if(e)for(const i of e.rings)for(const r of i)r.length>2&&(r[2]*=t)}function eCe(e,t){if(e)for(const i of e.paths)for(const r of i)r.length>2&&(r[2]*=t)}function tCe(e,t){if(e)for(const i of e.points)i.length>2&&(i[2]*=t)}function iCe(e,t){e&&e.zmin!=null&&e.zmax!=null&&(e.zmin*=t,e.zmax*=t)}let d1=null,z$=null,M4=null,P4={};function rle(){return!!d1&&Kae()}function J6(e){return O(M4)&&(M4=Promise.all([ele(),import("./geometryEngineBase.40db0853.js").then(t=>t.g),import("./hydrated.6cc1cd93.js")])),M4.then(([,t,{hydratedAdapter:i}])=>{Jt(e),z$=i,d1=t.default,d1._enableProjection(ZAe)})}function RR(e,t,i=null){return Array.isArray(e)?e.length===0?[]:$X(z$,e,e[0].spatialReference,t,i):$X(z$,[e],e.spatialReference,t,i)[0]}function $X(e,t,i,r,s=null){if(O(i)||O(r))return t;if(hT(i,r,s))return t.map(n=>sle(n,i,r));if(O(s)){const n=Ey.cacheKey(i,r);P4[n]!==void 0?s=P4[n]:(s=rCe(i,r,null),O(s)&&(s=new Ey),P4[n]=s)}if(O(d1))throw new e7;return d1._project(e,t,i,r,s)}function rCe(e,t,i=null){if(O(d1))throw new e7;if(O(e)||O(t))return null;const r=d1._getTransformation(z$,e,t,i,i==null?void 0:i.spatialReference);return r!==null?Ey.fromGE(r):null}class e7 extends Q{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var X;function Bht(e,t){try{const i=RR(e,t);if(i==null)return null;"xmin"in e&&"xmin"in i&&(i.zmin=e.zmin,i.zmax=e.zmax);const r=KG(i.type,e.spatialReference,t);return _(r)&&r(i),i}catch(i){if(!(i instanceof e7))throw i;return null}}function hT(e,t,i){return!i&&(!!bc(e,t)||hc(e)&&hc(t)&&!!s7(e,t,o7))}async function Vht(e,t,i,r){if(!rle()){if(Array.isArray(e)){for(const{source:s,dest:n,geographicTransformation:o}of e)if(!hT(s,n,o))return J6(r)}else if(!hT(e,t,i))return J6(r)}}function Ght(e,t){switch(s7(e,t,o7)){case Hi:return"copy3";case Cy:return"wgs84ToSphericalECEF";case p1:return"wgs84ToWebMercator";case Ay:return"wgs84ToPlateCarree";case Oy:return"wgs84ToWGS84ECEF";case G_:return"webMercatorToWGS84";case ule:return"webMercatorToSphericalECEF";case hle:return"webMercatorToWGS84ECEF";case dle:return"webMercatorToPlateCarree";case My:return"wgs84ECEFToWGS84";case mle:return"wgs84ECEFToSphericalECEF";case gle:return"wgs84ECEFToWebMercator";case Ry:return"sphericalECEFToWGS84";case ple:return"sphericalECEFToWebMercator";case iB:return"sphericalMarsPCPFToMars2000";case tB:return"sphericalMoonPCPFToMoon2000";case fle:return"sphericalECEFToWGS84ECEF";case eB:return"mars2000ToSphericalPCPF";case K6:return"moon2000ToSphericalPCPF";default:return null}}function sle(e,t,i){return e?"x"in e?nle(e,t,new Ke,i,0):"xmin"in e?aCe(e,t,new Zt,i,0):"rings"in e?ole(e,t,new dc,i,0):"paths"in e?oCe(e,t,new tc,i,0):"points"in e?nCe(e,t,new B1,i,0):null:null}function sCe(e,t,i=t.spatialReference,r=0){return!O(i)&&_(nle(e,e.spatialReference,t,i,r))}function nle(e,t,i,r,s){gi[0]=e.x,gi[1]=e.y;const n=e.z;return gi[2]=n!==void 0?n:s,_r(gi,t,0,gi,r,0,1)?(i.x=gi[0],i.y=gi[1],i.spatialReference=r,n===void 0?(i.z=void 0,i.hasZ=!1):(i.z=gi[2],i.hasZ=!0),e.m===void 0?(i.m=void 0,i.hasM=!1):(i.m=e.m,i.hasM=!0),i):null}function nCe(e,t,i,r,s){const{points:n,hasZ:o,hasM:a}=e,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!_r(h,t,0,h,r,0,c))return null;for(let p=0;p<c;++p){const f=3*p,g=h[f],y=h[f+1];o&&a?l.push([g,y,h[f+2],n[p][3]]):o?l.push([g,y,h[f+2]]):a?l.push([g,y,n[p][2]]):l.push([g,y])}return i.points=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i}function oCe(e,t,i,r,s){const{paths:n,hasZ:o,hasM:a}=e,l=[];return lle(n,o,a,t,l,r,s)?(i.paths=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function jht(e,t,i=t.spatialReference,r=0){return _(i)&&_(ole(e,e.spatialReference,t,i,r))}function ole(e,t,i,r,s){const{rings:n,hasZ:o,hasM:a}=e,l=[];return lle(n,o,a,t,l,r,s)?(i.rings=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function aCe(e,t,i,r,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=e;return DX(n,o,c?e.zmin:s,t,gi,r)?(i.xmin=gi[0],i.ymin=gi[1],c&&(i.zmin=gi[2]),DX(a,l,c?e.zmax:s,t,gi,r)?(i.xmax=gi[0],i.ymax=gi[1],c&&(i.zmax=gi[2]),h&&(i.mmin=e.mmin,i.mmax=e.mmax),i.spatialReference=r,i):null):null}function n0(e,t,i){if(O(t)||O(i))return null;const r=new Ke({spatialReference:i});return _r(e,t,0,gi,i,0,1)?(r.x=gi[0],r.y=gi[1],r.z=gi[2],r):null}function ale(e,t,i){return _r(e,t,0,gi,i.spatialReference,0,1)?(i.x=gi[0],i.y=gi[1],i.z=gi[2],i):null}function Qs(e,t,i,r=0){gi[0]=e.x,gi[1]=e.y;const s=e.z;return gi[2]=s!==void 0?s:r,_r(gi,e.spatialReference,0,t,i,0,1)}function DX(e,t,i,r,s,n){return pr[0]=e,pr[1]=t,pr[2]=i,_r(pr,r,0,s,n,0,1)}function yn(e,t,i,r){return!(O(t)||O(r)||e.length<2)&&(e.length===2&&(pr[0]=e[0],pr[1]=e[1],pr[2]=0,e=pr),_r(e,t,0,i,r,0,1))}function lCe(e,t){gi[0]=e.x,gi[1]=e.y;const i=e.z;return gi[2]=i!==void 0?i:0,cCe(gi,e.spatialReference,t)}function cCe(e,t,i){return uCe(e,t,i)}function uCe(e,t,i){if(O(t))return!1;const r=o0(t,nN),s=ep[r][X.WGS84_COMPARABLE_LON_LAT];return!O(s)&&(s(e,0,pr,0),i!==pr&&(i[0]=pr[0],i[1]=pr[1],i.length>2&&(i[2]=pr[2])),!0)}function _r(e,t,i,r,s,n,o=1){const a=s7(t,s,o7);if(O(a))return!1;if(a===Hi){if(e===r&&i===n)return!0;const c=i+3*o;for(let h=i,p=n;h<c;h++,p++)r[p]=e[h];return!0}const l=i+3*o;for(let c=i,h=n;c<l;c+=3,h+=3)a(e,c,r,h);return!0}function Hht(e,t,i,r,s){ne(gi,e),pe(UO,e,t),yn(gi,i,gi,s),yn(UO,i,UO,s),de(r,UO,gi),be(r,r)}function lle(e,t,i,r,s,n,o=0){const a=new Array;for(const c of e)for(const h of c)a.push(h[0],h[1],t?h[2]:o);if(!_r(a,r,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of e){const h=new Array;for(const p of c)t&&i?h.push([a[l++],a[l++],a[l++],p[3]]):t?h.push([a[l++],a[l++],a[l++]]):i?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function qht(e,t,i,r){if(O(t)||O(r))return!1;const s=yle(t,r,vCe);if(s.projector===Hi)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(O(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===X.WEB_MERCATOR){const a=ep[n.spatialReferenceId][X.WGS84];return!O(a)&&(a(e,0,mh,0),p1(mh,0,i,0),i[3]=LX(mh[1],e[2],e[3],ai.radius),!0)}if(n.spatialReferenceId!==X.WGS84&&n.spatialReferenceId!==X.CGCS2000||o.spatialReferenceId!==X.PLATE_CARREE)s.projector(e,0,i,0),i[3]=e[3]*n.metersPerUnit/o.metersPerUnit;else{const a=ep[n.spatialReferenceId][X.SPHERICAL_ECEF],l=ep[X.SPHERICAL_ECEF][X.PLATE_CARREE];let c=e[3];_(a)&&_(l)&&(c=LX(e[1],e[2],e[3],ai.radius)),s.projector(e,0,i,0),i[3]=c}return!0}function LX(e,t,i,r){const s=r+t;if(s<r/2||i>s)return Number.MAX_VALUE;const n=Math.abs(Rh*e)+Math.asin(i/s);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}function sN(e,t,i,r){return e!=null&&(bc(t,r)?(i0(i,e),!0):(pr[0]=e[0],pr[1]=e[1],pr[2]=0,!!_r(pr,t,0,pr,r,0,1)&&(i[0]=pr[0],i[1]=pr[1],pr[0]=e[2],pr[1]=e[3],pr[2]=0,!!_r(pr,t,0,pr,r,0,1)&&(i[2]=pr[0],i[3]=pr[1],!0))))}function Wht(e,t,i,r){if(O(t)||O(r))return!1;const s=o0(t,nN),n=o0(r,vle);if(s===n&&s!==X.UNKNOWN||bc(t,r))return i[0]=1,i[1]=1,i[2]=1,!0;if(s===X.SPHERICAL_ECEF){const o=Pe(e),a=o/Math.sqrt(e[0]*e[0]+e[1]*e[1]),l=o/ai.radius;if(n===X.WEB_MERCATOR)return i[0]=a*l,i[1]=a*l,i[2]=1,!0;if(n===X.WGS84||n===X.CGCS2000){const c=fA;return i[0]=c*a*l,i[1]=c*l,i[2]=1,!0}}else if(s===X.PLATE_CARREE){if(n===X.WGS84||n===X.CGCS2000)return i[0]=fA,i[1]=fA,i[2]=1,!0;if(n===X.WEB_MERCATOR){const o=e[1]/ai.radius;return i[0]=1,i[1]=1/Math.cos(o),i[2]=1,!0}}return!1}function Gh(e,t,i,r){if(O(e)||O(r))return!1;const s=o0(e,nN),n=o0(r,vle);if(s===n&&!NX(n)&&(s!==X.UNKNOWN||bc(e,r)))return iN(i,t),!0;if(NX(n)){const o=ep[s][X.LON_LAT],a=ep[X.LON_LAT][n];return!O(o)&&!O(a)&&(o(t,0,mh,0),a(mh,0,Ym,0),cle(Rh*mh[0],Rh*mh[1],i),i[12]=Ym[0],i[13]=Ym[1],i[14]=Ym[2],!0)}if((n===X.WEB_MERCATOR||n===X.PLATE_CARREE)&&(s===X.WGS84||s===X.CGCS2000&&n===X.PLATE_CARREE||s===X.SPHERICAL_ECEF||s===X.WEB_MERCATOR)){const o=ep[s][X.LON_LAT],a=ep[X.LON_LAT][n];return!O(o)&&!O(a)&&(o(t,0,mh,0),a(mh,0,Ym,0),s===X.SPHERICAL_ECEF?hCe(Rh*mh[0],Rh*mh[1],i):pp(i),i[12]=Ym[0],i[13]=Ym[1],i[14]=Ym[2],!0)}return!1}function NX(e){return e===X.SPHERICAL_ECEF||e===X.SPHERICAL_MARS_PCPF||e===X.SPHERICAL_MOON_PCPF}function cle(e,t,i){const r=Math.sin(e),s=Math.cos(e),n=Math.sin(t),o=Math.cos(t),a=i;return a[0]=-r,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*r,a[9]=o*r,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function hCe(e,t,i){return cle(e,t,i),Ea(i,i),i}function o0(e,t){return t.spatialReference===e?t.spatialReferenceId:(t.spatialReference=e,"metersPerUnit"in t&&(t.metersPerUnit=bl(e,1)),e.wkt===Lae.wkt?t.spatialReferenceId=X.SPHERICAL_ECEF:QA(e)?t.spatialReferenceId=X.WGS84:i1(e)?t.spatialReferenceId=X.WEB_MERCATOR:Sne(e)?t.spatialReferenceId=X.PLATE_CARREE:e.wkt===lAe.wkt?t.spatialReferenceId=X.WGS84_ECEF:e.wkid===pu.CGCS2000?t.spatialReferenceId=X.CGCS2000:e.wkt===$$.wkt?t.spatialReferenceId=X.SPHERICAL_MARS_PCPF:e.wkt===D$.wkt?t.spatialReferenceId=X.SPHERICAL_MOON_PCPF:wp(e)?t.spatialReferenceId=X.GCSMARS2000:xp(e)?t.spatialReferenceId=X.GCSMOON2000:t.spatialReferenceId=X.UNKNOWN)}function Hi(e,t,i,r){e!==i&&(i[r++]=e[t++],i[r++]=e[t++],i[r]=e[t])}function G_(e,t,i,r){i[r++]=dT*(e[t++]/ai.radius),i[r++]=dT*(Math.PI/2-2*Math.atan(Math.exp(-e[t++]/ai.radius))),i[r]=e[t]}function ule(e,t,i,r){G_(e,t,i,r),Cy(i,r,i,r)}function hle(e,t,i,r){G_(e,t,i,r),Oy(i,r,i,r)}function t7(e,t,i,r,s){const n=.4999999*Math.PI,o=ze(Rh*e[t+1],-n,n),a=Math.sin(o);i[r++]=Rh*e[t]*s.radius,i[r++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),i[r]=e[t+2]}function p1(e,t,i,r){t7(e,t,i,r,ai)}(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",e[e.WGS84=2]="WGS84",e[e.WEB_MERCATOR=3]="WEB_MERCATOR",e[e.WGS84_ECEF=4]="WGS84_ECEF",e[e.CGCS2000=5]="CGCS2000",e[e.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",e[e.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",e[e.GCSMARS2000=8]="GCSMARS2000",e[e.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",e[e.GCSMOON2000=10]="GCSMOON2000",e[e.LON_LAT=11]="LON_LAT",e[e.PLATE_CARREE=12]="PLATE_CARREE"})(X||(X={}));const FX=ai.radius*Math.PI/180,fA=180/(ai.radius*Math.PI);function Ay(e,t,i,r){i[r]=e[t]*FX,i[r+1]=e[t+1]*FX,i[r+2]=e[t+2]}function C_(e,t,i,r){i[r]=e[t]*fA,i[r+1]=e[t+1]*fA,i[r+2]=e[t+2]}function dle(e,t,i,r){G_(e,t,i,r),Ay(i,r,i,r)}function dCe(e,t,i,r){My(e,t,i,r),Ay(i,r,i,r)}function pCe(e,t,i,r){Ry(e,t,i,r),Ay(i,r,i,r)}function fCe(e,t,i,r){C_(e,t,i,r),Cy(i,r,i,r)}function mCe(e,t,i,r){C_(e,t,i,r),p1(i,r,i,r)}function gCe(e,t,i,r){C_(e,t,i,r),Oy(i,r,i,r)}function f1(e){if(O(e))return!1;const t=o0(e,nN);return!!ep[t][X.WGS84_COMPARABLE_LON_LAT]}function FS(e,t,i,r,s=0){const n=r+s,o=Math.cos(i);e[0]=Math.cos(t)*o*n,e[1]=Math.sin(t)*o*n,e[2]=Math.sin(i)*n}function i7(e,t,i,r,s){const n=s+e[t+2],o=Rh*e[t+1],a=Rh*e[t],l=Math.cos(o);i[r++]=Math.cos(a)*l*n,i[r++]=Math.sin(a)*l*n,i[r]=Math.sin(o)*n}function K6(e,t,i,r){i7(e,t,i,r,hm.radius)}function eB(e,t,i,r){i7(e,t,i,r,ip.radius)}function Cy(e,t,i,r){i7(e,t,i,r,ai.radius)}function r7(e,t,i,r,s){const n=e[t],o=e[t+1],a=e[t+2],l=Math.sqrt(n*n+o*o+a*a),c=Uh(a/(l===0?1:l)),h=Math.atan2(o,n);i[r++]=dT*h,i[r++]=dT*c,i[r]=l-s}function tB(e,t,i,r){r7(e,t,i,r,hm.radius)}function iB(e,t,i,r){r7(e,t,i,r,ip.radius)}function Ry(e,t,i,r){r7(e,t,i,r,ai.radius)}function ple(e,t,i,r){Ry(e,t,i,r),p1(i,r,i,r)}function fle(e,t,i,r){Ry(e,t,i,r),Oy(i,r,i,r)}function yCe(e,t,i,r,s){const n=Rh*e[t],o=Rh*e[t+1],a=e[t+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);i[r++]=(h+a)*c*Math.cos(n),i[r++]=(h+a)*c*Math.sin(n),i[r++]=(h*(1-s.eccentricitySquared)+a)*l}function Oy(e,t,i,r){yCe(e,t,i,r,ai)}function My(e,t,i,r){const s=QAe,n=e[t],o=e[t+1],a=e[t+2];let l,c,h,p,f,g,y,v,b,w,S,T,A,C,R,L,U,N,z,V,B;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),V=Math.atan2(o,n),g=a*a/p,y=c/p,C=s.a2/f,R=s.a3-s.a4/f,y>.3?(v=l/f*(1+y*(s.a1+C+g*R)/f),z=Math.asin(v),w=v*v,b=Math.sqrt(1-w)):(b=h/f*(1-g*(s.a5-C-y*R)/f),z=Math.acos(b),w=1-b*b,v=Math.sqrt(w)),S=1-ai.eccentricitySquared*w,T=ai.radius/Math.sqrt(S),A=s.a6*T,C=h-T*b,R=l-A*v,U=b*C+v*R,L=b*R-v*C,N=L/(A/S+U),z+=N,B=U+L*N/2,a<0&&(z=-z),i[r++]=dT*V,i[r++]=dT*z,i[r]=B}function mle(e,t,i,r){My(e,t,i,r),Cy(i,r,i,r)}function gle(e,t,i,r){My(e,t,i,r),p1(i,r,i,r)}const ep={[X.WGS84]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:Hi,[X.SPHERICAL_ECEF]:Cy,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:p1,[X.PLATE_CARREE]:Ay,[X.WGS84]:Hi,[X.WGS84_ECEF]:Oy},[X.CGCS2000]:{[X.CGCS2000]:Hi,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:Hi,[X.SPHERICAL_ECEF]:Cy,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:Ay,[X.WGS84]:null,[X.WGS84_ECEF]:Oy},[X.GCSMARS2000]:{[X.CGCS2000]:null,[X.GCSMARS2000]:Hi,[X.GCSMOON2000]:null,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:null,[X.SPHERICAL_ECEF]:null,[X.SPHERICAL_MARS_PCPF]:eB,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:null,[X.WGS84]:null,[X.WGS84_ECEF]:null},[X.GCSMOON2000]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:Hi,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:null,[X.SPHERICAL_ECEF]:null,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:K6,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:null,[X.WGS84]:null,[X.WGS84_ECEF]:null},[X.WEB_MERCATOR]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:G_,[X.WGS84_COMPARABLE_LON_LAT]:G_,[X.SPHERICAL_ECEF]:ule,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:Hi,[X.PLATE_CARREE]:dle,[X.WGS84]:G_,[X.WGS84_ECEF]:hle},[X.WGS84_ECEF]:{[X.CGCS2000]:My,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:My,[X.WGS84_COMPARABLE_LON_LAT]:My,[X.SPHERICAL_ECEF]:mle,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:gle,[X.PLATE_CARREE]:dCe,[X.WGS84]:My,[X.WGS84_ECEF]:Hi},[X.SPHERICAL_ECEF]:{[X.CGCS2000]:Ry,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:Ry,[X.WGS84_COMPARABLE_LON_LAT]:Ry,[X.SPHERICAL_ECEF]:Hi,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:ple,[X.PLATE_CARREE]:pCe,[X.WGS84]:Ry,[X.WGS84_ECEF]:fle},[X.SPHERICAL_MARS_PCPF]:{[X.CGCS2000]:null,[X.GCSMARS2000]:iB,[X.GCSMOON2000]:null,[X.LON_LAT]:iB,[X.WGS84_COMPARABLE_LON_LAT]:null,[X.SPHERICAL_ECEF]:null,[X.SPHERICAL_MARS_PCPF]:Hi,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:null,[X.WGS84]:null,[X.WGS84_ECEF]:null},[X.SPHERICAL_MOON_PCPF]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:tB,[X.LON_LAT]:tB,[X.WGS84_COMPARABLE_LON_LAT]:null,[X.SPHERICAL_ECEF]:null,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:Hi,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:null,[X.WGS84]:null,[X.WGS84_ECEF]:null},[X.UNKNOWN]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:null,[X.WGS84_COMPARABLE_LON_LAT]:null,[X.SPHERICAL_ECEF]:null,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:Hi,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:null,[X.WGS84]:null,[X.WGS84_ECEF]:null},[X.LON_LAT]:{[X.CGCS2000]:Hi,[X.GCSMARS2000]:Hi,[X.GCSMOON2000]:Hi,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:Hi,[X.SPHERICAL_ECEF]:Cy,[X.SPHERICAL_MARS_PCPF]:eB,[X.SPHERICAL_MOON_PCPF]:K6,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:p1,[X.PLATE_CARREE]:Ay,[X.WGS84]:Hi,[X.WGS84_ECEF]:Oy},[X.WGS84_COMPARABLE_LON_LAT]:{[X.CGCS2000]:null,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:Hi,[X.WGS84_COMPARABLE_LON_LAT]:Hi,[X.SPHERICAL_ECEF]:Cy,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:null,[X.PLATE_CARREE]:Ay,[X.WGS84]:Hi,[X.WGS84_ECEF]:Oy},[X.PLATE_CARREE]:{[X.CGCS2000]:C_,[X.GCSMARS2000]:null,[X.GCSMOON2000]:null,[X.LON_LAT]:C_,[X.WGS84_COMPARABLE_LON_LAT]:C_,[X.SPHERICAL_ECEF]:fCe,[X.SPHERICAL_MARS_PCPF]:null,[X.SPHERICAL_MOON_PCPF]:null,[X.UNKNOWN]:null,[X.WEB_MERCATOR]:mCe,[X.PLATE_CARREE]:Hi,[X.WGS84]:C_,[X.WGS84_ECEF]:gCe}};function s7(e,t,i=n7()){return O(e)||O(t)?null:yle(e,t,i).projector}function yle(e,t,i){if(O(e)||O(t)||i.source.spatialReference===e&&i.dest.spatialReference===t)return i;const r=o0(e,i.source),s=o0(t,i.dest);return r===X.UNKNOWN&&s===X.UNKNOWN?bc(e,t)?i.projector=Hi:i.projector=null:i.projector=ep[r][s],i}function n7(){return{source:{spatialReference:null,spatialReferenceId:X.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:X.UNKNOWN,metersPerUnit:1},projector:Hi}}const nN={spatialReference:null,spatialReferenceId:X.UNKNOWN},vle={spatialReference:null,spatialReferenceId:X.UNKNOWN},o7=n7(),vCe=n7(),Rh=Ct(1),dT=pl(1),pr=M(),mh=M(),Ym=M(),gi=M(),UO=M();class Om{constructor(t){this.allocator=t,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&qx(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const t=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*UX);this._items.length=Math.min(t,this._items.length),this._itemsPtr=0}_grow(){for(let t=0;t<Math.max(8,Math.min(this._items.length,UX));t++)this._items.push(this.allocator())}}const UX=1024;function Te(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function j_(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]}function a7(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v){return[e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v]}function _le(e,t){return new Float64Array(e,t,16)}const ss=Te();Object.freeze({__proto__:null,create:Te,clone:j_,fromValues:a7,createView:_le,IDENTITY:ss});var ac;(function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"})(ac||(ac={}));function _Ce(e){return 32+e.length}function bCe(){return 16}function ble(e){if(!e)return 0;let t=32;for(const i in e)if(e.hasOwnProperty(i)){const r=e[i];switch(typeof r){case"string":t+=_Ce(r);break;case"number":t+=bCe();break;case"boolean":t+=4}}return t}function Xht(e,t){return 32+e.length*t}var pT;(function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"})(pT||(pT={}));function br(){return[1,0,0,0,1,0,0,0,1]}function wCe(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}function xCe(e,t,i,r,s,n,o,a,l){return[e,t,i,r,s,n,o,a,l]}function wle(e,t){return new Float64Array(e,t,9)}Object.freeze({__proto__:null,create:br,clone:wCe,fromValues:xCe,createView:wle});function T0(){return[0,0,0,1]}function TCe(e){return[e[0],e[1],e[2],e[3]]}function SCe(e,t,i,r){return[e,t,i,r]}function xle(e,t){return new Float64Array(e,t,4)}const ECe=T0();Object.freeze({__proto__:null,create:T0,clone:TCe,fromValues:SCe,createView:xle,IDENTITY:ECe});function Xe(){return[0,0]}function dE(e){return[e[0],e[1]]}function vi(e,t){return[e,t]}function ACe(e){const t=Xe(),i=Math.min(2,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function Tle(e,t){return new Float64Array(e,t,2)}function Sle(){return Xe()}function Ele(){return vi(1,1)}function Ale(){return vi(1,0)}function Cle(){return vi(0,1)}const rB=Sle(),CCe=Ele(),RCe=Ale(),OCe=Cle();Object.freeze({__proto__:null,create:Xe,clone:dE,fromValues:vi,fromArray:ACe,createView:Tle,zeros:Sle,ones:Ele,unitX:Ale,unitY:Cle,ZEROS:rB,ONES:CCe,UNIT_X:RCe,UNIT_Y:OCe});function ni(){return[0,0,0,0]}function oN(e){return[e[0],e[1],e[2],e[3]]}function yi(e,t,i,r){return[e,t,i,r]}function l7(e){const t=ni(),i=Math.min(4,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function Rle(e,t){return new Float64Array(e,t,4)}function Ole(){return ni()}function Mle(){return yi(1,1,1,1)}function Ple(){return yi(1,0,0,0)}function Ile(){return yi(0,1,0,0)}function $le(){return yi(0,0,1,0)}function Dle(){return yi(0,0,0,1)}const H_=Ole(),Zd=Mle(),MCe=Ple(),PCe=Ile(),ICe=$le(),$Ce=Dle();Object.freeze({__proto__:null,create:ni,clone:oN,fromValues:yi,fromArray:l7,createView:Rle,zeros:Ole,ones:Mle,unitX:Ple,unitY:Ile,unitZ:$le,unitW:Dle,ZEROS:H_,ONES:Zd,UNIT_X:MCe,UNIT_Y:PCe,UNIT_Z:ICe,UNIT_W:$Ce});class Zl{constructor(t,i,r){this.itemByteSize=t,this.itemCreate=i,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(r/this.itemByteSize)}get(){this._itemsPtr===0&&qx(()=>this._reset());const t=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=t;){const i=new ArrayBuffer(this._itemsPerBuffer*this.itemByteSize);for(let r=0;r<this._itemsPerBuffer;++r)this._items.push(this.itemCreate(i,r*this.itemByteSize));this._buffers.push(i)}return this._items[this._itemsPtr++]}_reset(){const t=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>t;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(t=ob){return new Zl(16,Tle,t)}static createVec3f64(t=ob){return new Zl(24,H9,t)}static createVec4f64(t=ob){return new Zl(32,Rle,t)}static createMat3f64(t=ob){return new Zl(72,wle,t)}static createMat4f64(t=ob){return new Zl(128,_le,t)}static createQuatf64(t=ob){return new Zl(32,xle,t)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this.itemByteSize}}}const ob=4*pT.KILOBYTES,Yht=Zl.createVec2f64(),Le=Zl.createVec3f64(),c7=Zl.createVec4f64();Zl.createMat3f64();const OR=Zl.createMat4f64();Zl.createQuatf64();function S0(e){return e?{origin:Ts(e.origin),vector:Ts(e.vector)}:{origin:M(),vector:M()}}function q_(e,t,i=S0()){return ne(i.origin,e),de(i.vector,t,e),i}function u7(e,t){const i=de(Le.get(),t,e.origin),r=_e(e.vector,i),s=_e(e.vector,e.vector),n=ze(r/s,0,1),o=de(Le.get(),ae(Le.get(),e.vector,n),i);return _e(o,o)}function kX(e,t,i,r,s){const{vector:n,origin:o}=e,a=de(Le.get(),t,o),l=_e(n,a)/Fo(n);return ae(s,n,ze(l,i,r)),pe(s,s,e.origin)}function Lle(e,t,i){return!!DCe(e,t,!0,zX)&&(ne(i,zX.pA),!0)}function DCe(e,t,i,r){const n=e.origin,o=pe(Le.get(),n,e.vector),a=t.origin,l=pe(Le.get(),a,t.vector),c=Le.get(),h=Le.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=Le.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],g=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],v=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],b=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*v-g*g;if(Math.abs(b)<1e-6)return!1;let w=(f*g-y*v)/b,S=(f+g*w)/v;i&&(w=ze(w,0,1),S=ze(S,0,1));const T=Le.get(),A=Le.get();return T[0]=n[0]+w*p[0],T[1]=n[1]+w*p[1],T[2]=n[2]+w*p[2],A[0]=a[0]+S*h[0],A[1]=a[1]+S*h[1],A[2]=a[2]+S*h[2],r.tA=w,r.tB=S,r.pA=T,r.pB=A,r.distance2=ko(T,A),!0}const zX={tA:0,tB:0,pA:M(),pB:M(),distance2:0};new Om(()=>({origin:null,vector:null}));function Fn(e){return e?{origin:Ts(e.origin),direction:Ts(e.direction)}:{origin:M(),direction:M()}}function Zht(e,t){return J_(e.origin,t.origin)&&J_(e.direction,t.direction)}function fc(e,t){const i=kCe.get();return i.origin=e,i.direction=t,i}function B$(e,t=Fn()){return Nle(e.origin,e.direction,t)}function LCe(e,t,i=Fn()){return ne(i.origin,e),de(i.direction,t,e),i}function Nle(e,t,i=Fn()){return ne(i.origin,e),ne(i.direction,t),i}function NCe(e,t){const i=dt(Le.get(),be(Le.get(),e.direction),de(Le.get(),t,e.origin));return _e(i,i)}function FCe(e,t,i){const r=_e(e.direction,de(i,t,e.origin));return pe(i,e.origin,ae(i,e.direction,r)),i}function UCe(){return{origin:null,direction:null}}const kCe=new Om(UCe);function mA(e,t){return _e(e,t)/Pe(e)}function h7(e,t){const i=_e(e,t)/(Pe(e)*Pe(t));return-Es(i)}function zCe(e,t,i){be(kO,e),be(I4,t);const r=_e(kO,I4),s=Es(r),n=dt(kO,kO,I4);return _e(n,i)<0?2*Math.PI-s:s}const kO=M(),I4=M(),BCe=he.getLogger("esri.geometry.support.sphere");function vn(){return ni()}function fT(e,t=vn()){return fa(t,e)}function Fle(e,t){return yi(e[0],e[1],e[2],t)}function VCe(e){return e}function Ule(e){e[0]=e[1]=e[2]=e[3]=0}function GCe(e){return e}function aN(e){return Array.isArray(e)?e[3]:e}function mc(e){return Array.isArray(e)?e:ZCe}function kle(e,t,i,r){return yi(e,t,i,r)}function jCe(e,t,i){return e!==i&&ne(i,e),i[3]=e[3]+t,i}function HCe(e,t,i){return BCe.error("sphere.setExtent is not yet supported"),e===i?i:fT(e,i)}function E0(e,t,i){if(O(t))return!1;const{origin:r,direction:s}=t,n=qCe;n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-e[3]*e[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(i&&(i[0]=r[0]+s[0]*h,i[1]=r[1]+s[1]*h,i[2]=r[2]+s[2]*h),!0)}const qCe=M();function sB(e,t){return E0(e,t,null)}function WCe(e,t,i){if(E0(e,t,i))return i;const r=cS(e,t,Le.get());return pe(i,t.origin,ae(Le.get(),t.direction,xi(t.origin,r)/Pe(t.direction))),i}function cS(e,t,i){const r=Le.get(),s=OR.get();dt(r,t.origin,t.direction);const n=aN(e);dt(i,r,t.origin),ae(i,i,1/Pe(i)*n);const o=Vle(e,t.origin),a=h7(t.origin,i);return yl(s,a+o,r),Ue(i,i,s),i}function XCe(e,t,i){return E0(e,t,i)?i:(FCe(t,mc(e),i),zle(e,i,i))}function zle(e,t,i){const r=de(Le.get(),t,mc(e)),s=ae(Le.get(),r,e[3]/Pe(r));return pe(i,s,mc(e))}function Ble(e,t){const i=de(Le.get(),t,mc(e)),r=Fo(i),s=e[3]*e[3];return Math.sqrt(Math.abs(r-s))}function Vle(e,t){const i=de(Le.get(),t,mc(e)),r=Pe(i),s=aN(e),n=s+Math.abs(s-r);return Es(s/n)}const $4=M();function Gle(e,t,i,r){const s=de($4,t,mc(e));switch(i){case ac.X:{const n=CW(s,$4)[2];return oe(r,-Math.sin(n),Math.cos(n),0)}case ac.Y:{const n=CW(s,$4),o=n[1],a=n[2],l=Math.sin(o);return oe(r,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case ac.Z:return be(r,s);default:return}}function jle(e,t){const i=de(nB,t,mc(e));return Pe(i)-e[3]}function YCe(e,t,i,r){const s=jle(e,t),n=Gle(e,t,ac.Z,nB),o=ae(nB,n,i-s);return pe(r,t,o)}const ZCe=M(),nB=M(),QCe=Object.freeze({__proto__:null,create:vn,copy:fT,fromCenterAndRadius:Fle,wrap:VCe,clear:Ule,fromRadius:GCe,getRadius:aN,getCenter:mc,fromValues:kle,elevate:jCe,setExtent:HCe,intersectRay:E0,intersectsRay:sB,intersectRayClosestSilhouette:WCe,closestPointOnSilhouette:cS,closestPoint:XCe,projectPoint:zle,distanceToSilhouette:Ble,angleToSilhouette:Vle,axisAt:Gle,altitudeAt:jle,setAltitudeAt:YCe});function ii(e=nRe){return[e[0],e[1],e[2],e[3]]}function JCe(e,t,i,r){return d7(e,t,i,r,c7.get())}function lN(e,t){return d7(t[0],t[1],t[2],t[3],e)}function d7(e,t,i,r,s=ii()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Hle(e,t,i){return ne(i,e),i[3]=t,i}function mT(e,t,i){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=t[0]*s,i[1]=t[1]*s,i[2]=t[2]*s,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function ro(e,t,i,r=ii()){const s=i[0]-t[0],n=i[1]-t[1],o=i[2]-t[2],a=e[0]-t[0],l=e[1]-t[1],c=e[2]-t[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,g=h*h+p*p+f*f,y=Math.abs(g-1)>1e-5&&g>1e-12?1/Math.sqrt(g):1;r[0]=h*y,r[1]=p*y,r[2]=f*y,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2])}function qle(e,t,i,r,s){if(e.count<3)return!1;e.getVec(i,US);let n=r,o=!1;for(;n<e.count-1&&!o;)e.getVec(n,ab),n++,o=!sl(US,ab);if(!o)return!1;for(n=Math.max(n,s),o=!1;n<e.count&&!o;)e.getVec(n,p_),n++,de(zO,US,ab),be(zO,zO),de(BO,ab,p_),be(BO,BO),o=!sl(US,p_)&&!sl(ab,p_)&&Math.abs(_e(zO,BO))<KCe;return o?(ro(US,ab,p_,t),!0):(i!==0||r!==1||s!==2)&&qle(e,t,0,1,2)}const KCe=.99619469809,US=M(),ab=M(),p_=M(),zO=M(),BO=M();function oB(e,t,i){return t!==e&&lN(e,t),e[3]=-_e(e,i),e}function aB(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function uC(e,t,i,r){return dt(p_,t,e),mT(i,p_,r)}function Qht(e,t,i,r){return cN(e,t,de(Le.get(),i,t),oRe,r)}function X1(e,t,i){return!!_(t)&&cN(e,t.origin,t.direction,aRe,i)}function eRe(e,t,i){return cN(e,t.origin,t.vector,sp.NONE,i)}function tRe(e,t,i){return cN(e,t.origin,t.vector,sp.CLAMP,i)}function Wle(e,t){return er(e,t)>=0}function iRe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];return e[0]*(e[0]>0?i:n)+e[1]*(e[1]>0?r:o)+e[2]*(e[2]>0?s:a)+e[3]>=0}function rRe(e,t){const i=_e(e,t.ray.direction),r=-er(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const s=r/i;return i>0?s<t.c1&&(t.c1=s):s>t.c0&&(t.c0=s),t.c0<=t.c1}function sRe(e,t,i){const r=ae(Le.get(),e,-e[3]),s=lB(e,de(Le.get(),t,r),Le.get());return pe(i,s,r),i}function lB(e,t,i){const r=ae(Le.get(),e,_e(e,t));return de(i,t,r),i}function er(e,t){return _e(e,t)+e[3]}function cN(e,t,i,r,s){const n=_e(e,i);if(n===0)return!1;let o=-(_e(e,t)+e[3])/n;return r&sp.CLAMP&&(o=ze(o,0,1)),!(!(r&sp.INFINITE_MIN)&&o<0||!(r&sp.INFINITE_MAX)&&o>1)&&(pe(s,t,ae(s,i,o)),!0)}function Jht(e){return e}const nRe=[0,0,1,0];var sp;(function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.INFINITE_MIN=4]="INFINITE_MIN",e[e.INFINITE_MAX=8]="INFINITE_MAX"})(sp||(sp={}));const oRe=sp.INFINITE_MIN|sp.INFINITE_MAX,aRe=sp.INFINITE_MAX,D4=he.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class Xle{constructor(){this.plane=ii(),this.origin=M(),this.basis1=M(),this.basis2=M()}}function Y1(e=nce){return{plane:ii(e.plane),origin:Ts(e.origin),basis1:Ts(e.basis1),basis2:Ts(e.basis2)}}function lRe(e,t,i){const r=bRe.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=JCe(0,0,0,0),uN(r),r}function uS(e,t=Y1()){return p7(e.origin,e.basis1,e.basis2,t)}function Yle(e,t){ne(t.origin,e.origin),ne(t.basis1,e.basis1),ne(t.basis2,e.basis2),lN(t.plane,e.plane)}function p7(e,t,i,r=Y1()){return ne(r.origin,e),ne(r.basis1,t),ne(r.basis2,i),uN(r),vRe(r,"fromValues()"),r}function uN(e){uC(e.basis2,e.basis1,e.origin,e.plane)}function Zle(e,t,i){e!==i&&uS(e,i);const r=ae(Le.get(),gm(e),t);return pe(i.origin,i.origin,r),i.plane[3]-=t,i}function cRe(e,t,i){return Qle(t,i),Zle(i,y7(e,e.origin),i),i}function Qle(e,t=Y1()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return oe(t.origin,e[0]+i,e[1]+r,0),oe(t.basis1,i,0,0),oe(t.basis2,0,r,0),d7(0,0,1,0,t.plane),t}function f7(e,t,i){return!!X1(e.plane,t,i)&&rce(e,i)}function uRe(e,t,i){if(f7(e,t,i))return i;const r=Jle(e,t,Le.get());return pe(i,t.origin,ae(Le.get(),t.direction,xi(t.origin,r)/Pe(t.direction))),i}function Jle(e,t,i){const r=V$.get();sce(e,t,r,V$.get());let s=Number.POSITIVE_INFINITY;for(const n of _7){const o=v7(e,n,hN.get()),a=Le.get();if(eRe(r,o,a)){const l=Am(Le.get(),t.origin,a),c=Math.abs(Es(_e(t.direction,l)));c<s&&(s=c,ne(i,a))}}return s===Number.POSITIVE_INFINITY?Kle(e,t,i):i}function Kle(e,t,i){if(f7(e,t,i))return i;const r=V$.get(),s=V$.get();sce(e,t,r,s);let n=Number.POSITIVE_INFINITY;for(const o of _7){const a=v7(e,o,hN.get()),l=Le.get();if(tRe(r,a,l)){const c=NCe(t,l);if(!Wle(s,l))continue;c<n&&(n=c,ne(i,l))}}return m7(e,t.origin)<n&&ece(e,t.origin,i),i}function ece(e,t,i){const r=sRe(e.plane,t,Le.get()),s=kX(BX(e,e.basis1),r,-1,1,Le.get()),n=kX(BX(e,e.basis2),r,-1,1,Le.get());return de(i,pe(Le.get(),s,n),e.origin),i}function tce(e,t,i){const{origin:r,basis1:s,basis2:n}=e,o=de(Le.get(),t,r),a=mA(s,o),l=mA(n,o),c=mA(gm(e),o);return oe(i,a,l,c)}function m7(e,t){const i=tce(e,t,Le.get()),{basis1:r,basis2:s}=e,n=Pe(r),o=Pe(s),a=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-o,0),c=i[2];return a*a+l*l+c*c}function hRe(e,t){return Math.sqrt(m7(e,t))}function dRe(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of _7){const s=v7(e,r,hN.get()),n=u7(s,t);n>i&&(i=n)}return Math.sqrt(i)}function g7(e,t){return Wle(e.plane,t)&&rce(e,t)}function pRe(e,t,i,r){return yRe(e,i,r)}function y7(e,t){const i=-e.plane[3];return mA(gm(e),t)-i}function fRe(e,t,i,r){const s=y7(e,t),n=ae(_Re,gm(e),i-s);return pe(r,t,n),r}function mRe(e,t){return sl(e.basis1,t.basis1)&&sl(e.basis2,t.basis2)&&sl(e.origin,t.origin)}function ice(e,t,i){return e!==i&&uS(e,i),hr(lb,t),Ea(lb,lb),Ue(i.basis1,e.basis1,lb),Ue(i.basis2,e.basis2,lb),Ue(i.plane,e.plane,lb),Ue(i.origin,e.origin,t),oB(i.plane,i.plane,i.origin),i}function gRe(e,t,i,r){return e!==r&&uS(e,r),yl(L4,t,i),Ue(r.basis1,e.basis1,L4),Ue(r.basis2,e.basis2,L4),uN(r),r}function gm(e){return e.plane}function yRe(e,t,i){switch(t){case ac.X:ne(i,e.basis1),be(i,i);break;case ac.Y:ne(i,e.basis2),be(i,i);break;case ac.Z:ne(i,gm(e))}return i}function rce(e,t){const i=de(Le.get(),t,e.origin),r=Fo(e.basis1),s=Fo(e.basis2),n=_e(e.basis1,i),o=_e(e.basis2,i);return-n-r<0&&n-r<0&&-o-s<0&&o-s<0}function BX(e,t){const i=hN.get();return ne(i.origin,e.origin),ne(i.vector,t),i}function v7(e,t,i){const{basis1:r,basis2:s,origin:n}=e,o=ae(Le.get(),r,t.origin[0]),a=ae(Le.get(),s,t.origin[1]);pe(i.origin,o,a),pe(i.origin,i.origin,n);const l=ae(Le.get(),r,t.direction[0]),c=ae(Le.get(),s,t.direction[1]);return ae(i.vector,pe(l,l,c),2),i}function vRe(e,t){Math.abs(_e(e.basis1,e.basis2)/(Pe(e.basis1)*Pe(e.basis2)))>1e-6&&D4.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(_e(e.basis1,gm(e)))>1e-6&&D4.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-_e(gm(e),e.origin)-e.plane[3])>1e-6&&D4.warn(t,"Plane offset is not consistent with plane origin")}function sce(e,t,i,r){const s=gm(e);uC(s,t.direction,t.origin,i),uC(i,s,t.origin,r)}const nce={plane:ii(),origin:je(0,0,0),basis1:je(1,0,0),basis2:je(0,1,0)},V$=new Om(ii),hN=new Om(S0),_Re=M(),bRe=new Om(()=>({origin:null,basis1:null,basis2:null,plane:null})),_7=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],lb=Te(),L4=Te(),wRe=Object.freeze({__proto__:null,BoundedPlaneClass:Xle,create:Y1,wrap:lRe,copy:uS,copyWithoutVerify:Yle,fromValues:p7,updateUnboundedPlane:uN,elevate:Zle,setExtent:cRe,fromAABoundingRect:Qle,intersectRay:f7,intersectRayClosestSilhouette:uRe,closestPointOnSilhouette:Jle,closestPoint:Kle,projectPoint:ece,projectPointLocal:tce,distance2:m7,distance:hRe,distanceToSilhouette:dRe,extrusionContainsPoint:g7,axisAt:pRe,altitudeAt:y7,setAltitudeAt:fRe,equals:mRe,transform:ice,rotate:gRe,normal:gm,UP:nce});function xRe(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function TRe(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function SRe(e){return{operations:e,value:e.create()}}function oce(e,t,i=SRe(e)){return i.operations=e,e.copy(t,i.value),i}function ERe(e){return oce(QCe,kle(0,0,0,di(e).radius))}const VX=2**50;function ARe(){return oce(wRe,p7([0,0,0],[VX,0,0],[0,VX,0]))}function CRe(e,t,i){return e.operations.axisAt(e.value,t,ac.Z,i)}function RRe(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function ORe(e,t,i){return e.operations.intersectRay(e.value,t,i)}function MRe(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function PRe(e,t){return e.operations.altitudeAt(e.value,t)}function ace(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function IRe(e,t,i,r){return t!==r&&Lr(r,t),oe(cb,r[12],r[13],r[14]),ace(e,cb,i,cb),r[12]=cb[0],r[13]=cb[1],r[14]=cb[2],r}function N4(e,t,i){return e.operations.elevate(e.value,t,i.value)}const cb=M();function GX(e,t,i,r,s){return s[0]=_e(e,t),s[1]=_e(e,i),s[2]=_e(e,r),s}function cB(e,t,i,r,s){ne(i,e),ne(VO,t),be(VO,VO),dt(r,VO,i),dt(s,r,i)}function lce(e,t){return e?KL(t):t.isGeographic?tt.PlateCarree:t}const VO=M(),cce=96;function Kht(e,t){const i=t||e.extent,r=e.width,s=bl(i&&i.spatialReference);return i&&r?i.width/r*s*Nae*cce:0}function uce(e,t){return e/(bl(t)*Nae*cce)}var jX,G$,gA,HX,f_;(function(e){e[e.Binary=0]="Binary",e[e.JSON=1]="JSON"})(jX||(jX={})),function(e){e[e.TreeIndex=0]="TreeIndex",e[e.TreeStats=1]="TreeStats",e[e.TreeData=2]="TreeData",e[e.BrickBundles=3]="BrickBundles",e[e.Section=4]="Section",e[e.VariableStats=5]="VariableStats"}(G$||(G$={})),function(e){e[e.None=1]="None",e[e.Front=2]="Front",e[e.Back=3]="Back"}(gA||(gA={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(HX||(HX={})),function(e){e[e.None=0]="None",e[e.StaticSections=1]="StaticSections",e[e.Slices=2]="Slices",e[e.DynamicSections=4]="DynamicSections",e[e.GhostShell=8]="GhostShell",e[e.Isosurface=16]="Isosurface",e[e.Quality=32]="Quality",e[e.SunLocation=64]="SunLocation",e[e.StaticSectionSelection=128]="StaticSectionSelection",e[e.ExaggerationAndOffset=256]="ExaggerationAndOffset",e[e.CurrentTime=512]="CurrentTime",e[e.CurrentVariable=1024]="CurrentVariable",e[e.DeleteIsosurface=2048]="DeleteIsosurface",e[e.ContainerVisibility=4096]="ContainerVisibility",e[e.RenderMode=8192]="RenderMode",e[e.Optimization=16384]="Optimization"}(f_||(f_={}));function $Re(e){return new Promise(t=>import("./vxlLayer.26ce0764.js").then(i=>i.v).then(({default:i})=>{const r=i({locateFile:DRe,preinitializedWebGLContext:e,onRuntimeInitialized:()=>t(r)})})).catch(t=>Promise.reject(t))}function DRe(e){return ui(`esri/libs/vxl/${e}`)}var De;(function(e){e[e.MATERIAL=0]="MATERIAL",e[e.MATERIAL_ALPHA=1]="MATERIAL_ALPHA",e[e.MATERIAL_DEPTH=2]="MATERIAL_DEPTH",e[e.MATERIAL_NORMAL=3]="MATERIAL_NORMAL",e[e.MATERIAL_DEPTH_SHADOWMAP_ALL=4]="MATERIAL_DEPTH_SHADOWMAP_ALL",e[e.MATERIAL_HIGHLIGHT=5]="MATERIAL_HIGHLIGHT",e[e.MATERIAL_DEPTH_SHADOWMAP_DEFAULT=6]="MATERIAL_DEPTH_SHADOWMAP_DEFAULT",e[e.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT=7]="MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT",e[e.MAX_PASS=8]="MAX_PASS"})(De||(De={}));var ye;(function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_PLUGIN=3]="OPAQUE_PLUGIN",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_PLUGIN=5]="TRANSPARENT_PLUGIN",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=7]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_ENVIRONMENT_OPAQUE=12]="POSTPROCESSING_ENVIRONMENT_OPAQUE",e[e.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=13]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",e[e.LASERLINES=14]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=15]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=16]="HUD_MATERIAL",e[e.LABEL_MATERIAL=17]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=18]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=19]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=20]="DRAPED_MATERIAL",e[e.DRAPED_WATER=21]="DRAPED_WATER",e[e.VOXEL=22]="VOXEL",e[e.MAX_SLOTS=23]="MAX_SLOTS"})(ye||(ye={}));var Kt;function LRe(e,t,i={}){const r=hce(e);for(;r.length>1;){const s=j$(t,r.shift(),i);if(_(s))return s}return NRe(t,r.shift(),i)}function hce(e){const t=ue("esri-force-webgl");if(t===Kt.WEBGL1||t===Kt.WEBGL2)return[t];switch(e){case"2d":return[Kt.WEBGL1];case"3d":return[Kt.WEBGL2,Kt.WEBGL1]}}function NRe(e,t,i={}){if(!window.WebGLRenderingContext)return qX(e,FRe),null;const r=j$(e,t,i);return O(r)&&qX(e,URe),r}function j$(e,t,i={}){const r=t===Kt.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of r){try{s=e.getContext(n,i)}catch{}if(s)break}return s}function qX(e,t){const i=e.parentNode;i&&(i.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>")}(function(e){e[e.WEBGL1=1]="WEBGL1",e[e.WEBGL2=2]="WEBGL2"})(Kt||(Kt={}));const FRe='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',URe=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`;var bi,Tt,Ee,fp,ft,ma,gT,nt,Di,Fi,Ve,lt,rt,Ie,st,yt,Lo,ri,Ql,Gs,gr,ti;(function(e){e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(bi||(bi={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Tt||(Tt={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Ee||(Ee={})),function(e){e[e.ADD=32774]="ADD",e[e.SUBTRACT=32778]="SUBTRACT",e[e.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(fp||(fp={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(ft||(ft={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(ma||(ma={})),function(e){e[e.CW=2304]="CW",e[e.CCW=2305]="CCW"}(gT||(gT={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(nt||(nt={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(Di||(Di={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP"}(Fi||(Fi={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(Ve||(Ve={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.REPEAT=10497]="REPEAT",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(lt||(lt={})),function(e){e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(rt||(rt={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.RED=6403]="RED",e[e.RG=33319]="RG",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER"}(Ie||(Ie={})),function(e){e[e.RGBA4=32854]="RGBA4",e[e.R16F=33325]="R16F",e[e.RG16F=33327]="RG16F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.R32F=33326]="R32F",e[e.RG32F=33328]="RG32F",e[e.RGBA32F=34836]="RGBA32F",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB5_A1=32855]="RGB5_A1",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.RGB16F=34843]="RGB16F",e[e.RGB9_E5=35901]="RGB9_E5",e[e.SRGB8=35905]="SRGB8",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.RGB565=36194]="RGB565",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.RGB10_A2=32857]="RGB10_A2",e[e.RGB10_A2UI=36975]="RGB10_A2UI"}(st||(st={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.INT=5124]="INT",e[e.HALF_FLOAT=5131]="HALF_FLOAT",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(yt||(yt={})),function(e){e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(Lo||(Lo={})),function(e){e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_READ=35045]="STATIC_READ",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.STREAM_COPY=35042]="STREAM_COPY"}(ri||(ri={})),function(e){e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER"}(Ql||(Ql={})),function(e){e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(Gs||(Gs={})),function(e){e[e.TEXTURE=0]="TEXTURE",e[e.RENDER_BUFFER=1]="RENDER_BUFFER",e[e.CUBEMAP=2]="CUBEMAP"}(gr||(gr={})),function(e){e[e.NONE=0]="NONE",e[e.DEPTH_RENDER_BUFFER=1]="DEPTH_RENDER_BUFFER",e[e.STENCIL_RENDER_BUFFER=2]="STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_RENDER_BUFFER=3]="DEPTH_STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_TEXTURE=4]="DEPTH_STENCIL_TEXTURE"}(ti||(ti={}));const F4=33984;var Ns,kl;(function(e){e[e.Texture=0]="Texture",e[e.Buffer=1]="Buffer",e[e.VAO=2]="VAO",e[e.Shader=3]="Shader",e[e.Program=4]="Program",e[e.Framebuffer=5]="Framebuffer",e[e.Renderbuffer=6]="Renderbuffer",e[e.Sync=7]="Sync",e[e.COUNT=8]="COUNT"})(Ns||(Ns={})),function(e){e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(kl||(kl={}));const WX=33306;var Er,Po,XX,YX,H$,uB,ZX;(function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Er||(Er={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT=5124]="INT",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(Po||(Po={})),function(e){e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS"}(XX||(XX={})),function(e){e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED"}(YX||(YX={})),function(e){e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED"}(H$||(H$={})),function(e){e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(uB||(uB={})),function(e){e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}(ZX||(ZX={}));const kS=he.getLogger("esri.layers.VoxelWasmPerScene");var Mi;(function(e){e[e.Lifetime=1]="Lifetime",e[e.RequestResponse=2]="RequestResponse",e[e.Rendering=3]="Rendering",e[e.Error=4]="Error"})(Mi||(Mi={}));class kRe{constructor(t){this._halfIntTexturesAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=De.MATERIAL,this._renderSlot=ye.VOXEL,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._view=t,this._initialize()}get canRender(){return!!this._vxl&&this._view.viewingMode==="local"}_dbg(t,i){this._dbgFlags.has(t)&&(t===Mi.Error?kS.error(i):kS.warn(i))}_removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this._dbg(Mi.Lifetime,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}_initialize(){this._dbg(Mi.Lifetime,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=Nt(()=>this._view.ready,t=>{t&&this._view.viewingMode==="local"?(this._dbg(Mi.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(Mi.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},{initial:!0}),this._qualityWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.qualityProfile},t=>{this._dbg(Mi.Rendering,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this._toWasmQuality(t))},{initial:!0}),this._timeExtentWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.timeExtent},()=>{if(this._vxl){var t;const i=this._getTimeArgs((t=this._view)==null?void 0:t.timeExtent);this._dbg(Mi.Rendering,"sceneView timeExtent changed to useTime="+i.useTime+" st="+i.startTime+" et="+i.endTime),this._vxl.set_scene_time_extent(i.startTime,i.endTime,i.useTime),this._renderPluginContext.requestRender()}},{initial:!0}),this._stationaryWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.stationary},t=>{this._vxl&&t&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})}initializeRenderContext(t){this._dbg(Mi.Lifetime,"--initializeRenderContext--");const i=t.renderContext.rctx;i.type===Kt.WEBGL2?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._initializeWasm(i.gl)):this._dbg(Mi.Error,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this._dbg(Mi.Lifetime,"--uninitializeRenderContext--")}_restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this._dbg(Mi.Error,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const i=this._renderTargetToRestore.viewport;this._rctx.setViewport(i.x,i.y,i.width,i.height)}_bindPreviousDepthToSlot(t,i){const r=!!this._rctx,s=!!this._renderTargetToRestore;if(!r||!s)return 0;const n=this._renderTargetToRestore.fbo.depthStencilTexture;return n?(i===0?this._rctx.bindTexture(null,t,!0):this._rctx.bindTexture(n,t,!0),1):(this._dbg(Mi.Error,"no depth/stencil texture exists!"),0)}_modifyResourceCount(t,i,r){if(!this._rctx)return void this._dbg(Mi.Error,"modifyAllocation callback has no rendering context!");const s=t;r===1?this._rctx.instanceCounter.increment(s,i):this._rctx.instanceCounter.decrement(s,i)}_setBlendState(t,i,r,s){this._rctx?(this._rctx.setBlendingEnabled(t===1),this._rctx.setBlendFunction(i,r),this._rctx.setBlendEquation(s)):this._dbg(Mi.Error,"setBlendState callback has no rendering context!")}_setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this._dbg(Mi.Error,"setFrontFace callback has no rendering context!")}_setDepthStencilStateFunction(t,i,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(t===1),this._rctx.setDepthWriteEnabled(i===1),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(Di.ALWAYS,0,255),this._rctx.setStencilOpSeparate(ma.FRONT,Fi.KEEP,Fi.INCR,Fi.KEEP),this._rctx.setStencilOpSeparate(ma.BACK,Fi.KEEP,Fi.DECR,Fi.KEEP)):this._dbg(Mi.Error,"setDepthStencilStateFunction callback has no rendering context!")}_setRasterizerState(t){if(this._rctx)switch(t){case gA.None:this._rctx.setFaceCullingEnabled(!1);break;case gA.Back:this._rctx.setCullFace(ma.BACK),this._rctx.setFaceCullingEnabled(!0);break;case gA.Front:this._rctx.setCullFace(ma.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(Mi.Error,"setRasterizerState callback has no rendering context!")}_setViewport(t,i,r,s){this._rctx?this._rctx.setViewport(t,i,r,s):this._dbg(Mi.Error,"setViewport callback has no rendering context!")}_updateMemoryUsage(){this._layers.forEach((t,i)=>{if(t.needMemoryUsageUpdate){const r=this._vxl.estimate_memory_usage(i);r>=0&&(t.needMemoryUsageUpdate=!1,t.layerView.setUsedMemory(r))}})}_syncRequestsResponses(){this._layers.forEach((t,i)=>{const r=[];t.responses.forEach((a,l)=>{r.push(l),this._dbg(Mi.RequestResponse,"responding for requestID:"+l+" size:"+a.size),this._vxl.respond(i,l,a),a.requestType!==G$.TreeIndex&&a.requestType!==G$.Section||(t.needMemoryUsageUpdate=!0)});const s=t.responses;for(const a of r)s.delete(a);const n=this._vxl.get_new_requests(i),o=t.abortController.signal;for(const a in n){t.outstandingRequestCount+=1,t.outstandingRequestCount===1&&t.layerView.updatingFlagChanged();const l=n[a],c={responseType:"array-buffer",signal:o};this._dbg(Mi.RequestResponse,"making requestID:"+a+" url:"+l.url),Ci(l.url,c).then(h=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),this._dbg(Mi.RequestResponse,"have response for requestID:"+a);let p=0;if(h.data.byteLength>0){p=this._vxl._malloc(h.data.byteLength);const f=new Uint8Array(this._vxl.HEAPU8.buffer,p,h.data.byteLength),g=new Uint8Array(h.data);for(let y=0;y<h.data.byteLength;++y)f[y]=g[y]}s.set(+a,{responseType:l.responseType,ptr:p,size:h.data.byteLength,success:!0,requestType:l.requestType})}).catch(h=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),vr(h)||(this._dbg(Mi.Error,`requestID:${a} failed, error=${h.toString()}`),s.set(+a,{responseType:l.responseType,ptr:0,size:0,success:!1,requestType:l.requestType}))})}})}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}setEnabled(t,i){this._layers.forEach((r,s)=>{r.layerView===t&&(this._vxl.set_enabled(s,i),this._renderPluginContext.requestRender())})}setSlices(t,i){const r={mask:f_.Slices,slices:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(t,r,!0)}setDynamicSections(t,i){const r={mask:f_.DynamicSections,dynamicSections:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(t,r,!0)}setStaticSections(t,i){const r={mask:f_.StaticSections,staticSections:i};return this._doMaskedUIUpdate(t,r,!0)}setCurrentVariable(t,i){const r={mask:f_.CurrentVariable,currentVariable:i};return this._doMaskedUIUpdate(t,r,!0)}setRenderMode(t,i){const r={mask:f_.RenderMode,renderMode:i};return this._doMaskedUIUpdate(t,r,!0)}_doMaskedUIUpdate(t,i,r){if(!this._vxl)return!1;let s=!1;return this._layers.forEach((n,o)=>{if(n.layerView===t){const a={str:JSON.stringify(i),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(a)&&(s=this._vxl.handle_masked_ui_update(o,a.ptr,a.byteCount)===1,a.isReusable||this._vxl._free(a.ptr))}}),s&&r&&this._renderPluginContext.requestRender(),s}addVoxelLayer(t){if(!this._vxl){const r={layerView:t,resolveCallback:null,rejectCallback:null},s=new Promise((n,o)=>{r.resolveCallback=n,r.rejectCallback=o});return this._newLayers.push(r),s}const i=this._addVoxelLayer(t);return i<0?Promise.reject(-1):Promise.resolve(i)}removeVoxelLayer(t){if(!this._vxl){const s=this._newLayers.findIndex(o=>t===o.layerView);s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const n=this._newLayers.length;return n===0&&(this._dbg(Mi.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),n}let i=-1;this._layers.forEach((s,n)=>{s.layerView===t&&(i=n,s.abortController.abort(),this._vxl.remove_layer(i))}),i>=0&&this._layers.delete(i);const r=this._layers.size;return r===0&&(this._dbg(Mi.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}_getBlockSize(t){for(const i of this._wasmMemBlockSizes)if(t<i)return i;return-1}_allocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const i=this._getBlockSize(t.byteCount);return i<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(i),t.ptr===0&&(t.ptr=this._vxl._malloc(i),this._wasmMemBlocks.set(i,t.ptr))),t.ptr!==0&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let i=-Number.MAX_VALUE,r=Number.MAX_VALUE,s=!1;return _(t)&&(t.isAllTime?s=!0:(_(t.start)&&(s=!0,i=t.start.getTime()/1e3),_(t.end)&&(s=!0,r=t.end.getTime()/1e3))),{startTime:i,endTime:r,useTime:s}}_addVoxelLayer(t){var i;const r=t.layer;let s=-1;const n=r.getConfiguration();if(n.length<1)return-1;const o={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(o))return-1;const a=this._getTimeArgs((i=this._view)==null?void 0:i.timeExtent),l=this._view.spatialReference.isWGS84&&r.spatialReference.isWGS84?111319.49079327357:1;if(s=this._vxl.add_layer(r.serviceRoot,o.ptr,o.byteCount,l,l,a.startTime,a.endTime,a.useTime,this._toWasmQuality(this._view.qualityProfile)),o.isReusable||this._vxl._free(o.ptr),s>=0){const c=new AbortController;if(this._layers.set(s,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:c,needMemoryUsageUpdate:!1}),!this._halfIntTexturesAvailable||ue("mac")){const h=[];let p="";for(const f of t.layer.variables)f.renderingFormat.type!=="Int16"&&f.renderingFormat.type!=="UInt16"||(h.push(f.name),f.id===t.layer.style.currentVariableId&&(p=f.name));p!==""&&kS.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${p}' in this browser`),h.length>0&&kS.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${h.toString()}' in this browser`)}return ue("esri-mobile")&&kS.warnOnce("Mobile support differs across devices. Voxel layer might not display as expected."),s}return-1}prepareRender(t){if(!this._vxl)return;const i=t.viewForward,r=t.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],i[0],i[1],i[2]);const s=this._vxl.cull();this._dbg(Mi.RequestResponse,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=this._newLayers.length===0,this._updateMemoryUsage()}render(t){if(!this._vxl||t.pass!==this._renderPass||t.slot!==this._renderSlot)return;for(const r of this._newLayers){const s=this._addVoxelLayer(r.layerView);s===-1?r.rejectCallback(-1):r.resolveCallback(s)}if(this._newLayers=[],this._layers.size===0)return void this._dbg(Mi.Error,"No voxel layers but RenderPlugin instance is being asked to render!");this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._lastFrameWasStationary=this._view.stationary,this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0),this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,t.scenelightingData.lightingMainDirection[0],t.scenelightingData.lightingMainDirection[1],t.scenelightingData.lightingMainDirection[2]);const i=this._renderTargetToRestore.viewport;i.width===this._viewportWidth&&i.height===this._viewportHeight||(this._viewportWidth=i.width,this._viewportHeight=i.height,this._vxl.set_viewport(i.width,i.height),this._layers.forEach(r=>{r.needMemoryUsageUpdate=!0})),i.x===0&&i.y===0||this._dbg(Mi.Error,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}destroy(){this._dbg(Mi.Lifetime,"--destroy--"),this._removeRenderPlugin(),this._readyWatchHandle=Ys(this._readyWatchHandle),this._qualityWatchHandle=Ys(this._qualityWatchHandle),this._timeExtentWatchHandle=Ys(this._timeExtentWatchHandle),this._stationaryWatchHandle=Ys(this._stationaryWatchHandle),this._vxl&&(this._layers.forEach(t=>{t.abortController.abort()}),this._wasmMemBlocks.forEach(t=>{t!==0&&this._vxl._free(t)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}_initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=$Re(t).then(i=>{var r;if(this._vxl=i,this._vxlPromise=null,this._newLayers.length<=0)return this._dbg(Mi.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const s=this._getTimeArgs((r=this._view)==null?void 0:r.timeExtent),n=this._vxl.addFunction(this._restoreFramebuffer.bind(this),"v"),o=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),a=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),l=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),c=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),h=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),p=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),f=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),g=this._halfIntTexturesAvailable&&!ue("mac");this._vxl.initialize_voxel_wasm(n,o,a,l,c,h,p,f,s.startTime,s.endTime,s.useTime,g),this._renderPluginContext&&this._renderPluginContext.requestRender()}).catch(()=>{for(const i of this._newLayers)i.rejectCallback(-2);this._dbg(Mi.Error," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()})),this._vxlPromise)}pickDepth(t,i,r){if(!this._vxl||!this._rctx||this._layers.size===0)return null;const s=r.viewport[3]-i;if(t<0||t>r.viewport[2]||i<0||i>r.viewport[3])return this._dbg(Mi.Error,`pickDepth: outOfRange, screenXY=[${t}, ${s}], vp=[${r.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=r.viewForward,o=r.eye;this._vxl.update_camera_pos_and_direction(o[0],o[1],o[2],n[0],n[1],n[2]),this.updateWasmCamera(r),this._vxl.begin_frame();const a=this._vxl.pick_depth(t,s);return this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),a.success?a.distanceToCamera:null}_toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}class ex{constructor(){this.view2WASM=new Map}static getInstance(){return ex.instance||(ex.instance=new ex),ex.instance}getVoxelWasmPerSceneView(t){return this.view2WASM.has(t)?this.view2WASM.get(t):null}isUpdating(t,i){return!!this.view2WASM.has(t)&&this.view2WASM.get(t).isUpdating(i)}addLayer(t,i){return this.view2WASM.has(t)||this.view2WASM.set(t,new kRe(t)),this.view2WASM.get(t).addVoxelLayer(i)}removeLayer(t,i){this.view2WASM.has(t)&&this.view2WASM.get(t).removeVoxelLayer(i)<1&&this.view2WASM.delete(t)}setLayerEnabled(t,i,r){this.view2WASM.has(t)&&this.view2WASM.get(t).setEnabled(i,r)}setLayerSlices(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setSlices(o,i))})}),r}setLayerDynamicSections(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setDynamicSections(o,i))})}),r}setLayerCurrentVariable(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setCurrentVariable(o,i))})}),r}setLayerRenderMode(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setRenderMode(o,i))})}),r}setLayerStaticSections(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setStaticSections(o,i))})}),r}}function yA(e){return e&&e.type==="base-tile"||e.type==="tile"||e.type==="elevation"||e.type==="imagery-tile"||e.type==="base-elevation"||e.type==="open-street-map"||e.type==="wcs"||e.type==="web-tile"||e.type==="wmts"||e.type==="vector-tile"}function QX(e){return e&&e.type==="imagery-tile"}function zRe(e){return e&&e.type==="wmts"}function JX(e){return e&&e.type==="voxel"}function dce(e){return e.parent&&e.parent.declaredClass==="esri.Basemap"&&e.parent.baseLayers.indexOf(e)>-1}function hB(e){return e.labelsVisible===!0&&e.labelingInfo!=null&&e.labelingInfo.length>0}function BRe(e){if(e.activeLayer){const t=e.activeLayer.tileMatrixSet;if(t)return t;const i=e.activeLayer.tileMatrixSets;if(i)return i}return null}const VRe=he.getLogger("esri.support.AnalysesCollection");let yT=class extends dA{constructor(e){super(e),this.handles.add(this.on("before-add",t=>{O(t.item)||t.item.parent===this.owner&&(VRe.warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};yT=u([P("esri.support.AnalysesCollection")],yT);const U3={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},U4={xsmall:544,small:768,medium:992,large:1200};function GRe(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}function k4(e,t){return t?U3[e].valueToClassName[t].split(" "):[]}const jRe=e=>{let t=class extends e{constructor(...i){super(...i),this._breakpointsHandles=new Bt,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=U4}initialize(){this._breakpointsHandles.add(Nt(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),un))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=it(this._breakpointsHandles))}set breakpoints(i){if(i===this._get("breakpoints"))return;const r=GRe(i);if(!r){const s=JSON.stringify(U4,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}i=r?i:U4,this._set("breakpoints",I({},i))}_updateClassNames(){if(!this.container)return;const i=Ja.acquire(),r=Ja.acquire();let s,n=!1;for(s in U3){const o=this[s],a=U3[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,k4(s,o).forEach(l=>r.push(l)),k4(s,a).forEach(l=>i.push(l)))}n&&(this._applyClassNameChanges(i,r),Ja.release(i),Ja.release(r))}_applyClassNameChanges(i,r){const s=this.container;s&&(r.forEach(n=>s.classList.remove(n)),i.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const i=this.container;if(!i)return;let r;for(r in U3)k4(r,this[r]).forEach(s=>i.classList.remove(s))}};return u([d()],t.prototype,"breakpoints",null),u([d()],t.prototype,"orientation",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),u([d()],t.prototype,"heightBreakpoint",void 0),t=u([P("esri.views.BreakpointsOwner")],t),t};/*!
 * @esri/arcgis-html-sanitizer - v2.9.0 - Mon Dec 13 2021 15:07:01 GMT-0500 (Eastern Standard Time)
 * Copyright (c) 2021 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2017 Zongmin Lei(雷宗民) <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 * 
 * Lodash/isPlainObject
 * Copyright (c) JS Foundation and other contributors <https://js.foundation/>
 * MIT License, see https://raw.githubusercontent.com/lodash/lodash/4.17.10-npm/LICENSE for details
 */var HRe="[object Object]";function qRe(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}function WRe(e,t){return function(i){return e(t(i))}}var XRe=Function.prototype,pce=Object.prototype,fce=XRe.toString,YRe=pce.hasOwnProperty,ZRe=fce.call(Object),QRe=pce.toString,JRe=WRe(Object.getPrototypeOf,Object);function KRe(e){return!!e&&typeof e=="object"}function eOe(e){if(!KRe(e)||QRe.call(e)!=HRe||qRe(e))return!1;var t=JRe(e);if(t===null)return!0;var i=YRe.call(t,"constructor")&&t.constructor;return typeof i=="function"&&i instanceof i&&fce.call(i)==ZRe}var tOe=eOe,tx={exports:{}},ls={},hC={exports:{}},Z1={};function mce(){var e={};return e["align-content"]=!1,e["align-items"]=!1,e["align-self"]=!1,e["alignment-adjust"]=!1,e["alignment-baseline"]=!1,e.all=!1,e["anchor-point"]=!1,e.animation=!1,e["animation-delay"]=!1,e["animation-direction"]=!1,e["animation-duration"]=!1,e["animation-fill-mode"]=!1,e["animation-iteration-count"]=!1,e["animation-name"]=!1,e["animation-play-state"]=!1,e["animation-timing-function"]=!1,e.azimuth=!1,e["backface-visibility"]=!1,e.background=!0,e["background-attachment"]=!0,e["background-clip"]=!0,e["background-color"]=!0,e["background-image"]=!0,e["background-origin"]=!0,e["background-position"]=!0,e["background-repeat"]=!0,e["background-size"]=!0,e["baseline-shift"]=!1,e.binding=!1,e.bleed=!1,e["bookmark-label"]=!1,e["bookmark-level"]=!1,e["bookmark-state"]=!1,e.border=!0,e["border-bottom"]=!0,e["border-bottom-color"]=!0,e["border-bottom-left-radius"]=!0,e["border-bottom-right-radius"]=!0,e["border-bottom-style"]=!0,e["border-bottom-width"]=!0,e["border-collapse"]=!0,e["border-color"]=!0,e["border-image"]=!0,e["border-image-outset"]=!0,e["border-image-repeat"]=!0,e["border-image-slice"]=!0,e["border-image-source"]=!0,e["border-image-width"]=!0,e["border-left"]=!0,e["border-left-color"]=!0,e["border-left-style"]=!0,e["border-left-width"]=!0,e["border-radius"]=!0,e["border-right"]=!0,e["border-right-color"]=!0,e["border-right-style"]=!0,e["border-right-width"]=!0,e["border-spacing"]=!0,e["border-style"]=!0,e["border-top"]=!0,e["border-top-color"]=!0,e["border-top-left-radius"]=!0,e["border-top-right-radius"]=!0,e["border-top-style"]=!0,e["border-top-width"]=!0,e["border-width"]=!0,e.bottom=!1,e["box-decoration-break"]=!0,e["box-shadow"]=!0,e["box-sizing"]=!0,e["box-snap"]=!0,e["box-suppress"]=!0,e["break-after"]=!0,e["break-before"]=!0,e["break-inside"]=!0,e["caption-side"]=!1,e.chains=!1,e.clear=!0,e.clip=!1,e["clip-path"]=!1,e["clip-rule"]=!1,e.color=!0,e["color-interpolation-filters"]=!0,e["column-count"]=!1,e["column-fill"]=!1,e["column-gap"]=!1,e["column-rule"]=!1,e["column-rule-color"]=!1,e["column-rule-style"]=!1,e["column-rule-width"]=!1,e["column-span"]=!1,e["column-width"]=!1,e.columns=!1,e.contain=!1,e.content=!1,e["counter-increment"]=!1,e["counter-reset"]=!1,e["counter-set"]=!1,e.crop=!1,e.cue=!1,e["cue-after"]=!1,e["cue-before"]=!1,e.cursor=!1,e.direction=!1,e.display=!0,e["display-inside"]=!0,e["display-list"]=!0,e["display-outside"]=!0,e["dominant-baseline"]=!1,e.elevation=!1,e["empty-cells"]=!1,e.filter=!1,e.flex=!1,e["flex-basis"]=!1,e["flex-direction"]=!1,e["flex-flow"]=!1,e["flex-grow"]=!1,e["flex-shrink"]=!1,e["flex-wrap"]=!1,e.float=!1,e["float-offset"]=!1,e["flood-color"]=!1,e["flood-opacity"]=!1,e["flow-from"]=!1,e["flow-into"]=!1,e.font=!0,e["font-family"]=!0,e["font-feature-settings"]=!0,e["font-kerning"]=!0,e["font-language-override"]=!0,e["font-size"]=!0,e["font-size-adjust"]=!0,e["font-stretch"]=!0,e["font-style"]=!0,e["font-synthesis"]=!0,e["font-variant"]=!0,e["font-variant-alternates"]=!0,e["font-variant-caps"]=!0,e["font-variant-east-asian"]=!0,e["font-variant-ligatures"]=!0,e["font-variant-numeric"]=!0,e["font-variant-position"]=!0,e["font-weight"]=!0,e.grid=!1,e["grid-area"]=!1,e["grid-auto-columns"]=!1,e["grid-auto-flow"]=!1,e["grid-auto-rows"]=!1,e["grid-column"]=!1,e["grid-column-end"]=!1,e["grid-column-start"]=!1,e["grid-row"]=!1,e["grid-row-end"]=!1,e["grid-row-start"]=!1,e["grid-template"]=!1,e["grid-template-areas"]=!1,e["grid-template-columns"]=!1,e["grid-template-rows"]=!1,e["hanging-punctuation"]=!1,e.height=!0,e.hyphens=!1,e.icon=!1,e["image-orientation"]=!1,e["image-resolution"]=!1,e["ime-mode"]=!1,e["initial-letters"]=!1,e["inline-box-align"]=!1,e["justify-content"]=!1,e["justify-items"]=!1,e["justify-self"]=!1,e.left=!1,e["letter-spacing"]=!0,e["lighting-color"]=!0,e["line-box-contain"]=!1,e["line-break"]=!1,e["line-grid"]=!1,e["line-height"]=!1,e["line-snap"]=!1,e["line-stacking"]=!1,e["line-stacking-ruby"]=!1,e["line-stacking-shift"]=!1,e["line-stacking-strategy"]=!1,e["list-style"]=!0,e["list-style-image"]=!0,e["list-style-position"]=!0,e["list-style-type"]=!0,e.margin=!0,e["margin-bottom"]=!0,e["margin-left"]=!0,e["margin-right"]=!0,e["margin-top"]=!0,e["marker-offset"]=!1,e["marker-side"]=!1,e.marks=!1,e.mask=!1,e["mask-box"]=!1,e["mask-box-outset"]=!1,e["mask-box-repeat"]=!1,e["mask-box-slice"]=!1,e["mask-box-source"]=!1,e["mask-box-width"]=!1,e["mask-clip"]=!1,e["mask-image"]=!1,e["mask-origin"]=!1,e["mask-position"]=!1,e["mask-repeat"]=!1,e["mask-size"]=!1,e["mask-source-type"]=!1,e["mask-type"]=!1,e["max-height"]=!0,e["max-lines"]=!1,e["max-width"]=!0,e["min-height"]=!0,e["min-width"]=!0,e["move-to"]=!1,e["nav-down"]=!1,e["nav-index"]=!1,e["nav-left"]=!1,e["nav-right"]=!1,e["nav-up"]=!1,e["object-fit"]=!1,e["object-position"]=!1,e.opacity=!1,e.order=!1,e.orphans=!1,e.outline=!1,e["outline-color"]=!1,e["outline-offset"]=!1,e["outline-style"]=!1,e["outline-width"]=!1,e.overflow=!1,e["overflow-wrap"]=!1,e["overflow-x"]=!1,e["overflow-y"]=!1,e.padding=!0,e["padding-bottom"]=!0,e["padding-left"]=!0,e["padding-right"]=!0,e["padding-top"]=!0,e.page=!1,e["page-break-after"]=!1,e["page-break-before"]=!1,e["page-break-inside"]=!1,e["page-policy"]=!1,e.pause=!1,e["pause-after"]=!1,e["pause-before"]=!1,e.perspective=!1,e["perspective-origin"]=!1,e.pitch=!1,e["pitch-range"]=!1,e["play-during"]=!1,e.position=!1,e["presentation-level"]=!1,e.quotes=!1,e["region-fragment"]=!1,e.resize=!1,e.rest=!1,e["rest-after"]=!1,e["rest-before"]=!1,e.richness=!1,e.right=!1,e.rotation=!1,e["rotation-point"]=!1,e["ruby-align"]=!1,e["ruby-merge"]=!1,e["ruby-position"]=!1,e["shape-image-threshold"]=!1,e["shape-outside"]=!1,e["shape-margin"]=!1,e.size=!1,e.speak=!1,e["speak-as"]=!1,e["speak-header"]=!1,e["speak-numeral"]=!1,e["speak-punctuation"]=!1,e["speech-rate"]=!1,e.stress=!1,e["string-set"]=!1,e["tab-size"]=!1,e["table-layout"]=!1,e["text-align"]=!0,e["text-align-last"]=!0,e["text-combine-upright"]=!0,e["text-decoration"]=!0,e["text-decoration-color"]=!0,e["text-decoration-line"]=!0,e["text-decoration-skip"]=!0,e["text-decoration-style"]=!0,e["text-emphasis"]=!0,e["text-emphasis-color"]=!0,e["text-emphasis-position"]=!0,e["text-emphasis-style"]=!0,e["text-height"]=!0,e["text-indent"]=!0,e["text-justify"]=!0,e["text-orientation"]=!0,e["text-overflow"]=!0,e["text-shadow"]=!0,e["text-space-collapse"]=!0,e["text-transform"]=!0,e["text-underline-position"]=!0,e["text-wrap"]=!0,e.top=!1,e.transform=!1,e["transform-origin"]=!1,e["transform-style"]=!1,e.transition=!1,e["transition-delay"]=!1,e["transition-duration"]=!1,e["transition-property"]=!1,e["transition-timing-function"]=!1,e["unicode-bidi"]=!1,e["vertical-align"]=!1,e.visibility=!1,e["voice-balance"]=!1,e["voice-duration"]=!1,e["voice-family"]=!1,e["voice-pitch"]=!1,e["voice-range"]=!1,e["voice-rate"]=!1,e["voice-stress"]=!1,e["voice-volume"]=!1,e.volume=!1,e["white-space"]=!1,e.widows=!1,e.width=!0,e["will-change"]=!1,e["word-break"]=!0,e["word-spacing"]=!0,e["word-wrap"]=!0,e["wrap-flow"]=!1,e["wrap-through"]=!1,e["writing-mode"]=!1,e["z-index"]=!1,e}function iOe(e,t,i){}function rOe(e,t,i){}var sOe=/javascript\s*\:/img;function nOe(e,t){return sOe.test(t)?"":t}Z1.whiteList=mce();Z1.getDefaultWhiteList=mce;Z1.onAttr=iOe;Z1.onIgnoreAttr=rOe;Z1.safeAttrValue=nOe;var oOe={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(e){return String.prototype.trimRight?e.trimRight():e.replace(/(\s*$)/g,"")}},zS=oOe;function aOe(e,t){e=zS.trimRight(e),e[e.length-1]!==";"&&(e+=";");var i=e.length,r=!1,s=0,n=0,o="";function a(){if(!r){var h=zS.trim(e.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=zS.trim(h.slice(0,p)),g=zS.trim(h.slice(p+1));if(f){var y=t(s,o.length,f,g,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<i;n++){var l=e[n];if(l==="/"&&e[n+1]==="*"){var c=e.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,r=!1}else l==="("?r=!0:l===")"?r=!1:l===";"?r||a():l===`
`&&a()}return zS.trim(o)}var lOe=aOe,GO=Z1,cOe=lOe;function KX(e){return e==null}function uOe(e){var t={};for(var i in e)t[i]=e[i];return t}function gce(e){e=uOe(e||{}),e.whiteList=e.whiteList||GO.whiteList,e.onAttr=e.onAttr||GO.onAttr,e.onIgnoreAttr=e.onIgnoreAttr||GO.onIgnoreAttr,e.safeAttrValue=e.safeAttrValue||GO.safeAttrValue,this.options=e}gce.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onAttr,n=i.onIgnoreAttr,o=i.safeAttrValue,a=cOe(e,function(l,c,h,p,f){var g=r[h],y=!1;if(g===!0?y=g:typeof g=="function"?y=g(p):g instanceof RegExp&&(y=g.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var v={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var b=s(h,p,v);return KX(b)?h+":"+p:b}else{var b=n(h,p,v);if(!KX(b))return b}}});return a};var hOe=gce;(function(e,t){var i=Z1,r=hOe;function s(o,a){var l=new r(a);return l.process(o)}t=e.exports=s,t.FilterCSS=r;for(var n in i)t[n]=i[n]})(hC,hC.exports);var b7={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(e){var t=/\s|\n|\t/,i=t.exec(e);return i?i.index:-1}},dOe=hC.exports.FilterCSS,pOe=hC.exports.getDefaultWhiteList,q$=b7;function yce(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var vce=new dOe;function fOe(e,t,i){}function mOe(e,t,i){}function gOe(e,t,i){}function yOe(e,t,i){}function _ce(e){return e.replace(_Oe,"&lt;").replace(bOe,"&gt;")}function vOe(e,t,i,r){if(i=Ece(i),t==="href"||t==="src"){if(i=q$.trim(i),i==="#")return"#";if(!(i.substr(0,7)==="http://"||i.substr(0,8)==="https://"||i.substr(0,7)==="mailto:"||i.substr(0,4)==="tel:"||i.substr(0,11)==="data:image/"||i.substr(0,6)==="ftp://"||i.substr(0,2)==="./"||i.substr(0,3)==="../"||i[0]==="#"||i[0]==="/"))return""}else if(t==="background"){if(jO.lastIndex=0,jO.test(i))return""}else if(t==="style"){if(eY.lastIndex=0,eY.test(i)||(tY.lastIndex=0,tY.test(i)&&(jO.lastIndex=0,jO.test(i))))return"";r!==!1&&(r=r||vce,i=r.process(i))}return i=Ace(i),i}var _Oe=/</g,bOe=/>/g,wOe=/"/g,xOe=/&quot;/g,TOe=/&#([a-zA-Z0-9]*);?/gim,SOe=/&colon;?/gim,EOe=/&newline;?/gim,jO=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a)\:/gi,eY=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,tY=/u\s*r\s*l\s*\(.*/gi;function bce(e){return e.replace(wOe,"&quot;")}function wce(e){return e.replace(xOe,'"')}function xce(e){return e.replace(TOe,function(i,r){return r[0]==="x"||r[0]==="X"?String.fromCharCode(parseInt(r.substr(1),16)):String.fromCharCode(parseInt(r,10))})}function Tce(e){return e.replace(SOe,":").replace(EOe," ")}function Sce(e){for(var t="",i=0,r=e.length;i<r;i++)t+=e.charCodeAt(i)<32?" ":e.charAt(i);return q$.trim(t)}function Ece(e){return e=wce(e),e=xce(e),e=Tce(e),e=Sce(e),e}function Ace(e){return e=bce(e),e=_ce(e),e}function AOe(){return""}function COe(e,t){typeof t!="function"&&(t=function(){});var i=!Array.isArray(e);function r(o){return i?!0:q$.indexOf(e,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(r(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return t(o,a,l)},remove:function(o){var a="",l=0;return q$.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function ROe(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("<!--",i);if(r===-1){t+=e.slice(i);break}t+=e.slice(i,r);var s=e.indexOf("-->",r);if(s===-1)break;i=s+3}return t}function OOe(e){var t=e.split("");return t=t.filter(function(i){var r=i.charCodeAt(0);return r===127?!1:r<=31?r===10||r===13:!0}),t.join("")}ls.whiteList=yce();ls.getDefaultWhiteList=yce;ls.onTag=fOe;ls.onIgnoreTag=mOe;ls.onTagAttr=gOe;ls.onIgnoreTagAttr=yOe;ls.safeAttrValue=vOe;ls.escapeHtml=_ce;ls.escapeQuote=bce;ls.unescapeQuote=wce;ls.escapeHtmlEntities=xce;ls.escapeDangerHtml5Entities=Tce;ls.clearNonPrintableCharacter=Sce;ls.friendlyAttrValue=Ece;ls.escapeAttrValue=Ace;ls.onIgnoreTagStripAll=AOe;ls.StripTagBody=COe;ls.stripCommentTag=ROe;ls.stripBlankChar=OOe;ls.cssFilter=vce;ls.getDefaultCSSWhiteList=pOe;var dN={},iy=b7;function MOe(e){var t=iy.spaceIndex(e);if(t===-1)var i=e.slice(1,-1);else var i=e.slice(1,t+1);return i=iy.trim(i).toLowerCase(),i.slice(0,1)==="/"&&(i=i.slice(1)),i.slice(-1)==="/"&&(i=i.slice(0,-1)),i}function POe(e){return e.slice(0,2)==="</"}function IOe(e,t,i){var r="",s=0,n=!1,o=!1,a=0,l=e.length,c="",h="";e:for(a=0;a<l;a++){var p=e.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){r+=i(e.slice(s,a)),n=a,s=a;continue}if(p===">"){r+=i(e.slice(s,n)),h=e.slice(n,a+1),c=MOe(h),r+=t(n,r.length,c,h,POe(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,g=e.charAt(a-f);g.trim()===""||g==="=";){if(g==="="){o=p;continue e}g=e.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<e.length&&(r+=i(e.substr(s))),r}var $Oe=/[^a-zA-Z0-9_:\.\-]/gim;function DOe(e,t){var i=0,r=[],s=!1,n=e.length;function o(p,f){if(p=iy.trim(p),p=p.replace($Oe,"").toLowerCase(),!(p.length<1)){var g=t(p,f||"");g&&r.push(g)}}for(var a=0;a<n;a++){var l=e.charAt(a),c,h;if(s===!1&&l==="="){s=e.slice(i,a),i=a+1;continue}if(s!==!1&&a===i&&(l==='"'||l==="'")&&e.charAt(a-1)==="="){if(h=e.indexOf(l,a+1),h===-1)break;c=iy.trim(e.slice(i+1,h)),o(s,c),s=!1,a=h,i=a+1;continue}if(/\s|\n|\t/.test(l))if(e=e.replace(/\s|\n|\t/g," "),s===!1)if(h=LOe(e,a),h===-1){c=iy.trim(e.slice(i,a)),o(c),s=!1,i=a+1;continue}else{a=h-1;continue}else if(h=NOe(e,a-1),h===-1){c=iy.trim(e.slice(i,a)),c=iY(c),o(s,c),s=!1,i=a+1;continue}else continue}return i<e.length&&(s===!1?o(e.slice(i)):o(s,iY(iy.trim(e.slice(i))))),iy.trim(r.join(" "))}function LOe(e,t){for(;t<e.length;t++){var i=e[t];if(i!==" ")return i==="="?t:-1}}function NOe(e,t){for(;t>0;t--){var i=e[t];if(i!==" ")return i==="="?t:-1}}function FOe(e){return e[0]==='"'&&e[e.length-1]==='"'||e[0]==="'"&&e[e.length-1]==="'"}function iY(e){return FOe(e)?e.substr(1,e.length-2):e}dN.parseTag=IOe;dN.parseAttr=DOe;var UOe=hC.exports.FilterCSS,gh=ls,Cce=dN,kOe=Cce.parseTag,zOe=Cce.parseAttr,k3=b7;function HO(e){return e==null}function BOe(e){var t=k3.spaceIndex(e);if(t===-1)return{html:"",closing:e[e.length-2]==="/"};e=k3.trim(e.slice(t+1,-1));var i=e[e.length-1]==="/";return i&&(e=k3.trim(e.slice(0,-1))),{html:e,closing:i}}function VOe(e){var t={};for(var i in e)t[i]=e[i];return t}function Rce(e){e=VOe(e||{}),e.stripIgnoreTag&&(e.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),e.onIgnoreTag=gh.onIgnoreTagStripAll),e.whiteList=e.whiteList||gh.whiteList,e.onTag=e.onTag||gh.onTag,e.onTagAttr=e.onTagAttr||gh.onTagAttr,e.onIgnoreTag=e.onIgnoreTag||gh.onIgnoreTag,e.onIgnoreTagAttr=e.onIgnoreTagAttr||gh.onIgnoreTagAttr,e.safeAttrValue=e.safeAttrValue||gh.safeAttrValue,e.escapeHtml=e.escapeHtml||gh.escapeHtml,this.options=e,e.css===!1?this.cssFilter=!1:(e.css=e.css||{},this.cssFilter=new UOe(e.css))}Rce.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onTag,n=i.onIgnoreTag,o=i.onTagAttr,a=i.onIgnoreTagAttr,l=i.safeAttrValue,c=i.escapeHtml,h=t.cssFilter;i.stripBlankChar&&(e=gh.stripBlankChar(e)),i.allowCommentTag||(e=gh.stripCommentTag(e));var p=!1;if(i.stripIgnoreTagBody){var p=gh.StripTagBody(i.stripIgnoreTagBody,n);n=p.onIgnoreTag}var f=kOe(e,function(g,y,v,b,w){var S={sourcePosition:g,position:y,isClosing:w,isWhite:r.hasOwnProperty(v)},T=s(v,b,S);if(!HO(T))return T;if(S.isWhite){if(S.isClosing)return"</"+v+">";var A=BOe(b),C=r[v],R=zOe(A.html,function(U,N){var z=k3.indexOf(C,U)!==-1,V=o(v,U,N,z);if(!HO(V))return V;if(z)return N=l(v,U,N,h),N?U+'="'+N+'"':U;var V=a(v,U,N,z);return HO(V)?void 0:V}),b="<"+v;return R&&(b+=" "+R),A.closing&&(b+=" /"),b+=">",b}else{var T=n(v,b,S);return HO(T)?c(b):T}},c);return p&&(f=p.remove(f)),f};var GOe=Rce;(function(e,t){var i=ls,r=dN,s=GOe;function n(l,c){var h=new s(c);return h.process(l)}t=e.exports=n,t.filterXSS=n,t.FilterXSS=s;for(var o in i)t[o]=i[o];for(var o in r)t[o]=r[o];function a(){return typeof self!="undefined"&&typeof DedicatedWorkerGlobalScope!="undefined"&&self instanceof DedicatedWorkerGlobalScope}a()&&(self.filterXSS=e.exports)})(tx,tx.exports);var jOe=function(){function e(t,i){var r=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?r.sanitizeUrl(a):tx.exports.safeAttrValue(n,o,a,l)}};var s;t&&!i?s=t:t&&i?(s=Object.create(this.arcgisFilterOptions),Object.keys(t).forEach(function(n){n==="whiteList"?s.whiteList=r._extendObjectOfArrays([r.arcgisWhiteList,t.whiteList||{}]):s[n]=t[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new tx.exports.FilterXSS(s)}return e.prototype.sanitize=function(t,i){switch(i===void 0&&(i={}),typeof t){case"number":return isNaN(t)||!isFinite(t)?null:t;case"boolean":return t;case"string":return this._xssFilter.process(t);case"object":return this._iterateOverObject(t,i);default:return i.allowUndefined&&typeof t=="undefined"?void 0:null}},e.prototype.sanitizeUrl=function(t){var i=this._trim(t.substring(0,t.indexOf(":")));return t==="/"||t==="#"||t[0]==="#"||this.allowedProtocols.indexOf(i.toLowerCase())>-1?tx.exports.escapeAttrValue(t):""},e.prototype.sanitizeHTMLAttribute=function(t,i,r,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(t,i,r,s):tx.exports.safeAttrValue(t,i,r,s)},e.prototype.validate=function(t,i){i===void 0&&(i={});var r=this.sanitize(t,i);return{isValid:t===r,sanitized:r}},e.prototype._extendObjectOfArrays=function(t){var i={};return t.forEach(function(r){Object.keys(r).forEach(function(s){Array.isArray(r[s])&&Array.isArray(i[s])?i[s]=i[s].concat(r[s]):i[s]=r[s]})}),i},e.prototype._iterateOverObject=function(t,i){var r=this;i===void 0&&(i={});try{var s=!1,n=void 0;if(Array.isArray(t))n=t.reduce(function(a,l){var c=r.validate(l,i);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(tOe(t)){var o=Object.keys(t);n=o.reduce(function(a,l){var c=t[l],h=r.validate(c,i);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return i.allowUndefined&&typeof t=="undefined"?void 0:null;return s?n:t}catch{return null}},e.prototype._trim=function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},e}();const pN=new Map;function Oce(){pN.clear()}function HOe(e){return pN.get(e)}function qOe(e,t){pN.set(e,t)}function z4(e){pN.delete(e)}var m1,vT,WOe=function(e){if("WebkitTransition"in e.style)m1="webkitTransitionEnd",vT="webkitAnimationEnd";else{if(!("transition"in e.style))throw new Error("Your browser is not supported!");m1="transitionend",vT="animationend"}},Mce=function(e){m1||WOe(e)},XOe=function(e,t){return t===void 0&&(t=e+"-active"),function(i){Mce(i);var r=!1,s=function(n){r||(r=!0,i.removeEventListener(m1,s),i.removeEventListener(vT,s),i.classList.remove(e),i.classList.remove(t))};i.classList.add(e),i.addEventListener(m1,s),i.addEventListener(vT,s),requestAnimationFrame(function(){i.classList.add(t)})}},YOe=function(e,t){return t===void 0&&(t=e+"-active"),function(i,r){Mce(i);var s=!1,n=function(o){s||(s=!0,i.removeEventListener(m1,n),i.removeEventListener(vT,n),r())};i.classList.add(e),i.addEventListener(m1,n),i.addEventListener(vT,n),requestAnimationFrame(function(){i.classList.add(t)})}};const ZOe=he.getLogger("esri.widgets.support.widgetUtils");function Pce(e){const t=Ja.acquire();for(let r=0;r<arguments.length;r++){const s=arguments[r],n=typeof s;if(n==="string")t.push(s);else if(Array.isArray(s))t.push.apply(t,s);else if(n==="object")for(const o in s)s[o]&&t.push(o)}const i=t.join(" ");return Ja.release(t),i}(()=>{const e=new Map,t=new ResizeObserver(i=>{Oce();for(const r of i)e.get(r.target)(r)});return(i,r,s)=>(e.has(i)&&ZOe.error("Already observing element",i),e.set(i,r),t.observe(i,s),Sm(()=>{t.unobserve(i),e.delete(i)}))})();function Py(e){const t=e==null?void 0:e.closest("[dir]");return t!==null&&t instanceof HTMLElement&&t.dir==="rtl"||document.dir==="rtl"}function rY(e){const t="data-node-ref";this[e.getAttribute(t)]=null}function dB(e){const t="data-node-ref";this[e.getAttribute(t)]=e}function QOe(e,t){return(e==="enter"?XOe:YOe)(t)}const JOe=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],KOe=JOe.reduce((e,t)=>(e[t]=[],e),{}),eMe=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],Ice=new jOe({whiteList:KOe,onTagAttr:(e,t,i)=>{const r=`${t}="${i}"`;if(eMe.includes(t))return r},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function tMe(e){return e==="Enter"||e===" "}const $ce="http://www.w3.org/",fN=`${$ce}2000/svg`,Dce=`${$ce}1999/xlink`;let W$,sY=[],w7=(e,t)=>{let i={};return Object.keys(e).forEach(r=>{i[r]=e[r]}),t&&Object.keys(t).forEach(r=>{i[r]=t[r]}),i},x7=(e,t)=>e.vnodeSelector===t.vnodeSelector&&(e.properties&&t.properties?e.properties.key===t.properties.key&&e.properties.bind===t.properties.bind:!e.properties&&!t.properties),Lce=e=>{if(typeof e!="string")throw new Error("Style values must be strings")},iMe=(e,t,i)=>{if(t.vnodeSelector!==""){for(let r=i;r<e.length;r++)if(x7(e[r],t))return r}return-1},B4=(e,t,i,r)=>{let s=e[t];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n&&(n.key===void 0?n.bind:n.key))){for(let o=0;o<e.length;o++)if(o!==t){let a=e[o];if(x7(a,s))throw new Error(`${i.vnodeSelector} had a ${s.vnodeSelector} child ${r==="added"?r:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},rMe=e=>{if(e.properties){let t=e.properties.enterAnimation;t&&t(e.domNode,e.properties)}},pB=[],fB=!1,Nce=e=>{(e.children||[]).forEach(Nce),e.properties&&e.properties.afterRemoved&&e.properties.afterRemoved.apply(e.properties.bind||e.properties,[e.domNode])},nY=()=>{fB=!1,pB.forEach(Nce),pB.length=0},oY=e=>{pB.push(e),fB||(fB=!0,typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(nY,{timeout:16}):setTimeout(nY,16))},aY=e=>{let t=e.domNode;if(e.properties){let i=e.properties.exitAnimation;if(i)return t.style.pointerEvents="none",void i(t,()=>{t.parentNode&&(t.parentNode.removeChild(t),oY(e))},e.properties)}t.parentNode&&(t.parentNode.removeChild(t),oY(e))},sMe=(e,t,i)=>{if(!t)return;let r=i.eventHandlerInterceptor,s=Object.keys(t),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=t[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")mB(e,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&e.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],g=l[f];g&&(Lce(g),i.styleApplyer(e,f,g))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(r&&(l=r(a,l,e,t)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),e[a]=l):i.namespace===fN?a==="href"?e.setAttributeNS(Dce,a,l):e.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?e[a]=Ice.sanitize(l):e.setAttribute(a,l):e[a]=l}}},nMe=(e,t,i)=>{if(t)for(let r of t)ix(r,e,void 0,i)},Fce=(e,t,i)=>{nMe(e,t.children,i),t.text&&(e.textContent=t.text),sMe(e,t.properties,i),t.properties&&t.properties.afterCreate&&t.properties.afterCreate.apply(t.properties.bind||t.properties,[e,i,t.vnodeSelector,t.properties,t.children])},ix=(e,t,i,r)=>{let s,n=0,o=e.vnodeSelector,a=t.ownerDocument;if(o==="")s=e.domNode=a.createTextNode(e.text),i!==void 0?t.insertBefore(s,i):t.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(r=w7(r,{namespace:fN})),r.namespace!==void 0?s=e.domNode=a.createElementNS(r.namespace,p):(s=e.domNode=e.domNode||a.createElement(p),p==="input"&&e.properties&&e.properties.type!==void 0&&s.setAttribute("type",e.properties.type)),i!==void 0?t.insertBefore(s,i):s.parentNode!==t&&t.appendChild(s)),n=l+1}}Fce(s,e,r)}},mB=(e,t,i)=>{t&&t.split(" ").forEach(r=>{r&&e.classList.toggle(r,i)})},oMe=(e,t,i,r)=>{if(!i)return;let s=!1,n=Object.keys(i),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=i[l],h=t[l];if(l==="class")h!==c&&(mB(e,h,!1),mB(e,c,!0));else if(l==="classes"){let p=e.classList,f=Object.keys(c),g=f.length;for(let y=0;y<g;y++){let v=f[y],b=!!c[v];b!==!!h[v]&&(s=!0,b?p.add(v):p.remove(v))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let g=0;g<f;g++){let y=p[g],v=c[y];v!==h[y]&&(s=!0,v?(Lce(v),r.styleApplyer(e,y,v)):r.styleApplyer(e,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=e[l];p!==c&&(e["oninput-value"]?p===e["oninput-value"]:c!==h)&&(e[l]=c,e["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&r.eventHandlerInterceptor||(r.namespace===fN?l==="href"?e.setAttributeNS(Dce,l,c):e.setAttribute(l,c):p==="string"?l==="innerHTML"?e[l]=Ice.sanitize(c):l==="role"&&c===""?e.removeAttribute(l):e.setAttribute(l,c):e[l]!==c&&(e[l]=c),s=!0)}}return s},aMe=(e,t,i,r,s)=>{if(i===r)return!1;r=r||sY;let n,o=(i=i||sY).length,a=r.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?i[l]:void 0,f=r[c];if(p!==void 0&&x7(p,f))h=W$(p,f,s)||h,l++;else{let g=iMe(i,f,l+1);if(g>=0){for(n=l;n<g;n++)aY(i[n]),B4(i,n,e,"removed");h=W$(i[g],f,s)||h,l=g+1}else ix(f,t,l<o?i[l].domNode:void 0,s),rMe(f),B4(r,c,e,"added")}c++}if(o>l)for(n=l;n<o;n++)aY(i[n]),B4(i,n,e,"removed");return h};W$=(e,t,i)=>{let r=e.domNode,s=!1;if(e===t)return!1;let n=!1;if(t.vnodeSelector===""){if(t.text!==e.text){let o=r.ownerDocument.createTextNode(t.text);return r.parentNode.replaceChild(o,r),t.domNode=o,s=!0,s}t.domNode=r}else t.vnodeSelector.lastIndexOf("svg",0)===0&&(i=w7(i,{namespace:fN})),e.text!==t.text&&(n=!0,t.text===void 0?r.removeChild(r.firstChild):r.textContent=t.text),t.domNode=r,n=aMe(t,r,e.children,t.children,i)||n,n=oMe(r,e.properties,t.properties,i)||n,t.properties&&t.properties.afterUpdate&&t.properties.afterUpdate.apply(t.properties.bind||t.properties,[r,i,t.vnodeSelector,t.properties,t.children]);return n&&t.properties&&t.properties.updateAnimation&&t.properties.updateAnimation(r,t.properties,e.properties),s};let BS=(e,t)=>({getLastRender:()=>e,update:i=>{if(e.vnodeSelector!==i.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let r=e;e=i,W$(r,i,t)},domNode:e.domNode});const lMe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{t.charAt(0)==="-"?e.style.setProperty(t,i):e.style[t]=i}};let lw=e=>w7(lMe,e),Iy={create:(e,t)=>(t=lw(t),ix(e,document.createElement("div"),void 0,t),BS(e,t)),append:(e,t,i)=>(i=lw(i),ix(t,e,void 0,i),BS(t,i)),insertBefore:(e,t,i)=>(i=lw(i),ix(t,e.parentNode,e,i),BS(t,i)),merge:(e,t,i)=>(i=lw(i),t.domNode=e,Fce(e,t,i),BS(t,i)),replace:(e,t,i)=>(i=lw(i),ix(t,e.parentNode,e,i),e.parentNode.removeChild(e),BS(t,i))},Uce,cMe=(e,t)=>{let i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i};Uce=Array.prototype.find?(e,t)=>e.find(t):(e,t)=>e.filter(t)[0];let uMe=(e,t)=>{let i=e;return t.forEach(r=>{i=i&&i.children?Uce(i.children,s=>s.domNode===r):void 0}),i},hMe=(e,t,i)=>{let r=function(s){i("domEvent",s);let n=t(),o=cMe(s.currentTarget,n.domNode);o.reverse();let a,l=uMe(n.getLastRender(),o);return e.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),i("domEventProcessed",s),a};return(s,n,o,a)=>r},lY=e=>{let t,i,r=lw(e),s=r.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,g)=>{let y,v=()=>y;r.eventHandlerInterceptor=hMe(t,v,s),y=p(f,g(),r),a.push(y),l.push(g)},h=()=>{if(i=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return t={renderNow:h,scheduleRender:()=>{i||o||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),o=!0},resume:()=>{o=!1,n=!0,t.scheduleRender()},append:(p,f)=>{c(Iy.append,p,f)},insertBefore:(p,f)=>{c(Iy.insertBefore,p,f)},merge:(p,f)=>{c(Iy.merge,p,f)},replace:(p,f)=>{c(Iy.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},t},Dg=class extends we{constructor(){super(...arguments),this.items=new pt,this._watchUpdatingTracking=new rp,this._callbacks=new Map,this._projector=lY(),this._hiddenProjector=lY()}get needsRender(){return this.items.length>0}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(const i of t.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of t.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r=null;const s=()=>(r=e.render(),r);i.append(t,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r&&r.domNode){const o=r.domNode.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom}for(i.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const t=e.getContext("2d");t.save(),t.font=`10px ${getComputedStyle(this.surface).fontFamily}`,this.items.forEach(i=>{t.save(),i.renderCanvas(t),t.restore()}),t.restore()}};u([d({readOnly:!0})],Dg.prototype,"surface",void 0),u([d({readOnly:!0})],Dg.prototype,"items",void 0),u([d({readOnly:!0})],Dg.prototype,"needsRender",null),u([d({readOnly:!0})],Dg.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0,aliasOf:"_watchUpdatingTracking.updating"})],Dg.prototype,"updating",void 0),Dg=u([P("esri.views.overlay.ViewOverlay")],Dg);const cY=Dg;function T7(e,t,i,r){let s=null,n=1e3;typeof t=="number"?(n=t,r=i):(s=t!=null?t:null,n=i);let o,a=0;const l=()=>{a=0,e.apply(r,o)},c=(...h)=>{s&&s.apply(r,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}const dMe=/\?(\.|$)/g;function Wt(e,t,i,r){const s=Array.isArray(t)?t:t.indexOf(",")>-1?t.split(","):[t],n=rr(e,t,i,r);for(const o of s){const a=o.trim().replace(dMe,"$1"),l=e.get(a);i.call(e,l,l,a,e)}return n}function rr(e,t,i,r){return e.watch(t,i,r)}function pMe(e,t,i,r){return gN(e,t,null,i,r)}function S7(e,t,i,r){return mN(e,t,Bce,i,r)}function kce(e,t,i,r){return gN(e,t,Bce,i,r)}function edt(e,t,i,r){return gN(e,t,gMe,i,r)}function fMe(e,t,i,r){return mN(e,t,Vce,i,r)}function zce(e,t,i,r){return gN(e,t,Vce,i,r)}function X$(e,t,i,r){return mN(e,t,yMe,i,r)}function mMe(e,t,i,r){let s=!1;const n=e.watch(t,(o,a,l,c)=>{s||i.call(e,o,a,l,c)},r);return{remove(){n.remove()},pause(){s=!0},resume(){s=!1}}}function mp(e,t,i,r,s,n,o){const a={};function l(h){const p=a[h];p&&(n&&n(p.target,h,e,i),p.handle.remove(),delete a[h])}const c=Wt(e,t,(h,p,f)=>{l(f),CL(h)&&(a[f]={handle:gR(h,i,r),target:h},s&&s(h,f,e,i))},o);return{remove(){c.remove();for(const h in a)l(h)}}}function mN(e,t,i,r,s){const n=e.watch(t,(o,a,l,c)=>{i&&!i(o)||r==null||r.call(e,o,a,l,c)},s);if(Array.isArray(t))for(const o of t){const a=e.get(o);i&&i(a)&&(r==null||r.call(e,a,a,t,e))}else{const o=e.get(t);i&&i(o)&&(r==null||r.call(e,o,o,t,e))}return n}function gN(e,t,i,r,s){const n=typeof r=="function"?r:null,o=typeof r=="object"?r:null;typeof r=="boolean"&&(s=r);let a,l=!1;function c(){a&&(a.remove(),a=null)}const h=Jy();co(o,()=>{c(),h.reject(pi())});const p={then:h.promise.then.bind(h.promise),catch:h.promise.catch.bind(h.promise),remove:c};return Object.freeze(p),a=mN(e,t,i,(f,g,y,v)=>{l=!0,c(),n&&n.call(e,f,g,y,v),h.resolve({value:f,oldValue:g,propertyName:y,target:v})},s),l&&c(),p}function Bce(e){return!!e}function gMe(e){return!e}function Vce(e){return e===!0}function yMe(e){return e===!1}function mt(e,t){const i=t?me(I({},t),{source:e}):e;return d({aliasOf:i})}function vMe(){const e=crypto.getRandomValues(new Uint16Array(8));e[3]=4095&e[3]|16384,e[4]=16383&e[4]|32768;const t=i=>e[i].toString(16);return t(0)+t(1)+"-"+t(2)+"-"+t(3)+"-"+t(4)+"-"+t(5)+t(6)+t(7)}const _Me={handleInterceptedEvent:(e,t,i,r)=>(e.scheduleRender(),t.properties[`on${r.type}`].apply(t.properties.bind||i,[r]))},bMe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{e.style[t]=i}},wMe=e=>I(I({},bMe),e),xMe=(e,t)=>{const i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i},TMe=(e,t)=>e.find(t),uY=(e,t,i=!1)=>{let r=e;return t.forEach((s,n)=>{var o;const a=(o=r)!=null&&o.children?TMe(r.children,l=>l.domNode===s):void 0;i&&!a&&n!==t.length-1||(r=a)}),r},SMe=e=>{let t;const i=I(I({},_Me),e),r=wMe(i),s=r.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,g,y)=>{let v;r.eventHandlerInterceptor=(w,S,T,A)=>function(C){let R;s("domEvent",C);const L=xMe(C.currentTarget,v.domNode),U=L.some(z=>{var V;return customElements.get(z==null||(V=z.tagName)==null?void 0:V.toLowerCase())});if(C.eventPhase===Event.CAPTURING_PHASE||!U)L.reverse(),R=uY(v.getLastRender(),L);else{const z=C.composedPath(),V=z.slice(z.indexOf(C.currentTarget),z.indexOf(v.domNode)).filter(B=>B.getRootNode()===B.ownerDocument).reverse();R=uY(v.getLastRender(),V,!0)}let N;return R&&(N=i.handleInterceptedEvent(t,R,this,C)),s("domEventProcessed",C),N},i.postProcessProjectionOptions==null||i.postProcessProjectionOptions(r);const b=y();v=f(g,b,r),l.push(v),c.push(y),i.afterFirstVNodeRendered&&i.afterFirstVNodeRendered(v,b)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const g=c[f]();s("rendered",void 0),l[f].update(g),s("patched",void 0)}s("renderDone",void 0),o=!0}};return i.modifyDoRenderImplementation&&(p=i.modifyDoRenderImplementation(p,l,c)),t={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,t.scheduleRender()},append:(f,g)=>{h(Iy.append,f,g)},insertBefore:(f,g)=>{h(Iy.insertBefore,f,g)},merge:(f,g)=>{h(Iy.merge,f,g)},replace:(f,g)=>{h(Iy.replace,f,g)},detach:f=>{for(let g=0;g<c.length;g++)if(c[g]===f)return c.splice(g,1),l.splice(g,1)[0];throw new Error("renderFunction was not found")}},t},fr={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let cw,Gce,yN,jce=!1,Y$=!1,E7=!1,Bl=!1,hY=null,gB=!1;const hS=typeof window!="undefined"?window:{};fr.cssVarShim&&hS.CSS;const $h=hS.document||{head:{}},tdt=hS.HTMLElement||class{},uo={$flags$:0,$resourcesUrl$:"",jmp:e=>e(),raf:e=>requestAnimationFrame(e),ael:(e,t,i,r)=>e.addEventListener(t,i,r),rel:(e,t,i,r)=>e.removeEventListener(t,i,r),ce:(e,t)=>new CustomEvent(e,t)},Z$=fr.shadowDomShim&&fr.shadowDom?(()=>($h.head.attachShadow+"").indexOf("[native")>-1)():!0,EMe=(()=>{let e=!1;try{$h.addEventListener("e",null,Object.defineProperty({},"passive",{get(){e=!0}}))}catch{}return e})(),AMe=e=>Promise.resolve(e),CMe=fr.constructableCSS?(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replace=="function"}catch{}return!1})():!1,Hce=(e,t,i,r)=>{i&&i.map(([s,n,o])=>{const a=OMe(e,s),l=RMe(t,o),c=MMe(s);uo.ael(a,n,l,c),(t.$rmListeners$=t.$rmListeners$||[]).push(()=>uo.rel(a,n,l,c))})},RMe=(e,t)=>i=>{try{fr.lazyLoad||e.$hostElement$[t](i)}catch(r){MR(r)}},OMe=(e,t)=>t&4?$h:t&8?hS:t&16?$h.body:e,MMe=e=>EMe?{passive:(e&1)!==0,capture:(e&2)!==0}:(e&2)!==0,dY="http://www.w3.org/1999/xlink",g1=(e,t="")=>()=>{},pY=new WeakMap,PMe=(e,t,i)=>{let r=K$.get(e);CMe&&i?(r=r||new CSSStyleSheet,r.replace(t)):r=t,K$.set(e,r)},IMe=(e,t,i,r)=>{let s=qce(t,i),n=K$.get(s);if(e=e.nodeType===11?e:$h,n)if(typeof n=="string"){e=e.head||e;let o=pY.get(e),a;o||pY.set(e,o=new Set),o.has(s)||(a=$h.createElement("style"),a.innerHTML=n,e.insertBefore(a,e.querySelector("link")),o&&o.add(s))}else e.adoptedStyleSheets.includes(n)||(e.adoptedStyleSheets=[...e.adoptedStyleSheets,n]);return s},$Me=e=>{const t=e.$cmpMeta$,i=e.$hostElement$,r=t.$flags$,s=g1("attachStyles",t.$tagName$),n=IMe(Z$&&i.shadowRoot?i.shadowRoot:i.getRootNode(),t,e.$modeName$);r&10&&(i["s-sc"]=n,i.classList.add(n+"-h"),r&2&&i.classList.add(n+"-s")),s()},qce=(e,t)=>"sc-"+(t&&e.$flags$&32?e.$tagName$+"-"+t:e.$tagName$),DMe=e=>uPe.map(t=>t(e)).find(t=>!!t),fY={},LMe="http://www.w3.org/2000/svg",NMe="http://www.w3.org/1999/xhtml",FMe=e=>e!=null,A7=e=>(e=typeof e,e==="object"||e==="function"),Wce=(e,t,...i)=>{let r=null,s=null,n=null,o=!1,a=!1,l=[];const c=p=>{for(let f=0;f<p.length;f++)r=p[f],Array.isArray(r)?c(r):r!=null&&typeof r!="boolean"&&((o=typeof e!="function"&&!A7(r))&&(r=String(r)),o&&a?l[l.length-1].$text$+=r:l.push(o?Q$(null,r):r),a=o)};if(c(i),t&&(fr.isDev&&e==="input"&&BMe(t),fr.vdomKey&&t.key&&(s=t.key),fr.slotRelocation&&t.name&&(n=t.name),fr.vdomClass)){const p=t.className||t.class;p&&(t.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}if(fr.isDev&&l.some(Xce)&&cPe(`The <Host> must be the single root component. Make sure:
- You are NOT using hostData() and <Host> in the same component.
- <Host> is used once, and it's the single root component of the render() function.`),fr.vdomFunctional&&typeof e=="function")return e(t===null?{}:t,l,kMe);const h=Q$(e,null);return h.$attrs$=t,l.length>0&&(h.$children$=l),fr.vdomKey&&(h.$key$=s),fr.slotRelocation&&(h.$name$=n),h},Q$=(e,t)=>{const i={$flags$:0,$tag$:e,$text$:t,$elm$:null,$children$:null};return fr.vdomAttribute&&(i.$attrs$=null),fr.vdomKey&&(i.$key$=null),fr.slotRelocation&&(i.$name$=null),i},UMe={},Xce=e=>e&&e.$tag$===UMe,kMe={forEach:(e,t)=>e.map(mY).forEach(t),map:(e,t)=>e.map(mY).map(t).map(zMe)},mY=e=>({vattrs:e.$attrs$,vchildren:e.$children$,vkey:e.$key$,vname:e.$name$,vtag:e.$tag$,vtext:e.$text$}),zMe=e=>{if(typeof e.vtag=="function"){const i=Object.assign({},e.vattrs);return e.vkey&&(i.key=e.vkey),e.vname&&(i.name=e.vname),Wce(e.vtag,i,...e.vchildren||[])}const t=Q$(e.vtag,e.vtext);return t.$attrs$=e.vattrs,t.$children$=e.vchildren,t.$key$=e.vkey,t.$name$=e.vname,t},BMe=e=>{const t=Object.keys(e),i=t.indexOf("value");if(i===-1)return;const r=t.indexOf("type"),s=t.indexOf("min"),n=t.indexOf("max"),o=t.indexOf("step");(i<r||i<s||i<n||i<o)&&sue('The "value" prop of <input> should be set after "min", "max", "type" and "step"')},gY=(e,t,i,r,s,n)=>{if(i!==r){let o=bY(e,t),a=t.toLowerCase();if(t==="class"){const l=e.classList,c=yY(i),h=yY(r);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(t==="style"){for(const l in i)(!r||r[l]==null)&&(l.includes("-")?e.style.removeProperty(l):e.style[l]="");for(const l in r)(!i||r[l]!==i[l])&&(l.includes("-")?e.style.setProperty(l,r[l]):e.style[l]=r[l])}else if(t!=="key")if(t==="ref")r&&r(e);else if(!e.__lookupSetter__(t)&&t[0]==="o"&&t[1]==="n")t[2]==="-"?t=t.slice(3):bY(hS,a)?t=a.slice(2):t=a[2]+t.slice(3),i&&uo.rel(e,t,i,!1),r&&uo.ael(e,t,r,!1);else{const l=A7(r);if((o||l&&r!==null)&&!s)try{if(e.tagName.includes("-"))e[t]=r;else{let h=r==null?"":r;t==="list"?o=!1:(i==null||e[t]!=h)&&(e[t]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(t=a,c=!0),r==null||r===!1?(r!==!1||e.getAttribute(t)==="")&&(c?e.removeAttributeNS(dY,t):e.removeAttribute(t)):(!o||n&4||s)&&!l&&(r=r===!0?"":r,c?e.setAttributeNS(dY,t,r):e.setAttribute(t,r))}}},VMe=/\s/,yY=e=>e?e.split(VMe):[],Yce=(e,t,i,r)=>{const s=t.$elm$.nodeType===11&&t.$elm$.host?t.$elm$.host:t.$elm$,n=e&&e.$attrs$||fY,o=t.$attrs$||fY;for(r in n)r in o||gY(s,r,n[r],void 0,i,t.$flags$);for(r in o)gY(s,r,n[r],o[r],i,t.$flags$)},J$=(e,t,i,r)=>{let s=t.$children$[i],n=0,o,a,l;if(jce||(E7=!0,s.$tag$==="slot"&&(cw&&r.classList.add(cw+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=$h.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=$h.createTextNode("");else{if(Bl||(Bl=s.$tag$==="svg"),o=s.$elm$=$h.createElementNS(Bl?LMe:NMe,s.$flags$&2?"slot-fb":s.$tag$),Bl&&s.$tag$==="foreignObject"&&(Bl=!1),Yce(null,s,Bl),FMe(cw)&&o["s-si"]!==cw&&o.classList.add(o["s-si"]=cw),s.$children$)for(n=0;n<s.$children$.length;++n)a=J$(e,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?Bl=!1:o.tagName==="foreignObject"&&(Bl=!0)}return o["s-hn"]=yN,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=Gce,o["s-sn"]=s.$name$||"",l=e&&e.$children$&&e.$children$[i],l&&l.$tag$===s.$tag$&&e.$elm$&&dC(e.$elm$,!1)),o},dC=(e,t)=>{uo.$flags$|=1;const i=e.childNodes;for(let r=i.length-1;r>=0;r--){const s=i[r];s["s-hn"]!==yN&&s["s-ol"]&&(Jce(s).insertBefore(s,C7(s)),s["s-ol"].remove(),s["s-ol"]=void 0,E7=!0),t&&dC(s,t)}uo.$flags$&=-2},Zce=(e,t,i,r,s,n)=>{let o=e["s-cr"]&&e["s-cr"].parentNode||e,a;for(o.shadowRoot&&o.tagName===yN&&(o=o.shadowRoot);s<=n;++s)r[s]&&(a=J$(null,i,s,e),a&&(r[s].$elm$=a,o.insertBefore(a,C7(t))))},Qce=(e,t,i,r,s)=>{for(;t<=i;++t)(r=e[t])&&(s=r.$elm$,tue(r),Y$=!0,s["s-ol"]?s["s-ol"].remove():dC(s,!0),s.remove())},GMe=(e,t,i,r)=>{let s=0,n=0,o=0,a=0,l=t.length-1,c=t[0],h=t[l],p=r.length-1,f=r[0],g=r[p],y,v;for(;s<=l&&n<=p;)if(c==null)c=t[++s];else if(h==null)h=t[--l];else if(f==null)f=r[++n];else if(g==null)g=r[--p];else if(qO(c,f))uw(c,f),c=t[++s],f=r[++n];else if(qO(h,g))uw(h,g),h=t[--l],g=r[--p];else if(qO(c,g))(c.$tag$==="slot"||g.$tag$==="slot")&&dC(c.$elm$.parentNode,!1),uw(c,g),e.insertBefore(c.$elm$,h.$elm$.nextSibling),c=t[++s],g=r[--p];else if(qO(h,f))(c.$tag$==="slot"||g.$tag$==="slot")&&dC(h.$elm$.parentNode,!1),uw(h,f),e.insertBefore(h.$elm$,c.$elm$),h=t[--l],f=r[++n];else{for(o=-1,a=s;a<=l;++a)if(t[a]&&t[a].$key$!==null&&t[a].$key$===f.$key$){o=a;break}o>=0?(v=t[o],v.$tag$!==f.$tag$?y=J$(t&&t[n],i,o,e):(uw(v,f),t[o]=void 0,y=v.$elm$),f=r[++n]):(y=J$(t&&t[n],i,n,e),f=r[++n]),y&&Jce(c.$elm$).insertBefore(y,C7(c.$elm$))}s>l?Zce(e,r[p+1]==null?null:r[p+1].$elm$,i,r,n,p):n>p&&Qce(t,s,l)},qO=(e,t)=>e.$tag$===t.$tag$?e.$tag$==="slot"?e.$name$===t.$name$:e.$key$===t.$key$:!1,C7=e=>e&&e["s-ol"]||e,Jce=e=>(e["s-ol"]?e["s-ol"]:e).parentNode,uw=(e,t)=>{const i=t.$elm$=e.$elm$,r=e.$children$,s=t.$children$,n=t.$tag$,o=t.$text$;let a;o===null?(Bl=n==="svg"?!0:n==="foreignObject"?!1:Bl,n==="slot"||Yce(e,t,Bl),r!==null&&s!==null?GMe(i,r,t,s):s!==null?(e.$text$!==null&&(i.textContent=""),Zce(i,null,t,s,0,s.length-1)):r!==null&&Qce(r,0,r.length-1),Bl&&n==="svg"&&(Bl=!1)):(a=i["s-cr"])?a.parentNode.textContent=o:e.$text$!==o&&(i.data=o)},Kce=e=>{let t=e.childNodes,i,r,s,n,o,a;for(r=0,s=t.length;r<s;r++)if(i=t[r],i.nodeType===1){if(i["s-sr"]){for(o=i["s-sn"],i.hidden=!1,n=0;n<s;n++)if(a=t[n].nodeType,t[n]["s-hn"]!==i["s-hn"]||o!==""){if(a===1&&o===t[n].getAttribute("slot")){i.hidden=!0;break}}else if(a===1||a===3&&t[n].textContent.trim()!==""){i.hidden=!0;break}}Kce(i)}},bh=[],eue=e=>{let t,i,r,s,n,o,a=0,l=e.childNodes,c=l.length;for(;a<c;a++){if(t=l[a],t["s-sr"]&&(i=t["s-cr"])&&i.parentNode)for(r=i.parentNode.childNodes,s=t["s-sn"],o=r.length-1;o>=0;o--)i=r[o],!i["s-cn"]&&!i["s-nr"]&&i["s-hn"]!==t["s-hn"]&&(vY(i,s)?(n=bh.find(h=>h.$nodeToRelocate$===i),Y$=!0,i["s-sn"]=i["s-sn"]||s,n?n.$slotRefNode$=t:bh.push({$slotRefNode$:t,$nodeToRelocate$:i}),i["s-sr"]&&bh.map(h=>{vY(h.$nodeToRelocate$,i["s-sn"])&&(n=bh.find(p=>p.$nodeToRelocate$===i),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):bh.some(h=>h.$nodeToRelocate$===i)||bh.push({$nodeToRelocate$:i}));t.nodeType===1&&eue(t)}},vY=(e,t)=>e.nodeType===1?e.getAttribute("slot")===null&&t===""||e.getAttribute("slot")===t:e["s-sn"]===t?!0:t==="",tue=e=>{e.$attrs$&&e.$attrs$.ref&&e.$attrs$.ref(null),e.$children$&&e.$children$.map(tue)},jMe=(e,t)=>{const i=e.$hostElement$,r=e.$cmpMeta$,s=e.$vnode$||Q$(null,null),n=Xce(t)?t:Wce(null,null,t);yN=i.tagName,r.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},r.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=i[o])),n.$tag$=null,n.$flags$|=4,e.$vnode$=n,n.$elm$=s.$elm$=i.shadowRoot||i,cw=i["s-sc"],Gce=i["s-cr"],jce=Z$&&(r.$flags$&1)!==0,Y$=!1,uw(s,n);{if(uo.$flags$|=1,E7){eue(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<bh.length;f++)o=bh[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=$h.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<bh.length;f++)if(o=bh[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}Y$&&Kce(n.$elm$),uo.$flags$&=-2,bh.length=0}},HMe=e=>fr.lazyLoad?dS(e).$hostElement$:e,idt=(e,t,i)=>{const r=HMe(e);return{emit:s=>(fr.isDev&&!r.isConnected&&sue(`The "${t}" event was emitted, but the dispatcher node is no longer connected to the dom.`),qMe(r,t,{bubbles:!!(i&4),composed:!!(i&2),cancelable:!!(i&1),detail:s}))}},qMe=(e,t,i)=>{const r=uo.ce(t,i);return e.dispatchEvent(r),r},WMe=(e,t)=>{},R7=(e,t)=>(e.$flags$|=16,WMe(e,e.$ancestorComponent$),pPe(()=>XMe(e,t))),XMe=(e,t)=>{const i=e.$hostElement$,r=g1("scheduleUpdate",e.$cmpMeta$.$tagName$),s=i;let n;return t?n=Ax(s,"componentWillLoad"):n=Ax(s,"componentWillUpdate"),n=_Y(n,()=>Ax(s,"componentWillRender")),r(),_Y(n,()=>YMe(e,s,t))},YMe=async(e,t,i)=>{const r=e.$hostElement$,s=g1("update",e.$cmpMeta$.$tagName$);r["s-rc"],i&&$Me(e);const n=g1("render",e.$cmpMeta$.$tagName$);ZMe(e,t,r),n(),s(),QMe(e)},ZMe=(e,t,i)=>{try{hY=t,t=t.render&&t.render(),e.$flags$&=-17,e.$flags$|=2,(fr.hasRenderFn||fr.reflect)&&(fr.vdomRender||fr.reflect)&&(fr.hydrateServerSide||jMe(e,t))}catch(a){MR(a,e.$hostElement$)}return hY=null,null},QMe=e=>{const t=e.$cmpMeta$.$tagName$,i=e.$hostElement$,r=g1("postUpdate",t),s=i;e.$ancestorComponent$,Ax(s,"componentDidRender"),e.$flags$&64?(Ax(s,"componentDidUpdate"),r()):(e.$flags$|=64,Ax(s,"componentDidLoad"),r())},rdt=e=>{if(fr.updatable){const t=dS(e),i=t.$hostElement$.isConnected;return i&&(t.$flags$&18)===2&&R7(t,!1),i}return!1},Ax=(e,t,i)=>{if(e&&e[t])try{return e[t](i)}catch(r){MR(r)}},_Y=(e,t)=>e&&e.then?e.then(t):t(),JMe=(e,t)=>e!=null&&!A7(e)?t&4?e==="false"?!1:e===""||!!e:t&2?parseFloat(e):t&1?String(e):e:e,KMe=(e,t)=>dS(e).$instanceValues$.get(t),ePe=(e,t,i,r)=>{const s=dS(e),n=e,o=s.$instanceValues$.get(t),a=s.$flags$,l=n;if(i=JMe(i,r.$members$[t][0]),i!==o){s.$instanceValues$.set(t,i);{if(r.$watchers$&&a&128){const c=r.$watchers$[t];c&&c.map(h=>{try{l[h](i,o,t)}catch(p){MR(p,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(i,o,t)===!1)return;R7(s,!1)}}}},tPe=(e,t,i)=>{if(t.$members$){e.watchers&&(t.$watchers$=e.watchers);const r=Object.entries(t.$members$),s=e.prototype;r.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return KMe(this,n)},set(a){ePe(this,n,a,t)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){uo.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},e.observedAttributes=r.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&t.$attrsToReflect$.push([o,l]),l})}}return e},iPe=async(e,t,i,r,s)=>{if((t.$flags$&32)===0&&(s=e.constructor,t.$flags$|=32,customElements.whenDefined(i.$tagName$).then(()=>t.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[t.$modeName$=DMe(e)]);const a=qce(i,t.$modeName$);if(!K$.has(a)){const l=g1("registerStyles",i.$tagName$);PMe(a,o,!!(i.$flags$&1)),l()}}t.$ancestorComponent$,(()=>R7(t,!0))()},rPe=e=>{},sPe=e=>{if((uo.$flags$&1)===0){const t=dS(e),i=t.$cmpMeta$,r=g1("connectedCallback",i.$tagName$);t.$flags$&1?(Hce(e,t,i.$listeners$),rPe(t.$lazyInstance$)):(t.$flags$|=1,i.$flags$&12&&nPe(e),i.$members$&&Object.entries(i.$members$).map(([s,[n]])=>{if(n&31&&e.hasOwnProperty(s)){const o=e[s];delete e[s],e[s]=o}}),iPe(e,t,i)),r()}},nPe=e=>{const t=e["s-cr"]=$h.createComment("");t["s-cn"]=!0,e.insertBefore(t,e.firstChild)},oPe=e=>{if((uo.$flags$&1)===0){const t=dS(e);t.$rmListeners$&&(t.$rmListeners$.map(i=>i()),t.$rmListeners$=void 0)}},sdt=(e,t)=>{const i={$flags$:t[0],$tagName$:t[1]};i.$members$=t[2],i.$listeners$=t[3],i.$watchers$=e.$watchers$,i.$attrsToReflect$=[],!Z$&&i.$flags$&1&&(i.$flags$|=8);const r=e.prototype.connectedCallback,s=e.prototype.disconnectedCallback;return Object.assign(e.prototype,{__registerHost(){lPe(this,i)},connectedCallback(){sPe(this),r&&r.call(this)},disconnectedCallback(){oPe(this),s&&s.call(this)},__attachShadow(){Z$?this.attachShadow({mode:"open",delegatesFocus:!!(i.$flags$&16)}):this.shadowRoot=this}}),e.is=i.$tagName$,tPe(e,i)},ndt=e=>{const t=new URL(e,uo.$resourcesUrl$);return t.origin!==hS.location.origin?t.href:t.pathname},aPe=e=>uo.$resourcesUrl$=e,iue=new WeakMap,dS=e=>iue.get(e),lPe=(e,t)=>{const i={$flags$:0,$hostElement$:e,$cmpMeta$:t,$instanceValues$:new Map};return Hce(e,i,t.$listeners$),iue.set(e,i)},bY=(e,t)=>t in e,MR=(e,t)=>(0,console.error)(e,t),rue=fr.isTesting?["STENCIL:"]:["%cstencil","color: white;background:#4c47ff;font-weight: bold; font-size:10px; padding:2px 6px; border-radius: 5px"],cPe=(...e)=>console.error(...rue,...e),sue=(...e)=>console.warn(...rue,...e),K$=new Map,uPe=[],wY=[],nue=[],hPe=(e,t)=>i=>{e.push(i),gB||(gB=!0,t&&uo.$flags$&4?dPe(yB):uo.raf(yB))},xY=e=>{for(let t=0;t<e.length;t++)try{e[t](performance.now())}catch(i){MR(i)}e.length=0},yB=()=>{xY(wY),xY(nue),(gB=wY.length>0)&&uo.raf(yB)},dPe=e=>AMe().then(e),pPe=hPe(nue,!0),odt={isDev:!!fr.isDev,isBrowser:!0,isServer:!1,isTesting:!!fr.isTesting};let oue;function fPe(){aPe(yu(ui(oue)))}oue="components/assets";const aue=Symbol("widget"),mPe=[],gPe={},eD=new WeakMap;function lue(e,t){let i=t.children;if(i&&i.length)for(let s=0;s<i.length;++s)i[s]=lue(e,i[s]);else i=mPe;const r=t.vnodeSelector;if(O7(r)){const s=t.properties||gPe,n=s.key||r;return{vnodeSelector:"div",properties:{key:n,afterCreate:yPe,afterUpdate:vPe,afterRemoved:cue,parentWidget:e,widgetConstructor:r,widgetProperties:me(I({},s),{key:n,children:i})},children:void 0,text:void 0,domNode:null}}return t}function yPe(e,t,i,{parentWidget:r,widgetConstructor:s,widgetProperties:n}){const o=new s(n);o.container=e,eD.set(e,o),o.afterCreate==null||o.afterCreate(o,e),r._internalHandles.add(Sm(()=>cue(e)))}function vPe(e,t,i,{widgetProperties:r}){const s=eD.get(e);s&&(s.set(r),s.afterUpdate==null||s.afterUpdate(s,e))}function cue(e){const t=eD.get(e);t&&(t.destroy(),eD.delete(e))}function O7(e){return typeof e=="function"&&e[aue]}function uue(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-theme-name").replace(/\s|'|"/g,"")}function hue(){return uue().startsWith("dark")}function _Pe(){return"calcite-theme-"+(hue()?"dark":"light")}const due="esri.widgets.Widget",TY=he.getLogger(due);let bPe=0;const wPe={widgetIcon:"esri-icon-checkbox-unchecked"};function pue(e,t){for(const i in t)e[i]!=null&&(typeof e[i]=="object"&&typeof t[i]=="object"?pue(e[i],t[i]):e[i]=t[i]);return e}const xPe=SMe({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,i=/capture$/i;e.eventHandlerInterceptor=(r,s,n,o)=>{const a=t(r,s,n,o),l=i.test(r);if(!((r=r.replace(i,"")).toLowerCase()in n)||l){const c=r[2].toLowerCase()+r.slice(3),h=g=>a.call(n,g);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=g=>{f==null||f(g),p()}}return a}},handleInterceptedEvent(e,t,i,r){const{eventPhase:s,type:n}=r,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=t.properties;(a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,a in l))&&(Oce(),e.scheduleRender(),l[a].call(l.bind||i,r))}});let V4=!1,ks=class extends AR(wr.EventedAccessor){constructor(e,t){super(e,t),this._attached=!1,this._internalHandles=new Bt,this._projector=xPe,this._readyForTrueRender=!1,this.domNode=null,this.iconClass=wPe.widgetIcon,this.label=this.declaredClass.split(".").pop(),this.visible=!0,this.key=this,this._loadLocale=Ase(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const a=await Sa(this._messageBundleProps.map(async({bundlePath:l,propertyName:c})=>{let h=await Pae(l);this.uiStrings&&Object.keys(this.uiStrings)&&(h=pue(se(h),this.uiStrings)),this[c]=h}));for(const l of a)l.error&&TY.error("widget-intl:locale-error",this.declaredClass,l.error)}await this.loadLocale()}),fPe();const i=["light","dark"],r=uue()||"light";i.includes(r)||jx(TY,"The following themes are deprecated: light-blue, dark-blue, light-green, dark-green, light-purple, dark-purple, light-red, and dark-red.",{version:"4.19",warnOnce:!0,see:"https://developers.arcgis.com/javascript/latest/styling/"});const s="esri-widget-uid-"+vMe(),n=this.render.bind(this);this._trackingTarget=new ML(()=>this.scheduleRender());const o=()=>{var a;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:s,class:"",styles:{display:"none"}},domNode:void 0,children:void 0,text:void 0};const l=n();let{properties:c}=l;c||(l.properties=c={});let{key:h,styles:p}=c;h||(c.key=s),p||(c.styles=p={}),p.display||(p.display="");let f=0;return(a=l.children)==null||a.forEach(g=>{if(O7(g.vnodeSelector))return;let{properties:y}=g;y||(g.properties=y={}),y.key||(y.key=`${this.id}--${f++}`)}),lue(this,l)};this.render=()=>{if(V4)return o();let a=HOe(this);if(a)return a;this._trackingTarget.clear(),V4=!0;try{a=cm(this._trackingTarget,o)}finally{V4=!1}return qOe(this,a),a},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()}))}normalizeCtorArgs(e,t){const i=I({},e);return t&&(i.container=t),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(Zk)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(this._trackingTarget=it(this._trackingTarget),this.viewModel=it(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,z4(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return QL(e)}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+bPe++}set id(e){e&&this._set("id",e)}get renderable(){return this._resourcesFetch}get test(){return{projector:this._projector,handles:this._internalHandles}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(z4(this),this._projector.scheduleRender())}classes(...e){return Pce.apply(this,e)}own(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments)),this._internalHandles.add(e)}renderNow(){z4(this),this._projector.renderNow()}_postInitialize(){var e;if(this.destroyed)return;this.scheduleRender(),(e=this._delegatedEventNames)!=null&&e.length&&this._internalHandles.add(Nt(()=>this.viewModel,(i,r)=>{r&&this._internalHandles.remove("delegated-events"),i&&this._internalHandles.add(this._delegatedEventNames.map(s=>i.on(s,n=>{this.emit(s,n)})),"delegated-events")},un)),this.postInitialize();const t=async()=>{await this._loadLocale().catch(Zk),this.scheduleRender()};this._internalHandles.add([zTe(t),Nt(()=>this.uiStrings,t),JL(()=>this.container,i=>{this.destroyed||this._attach(i)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){e&&this._attached&&(this._projector.detach(this.render),e.parentNode&&e.parentNode.removeChild(e),this._attached=!1)}};ks[aue]=!0,u([d()],ks.prototype,"_readyForTrueRender",void 0),u([d({value:null})],ks.prototype,"container",null),u([It("container")],ks.prototype,"castContainer",null),u([d({aliasOf:"container"})],ks.prototype,"domNode",void 0),u([d()],ks.prototype,"iconClass",void 0),u([d()],ks.prototype,"id",null),u([d()],ks.prototype,"label",void 0),u([d()],ks.prototype,"renderable",null),u([d()],ks.prototype,"uiStrings",void 0),u([d()],ks.prototype,"viewModel",void 0),u([d()],ks.prototype,"visible",void 0),u([d()],ks.prototype,"key",void 0),u([d()],ks.prototype,"children",void 0),u([d()],ks.prototype,"afterCreate",void 0),u([d()],ks.prototype,"afterUpdate",void 0),u([d()],ks.prototype,"afterRemoved",void 0),ks=u([P(due)],ks);const Ra=ks;function TPe(e,t,i){return e.units[t][i]}function vN(e,t,i,r=2,s="abbr"){return`${fm(t,{minimumFractionDigits:r,maximumFractionDigits:r})} ${TPe(e,i,s)}`}function adt(e,t,i,r=2,s="abbr"){const n=mAe(t,i);return vN(e,gs(t,i,n),n,r,s)}function ldt(e,t,i,r=2,s="abbr"){const n=gAe(t,i);return vN(e,gs(t,i,n),n,r,s)}function cdt(e,t,i,r=2,s="abbr"){const n=yAe(t,i);return vN(e,gs(t,i,n),n,r,s)}function udt(e,t,i,r=2,s="abbr"){const n=vAe(t,i);return vN(e,gs(t,i,n),n,r,s)}const SY=["B","kB","MB","GB","TB"];function SPe(e,t){let i=t===0?0:Math.floor(Math.log(t)/Math.log(pT.KILOBYTES));i=ze(i,0,SY.length-1);const r=fm(t/pT.KILOBYTES**i,{maximumFractionDigits:2});return ap(e.units.bytes[SY[i]],{fileSize:r})}function EPe(e){const{exifInfo:t,exifName:i,tagName:r}=e;if(!t||!i||!r)return null;const s=t.find(n=>n.name===i);return s?APe({tagName:r,tags:s.tags}):null}function APe(e){const{tagName:t,tags:i}=e;if(!i||!t)return null;const r=i.find(s=>s.name===t);return r&&r.value||null}var vB;const CPe={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let Fa=vB=class extends ve{constructor(e){super(e),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:e}=this,t=EPe({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:e});return CPe[t]||null}clone(){return new vB({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],Fa.prototype,"contentType",void 0),u([d()],Fa.prototype,"exifInfo",void 0),u([d({readOnly:!0})],Fa.prototype,"orientationInfo",null),u([d({type:mr})],Fa.prototype,"id",void 0),u([d({type:String})],Fa.prototype,"globalId",void 0),u([d({type:String})],Fa.prototype,"keywords",void 0),u([d({type:String})],Fa.prototype,"name",void 0),u([d({json:{read:!1}})],Fa.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],Fa.prototype,"parentObjectId",void 0),u([d({type:mr})],Fa.prototype,"size",void 0),u([d({json:{read:!1}})],Fa.prototype,"url",void 0),Fa=vB=u([P("esri.layers.support.AttachmentInfo")],Fa);const fue=Fa;var _B;let Qn=_B=class extends ve{constructor(e){super(e),this.attachmentTypes=null,this.attachmentsWhere=null,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new _B(se({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],Qn.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],Qn.prototype,"attachmentsWhere",void 0),u([d({type:[String],json:{write:!0}})],Qn.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],Qn.prototype,"globalIds",void 0),u([d({json:{write:!0}})],Qn.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Qn.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],Qn.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Qn.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],Qn.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Qn.prototype,"start",void 0),u([Ge("start"),Ge("num")],Qn.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Qn.prototype,"where",void 0),Qn=_B=u([P("esri.rest.support.AttachmentQuery")],Qn),Qn.from=ns(Qn);const tD=Qn,RPe="esri.widgets.Feature.support.featureUtils",EY=he.getLogger(RPe),OPe=/href=(""|'')/gi,MPe=/(\{([^\{\r\n]+)\})/g,PPe=/\'/g,mue=/^\s*expression\//i,IPe=/(\n)/gi,$Pe=/[\u00A0-\u9999<>\&]/gim,DPe=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,LPe=/^(?:mailto:|tel:)/,gue="relationships/",bB=_G("short-date-short-time");function yue(e){if(!O(e))return e.get("sourceLayer")||e.get("layer")}async function iD(e,t){return typeof e=="function"?e.call(null,t):e}function vue(e=""){if(e)return!LPe.test(e.trim().toLowerCase())}function _ue(e){return!!e&&mue.test(e)}function NPe(e,t){if(!_ue(t)||!e)return null;const i=t.replace(mue,"").toLowerCase();let r;return e.some(s=>s.name.toLowerCase()===i&&(r=s,!0)),r}function bue(e,t){const i=NPe(t,e==null?void 0:e.fieldName);return i?i.title||null:e?e.label||e.fieldName:null}function FPe(e,t){const i=t.get(e.toLowerCase());return`{${i&&i.fieldName||e}}`}function UPe(e){return e.replace(OPe,"")}function rD(e,t){const i=M7(t,e);return i?i.name:e}function kPe(e,t){return e&&e.map(i=>rD(i,t))}function M7(e,t){return e&&typeof e.getField=="function"?e.getField(t):null}function wue(e){return`${e}`.trim()}function R_({attributes:e,globalAttributes:t,layer:i,text:r,expressionAttributes:s,fieldInfoMap:n}){return r?wB({formattedAttributes:t,template:GPe(r,I(I(I({},t),s),e),i),fieldInfoMap:n}):""}function wB({formattedAttributes:e,template:t,fieldInfoMap:i}){return wue(UPe(ap(ap(t,r=>FPe(r,i)),e)))}function zPe(e,t,i=!1){const r=t[e];if(typeof r=="string"){const s="%27",n=(i?encodeURIComponent(r):r).replace(PPe,s);t[e]=n}}function BPe(e,t=!1){const i=I({},e);return Object.keys(i).forEach(r=>zPe(r,i,t)),i}function VPe(e,t,i){const r=(t=wue(t))&&t[0]!=="{";return ap(e,BPe(i,r))}function xB(e,t){return e.replace(MPe,(i,r,s)=>{const n=M7(t,s);return n?`{${n.name}}`:r})}function GPe(e,t,i){const r=xB(e,i);return r&&r.replace(DPe,(s,n,o)=>VPe(s,n||o,t))}function jPe(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const i=Number(e);if(!isNaN(i))return i}return e}function HPe(e){return(e==null?void 0:e.type)==="feature"}function qPe(e){return(e==null?void 0:e.type)==="map-image"}function WPe(e){return!(e==null||!e.layer)}function xue(e,t){const i=t.fieldInfos,r=t.fieldName,s=Tue(i,r),n=s==null?void 0:s.clone(),o=t.preventPlacesFormatting,a=t.layer,l=M7(a,r);if(n&&(l==null?void 0:l.type)==="date"){const h=n.format||new oA;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=HPe(a)&&a.datesInUnknownTimezone||WPe(a)&&qPe(a.layer)&&a.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,n.format=h}const c=n&&n.format;return typeof(e=jPe(e,c))=="string"||e==null||c==null?PR(e):o?fm(e,me(I({},ooe(c)),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(e)}function Tue(e,t){if(!e||!e.length||!t)return;const i=t.toLowerCase();let r;return e.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==i)&&(r=s,!0)),r}function XPe({fieldName:e,graphic:t,layer:i}){if(Wf(e)||!i||typeof i.getFeatureType!="function")return null;const{typeIdField:r}=i;if(!r||e!==r)return null;const s=i.getFeatureType(t);return s?s.name:null}function YPe({fieldName:e,value:t,graphic:i,layer:r}){if(Wf(e)||!r||typeof r.getFieldDomain!="function")return null;const s=r.getFieldDomain(e,{feature:i});return s&&s.type==="coded-value"?s.getName(t):null}function ZPe(e,t){const{creatorField:i,creationDateField:r,editorField:s,editDateField:n}=e;if(!t)return;const o=t[n];if(typeof o=="number"){const l=t[s];return{type:"edit",date:pm(o,bB),user:l}}const a=t[r];if(typeof a=="number"){const l=t[i];return{type:"create",date:pm(a,bB),user:l}}return null}function QPe(e,t){const i=new Map;return e&&e.forEach(r=>{const s=rD(r.fieldName,t);r.fieldName=s,i.set(s.toLowerCase(),r)}),i}function AY(e){const t=[];if(!e)return t;const{fieldInfos:i,content:r}=e;return i&&t.push(...i),r&&Array.isArray(r)&&r.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&t.push(...n)}}),t}function P7(e){return e.replace($Pe,t=>`&#${t.charCodeAt(0)};`)}function PR(e){return typeof e=="string"?e.replace(IPe,'<br class="esri-text-new-line" />'):e}function JPe(e){const{value:t,fieldName:i,fieldInfos:r,fieldInfoMap:s,layer:n,graphic:o}=e;if(t==null)return"";const a=YPe({fieldName:i,value:t,graphic:o,layer:n});if(a)return a;const l=XPe({fieldName:i,graphic:o,layer:n});if(l)return l;if(s.get(i.toLowerCase()))return xue(t,{fieldInfos:r,fieldName:i,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(i)?pm(t,bB):PR(t)}function G4({fieldInfos:e,attributes:t,layer:i,graphic:r,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>r3e(o,a)),Object.keys(t).forEach(a=>{const l=t[a];o[a]=JPe({fieldName:a,fieldInfos:e,fieldInfoMap:s,layer:i,value:l,graphic:r})}),o}async function KPe(e,t){var i,r;const{layer:s,graphic:n,outFields:o,objectIds:a,returnGeometry:l,spatialReference:c}=e,h=a[0];if(typeof h!="number"&&typeof h!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",g={layer:s,graphic:n,objectId:h,requiredFields:o};return EY.warn(f,g),null}if((i=s.capabilities)==null||(r=i.operations)==null||!r.supportsQuery){const f="The specified layer cannot be queried. The following fields will not be available.",g={layer:s,graphic:n,requiredFields:o,returnGeometry:l};return EY.warn(f,g),null}const p=s.createQuery();return p.objectIds=a,p.outFields=o!=null&&o.length?o:[s.objectIdField],p.returnGeometry=!!l,p.returnZ=!!l,p.returnM=!!l,p.outSpatialReference=c,(await s.queryFeatures(p,t)).features[0]}async function e3e(e){var t;if((t=e.expressionInfos)==null||!t.length)return!1;const i=await cp(),{arcadeUtils:{hasGeometryFunctions:r}}=i;return r(e)}async function t3e({graphic:e,popupTemplate:t,layer:i,spatialReference:r},s){if(!i||!t||(typeof i.load=="function"&&await i.load(s),!e.attributes))return;const n=e.attributes[i.objectIdField];if(n==null)return;const o=[n],a=await t.getRequiredFields(i.fieldsIndex),l=NTe(a,e),c=l?[]:a,h=t.returnGeometry||await e3e(t);if(l&&!h)return;const p=await KPe({layer:i,graphic:e,outFields:c,objectIds:o,returnGeometry:h,spatialReference:r},s);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes=I(I({},e.attributes),p.attributes)))}function Wf(e=""){return!!e&&e.indexOf(gue)!==-1}function i3e(e){return e?`${gue}${e.layerId}/${e.fieldName}`:""}function CY({attributes:e,graphic:t,relatedInfo:i}){e&&t&&i&&Object.keys(t.attributes).forEach(r=>{const s=i3e({layerId:i.relation.id.toString(),fieldName:r});e[s]=t.attributes[r]})}function r3e(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach(i=>CY({attributes:e,graphic:i,relatedInfo:t})),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach(i=>CY({attributes:e,graphic:i,relatedInfo:t})))}const RY=e=>{if(!e)return!1;const t=e.toUpperCase();return t.indexOf("CURRENT_TIMESTAMP")>-1||t.indexOf("CURRENT_DATE")>-1||t.indexOf("CURRENT_TIME")>-1},Sue=({layer:e,method:t,query:i,definitionExpression:r})=>{var s,n;if((s=e.capabilities)==null||(n=s.query)==null||!n.supportsCacheHint||t==="attachments")return;const o=_(i.where)&&i.where,a=_(i.geometry)&&i.geometry;RY(r)||RY(o)||(a==null?void 0:a.type)==="extent"||i.resultType==="tile"||(i.cacheHint=!0)},s3e=({query:e,layer:t,method:i})=>{Sue({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},n3e=({queryPayload:e,layer:t,method:i})=>{Sue({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},OY={editing:!1,operations:{add:!0,update:!0,delete:!0}},Eue=pt.ofType(fue),o3e="graphic.layer.capabilities.operations.supportsResizeAttachments";let Ju=class extends aT{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities=I({},OY),this.activeAttachmentInfo=null,this.attachmentInfos=new Eue,this.graphic=null,this.mode="view",this.handles.add([Wt(this,"graphic",()=>this._graphicChanged())])}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return I(I({},OY),e)}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){return this.get(o3e)||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t}=this;if(!e||typeof e.queryAttachments!="function")throw new Q("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getFeatureId(),r=new tD({objectIds:[i],returnMetadata:!0}),s=[],n=e.queryAttachments(r).then(a=>a[i]||s).catch(()=>s);this._getAttachmentsPromise=n,this.notifyChange("state");const o=await n;return t.removeAll(),o.length&&t.addMany(o),this._getAttachmentsPromise=null,this.notifyChange("state"),o}async addAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new Q("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!s.operations.add)throw new Q("invalid-abilities","addAttachment(): add abilities are required.");if(!t||typeof t.addAttachment!="function")throw new Q("invalid-layer","addAttachment(): A valid layer is required.");const n=t.addAttachment(r,e).then(a=>this._queryAttachment(a.objectId)),o=await n;return i.add(o),o}async deleteAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new Q("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!s.operations.delete)throw new Q("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new Q("invalid-layer","deleteAttachment(): A valid layer is required.");const n=t.deleteAttachments(r,[e.id]).then(()=>e),o=await n;return i.remove(o),o}async updateAttachment(e,t=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:r,graphic:s,abilities:n}=this;if(!e)throw new Q("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new Q("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!n.operations.update)throw new Q("invalid-abilities","updateAttachment(): Update abilities are required.");const o=r.findIndex(c=>c===t);if(!i||typeof i.updateAttachment!="function")throw new Q("invalid-layer","updateAttachment(): A valid layer is required.");const a=i.updateAttachment(s,t.id,e).then(c=>this._queryAttachment(c.objectId)),l=await a;return r.splice(o,1,l),l}async _queryAttachment(e){if(!e)throw new Q("invalid-attachment-id","Could not query attachment.");const{_attachmentLayer:t}=this,i=this._getFeatureId(),r=new tD({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return t.queryAttachments(r).then(s=>s[i][0])}_getFeatureId(){const{_attachmentLayer:e,graphic:t}=this;if(!e||!t)return null;const{objectIdField:i}=e,{attributes:r}=t;return r&&r[i]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,t=yue(e);this._attachmentLayer=t?t.type==="scene"&&_(t.associatedLayer)?t.associatedLayer:t:null}};u([d()],Ju.prototype,"abilities",void 0),u([It("abilities")],Ju.prototype,"castAbilities",null),u([d()],Ju.prototype,"activeAttachmentInfo",void 0),u([d({readOnly:!0,type:Eue})],Ju.prototype,"attachmentInfos",void 0),u([d({type:Bo})],Ju.prototype,"graphic",void 0),u([d()],Ju.prototype,"mode",void 0),u([d({readOnly:!0})],Ju.prototype,"state",null),u([d({readOnly:!0})],Ju.prototype,"supportsResizeAttachments",null),Ju=u([P("esri.widgets.Attachments.AttachmentsViewModel")],Ju);const I7=Ju;function a3e(e){const t=e.toLowerCase();return t==="image/bmp"||t==="image/emf"||t==="image/exif"||t==="image/gif"||t==="image/x-icon"||t==="image/jpeg"||t==="image/png"||t==="image/tiff"||t==="image/x-wmf"}function l3e(e){const t=ui("esri/themes/base/images/files/");return e?e==="text/plain"?`${t}text-32.svg`:e==="application/pdf"?`${t}pdf-32.svg`:e==="text/csv"?`${t}csv-32.svg`:e==="application/gpx+xml"?`${t}gpx-32.svg`:e==="application/x-dwf"?`${t}cad-32.svg`:e==="application/postscript"||e==="application/json"||e==="text/xml"||e==="model/vrml"?`${t}code-32.svg`:e==="application/x-zip-compressed"||e==="application/x-7z-compressed"||e==="application/x-gzip"||e==="application/x-tar"||e==="application/x-gtar"||e==="application/x-bzip2"||e==="application/gzip"||e==="application/x-compress"||e==="application/x-apple-diskimage"||e==="application/x-rar-compressed"||e==="application/zip"?`${t}zip-32.svg`:e.indexOf("image/")!==-1?`${t}image-32.svg`:e.indexOf("audio/")!==-1?`${t}sound-32.svg`:e.indexOf("video/")!==-1?`${t}video-32.svg`:e.indexOf("msexcel")!==-1||e.indexOf("ms-excel")!==-1||e.indexOf("spreadsheetml")!==-1?`${t}excel-32.svg`:e.indexOf("msword")!==-1||e.indexOf("ms-word")!==-1||e.indexOf("wordprocessingml")!==-1?`${t}word-32.svg`:e.indexOf("powerpoint")!==-1||e.indexOf("presentationml")!==-1?`${t}report-32.svg`:`${t}generic-32.svg`:`${t}generic-32.svg`}function ul(e){return function(t,i){t.hasOwnProperty("_messageBundleProps")||(t._messageBundleProps=t._messageBundleProps?t._messageBundleProps.slice():[]),t._messageBundleProps.push({bundlePath:e,propertyName:i})}}var c3e=function(e){return{vnodeSelector:"",properties:void 0,children:void 0,text:e.toString(),domNode:null}},Aue=function(e,t){for(var i=0,r=e.length;i<r;i++){var s=e[i];Array.isArray(s)?Aue(s,t):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=c3e(s)),t.push(s))}},u3e=function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(i.length===1&&typeof i[0]=="string")return{vnodeSelector:e,properties:t||void 0,children:void 0,text:i[0],domNode:null};var s=[];return Aue(i,s),{vnodeSelector:e,properties:t||void 0,children:s,text:void 0,domNode:null}};function le(e,t,...i){return typeof e!="function"||O7(e)?u3e(e,t,...i):e(t,...i)}const MY={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},Ye={base:"esri-attachments",loaderContainer:"esri-attachments__loader-container",loader:"esri-attachments__loader",fadeIn:"esri-attachments--fade-in",container:"esri-attachments__container",containerList:"esri-attachments__container--list",containerPreview:"esri-attachments__container--preview",actions:"esri-attachments__actions",deleteButton:"esri-attachments__delete-button",addAttachmentButton:"esri-attachments__add-attachment-button",errorMessage:"esri-attachments__error-message",items:"esri-attachments__items",item:"esri-attachments__item",itemButton:"esri-attachments__item-button",itemMask:"esri-attachments__item-mask",itemMaskIcon:"esri-attachments__item-mask--icon",itemImage:"esri-attachments__image",itemImageResizable:"esri-attachments__image--resizable",itemLabel:"esri-attachments__label",itemFilename:"esri-attachments__filename",itemChevronIcon:"esri-attachments__item-chevron-icon",itemLink:"esri-attachments__item-link",itemLinkOverlay:"esri-attachments__item-link-overlay",itemLinkOverlayIcon:"esri-attachments__item-link-overlay-icon",itemEditIcon:"esri-attachments__item-edit-icon",itemAddIcon:"esri-attachments__item-add-icon",itemAddButton:"esri-attachments__item-add-button",formNode:"esri-attachments__form-node",fileFieldset:"esri-attachments__file-fieldset",fileLabel:"esri-attachments__file-label",fileName:"esri-attachments__file-name",fileInput:"esri-attachments__file-input",metadata:"esri-attachments__metadata",metadataFieldset:"esri-attachments__metadata-fieldset",progressBar:"esri-attachments__progress-bar",esriWidget:"esri-widget",esriButton:"esri-button",buttonDisabled:"esri-button--disabled",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",esriButtonThird:"esri-button--third",esriButtonSmall:"esri-button--small",esriButtonHalf:"esri-button--half",empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},j4=window.CSS;let bo=class extends Ra{constructor(e,t){super(e,t),this.abilities=null,this.displayType="auto",this.graphic=null,this.label=void 0,this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=new I7,this.visibleElements=I({},MY),this._supportsImageOrientation=j4&&j4.supports&&j4.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.own(mp(this,"viewModel.attachmentInfos","change",()=>this.scheduleRender()),Wt(this,"viewModel.mode",()=>this._modeChanged()))}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}castVisibleElements(e){return I(I({},MY),e)}addAttachment(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new Q("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}render(){const{submitting:e,viewModel:t}=this,{state:i}=t;return le("div",{class:this.classes(Ye.base,Ye.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?le("div",{key:"error-message",class:Ye.errorMessage},e.message):null}renderAttachments(){const{mode:e,activeAttachmentInfo:t}=this.viewModel;return e==="add"?this.renderAddForm():e==="edit"?this.renderDetailsForm(t):this.renderAttachmentContainer()}renderLoading(){return le("div",{class:Ye.loaderContainer,key:"loader"},le("div",{class:Ye.loader}))}renderProgressBar(){return this.visibleElements.progressBar?le("div",{class:Ye.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:t}=this,i=e||!t,r=this.visibleElements.cancelAddButton?le("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(Ye.esriButton,Ye.esriButtonTertiary,Ye.esriButtonSmall,Ye.esriButtonHalf,e&&Ye.buttonDisabled)},this.messages.cancel):null,s=this.visibleElements.addSubmitButton?le("button",{type:"submit",disabled:i,class:this.classes(Ye.esriButton,Ye.esriButtonSecondary,Ye.esriButtonSmall,Ye.esriButtonHalf,{[Ye.buttonDisabled]:i})},this.messages.add):null,n=t?le("span",{key:"file-name",class:Ye.fileName},t.name):null,o=le("form",{bind:this,afterCreate:dB,afterRemoved:rY,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},le("fieldset",{class:Ye.fileFieldset},n,le("label",{class:this.classes(Ye.fileLabel,Ye.esriButton,Ye.esriButtonSecondary)},t?this.messages.changeFile:this.messages.selectFile,le("input",{class:Ye.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),s,r);return le("div",{key:"add-form-container",class:Ye.formNode},o)}renderDetailsForm(e){const{visibleElements:t,viewModel:i,selectedFile:r,submitting:s}=this,{contentType:n,size:o,url:a}=e,{abilities:l}=i,c=s||!r,h=l.editing&&l.operations.delete&&t.deleteButton?le("button",{key:"delete-button",type:"button",disabled:s,bind:this,onclick:S=>this._submitDeleteAttachment(S,e),class:this.classes(Ye.esriButton,Ye.esriButtonSmall,Ye.esriButtonTertiary,Ye.deleteButton,{[Ye.buttonDisabled]:s})},this.messages.delete):null,p=l.editing&&l.operations.update&&t.updateButton?le("button",{disabled:c,key:"update-button",type:"submit",class:this.classes(Ye.esriButton,Ye.esriButtonSmall,Ye.esriButtonThird,{[Ye.buttonDisabled]:c})},this.messages.update):null,f=this.visibleElements.cancelUpdateButton?le("button",{disabled:s,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(Ye.esriButton,Ye.esriButtonSmall,Ye.esriButtonTertiary,Ye.esriButtonThird,{[Ye.buttonDisabled]:s})},this.messages.cancel):null,g=r?le("span",{key:"file-name",class:Ye.fileName},r.name):null,y=l.editing&&l.operations.update?le("fieldset",{key:"file",class:Ye.fileFieldset},g,le("label",{class:this.classes(Ye.fileLabel,Ye.esriButton,Ye.esriButtonSecondary)},this.messages.changeFile,le("input",{class:Ye.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,v=le("fieldset",{key:"size",class:Ye.metadataFieldset},le("label",null,SPe(this.messagesUnits,o))),b=le("fieldset",{key:"content-type",class:Ye.metadataFieldset},le("label",null,n)),w=le("form",{bind:this,afterCreate:dB,afterRemoved:rY,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},le("div",{class:Ye.metadata},v,b),y,le("div",{class:Ye.actions},h,f,p));return le("div",{key:"edit-form-container",class:Ye.formNode},le("a",{class:Ye.itemLink,href:a,rel:"noreferrer",target:"_blank"},this.renderImageMask({attachmentInfo:e,size:400}),le("div",{class:Ye.itemLinkOverlay},le("span",{class:Ye.itemLinkOverlayIcon},le("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},le("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),le("path",{fill:"none",d:"M0 0h32v32H0z"}))))),w)}renderImageMask({attachmentInfo:e,size:t}){const{supportsResizeAttachments:i}=this.viewModel,{contentType:r,name:s,url:n}=e,o=i&&a3e(r),a=this._getCSSTransform(e,o),l=a?{transform:a,"image-orientation":"none"}:{},c=n.indexOf("?")===-1?"?":"&",h=o?`${n}${c}w=${t}`:l3e(r),p={[Ye.itemMaskIcon]:!o},f={[Ye.itemImageResizable]:i};return le("div",{class:this.classes(p,Ye.itemMask)},le("img",{styles:l,alt:s,src:h,class:this.classes(f,Ye.itemImage)}))}renderAttachmentInfo({attachmentInfo:e,displayType:t}){const{viewModel:i}=this,{abilities:r}=i,{name:s,url:n}=e,o=this.renderImageMask({attachmentInfo:e,size:t==="list"?48:400}),a=r.editing?le("span",{"aria-hidden":"true",class:this.classes(Ye.itemChevronIcon,Py(this.container)?Ye.iconLeft:Ye.iconRight)}):null,l=[o,le("label",{class:Ye.itemLabel},le("span",{class:Ye.itemFilename},s||this.messages.noTitle),a)],c=r.editing?le("button",{key:"details-button",bind:this,class:Ye.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},l):le("a",{key:"details-link",class:Ye.itemButton,href:n,target:"_blank"},l);return le("li",{class:Ye.item,key:e},c)}renderAttachmentContainer(){const{effectiveDisplayType:e,viewModel:t,visibleElements:i}=this,{attachmentInfos:r,abilities:s}=t,n=r&&r.length,o={[Ye.containerList]:e!=="preview",[Ye.containerPreview]:e==="preview"},a=s.editing&&s.operations.add&&i.addButton?le("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(Ye.esriButton,Ye.esriButtonTertiary,Ye.addAttachmentButton),type:"button"},le("span",{"aria-hidden":"true",class:this.classes(Ye.itemAddIcon,Ye.iconPlus)}),this.messages.add):null,l=n?le("ul",{class:Ye.items},r.toArray().map(c=>this.renderAttachmentInfo({attachmentInfo:c,displayType:e}))):le("div",{class:Ye.empty},this.messages.noAttachments);return le("div",{key:"attachments-container",class:this.classes(Ye.container,o)},l,a)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const t=e.target,i=t&&t.files&&t.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,t){e.preventDefault(),this.deleteAttachment(t)}_submitAddAttachment(e){e.preventDefault(),this.addAttachment()}_submitUpdateAttachment(e){e.preventDefault(),this.updateAttachment()}_startEditAttachment(e){const{viewModel:t}=this;t.activeAttachmentInfo=e,t.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e,t){const{orientationInfo:i}=e;return!this._supportsImageOrientation&&t&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};u([mt("viewModel.abilities")],bo.prototype,"abilities",void 0),u([d()],bo.prototype,"displayType",void 0),u([d({readOnly:!0})],bo.prototype,"effectiveDisplayType",null),u([mt("viewModel.graphic")],bo.prototype,"graphic",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],bo.prototype,"label",void 0),u([d(),ul("esri/widgets/Attachments/t9n/Attachments")],bo.prototype,"messages",void 0),u([d(),ul("esri/core/t9n/Units")],bo.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],bo.prototype,"selectedFile",void 0),u([d({readOnly:!0})],bo.prototype,"submitting",void 0),u([d({readOnly:!0})],bo.prototype,"error",void 0),u([d({type:I7})],bo.prototype,"viewModel",void 0),u([d()],bo.prototype,"visibleElements",void 0),u([It("visibleElements")],bo.prototype,"castVisibleElements",null),bo=u([P("esri.widgets.Attachments")],bo);const h3e=bo;let pE=class extends I7{constructor(e){super(e),this.description=null,this.title=null}};u([d()],pE.prototype,"description",void 0),u([d()],pE.prototype,"title",void 0),pE=u([P("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],pE);const $7=pE,d3e={heading:"esri-widget__heading"};function D7(e,t){const i=p3e(e.level),r=`h${i}`;return delete e.level,le(r,me(I({},e),{class:Pce(d3e.heading,e.class),role:"heading","aria-level":String(i)}),t)}function p3e(e){return ze(Math.ceil(e),1,6)}const H4={base:"esri-feature-element-info",title:"esri-feature-element-info__title",description:"esri-feature-element-info__description"};let hw=class extends Ra{constructor(e,t){super(e,t),this.description=null,this.headingLevel=2,this.title=null}render(){return le("div",{class:H4.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:e}=this;return e?le(D7,{level:this.headingLevel,class:H4.title},e):null}renderDescription(){const{description:e}=this;return e?le("div",{key:"description",class:H4.description},e):null}};u([d()],hw.prototype,"description",void 0),u([d()],hw.prototype,"headingLevel",void 0),u([d()],hw.prototype,"title",void 0),hw=u([P("esri.widgets.Feature.support.FeatureElementInfo")],hw);const L7=hw,f3e={base:"esri-feature-attachments"};let Cd=class extends Ra{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attachmentsWidget=new h3e,this.description=null,this.displayType=null,this.graphic=null,this.headingLevel=2,this.title=null,this.viewModel=new $7}initialize(){this._featureElementInfo=new L7,Wt(this,["viewModel.description","viewModel.title","headingLevel"],()=>this._setupFeatureElementInfo()),Wt(this,"viewModel.graphic",e=>this.attachmentsWidget.graphic=e)}destroy(){this.attachmentsWidget.destroy(),this._featureElementInfo.destroy()}render(){var e;const{attachmentsWidget:t}=this;return le("div",{class:f3e.base},(e=this._featureElementInfo)==null?void 0:e.render(),t==null?void 0:t.render())}_setupFeatureElementInfo(){const{description:e,title:t,headingLevel:i}=this;this._featureElementInfo.set({description:e,title:t,headingLevel:i})}};u([d({readOnly:!0})],Cd.prototype,"attachmentsWidget",void 0),u([mt("viewModel.description")],Cd.prototype,"description",void 0),u([mt("attachmentsWidget.displayType")],Cd.prototype,"displayType",void 0),u([mt("viewModel.graphic")],Cd.prototype,"graphic",void 0),u([d()],Cd.prototype,"headingLevel",void 0),u([mt("viewModel.title")],Cd.prototype,"title",void 0),u([d({type:$7})],Cd.prototype,"viewModel",void 0),Cd=u([P("esri.widgets.Feature.FeatureAttachments")],Cd);const m3e=Cd;let Lg=class extends Rm(we){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(Wt(this,"creator",t=>{this._destroyContent(),this._createContent(t)}))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:i}=this;e&&(iD(i,{graphic:t}).catch(()=>null),this._set("created",null))}async _createContent(e){const{graphic:t}=this,i=iD(e,{graphic:t}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const r=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};u([d({readOnly:!0})],Lg.prototype,"created",void 0),u([d()],Lg.prototype,"creator",void 0),u([d()],Lg.prototype,"destroyer",void 0),u([d({type:Bo})],Lg.prototype,"graphic",void 0),u([d({readOnly:!0})],Lg.prototype,"state",null),Lg=u([P("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Lg);const sD=Lg;function Kc(){return function(e,t){if(!e[t])throw new TypeError(`Cannot auto bind undefined function '${t}'`);return{value:y3e(e[t])}}}function g3e(e){const{type:t}=e;return e instanceof KeyboardEvent||t==="keyup"||t==="keydown"||t==="keypress"}function y3e(e){return function(t,...i){g3e(t)?tMe(t.key)&&(t.preventDefault(),t.stopPropagation(),t.target.click()):e.call(this,t,...i)}}function v3e(e){return e.split(",").map(t=>t.trim())}function _3e(e){return t=>{t.hasOwnProperty("_delegatedEventNames")||(t._delegatedEventNames=t._delegatedEventNames?t._delegatedEventNames.slice():[]);const i=t._delegatedEventNames,r=Array.isArray(e)?e:v3e(e);i.push(...r)}}function Cue(e){return e&&typeof e.render=="function"}function b3e(e){return e&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}const q4={base:"esri-feature-content",loaderContainer:"esri-feature-content__loader-container",loader:"esri-feature-content__loader"};let dw=class extends Ra{constructor(e,t){super(e,t),this.creator=null,this.graphic=null,this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(r=>{vue(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}renderLoading(){return le("div",{class:q4.loaderContainer,key:"loader"},le("div",{class:q4.loader}))}renderCreated(){var e;const t=(e=this.viewModel)==null?void 0:e.created;return t?t instanceof HTMLElement?le("div",{key:t,bind:t,afterCreate:this._attachToNode}):Cue(t)?le("div",{key:t},!t.destroyed&&t.render()):le("div",{key:t,innerHTML:t,afterCreate:this._addTargetToAnchors}):null}render(){var e;const t=(e=this.viewModel)==null?void 0:e.state;return le("div",{class:q4.base},t==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(e){const t=this;e.appendChild(t)}};u([mt("viewModel.creator")],dw.prototype,"creator",void 0),u([mt("viewModel.graphic")],dw.prototype,"graphic",void 0),u([d({type:sD})],dw.prototype,"viewModel",void 0),dw=u([P("esri.widgets.Feature.FeatureContent")],dw);const z3=dw;let cf=class extends we{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,i=[];return t==null||t.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const s=r.clone();s.label=bue(s,e),i.push(s)}),i}};u([d()],cf.prototype,"attributes",void 0),u([d({type:[foe]})],cf.prototype,"expressionInfos",void 0),u([d()],cf.prototype,"description",void 0),u([d({type:[SR]})],cf.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],cf.prototype,"formattedFieldInfos",null),u([d()],cf.prototype,"title",void 0),cf=u([P("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],cf);const _N=cf,w3e=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function x3e(e){let t=null;return w3e.some(i=>(i.pattern.test(e)&&(t=i),!!t)),t}function T3e(e,t){if(typeof t!="string"||!t)return t;const i=x3e(t);if(!i)return t;const r=t.match(i.pattern),s=r&&r[2],n=ap(ap(i.label,{messages:e,hierPart:s}),{appName:i.appName}),o=i.target?` target="${i.target}"`:"",a=i.target==="_blank"?' rel="noreferrer"':"";return t.replace(i.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const VS={base:"esri-feature-fields",fieldHeader:"esri-feature-fields__field-header",fieldData:"esri-feature-fields__field-data",fieldDataDate:"esri-feature-fields__field-data--date",esriTable:"esri-widget__table"};let Ku=class extends Ra{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attributes=null,this.description=null,this.expressionInfos=null,this.fieldInfos=null,this.title=null,this.viewModel=new _N,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new L7,Wt(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo())}destroy(){this._featureElementInfo.destroy()}renderFieldInfo(e,t){const{attributes:i}=this.viewModel,r=e.fieldName,s=e.label||r,n=i?i[r]==null?"":i[r]:"",o=!(!e.format||!e.format.dateFormat),a=typeof n=="number"&&!o?this._forceLTR(n):T3e(this.messagesURIUtils,n),l={[VS.fieldDataDate]:o};return le("tr",{key:`fields-element-info-row-${r}-${t}`},le("th",{key:`fields-element-info-row-header-${r}-${t}`,class:VS.fieldHeader,innerHTML:s}),le("td",{key:`fields-element-info-row-data-${r}-${t}`,class:this.classes(VS.fieldData,l),innerHTML:a}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?le("table",{class:VS.esriTable,summary:this.messages.fieldsSummary},le("tbody",null,e.map((t,i)=>this.renderFieldInfo(t,i)))):null}render(){var e;return le("div",{class:VS.base},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderFields())}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_forceLTR(e){return`&lrm;${e}`}};u([mt("viewModel.attributes")],Ku.prototype,"attributes",void 0),u([mt("viewModel.description")],Ku.prototype,"description",void 0),u([mt("viewModel.expressionInfos")],Ku.prototype,"expressionInfos",void 0),u([mt("viewModel.fieldInfos")],Ku.prototype,"fieldInfos",void 0),u([mt("viewModel.title")],Ku.prototype,"title",void 0),u([d({type:_N})],Ku.prototype,"viewModel",void 0),u([d(),ul("esri/widgets/Feature/t9n/Feature")],Ku.prototype,"messages",void 0),u([d(),ul("esri/widgets/support/t9n/uriUtils")],Ku.prototype,"messagesURIUtils",void 0),Ku=u([P("esri.widgets.Feature.FeatureFields")],Ku);const Rue=Ku,PY={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},S3e={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function E3e(e,t){const i=new Date(e,t+1,1);return i.setDate(0),i.getDate()}function W_(e,t,i){const r=new Date(e.getTime());if(t&&i){const s=S3e[i],{getter:n,setter:o,multiplier:a}=s;if(i==="months"){const l=E3e(r.getFullYear(),r.getMonth()+t);r.getDate()>l&&r.setDate(l)}r[o](r[n]()+t*a)}return r}function IY(e,t){switch(t){case"milliseconds":return new Date(e.getTime());case"seconds":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());case"minutes":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes());case"hours":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours());case"days":return new Date(e.getFullYear(),e.getMonth(),e.getDate());case"weeks":return new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());case"months":return new Date(e.getFullYear(),e.getMonth(),1);case"years":return new Date(e.getFullYear(),0,1);case"decades":return new Date(e.getFullYear()-e.getFullYear()%10,0,1);case"centuries":return new Date(e.getFullYear()-e.getFullYear()%100,0,1);default:return new Date}}function A3e(e,t,i){return e===0?0:e*PY[t]/PY[i]}var eh;let zl=eh=class extends ve{constructor(e){super(e),this.end=null,this.start=null}static get allTime(){return $Y}static get empty(){return C3e}readEnd(e,t){return t.end!=null?new Date(t.end):null}writeEnd(e,t){t.end=e?e.getTime():null}get isAllTime(){return this.equals(eh.allTime)}get isEmpty(){return this.equals(eh.empty)}readStart(e,t){return t.start!=null?new Date(t.start):null}writeStart(e,t){t.start=e?e.getTime():null}clone(){return new eh({end:this.end,start:this.start})}equals(e){if(!e)return!1;const t=_(this.start)?this.start.getTime():this.start,i=_(this.end)?this.end.getTime():this.end,r=_(e.start)?e.start.getTime():e.start,s=_(e.end)?e.end.getTime():e.end;return t===r&&i===s}expandTo(e){if(this.isEmpty||this.isAllTime)return this.clone();const t=oo(this.start,r=>IY(r,e)),i=oo(this.end,r=>W_(IY(r,e),1,e));return new eh({start:t,end:i})}intersection(e){if(!e)return this.clone();if(this.isEmpty||e.isEmpty)return eh.empty;if(this.isAllTime)return e.clone();if(e.isAllTime)return this.clone();const t=Qa(this.start,-1/0,a=>a.getTime()),i=Qa(this.end,1/0,a=>a.getTime()),r=Qa(e.start,-1/0,a=>a.getTime()),s=Qa(e.end,1/0,a=>a.getTime());let n,o;if(r>=t&&r<=i?n=r:t>=r&&t<=s&&(n=t),i>=r&&i<=s?o=i:s>=t&&s<=i&&(o=s),!isNaN(n)&&!isNaN(o)){const a=new eh;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return eh.empty}offset(e,t){if(this.isEmpty||this.isAllTime)return this.clone();const i=new eh,{start:r,end:s}=this;return _(r)&&(i.start=W_(r,e,t)),_(s)&&(i.end=W_(s,e,t)),i}union(e){if(!e||e.isEmpty)return this.clone();if(this.isEmpty)return e.clone();if(this.isAllTime||e.isAllTime)return $Y.clone();const t=_(this.start)&&_(e.start)?new Date(Math.min(this.start.getTime(),e.start.getTime())):null,i=_(this.end)&&_(e.end)?new Date(Math.max(this.end.getTime(),e.end.getTime())):null;return new eh({start:t,end:i})}};u([d({type:Date,json:{write:{allowNull:!0}}})],zl.prototype,"end",void 0),u([Fe("end")],zl.prototype,"readEnd",null),u([Ge("end")],zl.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],zl.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],zl.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],zl.prototype,"start",void 0),u([Fe("start")],zl.prototype,"readStart",null),u([Ge("start")],zl.prototype,"writeStart",null),zl=eh=u([P("esri.TimeExtent")],zl);const $Y=new zl,C3e=new zl({start:void 0,end:void 0}),Ap=zl;var TB;let fE=TB=class extends ve{constructor(e){super(e),this.name=null,this.code=null}clone(){return new TB({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],fE.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],fE.prototype,"code",void 0),fE=TB=u([P("esri.layers.support.CodedValue")],fE);const R3e=fE,O3e=new si({inherited:"inherited",codedValue:"coded-value",range:"range"});let mE=class extends ve{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],mE.prototype,"name",void 0),u([ht(O3e)],mE.prototype,"type",void 0),mE=u([P("esri.layers.support.Domain")],mE);const bN=mE;var SB;let gE=SB=class extends bN{constructor(e){super(e),this.codedValues=null,this.type="coded-value"}getName(e){let t=null;if(this.codedValues){const i=String(e);this.codedValues.some(r=>(String(r.code)===i&&(t=r.name),!!t))}return t}clone(){return new SB({codedValues:se(this.codedValues),name:this.name})}};u([d({type:[R3e],json:{write:!0}})],gE.prototype,"codedValues",void 0),u([ht({codedValue:"coded-value"})],gE.prototype,"type",void 0),gE=SB=u([P("esri.layers.support.CodedValueDomain")],gE);const Oue=gE;var EB;let B3=EB=class extends bN{constructor(e){super(e),this.type="inherited"}clone(){return new EB}};u([ht({inherited:"inherited"})],B3.prototype,"type",void 0),B3=EB=u([P("esri.layers.support.InheritedDomain")],B3);const Mue=B3;var AB;let pw=AB=class extends bN{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new AB({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(e,t,i){t[i]=[this.minValue||0,e]}}}})],pw.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[0]},write:{target:"range",writer(e,t,i){t[i]=[e,this.maxValue||0]}}}})],pw.prototype,"minValue",void 0),u([ht({range:"range"})],pw.prototype,"type",void 0),pw=AB=u([P("esri.layers.support.RangeDomain")],pw);const Pue=pw,Iue={key:"type",base:bN,typeMap:{range:Pue,"coded-value":Oue,inherited:Mue}};function N7(e){if(!e||!e.type)return null;switch(e.type){case"range":return Pue.fromJSON(e);case"codedValue":return Oue.fromJSON(e);case"inherited":return Mue.fromJSON(e)}return null}const M3e=new si({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var CB;const P3e=new si({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let Ko=CB=class extends ve{constructor(e){super(e),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null}readDescription(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?i.value:null}readValueType(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?P3e.fromJSON(i.fieldValueType):null}clone(){return new CB({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})}};u([d({type:String,json:{write:!0}})],Ko.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],Ko.prototype,"defaultValue",void 0),u([d()],Ko.prototype,"description",void 0),u([Fe("description")],Ko.prototype,"readDescription",null),u([d({types:Iue,json:{read:{reader:N7},write:!0}})],Ko.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Ko.prototype,"editable",void 0),u([d({type:mr,json:{write:!0}})],Ko.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],Ko.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],Ko.prototype,"nullable",void 0),u([ht(M3e)],Ko.prototype,"type",void 0),u([d()],Ko.prototype,"valueType",void 0),u([Fe("valueType",["description"])],Ko.prototype,"readValueType",null),Ko=CB=u([P("esri.layers.support.Field")],Ko);const IR=Ko;var RB;let fw=RB=class extends ve{constructor(e){super(e),this.type="map-layer"}clone(){const{mapLayerId:e,gdbVersion:t}=this;return new RB({mapLayerId:e,gdbVersion:t})}};u([ht({mapLayer:"map-layer"})],fw.prototype,"type",void 0),u([d({type:mr,json:{write:!0}})],fw.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],fw.prototype,"gdbVersion",void 0),fw=RB=u([P("esri.layers.support.source.MapLayerSource")],fw);var OB;let uf=OB=class extends ve{constructor(e){super(e),this.type="query-table"}clone(){var e;const{workspaceId:t,query:i,oidFields:r,spatialReference:s,geometryType:n}=this,o={workspaceId:t,query:i,oidFields:r,spatialReference:(e=s==null?void 0:s.clone())!=null?e:void 0,geometryType:n};return new OB(o)}};u([ht({queryTable:"query-table"})],uf.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],uf.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],uf.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],uf.prototype,"oidFields",void 0),u([d({type:tt,json:{write:!0}})],uf.prototype,"spatialReference",void 0),u([ht(Hne)],uf.prototype,"geometryType",void 0),uf=OB=u([P("esri.layers.support.source.QueryTableDataSource")],uf);var MB;let mw=MB=class extends ve{constructor(e){super(e),this.type="raster"}clone(){const{workspaceId:e,dataSourceName:t}=this;return new MB({workspaceId:e,dataSourceName:t})}};u([ht({raster:"raster"})],mw.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],mw.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],mw.prototype,"workspaceId",void 0),mw=MB=u([P("esri.layers.support.source.RasterDataSource")],mw);var PB;let Rv=PB=class extends ve{constructor(e){super(e),this.type="table"}clone(){const{workspaceId:e,gdbVersion:t,dataSourceName:i}=this;return new PB({workspaceId:e,gdbVersion:t,dataSourceName:i})}};u([ht({table:"table"})],Rv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Rv.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],Rv.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],Rv.prototype,"dataSourceName",void 0),Rv=PB=u([P("esri.layers.support.source.TableDataSource")],Rv);var IB,$B;const I3e=po()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let Pl=IB=class extends ve{constructor(e){super(e),this.type="join-table"}readLeftTableSource(e,t,i){return DY()(e,t,i)}castLeftTableSource(e){return Fh(DB(),e)}readRightTableSource(e,t,i){return DY()(e,t,i)}castRightTableSource(e){return Fh(DB(),e)}clone(){var e,t;const{leftTableKey:i,rightTableKey:r,leftTableSource:s,rightTableSource:n,joinType:o}=this,a={leftTableKey:i,rightTableKey:r,leftTableSource:(e=s==null?void 0:s.clone())!=null?e:void 0,rightTableSource:(t=n==null?void 0:n.clone())!=null?t:void 0,joinType:o};return new IB(a)}};u([ht({joinTable:"join-table"})],Pl.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Pl.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],Pl.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],Pl.prototype,"leftTableSource",void 0),u([Fe("leftTableSource")],Pl.prototype,"readLeftTableSource",null),u([It("leftTableSource")],Pl.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],Pl.prototype,"rightTableSource",void 0),u([Fe("rightTableSource")],Pl.prototype,"readRightTableSource",null),u([It("rightTableSource")],Pl.prototype,"castRightTableSource",null),u([ht(I3e)],Pl.prototype,"joinType",void 0),Pl=IB=u([P("esri.layers.support.source.JoinTableDataSource")],Pl);let W4=null;function DY(){return W4||(W4=ZT({types:DB()})),W4}let X4=null;function DB(){return X4||(X4={key:"type",base:null,typeMap:{"data-layer":ql,"map-layer":fw}}),X4}const $3e={key:"type",base:null,typeMap:{"join-table":Pl,"query-table":uf,raster:mw,table:Rv}};let ql=$B=class extends ve{constructor(e){super(e),this.type="data-layer"}clone(){const{fields:e,dataSource:t}=this;return new $B({fields:e,dataSource:t})}};u([ht({dataLayer:"data-layer"})],ql.prototype,"type",void 0),u([d({type:[IR],json:{write:!0}})],ql.prototype,"fields",void 0),u([d({types:$3e,json:{write:!0}})],ql.prototype,"dataSource",void 0),ql=$B=u([P("esri.layers.support.source.DataLayerSource")],ql),ql.from=ns(ql);var LB;const LY=new si({upperLeft:"upper-left",lowerLeft:"lower-left"});let Ov=LB=class extends ve{constructor(e){super(e),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new LB(se({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:Zt,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Ov.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],Ov.prototype,"mode",void 0),u([d({type:String,json:{read:LY.read,write:LY.write}})],Ov.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Ov.prototype,"tolerance",void 0),Ov=LB=u([P("esri.rest.support.QuantizationParameters")],Ov);const D3e=Ov;var NB;const NY=new si({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let th=NB=class extends ve{constructor(e){super(e),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(e,t){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(t.statisticParameters=se(e))}clone(){return new NB({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:se(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],th.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],th.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],th.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],th.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],th.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:NY.read},write:{target:"statisticType",writer:NY.write}}})],th.prototype,"statisticType",void 0),u([d({type:Object})],th.prototype,"statisticParameters",void 0),u([Ge("statisticParameters")],th.prototype,"writeStatisticParameters",null),th=NB=u([P("esri.rest.support.StatisticDefinition")],th);const $ue=th;var Cx;const L3e=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),N3e=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let St=Cx=class extends ve{constructor(e){super(e),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}static from(e){return Xx(Cx,e)}castDatumTransformation(e){return typeof e=="number"||typeof e=="object"?e:null}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeParameterValues(e,t){if(e){const i={};for(const r in e){const s=e[r];Array.isArray(s)?i[r]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?i[r]=s.getTime():i[r]=s}t.parameterValues=i}}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,t.where="1=1"}writeWhere(e,t){t.where=e||"1=1"}clone(){return new Cx(se({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:_(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};St.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],St.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],St.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],St.prototype,"datumTransformation",void 0),u([It("datumTransformation")],St.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],St.prototype,"distance",void 0),u([d({type:ql,json:{write:!0}})],St.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"formatOf3DObjects",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"gdbVersion",void 0),u([d({types:V1,json:{read:dm,write:!0}})],St.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],St.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"having",void 0),u([d({type:Date})],St.prototype,"historicMoment",void 0),u([Ge("historicMoment")],St.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],St.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:e=>e<1?1:e>Cx.MAX_MAX_RECORD_COUNT_FACTOR?Cx.MAX_MAX_RECORD_COUNT_FACTOR:e,json:{write:{overridePolicy:e=>({enabled:e>1})}}})],St.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],St.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],St.prototype,"num",void 0),u([d({json:{write:!0}})],St.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"outFields",void 0),u([d({type:tt,json:{name:"outSR",write:!0}})],St.prototype,"outSpatialReference",void 0),u([d({type:[$ue],json:{write:{enabled:!0,overridePolicy(){return{enabled:_(this.outStatistics)&&this.outStatistics.length>0}}}}})],St.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],St.prototype,"parameterValues",void 0),u([Ge("parameterValues")],St.prototype,"writeParameterValues",null),u([d({type:Ke,json:{write:!0}})],St.prototype,"pixelSize",void 0),u([d({type:D3e,json:{write:!0}})],St.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],St.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],St.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],St.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],St.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],St.prototype,"returnZ",void 0),u([d({type:tt,json:{write:!0}})],St.prototype,"sourceSpatialReference",void 0),u([ht(L3e,{ignoreUnknown:!1,name:"spatialRel"})],St.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],St.prototype,"start",void 0),u([Ge("start"),Ge("num")],St.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],St.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"text",void 0),u([d({type:Ap,json:{write:!0}})],St.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"timeReferenceUnknownClient",void 0),u([ht(N3e,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],St.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(e){return{enabled:e!=null||this.start>0}}}}})],St.prototype,"where",void 0),u([Ge("where")],St.prototype,"writeWhere",null),St=Cx=u([P("esri.rest.support.Query")],St);const pa=St;var FB;let Xr=FB=class extends ve{constructor(e){super(e),this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(t.definitionExpression="1=1")}clone(){return new FB(se({dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:ql,json:{write:!0}})],Xr.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],Xr.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],Xr.prototype,"geometryPrecision",void 0),u([d({type:Date})],Xr.prototype,"historicMoment",void 0),u([Ge("historicMoment")],Xr.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],Xr.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],Xr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Xr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Xr.prototype,"outFields",void 0),u([d({type:tt,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Xr.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],Xr.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Xr.prototype,"start",void 0),u([Ge("start"),Ge("num")],Xr.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Xr.prototype,"num",void 0),u([d({json:{write:!0}})],Xr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Xr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Xr.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Xr.prototype,"where",void 0),Xr=FB=u([P("esri.rest.support.RelationshipQuery")],Xr),Xr.from=ns(Xr);const y1=Xr;function hdt(e){var t;const i=e.layer;return"floorInfo"in i&&(t=i.floorInfo)!=null&&t.floorField&&"floors"in e.view?Due(e.view.floors,i.floorInfo.floorField):null}function ddt(e,t){var i;return"floorInfo"in t&&(i=t.floorInfo)!=null&&i.floorField?Due(e,t.floorInfo.floorField):null}function pdt(e,t){const{definitionExpression:i}=t;return e?i?`(${i}) AND (${e})`:e:i}function Due(e,t){if(e==null||!e.length)return null;const i=e.filter(r=>r!=="").map(r=>`'${r}'`);return i.push("''"),`${t} IN (${i.join(",")}) OR ${t} IS NULL`}function F3e(e,t){return t?me(I({},t),{query:I(I({},e),t.query)}):{query:e}}function wc(e){return typeof e=="string"?Gn(e):e}function U3e(e,t,i){const r={};for(const s in e){if(s==="declaredClass")continue;const n=e[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=U3e(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=t?o:JSON.stringify(o)}else r[s]=t?n:JSON.stringify(n);else r[s]=n}return r}function $R(e){const t={};for(const i in e){if(i==="declaredClass")continue;const r=e[i];if(r!=null&&typeof r!="function")if(Array.isArray(r)){t[i]=[];for(let s=0;s<r.length;s++)t[i][s]=$R(r[s])}else typeof r=="object"?r.toJSON&&(t[i]=JSON.stringify(r)):t[i]=r}return t}function k3e(e){const t=e.toJSON();return t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),t.keywords&&(t.keywords=t.keywords.join(",")),t.globalIds&&(t.globalIds=t.globalIds.join(",")),t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t}function z3e(e,t){const i={};for(const r of e){const{parentObjectId:s,parentGlobalId:n,attachmentInfos:o}=r;for(const a of o){const{id:l}=a,c=n2e(D2e(`${t}/${s}/attachments/${l}`)),h=fue.fromJSON(a);h.set({url:c,parentObjectId:s,parentGlobalId:n}),i[s]?i[s].push(h):i[s]=[h]}}return i}function B3e(e,t,i){let r={query:$R(I(me(I({},e.query),{f:"json"}),k3e(t)))};return i&&(r=me(I(I({},i),r),{query:I(I({},i.query),r.query)})),Ci(e.path+"/queryAttachments",r)}async function V3e(e,t,i){const r=wc(e);return B3e(r,tD.from(t),I({},i)).then(s=>z3e(s.data.attachmentGroups,r.path))}const WO={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new tc({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:tt.WebMercator}),minus180Line:new tc({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:tt.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new tc({paths:[[[180,-180],[180,180]]],spatialReference:tt.WGS84}),minus180Line:new tc({paths:[[[-180,-180],[-180,180]]],spatialReference:tt.WGS84})}};function O_(e,t){return Math.ceil((e-t)/(2*t))}function Lue(e,t){const i=vA(e);for(const r of i)for(const s of r)s[0]+=t;return e}function vA(e){return k_(e)?e.rings:e.paths}async function G3e(e,t,i,r){const s=typeof e=="string"?Gn(e):e,n=t[0].spatialReference,o=me(I({},r),{query:me(I({},s.query),{f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:x0(t[0]),geometries:t}),cutter:JSON.stringify(i)})}),a=await Ci(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=dm(h);return p.spatialReference=n,p})}}async function j3e(e,t,i){const r=typeof e=="string"?Gn(e):e,s=t[0].spatialReference,n=x0(t[0]),o=me(I({},i),{query:me(I({},r.query),{f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(H3e(t))})});return q3e((await Ci(r.path+"/simplify",o)).data,n,s)}function H3e(e){return{geometryType:x0(e[0]),geometries:e.map(t=>t.toJSON())}}function q3e(e,t,i){const r=Wne(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}const W3e=he.getLogger("esri.geometry.support.normalizeUtils");function X3e(e){return e.type==="polygon"}function Y3e(e){return e[0].type==="polygon"}function Z3e(e){return e[0].type==="polyline"}function Q3e(e,t){if(!(e instanceof tc||e instanceof dc)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw W3e.error(s),new Q(s)}const i=vA(e),r=[];for(const s of i){const n=[];r.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,g=(c-a)/p,y=p/t;if(y>1){for(let S=1;S<=y-1;S++){const T=S*t,A=g*T+a,C=f*T+l;n.push([A,C])}const v=(p+Math.floor(y-1)*t)/2,b=g*v+a,w=f*v+l;n.push([b,w])}n.push([c,h])}}return X3e(e)?new dc({rings:r,spatialReference:e.spatialReference}):new tc({paths:r,spatialReference:e.spatialReference})}function FY(e,t,i){if(t){const r=Q3e(e,1e6);e=G2(r,!0)}return i&&(e=Lue(e,i)),e}function UY(e,t,i){if(Array.isArray(e)){const r=e[0];if(r>t){const s=O_(r,t);e[0]=r+s*(-2*t)}else if(r<i){const s=O_(r,i);e[0]=r+s*(-2*i)}}else{const r=e.x;if(r>t){const s=O_(r,t);e=e.clone().offset(s*(-2*t),0)}else if(r<i){const s=O_(r,i);e=e.clone().offset(s*(-2*i),0)}}return e}function J3e(e,t){let i=-1;for(let r=0;r<t.cutIndexes.length;r++){const s=t.cutIndexes[r],n=t.geometries[r],o=vA(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const g=l[f][0];h=g>h?g:h}h=Number(h.toFixed(9));const p=-360*O_(h,180);for(let f=0;f<l.length;f++){const g=n.getPoint(a,f);n.setPoint(a,f,g.clone().offset(p,0))}return!0}})}if(s===i){if(Y3e(e))for(const a of vA(n))e[s]=e[s].addRing(a);else if(Z3e(e))for(const a of vA(n))e[s]=e[s].addPath(a)}else i=s,e[s]=n}return e}async function F7(e,t,i){var r;if(!Array.isArray(e))return F7([e],t);const s=(r=t==null?void 0:t.url)!=null?r:zi.geometryServiceUrl;let n,o,a,l,c,h,p,f,g=0;const y=[],v=[];for(const C of e)if(O(C))v.push(C);else if(n||(n=C.spatialReference,o=Gy(n),a=n.isWebMercator,h=a?102100:4326,l=WO[h].maxX,c=WO[h].minX,p=WO[h].plus180Line,f=WO[h].minus180Line),o)if(C.type==="mesh")v.push(C);else if(C.type==="point")v.push(UY(C.clone(),l,c));else if(C.type==="multipoint"){const R=C.clone();R.points=R.points.map(L=>UY(L,l,c)),v.push(R)}else if(C.type==="extent"){const R=C.clone()._normalize(!1,!1,o);v.push(R.rings?new dc(R):R)}else if(C.extent){const R=C.extent,L=O_(R.xmin,c)*(2*l);let U=L===0?C.clone():Lue(C.clone(),L);R.offset(L,0),R.intersects(p)&&R.xmax!==l?(g=R.xmax>g?R.xmax:g,U=FY(U,a),y.push(U),v.push("cut")):R.intersects(f)&&R.xmin!==c?(g=R.xmax*(2*l)>g?R.xmax*(2*l):g,U=FY(U,a,360),y.push(U),v.push("cut")):v.push(U)}else v.push(C.clone());else v.push(C);let b=O_(g,l),w=-90;const S=b,T=new tc;for(;b>0;){const C=360*b-180;T.addPath([[C,w],[C,-1*w]]),w*=-1,b--}if(y.length>0&&S>0){const C=J3e(y,await G3e(s,y,T,i)),R=[],L=[];for(let z=0;z<v.length;z++){const V=v[z];if(V!=="cut")L.push(V);else{const B=C.shift(),J=e[z];_(J)&&J.type==="polygon"&&J.rings&&J.rings.length>1&&B.rings.length>=J.rings.length?(R.push(B),L.push("simplify")):L.push(a?Kf(B):B)}}if(!R.length)return L;const U=await j3e(s,R,i),N=[];for(let z=0;z<L.length;z++){const V=L[z];V!=="simplify"?N.push(V):N.push(a?Kf(U.shift()):U.shift())}return N}const A=[];for(let C=0;C<v.length;C++){const R=v[C];if(R!=="cut")A.push(R);else{const L=y.shift();A.push(a===!0?Kf(L):L)}}return Promise.resolve(A)}var ry;(function(e){e[e.varint=0]="varint",e[e.fixed64=1]="fixed64",e[e.delimited=2]="delimited",e[e.fixed32=5]="fixed32",e[e.unknown=99]="unknown"})(ry||(ry={}));const kY=4294967296,K3e=new TextDecoder("utf-8"),eIe=ue("safari")||ue("ios")?6:ue("ff")?12:32;class X_{constructor(t,i,r=0,s=t?t.byteLength:0){this._tag=0,this._dataType=ry.unknown,this._init(t,i,r,s)}_init(t,i,r,s){this._data=t,this._dataView=i,this._pos=r,this._end=s}clone(){return new X_(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(t){this._pos=t}nextTag(t){for(;;){if(this._pos===this._end)return!1;const i=this._decodeVarint();if(this._tag=i>>3,this._dataType=7&i,!t||t===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const t=this._decodeVarint();return this._tag=t>>3,this._dataType=7&t,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let t=4294967295;return t=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?t:(t=(t|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?t:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const t=this.getUInt32();return t>>>1^-(1&t)|0}getSInt64(){return this._decodeSVarint()}getBool(){const t=this._data[this._pos]!==0;return this._skip(1),t}getEnum(){return this._decodeVarint()}getFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getUint32(i+4,!0)*kY;return this._skip(8),r}getSFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getInt32(i+4,!0)*kY;return this._skip(8),r}getDouble(){const t=this._dataView.getFloat64(this._pos,!0);return this._skip(8),t}getFixed32(){const t=this._dataView.getUint32(this._pos,!0);return this._skip(4),t}getSFixed32(){const t=this._dataView.getInt32(this._pos,!0);return this._skip(4),t}getFloat(){const t=this._dataView.getFloat32(this._pos,!0);return this._skip(4),t}getString(){const t=this._getLength(),i=this._pos,r=this._toString(this._data,i,i+t);return this._skip(t),r}getBytes(){const t=this._getLength(),i=this._pos,r=this._toBytes(this._data,i,i+t);return this._skip(t),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(t,i,r,s){const n=this.getMessage(),o=t(n,i,r,s);return n.release(),o}processMessage(t){const i=this.getMessage(),r=t(i);return i.release(),r}getMessage(){const t=this._getLength(),i=X_.pool.acquire();return i._init(this._data,this._dataView,this._pos,this._pos+t),this._skip(t),i}release(){X_.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case ry.varint:this._decodeVarint();break;case ry.fixed64:this._skip(8);break;case ry.delimited:this._skip(this._getLength());break;case ry.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(t){this._skip(t)}_skip(t){if(this._pos+t>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=t}_decodeVarint(){const t=this._data;let i,r=this._pos,s=0;if(this._end-r>=10)do{if(i=t[r++],s|=127&i,(128&i)==0||(i=t[r++],s|=(127&i)<<7,(128&i)==0)||(i=t[r++],s|=(127&i)<<14,(128&i)==0)||(i=t[r++],s|=(127&i)<<21,(128&i)==0)||(i=t[r++],s+=268435456*(127&i),(128&i)==0)||(i=t[r++],s+=34359738368*(127&i),(128&i)==0)||(i=t[r++],s+=4398046511104*(127&i),(128&i)==0)||(i=t[r++],s+=562949953421312*(127&i),(128&i)==0)||(i=t[r++],s+=72057594037927940*(127&i),(128&i)==0)||(i=t[r++],s+=9223372036854776e3*(127&i),(128&i)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(i=t[r],(128&i)!=0);)++r,s+=(127&i)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,s+=i*n}return this._pos=r,s}_decodeSVarint(){const t=this._decodeVarint();return t%2?-(t+1)/2:t/2}_getLength(){if(this._dataType!==ry.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(t,i,r){if((r=Math.min(this._end,r))-i>eIe){const o=t.subarray(i,r);return K3e.decode(o)}let s="",n="";for(let o=i;o<r;++o){const a=t[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(t,i,r){return r=Math.min(this._end,r),new Uint8Array(t.buffer,i,r-i)}}X_.pool=new Gr(X_,null,e=>{e._data=null,e._dataView=null});class vl{constructor(t=[],i=[],r=!1){this.lengths=t!=null?t:[],this.coords=i!=null?i:[],this.hasIndeterminateRingOrder=r}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((t,i)=>t+i)}forEachVertex(t){let i=0;this.lengths.length||t(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const s=this.lengths[r];for(let n=0;n<s;n++)t(this.coords[2*(n+i)],this.coords[2*(n+i)+1]);i+=s}}clone(t){return t?(t.set(this.coords),new vl(this.lengths.slice(),t,this.hasIndeterminateRingOrder)):new vl(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}}class gp{constructor(t=null,i={},r,s){this.geometry=t,this.attributes=i,this.centroid=r,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const t=new gp(this.geometry,this.attributes,this.centroid,this.objectId);return t.displayId=this.displayId,t.geohashX=this.geohashX,t.geohashY=this.geohashY,t}}function tIe(e){return!(O(e.geometry)||!e.geometry.coords||!e.geometry.coords.length)}class fdt extends gp{}class wN{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const t=new wN;return t.objectIdFieldName=this.objectIdFieldName,t.globalIdFieldName=this.globalIdFieldName,t.geohashFieldName=this.geohashFieldName,t.geometryProperties=this.geometryProperties,t.geometryType=this.geometryType,t.spatialReference=this.spatialReference,t.hasZ=this.hasZ,t.hasM=this.hasM,t.features=this.features,t.fields=this.fields,t.transform=this.transform,t.exceededTransferLimit=this.exceededTransferLimit,t.uniqueIdField=this.uniqueIdField,t.queryGeometry=this.queryGeometry,t.queryGeometryType=this.queryGeometryType,t}}const Nue=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class mdt{constructor(t){this.options=t,this.geometryTypes=Nue,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new wN}prepareFeatures(t){this._vertexDimension=2,t.hasZ&&this._vertexDimension++,t.hasM&&this._vertexDimension++}finishFeatureResult(t){if(!t||!t.features||!t.hasZ||!this.options.sourceSpatialReference||!t.spatialReference||bc(t.spatialReference,this.options.sourceSpatialReference)||t.spatialReference.vcsWkid)return;const i=lT(this.options.sourceSpatialReference)/lT(t.spatialReference);if(i!==1)for(const r of t.features){if(!tIe(r))continue;const s=r.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=i}}addFeature(t,i){t.features.push(i)}createFeature(){return new gp}createSpatialReference(){return{wkid:0}}createGeometry(){return new vl}addField(t,i){t.fields.push(i)}allocateCoordinates(t){t.coords.length=t.lengths.reduce((i,r)=>i+r,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(t,i){t.coords[this._coordinatePtr++]=i}addCoordinatePoint(t,i){t.coords.push(i)}addLength(t,i){t.lengths.push(i)}addQueryGeometry(t,i){t.queryGeometry=i.queryGeometry,t.queryGeometryType=i.queryGeometryType}createPointGeometry(){return new vl}}const zY=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],BY=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],VY=["upperLeft","lowerLeft"];function GY(e){return e>=zY.length?null:zY[e]}function iIe(e){return e>=BY.length?null:BY[e]}function jY(e){return e>=VY.length?null:VY[e]}function HY(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function rIe(e,t,i){const s=t.createPointGeometry(i);for(;e.next();)switch(e.tag()){case 3:{const n=e.getUInt32(),o=e.pos()+n;let a=0;for(;e.pos()<o;)t.addCoordinatePoint(s,e.getSInt64(),a++);break}default:e.skip()}return s}function sIe(e,t,i){const n=t.createGeometry(i),o=2+(i.hasZ?1:0)+(i.hasM?1:0);for(;e.next();)switch(e.tag()){case 2:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(;e.pos()<l;)t.addLength(n,e.getUInt32(),c++);break}case 3:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(t.allocateCoordinates(n);e.pos()<l;)t.addCoordinate(n,e.getSInt64(),c),c++,c===o&&(c=0);break}default:e.skip()}return n}function nIe(e){const s=new vl;let n="esriGeometryPoint";for(;e.next();)switch(e.tag()){case 2:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.lengths.push(e.getUInt32());break}case 3:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.coords.push(e.getSInt64());break}case 1:n=Nue[e.getEnum()];break;default:e.skip()}return{queryGeometry:s,queryGeometryType:n}}function oIe(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function aIe(e){const a={type:GY(0)};for(;e.next();)switch(e.tag()){case 1:a.name=e.getString();break;case 2:a.type=GY(e.getEnum());break;case 3:a.alias=e.getString();break;case 4:a.sqlType=iIe(e.getEnum());break;case 5:e.skip();break;case 6:a.defaultValue=e.getString();break;default:e.skip()}return a}function lIe(e){const r={};for(;e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:r.isSystemMaintained=e.getBool();break;default:e.skip()}return r}function cIe(e,t,i,r){const a=t.createFeature(i);let l=0;for(;e.next();)switch(e.tag()){case 1:{const c=r[l++].name;a.attributes[c]=e.processMessage(oIe);break}case 2:a.geometry=e.processMessageWithArgs(sIe,t,i);break;case 4:a.centroid=e.processMessageWithArgs(rIe,t,i);break;default:e.skip()}return a}function uIe(e){const n=[1,1,1,1];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function hIe(e){const n=[0,0,0,0];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function dIe(e){const s={originPosition:jY(0)};for(;e.next();)switch(e.tag()){case 1:s.originPosition=jY(e.getEnum());break;case 2:s.scale=e.processMessage(uIe);break;case 3:s.translate=e.processMessage(hIe);break;default:e.skip()}return s}function pIe(e){const s={};for(;e.next();)switch(e.tag()){case 1:s.shapeAreaFieldName=e.getString();break;case 2:s.shapeLengthFieldName=e.getString();break;case 3:s.units=e.getString();break;default:e.skip()}return s}function fIe(e,t){const a=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:a.wkid=e.getUInt32();break;case 5:a.wkt=e.getString();break;case 2:a.latestWkid=e.getUInt32();break;case 3:a.vcsWkid=e.getUInt32();break;case 4:a.latestVcsWkid=e.getUInt32();break;default:e.skip()}return a}function mIe(e,t){const v=t.createFeatureResult();v.geometryType=HY(t,0);let b=!1;for(;e.next();)switch(e.tag()){case 1:v.objectIdFieldName=e.getString();break;case 3:v.globalIdFieldName=e.getString();break;case 4:v.geohashFieldName=e.getString();break;case 5:v.geometryProperties=e.processMessage(pIe);break;case 7:v.geometryType=HY(t,e.getEnum());break;case 8:v.spatialReference=e.processMessageWithArgs(fIe,t);break;case 10:v.hasZ=e.getBool();break;case 11:v.hasM=e.getBool();break;case 12:v.transform=e.processMessage(dIe);break;case 9:{const w=e.getBool();v.exceededTransferLimit=w;break}case 13:t.addField(v,e.processMessage(aIe));break;case 15:b||(t.prepareFeatures(v),b=!0),t.addFeature(v,e.processMessageWithArgs(cIe,t,v,v.fields));break;case 2:v.uniqueIdField=e.processMessage(lIe);break;default:e.skip()}return t.finishFeatureResult(v),v}function gIe(e,t){const s={};let n=null;for(;e.next();)switch(e.tag()){case 4:n=e.processMessageWithArgs(nIe);break;case 1:s.featureResult=e.processMessageWithArgs(mIe,t);break;default:e.skip()}return _(n)&&s.featureResult&&t.addQueryGeometry(s,n),s}function yIe(e,t){try{const r=new X_(new Uint8Array(e),new DataView(e)),s={};for(;r.next();)r.tag()===2?s.queryResult=r.processMessageWithArgs(gIe,t):r.skip();return s}catch(i){throw new Q("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:i})}}function vIe(e,t){const i=yIe(e,t),r=i.queryResult.featureResult,s=i.queryResult.queryGeometry,n=i.queryResult.queryGeometryType;if(r&&r.features&&r.features.length&&r.objectIdFieldName){const o=r.objectIdFieldName;for(const a of r.features)a.attributes&&(a.objectId=a.attributes[o])}return r&&(r.queryGeometry=s,r.queryGeometryType=n),r}function nD(e,t,i){if(!i||!i.features||!i.hasZ)return;const r=KG(i.geometryType,t,e.outSpatialReference);if(!O(r))for(const s of i.features)r(s.geometry)}const qY="Layer does not support extent calculation.";function Fue(e,t){if(t&&e.type==="extent")return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&e.type==="point")return`${e.x},${e.y}`;const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}function Uue(e,t){const i=e.geometry,r=e.toJSON();delete r.compactGeometryEnabled,delete r.defaultSpatialReferenceEnabled;const s=r,n=e.outSpatialReference;let o,a;if(_(i)&&(o=i.spatialReference,a=i.spatialReference.wkid||JSON.stringify(i.spatialReference),s.geometryType=x0(i),s.geometry=Fue(i,e.compactGeometryEnabled),s.inSR=a),r.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r.objectIds&&(s.objectIds=r.objectIds.join(",")),r.orderByFields&&(s.orderByFields=r.orderByFields.join(",")),!r.outFields||!r.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete s.outFields:r.outFields.indexOf("*")!==-1?s.outFields="*":s.outFields=r.outFields.join(","),r.outSR?s.outSR=r.outSR.wkid||JSON.stringify(r.outSR):i&&(r.returnGeometry||r.returnCentroid)&&(s.outSR=s.inSR),r.returnGeometry&&delete r.returnGeometry,r.outStatistics&&(s.outStatistics=JSON.stringify(r.outStatistics)),r.pixelSize&&(s.pixelSize=JSON.stringify(r.pixelSize)),r.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&_(o)&&_(e.quantizationParameters)&&_(e.quantizationParameters.extent)&&o.equals(e.quantizationParameters.extent.spatialReference)&&delete r.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(r.quantizationParameters)),r.parameterValues&&(s.parameterValues=JSON.stringify(r.parameterValues)),r.rangeValues&&(s.rangeValues=JSON.stringify(r.rangeValues)),r.dynamicDataSource&&(s.layer=JSON.stringify({source:r.dynamicDataSource}),delete r.dynamicDataSource),r.timeExtent){const l=r.timeExtent,{start:c,end:h}=l;c==null&&h==null||(s.time=c===h?c:`${c==null?"null":c},${h==null?"null":h}`),delete r.timeExtent}return e.defaultSpatialReferenceEnabled&&_(o)&&_(n)&&o.equals(n)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function kue(e,t,i,r){const s=_(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await pS(e,t,"json",r);return nD(t,i,s.data),s}async function zue(e,t,i,r){if(_(t.timeExtent)&&t.timeExtent.isEmpty)return Promise.resolve({data:i.createFeatureResult()});const s=await Bue(e,t,r),n=s;return n.data=vIe(s.data,i),n}function Bue(e,t,i){return pS(e,t,"pbf",i)}function Vue(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):pS(e,t,"json",i,{returnIdsOnly:!0})}function Gue(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):pS(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function jue(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):pS(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(qY);if(s.hasOwnProperty("count"))throw new Error(qY);return r})}function pS(e,t,i,r={},s={}){const n=typeof e=="string"?Gn(e):e,o=t.geometry?[t.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",F7(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((t=t.clone()).geometry=l);const c=$R(I(I(me(I({},n.query),{f:i}),s),Uue(t,s)));return Ci(r0(n.path,"query"),me(I({},r),{query:I(I({},c),r.query)}))})}var gdt=Object.freeze(Object.defineProperty({__proto__:null,encodeGeometry:Fue,executeQuery:kue,executeQueryForCount:Gue,executeQueryForExtent:jue,executeQueryForIds:Vue,executeQueryPBF:zue,executeQueryPBFBuffer:Bue,queryToQueryStringParameters:Uue,runQuery:pS},Symbol.toStringTag,{value:"Module"}));async function _Ie(e,t,i){const r=wc(e);return Gue(r,pa.from(t),I({},i)).then(s=>s.data.count)}async function bIe(e,t,i){const r=wc(e);return jue(r,pa.from(t),I({},i)).then(s=>({count:s.data.count,extent:Zt.fromJSON(s.data.extent)}))}async function wIe(e,t,i){const r=wc(e);return Vue(r,pa.from(t),I({},i)).then(s=>s.data.objectIds)}var UB;const kB=new si({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let En=UB=class extends ve{constructor(e){super(e),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(e,t){const i=tt.fromJSON(t.spatialReference),r=[];for(let s=0;s<e.length;s++){const n=e[s],o=Bo.fromJSON(n),a=n.geometry&&n.geometry.spatialReference;_(o.geometry)&&!a&&(o.geometry.spatialReference=i);const l=n.aggregateGeometries,c=o.aggregateGeometries;if(l&&_(c))for(const h in c){const p=c[h],f=l[h],g=f==null?void 0:f.spatialReference;_(p)&&!g&&(p.spatialReference=i)}r.push(o)}return r}writeGeometryType(e,t,i,r){if(e)return void kB.write(e,t,i,r);const{features:s}=this;if(s){for(const n of s)if(n&&_(n.geometry))return void kB.write(n.geometry.type,t,i,r)}}readQueryGeometry(e,t){if(!e)return null;const i=!!e.spatialReference,r=dm(e);return!i&&t.spatialReference&&(r.spatialReference=tt.fromJSON(t.spatialReference)),r}writeSpatialReference(e,t){if(e)return void(t.spatialReference=e.toJSON());const{features:i}=this;if(i){for(const r of i)if(r&&_(r.geometry)&&r.geometry.spatialReference)return void(t.spatialReference=r.geometry.spatialReference.toJSON())}}clone(){return new UB(this.cloneProperties())}cloneProperties(){return se({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(e){const t=this.write();if(t.features&&Array.isArray(e)&&e.length>0)for(let i=0;i<t.features.length;i++){const r=t.features[i];if(r.geometry){const s=e&&e[i];r.geometry=s&&s.toJSON()||r.geometry}}return t}quantize(e){const{scale:[t,i],translate:[r,s]}=e,n=c=>Math.round((c-r)/t),o=c=>Math.round((s-c)/i),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=e,this}unquantize(){const{geometryType:e,features:t,transform:i}=this;if(!i)return this;const{translate:[r,s],scale:[n,o]}=i,a=h=>h*n+r,l=h=>s-h*o,c=this._getHydrationFunction(e,a,l);for(const{geometry:h}of t)_(h)&&c(h);return this.transform=null,this}_quantizePoints(e,t,i){let r,s;const n=[];for(let o=0,a=e.length;o<a;o++){const l=e[o];if(o>0){const c=t(l[0]),h=i(l[1]);c===r&&h===s||(n.push([c-r,h-s]),r=c,s=h)}else r=t(l[0]),s=i(l[1]),n.push([r,s])}return n.length>0?n:null}_getQuantizationFunction(e,t,i){return e==="point"?r=>(r.x=t(r.x),r.y=i(r.y),r):e==="polyline"||e==="polygon"?r=>{const s=k_(r)?r.rings:r.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,t,i);c&&n.push(c)}return n.length>0?(k_(r)?r.rings=n:r.paths=n,r):null}:e==="multipoint"?r=>{const s=this._quantizePoints(r.points,t,i);return s.length>0?(r.points=s,r):null}:e==="extent"?r=>r:null}_getHydrationFunction(e,t,i){return e==="point"?r=>{r.x=t(r.x),r.y=i(r.y)}:e==="polyline"||e==="polygon"?r=>{const s=k_(r)?r.rings:r.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=t(n),f[1]=i(o)}}}:e==="extent"?r=>{r.xmin=t(r.xmin),r.ymin=i(r.ymin),r.xmax=t(r.xmax),r.ymax=i(r.ymax)}:e==="multipoint"?r=>{const s=r.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=t(n),c[1]=i(o)}}:void 0}};u([d({type:String,json:{write:!0}})],En.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],En.prototype,"exceededTransferLimit",void 0),u([d({type:[Bo],json:{write:!0}})],En.prototype,"features",void 0),u([Fe("features")],En.prototype,"readFeatures",null),u([d({type:[IR],json:{write:!0}})],En.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:kB.read}}})],En.prototype,"geometryType",void 0),u([Ge("geometryType")],En.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],En.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],En.prototype,"hasZ",void 0),u([d({types:V1,json:{write:!0}})],En.prototype,"queryGeometry",void 0),u([Fe("queryGeometry")],En.prototype,"readQueryGeometry",null),u([d({type:tt,json:{write:!0}})],En.prototype,"spatialReference",void 0),u([Ge("spatialReference")],En.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],En.prototype,"transform",void 0),En=UB=u([P("esri.rest.support.FeatureSet")],En),En.prototype.toJSON.isDefaultToJSON=!0;const Q1=En;var ydt=Object.freeze(Object.defineProperty({__proto__:null,default:Q1},Symbol.toStringTag,{value:"Module"}));async function vdt(e,t,i){const r=await Hue(e,t,i);return Q1.fromJSON(r)}async function Hue(e,t,i){const r=wc(e),s=I({},i),n=pa.from(t),{data:o}=await kue(r,n,n.sourceSpatialReference,s);return o}function ho(e,t){return e?t?4:3:t?3:2}const DR=he.getLogger("esri.layers.graphics.featureConversionUtils"),que={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},Wue=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n},oD=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2]},xIe=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+3]},Xue=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2],e[i+3]=t[r+3]};function U7(e,t,i,r){if(e){if(i)return t&&r?Xue:oD;if(t&&r)return xIe}else if(t&&r)return oD;return Wue}function Y4({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function Z4({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function WY({scale:e,translate:t},i){return i*e[0]+t[0]}function XY({scale:e,translate:t},i){return t[1]-i*e[1]}function _dt(e,t,i){return e?t?i?B7(e):k7(e):i?z7(e):xN(e):null}function xN(e){const t=e.coords;return{x:t[0],y:t[1]}}function Yue(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function k7(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function TIe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function z7(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function SIe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function B7(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function EIe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function AIe(e,t,i,r){let s=xN;i&&r?s=B7:i?s=k7:r&&(s=z7);for(const n of t){const{geometry:o,attributes:a}=n,l=_(o)?s(o):null;e.push({attributes:a,geometry:l})}return e}function V7(e,t){return e&&t?EIe:e?TIe:t?SIe:Yue}function CIe(e,t,i,r,s){const n=V7(i,r);for(const o of t){const{geometry:a,attributes:l}=o;let c;a&&(c=n(new vl,a)),e.push(new gp(c,l,null,l[s]))}return e}function bdt(e,t,i=V7(t.z!=null,t.m!=null)){return i(e,t)}function RIe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;n&&(a=Zue(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Zue(e,t,i){if(O(e))return null;const r=ho(t,i),s=[];for(let n=0;n<e.coords.length;n+=r){const o=[];for(let a=0;a<r;a++)o.push(e.coords[n+a]);s.push(o)}return t?i?{points:s,hasZ:t,hasM:i}:{points:s,hasZ:t}:i?{points:s,hasM:i}:{points:s}}function OIe(e,t,i,r,s){const n=ho(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Que(new vl,a,n)),e.push(new gp(c,l,null,l[s]))}return e}function Que(e,t,i=ho(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const r=e.coords;let s=0;for(const n of t.points)for(let o=0;o<i;o++)r[s++]=n[o];return e}function MIe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;_(n)&&(a=Jue(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Jue(e,t,i){if(!e)return null;const r=ho(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{paths:o,hasZ:t,hasM:i}:{paths:o,hasZ:t}:i?{paths:o,hasM:i}:{paths:o}}function PIe(e,t,i,r,s){const n=ho(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Kue(new vl,a,n)),e.push(new gp(c,l,null,l[s]))}return e}function Kue(e,t,i=ho(t.hasZ,t.hasM)){const{lengths:r,coords:s}=e;let n=0;for(const o of t.paths){for(const a of o)for(let l=0;l<i;l++)s[n++]=a[l];r.push(o.length)}return e}function IIe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o,centroid:a}=s;let l;if(_(n)&&(l=ehe(n,i,r)),_(a)){const c=xN(a);e.push({attributes:o,centroid:c,geometry:l})}else e.push({attributes:o,geometry:l})}return e}function ehe(e,t,i){if(!e)return null;const r=ho(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{rings:o,hasZ:t,hasM:i}:{rings:o,hasZ:t}:i?{rings:o,hasM:i}:{rings:o}}function $Ie(e,t,i,r,s){for(const n of t){const o=n.geometry,a=n.centroid,l=n.attributes;let c;o&&(c=the(new vl,o,i,r)),_(a)?e.push(new gp(c,l,Yue(new vl,a),l[s])):e.push(new gp(c,l,null,l[s]))}return e}function the(e,t,i=t.hasZ,r=t.hasM){return DIe(e,t.rings,i,r),e}function DIe(e,t,i,r){const s=ho(i,r),{lengths:n,coords:o}=e;let a=0;n.length=o.length=0;for(const l of t){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return e}const Rx=[],_A=[];function wdt(e,t,i,r,s){Rx[0]=e;const[n]=ihe(_A,Rx,t,i,r,s);return Rx.length=_A.length=0,n}function ihe(e,t,i,r,s,n){if(e.length=0,!i){for(const o of t){const a=o.attributes[n];e.push(new gp(null,o.attributes,null,a))}return e}switch(i){case"esriGeometryPoint":return CIe(e,t,r,s,n);case"esriGeometryMultipoint":return OIe(e,t,r,s,n);case"esriGeometryPolyline":return PIe(e,t,r,s,n);case"esriGeometryPolygon":return $Ie(e,t,r,s,n);default:DR.error("convertToFeatureSet:unknown-geometry",new Q(`Unable to parse unknown geometry type '${i}'`)),e.length=0}return e}function xdt(e,t,i,r){_A[0]=e,she(Rx,_A,t,i,r);const s=Rx[0];return Rx.length=_A.length=0,s}function LIe(e,t,i){if(O(e))return null;const r=new vl;return"hasZ"in e&&t==null&&(t=e.hasZ),"hasM"in e&&i==null&&(i=e.hasM),dG(e)?V7(t!=null?t:e.z!=null,i!=null?i:e.m!=null)(r,e):k_(e)?the(r,e,t,i):pG(e)?Kue(r,e,ho(t,i)):hG(e)?Que(r,e,ho(t,i)):void DR.error("convertFromGeometry:unknown-geometry",new Q(`Unable to parse unknown geometry type '${e}'`))}function rhe(e,t,i,r){const s=e&&("coords"in e?e:e.geometry);if(O(s))return null;switch(t){case"esriGeometryPoint":{let n=xN;return i&&r?n=B7:i?n=k7:r&&(n=z7),n(s)}case"esriGeometryMultipoint":return Zue(s,i,r);case"esriGeometryPolyline":return Jue(s,i,r);case"esriGeometryPolygon":return ehe(s,i,r);default:return void DR.error("convertToGeometry:unknown-geometry",new Q(`Unable to parse unknown geometry type '${t}'`))}}function NIe(e,t){for(const i of t)e.push({attributes:i.attributes});return e}function she(e,t,i,r,s){if(e.length=0,O(i))return NIe(e,t);switch(i){case"esriGeometryPoint":return AIe(e,t,r,s);case"esriGeometryMultipoint":return RIe(e,t,r,s);case"esriGeometryPolyline":return MIe(e,t,r,s);case"esriGeometryPolygon":return IIe(e,t,r,s);default:DR.error("convertToFeatureSet:unknown-geometry",new Q(`Unable to parse unknown geometry type '${i}'`))}return e}function Tdt(e){const{objectIdFieldName:t,spatialReference:i,transform:r,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=e,g={features:she([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:t,spatialReference:i,uniqueIdField:h,queryGeometry:rhe(p,f,!1,!1)};return r&&(g.transform=r),c&&(g.exceededTransferLimit=c),n&&(g.hasM=n),o&&(g.hasZ=o),g}function Sdt(e,t){const i=new wN,{hasM:r,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=e;return p&&(i.fields=p),i.geometryType=l,i.objectIdFieldName=o||t,i.spatialReference=a,i.objectIdFieldName?(n&&ihe(i.features,n,l,s,r,i.objectIdFieldName),c&&(i.exceededTransferLimit=c),r&&(i.hasM=r),s&&(i.hasZ=s),h&&(i.transform=h),i):(DR.error(new Q("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),i)}function Edt(e){const{transform:t,features:i,hasM:r,hasZ:s}=e;if(!t)return e;for(const n of i)_(n.geometry)&&BB(n.geometry,n.geometry,r,s,t),_(n.centroid)&&BB(n.centroid,n.centroid,r,s,t);return e.transform=null,e}function Adt(e,t){const{geometryType:i,features:r,hasM:s,hasZ:n}=t;if(!e)return t;for(let o=0;o<r.length;o++){const a=r[o],l=a.weakClone();l.geometry=new vl,YY(l.geometry,a.geometry,s,n,i,e),a.centroid&&(l.centroid=new vl,YY(l.centroid,a.centroid,s,n,"esriGeometryPoint",e)),r[o]=l}return t.transform=e,t}function YY(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),O(t)||!t.coords.length)return null;const l=que[s],{coords:c,lengths:h}=t,p=ho(i,r),f=ho(i&&o,r&&a),g=U7(i,r,o,a);if(!h.length)return g(e.coords,c,0,0,Y4(n,c[0]),Z4(n,c[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y,v,b,w,S=0,T=0,A=T;for(const C of h){if(C<l)continue;let R=0;T=A,b=y=Y4(n,c[S]),w=v=Z4(n,c[S+1]),g(e.coords,c,T,S,b,w),R++,S+=p,T+=f;for(let L=1;L<C;L++,S+=p)b=Y4(n,c[S]),w=Z4(n,c[S+1]),b===y&&w===v||(g(e.coords,c,T,S,b-y,w-v),T+=f,R++,y=b,v=w);R>=l&&(e.lengths.push(R),A=T)}return e.coords.length=A,e.coords.length?e:null}function Cdt(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const l=que[s],{coords:c,lengths:h}=t,p=ho(i,r),f=ho(i&&o,r&&a),g=U7(i,r,o,a);if(!h.length)return g(e.coords,c,0,0,c[0],c[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y=0;const v=n*n;for(const b of h){if(b<l){y+=b*p;continue}const w=e.coords.length/f,S=y,T=y+(b-1)*p;g(e.coords,c,e.coords.length,S,c[S],c[S+1]),zB(e.coords,c,p,v,g,S,T),g(e.coords,c,e.coords.length,T,c[T],c[T+1]);const A=e.coords.length/f-w;A>=l?e.lengths.push(A):e.coords.length=w*f,y+=b*p}return e.coords.length?e:null}function FIe(e,t,i,r){const s=e[t],n=e[t+1],o=e[i],a=e[i+1],l=e[r],c=e[r+1];let h=o,p=a,f=l-h,g=c-p;if(f!==0||g!==0){const y=((s-h)*f+(n-p)*g)/(f*f+g*g);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=g*y)}return f=s-h,g=n-p,f*f+g*g}function zB(e,t,i,r,s,n,o){let a,l=r,c=0;for(let h=n+i;h<o;h+=i)a=FIe(t,h,n,o),a>l&&(c=h,l=a);l>r&&(c-n>i&&zB(e,t,i,r,s,n,c),s(e,t,e.length,c,t[c],t[c+1]),o-c>i&&zB(e,t,i,r,s,c,o))}function Rdt(e,t,i,r){if(O(t)||!t.coords||!t.coords.length)return null;const s=ho(i,r);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(t&&t.coords){const c=t.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return e[0]=n,e[1]=o,e[2]=a,e[3]=l,e}function BB(e,t,i,r,s){const{coords:n,lengths:o}=t,a=i?r?Xue:oD:r?oD:Wue,l=ho(i,r);if(!n.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!o.length)return a(e.coords,n,0,0,WY(s,n[0]),XY(s,n[1])),e!==t&&(e.lengths.length=0,e.coords.length=l),e;const[c,h]=s.scale;let p=0;for(let f=0;f<o.length;f++){const g=o[f];e.lengths[f]=g;let y=WY(s,n[p]),v=XY(s,n[p+1]);a(e.coords,n,p,p,y,v),p+=l;for(let b=1;b<g;b++,p+=l)y+=n[p]*c,v-=n[p+1]*h,a(e.coords,n,p,p,y,v)}return e!==t&&(e.lengths.length=o.length,e.coords.length=n.length),e}function Odt(e,t,i,r,s,n){const o=ho(i,r),a=U7(i,r,s,n),l=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let c=0;c<l.length;c+=o)a(e.coords,l,e.coords.length,c,l[c],l[c+1]);return e}function UIe(e,t,i,r){let s=0,n=e[r*t],o=e[r*(t+1)];for(let a=1;a<i;a++){const l=n+e[r*(t+a)],c=o+e[r*(t+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function Mdt(e,t){const{coords:i,lengths:r}=e;let s=0,n=0;for(let o=0;o<r.length;o++)n+=UIe(i,s,r[o],t),s+=o;return Math.abs(n)}function Pdt(e,t){if(O(e))return null;const i=e.clone(),r=e.coords,s=e.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=r[t*n],c=r[t*n+1];for(let h=1;h<a;h++){const p=l+r[t*(n+h)],f=c+r[t*(n+h)+1];i.coords[t*(n+h)]=p,i.coords[t*(n+h)+1]=f,l=p,c=f}n+=a}return i}function kIe(e,t){return t}function G7(e,t,i,r){switch(i){case 0:return pC(e,t+r,0);case 1:return e.originPosition==="lowerLeft"?pC(e,t+r,1):VIe(e,t+r,1)}}function nhe(e,t,i,r){return i===2?pC(e,t,2):G7(e,t,i,r)}function zIe(e,t,i,r){return i===2?pC(e,t,3):G7(e,t,i,r)}function BIe(e,t,i,r){return i===3?pC(e,t,3):nhe(e,t,i,r)}function pC({translate:e,scale:t},i,r){return e[r]+i*t[r]}function VIe({translate:e,scale:t},i,r){return e[r]-i*t[r]}class GIe{constructor(t){this.options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=kIe,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this._attributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this.options.applyTransform&&(t.transform=null),this._attributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!t.hasZ)return;const i=KG(t.geometryType,this.options.sourceSpatialReference,t.spatialReference);if(!O(i))for(const r of t.features)i(r.geometry)}createSpatialReference(){return{}}addField(t,i){t.fields.push(i);const r=t.fields.map(s=>s.name);this._attributesConstructor=function(){for(const s of r)this[s]=null}}addFeature(t,i){t.features.push(i)}prepareFeatures(t){switch(this.transform=t.transform,this.options.applyTransform&&t.transform&&(this.applyTransform=this._deriveApplyTransform(t)),this.vertexDimension=2,t.hasZ&&this.vertexDimension++,t.hasM&&this.vertexDimension++,t.geometryType){case"esriGeometryPoint":this.addCoordinate=(i,r,s)=>this.addCoordinatePoint(i,r,s),this.createGeometry=i=>this.createPointGeometry(i);break;case"esriGeometryPolygon":this.addCoordinate=(i,r,s)=>this._addCoordinatePolygon(i,r,s),this.createGeometry=i=>this._createPolygonGeometry(i);break;case"esriGeometryPolyline":this.addCoordinate=(i,r,s)=>this._addCoordinatePolyline(i,r,s),this.createGeometry=i=>this._createPolylineGeometry(i);break;case"esriGeometryMultipoint":this.addCoordinate=(i,r,s)=>this._addCoordinateMultipoint(i,r,s),this.createGeometry=i=>this._createMultipointGeometry(i);break;default:t.geometryType}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(t,i,r){this.lengths.length===0&&(this.toAddInCurrentPath=i),this.lengths.push(i)}addQueryGeometry(t,i){const{queryGeometry:r,queryGeometryType:s}=i,n=BB(r.clone(),r,!1,!1,this.transform),o=rhe(n,s,!1,!1);t.queryGeometryType=s,t.queryGeometry=I({},o)}createPointGeometry(t){const i={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(i.z=0),t.hasM&&(i.m=0),i}addCoordinatePoint(t,i,r){switch(i=this.applyTransform(this.transform,i,r,0),r){case 0:t.x=i;break;case 1:t.y=i;break;case 2:"z"in t?t.z=i:t.m=i;break;case 3:t.m=i}}_transformPathLikeValue(t,i){let r=0;return i<=1&&(r=this.previousCoordinate[i],this.previousCoordinate[i]+=t),this.applyTransform(this.transform,t,i,r)}_addCoordinatePolyline(t,i,r){this._dehydratedAddPointsCoordinate(t.paths,i,r)}_addCoordinatePolygon(t,i,r){this._dehydratedAddPointsCoordinate(t.rings,i,r)}_addCoordinateMultipoint(t,i,r){r===0&&t.points.push([]);const s=this._transformPathLikeValue(i,r);t.points[t.points.length-1].push(s)}_createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_dehydratedAddPointsCoordinate(t,i,r){r===0&&this.toAddInCurrentPath--==0&&(t.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const s=this._transformPathLikeValue(i,r),n=t[t.length-1];r===0&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),n.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=s}_deriveApplyTransform(t){const{hasZ:i,hasM:r}=t;return i&&r?BIe:i?nhe:r?zIe:G7}}async function jIe(e,t,i){const r=wc(e),s=I({},i),n=pa.from(t),o=!n.quantizationParameters,{data:a}=await zue(r,n,new GIe({sourceSpatialReference:n.sourceSpatialReference,applyTransform:o}),s);return a}function HIe(e,t){const i=e.toJSON();return i.objectIds&&(i.objectIds=i.objectIds.join(",")),i.orderByFields&&(i.orderByFields=i.orderByFields.join(",")),!i.outFields||t!=null&&t.returnCountOnly?delete i.outFields:i.outFields.indexOf("*")!==-1?i.outFields="*":i.outFields=i.outFields.join(","),i.outSpatialReference&&(i.outSR=i.outSR.wkid||JSON.stringify(i.outSR.toJSON()),delete i.outSpatialReference),i.dynamicDataSource&&(i.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i}async function qIe(e,t,i){const r=await ohe(e,t,i),s=r.data,n=s.geometryType,o=s.spatialReference,a={};for(const l of s.relatedRecordGroups){const c={fields:void 0,objectIdFieldName:void 0,geometryType:n,spatialReference:o,hasZ:!!s.hasZ,hasM:!!s.hasM,features:l.relatedRecords};if(l.objectId!=null)a[l.objectId]=c;else for(const h in l)l.hasOwnProperty(h)&&h!=="relatedRecords"&&(a[l[h]]=c)}return me(I({},r),{data:a})}async function WIe(e,t,i){const r=await ohe(e,t,i,{returnCountOnly:!0}),s=r.data,n={};for(const o of s.relatedRecordGroups)o.objectId!=null&&(n[o.objectId]=o.count);return me(I({},r),{data:n})}async function ohe(e,t,i={},r){const s=$R(I(I(me(I({},e.query),{f:"json"}),r),HIe(t,r)));return Ci(e.path+"/queryRelatedRecords",me(I({},i),{query:I(I({},i.query),s)}))}async function XIe(e,t,i){t=y1.from(t);const r=wc(e);return qIe(r,t,i).then(s=>{const n=s.data,o={};return Object.keys(n).forEach(a=>o[a]=Q1.fromJSON(n[a])),o})}async function YIe(e,t,i){t=y1.from(t);const r=wc(e);return WIe(r,t,I({},i)).then(s=>s.data)}const ZY="Layer does not support extent calculation.";function ZIe(e,t){var i,r;const s=e.geometry,n=e.toJSON(),o=n;if(_(s)&&(o.geometry=JSON.stringify(s),o.geometryType=x0(s),o.inSR=s.spatialReference.wkid||JSON.stringify(s.spatialReference)),(i=n.topFilter)!=null&&i.groupByFields&&(o.topFilter.groupByFields=n.topFilter.groupByFields.join(",")),(r=n.topFilter)!=null&&r.orderByFields&&(o.topFilter.orderByFields=n.topFilter.orderByFields.join(",")),n.topFilter&&(o.topFilter=JSON.stringify(o.topFilter)),n.objectIds&&(o.objectIds=n.objectIds.join(",")),n.orderByFields&&(o.orderByFields=n.orderByFields.join(",")),n.outFields&&!(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?n.outFields.indexOf("*")!==-1?o.outFields="*":o.outFields=n.outFields.join(","):delete o.outFields,n.outSR?o.outSR=n.outSR.wkid||JSON.stringify(n.outSR):s&&n.returnGeometry&&(o.outSR=o.inSR),n.returnGeometry&&delete n.returnGeometry,n.timeExtent){const a=n.timeExtent,{start:l,end:c}=a;l==null&&c==null||(o.time=l===c?l:`${l==null?"null":l},${c==null?"null":c}`),delete n.timeExtent}return o}async function QIe(e,t,i,r){const s=await TN(e,t,"json",r);return nD(t,i,s.data),s}async function JIe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):TN(e,t,"json",i,{returnIdsOnly:!0})}async function KIe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):TN(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(ZY);if(s.hasOwnProperty("count"))throw new Error(ZY);return r})}function e$e(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):TN(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function TN(e,t,i,r={},s={}){const n=typeof e=="string"?Gn(e):e,o=t.geometry?[t.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",F7(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((t=t.clone()).geometry=l);const c=$R(I(I(me(I({},n.query),{f:i}),s),ZIe(t,s)));return Ci(r0(n.path,"queryTopFeatures"),me(I({},r),{query:I(I({},c),r.query)}))})}var VB;let gw=VB=class extends ve{constructor(e){super(e),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new VB({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],gw.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],gw.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],gw.prototype,"orderByFields",void 0),gw=VB=u([P("esri.rest.support.TopFilter")],gw);const t$e=gw;var GB;const QY=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),JY=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Tr=GB=class extends ve{constructor(e){super(e),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new GB(se({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],Tr.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],Tr.prototype,"distance",void 0),u([d({types:V1,json:{read:dm,write:!0}})],Tr.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Tr.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],Tr.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Tr.prototype,"num",void 0),u([d({json:{write:!0}})],Tr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Tr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Tr.prototype,"outFields",void 0),u([d({type:tt,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Tr.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],Tr.prototype,"resultType",void 0),u([d({json:{write:!0}})],Tr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Tr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Tr.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Tr.prototype,"start",void 0),u([Ge("start"),Ge("num")],Tr.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:QY.read},write:{target:"spatialRel",writer:QY.write}}})],Tr.prototype,"spatialRelationship",void 0),u([d({type:Ap,json:{write:!0}})],Tr.prototype,"timeExtent",void 0),u([d({type:t$e,json:{write:!0}})],Tr.prototype,"topFilter",void 0),u([d({type:String,json:{read:JY.read,write:{writer:JY.write,overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],Tr.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],Tr.prototype,"where",void 0),Tr=GB=u([P("esri.rest.support.TopFeaturesQuery")],Tr),Tr.from=ns(Tr);const $y=Tr;async function i$e(e,t,i,r){const s=wc(e),n=I({},r),{data:o}=await QIe(s,$y.from(t),i,n);return Q1.fromJSON(o)}async function r$e(e,t,i){const r=wc(e);return(await JIe(r,$y.from(t),I({},i))).data.objectIds}async function s$e(e,t,i){const r=wc(e),s=await KIe(r,$y.from(t),I({},i));return{count:s.data.count,extent:Zt.fromJSON(s.data.extent)}}async function n$e(e,t,i){const r=wc(e);return(await e$e(r,$y.from(t),I({},i))).data.count}let yw=class extends we{constructor(...e){super(...e),this.requestOptions=null,this.url=null}normalizeCtorArgs(e,t){return typeof e!="string"?e:I({url:e},t)}get parsedUrl(){return this._parseUrl(this.url)}_parseUrl(e){return e?Gn(e):null}_encode(e,t,i){const r={};for(const s in e){if(s==="declaredClass")continue;const n=e[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=this._encode(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=t?o:JSON.stringify(o)}else r[s]=t?n:JSON.stringify(n);else r[s]=n}return r}};u([d({readOnly:!0})],yw.prototype,"parsedUrl",null),u([d()],yw.prototype,"requestOptions",void 0),u([d({type:String})],yw.prototype,"url",void 0),yw=u([P("esri.tasks.Task")],yw);const o$e=yw;let hf=class extends o$e{constructor(e){super(e),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(e,t){return this.executeJSON(e,t).then(i=>this.featureSetFromJSON(e,i,t))}async executeJSON(e,t){var i;const r=I(I({},this.requestOptions),t),s=this._normalizeQuery(e),n=((i=e.outStatistics)==null?void 0:i[0])!=null,o=ue("featurelayer-pbf-statistics"),a=!n||o;let l;if(this.format==="pbf"&&a)try{l=await jIe(this.url,s,r)}catch(c){if(c.name!=="query:parsing-pbf")throw c;this.format="json"}return this.format!=="json"&&a||(l=await Hue(this.url,s,r)),this._normalizeFields(l.fields),l}async featureSetFromJSON(e,t,i){if(!(this._queryIs3DObjectFormat(e)&&_(this.infoFor3D)&&t.features&&t.features.length))return Q1.fromJSON(t);const{meshFeatureSetFromJSON:r}=await Ese(import("./meshFeatureSet.4da85dc6.js"),i);return r(e,this.infoFor3D,t)}executeForCount(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return _Ie(this.url,r,i)}executeForExtent(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return bIe(this.url,r,i)}executeForIds(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return wIe(this.url,r,i)}executeRelationshipQuery(e,t){e=y1.from(e);const i=I(I({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),XIe(this.url,e,i)}executeRelationshipQueryForCount(e,t){e=y1.from(e);const i=I(I({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),YIe(this.url,e,i)}executeAttachmentQuery(e,t){const i=I(I({},this.requestOptions),t);return V3e(this.url,e,i)}executeTopFeaturesQuery(e,t){const i=I(I({},this.requestOptions),t);return i$e(this.parsedUrl,e,this.sourceSpatialReference,i)}executeForTopIds(e,t){const i=I(I({},this.requestOptions),t);return r$e(this.parsedUrl,e,i)}executeForTopExtents(e,t){const i=I(I({},this.requestOptions),t);return s$e(this.parsedUrl,e,i)}executeForTopCount(e,t){const i=I(I({},this.requestOptions),t);return n$e(this.parsedUrl,e,i)}_normalizeQuery(e){let t=pa.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?ql.from(e.dynamicDataSource):this.dynamicDataSource),_(this.infoFor3D)&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;for(const i of this.infoFor3D.queryFormats){if(i.id==="3D_glb"){t.formatOf3DObjects=i.id;break}i.id!=="3D_gltf"||t.formatOf3DObjects||(t.formatOf3DObjects=i.id)}if(!t.formatOf3DObjects)throw new Q("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(O(t.outFields)||!t.outFields.includes("*")){t=t===e?t.clone():t,O(t.outFields)&&(t.outFields=[]);const{originX:i,originY:r,originZ:s,translationX:n,translationY:o,translationZ:a,scaleX:l,scaleY:c,scaleZ:h,rotationX:p,rotationY:f,rotationZ:g,rotationDeg:y}=this.infoFor3D.transformFieldRoles;t.outFields.push(i,r,s,n,o,a,l,c,h,p,f,g,y)}}return t}_normalizeFields(e){if(_(this.fieldsIndex)&&_(e))for(const t of e){const i=this.fieldsIndex.get(t.name);i&&Object.assign(t,i.toJSON())}}_queryIs3DObjectFormat(e){return _(this.infoFor3D)&&e.returnGeometry&&e.multipatchOption!=="xyFootprint"&&!e.outStatistics}};u([d({type:ql})],hf.prototype,"dynamicDataSource",void 0),u([d()],hf.prototype,"fieldsIndex",void 0),u([d()],hf.prototype,"format",void 0),u([d()],hf.prototype,"gdbVersion",void 0),u([d()],hf.prototype,"infoFor3D",void 0),u([d()],hf.prototype,"sourceSpatialReference",void 0),hf=u([P("esri.tasks.QueryTask")],hf);const a$e=hf,l$e="esri.widgets.Feature.support.relatedFeatureUtils",KY=he.getLogger(l$e),eZ=new Map;function yE(e){if(!Wf(e))return null;const[t,i]=e.split("/").slice(1);return{layerId:t,fieldName:i}}function c$e(e,t){if(!t.relationships)return null;let i=null;const{relationships:r}=t;return r.some(s=>s.id===parseInt(e,10)&&(i=s,!0)),i}function u$e({originRelationship:e,relationships:t,layerId:i}){let r;return t&&t.some(s=>(`${s.relatedTableId}`===i&&s.id===e.id&&(r=s),!!r)),r}function h$e(e,t){const i=t.toLowerCase();for(const r in e)if(r.toLowerCase()===i)return e[r];return null}function d$e(e,t){const i=c$e(e,t);if(!i)return;const r=`${t.url}/${i.relatedTableId}`;return{url:r,queryTask:new a$e({url:r,sourceSpatialReference:t.spatialReference}),relation:i,relatedFields:[],outStatistics:[]}}function p$e(e,t){if(!t||!e)return;const{features:i,statsFeatures:r}=e,s=i&&i.value;t.relatedFeatures=s?s.features:[];const n=r&&r.value;t.relatedStatsFeatures=n?n.features:[]}function f$e(e,t,i,r){const s=new y1;return s.outFields=["*"],s.relationshipId=typeof t.id=="number"?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[i.objectIdField]],i.queryRelatedFeatures(s,r)}function m$e(e,t,i){let r=0;const s=[];for(;r<t.length;)s.push(`${e} IN (${t.slice(r,i+r)})`),r+=i;return s.join(" OR ")}async function g$e(e,t,i,r){const s=i.layerId.toString(),{layerInfo:n,queryTask:o,relation:a,relatedFields:l,outStatistics:c}=t,h=u$e({originRelationship:a,relationships:n.relationships,layerId:s});if(h.relationshipTableId&&h.keyFieldInRelationshipTable){const f=(await f$e(e,h,i,r))[e.attributes[i.objectIdField]];if(!f)return null;const g=f.features.map(y=>y.attributes[n.objectIdField]);if((c==null?void 0:c.length)>0&&n.supportsStatistics){const y=new pa;y.where=m$e(n.objectIdField,g,1e3),y.outFields=l,y.outStatistics=c;const v={features:Promise.resolve(f),statsFeatures:o.execute(y)};return Sa(v)}}const p=h==null?void 0:h.keyField;if(p){const f=$L(w$e(n.fields,p)),g=h$e(e.attributes,a.keyField),y=f?`${p}=${g}`:`${p}='${g}'`,v=o.execute(new pa({where:y,outFields:t.relatedFields}),r),b=t.outStatistics&&t.outStatistics.length>0&&n.supportsStatistics?o.execute(new pa({where:y,outFields:t.relatedFields,outStatistics:t.outStatistics}),r):null,w={features:v};return b&&(w.statsFeatures=b),Sa(w)}return null}function y$e(e,t){return Ci(e,{query:{f:"json"},signal:t&&t.signal})}function v$e({relatedInfos:e,layer:t},i){const r={};return e.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new Q("relation-required","A relation is required on a layer to retrieve related records.");throw KY.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new Q("A related table ID is required on a layer to retrieve related records.");throw KY.error(p),p}const l=`${t.url}/${a}`,c=eZ.get(l),h=c||y$e(l,i);c||eZ.set(l,h),r[n]=h}),Sa(r)}function _$e({graphic:e,relatedInfos:t,layer:i},r){const s={};return t.forEach((n,o)=>{n.layerInfo&&(s[o]=g$e(e,n,i,r))}),Sa(s)}function b$e({relatedInfo:e,fieldName:t,fieldInfo:i}){if(e.relatedFields.push(t),i.statisticType){const r=new $ue({statisticType:i.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(r)}}function w$e(e,t){if(e!=null){t=t.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===t)return i}return null}const tZ={chartAnimation:!0};let sn=class extends we{constructor(e){super(e),this.abilities=I({},tZ),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return I(I({},tZ),e)}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:e,mediaInfos:t,formattedAttributes:i,expressionAttributes:r,fieldInfoMap:s,layer:n}=this;return t==null?void 0:t.map(o=>{const a=o==null?void 0:o.clone();if(!a)return null;if(a.title=R_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.title}),a.caption=R_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.caption}),a.altText=R_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.altText}),a.type==="image"){const{value:l}=a;return this._setImageValue({value:l,formattedAttributes:i,layer:n}),a.value.sourceURL?a:void 0}if(a.type==="pie-chart"||a.type==="line-chart"||a.type==="column-chart"||a.type==="bar-chart"){const{value:l}=a;return this._setChartValue({value:l,chartType:a.type,attributes:e,formattedAttributes:i,layer:n}),a}return null}).filter(Boolean)}_setImageValue(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:r,layer:s}=e,{linkURL:n,sourceURL:o}=i;if(o){const a=xB(o,s);i.sourceURL=wB({formattedAttributes:r,template:a,fieldInfoMap:t})}if(n){const a=xB(n,s);i.linkURL=wB({formattedAttributes:r,template:a,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:i,formattedAttributes:r,chartType:s,layer:n}=e,{popupTemplate:o,relatedInfos:a}=this,{fields:l,normalizeField:c}=t;if(t.fields=kPe(l,n),c&&(t.normalizeField=rD(c,n)),!l.some(p=>!!(r[p]!=null||Wf(p)&&a.size)))return;const h=o==null?void 0:o.fieldInfos;l.forEach(p=>{if(Wf(p))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:h,fieldName:p,formattedAttributes:r,chartType:s,value:t})]);const f=this._getChartOption({value:t,attributes:i,chartType:s,formattedAttributes:r,fieldName:p,fieldInfos:h});t.series.push(f)})}_getRelatedChartInfos(e){var t;const{fieldInfos:i,fieldName:r,formattedAttributes:s,chartType:n,value:o}=e,a=[],l=yE(r),{layerId:c,fieldName:h}=l,p=(t=this.relatedInfos)==null?void 0:t.get(c.toString());if(!p)return a;const{relatedFeatures:f,relation:g}=p;if(!g||!f)return a;const{cardinality:y}=g;return f.forEach(v=>{const{attributes:b}=v;b&&Object.keys(b).forEach(w=>{w===h&&a.push(this._getChartOption({value:o,attributes:b,formattedAttributes:s,fieldName:r,chartType:n,relatedFieldName:w,fieldInfos:i}))})}),y==="one-to-many"||y==="many-to-many"?a:[a[0]]}_getTooltip({label:e,value:t,chartType:i}){return i==="pie-chart"?e:`${e}: ${t}`}_getChartOption(e){var t;const{value:i,attributes:r,formattedAttributes:s,fieldName:n,relatedFieldName:o,fieldInfos:a,chartType:l}=e,{layer:c}=this,{normalizeField:h,tooltipField:p}=i,f=h?Wf(h)?r[yE(h).fieldName]:r[h]:null,g=o&&r[o]!==void 0?r[o]:r[n]!==void 0?r[n]:s[n],y=g===void 0?null:g&&f?g/f:g,v=new aoe({value:y});if(Wf(n)){const A=yE(n),C=yE(p),R=C?C.fieldName:null,L=xue(y,{fieldInfos:a,fieldName:o,layer:c,preventPlacesFormatting:!!f}),U=A?A.label||A.fieldName:o,N=R&&r[R]!==void 0?r[R]:U;return v.tooltip=this._getTooltip({label:N,value:L,chartType:l}),v}const b=Tue(a,n),w=rD(n,c),S=p&&s[p]!==void 0?s[p]:bue(b||new SR({fieldName:w}),(t=this.popupTemplate)==null?void 0:t.expressionInfos),T=s[w];return v.tooltip=this._getTooltip({label:S,value:T,chartType:l}),v}};u([d()],sn.prototype,"abilities",void 0),u([It("abilities")],sn.prototype,"castAbilities",null),u([d()],sn.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],sn.prototype,"activeMediaInfo",null),u([d()],sn.prototype,"attributes",void 0),u([d()],sn.prototype,"description",void 0),u([d()],sn.prototype,"fieldInfoMap",void 0),u([d()],sn.prototype,"formattedAttributes",void 0),u([d()],sn.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],sn.prototype,"formattedMediaInfos",null),u([d()],sn.prototype,"layer",void 0),u([d({readOnly:!0})],sn.prototype,"formattedMediaInfoCount",null),u([d()],sn.prototype,"mediaInfos",void 0),u([d()],sn.prototype,"popupTemplate",void 0),u([d()],sn.prototype,"relatedInfos",void 0),u([d()],sn.prototype,"title",void 0),sn=u([P("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],sn);const M_=sn;var iZ=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],x$e=[].concat(iZ.slice(30,39),iZ.slice(28,30).reverse()),T$e=[{name:"default",colors:x$e},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const rZ="en-us",j7=new Map([["ar",()=>import("./ar.4e64ecc8.js").then(e=>e.a)],["bg-bg",()=>import("./bg_BG.4a4da69f.js").then(e=>e.b)],["bs-ba",()=>import("./bs_BA.3beb2703.js").then(e=>e.b)],["ca-es",()=>import("./ca_ES.bff7eb46.js").then(e=>e.c)],["cs-cz",()=>import("./cs_CZ.47337f04.js").then(e=>e.c)],["da-dk",()=>import("./da_DK.5c755859.js").then(e=>e.d)],["de-de",()=>import("./de_DE.ce79023e.js").then(e=>e.d)],["de-ch",()=>import("./de_CH.c1a4e07c.js").then(e=>e.d)],["el-gr",()=>import("./el_GR.efb4af58.js").then(e=>e.e)],["en-us",()=>import("./en_US.c577054a.js").then(e=>e.e)],["en-ca",()=>import("./en_CA.e3bf8300.js").then(e=>e.e)],["es-es",()=>import("./es_ES.442fe4df.js").then(e=>e.e)],["et-ee",()=>import("./et_EE.42c4c968.js").then(e=>e.e)],["fi-fi",()=>import("./fi_FI.648fd5d2.js").then(e=>e.f)],["fr-fr",()=>import("./fr_FR.c6475b38.js").then(e=>e.f)],["he-il",()=>import("./he_IL.55df394b.js").then(e=>e.h)],["hr-hr",()=>import("./hr_HR.dd490c78.js").then(e=>e.h)],["hu-hu",()=>import("./hu_HU.55595345.js").then(e=>e.h)],["id-id",()=>import("./id_ID.141aeb79.js").then(e=>e.i)],["it-it",()=>import("./it_IT.99f05a90.js").then(e=>e.i)],["ja-jp",()=>import("./ja_JP.99c4da4e.js").then(e=>e.j)],["ko-kr",()=>import("./ko_KR.ce4c7ad4.js").then(e=>e.k)],["lt-lt",()=>import("./lt_LT.89740356.js").then(e=>e.l)],["lv-lv",()=>import("./lv_LV.0f8132f1.js").then(e=>e.l)],["nb-no",()=>import("./nb_NO.18a09c4c.js").then(e=>e.n)],["nl-nl",()=>import("./nl_NL.8659eb66.js").then(e=>e.n)],["pl-pl",()=>import("./pl_PL.b183b047.js").then(e=>e.p)],["pt-br",()=>import("./pt_BR.6c0e489f.js").then(e=>e.p)],["pt-pt",()=>import("./pt_PT.97c9e45d.js").then(e=>e.p)],["ro-ro",()=>import("./ro_RO.da8d76f3.js").then(e=>e.r)],["ru-ru",()=>import("./ru_RU.cf37517e.js").then(e=>e.r)],["sk-sk",()=>import("./sk_SK.832065f9.js").then(e=>e.s)],["sl-sl",()=>import("./sl_SL.bce70cf7.js").then(e=>e.s)],["sr-rs",()=>import("./sr_RS.bbc8e817.js").then(e=>e.s)],["sv-se",()=>import("./sv_SE.c3a79bc2.js").then(e=>e.s)],["th-th",()=>import("./th_TH.9bbfe7b0.js").then(e=>e.t)],["tr-tr",()=>import("./tr_TR.1f2c53d1.js").then(e=>e.t)],["uk-ua",()=>import("./uk_UA.ea089724.js").then(e=>e.u)],["vi-vn",()=>import("./vi_VN.3bd55ddc.js").then(e=>e.v)],["zh-cn",()=>import("./zh_Hans.8d6fc46e.js").then(e=>e.z)],["zh-hk",()=>import("./zh_Hant.b1837c9a.js").then(e=>e.z)],["zh-tw",()=>import("./zh_Hant.b1837c9a.js").then(e=>e.z)]]);function S$e(e){const t=e.split("-")[0].toLowerCase();let i=null;for(const r of j7.keys())if(r.startsWith(t)){i=r;break}return i}function E$e(e){return e?j7.has(e.toLowerCase())?e.toLowerCase():S$e(e)||rZ:rZ}let ub,GS;async function A$e(e=sc()){if(e=E$e(e),ub&&e===GS)return ub;ub=import("./index.122d4706.js").then(t=>t.i),GS=e;try{const[t,i]=await Promise.all([ub,j7.get(GS)()]);GS===e&&(t.am4core.options.defaultLocale=i.default),t.am4core.options.suppressWarnings=!0,t.am4core.options.autoDispose=!0}catch{return ub=null,GS=null,null}return ub}function C$e(e,t="default"){const i=T$e.find(r=>r.name===t);return i?i.colors.map(r=>e.color(r)):null}const Wr={base:"esri-feature-media",mediaContainer:"esri-feature-media__container",mediaItemContainer:"esri-feature-media__item-container",mediaItem:"esri-feature-media__item",mediaItemTitle:"esri-feature-media__item-title",mediaItemCaption:"esri-feature-media__item-caption",mediaPrevious:"esri-feature-media__previous",mediaPreviousIconLTR:"esri-feature-media__previous-icon",mediaPreviousIconRTL:"esri-feature-media__previous-icon--rtl",mediaNext:"esri-feature-media__next",mediaNextIconLTR:"esri-feature-media__next-icon",mediaNextIconRTL:"esri-feature-media__next-icon--rtl",mediaChart:"esri-feature-media__chart",mediaButton:"esri-feature-media__button",mediaIcon:"esri-feature-media__icon",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},Q4=.05,J4=.95,K4=15;let Ua=class extends Ra{constructor(e,t){super(e,t),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.description=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null,this.viewModel=new M_,this.messages=null,this._getChartDependencies=async i=>{const r=await A$e(),{destroyed:s,viewModel:n}=this;if(s||!n||!i)return;const{activeMediaInfo:o}=n;this._renderChart({chartDiv:i,mediaInfo:o,chartsModule:r})}}initialize(){this._featureElementInfo=new L7,this.own(Wt(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],()=>this._setupMediaRefreshTimer()),Wt(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo()))}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo.destroy()}render(){var e;return le("div",{bind:this,class:Wr.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?le("div",{key:"media-element-container",class:Wr.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:s,refreshInterval:n,altText:o,title:a,type:l}=e,{sourceURL:c,linkURL:h}=s,p=vue(h)?"_blank":"_self",f=p==="_blank"?"noreferrer":"",g=n?t:null,y=g?g.timestamp:0,v=g?g.sourceURL:c,b=le("img",{alt:o||a,key:`media-${l}-${i}-${r}-${y}`,src:v});return(h?le("a",{title:a,href:h,rel:f,target:p},b):null)||b}renderChartMediaInfo(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return le("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:Wr.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this.renderImageMediaInfo(e):e.type.indexOf("chart")!==-1?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e.title?le("div",{key:"media-title",class:Wr.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?le("div",{key:"media-caption",class:Wr.mediaItemCaption,innerHTML:e.caption}):null;return le("div",{key:"media-container",class:Wr.mediaItemContainer},le("div",{key:"media-item-container",class:Wr.mediaItem},this.renderMediaInfoType()),t,i)}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t=e==="previous",i=t?this.messages.previous:this.messages.next,r=t?this.classes(Wr.mediaButton,Wr.mediaPrevious):this.classes(Wr.mediaButton,Wr.mediaNext),s=t?this.classes(Wr.mediaIcon,Wr.mediaPreviousIconLTR,Wr.iconLeftTriangleArrow):this.classes(Wr.mediaIcon,Wr.mediaNextIconLTR,Wr.iconRightTriangleArrow),n=t?this.classes(Wr.mediaIcon,Wr.mediaPreviousIconRTL,Wr.iconRightTriangleArrow):this.classes(Wr.mediaIcon,Wr.mediaNextIconRTL,Wr.iconLeftTriangleArrow),o=t?"media-previous":"media-next",a=t?this._previous:this._next;return le("button",{type:"button",key:o,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:a},le("span",{"aria-hidden":"true",class:s}),le("span",{"aria-hidden":"true",class:n}))}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_handleMediaKeyup(e){const t=l_(e);t==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{abilities:t}=this.viewModel,{chartsModule:i,chartDiv:r,mediaInfo:s}=e,{value:n,type:o}=s,{am4core:a}=i,l=C$e(a);function c(f){f instanceof a.ColorSet&&l&&(f.list=l)}hue()&&a.useTheme(i.am4themes_dark);const h=window.matchMedia("(prefers-reduced-motion: reduce)");t.chartAnimation&&!h.matches?a.useTheme(i.am4themes_animated):a.unuseTheme(i.am4themes_animated),a.useTheme(c);const p=o==="pie-chart"?this._createPieChart(e):this._createXYChart(e);r.setAttribute("aria-label",s.altText||s.title),p.data=n.series.map(f=>({tooltip:f.tooltip,value:f.value})).filter(f=>o!=="pie-chart"||f.value>0)}_customizeChartTooltip(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})}_createPieChart(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:s}=i,n=r.create(t,s.PieChart);n.rtl=Py(this.container);const o=n.series.push(new s.PieSeries);return o.labels.template.disabled=!0,o.ticks.template.disabled=!0,o.dataFields.value="value",o.dataFields.category="tooltip",this._customizeChartTooltip(o.tooltip,r),o.slices.template.tooltipText=n.rtl?"{category}: %{value.percent.formatNumber('#.0')}":"{category}: {value.percent.formatNumber('#.0')}%",n}_getMinSeriesValue(e){let t=0;return e.forEach(i=>t=Math.min(i.value,t)),t}_createColumnChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=e.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=Q4,l.renderer.maxLabelPosition=J4,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueY="value",h.dataFields.categoryX="tooltip",e.cursor=new o.XYCursor,s.series.length>K4&&(e.scrollbarX=new n.Scrollbar)}_createBarChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.yAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.inversed=!0,a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dx=a.tooltip.contentWidth});const l=e.xAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=Q4,l.renderer.maxLabelPosition=J4,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueX="value",h.dataFields.categoryY="tooltip",e.cursor=new o.XYCursor,s.series.length>K4&&(e.scrollbarY=new n.Scrollbar)}_createLineChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=e.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=Q4,l.renderer.maxLabelPosition=J4,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.LineSeries);h.dataFields.categoryX="tooltip",h.dataFields.valueY="value",e.cursor=new o.XYCursor,s.series.length>K4&&(e.scrollbarX=new n.Scrollbar)}_createXYChart(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:s}=r,{am4core:n,am4charts:o}=i,a=n.create(t,o.XYChart);return a.rtl=Py(this.container),s==="column-chart"&&this._createColumnChart(a,e),s==="bar-chart"&&this._createBarChart(a,e),s==="line-chart"&&this._createLineChart(a,e),a}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const s=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},r);this._refreshTimer=s}_getImageSource(e,t){const i=e.indexOf("?")!==-1?"&":"?",[r,s=""]=e.split("#");return`${r}${i}timestamp=${t}${s?"#":""}${s}`}};u([mt("viewModel.attributes")],Ua.prototype,"attributes",void 0),u([mt("viewModel.activeMediaInfoIndex")],Ua.prototype,"activeMediaInfoIndex",void 0),u([mt("viewModel.description")],Ua.prototype,"description",void 0),u([mt("viewModel.fieldInfoMap")],Ua.prototype,"fieldInfoMap",void 0),u([mt("viewModel.layer")],Ua.prototype,"layer",void 0),u([mt("viewModel.mediaInfos")],Ua.prototype,"mediaInfos",void 0),u([mt("viewModel.popupTemplate")],Ua.prototype,"popupTemplate",void 0),u([mt("viewModel.relatedInfos")],Ua.prototype,"relatedInfos",void 0),u([mt("viewModel.title")],Ua.prototype,"title",void 0),u([d({type:M_})],Ua.prototype,"viewModel",void 0),u([d(),ul("esri/widgets/Feature/t9n/Feature")],Ua.prototype,"messages",void 0),Ua=u([P("esri.widgets.Feature.FeatureMedia")],Ua);const ahe=Ua;class R$e{constructor(t,i){this.definition=null,this.context=null,this.definition=t,this.context=i}}class Cp{constructor(t=[]){this._elements=t}length(){return this._elements.length}get(t){return this._elements[t]}toArray(){const t=[];for(let i=0;i<this.length();i++)t.push(this.get(i));return t}}class J1 extends Cp{constructor(t,i,r,s,n,o){super(t),this._lazyPt=[],this._hasZ=!1,this._hasM=!1,this._spRef=i,this._hasZ=r,this._hasM=s,this._cacheId=n,this._partId=o}get(t){if(this._lazyPt[t]===void 0){const i=this._elements[t];if(i===void 0)return;const r=this._hasZ,s=this._hasM;let n=null;n=r&&!s?new Ke(i[0],i[1],i[2],void 0,this._spRef):s&&!r?new Ke(i[0],i[1],void 0,i[2],this._spRef):r&&s?new Ke(i[0],i[1],i[2],i[3],this._spRef):new Ke(i[0],i[1],this._spRef),n.cache._arcadeCacheId=this._cacheId.toString()+"-"+this._partId.toString()+"-"+t.toString(),this._lazyPt[t]=n}return this._lazyPt[t]}equalityTest(t){return t===this||t!==null&&t instanceof J1&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()+"-"+this._partId.toString()}}class H7 extends Cp{constructor(t,i,r,s,n){super(t),this._lazyPath=[],this._hasZ=!1,this._hasM=!1,this._hasZ=r,this._hasM=s,this._spRef=i,this._cacheId=n}get(t){if(this._lazyPath[t]===void 0){const i=this._elements[t];if(i===void 0)return;this._lazyPath[t]=new J1(i,this._spRef,this._hasZ,this._hasM,this._cacheId,t)}return this._lazyPath[t]}equalityTest(t){return t===this||t!==null&&t instanceof H7&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()}}class K1 extends Error{}class O$e extends K1{constructor(t){super(`Invalid DateTime: ${t.toMessage()}`)}}class M$e extends K1{constructor(t){super(`Invalid Interval: ${t.toMessage()}`)}}class P$e extends K1{constructor(t){super(`Invalid Duration: ${t.toMessage()}`)}}class vE extends K1{}class lhe extends K1{constructor(t){super(`Invalid unit ${t}`)}}class au extends K1{}class Zm extends K1{constructor(){super("Zone is an abstract class")}}const He="numeric",jh="short",lc="long",jB={year:He,month:He,day:He},che={year:He,month:jh,day:He},I$e={year:He,month:jh,day:He,weekday:jh},uhe={year:He,month:lc,day:He},hhe={year:He,month:lc,day:He,weekday:lc},dhe={hour:He,minute:He},phe={hour:He,minute:He,second:He},fhe={hour:He,minute:He,second:He,timeZoneName:jh},mhe={hour:He,minute:He,second:He,timeZoneName:lc},ghe={hour:He,minute:He,hourCycle:"h23"},yhe={hour:He,minute:He,second:He,hourCycle:"h23"},vhe={hour:He,minute:He,second:He,hourCycle:"h23",timeZoneName:jh},_he={hour:He,minute:He,second:He,hourCycle:"h23",timeZoneName:lc},bhe={year:He,month:He,day:He,hour:He,minute:He},whe={year:He,month:He,day:He,hour:He,minute:He,second:He},xhe={year:He,month:jh,day:He,hour:He,minute:He},The={year:He,month:jh,day:He,hour:He,minute:He,second:He},$$e={year:He,month:jh,day:He,weekday:jh,hour:He,minute:He},She={year:He,month:lc,day:He,hour:He,minute:He,timeZoneName:jh},Ehe={year:He,month:lc,day:He,hour:He,minute:He,second:He,timeZoneName:jh},Ahe={year:He,month:lc,day:He,weekday:lc,hour:He,minute:He,timeZoneName:lc},Che={year:He,month:lc,day:He,weekday:lc,hour:He,minute:He,second:He,timeZoneName:lc};function Ei(e){return typeof e=="undefined"}function Y_(e){return typeof e=="number"}function SN(e){return typeof e=="number"&&e%1===0}function D$e(e){return typeof e=="string"}function L$e(e){return Object.prototype.toString.call(e)==="[object Date]"}function Rhe(){try{return typeof Intl!="undefined"&&!!Intl.RelativeTimeFormat}catch{return!1}}function N$e(e){return Array.isArray(e)?e:[e]}function sZ(e,t,i){if(e.length!==0)return e.reduce((r,s)=>{const n=[t(s),s];return r&&i(r[0],n[0])===r[0]?r:n},null)[1]}function F$e(e,t){return t.reduce((i,r)=>(i[r]=e[r],i),{})}function _T(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Xf(e,t,i){return SN(e)&&e>=t&&e<=i}function U$e(e,t){return e-t*Math.floor(e/t)}function qs(e,t=2){const i=e<0;let r;return i?r="-"+(""+-e).padStart(t,"0"):r=(""+e).padStart(t,"0"),r}function sy(e){if(!(Ei(e)||e===null||e===""))return parseInt(e,10)}function I0(e){if(!(Ei(e)||e===null||e===""))return parseFloat(e)}function q7(e){if(!(Ei(e)||e===null||e==="")){const t=parseFloat("0."+e)*1e3;return Math.floor(t)}}function W7(e,t,i=!1){const r=10**t;return(i?Math.trunc:Math.round)(e*r)/r}function LR(e){return e%4===0&&(e%100!==0||e%400===0)}function bA(e){return LR(e)?366:365}function aD(e,t){const i=U$e(t-1,12)+1,r=e+(t-i)/12;return i===2?LR(r)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][i-1]}function X7(e){let t=Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond);return e.year<100&&e.year>=0&&(t=new Date(t),t.setUTCFullYear(t.getUTCFullYear()-1900)),+t}function lD(e){const t=(e+Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400))%7,i=e-1,r=(i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400))%7;return t===4||r===3?53:52}function HB(e){return e>99?e:e>60?1900+e:2e3+e}function Ohe(e,t,i,r=null){const s=new Date(e),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};r&&(n.timeZone=r);const o=I({timeZoneName:t},n),a=new Intl.DateTimeFormat(i,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function EN(e,t){let i=parseInt(e,10);Number.isNaN(i)&&(i=0);const r=parseInt(t,10)||0,s=i<0||Object.is(i,-0)?-r:r;return i*60+s}function Mhe(e){const t=Number(e);if(typeof e=="boolean"||e===""||Number.isNaN(t))throw new au(`Invalid unit value ${e}`);return t}function cD(e,t){const i={};for(const r in e)if(_T(e,r)){const s=e[r];if(s==null)continue;i[t(r)]=Mhe(s)}return i}function uD(e,t){const i=Math.trunc(Math.abs(e/60)),r=Math.trunc(Math.abs(e%60)),s=e>=0?"+":"-";switch(t){case"short":return`${s}${qs(i,2)}:${qs(r,2)}`;case"narrow":return`${s}${i}${r>0?`:${r}`:""}`;case"techie":return`${s}${qs(i,2)}${qs(r,2)}`;default:throw new RangeError(`Value format ${t} is out of range for property format`)}}function AN(e){return F$e(e,["hour","minute","second","millisecond"])}const k$e=/[A-Za-z_+-]{1,256}(:?\/[A-Za-z0-9_+-]{1,256}(\/[A-Za-z0-9_+-]{1,256})?)?/,z$e=["January","February","March","April","May","June","July","August","September","October","November","December"],Phe=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B$e=["J","F","M","A","M","J","J","A","S","O","N","D"];function Ihe(e){switch(e){case"narrow":return[...B$e];case"short":return[...Phe];case"long":return[...z$e];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const $he=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Dhe=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],V$e=["M","T","W","T","F","S","S"];function Lhe(e){switch(e){case"narrow":return[...V$e];case"short":return[...Dhe];case"long":return[...$he];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const Nhe=["AM","PM"],G$e=["Before Christ","Anno Domini"],j$e=["BC","AD"],H$e=["B","A"];function Fhe(e){switch(e){case"narrow":return[...H$e];case"short":return[...j$e];case"long":return[...G$e];default:return null}}function q$e(e){return Nhe[e.hour<12?0:1]}function W$e(e,t){return Lhe(t)[e.weekday-1]}function X$e(e,t){return Ihe(t)[e.month-1]}function Y$e(e,t){return Fhe(t)[e.year<0?0:1]}function Z$e(e,t,i="always",r=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(e)===-1;if(i==="auto"&&n){const p=e==="days";switch(t){case 1:return p?"tomorrow":`next ${s[e][0]}`;case-1:return p?"yesterday":`last ${s[e][0]}`;case 0:return p?"today":`this ${s[e][0]}`}}const o=Object.is(t,-0)||t<0,a=Math.abs(t),l=a===1,c=s[e],h=r?l?c[1]:c[2]||c[1]:l?s[e][0]:e;return o?`${a} ${h} ago`:`in ${a} ${h}`}function nZ(e,t){let i="";for(const r of e)r.literal?i+=r.val:i+=t(r.val);return i}const Q$e={D:jB,DD:che,DDD:uhe,DDDD:hhe,t:dhe,tt:phe,ttt:fhe,tttt:mhe,T:ghe,TT:yhe,TTT:vhe,TTTT:_he,f:bhe,ff:xhe,fff:She,ffff:Ahe,F:whe,FF:The,FFF:Ehe,FFFF:Che};class ol{static create(t,i={}){return new ol(t,i)}static parseFormat(t){let i=null,r="",s=!1;const n=[];for(let o=0;o<t.length;o++){const a=t.charAt(o);a==="'"?(r.length>0&&n.push({literal:s,val:r}),i=null,r="",s=!s):s||a===i?r+=a:(r.length>0&&n.push({literal:!1,val:r}),r=a,i=a)}return r.length>0&&n.push({literal:s,val:r}),n}static macroTokenToFormatOpts(t){return Q$e[t]}constructor(t,i){this.opts=i,this.loc=t,this.systemLoc=null}formatWithSystemDefault(t,i){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(t,I(I({},this.opts),i)).format()}formatDateTime(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).format()}formatDateTimeParts(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).formatToParts()}resolvedOptions(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).resolvedOptions()}num(t,i=0){if(this.opts.forceSimple)return qs(t,i);const r=I({},this.opts);return i>0&&(r.padTo=i),this.loc.numberFormatter(r).format(t)}formatDateTimeFromString(t,i){const r=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(g,y)=>this.loc.extract(t,g,y),o=g=>t.isOffsetFixed&&t.offset===0&&g.allowZ?"Z":t.isValid?t.zone.formatOffset(t.ts,g.format):"",a=()=>r?q$e(t):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(g,y)=>r?X$e(t,g):n(y?{month:g}:{month:g,day:"numeric"},"month"),c=(g,y)=>r?W$e(t,g):n(y?{weekday:g}:{weekday:g,month:"long",day:"numeric"},"weekday"),h=g=>{const y=ol.macroTokenToFormatOpts(g);return y?this.formatWithSystemDefault(t,y):g},p=g=>r?Y$e(t,g):n({era:g},"era"),f=g=>{switch(g){case"S":return this.num(t.millisecond);case"u":case"SSS":return this.num(t.millisecond,3);case"s":return this.num(t.second);case"ss":return this.num(t.second,2);case"uu":return this.num(Math.floor(t.millisecond/10),2);case"uuu":return this.num(Math.floor(t.millisecond/100));case"m":return this.num(t.minute);case"mm":return this.num(t.minute,2);case"h":return this.num(t.hour%12===0?12:t.hour%12);case"hh":return this.num(t.hour%12===0?12:t.hour%12,2);case"H":return this.num(t.hour);case"HH":return this.num(t.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return t.zone.offsetName(t.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return t.zone.offsetName(t.ts,{format:"long",locale:this.loc.locale});case"z":return t.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(t.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(t.day,2);case"c":return this.num(t.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(t.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(t.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(t.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(t.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(t.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(t.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(t.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(t.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(t.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(t.weekYear.toString().slice(-2),2);case"kkkk":return this.num(t.weekYear,4);case"W":return this.num(t.weekNumber);case"WW":return this.num(t.weekNumber,2);case"o":return this.num(t.ordinal);case"ooo":return this.num(t.ordinal,3);case"q":return this.num(t.quarter);case"qq":return this.num(t.quarter,2);case"X":return this.num(Math.floor(t.ts/1e3));case"x":return this.num(t.ts);default:return h(g)}};return nZ(ol.parseFormat(i),f)}formatDurationFromString(t,i){const r=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=r(c);return h?this.num(l.get(h),c.length):c},n=ol.parseFormat(i),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=t.shiftTo(...o.map(r).filter(l=>l));return nZ(n,s(a))}}class Oh{constructor(t,i){this.reason=t,this.explanation=i}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}class NR{get type(){throw new Zm}get name(){throw new Zm}get isUniversal(){throw new Zm}offsetName(t,i){throw new Zm}formatOffset(t,i){throw new Zm}offset(t){throw new Zm}equals(t){throw new Zm}get isValid(){throw new Zm}}let e5=null;class Y7 extends NR{static get instance(){return e5===null&&(e5=new Y7),e5}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return Ohe(t,i,r)}formatOffset(t,i){return uD(this.offset(t),i)}offset(t){return-new Date(t).getTimezoneOffset()}equals(t){return t.type==="system"}get isValid(){return!0}}let V3={};function J$e(e){return V3[e]||(V3[e]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})),V3[e]}const K$e={year:0,month:1,day:2,hour:3,minute:4,second:5};function eDe(e,t){const i=e.format(t).replace(/\u200E/g,""),r=/(\d+)\/(\d+)\/(\d+),? (\d+):(\d+):(\d+)/.exec(i),[,s,n,o,a,l,c]=r;return[o,s,n,a,l,c]}function tDe(e,t){const i=e.formatToParts(t),r=[];for(let s=0;s<i.length;s++){const{type:n,value:o}=i[s],a=K$e[n];Ei(a)||(r[a]=parseInt(o,10))}return r}let XO={};class ym extends NR{static create(t){return XO[t]||(XO[t]=new ym(t)),XO[t]}static resetCache(){XO={},V3={}}static isValidSpecifier(t){return this.isValidZone(t)}static isValidZone(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}).format(),!0}catch{return!1}}constructor(t){super();this.zoneName=t,this.valid=ym.isValidZone(t)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return Ohe(t,i,r,this.name)}formatOffset(t,i){return uD(this.offset(t),i)}offset(t){const i=new Date(t);if(isNaN(i))return NaN;const r=J$e(this.name),[s,n,o,a,l,c]=r.formatToParts?tDe(r,i):eDe(r,i),p=X7({year:s,month:n,day:o,hour:a===24?0:a,minute:l,second:c,millisecond:0});let f=+i;const g=f%1e3;return f-=g>=0?g:1e3+g,(p-f)/(60*1e3)}equals(t){return t.type==="iana"&&t.name===this.name}get isValid(){return this.valid}}let t5=null;class ga extends NR{static get utcInstance(){return t5===null&&(t5=new ga(0)),t5}static instance(t){return t===0?ga.utcInstance:new ga(t)}static parseSpecifier(t){if(t){const i=t.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(i)return new ga(EN(i[1],i[2]))}return null}constructor(t){super();this.fixed=t}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${uD(this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(t,i){return uD(this.fixed,i)}get isUniversal(){return!0}offset(){return this.fixed}equals(t){return t.type==="fixed"&&t.fixed===this.fixed}get isValid(){return!0}}class iDe extends NR{constructor(t){super();this.zoneName=t}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function my(e,t){if(Ei(e)||e===null)return t;if(e instanceof NR)return e;if(D$e(e)){const i=e.toLowerCase();return i==="local"||i==="system"?t:i==="utc"||i==="gmt"?ga.utcInstance:ga.parseSpecifier(i)||ym.create(e)}else return Y_(e)?ga.instance(e):typeof e=="object"&&e.offset&&typeof e.offset=="number"?e:new iDe(e)}let oZ=()=>Date.now(),aZ="system",lZ=null,cZ=null,uZ=null,hZ;class an{static get now(){return oZ}static set now(t){oZ=t}static set defaultZone(t){aZ=t}static get defaultZone(){return my(aZ,Y7.instance)}static get defaultLocale(){return lZ}static set defaultLocale(t){lZ=t}static get defaultNumberingSystem(){return cZ}static set defaultNumberingSystem(t){cZ=t}static get defaultOutputCalendar(){return uZ}static set defaultOutputCalendar(t){uZ=t}static get throwOnInvalid(){return hZ}static set throwOnInvalid(t){hZ=t}static resetCaches(){es.resetCache(),ym.resetCache()}}let dZ={};function rDe(e,t={}){const i=JSON.stringify([e,t]);let r=dZ[i];return r||(r=new Intl.ListFormat(e,t),dZ[i]=r),r}let qB={};function WB(e,t={}){const i=JSON.stringify([e,t]);let r=qB[i];return r||(r=new Intl.DateTimeFormat(e,t),qB[i]=r),r}let XB={};function sDe(e,t={}){const i=JSON.stringify([e,t]);let r=XB[i];return r||(r=new Intl.NumberFormat(e,t),XB[i]=r),r}let YB={};function nDe(e,t={}){const o=t,{base:i}=o,r=n4(o,["base"]),s=JSON.stringify([e,r]);let n=YB[s];return n||(n=new Intl.RelativeTimeFormat(e,t),YB[s]=n),n}let _E=null;function oDe(){return _E||(_E=new Intl.DateTimeFormat().resolvedOptions().locale,_E)}function aDe(e){const t=e.indexOf("-u-");if(t===-1)return[e];{let i;const r=e.substring(0,t);try{i=WB(e).resolvedOptions()}catch{i=WB(r).resolvedOptions()}const{numberingSystem:s,calendar:n}=i;return[r,s,n]}}function lDe(e,t,i){return(i||t)&&(e+="-u",i&&(e+=`-ca-${i}`),t&&(e+=`-nu-${t}`)),e}function cDe(e){const t=[];for(let i=1;i<=12;i++){const r=zt.utc(2016,i,1);t.push(e(r))}return t}function uDe(e){const t=[];for(let i=1;i<=7;i++){const r=zt.utc(2016,11,13+i);t.push(e(r))}return t}function YO(e,t,i,r,s){const n=e.listingMode(i);return n==="error"?null:n==="en"?r(t):s(t)}function hDe(e){return e.numberingSystem&&e.numberingSystem!=="latn"?!1:e.numberingSystem==="latn"||!e.locale||e.locale.startsWith("en")||new Intl.DateTimeFormat(e.intl).resolvedOptions().numberingSystem==="latn"}class dDe{constructor(t,i,r){this.padTo=r.padTo||0,this.floor=r.floor||!1;const a=r,{padTo:s,floor:n}=a,o=n4(a,["padTo","floor"]);if(!i||Object.keys(o).length>0){const l=I({useGrouping:!1},r);r.padTo>0&&(l.minimumIntegerDigits=r.padTo),this.inf=sDe(t,l)}}format(t){if(this.inf){const i=this.floor?Math.floor(t):t;return this.inf.format(i)}else{const i=this.floor?Math.floor(t):W7(t,3);return qs(i,this.padTo)}}}class pDe{constructor(t,i,r){this.opts=r;let s;if(t.zone.isUniversal){const o=-1*(t.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;t.offset!==0&&ym.create(a).valid?(s=a,this.dt=t):(s="UTC",r.timeZoneName?this.dt=t:this.dt=t.offset===0?t:zt.fromMillis(t.ts+t.offset*60*1e3))}else t.zone.type==="system"?this.dt=t:(this.dt=t,s=t.zone.name);const n=I({},this.opts);s&&(n.timeZone=s),this.dtf=WB(i,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class fDe{constructor(t,i,r){this.opts=I({style:"long"},r),!i&&Rhe()&&(this.rtf=nDe(t,r))}format(t,i){return this.rtf?this.rtf.format(t,i):Z$e(i,t,this.opts.numeric,this.opts.style!=="long")}formatToParts(t,i){return this.rtf?this.rtf.formatToParts(t,i):[]}}class es{static fromOpts(t){return es.create(t.locale,t.numberingSystem,t.outputCalendar,t.defaultToEN)}static create(t,i,r,s=!1){const n=t||an.defaultLocale,o=n||(s?"en-US":oDe()),a=i||an.defaultNumberingSystem,l=r||an.defaultOutputCalendar;return new es(o,a,l,n)}static resetCache(){_E=null,qB={},XB={},YB={}}static fromObject({locale:t,numberingSystem:i,outputCalendar:r}={}){return es.create(t,i,r)}constructor(t,i,r,s){const[n,o,a]=aDe(t);this.locale=n,this.numberingSystem=i||o||null,this.outputCalendar=r||a||null,this.intl=lDe(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=hDe(this)),this.fastNumbersCached}listingMode(){const t=this.isEnglish(),i=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return t&&i?"en":"intl"}clone(t){return!t||Object.getOwnPropertyNames(t).length===0?this:es.create(t.locale||this.specifiedLocale,t.numberingSystem||this.numberingSystem,t.outputCalendar||this.outputCalendar,t.defaultToEN||!1)}redefaultToEN(t={}){return this.clone(me(I({},t),{defaultToEN:!0}))}redefaultToSystem(t={}){return this.clone(me(I({},t),{defaultToEN:!1}))}months(t,i=!1,r=!0){return YO(this,t,r,Ihe,()=>{const s=i?{month:t,day:"numeric"}:{month:t},n=i?"format":"standalone";return this.monthsCache[n][t]||(this.monthsCache[n][t]=cDe(o=>this.extract(o,s,"month"))),this.monthsCache[n][t]})}weekdays(t,i=!1,r=!0){return YO(this,t,r,Lhe,()=>{const s=i?{weekday:t,year:"numeric",month:"long",day:"numeric"}:{weekday:t},n=i?"format":"standalone";return this.weekdaysCache[n][t]||(this.weekdaysCache[n][t]=uDe(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][t]})}meridiems(t=!0){return YO(this,void 0,t,()=>Nhe,()=>{if(!this.meridiemCache){const i={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[zt.utc(2016,11,13,9),zt.utc(2016,11,13,19)].map(r=>this.extract(r,i,"dayperiod"))}return this.meridiemCache})}eras(t,i=!0){return YO(this,t,i,Fhe,()=>{const r={era:t};return this.eraCache[t]||(this.eraCache[t]=[zt.utc(-40,1,1),zt.utc(2017,1,1)].map(s=>this.extract(s,r,"era"))),this.eraCache[t]})}extract(t,i,r){const s=this.dtFormatter(t,i),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===r);return o?o.value:null}numberFormatter(t={}){return new dDe(this.intl,t.forceSimple||this.fastNumbers,t)}dtFormatter(t,i={}){return new pDe(t,this.intl,i)}relFormatter(t={}){return new fDe(this.intl,this.isEnglish(),t)}listFormatter(t={}){return rDe(this.intl,t)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(t){return this.locale===t.locale&&this.numberingSystem===t.numberingSystem&&this.outputCalendar===t.outputCalendar}}function fS(...e){const t=e.reduce((i,r)=>i+r.source,"");return RegExp(`^${t}$`)}function eb(...e){return t=>e.reduce(([i,r,s],n)=>{const[o,a,l]=n(t,s);return[I(I({},i),o),r||a,l]},[{},null,1]).slice(0,2)}function mS(e,...t){if(e==null)return[null,null];for(const[i,r]of t){const s=i.exec(e);if(s)return r(s)}return[null,null]}function Uhe(...e){return(t,i)=>{const r={};let s;for(s=0;s<e.length;s++)r[e[s]]=sy(t[i+s]);return[r,null,i+s]}}const khe=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,Z7=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,zhe=RegExp(`${Z7.source}${khe.source}?`),Q7=RegExp(`(?:T${zhe.source})?`),mDe=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,gDe=/(\d{4})-?W(\d\d)(?:-?(\d))?/,yDe=/(\d{4})-?(\d{3})/,vDe=Uhe("weekYear","weekNumber","weekDay"),_De=Uhe("year","ordinal"),bDe=/(\d{4})-(\d\d)-(\d\d)/,Bhe=RegExp(`${Z7.source} ?(?:${khe.source}|(${k$e.source}))?`),wDe=RegExp(`(?: ${Bhe.source})?`);function Ox(e,t,i){const r=e[t];return Ei(r)?i:sy(r)}function Vhe(e,t){return[{year:Ox(e,t),month:Ox(e,t+1,1),day:Ox(e,t+2,1)},null,t+3]}function tb(e,t){return[{hours:Ox(e,t,0),minutes:Ox(e,t+1,0),seconds:Ox(e,t+2,0),milliseconds:q7(e[t+3])},null,t+4]}function gS(e,t){const i=!e[t]&&!e[t+1],r=EN(e[t+1],e[t+2]),s=i?null:ga.instance(r);return[{},s,t+3]}function Ghe(e,t){const i=e[t]?ym.create(e[t]):null;return[{},i,t+1]}const xDe=RegExp(`^T?${Z7.source}$`),TDe=/^-?P(?:(?:(-?\d{1,9}(?:\.\d{1,9})?)Y)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,9}(?:\.\d{1,9})?)W)?(?:(-?\d{1,9}(?:\.\d{1,9})?)D)?(?:T(?:(-?\d{1,9}(?:\.\d{1,9})?)H)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,9}))?S)?)?)$/;function SDe(e){const[t,i,r,s,n,o,a,l,c]=e,h=t[0]==="-",p=l&&l[0]==="-",f=(g,y=!1)=>g!==void 0&&(y||g&&h)?-g:g;return[{years:f(I0(i)),months:f(I0(r)),weeks:f(I0(s)),days:f(I0(n)),hours:f(I0(o)),minutes:f(I0(a)),seconds:f(I0(l),l==="-0"),milliseconds:f(q7(c),p)}]}const EDe={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function J7(e,t,i,r,s,n,o){const a={year:t.length===2?HB(sy(t)):sy(t),month:Phe.indexOf(i)+1,day:sy(r),hour:sy(s),minute:sy(n)};return o&&(a.second=sy(o)),e&&(a.weekday=e.length>3?$he.indexOf(e)+1:Dhe.indexOf(e)+1),a}const ADe=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function CDe(e){const[,t,i,r,s,n,o,a,l,c,h,p]=e,f=J7(t,s,r,i,n,o,a);let g;return l?g=EDe[l]:c?g=0:g=EN(h,p),[f,new ga(g)]}function RDe(e){return e.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const ODe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,MDe=/^(Monday|Tuesday|Wedsday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,PDe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function pZ(e){const[,t,i,r,s,n,o,a]=e;return[J7(t,s,r,i,n,o,a),ga.utcInstance]}function IDe(e){const[,t,i,r,s,n,o,a]=e;return[J7(t,a,i,r,s,n,o),ga.utcInstance]}const $De=fS(mDe,Q7),DDe=fS(gDe,Q7),LDe=fS(yDe,Q7),NDe=fS(zhe),FDe=eb(Vhe,tb,gS),UDe=eb(vDe,tb,gS),kDe=eb(_De,tb,gS),zDe=eb(tb,gS);function BDe(e){return mS(e,[$De,FDe],[DDe,UDe],[LDe,kDe],[NDe,zDe])}function VDe(e){return mS(RDe(e),[ADe,CDe])}function GDe(e){return mS(e,[ODe,pZ],[MDe,pZ],[PDe,IDe])}function jDe(e){return mS(e,[TDe,SDe])}const HDe=eb(tb);function qDe(e){return mS(e,[xDe,HDe])}const WDe=fS(bDe,wDe),XDe=fS(Bhe),YDe=eb(Vhe,tb,gS,Ghe),ZDe=eb(tb,gS,Ghe);function QDe(e){return mS(e,[WDe,YDe],[XDe,ZDe])}const JDe="Invalid Duration",jhe={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},KDe=I({years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3}},jhe),Ac=146097/400,hb=146097/4800,eLe=I({years:{quarters:4,months:12,weeks:Ac/7,days:Ac,hours:Ac*24,minutes:Ac*24*60,seconds:Ac*24*60*60,milliseconds:Ac*24*60*60*1e3},quarters:{months:3,weeks:Ac/28,days:Ac/4,hours:Ac*24/4,minutes:Ac*24*60/4,seconds:Ac*24*60*60/4,milliseconds:Ac*24*60*60*1e3/4},months:{weeks:hb/7,days:hb,hours:hb*24,minutes:hb*24*60,seconds:hb*24*60*60,milliseconds:hb*24*60*60*1e3}},jhe),Mv=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],tLe=Mv.slice(0).reverse();function $0(e,t,i=!1){const r={values:i?t.values:I(I({},e.values),t.values||{}),loc:e.loc.clone(t.loc),conversionAccuracy:t.conversionAccuracy||e.conversionAccuracy};return new Ii(r)}function iLe(e){return e<0?Math.floor(e):Math.ceil(e)}function Hhe(e,t,i,r,s){const n=e[s][i],o=t[i]/n,a=Math.sign(o)===Math.sign(r[s]),l=!a&&r[s]!==0&&Math.abs(o)<=1?iLe(o):Math.trunc(o);r[s]+=l,t[i]-=l*n}function rLe(e,t){tLe.reduce((i,r)=>Ei(t[r])?i:(i&&Hhe(e,t,i,t,r),r),null)}class Ii{constructor(t){const i=t.conversionAccuracy==="longterm"||!1;this.values=t.values,this.loc=t.loc||es.create(),this.conversionAccuracy=i?"longterm":"casual",this.invalid=t.invalid||null,this.matrix=i?eLe:KDe,this.isLuxonDuration=!0}static fromMillis(t,i){return Ii.fromObject({milliseconds:t},i)}static fromObject(t,i={}){if(t==null||typeof t!="object")throw new au(`Duration.fromObject: argument expected to be an object, got ${t===null?"null":typeof t}`);return new Ii({values:cD(t,Ii.normalizeUnit),loc:es.fromObject(i),conversionAccuracy:i.conversionAccuracy})}static fromDurationLike(t){if(Y_(t))return Ii.fromMillis(t);if(Ii.isDuration(t))return t;if(typeof t=="object")return Ii.fromObject(t);throw new au(`Unknown duration argument ${t} of type ${typeof t}`)}static fromISO(t,i){const[r]=jDe(t);return r?Ii.fromObject(r,i):Ii.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static fromISOTime(t,i){const[r]=qDe(t);return r?Ii.fromObject(r,i):Ii.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static invalid(t,i=null){if(!t)throw new au("need to specify a reason the Duration is invalid");const r=t instanceof Oh?t:new Oh(t,i);if(an.throwOnInvalid)throw new P$e(r);return new Ii({invalid:r})}static normalizeUnit(t){const i={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[t&&t.toLowerCase()];if(!i)throw new lhe(t);return i}static isDuration(t){return t&&t.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(t,i={}){const r=me(I({},i),{floor:i.round!==!1&&i.floor!==!1});return this.isValid?ol.create(this.loc,r).formatDurationFromString(this,t):JDe}toHuman(t={}){const i=Mv.map(r=>{const s=this.values[r];return Ei(s)?null:this.loc.numberFormatter(me(I({style:"unit",unitDisplay:"long"},t),{unit:r.slice(0,-1)})).format(s)}).filter(r=>r);return this.loc.listFormatter(I({type:"conjunction",style:t.listStyle||"narrow"},t)).format(i)}toObject(){return this.isValid?I({},this.values):{}}toISO(){if(!this.isValid)return null;let t="P";return this.years!==0&&(t+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(t+=this.months+this.quarters*3+"M"),this.weeks!==0&&(t+=this.weeks+"W"),this.days!==0&&(t+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(t+="T"),this.hours!==0&&(t+=this.hours+"H"),this.minutes!==0&&(t+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(t+=W7(this.seconds+this.milliseconds/1e3,3)+"S"),t==="P"&&(t+="T0S"),t}toISOTime(t={}){if(!this.isValid)return null;const i=this.toMillis();if(i<0||i>=864e5)return null;t=I({suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended"},t);const r=this.shiftTo("hours","minutes","seconds","milliseconds");let s=t.format==="basic"?"hhmm":"hh:mm";(!t.suppressSeconds||r.seconds!==0||r.milliseconds!==0)&&(s+=t.format==="basic"?"ss":":ss",(!t.suppressMilliseconds||r.milliseconds!==0)&&(s+=".SSS"));let n=r.toFormat(s);return t.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(t){if(!this.isValid)return this;const i=Ii.fromDurationLike(t),r={};for(const s of Mv)(_T(i.values,s)||_T(this.values,s))&&(r[s]=i.get(s)+this.get(s));return $0(this,{values:r},!0)}minus(t){if(!this.isValid)return this;const i=Ii.fromDurationLike(t);return this.plus(i.negate())}mapUnits(t){if(!this.isValid)return this;const i={};for(const r of Object.keys(this.values))i[r]=Mhe(t(this.values[r],r));return $0(this,{values:i},!0)}get(t){return this[Ii.normalizeUnit(t)]}set(t){if(!this.isValid)return this;const i=I(I({},this.values),cD(t,Ii.normalizeUnit));return $0(this,{values:i})}reconfigure({locale:t,numberingSystem:i,conversionAccuracy:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i}),n={loc:s};return r&&(n.conversionAccuracy=r),$0(this,n)}as(t){return this.isValid?this.shiftTo(t).get(t):NaN}normalize(){if(!this.isValid)return this;const t=this.toObject();return rLe(this.matrix,t),$0(this,{values:t},!0)}shiftTo(...t){if(!this.isValid)return this;if(t.length===0)return this;t=t.map(o=>Ii.normalizeUnit(o));const i={},r={},s=this.toObject();let n;for(const o of Mv)if(t.indexOf(o)>=0){n=o;let a=0;for(const c in r)a+=this.matrix[c][o]*r[c],r[c]=0;Y_(s[o])&&(a+=s[o]);const l=Math.trunc(a);i[o]=l,r[o]=(a*1e3-l*1e3)/1e3;for(const c in s)Mv.indexOf(c)>Mv.indexOf(o)&&Hhe(this.matrix,s,c,i,o)}else Y_(s[o])&&(r[o]=s[o]);for(const o in r)r[o]!==0&&(i[n]+=o===n?r[o]:r[o]/this.matrix[n][o]);return $0(this,{values:i},!0).normalize()}negate(){if(!this.isValid)return this;const t={};for(const i of Object.keys(this.values))t[i]=this.values[i]===0?0:-this.values[i];return $0(this,{values:t},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(t){if(!this.isValid||!t.isValid||!this.loc.equals(t.loc))return!1;function i(r,s){return r===void 0||r===0?s===void 0||s===0:r===s}for(const r of Mv)if(!i(this.values[r],t.values[r]))return!1;return!0}}const jS="Invalid Interval";function sLe(e,t){return!e||!e.isValid?ds.invalid("missing or invalid start"):!t||!t.isValid?ds.invalid("missing or invalid end"):t<e?ds.invalid("end before start",`The end of an interval must be after its start, but you had start=${e.toISO()} and end=${t.toISO()}`):null}class ds{constructor(t){this.s=t.start,this.e=t.end,this.invalid=t.invalid||null,this.isLuxonInterval=!0}static invalid(t,i=null){if(!t)throw new au("need to specify a reason the Interval is invalid");const r=t instanceof Oh?t:new Oh(t,i);if(an.throwOnInvalid)throw new M$e(r);return new ds({invalid:r})}static fromDateTimes(t,i){const r=WS(t),s=WS(i),n=sLe(r,s);return n==null?new ds({start:r,end:s}):n}static after(t,i){const r=Ii.fromDurationLike(i),s=WS(t);return ds.fromDateTimes(s,s.plus(r))}static before(t,i){const r=Ii.fromDurationLike(i),s=WS(t);return ds.fromDateTimes(s.minus(r),s)}static fromISO(t,i){const[r,s]=(t||"").split("/",2);if(r&&s){let n,o;try{n=zt.fromISO(r,i),o=n.isValid}catch{o=!1}let a,l;try{a=zt.fromISO(s,i),l=a.isValid}catch{l=!1}if(o&&l)return ds.fromDateTimes(n,a);if(o){const c=Ii.fromISO(s,i);if(c.isValid)return ds.after(n,c)}else if(l){const c=Ii.fromISO(r,i);if(c.isValid)return ds.before(a,c)}}return ds.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static isInterval(t){return t&&t.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(t="milliseconds"){return this.isValid?this.toDuration(t).get(t):NaN}count(t="milliseconds"){if(!this.isValid)return NaN;const i=this.start.startOf(t),r=this.end.startOf(t);return Math.floor(r.diff(i,t).get(t))+1}hasSame(t){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,t):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(t){return this.isValid?this.s>t:!1}isBefore(t){return this.isValid?this.e<=t:!1}contains(t){return this.isValid?this.s<=t&&this.e>t:!1}set({start:t,end:i}={}){return this.isValid?ds.fromDateTimes(t||this.s,i||this.e):this}splitAt(...t){if(!this.isValid)return[];const i=t.map(WS).filter(o=>this.contains(o)).sort(),r=[];let{s}=this,n=0;for(;s<this.e;){const o=i[n]||this.e,a=+o>+this.e?this.e:o;r.push(ds.fromDateTimes(s,a)),s=a,n+=1}return r}splitBy(t){const i=Ii.fromDurationLike(t);if(!this.isValid||!i.isValid||i.as("milliseconds")===0)return[];let{s:r}=this,s=1,n;const o=[];for(;r<this.e;){const a=this.start.plus(i.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(ds.fromDateTimes(r,n)),r=n,s+=1}return o}divideEqually(t){return this.isValid?this.splitBy(this.length()/t).slice(0,t):[]}overlaps(t){return this.e>t.s&&this.s<t.e}abutsStart(t){return this.isValid?+this.e==+t.s:!1}abutsEnd(t){return this.isValid?+t.e==+this.s:!1}engulfs(t){return this.isValid?this.s<=t.s&&this.e>=t.e:!1}equals(t){return!this.isValid||!t.isValid?!1:this.s.equals(t.s)&&this.e.equals(t.e)}intersection(t){if(!this.isValid)return this;const i=this.s>t.s?this.s:t.s,r=this.e<t.e?this.e:t.e;return i>=r?null:ds.fromDateTimes(i,r)}union(t){if(!this.isValid)return this;const i=this.s<t.s?this.s:t.s,r=this.e>t.e?this.e:t.e;return ds.fromDateTimes(i,r)}static merge(t){const[i,r]=t.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return r&&i.push(r),i}static xor(t){let i=null,r=0;const s=[],n=t.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)r+=l.type==="s"?1:-1,r===1?i=l.time:(i&&+i!=+l.time&&s.push(ds.fromDateTimes(i,l.time)),i=null);return ds.merge(s)}difference(...t){return ds.xor([this].concat(t)).map(i=>this.intersection(i)).filter(i=>i&&!i.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} \u2013 ${this.e.toISO()})`:jS}toISO(t){return this.isValid?`${this.s.toISO(t)}/${this.e.toISO(t)}`:jS}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:jS}toISOTime(t){return this.isValid?`${this.s.toISOTime(t)}/${this.e.toISOTime(t)}`:jS}toFormat(t,{separator:i=" \u2013 "}={}){return this.isValid?`${this.s.toFormat(t)}${i}${this.e.toFormat(t)}`:jS}toDuration(t,i){return this.isValid?this.e.diff(this.s,t,i):Ii.invalid(this.invalidReason)}mapEndpoints(t){return ds.fromDateTimes(t(this.s),t(this.e))}}class ZO{static hasDST(t=an.defaultZone){const i=zt.now().setZone(t).set({month:12});return!t.isUniversal&&i.offset!==i.set({month:6}).offset}static isValidIANAZone(t){return ym.isValidZone(t)}static normalizeZone(t){return my(t,an.defaultZone)}static months(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||es.create(i,r,n)).months(t)}static monthsFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||es.create(i,r,n)).months(t,!0)}static weekdays(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||es.create(i,r,null)).weekdays(t)}static weekdaysFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||es.create(i,r,null)).weekdays(t,!0)}static meridiems({locale:t=null}={}){return es.create(t).meridiems()}static eras(t="short",{locale:i=null}={}){return es.create(i,null,"gregory").eras(t)}static features(){return{relative:Rhe()}}}function fZ(e,t){const i=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),r=i(t)-i(e);return Math.floor(Ii.fromMillis(r).as("days"))}function nLe(e,t,i){const r=[["years",(a,l)=>l.year-a.year],["quarters",(a,l)=>l.quarter-a.quarter],["months",(a,l)=>l.month-a.month+(l.year-a.year)*12],["weeks",(a,l)=>{const c=fZ(a,l);return(c-c%7)/7}],["days",fZ]],s={};let n,o;for(const[a,l]of r)if(i.indexOf(a)>=0){n=a;let c=l(e,t);o=e.plus({[a]:c}),o>t?(e=e.plus({[a]:c-1}),c-=1):e=o,s[a]=c}return[e,s,o,n]}function oLe(e,t,i,r){let[s,n,o,a]=nLe(e,t,i);const l=t-s,c=i.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<t&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=Ii.fromObject(n,r);return c.length>0?Ii.fromMillis(l,r).shiftTo(...c).plus(h):h}const K7={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[\u3007|\u4E00|\u4E8C|\u4E09|\u56DB|\u4E94|\u516D|\u4E03|\u516B|\u4E5D]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d"},mZ={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},aLe=K7.hanidec.replace(/[\[|\]]/g,"").split("");function lLe(e){let t=parseInt(e,10);if(isNaN(t)){t="";for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);if(e[i].search(K7.hanidec)!==-1)t+=aLe.indexOf(e[i]);else for(const s in mZ){const[n,o]=mZ[s];r>=n&&r<=o&&(t+=r-n)}}return parseInt(t,10)}else return t}function Uu({numberingSystem:e},t=""){return new RegExp(`${K7[e||"latn"]}${t}`)}const cLe="missing Intl.DateTimeFormat.formatToParts support";function ji(e,t=i=>i){return{regex:e,deser:([i])=>t(lLe(i))}}const uLe=String.fromCharCode(160),qhe=`( |${uLe})`,Whe=new RegExp(qhe,"g");function hLe(e){return e.replace(/\./g,"\\.?").replace(Whe,qhe)}function gZ(e){return e.replace(/\./g,"").replace(Whe," ").toLowerCase()}function ku(e,t){return e===null?null:{regex:RegExp(e.map(hLe).join("|")),deser:([i])=>e.findIndex(r=>gZ(i)===gZ(r))+t}}function yZ(e,t){return{regex:e,deser:([,i,r])=>EN(i,r),groups:t}}function i5(e){return{regex:e,deser:([t])=>t}}function dLe(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function pLe(e,t){const i=Uu(t),r=Uu(t,"{2}"),s=Uu(t,"{3}"),n=Uu(t,"{4}"),o=Uu(t,"{6}"),a=Uu(t,"{1,2}"),l=Uu(t,"{1,3}"),c=Uu(t,"{1,6}"),h=Uu(t,"{1,9}"),p=Uu(t,"{2,4}"),f=Uu(t,"{4,6}"),g=b=>({regex:RegExp(dLe(b.val)),deser:([w])=>w,literal:!0}),v=(b=>{if(e.literal)return g(b);switch(b.val){case"G":return ku(t.eras("short",!1),0);case"GG":return ku(t.eras("long",!1),0);case"y":return ji(c);case"yy":return ji(p,HB);case"yyyy":return ji(n);case"yyyyy":return ji(f);case"yyyyyy":return ji(o);case"M":return ji(a);case"MM":return ji(r);case"MMM":return ku(t.months("short",!0,!1),1);case"MMMM":return ku(t.months("long",!0,!1),1);case"L":return ji(a);case"LL":return ji(r);case"LLL":return ku(t.months("short",!1,!1),1);case"LLLL":return ku(t.months("long",!1,!1),1);case"d":return ji(a);case"dd":return ji(r);case"o":return ji(l);case"ooo":return ji(s);case"HH":return ji(r);case"H":return ji(a);case"hh":return ji(r);case"h":return ji(a);case"mm":return ji(r);case"m":return ji(a);case"q":return ji(a);case"qq":return ji(r);case"s":return ji(a);case"ss":return ji(r);case"S":return ji(l);case"SSS":return ji(s);case"u":return i5(h);case"uu":return i5(a);case"uuu":return ji(i);case"a":return ku(t.meridiems(),0);case"kkkk":return ji(n);case"kk":return ji(p,HB);case"W":return ji(a);case"WW":return ji(r);case"E":case"c":return ji(i);case"EEE":return ku(t.weekdays("short",!1,!1),1);case"EEEE":return ku(t.weekdays("long",!1,!1),1);case"ccc":return ku(t.weekdays("short",!0,!1),1);case"cccc":return ku(t.weekdays("long",!0,!1),1);case"Z":case"ZZ":return yZ(new RegExp(`([+-]${a.source})(?::(${r.source}))?`),2);case"ZZZ":return yZ(new RegExp(`([+-]${a.source})(${r.source})?`),2);case"z":return i5(/[a-z_+-/]{1,256}?/i);default:return g(b)}})(e)||{invalidReason:cLe};return v.token=e,v}const fLe={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"}};function mLe(e,t,i){const{type:r,value:s}=e;if(r==="literal")return{literal:!0,val:s};const n=i[r];let o=fLe[r];if(typeof o=="object"&&(o=o[n]),o)return{literal:!1,val:o}}function gLe(e){return[`^${e.map(i=>i.regex).reduce((i,r)=>`${i}(${r.source})`,"")}$`,e]}function yLe(e,t,i){const r=e.match(t);if(r){const s={};let n=1;for(const o in i)if(_T(i,o)){const a=i[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(r.slice(n,n+l))),n+=l}return[r,s]}else return[r,{}]}function vLe(e){const t=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let i=null,r;return Ei(e.z)||(i=ym.create(e.z)),Ei(e.Z)||(i||(i=new ga(e.Z)),r=e.Z),Ei(e.q)||(e.M=(e.q-1)*3+1),Ei(e.h)||(e.h<12&&e.a===1?e.h+=12:e.h===12&&e.a===0&&(e.h=0)),e.G===0&&e.y&&(e.y=-e.y),Ei(e.u)||(e.S=q7(e.u)),[Object.keys(e).reduce((n,o)=>{const a=t(o);return a&&(n[a]=e[o]),n},{}),i,r]}let r5=null;function _Le(){return r5||(r5=zt.fromMillis(1555555555555)),r5}function bLe(e,t){if(e.literal)return e;const i=ol.macroTokenToFormatOpts(e.val);if(!i)return e;const n=ol.create(t,i).formatDateTimeParts(_Le()).map(o=>mLe(o,t,i));return n.includes(void 0)?e:n}function wLe(e,t){return Array.prototype.concat(...e.map(i=>bLe(i,t)))}function Xhe(e,t,i){const r=wLe(ol.parseFormat(i),e),s=r.map(o=>pLe(o,e)),n=s.find(o=>o.invalidReason);if(n)return{input:t,tokens:r,invalidReason:n.invalidReason};{const[o,a]=gLe(s),l=RegExp(o,"i"),[c,h]=yLe(t,l,a),[p,f,g]=h?vLe(h):[null,null,void 0];if(_T(h,"a")&&_T(h,"H"))throw new vE("Can't include meridiem when specifying 24-hour format");return{input:t,tokens:r,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:g}}}function xLe(e,t,i){const{result:r,zone:s,specificOffset:n,invalidReason:o}=Xhe(e,t,i);return[r,s,n,o]}const Yhe=[0,31,59,90,120,151,181,212,243,273,304,334],Zhe=[0,31,60,91,121,152,182,213,244,274,305,335];function vu(e,t){return new Oh("unit out of range",`you specified ${t} (of type ${typeof t}) as a ${e}, which is invalid`)}function Qhe(e,t,i){const r=new Date(Date.UTC(e,t-1,i)).getUTCDay();return r===0?7:r}function Jhe(e,t,i){return i+(LR(e)?Zhe:Yhe)[t-1]}function Khe(e,t){const i=LR(e)?Zhe:Yhe,r=i.findIndex(n=>n<t),s=t-i[r];return{month:r+1,day:s}}function ZB(e){const{year:t,month:i,day:r}=e,s=Jhe(t,i,r),n=Qhe(t,i,r);let o=Math.floor((s-n+10)/7),a;return o<1?(a=t-1,o=lD(a)):o>lD(t)?(a=t+1,o=1):a=t,I({weekYear:a,weekNumber:o,weekday:n},AN(e))}function vZ(e){const{weekYear:t,weekNumber:i,weekday:r}=e,s=Qhe(t,1,4),n=bA(t);let o=i*7+r-s-3,a;o<1?(a=t-1,o+=bA(a)):o>n?(a=t+1,o-=bA(t)):a=t;const{month:l,day:c}=Khe(a,o);return I({year:a,month:l,day:c},AN(e))}function s5(e){const{year:t,month:i,day:r}=e,s=Jhe(t,i,r);return I({year:t,ordinal:s},AN(e))}function _Z(e){const{year:t,ordinal:i}=e,{month:r,day:s}=Khe(t,i);return I({year:t,month:r,day:s},AN(e))}function TLe(e){const t=SN(e.weekYear),i=Xf(e.weekNumber,1,lD(e.weekYear)),r=Xf(e.weekday,1,7);return t?i?r?!1:vu("weekday",e.weekday):vu("week",e.week):vu("weekYear",e.weekYear)}function SLe(e){const t=SN(e.year),i=Xf(e.ordinal,1,bA(e.year));return t?i?!1:vu("ordinal",e.ordinal):vu("year",e.year)}function ede(e){const t=SN(e.year),i=Xf(e.month,1,12),r=Xf(e.day,1,aD(e.year,e.month));return t?i?r?!1:vu("day",e.day):vu("month",e.month):vu("year",e.year)}function tde(e){const{hour:t,minute:i,second:r,millisecond:s}=e,n=Xf(t,0,23)||t===24&&i===0&&r===0&&s===0,o=Xf(i,0,59),a=Xf(r,0,59),l=Xf(s,0,999);return n?o?a?l?!1:vu("millisecond",s):vu("second",r):vu("minute",i):vu("hour",t)}const n5="Invalid DateTime",bZ=864e13;function QO(e){return new Oh("unsupported zone",`the zone "${e.name}" is not supported`)}function o5(e){return e.weekData===null&&(e.weekData=ZB(e.c)),e.weekData}function HS(e,t){const i={ts:e.ts,zone:e.zone,c:e.c,o:e.o,loc:e.loc,invalid:e.invalid};return new zt(me(I(I({},i),t),{old:i}))}function ide(e,t,i){let r=e-t*60*1e3;const s=i.offset(r);if(t===s)return[r,t];r-=(s-t)*60*1e3;const n=i.offset(r);return s===n?[r,s]:[e-Math.min(s,n)*60*1e3,Math.max(s,n)]}function wZ(e,t){e+=t*60*1e3;const i=new Date(e);return{year:i.getUTCFullYear(),month:i.getUTCMonth()+1,day:i.getUTCDate(),hour:i.getUTCHours(),minute:i.getUTCMinutes(),second:i.getUTCSeconds(),millisecond:i.getUTCMilliseconds()}}function G3(e,t,i){return ide(X7(e),t,i)}function xZ(e,t){const i=e.o,r=e.c.year+Math.trunc(t.years),s=e.c.month+Math.trunc(t.months)+Math.trunc(t.quarters)*3,n=me(I({},e.c),{year:r,month:s,day:Math.min(e.c.day,aD(r,s))+Math.trunc(t.days)+Math.trunc(t.weeks)*7}),o=Ii.fromObject({years:t.years-Math.trunc(t.years),quarters:t.quarters-Math.trunc(t.quarters),months:t.months-Math.trunc(t.months),weeks:t.weeks-Math.trunc(t.weeks),days:t.days-Math.trunc(t.days),hours:t.hours,minutes:t.minutes,seconds:t.seconds,milliseconds:t.milliseconds}).as("milliseconds"),a=X7(n);let[l,c]=ide(a,i,e.zone);return o!==0&&(l+=o,c=e.zone.offset(l)),{ts:l,o:c}}function qS(e,t,i,r,s,n){const{setZone:o,zone:a}=i;if(e&&Object.keys(e).length!==0){const l=t||a,c=zt.fromObject(e,me(I({},i),{zone:l,specificOffset:n}));return o?c:c.setZone(a)}else return zt.invalid(new Oh("unparsable",`the input "${s}" can't be parsed as ${r}`))}function JO(e,t,i=!0){return e.isValid?ol.create(es.create("en-US"),{allowZ:i,forceSimple:!0}).formatDateTimeFromString(e,t):null}function a5(e,t){const i=e.c.year>9999||e.c.year<0;let r="";return i&&e.c.year>=0&&(r+="+"),r+=qs(e.c.year,i?6:4),t?(r+="-",r+=qs(e.c.month),r+="-",r+=qs(e.c.day)):(r+=qs(e.c.month),r+=qs(e.c.day)),r}function TZ(e,t,i,r,s){let n=qs(e.c.hour);return t?(n+=":",n+=qs(e.c.minute),(e.c.second!==0||!i)&&(n+=":")):n+=qs(e.c.minute),(e.c.second!==0||!i)&&(n+=qs(e.c.second),(e.c.millisecond!==0||!r)&&(n+=".",n+=qs(e.c.millisecond,3))),s&&(e.isOffsetFixed&&e.offset===0?n+="Z":e.o<0?(n+="-",n+=qs(Math.trunc(-e.o/60)),n+=":",n+=qs(Math.trunc(-e.o%60))):(n+="+",n+=qs(Math.trunc(e.o/60)),n+=":",n+=qs(Math.trunc(e.o%60)))),n}const rde={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},ELe={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},ALe={ordinal:1,hour:0,minute:0,second:0,millisecond:0},sde=["year","month","day","hour","minute","second","millisecond"],CLe=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],RLe=["year","ordinal","hour","minute","second","millisecond"];function SZ(e){const t={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[e.toLowerCase()];if(!t)throw new lhe(e);return t}function EZ(e,t){const i=my(t.zone,an.defaultZone),r=es.fromObject(t),s=an.now();let n,o;if(Ei(e.year))n=s;else{for(const c of sde)Ei(e[c])&&(e[c]=rde[c]);const a=ede(e)||tde(e);if(a)return zt.invalid(a);const l=i.offset(s);[n,o]=G3(e,l,i)}return new zt({ts:n,zone:i,loc:r,o})}function AZ(e,t,i){const r=Ei(i.round)?!0:i.round,s=(o,a)=>(o=W7(o,r||i.calendary?0:2,!0),t.loc.clone(i).relFormatter(i).format(o,a)),n=o=>i.calendary?t.hasSame(e,o)?0:t.startOf(o).diff(e.startOf(o),o).get(o):t.diff(e,o).get(o);if(i.unit)return s(n(i.unit),i.unit);for(const o of i.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(e>t?-0:0,i.units[i.units.length-1])}function CZ(e){let t={},i;return e.length>0&&typeof e[e.length-1]=="object"?(t=e[e.length-1],i=Array.from(e).slice(0,e.length-1)):i=Array.from(e),[t,i]}class zt{constructor(t){const i=t.zone||an.defaultZone;let r=t.invalid||(Number.isNaN(t.ts)?new Oh("invalid input"):null)||(i.isValid?null:QO(i));this.ts=Ei(t.ts)?an.now():t.ts;let s=null,n=null;if(!r)if(t.old&&t.old.ts===this.ts&&t.old.zone.equals(i))[s,n]=[t.old.c,t.old.o];else{const a=i.offset(this.ts);s=wZ(this.ts,a),r=Number.isNaN(s.year)?new Oh("invalid input"):null,s=r?null:s,n=r?null:a}this._zone=i,this.loc=t.loc||es.create(),this.invalid=r,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new zt({})}static local(){const[t,i]=CZ(arguments),[r,s,n,o,a,l,c]=i;return EZ({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static utc(){const[t,i]=CZ(arguments),[r,s,n,o,a,l,c]=i;return t.zone=ga.utcInstance,EZ({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static fromJSDate(t,i={}){const r=L$e(t)?t.valueOf():NaN;if(Number.isNaN(r))return zt.invalid("invalid input");const s=my(i.zone,an.defaultZone);return s.isValid?new zt({ts:r,zone:s,loc:es.fromObject(i)}):zt.invalid(QO(s))}static fromMillis(t,i={}){if(Y_(t))return t<-bZ||t>bZ?zt.invalid("Timestamp out of range"):new zt({ts:t,zone:my(i.zone,an.defaultZone),loc:es.fromObject(i)});throw new au(`fromMillis requires a numerical input, but received a ${typeof t} with value ${t}`)}static fromSeconds(t,i={}){if(Y_(t))return new zt({ts:t*1e3,zone:my(i.zone,an.defaultZone),loc:es.fromObject(i)});throw new au("fromSeconds requires a numerical input")}static fromObject(t,i={}){t=t||{};const r=my(i.zone,an.defaultZone);if(!r.isValid)return zt.invalid(QO(r));const s=an.now(),n=Ei(i.specificOffset)?r.offset(s):i.specificOffset,o=cD(t,SZ),a=!Ei(o.ordinal),l=!Ei(o.year),c=!Ei(o.month)||!Ei(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=es.fromObject(i);if((h||a)&&p)throw new vE("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new vE("Can't mix ordinal dates with month/day");const g=p||o.weekday&&!h;let y,v,b=wZ(s,n);g?(y=CLe,v=ELe,b=ZB(b)):a?(y=RLe,v=ALe,b=s5(b)):(y=sde,v=rde);let w=!1;for(const U of y){const N=o[U];Ei(N)?w?o[U]=v[U]:o[U]=b[U]:w=!0}const S=g?TLe(o):a?SLe(o):ede(o),T=S||tde(o);if(T)return zt.invalid(T);const A=g?vZ(o):a?_Z(o):o,[C,R]=G3(A,n,r),L=new zt({ts:C,zone:r,o:R,loc:f});return o.weekday&&h&&t.weekday!==L.weekday?zt.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${L.toISO()}`):L}static fromISO(t,i={}){const[r,s]=BDe(t);return qS(r,s,i,"ISO 8601",t)}static fromRFC2822(t,i={}){const[r,s]=VDe(t);return qS(r,s,i,"RFC 2822",t)}static fromHTTP(t,i={}){const[r,s]=GDe(t);return qS(r,s,i,"HTTP",i)}static fromFormat(t,i,r={}){if(Ei(t)||Ei(i))throw new au("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=r,o=es.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=xLe(o,t,i);return h?zt.invalid(h):qS(a,l,r,`format ${i}`,t,c)}static fromString(t,i,r={}){return zt.fromFormat(t,i,r)}static fromSQL(t,i={}){const[r,s]=QDe(t);return qS(r,s,i,"SQL",t)}static invalid(t,i=null){if(!t)throw new au("need to specify a reason the DateTime is invalid");const r=t instanceof Oh?t:new Oh(t,i);if(an.throwOnInvalid)throw new O$e(r);return new zt({invalid:r})}static isDateTime(t){return t&&t.isLuxonDateTime||!1}get(t){return this[t]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?o5(this).weekYear:NaN}get weekNumber(){return this.isValid?o5(this).weekNumber:NaN}get weekday(){return this.isValid?o5(this).weekday:NaN}get ordinal(){return this.isValid?s5(this.c).ordinal:NaN}get monthShort(){return this.isValid?ZO.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?ZO.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?ZO.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?ZO.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return LR(this.year)}get daysInMonth(){return aD(this.year,this.month)}get daysInYear(){return this.isValid?bA(this.year):NaN}get weeksInWeekYear(){return this.isValid?lD(this.weekYear):NaN}resolvedLocaleOptions(t={}){const{locale:i,numberingSystem:r,calendar:s}=ol.create(this.loc.clone(t),t).resolvedOptions(this);return{locale:i,numberingSystem:r,outputCalendar:s}}toUTC(t=0,i={}){return this.setZone(ga.instance(t),i)}toLocal(){return this.setZone(an.defaultZone)}setZone(t,{keepLocalTime:i=!1,keepCalendarTime:r=!1}={}){if(t=my(t,an.defaultZone),t.equals(this.zone))return this;if(t.isValid){let s=this.ts;if(i||r){const n=t.offset(this.ts),o=this.toObject();[s]=G3(o,n,t)}return HS(this,{ts:s,zone:t})}else return zt.invalid(QO(t))}reconfigure({locale:t,numberingSystem:i,outputCalendar:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i,outputCalendar:r});return HS(this,{loc:s})}setLocale(t){return this.reconfigure({locale:t})}set(t){if(!this.isValid)return this;const i=cD(t,SZ),r=!Ei(i.weekYear)||!Ei(i.weekNumber)||!Ei(i.weekday),s=!Ei(i.ordinal),n=!Ei(i.year),o=!Ei(i.month)||!Ei(i.day),a=n||o,l=i.weekYear||i.weekNumber;if((a||s)&&l)throw new vE("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new vE("Can't mix ordinal dates with month/day");let c;r?c=vZ(I(I({},ZB(this.c)),i)):Ei(i.ordinal)?(c=I(I({},this.toObject()),i),Ei(i.day)&&(c.day=Math.min(aD(c.year,c.month),c.day))):c=_Z(I(I({},s5(this.c)),i));const[h,p]=G3(c,this.o,this.zone);return HS(this,{ts:h,o:p})}plus(t){if(!this.isValid)return this;const i=Ii.fromDurationLike(t);return HS(this,xZ(this,i))}minus(t){if(!this.isValid)return this;const i=Ii.fromDurationLike(t).negate();return HS(this,xZ(this,i))}startOf(t){if(!this.isValid)return this;const i={},r=Ii.normalizeUnit(t);switch(r){case"years":i.month=1;case"quarters":case"months":i.day=1;case"weeks":case"days":i.hour=0;case"hours":i.minute=0;case"minutes":i.second=0;case"seconds":i.millisecond=0;break}if(r==="weeks"&&(i.weekday=1),r==="quarters"){const s=Math.ceil(this.month/3);i.month=(s-1)*3+1}return this.set(i)}endOf(t){return this.isValid?this.plus({[t]:1}).startOf(t).minus(1):this}toFormat(t,i={}){return this.isValid?ol.create(this.loc.redefaultToEN(i)).formatDateTimeFromString(this,t):n5}toLocaleString(t=jB,i={}){return this.isValid?ol.create(this.loc.clone(i),t).formatDateTime(this):n5}toLocaleParts(t={}){return this.isValid?ol.create(this.loc.clone(t),t).formatDateTimeParts(this):[]}toISO({format:t="extended",suppressSeconds:i=!1,suppressMilliseconds:r=!1,includeOffset:s=!0}={}){if(!this.isValid)return null;const n=t==="extended";let o=a5(this,n);return o+="T",o+=TZ(this,n,i,r,s),o}toISODate({format:t="extended"}={}){return this.isValid?a5(this,t==="extended"):null}toISOWeekDate(){return JO(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:t=!1,suppressSeconds:i=!1,includeOffset:r=!0,includePrefix:s=!1,format:n="extended"}={}){return this.isValid?(s?"T":"")+TZ(this,n==="extended",i,t,r):null}toRFC2822(){return JO(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return JO(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?a5(this,!0):null}toSQLTime({includeOffset:t=!0,includeZone:i=!1,includeOffsetSpace:r=!0}={}){let s="HH:mm:ss.SSS";return(i||t)&&(r&&(s+=" "),i?s+="z":t&&(s+="ZZ")),JO(this,s,!0)}toSQL(t={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(t)}`:null}toString(){return this.isValid?this.toISO():n5}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(t={}){if(!this.isValid)return{};const i=I({},this.c);return t.includeConfig&&(i.outputCalendar=this.outputCalendar,i.numberingSystem=this.loc.numberingSystem,i.locale=this.loc.locale),i}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(t,i="milliseconds",r={}){if(!this.isValid||!t.isValid)return Ii.invalid("created by diffing an invalid DateTime");const s=I({locale:this.locale,numberingSystem:this.numberingSystem},r),n=N$e(i).map(Ii.normalizeUnit),o=t.valueOf()>this.valueOf(),a=o?this:t,l=o?t:this,c=oLe(a,l,n,s);return o?c.negate():c}diffNow(t="milliseconds",i={}){return this.diff(zt.now(),t,i)}until(t){return this.isValid?ds.fromDateTimes(this,t):this}hasSame(t,i){if(!this.isValid)return!1;const r=t.valueOf(),s=this.setZone(t.zone,{keepLocalTime:!0});return s.startOf(i)<=r&&r<=s.endOf(i)}equals(t){return this.isValid&&t.isValid&&this.valueOf()===t.valueOf()&&this.zone.equals(t.zone)&&this.loc.equals(t.loc)}toRelative(t={}){if(!this.isValid)return null;const i=t.base||zt.fromObject({},{zone:this.zone}),r=t.padding?this<i?-t.padding:t.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=t.unit;return Array.isArray(t.unit)&&(s=t.unit,n=void 0),AZ(i,this.plus(r),me(I({},t),{numeric:"always",units:s,unit:n}))}toRelativeCalendar(t={}){return this.isValid?AZ(t.base||zt.fromObject({},{zone:this.zone}),this,me(I({},t),{numeric:"auto",units:["years","months","days"],calendary:!0})):null}static min(...t){if(!t.every(zt.isDateTime))throw new au("min requires all arguments be DateTimes");return sZ(t,i=>i.valueOf(),Math.min)}static max(...t){if(!t.every(zt.isDateTime))throw new au("max requires all arguments be DateTimes");return sZ(t,i=>i.valueOf(),Math.max)}static fromFormatExplain(t,i,r={}){const{locale:s=null,numberingSystem:n=null}=r,o=es.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return Xhe(o,t,i)}static fromStringExplain(t,i,r={}){return zt.fromFormatExplain(t,i,r)}static get DATE_SHORT(){return jB}static get DATE_MED(){return che}static get DATE_MED_WITH_WEEKDAY(){return I$e}static get DATE_FULL(){return uhe}static get DATE_HUGE(){return hhe}static get TIME_SIMPLE(){return dhe}static get TIME_WITH_SECONDS(){return phe}static get TIME_WITH_SHORT_OFFSET(){return fhe}static get TIME_WITH_LONG_OFFSET(){return mhe}static get TIME_24_SIMPLE(){return ghe}static get TIME_24_WITH_SECONDS(){return yhe}static get TIME_24_WITH_SHORT_OFFSET(){return vhe}static get TIME_24_WITH_LONG_OFFSET(){return _he}static get DATETIME_SHORT(){return bhe}static get DATETIME_SHORT_WITH_SECONDS(){return whe}static get DATETIME_MED(){return xhe}static get DATETIME_MED_WITH_SECONDS(){return The}static get DATETIME_MED_WITH_WEEKDAY(){return $$e}static get DATETIME_FULL(){return She}static get DATETIME_FULL_WITH_SECONDS(){return Ehe}static get DATETIME_HUGE(){return Ahe}static get DATETIME_HUGE_WITH_SECONDS(){return Che}}function WS(e){if(zt.isDateTime(e))return e;if(e&&e.valueOf&&Y_(e.valueOf()))return zt.fromJSDate(e);if(e&&typeof e=="object")return zt.fromObject(e);throw new au(`Unknown datetime argument: ${e}, of type ${typeof e}`)}const l5={ar:[".",","],bg:[",","\xA0"],bs:[",","."],ca:[",","."],cs:[",","\xA0"],da:[",","."],de:[",","."],"de-ch":[".","\u2019"],el:[",","."],en:[".",","],"en-au":[".",","],es:[",","."],"es-mx":[".",","],et:[",","\xA0"],fi:[",","\xA0"],fr:[",","\u202F"],"fr-ch":[",","\u202F"],he:[".",","],hi:[".",",","#,##,##0.###"],hr:[",","."],hu:[",","\xA0"],id:[",","."],it:[",","."],"it-ch":[".","\u2019"],ja:[".",","],ko:[".",","],lt:[",","\xA0"],lv:[",","\xA0"],mk:[",","."],nb:[",","\xA0"],nl:[",","."],pl:[",","\xA0"],pt:[",","."],"pt-pt":[",","\xA0"],ro:[",","."],ru:[",","\xA0"],sk:[",","\xA0"],sl:[",","."],sr:[",","."],sv:[",","\xA0"],th:[".",","],tr:[",","."],uk:[",","\xA0"],vi:[",","."],zh:[".",","]};function nde(e){e||(e=sc());let t=e in l5;if(!t){const n=e.split("-");n.length>1&&n[0]in l5&&(e=n[0],t=!0),t||(e="en")}const[i,r,s="#,##0.###"]=l5[e];return{decimal:i,group:r,pattern:s}}function OLe(e,t){const i=nde((t=I({},t)).locale);t.customs=i;const r=t.pattern||i.pattern;return isNaN(e)||Math.abs(e)===1/0?null:MLe(e,r,t)}const ode=/[#0,]*[#0](?:\.0*#*)?/;function MLe(e,t,i){const r=(i=i||{}).customs.group,s=i.customs.decimal,n=t.split(";"),o=n[0];if((t=n[e<0?1:0]||"-"+o).indexOf("%")!==-1)e*=100;else if(t.indexOf("\u2030")!==-1)e*=1e3;else{if(t.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");if(t.indexOf("E")!==-1)throw new Error("exponential notation not supported")}const a=ode,l=o.match(a);if(!l)throw new Error("unable to find a number expression in pattern: "+t);return i.fractional===!1&&(i.places=0),t.replace(a,PLe(e,l[0],{decimal:s,group:r,places:i.places,round:i.round}))}function PLe(e,t,i){(i=i||{}).places===!0&&(i.places=0),i.places===1/0&&(i.places=6);const r=t.split("."),s=typeof i.places=="string"&&i.places.indexOf(",");let n=i.places;s?n=i.places.substring(s+1):n>=0||(n=(r[1]||[]).length),i.round<0||(e=Number(e.toFixed(Number(n))));const o=String(Math.abs(e)).split("."),a=o[1]||"";if(r[1]||i.places){s&&(i.places=i.places.substring(0,s));const y=i.places!==void 0?i.places:r[1]&&r[1].lastIndexOf("0")+1;y>a.length&&(o[1]=a.padEnd(Number(y),"0")),n<a.length&&(o[1]=a.substr(0,Number(n)))}else o[1]&&o.pop();const l=r[0].replace(",","");let c=l.indexOf("0");c!==-1&&(c=l.length-c,c>o[0].length&&(o[0]=o[0].padStart(c,"0")),l.indexOf("#")===-1&&(o[0]=o[0].substr(o[0].length-c)));let h,p,f=r[0].lastIndexOf(",");if(f!==-1){h=r[0].length-f-1;const y=r[0].substr(0,f);f=y.lastIndexOf(","),f!==-1&&(p=y.length-f-1)}const g=[];for(let y=o[0];y;){const v=y.length-h;g.push(v>0?y.substr(v):y),y=v>0?y.slice(0,v):"",p&&(h=p,p=void 0)}return o[0]=g.reverse().join(i.group||","),o.join(i.decimal||".")}function ILe(e){const t=nde((e=e||{}).locale),i=e.pattern||t.pattern,r=t.group,s=t.decimal;let n=1;if(i.indexOf("%")!==-1)n/=100;else if(i.indexOf("\u2030")!==-1)n/=1e3;else if(i.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");const o=i.split(";");return o.length===1&&o.push("-"+o[0]),{regexp:fC(o,function(l){return(l="(?:"+pse(l,".")+")").replace(ode,function(c){const h={signed:!1,separator:e.strict?r:[r,""],fractional:e.fractional,decimal:s,exponent:!1},p=c.split(".");let f=e.places;p.length===1&&n!==1&&(p[1]="###"),p.length===1||f===0?h.fractional=!1:(f===void 0&&(f=e.pattern?p[1].lastIndexOf("0")+1:1/0),f&&e.fractional==null&&(h.fractional=!0),!e.places&&f<p[1].length&&(f+=","+p[1].length),h.places=f);const g=p[0].split(",");return g.length>1&&(h.groupSize=g.pop().length,g.length>1&&(h.groupSize2=g.pop().length)),"("+DLe(h)+")"})},!0).replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:r,decimal:s,factor:n}}function $Le(e,t){const i=ILe(t),r=new RegExp("^"+i.regexp+"$").exec(e);if(!r)return NaN;let s=r[1];if(!r[1]){if(!r[2])return NaN;s=r[2],i.factor*=-1}return s=s.replace(new RegExp("["+i.group+"\\s\\xa0]","g"),"").replace(i.decimal,"."),Number(s)*i.factor}function DLe(e){"places"in(e=e||{})||(e.places=1/0),typeof e.decimal!="string"&&(e.decimal="."),"fractional"in e&&!/^0/.test(String(e.places))||(e.fractional=[!0,!1]),"exponent"in e||(e.exponent=[!0,!1]),"eSigned"in e||(e.eSigned=[!0,!1]);const t=RZ(e),i=fC(e.fractional,function(s){let n="";return s&&e.places!==0&&(n="\\"+e.decimal,e.places===1/0?n="(?:"+n+"\\d+)?":n+="\\d{"+e.places+"}"),n},!0);let r=t+i;return i&&(r="(?:(?:"+r+")|(?:"+i+"))"),r+fC(e.exponent,function(s){return s?"([eE]"+RZ({signed:e.eSigned})+")":""})}function RZ(e){return"signed"in(e=e||{})||(e.signed=[!0,!1]),"separator"in e?"groupSize"in e||(e.groupSize=3):e.separator="",fC(e.signed,function(t){return t?"[-+]":""},!0)+fC(e.separator,function(t){if(!t)return"(?:\\d+)";(t=pse(t))===" "?t="\\s":t==="\xA0"&&(t="\\s\\xa0");const i=e.groupSize,r=e.groupSize2;if(r){const s="(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+t+"]\\d{"+r+"})*["+t+"]\\d{"+i+"})";return i-r>0?"(?:"+s+"|(?:0|[1-9]\\d{0,"+(i-1)+"}))":s}return"(?:0|[1-9]\\d{0,"+(i-1)+"}(?:["+t+"]\\d{"+i+"})*)"},!0)}const fC=function(e,t,i){if(!(e instanceof Array))return t(e);const r=[];for(let s=0;s<e.length;s++)r.push(t(e[s]));return LLe(r.join("|"),i)},LLe=function(e,t){return"("+(t?"?:":"")+e+")"};var OZ,MZ;function Idt(e){return IR.fromJSON(e.toJSON())}function NLe(e){return e.toJSON?e.toJSON():e}function $dt(e){return typeof e=="string"||e instanceof String}function Ddt(e){return typeof e=="number"}function PZ(e){return e instanceof Date}function Ldt(e,t){return e===t||!(!PZ(e)||!PZ(t))&&e.getTime()===t.getTime()}function Ndt(e){if(e===void 0)return null;if(typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 109404;case"miles":case"mile":return 109413;case"kilometers":case"kilometer":case"km":return 109414}return null}function Fdt(e){if(e===null)return null;switch(e.type){case"polygon":case"multipoint":case"polyline":return e.extent;case"point":return new Zt({xmin:e.x,ymin:e.y,xmax:e.x,ymax:e.y,spatialReference:e.spatialReference});case"extent":return e}return null}function Udt(e){if(e===void 0)return null;if(typeof e=="number"||typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 9001;case"miles":case"mile":return 9035;case"kilometers":case"kilometer":case"km":return 9036}return null}(function(e){e[e.Standardised=0]="Standardised",e[e.StandardisedNoInterval=1]="StandardisedNoInterval",e[e.SqlServer=2]="SqlServer",e[e.Oracle=3]="Oracle",e[e.Postgres=4]="Postgres",e[e.PGDB=5]="PGDB",e[e.FILEGDB=6]="FILEGDB",e[e.NotEvaluated=7]="NotEvaluated"})(OZ||(OZ={})),function(e){e[e.InFeatureSet=0]="InFeatureSet",e[e.NotInFeatureSet=1]="NotInFeatureSet",e[e.Unknown=2]="Unknown"}(MZ||(MZ={}));const kdt=1e3,zdt={point:"point",polygon:"polygon",polyline:"polyline",multipoint:"multipoint",extent:"extent",esriGeometryPoint:"point",esriGeometryPolygon:"polygon",esriGeometryPolyline:"polyline",esriGeometryMultipoint:"multipoint",esriGeometryEnvelope:"extent",envelope:"extent"},IZ={point:"esriGeometryPoint",polygon:"esriGeometryPolygon",polyline:"esriGeometryPolyline",multipoint:"esriGeometryMultipoint",extent:"esriGeometryEnvelope",esriGeometryPoint:"esriGeometryPoint",esriGeometryPolygon:"esriGeometryPolygon",esriGeometryPolyline:"esriGeometryPolyline",esriGeometryMultipoint:"esriGeometryMultipoint",esriGeometryEnvelope:"esriGeometryEnvelope",envelope:"esriGeometryEnvelope"},Bdt={"small-integer":"esriFieldTypeSmallInteger",integer:"esriFieldTypeInteger",long:"esriFieldTypeLong",single:"esriFieldTypeSingle",double:"esriFieldTypeDouble",string:"esriFieldTypeString",date:"esriFieldTypeDate",oid:"esriFieldTypeOID",geometry:"esriFieldTypeGeometry",blob:"esriFieldTypeBlob",raster:"esriFieldTypeRaster",guid:"esriFieldTypeGUID","global-id":"esriFieldTypeGlobalID",xml:"eesriFieldTypeXML",esriFieldTypeSmallInteger:"esriFieldTypeSmallInteger",esriFieldTypeInteger:"esriFieldTypeInteger",esriFieldTypeLong:"esriFieldTypeLong",esriFieldTypeSingle:"esriFieldTypeSingle",esriFieldTypeDouble:"esriFieldTypeDouble",esriFieldTypeString:"esriFieldTypeString",esriFieldTypeDate:"esriFieldTypeDate",esriFieldTypeOID:"esriFieldTypeOID",esriFieldTypeGeometry:"esriFieldTypeGeometry",esriFieldTypeBlob:"esriFieldTypeBlob",esriFieldTypeRaster:"esriFieldTypeRaster",esriFieldTypeGUID:"esriFieldTypeGUID",esriFieldTypeGlobalID:"esriFieldTypeGlobalID",esriFieldTypeXML:"eesriFieldTypeXML"};function Vdt(e,t){return k9((i,r)=>{const s=Zw(!0);e.reduce((n,o,a,l)=>n.then(c=>{try{return t(c,o,a,l)}catch(h){return mW(h)}},c=>mW(c)),s).then(i,r)})}function Gdt(e){return e===void 0?"":e=(e=(e=e.replace(/\/featureserver\/[0-9]*/i,"/FeatureServer")).replace(/\/mapserver\/[0-9]*/i,"/MapServer")).split("?")[0]}function jdt(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.indexOf(a)!==-1){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],g=o(a[f]);g&&(c&&(c+=","),c+=JSON.stringify(f)+":"+g)}return n.splice(h,1),"{"+c+"}"}(e)}class ade{constructor(t){this.value=t}}class lde{constructor(t){this.value=t}}class ej{constructor(t){this.fn=t}}class tj{constructor(t,i){this.paramCount=i,this.fn=t}}const FLe=ej,ULe=lde,kLe=ade,zLe=tj,Wl={type:"VOID"},BLe={type:"BREAK"},VLe={type:"CONTINUE"};function mC(e,t,i){return t===""||t==null||t===i||t===i?e:e=e.split(t).join(i)}function ij(e){return e instanceof ej||e instanceof R$e||e instanceof tj}function hD(e){return!!io(e)||!!ca(e)||!!No(e)||!!la(e)||e===null||e===Wl||typeof e=="number"}function GLe(e,t){return e===void 0?t:e}function io(e){return typeof e=="string"||e instanceof String}function la(e){return typeof e=="boolean"}function ca(e){return typeof e=="number"}function jLe(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e}function Su(e){return e instanceof Array}function HLe(e){return(e==null?void 0:e.arcadeDeclaredClass)==="esri.arcade.Feature"}function qLe(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureset.support.FeatureSet")===!0}function WLe(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureSetCollection")===!0}function v1(e){return e instanceof Cp}function No(e){return e instanceof Date}function XLe(e,t,i){if(e.length<t||e.length>i)throw new Error("Function called with wrong number of Parameters")}function YLe(e){return e<0?-Math.round(-e):Math.round(e)}function ZLe(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),(t==="x"?i:3&i|8).toString(16)})}function rj(e,t){return isNaN(e)===!1?t==null||t===""?e.toString():(t=mC(t,"\u2030",""),t=mC(t,"\xA4",""),OLe(e,{pattern:t})):e.toString()}function CN(e,t){const i=zt.fromJSDate(e);return t==null||t===""?i.toISO({suppressMilliseconds:!0}):i.toFormat(cde(t),{locale:sc(),numberingSystem:"latn"})}function cde(e){e=e.replace(/LTS|LT|LL?L?L?|l{1,4}/g,"[$&]");let t="";const i=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;for(const r of e.match(i))switch(r){case"D":t+="d";break;case"DD":t+="dd";break;case"DDD":t+="o";break;case"d":t+="c";break;case"ddd":t+="ccc";break;case"dddd":t+="cccc";break;case"M":t+="L";break;case"MM":t+="LL";break;case"MMM":t+="LLL";break;case"MMMM":t+="LLLL";break;case"YY":t+="yy";break;case"Y":case"YYYY":t+="yyyy";break;case"Q":t+="q";break;case"Z":t+="ZZ";break;case"ZZ":t+="ZZZ";break;case"S":t+="'S'";break;case"SS":t+="'SS'";break;case"SSS":t+="u";break;case"A":case"a":t+="a";break;case"m":case"mm":case"h":case"hh":case"H":case"HH":case"s":case"ss":case"X":case"x":t+=r;break;default:r.length>=2&&r.slice(0,1)==="["&&r.slice(-1)==="]"?t+=`'${r.slice(1,-1)}'`:t+=`'${r}'`}return t}function Yi(e,t,i){switch(i){case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}return!1}function QLe(e,t,i){if(e===null){if(t===null||t===Wl)return Yi(null,null,i);if(ca(t))return Yi(0,t,i);if(io(t)||la(t))return Yi(0,Qr(t),i);if(No(t))return Yi(0,t.getTime(),i)}if(e===Wl){if(t===null||t===Wl)return Yi(null,null,i);if(ca(t))return Yi(0,t,i);if(io(t)||la(t))return Yi(0,Qr(t),i);if(No(t))return Yi(0,t.getTime(),i)}else if(ca(e)){if(ca(t))return Yi(e,t,i);if(la(t))return Yi(e,Qr(t),i);if(t===null||t===Wl)return Yi(e,0,i);if(io(t))return Yi(e,Qr(t),i);if(No(t))return Yi(e,t.getTime(),i)}else if(io(e)){if(io(t))return Yi(Hy(e),Hy(t),i);if(No(t))return Yi(Qr(e),t.getTime(),i);if(ca(t))return Yi(Qr(e),t,i);if(t===null||t===Wl)return Yi(Qr(e),0,i);if(la(t))return Yi(Qr(e),Qr(t),i)}else if(No(e)){if(No(t))return Yi(e,t,i);if(t===null||t===Wl)return Yi(e.getTime(),0,i);if(ca(t))return Yi(e.getTime(),t,i);if(la(t)||io(t))return Yi(e.getTime(),Qr(t),i)}else if(la(e)){if(la(t))return Yi(e,t,i);if(ca(t))return Yi(Qr(e),Qr(t),i);if(No(t))return Yi(Qr(e),t.getTime(),i);if(t===null||t===Wl)return Yi(Qr(e),0,i);if(io(t))return Yi(Qr(e),Qr(t),i)}return!!ude(e,t)&&(i==="<="||i===">=")}function ude(e,t){if(e===t||e===null&&t===Wl||t===null&&e===Wl)return!0;if(No(e)&&No(t))return e.getTime()===t.getTime();if(e instanceof H7||e instanceof J1)return e.equalityTest(t);if(e instanceof Ke&&t instanceof Ke){const i=e.cache._arcadeCacheId,r=t.cache._arcadeCacheId;if(i!=null)return i===r}return e!==void 0&&t!==void 0&&e!==null&&t!==null&&typeof e=="object"&&typeof t=="object"&&(e._arcadeCacheId===t._arcadeCacheId&&e._arcadeCacheId!==void 0&&e._arcadeCacheId!==null||e._underlyingGraphic===t._underlyingGraphic&&e._underlyingGraphic!==void 0&&e._underlyingGraphic!==null)}function Hy(e,t){if(io(e))return e;if(e===null)return"";if(ca(e))return rj(e,t);if(la(e))return e.toString();if(No(e))return CN(e,t);if(e instanceof fl)return JSON.stringify(e.toJSON());if(Su(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=dD(e[r]);return"["+i.join(",")+"]"}if(e instanceof Cp){const i=[];for(let r=0;r<e.length();r++)i[r]=dD(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():ij(e)?"object, Function":""}function JLe(e){const t=[];if(Su(e)===!1)return null;if(e instanceof Cp){for(let i=0;i<e.length();i++)t[i]=Qr(e.get(i));return t}for(let i=0;i<e.length;i++)t[i]=Qr(e[i]);return t}function j3(e,t){if(io(e))return e;if(e===null)return"";if(ca(e))return rj(e,t);if(la(e))return e.toString();if(No(e))return CN(e,t);if(e instanceof fl)return e instanceof Zt?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+QB(e.spatialReference)+"}":QB(e.toJSON(),(i,r)=>i.key===r.key?0:i.key==="spatialReference"?1:r.key==="spatialReference"||i.key<r.key?-1:i.key>r.key?1:0);if(Su(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=dD(e[r]);return"["+i.join(",")+"]"}if(e instanceof Cp){const i=[];for(let r=0;r<e.length();r++)i[r]=dD(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():ij(e)?"object, Function":""}function dD(e){if(e===null)return"null";if(la(e)||ca(e)||io(e))return JSON.stringify(e);if(e instanceof fl||e instanceof Cp||e instanceof Array)return j3(e);if(e instanceof Date)return JSON.stringify(CN(e,""));if(e!==null&&typeof e=="object"){if(e.castToText!==void 0)return e.castToText()}else if(e===Wl)return"null";return"null"}function Qr(e,t){return ca(e)?e:e===null||e===""?0:No(e)?NaN:la(e)?e?1:0:Su(e)||e===""||e===void 0?NaN:t!==void 0&&io(e)?(t=mC(t,"\u2030",""),t=mC(t,"\xA4",""),$Le(e,{pattern:t})):e===Wl?0:Number(e)}function KLe(e){if(No(e))return e;if(io(e)){const t=hde(e);if(t)return t.toJSDate()}return null}function eNe(e){return No(e)?zt.fromJSDate(e):io(e)?hde(e):null}function hde(e){const t=/ (\d\d)/;let i=zt.fromISO(e);return i.isValid||t.test(e)&&(e=e.replace(t,"T$1"),i=zt.fromISO(e),i.isValid)?i:null}function tNe(e){return la(e)?e:io(e)?(e=e.toLowerCase())==="true":!!ca(e)&&e!==0&&!isNaN(e)}function iNe(e,t){return O(e)?null:(e.spatialReference!==null&&e.spatialReference!==void 0||(e.spatialReference=t),e)}function rNe(e){if(e===null)return null;if(e instanceof Ke)return e.x==="NaN"||e.x===null||isNaN(e.x)?null:e;if(e instanceof dc){if(e.rings.length===0)return null;for(const t of e.rings)if(t.length>0)return e;return null}if(e instanceof tc){if(e.paths.length===0)return null;for(const t of e.paths)if(t.length>0)return e;return null}return e instanceof B1?e.points.length===0?null:e:e instanceof Zt?e.xmin==="NaN"||e.xmin===null||isNaN(e.xmin)?null:e:null}function dde(e,t){if(!e||!e.domain)return t;let i=null;if(e.field.type==="string"||e.field.type==="esriFieldTypeString")t=Hy(t);else{if(t==null)return null;if(t==="")return t;t=Qr(t)}for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.code===t&&(i=s)}return i===null?t:i.name}function pde(e,t){if(!e||!e.domain)return t;let i=null;t=Hy(t);for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.name===t&&(i=s)}return i===null?t:i.code}function RN(e,t,i=null,r=null){if(!t||!t.fields)return null;let s,n,o=null;for(let a=0;a<t.fields.length;a++){const l=t.fields[a];l.name.toLowerCase()===e.toString().toLowerCase()&&(o=l)}if(o===null)throw new Error("Field not found");return r===null&&i&&t.typeIdField&&(r=i.hasField(t.typeIdField)?i.field(t.typeIdField):null),r!=null&&t.types.some(function(a){return a.id===r&&(s=a.domains&&a.domains[o.name],s&&s.type==="inherited"&&(s=$Z(o.name,t),n=!0),!0)}),n||s||(s=$Z(e,t)),{field:o,domain:s}}function $Z(e,t){let i;return t.fields.some(function(r){return r.name.toLowerCase()===e.toLowerCase()&&(i=r.domain),!!i}),i}function QB(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.indexOf(a)!==-1){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],g=o(a[f]);g&&(c&&(c+=","),c+=JSON.stringify(f)+":"+g)}return n.splice(h,1),"{"+c+"}"}(e)}function sNe(e){if(e===null)return null;const t=[];for(const i of e)i&&i.arcadeDeclaredClass&&i.arcadeDeclaredClass==="esri.arcade.Feature"?t.push(i.geometry()):t.push(i);return t}function bT(e,t){if(!(t instanceof Ke))throw new Error("Invalid Argument");e.push(t.hasZ?t.hasM?[t.x,t.y,t.z,t.m]:[t.x,t.y,t.z]:[t.x,t.y])}function nNe(e,t){if(Su(e)||v1(e)){let i=!1,r=!1,s=[],n=t;if(Su(e)){for(const o of e)bT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ,r=e[0].hasM)}else if(e instanceof J1)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else{if(!v1(e))throw new Error("Invalid Argument");for(const o of e.toArray())bT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:(aG(s,r,i)===!1&&(s=s.slice(0).reverse()),new dc({rings:[s],spatialReference:n,hasZ:i,hasM:r}))}return e}function oNe(e,t){if(Su(e)||v1(e)){let i=!1,r=!1,s=[],n=t;if(Su(e)){for(const o of e)bT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof J1)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(v1(e)){for(const o of e.toArray())bT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new tc({paths:[s],spatialReference:n,hasZ:i,hasM:r})}return e}function aNe(e,t){if(Su(e)||v1(e)){let i=!1,r=!1,s=[],n=t;if(Su(e)){for(const o of e)bT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof J1)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(v1(e)){for(const o of e.toArray())bT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new B1({points:s,spatialReference:n,hasZ:i,hasM:r})}return e}function lNe(e,t=!1){const i=[];if(e===null)return i;if(Su(e)===!0){for(let r=0;r<e.length;r++){const s=Hy(e[r]);s===""&&t!==!0||i.push(s)}return i}if(e instanceof Cp){for(let r=0;r<e.length();r++){const s=Hy(e.get(r));s===""&&t!==!0||i.push(s)}return i}if(hD(e)){const r=Hy(e);return r===""&&t!==!0||i.push(r),i}return[]}let c5=0;function cNe(e){return c5++,c5%100==0?(c5=0,k9(t=>{setTimeout(()=>{t(e)},0)})):e}function uNe(e,t,i){switch(i){case"&":return e&t;case"|":return e|t;case"^":return e^t;case"<<":return e<<t;case">>":return e>>t;case">>>":return e>>>t}}function gC(e,t=null){return e==null?null:la(e)||ca(e)||io(e)?e:e instanceof fl?(t==null?void 0:t.keepGeometryType)===!0?e:e.toJSON():e instanceof Cp?e.toArray().map(i=>gC(i,t)):e instanceof Array?e.map(i=>gC(i,t)):e instanceof Date?e:e!==null&&typeof e=="object"&&e.castAsJson!==void 0?e.castAsJson(t):null}function hNe(e,t,i,r,s){return sj(e,t,i).then(n=>{s[r]=n})}function sj(e,t=null,i=null){if(e instanceof Cp&&(e=e.toArray()),e==null)return Zw(null);if(hD(e)||e instanceof fl||e instanceof Date)return Zw(gC(e,i));if(e instanceof Array){const r=[],s=[];for(const n of e)n===null||hD(n)||n instanceof fl||n instanceof Date?s.push(gC(n,i)):(s.push(null),r.push(hNe(n,t,i,s.length-1,s)));return r.length>0?U9(r).then(()=>s):Zw(s)}return e!==null&&typeof e=="object"&&e.castAsJsonAsync!==void 0?e.castAsJsonAsync(t,i):Zw(null)}function dNe(e,t,i){const r=e.fullSchema();return r===null||!r.fields?null:RN(t,r,e,i)}function pNe(e){const t=e.fullSchema();return t===null?null:t.fields&&t.typeIdField?{subtypeField:t.typeIdField,subtypes:t.types?t.types.map(i=>({name:i.name,code:i.id})):[]}:null}function fNe(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;const n=RN(t,s,e,r);if(i===void 0)try{i=e.field(t)}catch{return null}return dde(n,i)}function mNe(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;if(i===void 0){try{i=e.field(t)}catch{return null}return i}return pde(RN(t,s,e,r),i)}function gNe(e){const t=e.fullSchema();if(t===null||!t.fields)return null;const i=[];for(const r of t.fields)i.push(NLe(r));return{objectIdField:t.objectIdField,globalIdField:t.globalIdField,geometryType:IZ[t.geometryType]===void 0?"":IZ[t.geometryType],fields:i}}const Hdt=Object.freeze({__proto__:null,ReturnResultE:ade,ImplicitResultE:lde,NativeFunctionE:ej,SizzleFunctionE:tj,NativeFunction:FLe,ImplicitResult:ULe,ReturnResult:kLe,SizzleFunction:zLe,voidOperation:Wl,breakResult:BLe,continueResult:VLe,multiReplace:mC,isFunctionParameter:ij,isSimpleType:hD,defaultUndefined:GLe,isString:io,isBoolean:la,isNumber:ca,isInteger:jLe,isArray:Su,isFeature:HLe,isFeatureSet:qLe,isFeatureSetCollection:WLe,isImmutableArray:v1,isDate:No,pcCheck:XLe,absRound:YLe,generateUUID:ZLe,formatNumber:rj,formatDate:CN,standardiseDateFormat:cde,greaterThanLessThan:QLe,equalityTest:ude,toString:Hy,toNumberArray:JLe,toStringExplicit:j3,toNumber:Qr,toDate:KLe,toDateTime:eNe,toBoolean:tNe,fixSpatialReference:iNe,fixNullGeometry:rNe,getDomainValue:dde,getDomainCode:pde,getDomain:RN,stableStringify:QB,autoCastFeatureToGeometry:sNe,autoCastArrayOfPointsToPolygon:nNe,autoCastArrayOfPointsToPolyline:oNe,autoCastArrayOfPointsToMultiPoint:aNe,toStringArray:lNe,tick:cNe,binaryOperator:uNe,castAsJson:gC,castAsJsonAsync:sj,featureFullDomain:dNe,featureSubtypes:pNe,featureDomainValueLookup:fNe,featureDomainCodeLookup:mNe,featureSchema:gNe});var JB;let bE=JB=class extends ve{constructor(e){super(e),this.minValue=0,this.maxValue=0}clone(){return new JB({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],bE.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],bE.prototype,"maxValue",void 0),bE=JB=u([P("esri.renderer.support.AuthoringInfoClassBreakInfo")],bE);const yNe=bE;var KB;let Pv=KB=class extends ve{constructor(e){super(e),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new KB({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:se(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],Pv.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Pv.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],Pv.prototype,"label",void 0),u([d({type:[yNe],json:{write:!0}})],Pv.prototype,"classBreakInfos",void 0),Pv=KB=u([P("esri.renderers.support.AuthoringInfoFieldInfo")],Pv);const DZ=Pv;var eV;const KO=new si({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),eM=new si({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),LZ={key:e=>typeof e=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},NZ=["high-to-low","above-and-below","centered-on","extremes"],FZ=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],UZ=["seconds","minutes","hours","days","months","years"];let ka=eV=class extends ve{constructor(e){super(e),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(e){return typeof e=="string"||typeof e=="number"?e:null}castStartTime(e){return typeof e=="string"||typeof e=="number"?e:null}get style(){return this.type==="color"?this._get("style"):null}set style(e){this._set("style",e)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(e){this._set("theme",e)}clone(){return new eV({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:LZ,json:{write:!0}})],ka.prototype,"endTime",void 0),u([It("endTime")],ka.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],ka.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"minSliderValue",void 0),u([d({types:LZ,json:{write:!0}})],ka.prototype,"startTime",void 0),u([It("startTime")],ka.prototype,"castStartTime",null),u([d({type:KO.apiValues,value:null,json:{type:KO.jsonValues,read:KO.read,write:KO.write}})],ka.prototype,"style",null),u([d({type:FZ,value:null,json:{type:FZ,origins:{"web-scene":{type:NZ,write:{writer:(e,t)=>{NZ.indexOf(e)>-1&&(t.theme=e)}}}},write:!0}})],ka.prototype,"theme",null),u([d({type:eM.apiValues,json:{type:eM.jsonValues,read:eM.read,write:eM.write}})],ka.prototype,"type",void 0),u([d({type:UZ,json:{type:UZ,write:!0}})],ka.prototype,"units",void 0),ka=eV=u([P("esri.renderers.support.AuthoringInfoVisualVariable")],ka);const vNe=ka;let H3=class extends ve{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],H3.prototype,"type",void 0),H3=u([P("esri.rest.support.ColorRamp")],H3);const nj=H3;var tV;let Iv=tV=class extends nj{constructor(e){super(e),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new tV({fromColor:se(this.fromColor),toColor:se(this.toColor),algorithm:this.algorithm})}};u([ht({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],Iv.prototype,"algorithm",void 0),u([d({type:Qe,json:{type:[mr],write:!0}})],Iv.prototype,"fromColor",void 0),u([d({type:Qe,json:{type:[mr],write:!0}})],Iv.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],Iv.prototype,"type",void 0),Iv=tV=u([P("esri.rest.support.AlgorithmicColorRamp")],Iv);const oj=Iv;var iV;let wE=iV=class extends nj{constructor(e){super(e),this.colorRamps=null,this.type="multipart"}clone(){return new iV({colorRamps:se(this.colorRamps)})}};u([d({type:[oj],json:{write:!0}})],wE.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],wE.prototype,"type",void 0),wE=iV=u([P("esri.rest.support.MultipartColorRamp")],wE);const fde=wE,_Ne={key:"type",base:nj,typeMap:{algorithmic:oj,multipart:fde}};function bNe(e){return e&&e.type?e.type==="algorithmic"?oj.fromJSON(e):e.type==="multipart"?fde.fromJSON(e):null:null}var rV;const D0=new si({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),tM=new si({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),kZ=new si({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),zZ=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],wNe=["high-to-low","above-and-below","above","below","90-10"],xNe=["flow-line","wave-front"],TNe=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let Is=rV=class extends ve{constructor(e){super(e),this.colorRamp=null,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const e=this._get("classificationMethod"),t=this.type;return t&&t!=="relationship"?t==="class-breaks-size"||t==="class-breaks-color"?e||"manual":null:e}set classificationMethod(e){this._set("classificationMethod",e)}readColorRamp(e){if(e)return bNe(e)}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(e){this._set("fields",e)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(e){this._set("field1",e)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(e){this._set("field2",e)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(e){this._set("flowTheme",e)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(e){this._set("focus",e)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(e){this._set("numClasses",e)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(e){this._set("statistics",e)}get standardDeviationInterval(){const e=this.type;return e&&e!=="relationship"&&e!=="class-breaks-size"&&e!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(e){this._set("standardDeviationInterval",e)}get type(){return this._get("type")}set type(e){let t=e;e==="classed-size"?t="class-breaks-size":e==="classed-color"&&(t="class-breaks-color"),this._set("type",t)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(e){this._set("univariateSymbolStyle",e)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(e){this._set("univariateTheme",e)}clone(){return new rV({classificationMethod:this.classificationMethod,colorRamp:se(this.colorRamp),fields:this.fields&&this.fields.slice(0),field1:se(this.field1),field2:se(this.field2),focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(e=>e.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:D0.apiValues,value:null,json:{type:D0.jsonValues,read:D0.read,write:D0.write,origins:{"web-document":{default:"manual",type:D0.jsonValues,read:D0.read,write:D0.write}}}})],Is.prototype,"classificationMethod",null),u([d({types:_Ne,json:{write:!0}})],Is.prototype,"colorRamp",void 0),u([Fe("colorRamp")],Is.prototype,"readColorRamp",null),u([d({type:[String],value:null,json:{write:!0}})],Is.prototype,"fields",null),u([d({type:DZ,value:null,json:{write:!0}})],Is.prototype,"field1",null),u([d({type:DZ,value:null,json:{write:!0}})],Is.prototype,"field2",null),u([d({type:xNe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Is.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],Is.prototype,"focus",null),u([d({type:Number,value:null,json:{type:mr,write:!0}})],Is.prototype,"numClasses",null),u([d({type:zZ,json:{type:zZ,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],Is.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Is.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Is.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Is.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],Is.prototype,"standardDeviationInterval",null),u([d({type:tM.apiValues,value:null,json:{type:tM.jsonValues,read:tM.read,write:tM.write,origins:{"web-scene":{type:kZ.jsonValues,write:{writer:kZ.write,overridePolicy:e=>({enabled:e!=="flow"})}}}}})],Is.prototype,"type",null),u([d({type:[vNe],json:{write:!0}})],Is.prototype,"visualVariables",void 0),u([d({type:TNe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Is.prototype,"univariateSymbolStyle",null),u([d({type:wNe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Is.prototype,"univariateTheme",null),Is=rV=u([P("esri.renderers.support.AuthoringInfo")],Is);const SNe=Is,u5=new si({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary"},{ignoreUnknown:!0});let xE=class extends ve{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const t=new Set;return await this.collectRequiredFields(t,e),Array.from(t).sort()}getSymbol(e,t){}async getSymbolAsync(e,t){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:SNe,json:{write:!0}})],xE.prototype,"authoringInfo",void 0),u([d({type:u5.apiValues,readOnly:!0,json:{type:u5.jsonValues,read:!1,write:{writer:u5.write,ignoreOrigin:!0}}})],xE.prototype,"type",void 0),xE=u([P("esri.renderers.Renderer")],xE);const A0=xE;var sV;let q3=sV=class extends ve{constructor(){super(...arguments),this.title=null}clone(){return new sV({title:this.title})}};u([d({type:String,json:{write:!0}})],q3.prototype,"title",void 0),q3=sV=u([P("esri.renderers.support.LegendOptions")],q3);const aj=q3;var nV;let W3=nV=class extends aj{constructor(){super(...arguments),this.showLegend=null}clone(){return new nV({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],W3.prototype,"showLegend",void 0),W3=nV=u([P("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],W3);const mde=W3,ENe=he.getLogger("esri.renderers.visualVariables.VisualVariable"),h5=new si({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let ih=class extends ve{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(ENe.error(".field: field must be a string value"),null):_R(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],ih.prototype,"index",void 0),u([d({type:h5.apiValues,readOnly:!0,json:{read:h5.read,write:h5.write}})],ih.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],ih.prototype,"field",void 0),u([It("field")],ih.prototype,"castField",null),u([d({type:String,json:{write:!0}})],ih.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],ih.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],ih.prototype,"arcadeRequired",null),u([d({type:mde,json:{write:!0}})],ih.prototype,"legendOptions",void 0),ih=u([P("esri.renderers.visualVariables.VisualVariable")],ih);const FR=ih;var oV;let $v=oV=class extends ve{constructor(e){super(e),this.color=null,this.label=null,this.value=null}writeValue(e,t,i){t[i]=e==null?0:e}clone(){return new oV({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Qe,json:{type:[mr],write:!0}})],$v.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],$v.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],$v.prototype,"value",void 0),u([Ge("value")],$v.prototype,"writeValue",null),$v=oV=u([P("esri.renderers.visualVariables.support.ColorStop")],$v);const ANe=$v;var aV;let Dv=aV=class extends FR{constructor(e){super(e),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new aV({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Dv.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],Dv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Dv.prototype,"normalizationField",void 0),u([d({type:[ANe],json:{write:!0}})],Dv.prototype,"stops",null),Dv=aV=u([P("esri.renderers.visualVariables.ColorVariable")],Dv);const gde=Dv;var lV;let Ng=lV=class extends ve{constructor(e){super(e),this.label=null,this.opacity=null,this.value=null}readOpacity(e,t){return rC(t.transparency)}writeOpacity(e,t,i){t[i]=xG(e)}clone(){return new lV({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],Ng.prototype,"label",void 0),u([d({type:Number,json:{type:mr,write:{target:"transparency"}}})],Ng.prototype,"opacity",void 0),u([Fe("opacity",["transparency"])],Ng.prototype,"readOpacity",null),u([Ge("opacity")],Ng.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],Ng.prototype,"value",void 0),Ng=lV=u([P("esri.renderers.visualVariables.support.OpacityStop")],Ng);const CNe=Ng;var cV;let Lv=cV=class extends FR{constructor(e){super(e),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new cV({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Lv.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],Lv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Lv.prototype,"normalizationField",void 0),u([d({type:[CNe],json:{write:!0}})],Lv.prototype,"stops",null),Lv=cV=u([P("esri.renderers.visualVariables.OpacityVariable")],Lv);const yde=Lv;var uV;let df=uV=class extends FR{constructor(e){super(e),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(e,t,i,r){if(r&&r.messages){const s=`visualVariables[${this.index}]`;r.messages.push(new Q("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:r}))}}clone(){return new uV({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],df.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],df.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],df.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],df.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],df.prototype,"valueExpressionTitle",void 0),u([Ge("web-scene","valueExpressionTitle")],df.prototype,"writeValueExpressionTitleWebScene",null),df=uV=u([P("esri.renderers.visualVariables.RotationVariable")],df);const vde=df;var hV;let vw=hV=class extends ve{constructor(e){super(e),this.label=null,this.size=null,this.value=null}clone(){return new hV({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],vw.prototype,"label",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],vw.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],vw.prototype,"value",void 0),vw=hV=u([P("esri.renderers.visualVariables.support.SizeStop")],vw);const RNe=vw;var dV;let X3=dV=class extends mde{constructor(){super(...arguments),this.customValues=null}clone(){return new dV({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],X3.prototype,"customValues",void 0),X3=dV=u([P("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],X3);const ONe=X3;var em,cn;function rx(e){return e&&e.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function yC(e){return e!=null&&!isNaN(e)&&isFinite(e)}function _de(e){return e.valueExpression?em.Expression:e.field&&typeof e.field=="string"?em.Field:em.Unknown}function MNe(e,t){const i=t||_de(e),r=e.valueUnit||"unknown";return i===em.Unknown?cn.Constant:e.stops?cn.Stops:e.minSize!=null&&e.maxSize!=null&&e.minDataValue!=null&&e.maxDataValue!=null?cn.ClampedLinear:r==="unknown"?e.minSize!=null&&e.minDataValue!=null?e.minSize&&e.minDataValue?cn.Proportional:cn.Additive:cn.Identity:cn.RealWorldSize}(function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"})(em||(em={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(cn||(cn={}));const wT={inches:gs(1,"meters","inches"),feet:gs(1,"meters","feet"),"us-feet":gs(1,"meters","us-feet"),yards:gs(1,"meters","yards"),miles:gs(1,"meters","miles"),"nautical-miles":gs(1,"meters","nautical-miles"),millimeters:gs(1,"meters","millimeters"),centimeters:gs(1,"meters","centimeters"),decimeters:gs(1,"meters","decimeters"),meters:gs(1,"meters","meters"),kilometers:gs(1,"meters","kilometers"),"decimal-degrees":1/_Ae(1,"meters",ai.radius)},a0=he.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),BZ=new Bo,Y3=Math.PI,bde=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function wde(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="color"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void a0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(!_(i)||!_(i.arcade))return void a0.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=cj(a,c);if(y){const v=y[0],b=y[1],w=v===b?r.stops[v].color:Qe.blendColors(r.stops[v].color,r.stops[b].color,y[2],_(i)?i.color:void 0);return new Qe(w)}}}function xde(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="opacity"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void a0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(O(i)||O(i.arcade))return void a0.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=cj(a,c);if(y){const v=y[0],b=y[1];if(v===b)return r.stops[v].opacity;{const w=r.stops[v].opacity;return w+(r.stops[b].opacity-w)*y[2]}}}}function Tde(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(g=>g.type==="rotation"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void a0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=r.axis||"heading",n=s==="heading"&&r.rotationType==="arithmetic"?90:0,o=s==="heading"&&r.rotationType==="arithmetic"?-1:1,a=typeof t=="number"?null:t,l=a&&a.attributes,c=r.field,{hasExpression:h}=r.cache;let p=r.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(O(i)||O(i.arcade))return void a0.error("Use of arcade expressions requires an arcade context");const g={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},y=i.arcade.arcadeUtils,v=y.getViewInfo(g),b=y.createExecContext(a,v);if(!p){const w=y.createSyntaxTree(r.valueExpression);p=y.createFunction(w),r.cache.compiledFunc=p}f=y.executeFunction(p,b)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function PNe(e,t,i){const r=typeof t=="number",s=r?null:t,n=s&&s.attributes;let o=r?t:null;const{isScaleDriven:a}=e.cache;let l=e.cache.compiledFunc;if(a){const h=_(i)?i.scale:void 0,p=_(i)?i.view:void 0;o=h==null||p==="3d"?INe(e):h}else if(!r)switch(e.inputValueType){case em.Expression:{if(O(i)||O(i.arcade))return void a0.error("Use of arcade expressions requires an arcade context");const h={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},p=i.arcade.arcadeUtils,f=p.getViewInfo(h),g=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(e.valueExpression);l=p.createFunction(y),e.cache.compiledFunc=l}o=p.executeFunction(l,g);break}case em.Field:n&&(o=n[e.field]);break;case em.Unknown:o=null}if(!yC(o))return null;if(r||!e.normalizationField)return o;const c=n?parseFloat(n[e.normalizationField]):null;return yC(c)&&c!==0?o/c:null}function INe(e){let t=null,i=null;const r=e.stops;return r?(t=r[0].value,i=r[r.length-1].value):(t=e.minDataValue||0,i=e.maxDataValue||0),(t+i)/2}function ON(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(n=>n.type==="size"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void a0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=Ede(PNe(r,t,i),r,t,i,r.cache.ipData);return s==null||isNaN(s)?0:s}function hl(e,t,i){return e==null?null:rx(e)?ON(e,t,i):yC(e)?e:null}function Sde(e,t,i){return yC(i)&&e>i?i:yC(t)&&e<t?t:e}function $Ne(e,t,i,r){return e+(hl(t.minSize,i,r)||t.minDataValue)}function DNe(e,t,i){const r=e.stops;let s=r&&r.length&&r[0].size;return s==null&&(s=e.minSize),hl(s,t,i)}function LNe(e,t,i,r){const s=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),n=hl(t.minSize,i,r),o=hl(t.maxSize,i,r),a=_(r)?r.shape:void 0;if(e<=t.minDataValue)return n;if(e>=t.maxDataValue)return o;if(t.scaleBy==="area"&&a){const l=a==="circle",c=l?Y3*(n/2)**2:n*n,h=c+s*((l?Y3*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/Y3):Math.sqrt(h)}return n+s*(o-n)}function NNe(e,t,i,r){const s=_(r)?r.shape:void 0,n=e/t.minDataValue,o=hl(t.minSize,i,r),a=hl(t.maxSize,i,r);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,Sde(l,o,a)}function FNe(e,t,i,r,s){const[n,o,a]=cj(e,s);if(n===o)return hl(t.stops[n].size,i,r);{const l=hl(t.stops[n].size,i,r);return l+(hl(t.stops[o].size,i,r)-l)*a}}function UNe(e,t,i,r){const s=(_(r)&&r.resolution?r.resolution:1)*wT[t.valueUnit],n=hl(t.minSize,i,r),o=hl(t.maxSize,i,r),{valueRepresentation:a}=t;let l=null;return l=a==="area"?2*Math.sqrt(e/Y3)/s:a==="radius"||a==="distance"?2*e/s:e/s,Sde(l,n,o)}function Ede(e,t,i,r,s){switch(t.transformationType){case cn.Additive:return $Ne(e,t,i,r);case cn.Constant:return DNe(t,i,r);case cn.ClampedLinear:return LNe(e,t,i,r);case cn.Proportional:return NNe(e,t,i,r);case cn.Stops:return FNe(e,t,i,r,s);case cn.RealWorldSize:return UNe(e,t,i,r);case cn.Identity:return e;case cn.Unknown:return null}}function kNe(e,t,i){const{isScaleDriven:r}=e.cache;if(!(r&&i==="3d"||t))return null;const s={scale:t,view:i};let n=hl(e.minSize,BZ,s),o=hl(e.maxSize,BZ,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function lj(e,t,i){if(!e.visualVariables)return;const r=[],s=[],n=[],o=[],a=[];for(const l of e.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=wde(l,t,i);r.push({variable:l,value:c})}),n.forEach(l=>{const c=xde(l,t,i);r.push({variable:l,value:c})}),a.forEach(l=>{const c=Tde(l,t,i);r.push({variable:l,value:c})}),o.forEach(l=>{const c=ON(l,t,i);r.push({variable:l,value:c})}),r.filter(l=>l.value!=null)}function cj(e,t){if(!t)return;let i=0,r=t.length-1;return t.some((s,n)=>e<s?(r=n,!0):(i=n,!1)),[i,r,(e-t[i])/(t[r]-t[i])]}function zNe(e,t,i){const r=["proportional","proportional","proportional"];for(const s of e){const n=s.useSymbolValue?"symbol-value":ON(s,t,i);switch(s.axis){case"width":r[0]=n;break;case"depth":r[1]=n;break;case"height":r[2]=n;break;case"width-and-depth":r[0]=n,r[1]=n;break;case"all":case void 0:case null:r[0]=n,r[1]=n,r[2]=n;break;default:s.axis}}return r}var BNe=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:zNe,getColor:wde,getOpacity:xde,getRotationAngle:Tde,getSize:ON,getSizeForValue:Ede,getSizeFromNumberOrVariable:hl,getSizeRangeAtScale:kNe,getVisualVariableValues:lj,viewScaleRE:bde},Symbol.toStringTag,{value:"Module"})),pV;const db=he.getLogger("esri.renderers.visualVariables.SizeVariable"),iM=new si({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),fV=new si({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function VZ(e){if(e!=null)return typeof e=="string"||typeof e=="number"?Bi(e):e.type==="size"?rx(e)?e:(delete(e=I({},e)).type,new Pi(e)):void 0}function GZ(e,t,i){if(typeof e!="object")return e;const r=new Pi;return r.read(e,i),r}let Pi=pV=class extends FR{constructor(e){super(e),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:bde.test(this.valueExpression)}}set expression(e){db.warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),e==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",e)):this._set("expression",null)}set index(e){rx(this.maxSize)&&(this.maxSize.index=`visualVariables[${e}].maxSize`),rx(this.minSize)&&(this.minSize.index=`visualVariables[${e}].minSize`),this._set("index",e)}get inputValueType(){return _de(this)}set maxDataValue(e){e&&this.stops&&(db.warn("cannot set maxDataValue when stops is not null."),e=null),this._set("maxDataValue",e)}set maxSize(e){e&&this.stops&&(db.warn("cannot set maxSize when stops is not null."),e=null),this._set("maxSize",e)}castMaxSize(e){return VZ(e)}readMaxSize(e,t,i){return GZ(e,t,i)}set minDataValue(e){e&&this.stops&&(db.warn("cannot set minDataValue when stops is not null."),e=null),this._set("minDataValue",e)}set minSize(e){e&&this.stops&&(db.warn("cannot set minSize when stops is not null."),e=null),this._set("minSize",e)}castMinSize(e){return VZ(e)}readMinSize(e,t,i){return GZ(e,t,i)}get arcadeRequired(){return!!this.valueExpression||this.minSize&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(e){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value):e&&(db.warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),e=null),this._set("stops",e)}get transformationType(){return MNe(this,this.inputValueType)}readValueExpression(e,t){return e||t.expression&&"$view.scale"}writeValueExpressionWebScene(e,t,i,r){if(e==="$view.scale"){if(r&&r.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;r.messages.push(new Q("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:r}))}}else t[i]=e}readValueUnit(e){return e?fV.read(e):null}clone(){return new pV({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:rx(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:rx(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===cn.ClampedLinear){const{minSize:e,maxSize:t}=this;return this.minSize=t,this.maxSize=e,this}if(this.transformationType===cn.Stops){const e=this.stops,t=e.map(r=>r.size).reverse(),i=e.length;for(let r=0;r<i;r++)e[r].size=t[r];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Pi.prototype,"cache",null),u([d({type:iM.apiValues,json:{type:iM.jsonValues,origins:{"web-map":{read:!1}},read:iM.read,write:iM.write}})],Pi.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],Pi.prototype,"expression",null),u([d()],Pi.prototype,"index",null),u([d({type:String,readOnly:!0})],Pi.prototype,"inputValueType",null),u([d({type:ONe,json:{write:!0}})],Pi.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],Pi.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Pi.prototype,"maxSize",null),u([It("maxSize")],Pi.prototype,"castMaxSize",null),u([Fe("maxSize")],Pi.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],Pi.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Pi.prototype,"minSize",null),u([It("minSize")],Pi.prototype,"castMinSize",null),u([Fe("minSize")],Pi.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],Pi.prototype,"normalizationField",void 0),u([d({readOnly:!0})],Pi.prototype,"arcadeRequired",null),u([d({type:String})],Pi.prototype,"scaleBy",void 0),u([d({type:[RNe],value:null,json:{write:!0}})],Pi.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],Pi.prototype,"target",void 0),u([d({type:String,readOnly:!0})],Pi.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],Pi.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],Pi.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],Pi.prototype,"valueExpression",void 0),u([Fe("valueExpression",["valueExpression","expression"])],Pi.prototype,"readValueExpression",null),u([Ge("web-scene","valueExpression")],Pi.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],Pi.prototype,"valueRepresentation",void 0),u([d({type:fV.apiValues,json:{write:fV.write,origins:{"web-map":{read:!1},"web-scene":{write:!0}}}})],Pi.prototype,"valueUnit",void 0),u([Fe("valueUnit")],Pi.prototype,"readValueUnit",null),Pi=pV=u([P("esri.renderers.visualVariables.SizeVariable")],Pi);const Ade=Pi,VNe=he.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),GNe={color:gde,size:Ade,opacity:yde,rotation:vde},jNe=new si({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),HNe=/^\[([^\]]+)\]$/i;let Z3=class extends we{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(t=>!!t))&&e.length){for(const t of e)switch(t.type){case"color":this.colorVariables.push(t);break;case"opacity":this.opacityVariables.push(t);break;case"rotation":this.rotationVariables.push(t);break;case"size":this.sizeVariables.push(t)}this.sizeVariables.length&&this.sizeVariables.some(t=>!!t.target)&&e.sort((t,i)=>{let r=null;return r=t.target===i.target?0:t.target?1:-1,r});for(let t=0;t<e.length;t++)e[t].index=t;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,t,i){const{rotationExpression:r,rotationType:s}=t,n=r&&r.match(HNe),o=n&&n[1];if(o&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:s,field:o})),e)return e.map(a=>{const l=jNe.read(a.type),c=GNe[l];c||(VNe.warn(`Unknown variable type: ${l}`),i&&i.messages&&i.messages.push(new uc("visual-variable:unsupported",`visualVariable of type '${l}' is not supported`,{definition:a,context:i})));const h=new c;return h.read(a,i),h})}writeVariables(e,t){const i=[];for(const r of e){const s=r.toJSON(t);s&&i.push(s)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],Z3.prototype,"visualVariables",null),Z3=u([P("esri.renderers.visualVariables.VisualVariableFactory")],Z3);const qNe=Z3,WNe={base:FR,key:"type",typeMap:{opacity:yde,color:gde,rotation:vde,size:Ade}},UR=e=>{let t=class extends e{constructor(){super(...arguments),this._vvFactory=new qNe}set visualVariables(i){this._vvFactory.visualVariables=i,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(i,r,s){return this._vvFactory.readVariables(i,r,s)}writeVisualVariables(i,r,s,n){r[s]=this._vvFactory.writeVariables(i,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const i of this.visualVariables)if(i.arcadeRequired)return!0;return!1}hasVisualVariables(i,r){return i?this.getVisualVariablesForType(i,r).length>0:this.getVisualVariablesForType("size",r).length>0||this.getVisualVariablesForType("color",r).length>0||this.getVisualVariablesForType("opacity",r).length>0||this.getVisualVariablesForType("rotation",r).length>0}getVisualVariablesForType(i,r){const s=this.visualVariables;return s?s.filter(n=>n.type===i&&(typeof r=="string"?n.target===r:r!==!1||!n.target)):[]}async collectVVRequiredFields(i,r){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&wu(i,r,n.field),n.normalizationField&&wu(i,r,n.normalizationField),n.valueExpression&&await pc(i,r,n.valueExpression))}};return u([d({types:[WNe],value:null,json:{write:!0}})],t.prototype,"visualVariables",null),u([Fe("visualVariables",["visualVariables","rotationType","rotationExpression"])],t.prototype,"readVisualVariables",null),u([Ge("visualVariables")],t.prototype,"writeVisualVariables",null),t=u([P("esri.renderers.mixins.VisualVariablesMixin")],t),t},XS={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function XNe(e,t=XS){if(!e)return{symbol:null};const{retainId:i=XS.retainId,ignoreDrivers:r=XS.ignoreDrivers,hasLabelingContext:s=XS.hasLabelingContext,retainCIM:n=XS.retainCIM}=t;let o;if(oC(e)||e instanceof W1)o=e.clone();else if(e.type==="cim"){var a,l;const c=(a=e.data)==null||(l=a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new Q("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:e})};o=n?e.clone():Sy.fromCIMSymbol(e)}else if(e instanceof Xh)o=XL.fromSimpleLineSymbol(e);else if(e instanceof oS)o=Sy.fromSimpleMarkerSymbol(e);else if(e instanceof YL)o=Sy.fromPictureMarkerSymbol(e);else if(e instanceof q1)o=CR.fromSimpleFillSymbol(e);else{if(!(e instanceof aS))return{error:new Q("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${e.type||e.declaredClass}' is unsupported in 3D`,{symbol:e})};o=s?WL.fromTextSymbol(e):Sy.fromTextSymbol(e)}if(i&&o.type!=="cim"&&(o.id=e.id),r&&oC(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}function pD(e,t,i,r){const s=Cde(e,{},{context:r,isLabelSymbol:!1});_(s)&&(t[i]=s)}function jZ(e,t,i,r){const s=Cde(e,{},{context:r,isLabelSymbol:!0});_(s)&&(t[i]=s)}function Cde(e,t,i){if(O(e))return null;const{context:r,isLabelSymbol:s}=i;if(r&&r.origin==="web-scene"&&!(e instanceof nS)&&!(e instanceof W1)){const n=XNe(e,{retainCIM:!0,hasLabelingContext:s});return _(n.symbol)?n.symbol.write(t,r):(r.messages&&r.messages.push(new Q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:e,context:r,error:n.error})),null)}return r&&r.origin==="web-map"&&e.type==="web-style"?(r.messages&&r.messages.push(new Q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in webmaps. Use CIMSymbol instead when working with WebMap in MapView.`,{symbol:e,context:r})),null):e.write(t,r)}function qdt(e,t){return gEe(e,null,t)}const kR={types:xae,json:{write:{writer:pD},origins:{"web-scene":{types:cX,write:{writer:pD},read:{reader:ZT({types:cX})}}}}},Rde={types:{base:_l,key:"type",typeMap:{"simple-fill":B_.typeMap["simple-fill"],"picture-fill":B_.typeMap["picture-fill"],"polygon-3d":B_.typeMap["polygon-3d"]}},json:{write:{writer:pD},origins:{"web-scene":{type:CR,write:{writer:pD}}}}};var mV;let Fg=mV=class extends ve{constructor(e){super(e),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new mV({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${e}`}};u([d({type:String,json:{write:!0}})],Fg.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Fg.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],Fg.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],Fg.prototype,"maxValue",void 0),u([d(kR)],Fg.prototype,"symbol",void 0),Fg=mV=u([P("esri.renderers.support.ClassBreakInfo")],Fg);const fD=Fg;var gV;const rM=he.getLogger("esri.renderers.ClassBreaksRenderer"),Ode="log",Q3="percent-of-total",J3="field",sM=new si({esriNormalizeByLog:Ode,esriNormalizeByPercentOfTotal:Q3,esriNormalizeByField:J3}),YNe=ns(fD);let zs=gV=class extends UR(A0){constructor(e){super(e),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(e,t,i){if(!Array.isArray(e))return;let r=t.minValue;return e.map(s=>{const n=new fD;return n.read(s,i),n.minValue==null&&(n.minValue=r),n.maxValue==null&&(n.maxValue=n.minValue),r=n.maxValue,n})}writeClassBreakInfos(e,t,i,r){const s=e.map(n=>n.write({},r));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),t[i]=s}castField(e){return e==null?e:typeof e=="function"?(rM.error(".field: field must be a string value"),null):_R(e)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let e=this._get("normalizationType");const t=!!this.normalizationField,i=this.normalizationTotal!=null;return t||i?(e=t&&J3||i&&Q3||null,t&&i&&rM.warn("warning: both normalizationField and normalizationTotal are set!")):e!==J3&&e!==Q3||(e=null),e}set normalizationType(e){this._set("normalizationType",e)}addClassBreakInfo(e,t,i){let r=null;r=typeof e=="number"?new fD({minValue:e,maxValue:t,symbol:Tae(i)}):YNe(se(e)),this.classBreakInfos.push(r),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(e,t){const i=this.classBreakInfos.length;for(let r=0;r<i;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===e&&s[1]===t){this.classBreakInfos.splice(r,1);break}}}getBreakIndex(e,t){return this.valueExpression&&(O(t)||O(t.arcade))&&rM.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)}async getClassBreakInfo(e,t){let i=t;this.valueExpression&&(O(t)||O(t.arcade))&&(i=me(I({},i),{arcade:await cp()}));const r=this.getBreakIndex(e,i);return r!==-1?this.classBreakInfos[r]:null}getSymbol(e,t){if(this.valueExpression&&(O(t)||O(t.arcade)))return void rM.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this.getBreakIndex(e,t);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(O(t)||O(t.arcade))){const s=await cp(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=me(I({},i),{arcade:s})}const r=this.getBreakIndex(e,i);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}getSymbols(){const e=[];return this.classBreakInfos.forEach(t=>{t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),i=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce((r,s)=>r+s.getMeshHash(),"")}.${i}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new gV({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:se(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:se(this.visualVariables),legendOptions:se(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),pc(e,t,this.valueExpression)];wu(e,t,this.field),wu(e,t,this.normalizationField),await Promise.all(i)}_getBreakIndexForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=gt(t,{});let o=this._compiledValueExpression.valueExpression===this.valueExpression?this._compiledValueExpression.compiledFunction:null;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._compiledValueExpression.compiledFunction=o}this._compiledValueExpression.valueExpression=this.valueExpression;const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._getBreakIndexfromInfos(l)}_getBreakIndexForField(e){const t=this.field,i=e.attributes,r=this.normalizationType;let s=parseFloat(i[t]);if(r){const n=this.normalizationTotal,o=parseFloat(i[this.normalizationField]);if(r===Ode)s=Math.log(s)*Math.LOG10E;else if(r!==Q3||isNaN(n)){if(r===J3&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(e){const t=this.isMaxInclusive;if(e!=null&&typeof e=="number"&&!isNaN(e))for(let i=0;i<this.classBreakInfos.length;i++){const r=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(r[0]<=e&&(t?e<=r[1]:e<r[1]))return i}return-1}_areClassBreaksConsecutive(){const e=this.classBreakInfos,t=e.length;for(let i=1;i<t;i++)if(e[i-1].maxValue!==e[i].minValue)return!1;return!0}};u([d(Rde)],zs.prototype,"backgroundFillSymbol",void 0),u([d({type:[fD]})],zs.prototype,"classBreakInfos",void 0),u([Fe("classBreakInfos")],zs.prototype,"readClassBreakInfos",null),u([Ge("classBreakInfos")],zs.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],zs.prototype,"defaultLabel",void 0),u([d(kR)],zs.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],zs.prototype,"field",void 0),u([It("field")],zs.prototype,"castField",null),u([d({type:Boolean})],zs.prototype,"isMaxInclusive",void 0),u([d({type:aj,json:{write:!0}})],zs.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],zs.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],zs.prototype,"normalizationField",void 0),u([d({type:Number,cast:e=>ou(e),json:{write:!0}})],zs.prototype,"normalizationTotal",void 0),u([d({type:sM.apiValues,value:null,json:{type:sM.jsonValues,read:sM.read,write:sM.write}})],zs.prototype,"normalizationType",null),u([ht({classBreaks:"class-breaks"})],zs.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],zs.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],zs.prototype,"valueExpressionTitle",void 0),zs=gV=u([P("esri.renderers.ClassBreaksRenderer")],zs);const Mde=zs,K3=-3;var Uf;(function(e){e[e.ALL=0]="ALL",e[e.SOME=1]="SOME"})(Uf||(Uf={}));class ZNe{constructor(t,i,r){this._namespace=t,this._storage=i,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(t,i,r,s=0){this._storage.put(this._namespace+t,i,r,s)}get(t){const i=this._storage.get(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}pop(t){const i=this._storage.pop(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}updateSize(t,i,r){this._storage.updateSize(this._namespace+t,i,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class uj{constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new $t,this._users=new $t}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,i){this._removeFuncs.push([t,i])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace(i=>i[0]!==t)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,0),this._checkSizeLimit()}put(t,i,r,s){const n=this._db.get(t);if(n&&(this._size-=n.size,this._db.delete(t),n.entry!==i&&this._notifyRemove(t,n.entry,Uf.ALL)),r>this._maxSize)return void this._notifyRemove(t,i,Uf.ALL);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const o=1+Math.max(s,K3)-K3;this._db.set(t,{entry:i,size:r,lifetime:o,lives:o}),this._size+=r,this._checkSizeLimit()}updateSize(t,i,r){const s=this._db.get(t);if(s&&s.entry===i){for(this._size-=s.size;r>this._maxSize;){const n=this._notifyRemove(t,i,Uf.SOME);if(!(_(n)&&n>0))return void this._db.delete(t);r=n}s.size=r,this._size+=r,this._checkSizeLimit()}}pop(t){const i=this._db.get(t);if(i)return this._size-=i.size,this._db.delete(t),++this._hit,i.entry;++this._miss}get(t){const i=this._db.get(t);if(i!==void 0)return this._db.delete(t),i.lives=i.lifetime,this._db.set(t,i),++this._hit,i.entry;++this._miss}getStats(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},r=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;r[l]=(r[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=i[h]||0;i[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=i[a]||0;i[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(i);n.sort((o,a)=>i[a]-i[o]),n.forEach(o=>t[o]=Math.round(i[o]/2**20)+"MB / "+s[o]);for(let o=r.length-1;o>=0;--o){const a=r[o];a&&(t["Priority "+(o+K3-1)]=Math.round(a/this.size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll(t=>t.resetHitRate())}clear(t){this._db.forEach((i,r)=>{r.startsWith(t)&&(this._size-=i.size,this._db.delete(r),this._notifyRemove(r,i.entry,Uf.ALL))})}clearAll(){this._db.forEach((t,i)=>this._notifyRemove(i,t.entry,Uf.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,i,r){let s;return this._removeFuncs.some(n=>{if(t.startsWith(n[0])){const o=n[1](i,r);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[t,i]of this._db){if(this._db.delete(t),i.lives<=1){this._size-=i.size;const r=this._notifyRemove(t,i.entry,Uf.SOME);_(r)&&r>0&&(this._size+=r,i.lives=i.lifetime,i.size=r,this._db.set(t,i))}else--i.lives,this._db.set(t,i);if(this._size<=.9*this.maxSize)return}}}class QNe{constructor(t,i){this._storage=new uj,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i,r){this._storage.put(t,i,r,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}}const HZ=he.getLogger("esri.renderers.support.DictionaryLoader"),JNe={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class hj{constructor(t,i,r){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new QNe(100),this.url=t,this.config=i,this.fieldMap=r}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,i){let r;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(i));try{r=await this._dictionaryPromise}catch(g){if(vr(g))return this._dictionaryPromise=null,null}const s={};if(this.fieldMap)for(const g of this._symbolFields){const y=this.fieldMap[g];if(y&&t.attributes[y]!=null){const v=""+t.attributes[y];s[g]=v}else s[g]=""}const n=r(s,i);if(!n||typeof n!="string")return null;const o=D9(n).toString(),a=this._symbolCache.get(o);if(a)return a.catch(()=>{this._symbolCache.pop(o)}),a;const l=n.split(";"),c=[],h=[];for(const g of l)if(g)if(g.includes("po:")){const y=g.substr(3).split("|");if(y.length===3){const v=y[0],b=y[1];let w=y[2];if(b==="DashTemplate")w=w.split(" ").map(S=>Number(S));else if(b==="Color"){const S=new Qe(w).toRgba();w=[S[0],S[1],S[2],255*S[3]]}else w=Number(w);h.push({primitiveName:v,propertyName:b,value:w})}}else if(g.includes("|")){for(const y of g.split("|"))if(this._itemNames.has(y)){c.push(y);break}}else this._itemNames.has(g)&&c.push(g);const p=!_(t.geometry)||!t.geometry.hasZ&&t.geometry.type==="point",f=this._cimPartsToCIMSymbol(c,h,p,i);return this._symbolCache.put(o,f,1),f}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void HZ.error("no valid URL!");const i=_(t)?t.abortOptions:null,r=Ci(this.url+"/resources/styles/dictionary-info.json",I({responseType:"json",query:{f:"json"}},i)),[{data:s}]=await Promise.all([r,cp()]);if(!s)throw this._dictionaryPromise=null,new Q("esri.renderers.DictionaryRenderer","Bad dictionary data!");const n=s.expression,o=s.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+s.cimRefTemplateUrl,this._itemNames=new Set(s.itemsNames),this._symbolFields=o.symbol;const a={};if(this.config){const c=this.config;for(const h in c)a[h]=c[h]}if(o.configuration)for(const c of o.configuration)a.hasOwnProperty(c.name)||(a[c.name]=c.value);const l=[];if(_(t)&&t.fields&&this.fieldMap)for(const c of this._symbolFields){const h=this.fieldMap[c],p=t.fields.filter(f=>f.name===h);p.length>0&&l.push(me(I({},p[0]),{name:c}))}return this._dictionaryPromise=gTe(n,_(t)?t.spatialReference:null,l,a).then(c=>{const h={scale:0};return(p,f)=>{const g=c.repurposeFeature({geometry:null,attributes:p});return h.scale=_(f)?f.scale:void 0,c.evaluate({$feature:g,$view:h})}}).catch(c=>(HZ.error("Creating dictinoary expression failed:",c),null)),this._dictionaryPromise}async _cimPartsToCIMSymbol(t,i,r,s){const n=new Array(t.length);for(let l=0;l<t.length;l++)n[l]=this._getSymbolPart(t[l],s);const o=await Promise.all(n),a=this.fieldMap;for(const l of o)Pde(l,a);return new JT({data:this._combineSymbolParts(o,i,r)})}async _getSymbolPart(t,i){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then(n=>n.data);const r=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,t),s=Ci(r,I({responseType:"json",query:{f:"json"}},i));this._ongoingRequests.set(t,s);try{return(await s).data}catch(n){return this._ongoingRequests.delete(t),Promise.reject(n)}}_combineSymbolParts(t,i,r){if(!t||t.length===0)return null;const s=I({},t[0]);if(t.length>1){s.symbolLayers=[];for(const n of t){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return r&&(s.callout=JNe),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:i}}}function Pde(e,t){if(!e)return;const i=e.symbolLayers;if(!i)return;let r=i.length;for(;r--;){const s=i[r];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&KNe(s,t)}}function KNe(e,t){const i=e.markerGraphics;if(i)for(const r of i){if(!r)continue;const s=r.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Pde(s,t);break;case"CIMTextSymbol":s.fieldMap=t}}}var Wdt=Object.freeze(Object.defineProperty({__proto__:null,DictionaryLoader:hj},Symbol.toStringTag,{value:"Module"})),yV;let rh=yV=class extends UR(A0){constructor(e){super(e),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new hj(this.url,this.config,this.fieldMap)}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,i,r){r!=null&&r.origin||super.writeVisualVariables(e,t,i,r)}clone(){return new yV({config:se(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:se(this.fieldMap),url:se(this.url),visualVariables:se(this.visualVariables)})}async getSymbolAsync(e,t){return this._loader.getSymbolAsync(e,t)}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await pc(e,t,this.scaleExpression);for(const i in this.fieldMap){const r=this.fieldMap[i];t.has(r)&&e.add(r)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:hj})],rh.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],rh.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],rh.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],rh.prototype,"scaleExpression",void 0),u([Ge("scaleExpression")],rh.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],rh.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],rh.prototype,"url",void 0),u([Ge("visualVariables")],rh.prototype,"writeVisualVariables",null),rh=yV=u([P("esri.renderers.DictionaryRenderer")],rh);const eFe=rh;var vV;const tFe=he.getLogger("esri.renderers.support.AttributeColorInfo");let pf=vV=class extends ve{constructor(e){super(e),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(e){return e==null?e:typeof e=="function"?(tFe.error(".field: field must be a string value"),null):_R(e)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new vV({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Qe,json:{type:[Number],write:!0}})],pf.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],pf.prototype,"field",void 0),u([It("field")],pf.prototype,"castField",null),u([d({type:String,json:{write:!0}})],pf.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],pf.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],pf.prototype,"valueExpressionTitle",void 0),pf=vV=u([P("esri.renderers.support.AttributeColorInfo")],pf);const iFe=pf;var _V;let eI=_V=class extends ve{constructor(){super(...arguments),this.unit=null}clone(){return new _V({unit:this.unit})}};u([d({type:String,json:{write:!0}})],eI.prototype,"unit",void 0),eI=_V=u([P("esri.renderers.support.DotDensityLegendOptions")],eI);const rFe=eI;var bV;let wo=bV=class extends UR(A0){constructor(e){super(e),this.attributes=null,this.backgroundColor=new Qe([0,0,0,0]),this.blendDots=!0,this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new Xh,this.dotValue=null,this.referenceDotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(e){if(this.referenceScale==null)return this.dotValue;const t=e/this.referenceScale*this.dotValue;return t<1?1:t}getSymbol(){return new q1({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes&&this.attributes.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new bV({attributes:se(this.attributes),backgroundColor:se(this.backgroundColor),dotBlendingEnabled:se(this.dotBlendingEnabled),dotShape:se(this.dotShape),dotSize:se(this.dotSize),dotValue:se(this.dotValue),legendOptions:se(this.legendOptions),outline:se(this.outline),referenceScale:se(this.referenceScale),visualVariables:se(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){return`${this.attributes.map(e=>e.field||e.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const i of this.attributes)i.valueExpression&&await pc(e,t,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[iFe],json:{write:!0}})],wo.prototype,"attributes",void 0),u([d({type:Qe,json:{write:!0}})],wo.prototype,"backgroundColor",void 0),u([d({type:Boolean}),mt("dotBlendingEnabled")],wo.prototype,"blendDots",void 0),u([d({type:Boolean,json:{write:!0}})],wo.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],wo.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1}}}})],wo.prototype,"dotSize",void 0),u([d({type:rFe,json:{write:!0}})],wo.prototype,"legendOptions",void 0),u([d({type:Xh,json:{default:null,write:!0}})],wo.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],wo.prototype,"dotValue",void 0),u([d({type:Number}),mt("dotValue")],wo.prototype,"referenceDotValue",void 0),u([d({type:Number,json:{write:!0}})],wo.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],wo.prototype,"seed",void 0),u([ht({dotDensity:"dot-density"})],wo.prototype,"type",void 0),wo=bV=u([P("esri.renderers.DotDensityRenderer")],wo);const sFe=wo;var wV;let TE=wV=class extends ve{constructor(e){super(e),this.color=null,this.ratio=null}clone(){return new wV({color:this.color,ratio:this.ratio})}};u([d({type:Qe,json:{write:!0}})],TE.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],TE.prototype,"ratio",void 0),TE=wV=u([P("esri.renderers.support.HeatmapColorStop")],TE);const tI=TE;var xV;let sh=xV=class extends A0{constructor(e){super(e),this.blurRadius=10,this.referenceScale=0,this.colorStops=[new tI({ratio:0,color:new Qe("rgba(255, 140, 0, 0)")}),new tI({ratio:.75,color:new Qe("rgba(255, 140, 0, 1)")}),new tI({ratio:.9,color:new Qe("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.maxPixelIntensity=100,this.minPixelIntensity=0,this.type="heatmap"}async collectRequiredFields(e,t){const i=this.field;i&&typeof i=="string"&&wu(e,t,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new xV({blurRadius:this.blurRadius,referenceScale:this.referenceScale,colorStops:se(this.colorStops),field:this.field,maxPixelIntensity:this.maxPixelIntensity,minPixelIntensity:this.minPixelIntensity})}};u([d({type:Number,json:{write:!0}})],sh.prototype,"blurRadius",void 0),u([d({type:Number})],sh.prototype,"referenceScale",void 0),u([d({type:[tI],json:{write:!0}})],sh.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],sh.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:i==null})}}})],sh.prototype,"fieldOffset",void 0),u([d({type:Number,json:{write:!0}})],sh.prototype,"maxPixelIntensity",void 0),u([d({type:Number,json:{write:!0}})],sh.prototype,"minPixelIntensity",void 0),u([ht({heatmap:"heatmap"})],sh.prototype,"type",void 0),sh=xV=u([P("esri.renderers.HeatmapRenderer")],sh);const nFe=sh;var TV;let Nv=TV=class extends UR(A0){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(e,t){await Promise.all([this.collectSymbolFields(e,t),this.collectVVRequiredFields(e,t)])}async collectSymbolFields(e,t){await Promise.all(this.getSymbols().map(i=>i.collectRequiredFields(e,t)))}getSymbol(e,t){return this.symbol}async getSymbolAsync(e,t){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,t)=>e+JSON.stringify(t),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new TV({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:se(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],Nv.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Nv.prototype,"label",void 0),u([d(kR)],Nv.prototype,"symbol",void 0),u([ht({simple:"simple"})],Nv.prototype,"type",void 0),Nv=TV=u([P("esri.renderers.SimpleRenderer")],Nv);const dj=Nv,oFe=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function SV(e){return e instanceof we}function qZ(e){return e instanceof pt?Object.keys(e.items):SV(e)?Ta(e).keys():e?Object.keys(e):[]}function nM(e,t){return e instanceof pt?e.items[t]:e[t]}function aFe(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}function wA(e){return e?e.declaredClass:null}function Ide(e,t){const i=e.diff;if(i&&typeof i=="function")return i(e,t);const r=qZ(e),s=qZ(t);if(r.length===0&&s.length===0)return;if(!r.length||!s.length||aFe(e,t))return{type:"complete",oldValue:e,newValue:t};const n=s.filter(p=>r.indexOf(p)===-1),o=r.filter(p=>s.indexOf(p)===-1),a=r.filter(p=>s.indexOf(p)>-1&&nM(e,p)!==nM(t,p)).concat(n,o).sort(),l=wA(e);if(l&&oFe.indexOf(l)>-1&&a.length)return{type:"complete",oldValue:e,newValue:t};let c;const h=SV(e)&&SV(t);for(const p of a){const f=nM(e,p),g=nM(t,p);let y;(h||typeof f!="function"&&typeof g!="function")&&f!==g&&(f==null&&g==null||(y=i&&i[p]&&typeof i[p]=="function"?i[p](f,g):typeof f=="object"&&typeof g=="object"&&wA(f)===wA(g)?Ide(f,g):{type:"complete",oldValue:f,newValue:g},_(y)&&(_(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})))}return c}function lFe(e,t){if(O(e))return!1;const i=t.split(".");let r=e;for(const s of i){if(r.type==="complete")return!0;if(r.type!=="partial")return!1;{const n=r.diff[s];if(!n)return!1;r=n}}return!0}function Xdt(e,t){for(const i of t)if(lFe(e,i))return!0;return!1}function cFe(e,t){if(!(typeof e=="function"||typeof t=="function"||O(e)&&O(t)))return O(e)||O(t)||typeof e=="object"&&typeof t=="object"&&wA(e)!==wA(t)?{type:"complete",oldValue:e,newValue:t}:Ide(e,t)}function oM(e){if(O(e))return!0;switch(e.type){case"complete":return!1;case"collection":{const t=e;for(const i of t.added)if(!oM(i))return!1;for(const i of t.removed)if(!oM(i))return!1;for(const i of t.changed)if(!oM(i))return!1;return!0}case"partial":for(const t in e.diff)if(!oM(e.diff[t]))return!1;return!0}}var EV;let Ug=EV=class extends ve{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}castValue(e){return e==null||typeof e=="string"||typeof e=="number"?e:`${e}`}clone(){return new EV({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${e}`}};u([d({type:String,json:{write:!0}})],Ug.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Ug.prototype,"label",void 0),u([d(kR)],Ug.prototype,"symbol",void 0),u([d({json:{type:String,write:{writer:(e,t)=>{t.value=e==null?void 0:e.toString()}}}})],Ug.prototype,"value",void 0),u([It("value")],Ug.prototype,"castValue",null),Ug=EV=u([P("esri.renderers.support.UniqueValueInfo")],Ug);const mD=Ug,uFe=()=>!!ue("enable-feature:force-wosr"),Ydt=()=>!!ue("enable-feature:direct-3d-object-feature-layer-display"),hFe=()=>!!ue("enable-feature:precipitation"),d5={};async function dFe(e,t){try{return{data:(await gFe(e,t)).data,baseUrl:g2e(e),styleUrl:e}}catch(i){return Em(i),null}}function pFe(e,t,i){const r=t&&t.portal||gl.getDefault();let s;const n=`${r.url} - ${r.user&&r.user.username} - ${e}`;return d5[n]||(d5[n]=fFe(e,r,i).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl,styleName:e}))),d5[n]}function fFe(e,t,i){return t.load(i).then(()=>{const r=new Vf({disableExtraQuery:!0,query:`owner:${WZ} AND type:${XZ} AND typekeywords:"${e}"`});return t.queryItems(r,i)}).then(({results:r})=>{let s=null;const n=e.toLowerCase();if(r&&Array.isArray(r)){for(const o of r)if(o.typeKeywords.some(a=>a.toLowerCase()===n)&&o.type===XZ&&o.owner===WZ){s=o;break}}if(!s)throw new Q("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return s.load(i)})}function mFe(e,t,i){return e.styleUrl?dFe(e.styleUrl,i):e.styleName?pFe(e.styleName,t,i):Promise.reject(new Q("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function Zdt(e){return e===null||e.type==="CIMSymbolReference"?e:{type:"CIMSymbolReference",symbol:e}}function Qdt(e,t){if(t==="cimRef")return e.cimRef;if(e.formatInfos&&!uFe()){for(const i of e.formatInfos)if(i.type==="gltf")return i.href}return e.webRef}function gFe(e,t){const i=I({responseType:"json",query:{f:"json"}},t);return Ci(Ih(e),i)}const WZ="esri_en",XZ="Style",Jdt="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var SE;const L0=he.getLogger("esri.renderers.UniqueValueRenderer"),yFe=ns(mD);let Yr=SE=class extends UR(A0){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="unique-value",this.backgroundFillSymbol=null,this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,i){if(!t&&!i)return;if(!t||!i)return{type:"complete",oldValue:t,newValue:i};let r=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<i.length;n++){const o=t.find(a=>a.value===i[n].value);o?cFe(o,i[n])?(s.changed.push({type:"complete",oldValue:o,newValue:i[n]}),r=!0):s.unchanged.push({oldValue:o,newValue:i[n]}):(s.added.push(i[n]),r=!0)}for(let n=0;n<t.length;n++)i.find(o=>o.value===t[n].value)||(s.removed.push(t[n]),r=!0);return r?s:void 0}},this._set("uniqueValueInfos",[])}get _cache(){return{compiledFunc:null}}castField(e){return e==null||typeof e=="function"?e:_R(e)}writeField(e,t,i,r){typeof e=="string"?t[i]=e:r&&r.messages?r.messages.push(new Q("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):L0.error(".field: cannot write field to JSON since it's not a string value")}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}readPortal(e,t,i){return i.portal||gl.getDefault()}readStyleOrigin(e,t,i){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const r=rS(t.styleUrl,i);return Object.freeze({styleUrl:r})}}writeStyleOrigin(e,t,i,r){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=u1(e.styleUrl,r))}set uniqueValueInfos(e){this.styleOrigin?L0.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void L0.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i=typeof e=="object"?yFe(e):new mD({value:e,symbol:Tae(t)}),this.uniqueValueInfos.push(i),this._valueInfoMap[i.value]=i}removeUniqueValueInfo(e){if(this.styleOrigin)L0.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++)if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}async getUniqueValueInfo(e,t){let i=t;return this.valueExpression&&(O(t)||O(t.arcade))&&(i=me(I({},i),{arcade:await cp()})),this._getUniqueValueInfo(e,i)}getSymbol(e,t){if(this.valueExpression&&(O(t)||O(t.arcade)))return void L0.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(e,t);return i&&i.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(O(i)||O(i.arcade))){const s=await cp(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=me(I({},i),{arcade:s})}const r=this._getUniqueValueInfo(e,i);return r&&r.symbol||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce((e,t)=>e+t.getMeshHash(),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new SE({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:se(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:se(this.visualVariables),legendOptions:se(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:se(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=se(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(se(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),pc(e,t,this.valueExpression)];wu(e,t,this.field),wu(e,t,this.field2),wu(e,t,this.field3),await Promise.all(i)}populateFromStyle(){return mFe(this.styleOrigin,{portal:this.portal}).then(e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const r=new W1({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=r,this._isDefaultSymbolDerived=!0);const s=new mD({value:i.name,symbol:r});t.push(s),this._valueInfoMap[i.name]=s}),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateValueInfoMap(){this._valueInfoMap={},this.uniqueValueInfos.forEach(e=>this._valueInfoMap[e.value+""]=e)}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=gt(t,{});let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(e){const t=this.field,i=e.attributes;let r;if(typeof t!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];t&&o.push(i[t]),s&&o.push(i[s]),n&&o.push(i[n]),r=o.join(this.fieldDelimiter||"")}else typeof t=="function"?r=t(e):t&&(r=i[t]);return this._valueInfoMap[r+""]}static fromPortalStyle(e,t){const i=new SE(t&&t.properties);i._set("styleOrigin",Object.freeze({styleName:e})),i._set("portal",t&&t.portal||gl.getDefault());const r=i.populateFromStyle();return r.catch(s=>{L0.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",s)}),r}static fromStyleUrl(e,t){const i=new SE(t&&t.properties);i._set("styleOrigin",Object.freeze({styleUrl:e}));const r=i.populateFromStyle();return r.catch(s=>{L0.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),r}};u([d({readOnly:!0})],Yr.prototype,"_cache",null),u([ht({uniqueValue:"unique-value"})],Yr.prototype,"type",void 0),u([d(Rde)],Yr.prototype,"backgroundFillSymbol",void 0),u([d({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],Yr.prototype,"field",void 0),u([It("field")],Yr.prototype,"castField",null),u([Ge("field")],Yr.prototype,"writeField",null),u([d({type:String,json:{write:!0}})],Yr.prototype,"field2",void 0),u([d({type:String,json:{write:!0}})],Yr.prototype,"field3",void 0),u([d({type:String,json:{write:!0}})],Yr.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Yr.prototype,"valueExpressionTitle",void 0),u([d({type:aj,json:{write:!0}})],Yr.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],Yr.prototype,"defaultLabel",void 0),u([d(use(I({},kR),{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],Yr.prototype,"defaultSymbol",null),u([d({type:String,json:{write:!0}})],Yr.prototype,"fieldDelimiter",void 0),u([d({type:gl,readOnly:!0})],Yr.prototype,"portal",void 0),u([Fe("portal",["styleName"])],Yr.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],Yr.prototype,"styleOrigin",void 0),u([Fe("styleOrigin",["styleName","styleUrl"])],Yr.prototype,"readStyleOrigin",null),u([Ge("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],Yr.prototype,"writeStyleOrigin",null),u([d({type:[mD],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Yr.prototype,"uniqueValueInfos",null),Yr=SE=u([P("esri.renderers.UniqueValueRenderer")],Yr);const pj=Yr,$de={key:"type",base:A0,typeMap:{heatmap:nFe,simple:dj,"unique-value":pj,"class-breaks":Mde,"dot-density":sFe,dictionary:eFe},errorContext:"renderer"},vFe={key:"type",base:A0,typeMap:{simple:dj,"unique-value":pj,"class-breaks":Mde},errorContext:"renderer"},_Fe=ZT({types:$de});function bFe(e,t,i){return e?e&&(e.styleName||e.styleUrl)&&e.type!=="uniqueValue"?(i&&i.messages&&i.messages.push(new uc("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+e.type+"'",{definition:e,context:i})),null):_Fe(e,t,i):null}class fj{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(Xk),this._values=new Map,this.multipleOriginsSupported=!0}clone(t){const i=new fj,r=this._originStores[oi.DEFAULTS];r&&r.forEach((s,n)=>{i.set(n,se(s),oi.DEFAULTS)});for(let s=oi.SERVICE;s<Xk;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{t&&t.has(a)||i.set(a,se(o),s)})}return i}get(t,i){const r=i===void 0?this._values:this._originStores[i];return r?r.get(t):void 0}keys(t){const i=t==null?this._values:this._originStores[t];return i?[...i.keys()]:[]}set(t,i,r=oi.USER){let s=this._originStores[r];if(s||(s=new Map,this._originStores[r]=s),s.set(t,i),!this._values.has(t)||this._propertyOriginMap.get(t)<=r){const n=this._values.get(t);return this._values.set(t,i),this._propertyOriginMap.set(t,r),n!==i}return!1}delete(t,i=oi.USER){const r=this._originStores[i];if(!r)return;const s=r.get(t);if(r.delete(t),this._values.has(t)&&this._propertyOriginMap.get(t)===i){this._values.delete(t);for(let n=i-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(t)){this._values.set(t,o.get(t)),this._propertyOriginMap.set(t,n);break}}}return s}has(t,i){const r=i===void 0?this._values:this._originStores[i];return!!r&&r.has(t)}revert(t,i){for(;i>0&&!this.has(t,i);)--i;const r=this._originStores[i],s=r&&r.get(t),n=this._values.get(t);return this._values.set(t,s),this._propertyOriginMap.set(t,i),n!==s}originOf(t){return this._propertyOriginMap.get(t)||oi.DEFAULTS}forEach(t){this._values.forEach(t)}}const Dde=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ta(this),s=r.store,n=new fj;r.store=n,ene(r,s,n)}read(i,r){ine(this,i,r)}getAtOrigin(i,r){const s=p5(this),n=wy(r);if(typeof i=="string")return s.get(i,n);const o={};return i.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(i){return a$(this.originIdOf(i))}originIdOf(i){return p5(this).originOf(i)}revert(i,r){const s=p5(this),n=wy(r),o=Ta(this);let a;a=typeof i=="string"?i==="*"?s.keys(n):[i]:i,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return t=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],t),t};function p5(e){return Ta(e).store}let YZ=class extends Dde(we){};YZ=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],YZ);const wFe=e=>{let t=class extends e{constructor(...i){super(...i)}clear(i,r="user"){return f5(this).delete(i,wy(r))}write(i={},r){return sne(this,i=i||{},r),i}setAtOrigin(i,r,s){Ta(this).setAtOrigin(i,r,wy(s))}removeOrigin(i){const r=f5(this),s=wy(i),n=r.keys(s);for(const o of n)r.originOf(o)===s&&r.set(o,r.get(o,s),oi.USER)}updateOrigin(i,r){const s=f5(this),n=wy(r),o=this.get(i);for(let a=n+1;a<Xk;++a)s.delete(i,a);s.set(i,o,n)}toJSON(i){return this.write({},i)}};return t=u([P("esri.core.WriteableMultiOriginJSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function f5(e){return Ta(e).store}const Lde=e=>{let t=class extends wFe(Dde(e)){constructor(...i){super(...i)}};return t=u([P("esri.core.MultiOriginJSONSupport")],t),t};let ZZ=class extends Lde(we){};ZZ=u([P("esri.core.MultiOriginJSONSupport")],ZZ);async function xFe(e,t){const{WhereClause:i}=await import("./WhereClause.184162be.js");return i.create(e,t)}var AV;let Fv=AV=class extends ve{constructor(e){super(e),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new AV({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Fv.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],Fv.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],Fv.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],Fv.prototype,"title",void 0),Fv=AV=u([P("esri.form.ExpressionInfo")],Fv);const TFe=Fv;let Uv=class extends ve{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],Uv.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Uv.prototype,"label",void 0),u([d()],Uv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Uv.prototype,"visibilityExpression",void 0),Uv=u([P("esri.form.elements.Element")],Uv);const xT=Uv;var CV;let iI=CV=class extends ve{constructor(e){super(e),this.type=null}clone(){return new CV({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],iI.prototype,"type",void 0),iI=CV=u([P("esri.form.elements.inputs.AttachmentInput")],iI);const SFe=iI;var RV;let kv=RV=class extends xT{constructor(e){super(e),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new RV({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],kv.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],kv.prototype,"editable",void 0),u([d({type:SFe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],kv.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],kv.prototype,"type",void 0),kv=RV=u([P("esri.form.elements.AttachmentElement")],kv);const QZ=kv;let rI=class extends ve{constructor(e){super(e),this.type=null}};u([d()],rI.prototype,"type",void 0),rI=u([P("esri.form.elements.inputs.Input")],rI);const yS=rI;let EE=class extends yS{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],EE.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],EE.prototype,"minLength",void 0),EE=u([P("esri.form.elements.inputs.TextInput")],EE);const mj=EE;var OV;let sI=OV=class extends mj{constructor(e){super(e),this.type="barcode-scanner"}clone(){return new OV({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],sI.prototype,"type",void 0),sI=OV=u([P("esri.form.elements.inputs.BarcodeScannerInput")],sI);const EFe=sI;var MV;let _w=MV=class extends yS{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="combo-box"}clone(){return new MV({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],_w.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],_w.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],_w.prototype,"type",void 0),_w=MV=u([P("esri.form.elements.inputs.ComboBoxInput")],_w);const AFe=_w;var PV;function JZ(e){return e!=null?new Date(e):null}function KZ(e){return e?e.getTime():null}let nh=PV=class extends yS{constructor(e){super(e),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(e,t){return JZ(t.max)}writeMax(e,t){t.max=KZ(e)}readMin(e,t){return JZ(t.min)}writeMin(e,t){t.min=KZ(e)}clone(){return new PV({includeTime:this.includeTime,max:this.max,min:this.min,type:this.type})}};u([d({type:Boolean,json:{write:!0}})],nh.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],nh.prototype,"max",void 0),u([Fe("max")],nh.prototype,"readMax",null),u([Ge("max")],nh.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],nh.prototype,"min",void 0),u([Fe("min")],nh.prototype,"readMin",null),u([Ge("min")],nh.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],nh.prototype,"type",void 0),nh=PV=u([P("esri.form.elements.inputs.DateTimePickerInput")],nh);const CFe=nh;var IV;let bw=IV=class extends yS{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="radio-buttons"}clone(){return new IV({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],bw.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],bw.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],bw.prototype,"type",void 0),bw=IV=u([P("esri.form.elements.inputs.RadioButtonsInput")],bw);const RFe=bw;var $V;let ww=$V=class extends yS{constructor(e){super(e),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new $V({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],ww.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],ww.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],ww.prototype,"type",void 0),ww=$V=u([P("esri.form.elements.inputs.SwitchInput")],ww);const OFe=ww;var DV;let nI=DV=class extends mj{constructor(e){super(e),this.type="text-area"}clone(){return new DV({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],nI.prototype,"type",void 0),nI=DV=u([P("esri.form.elements.inputs.TextAreaInput")],nI);const MFe=nI;var LV;let oI=LV=class extends mj{constructor(e){super(e),this.type="text-box"}clone(){return new LV({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],oI.prototype,"type",void 0),oI=LV=u([P("esri.form.elements.inputs.TextBoxInput")],oI);const PFe=oI,IFe={base:yS,key:"type",typeMap:{"barcode-scanner":EFe,"combo-box":AFe,"datetime-picker":CFe,"radio-buttons":RFe,switch:OFe,"text-area":MFe,"text-box":PFe}};var NV;let Vc=NV=class extends xT{constructor(e){super(e),this.domain=null,this.editable=!0,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}clone(){return new NV({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:Iue,json:{read:{reader:N7},write:!0}})],Vc.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Vc.prototype,"editable",void 0),u([d({type:String,json:{write:!0}})],Vc.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],Vc.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],Vc.prototype,"hint",void 0),u([d({types:IFe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],Vc.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],Vc.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],Vc.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Vc.prototype,"valueExpression",void 0),Vc=NV=u([P("esri.form.elements.FieldElement")],Vc);const eQ=Vc;var FV;let ff=FV=class extends xT{constructor(e){super(e),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new FV({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:se(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],ff.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],ff.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],ff.prototype,"editable",void 0),u([d({type:[moe],json:{write:!0}})],ff.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],ff.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],ff.prototype,"type",void 0),ff=FV=u([P("esri.form.elements.RelationshipElement")],ff);const tQ=ff;function Nde(e){return{typesWithGroup:{base:xT,key:"type",typeMap:{attachment:QZ,field:eQ,group:e,relationship:tQ}},typesWithoutGroup:{base:xT,key:"type",typeMap:{attachment:QZ,field:eQ,relationship:tQ}}}}function Fde(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>r[s.type].fromJSON(s))}function Ude(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>s.toJSON())}function kde(e,t,i=!0){return e?e.map(r=>Fh(i?t.typesWithGroup:t.typesWithoutGroup,r)):null}var UV;let Bd=UV=class extends xT{constructor(e){super(e),this.elements=null,this.initialState="expanded",this.type="group"}castElements(e){return kde(e,m5,!1)}readElements(e,t){return Fde(t.formElements,m5,!1)}writeElements(e,t){t.formElements=Ude(e,m5,!1)}clone(){return new UV({description:this.description,elements:se(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Bd.prototype,"elements",void 0),u([It("elements")],Bd.prototype,"castElements",null),u([Fe("elements",["formElements"])],Bd.prototype,"readElements",null),u([Ge("elements")],Bd.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Bd.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Bd.prototype,"type",void 0),Bd=UV=u([P("esri.form.elements.GroupElement")],Bd);const m5=Nde(Bd),$Fe=Bd;var kV;const g5=Nde($Fe);let Rd=kV=class extends ve{constructor(e){super(e),this.description=null,this.elements=null,this.expressionInfos=null,this.title=null}castElements(e){return kde(e,g5)}readElements(e,t){return Fde(t.formElements,g5)}writeElements(e,t){t.formElements=Ude(e,g5)}clone(){return new kV({description:this.description,expressionInfos:se(this.expressionInfos),elements:se(this.elements),title:this.title})}};u([d({type:String,json:{write:!0}})],Rd.prototype,"description",void 0),u([d({json:{write:!0}})],Rd.prototype,"elements",void 0),u([It("elements")],Rd.prototype,"castElements",null),u([Fe("elements",["formElements"])],Rd.prototype,"readElements",null),u([Ge("elements")],Rd.prototype,"writeElements",null),u([d({type:[TFe],json:{write:!0}})],Rd.prototype,"expressionInfos",void 0),u([d({type:String,json:{write:!0}})],Rd.prototype,"title",void 0),Rd=kV=u([P("esri.form.FormTemplate")],Rd);const DFe=Rd;let LFe=0;const iQ=he.getLogger("esri.layers.Layer");let nn=class extends wr.EventedMixin(NL(mm)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new Zt(-180,-90,180,90,tt.WGS84),this.id=Date.now().toString(16)+"-layer-"+LFe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=tt.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const t=typeof e=="string"?{url:e}:e,i=await import("./arcgisLayers.8b904a2f.js");try{return await i.fromUrl(t)}catch(r){throw iQ.error("#fromArcGISServerUrl({ url: '"+t.url+"'})","Failed to create layer from arcgis server url",r),r}}static async fromPortalItem(e){const t="portalItem"in e?e:{portalItem:e},i=await import("./portalLayers.ab3d112b.js");try{return await i.fromItem(t)}catch(r){const s=t&&t.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||zi.portalUrl;throw iQ.error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",r),r}}initialize(){this.when().catch(e=>{var t,i;vr(e)||he.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${(t=this.title)!=null?t:"no title"}', id: '${(i=this.id)!=null?i:"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,t=this.parent;"layers"in t&&t.layers.includes(e)?t.layers.remove(e):"tables"in t&&t.tables.includes(e)?t.tables.remove(e):"baseLayers"in t&&t.baseLayers.includes(e)?t.baseLayers.remove(e):"baseLayers"in t&&t.referenceLayers.includes(e)&&t.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){const e=this.url;return e?Gn(e):null}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await Ci(e,{query:{f:"json"},responseType:"json"})).data;throw new Q("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],nn.prototype,"attributionDataUrl",void 0),u([d({type:Zt})],nn.prototype,"fullExtent",void 0),u([d({readOnly:!0})],nn.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],nn.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],nn.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],nn.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],nn.prototype,"opacity",void 0),u([d({clonable:!1})],nn.prototype,"parent",void 0),u([d({readOnly:!0})],nn.prototype,"parsedUrl",null),u([d({type:Boolean})],nn.prototype,"popupEnabled",void 0),u([d({type:Boolean})],nn.prototype,"attributionVisible",void 0),u([d({type:tt})],nn.prototype,"spatialReference",void 0),u([d({type:String})],nn.prototype,"title",void 0),u([d({type:String,readOnly:!0,json:{read:!1}})],nn.prototype,"type",void 0),u([d()],nn.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],nn.prototype,"visible",void 0),nn=u([P("esri.layers.Layer")],nn);const gj=nn;function rQ(e,t,i){if(e.hasM==null||e.hasZ)for(const r of t)for(const s of r)s.length>2&&(s[2]*=i)}function NFe(e,t,i){if(!e&&!t||!i)return;const r=lT(i);sQ(e,i,r),sQ(t,i,r)}function sQ(e,t,i){if(e)for(const r of e)FFe(r.geometry,t,i)}function FFe(e,t,i){if(O(e)||!e.spatialReference||bc(e.spatialReference,t))return;const r=lT(e.spatialReference)/i;if(r!==1){if("x"in e)e.z!=null&&(e.z*=r);else if("rings"in e)rQ(e,e.rings,r);else if("paths"in e)rQ(e,e.paths,r);else if("points"in e&&(e.hasM==null||e.hasZ))for(const s of e.points)s.length>2&&(s[2]*=r)}}let UFe=0;const y5=he.getLogger("esri.layers.graphics.sources.MemorySource");let kg=class extends mm.LoadableMixin(AR(Rm(pt))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const t=_(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)}destroy(){var e;(e=this._connection)==null||e.close(),this._connection=null}get workerGeometryType(){var e;const t=(e=this.layer)==null?void 0:e.geometryType;return t?this._geometryTypeRequiresClientGraphicMapping(t)?"polygon":t:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,t={}){await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);nD(e,this.layer.spatialReference,i);const r=Q1.fromJSON(i);if(!this._requiresClientGraphicMapping())return r;const s=this.layer.objectIdField;for(const n of r.features){const o=n.attributes[s],a=this._idToClientGraphic.get(o);a&&(n.geometry=a.geometry)}return r.geometryType=this.layer.geometryType,r}async queryFeaturesJSON(e,t={}){if(this._requiresClientGraphicMapping())throw new Q("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return nD(e,this.layer.spatialReference,i),i}queryFeatureCount(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t))}queryObjectIds(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t))}queryExtent(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t)).then(i=>({count:i.count,extent:Zt.fromJSON(i.extent)}))}querySnapping(e,t={}){return this.load(t).then(()=>this._connection.invoke("querySnapping",e,t))}async _applyEdits(e){if(!this._connection)throw new Q("feature-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField;let i=null;const r=[],s=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const n=c=>"objectId"in c&&c.objectId!=null?c.objectId:"attributes"in c&&c.attributes[t]!=null?c.attributes[t]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const c of e.deleteFeatures){const h=n(c);h!=null&&r.push(h)}const o=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const c of e.updateFeatures)if(s.push(this._serializeFeature(c)),o){const h=n(c);h!=null&&o.set(h,c)}}NFe(i?i.features:null,s,this.layer.spatialReference);const{fullExtent:a,featureEditResults:l}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:s,deletes:r});return this.fullExtent=a,i&&i.finish(l.uidToObjectId),this._updateClientGraphicIds(o,l),this._createEditsResult(l)}async _prepareClientMapping(e,t){if(this.layerOrSourceGeometryType!=="mesh"||O(e))return;const i=[];for(const{geometry:r}of e)!_(r)||r.type!=="mesh"||r.hasExtent||r.loaded||i.push(r.load({signal:t}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,t){if(this._idToClientGraphic){if(e)for(const i of t.updateResults){if(!i.success)continue;const r=e.get(i.objectId);r!=null&&this._addIdToClientGraphic(r)}for(const i of t.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const t=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new Q("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_prepareAddFeatures(e){const t=new Map,i=new Array(e.length);let r=null;for(let n=0;n<e.length;n++){const o=e[n],a=this._serializeFeature(o);!r&&_(o.geometry)&&(r=o.geometry.type),i[n]=a,t.set(`${a.uid}`,o)}const s=this;return{features:i,inferredGeometryType:r,finish(n){const o=s.sourceJSON.objectIdField;for(const a in n){const l=n[a],c=t.get(a);c&&(c.attributes||(c.attributes={}),l===-1?delete c.attributes[o]:c.attributes[o]=l,s._addIdToClientGraphic(c))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[t];i!=null&&this._idToClientGraphic.set(i,e)}get layerOrSourceGeometryType(){var e,t,i;return(e=(t=this.layer)==null?void 0:t.geometryType)!=null?e:(i=this.sourceJSON)==null?void 0:i.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:t}=e,i=this._geometryForSerialization(e),r=(UFe++).toString();return i?{uid:r,geometry:i.toJSON(),attributes:t}:{uid:r,attributes:t}}_geometryForSerialization(e){const{geometry:t}=e;return O(t)?null:this._geometryRequiresClientGraphicMapping(t)?t.extent?dc.fromExtent(t.extent):null:t}async _startWorker(e){this._connection=await $ae("MemorySourceWorker",{strategy:ue("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:i,objectIdField:r,hasM:s,hasZ:n,timeInfo:o}=this.layer,a=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const l=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",f=>{y5.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),f.preventDefault()}));const c={features:l.features,fields:t&&t.map(f=>f.toJSON()),geometryType:UW.toJSON(this.workerGeometryType),hasM:this.layerOrSourceGeometryType!=="mesh"&&s,hasZ:this.layerOrSourceGeometryType==="mesh"||n,objectIdField:r,spatialReference:a?null:i&&i.toJSON(),timeInfo:o?o.toJSON():null},h=await this._connection.invoke("load",c,{signal:e});for(const f of h.warnings)y5.warn(f.message,{layer:this.layer,warning:f});h.featureErrors.length&&y5.warn(`Encountered ${h.featureErrors.length} validation errors while loading features`,h.featureErrors);const p=h.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(l.inferredGeometryType)&&(p.geometryType=UW.toJSON(l.inferredGeometryType)),this.sourceJSON=p,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),l.finish(h.assignedObjectIds)}};u([fG({Type:Bo,ensureType:ns(Bo)})],kg.prototype,"itemType",void 0),u([d()],kg.prototype,"type",void 0),u([d({constructOnly:!0})],kg.prototype,"layer",void 0),u([d({readOnly:!0})],kg.prototype,"workerGeometryType",null),u([d()],kg.prototype,"sourceJSON",void 0),kg=u([P("esri.layers.graphics.sources.MemorySource")],kg);const nQ=kg;function kFe(e){return"portalItem"in e}const zFe=e=>{let t=class extends e{get apiKey(){var i;return this._isOverridden("apiKey")?this._get("apiKey"):kFe(this)?(i=this.portalItem)==null?void 0:i.apiKey:null}set apiKey(i){i!=null?this._override("apiKey",i):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],t.prototype,"apiKey",null),t=u([P("esri.layers.mixins.APIKeyMixin")],t),t},zde={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},Bde=Object.values(zde),Vde=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${Bde.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),BFe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${Bde.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),VFe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function Kdt(e){return!!Vde.test(e)}function zR(e){const t=Gn(e),i=t.path.match(Vde)||t.path.match(BFe);if(!i)return null;const[,r,s,n,o]=i,a=s.indexOf("/");return{title:yj(a!==-1?s.slice(a+1):s),serverType:zde[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:r}}}function GFe(e){const t=Gn(e).path.match(VFe);return t?{serviceUrl:t[1],sublayerId:Number(t[2])}:null}function yj(e){return(e=e.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+e.slice(1)}function jFe(e,t){const i=[];if(e){const r=zR(e);_(r)&&r.title&&i.push(r.title)}if(t){const r=yj(t);i.push(r)}if(i.length===2){if(i[0].toLowerCase().indexOf(i[1].toLowerCase())!==-1)return i[0];if(i[1].toLowerCase().indexOf(i[0].toLowerCase())!==-1)return i[1]}return i.join(" - ")}function Gde(e){if(!e)return!1;const t=".arcgis.com/",i="//services",r="//tiles",s="//features",n=(e=e.toLowerCase()).indexOf(t)!==-1,o=e.indexOf(i)!==-1||e.indexOf(r)!==-1||e.indexOf(s)!==-1;return n&&o}function HFe(e,t){return e&&Woe(Xoe(e,t))}function qFe(e){let{url:t}=e;if(!t)return{url:t};t=Xoe(t,e.logger);const i=Gn(t),r=zR(i.path);let s;if(_(r))r.sublayer!=null&&e.layer.layerId==null&&(s=r.sublayer),t=r.url.path;else if(e.nonStandardUrlAllowed){const n=GFe(i.path);_(n)&&(t=n.serviceUrl,s=n.sublayerId)}return{url:Woe(t),layerId:s}}function WFe(e,t,i,r,s){s0(t,r,"url",s),r.url&&e.layerId!=null&&(r.url=r0(r.url,i,e.layerId.toString()))}function ept(e){if(!e)return!1;const t=e.toLowerCase(),i=t.indexOf("/services/")!==-1,r=t.indexOf("/mapserver/wmsserver")!==-1,s=t.indexOf("/imageserver/wmsserver")!==-1,n=t.indexOf("/wmsserver")!==-1;return i&&(r||s||n)}const XFe=e=>{let t=class extends e{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const i=zR(this.url);if(_(i)&&i.title)return i.title}return this._get("title")||""}set title(i){this._set("title",i)}set url(i){this._set("url",HFe(i,he.getLogger(this.declaredClass)))}};return u([d()],t.prototype,"title",null),u([d({type:String})],t.prototype,"url",null),t=u([P("esri.layers.mixins.ArcGISService")],t),t};function BR(){const e=new Float32Array(16);return e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function YFe(e){const t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ZFe(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v){const b=new Float32Array(16);return b[0]=e,b[1]=t,b[2]=i,b[3]=r,b[4]=s,b[5]=n,b[6]=o,b[7]=a,b[8]=l,b[9]=c,b[10]=h,b[11]=p,b[12]=f,b[13]=g,b[14]=y,b[15]=v,b}function QFe(e,t){return new Float32Array(e,t,16)}const JFe=BR();Object.freeze({__proto__:null,create:BR,clone:YFe,fromValues:ZFe,createView:QFe,IDENTITY:JFe});const KFe=(e,t)=>{const i=Ep(e,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1);return Ea(i,i)},e4e=(e,t)=>{const i=Ep(e,t,0,0,.5-.5*t,0,t,0,.5-.5*t,0,0,t,.5-.5*t,0,0,0,1);return Ea(i,i)},t4e=(e,t)=>{const i=1-t,r=Ep(e,.2126+.7874*i,.7152-.7152*i,.0722-.0722*i,0,.2126-.2126*i,.7152+.2848*i,.0722-.0722*i,0,.2126-.2126*i,.7152-.7152*i,.0722+.9278*i,0,0,0,0,1);return Ea(r,r)},i4e=(e,t)=>{const i=Math.sin(t*Math.PI/180),r=Math.cos(t*Math.PI/180),s=Ep(e,.213+.787*r-.213*i,.715-.715*r-.715*i,.072-.072*r+.928*i,0,.213-.213*r+.143*i,.715+.285*r+.14*i,.072-.072*r-.283*i,0,.213-.213*r-.787*i,.715-.715*r+.715*i,.072+.928*r+.072*i,0,0,0,0,1);return Ea(s,s)},r4e=(e,t)=>{const i=1-2*t,r=Ep(e,i,0,0,t,0,i,0,t,0,0,i,t,0,0,0,1);return Ea(r,r)},s4e=(e,t)=>{const i=Ep(e,.213+.787*t,.715-.715*t,.072-.072*t,0,.213-.213*t,.715+.285*t,.072-.072*t,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,1);return Ea(i,i)},n4e=(e,t)=>{const i=1-t,r=Ep(e,.393+.607*i,.769-.769*i,.189-.189*i,0,.349-.349*i,.686+.314*i,.168-.168*i,0,.272-.272*i,.534-.534*i,.131+.869*i,0,0,0,0,1);return Ea(r,r)};class MN{constructor(t,i,r){this.strength=t,this.radius=i,this.threshold=r,this.type="bloom"}interpolate(t,i,r){this.strength=Ya(t.strength,i.strength,r),this.radius=Ya(t.radius,i.radius,r),this.threshold=Ya(t.threshold,i.threshold,r)}clone(){return new MN(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:xA(this.radius),strength:this.strength,threshold:this.threshold}}}class PN{constructor(t){this.radius=t,this.type="blur"}interpolate(t,i,r){this.radius=Math.round(Ya(t.radius,i.radius,r))}clone(){return new PN(this.radius)}toJSON(){return{type:"blur",radius:xA(this.radius)}}}class vC{constructor(t,i){this.type=t,this.amount=i,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.amount=Ya(t.amount,i.amount,r),this._updateMatrix()}clone(){return new vC(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const t=this._colorMatrix||BR();switch(this.type){case"brightness":this._colorMatrix=KFe(t,this.amount);break;case"contrast":this._colorMatrix=e4e(t,this.amount);break;case"grayscale":this._colorMatrix=t4e(t,this.amount);break;case"invert":this._colorMatrix=r4e(t,this.amount);break;case"saturate":this._colorMatrix=s4e(t,this.amount);break;case"sepia":this._colorMatrix=n4e(t,this.amount)}}}class IN{constructor(t,i,r,s){this.offsetX=t,this.offsetY=i,this.blurRadius=r,this.color=s,this.type="drop-shadow"}interpolate(t,i,r){this.offsetX=Ya(t.offsetX,i.offsetX,r),this.offsetY=Ya(t.offsetY,i.offsetY,r),this.blurRadius=Ya(t.blurRadius,i.blurRadius,r),this.color[0]=Math.round(Ya(t.color[0],i.color[0],r)),this.color[1]=Math.round(Ya(t.color[1],i.color[1],r)),this.color[2]=Math.round(Ya(t.color[2],i.color[2],r)),this.color[3]=Ya(t.color[3],i.color[3],r)}clone(){return new IN(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const t=[...this.color];return t[3]*=255,{type:"drop-shadow",xoffset:xA(this.offsetX),yoffset:xA(this.offsetY),blurRadius:xA(this.blurRadius),color:t}}}class $N{constructor(t){this.angle=t,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.angle=Ya(t.angle,i.angle,r),this._updateMatrix()}clone(){return new $N(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const t=this._colorMatrix||BR();this._colorMatrix=i4e(t,this.angle)}}class DN{constructor(t){this.amount=t,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(t,i,r){this.amount=Ya(t.amount,i.amount,r)}clone(){return new DN(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}}function Ya(e,t,i){return e+(t-e)*i}function xA(e){return Math.round(1e3*kh(e))/1e3}function o4e(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new vC(e.type,0);case"saturate":case"brightness":case"contrast":return new vC(e.type,1);case"opacity":return new DN(1);case"hue-rotate":return new $N(0);case"blur":return new PN(0);case"drop-shadow":return new IN(0,0,0,[...wG("transparent")]);case"bloom":return new MN(0,0,1)}}var tpt=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function ipt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function rpt(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function a4e(e,t){const i=e.length>t.length?e:t;return(e.length>t.length?t:e).every((r,s)=>r.type===i[s].type)}function l4e(e,t){const i=e.length>t.length?e:t,r=e.length>t.length?t:e;for(let s=r.length;s<i.length;s++)r.push(o4e(i[s]))}function c4e(e){const t=e[0];return!!t&&"type"in t}var oQ,aQ,jde={exports:{}};function Hde(e){if(!e||e.length===0)return null;if(typeof e=="string"){const i=lQ(e);return i&&i.length!==0?i:null}const t=e.map(i=>{if(!Number.isFinite(i.scale)||i.scale<=0)throw new Q("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});return{scale:i.scale,effects:lQ(i.value)}});t.sort((i,r)=>r.effects.length-i.effects.length);for(let i=0;i<t.length-1;i++){if(!a4e(t[i].effects,t[i+1].effects))throw new Q("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[i].effects,b:t[i+1].effects});l4e(t[i].effects,t[i+1].effects)}return t.sort((i,r)=>r.scale-i.scale),t}function lQ(e){let t;if(!e)return[];try{t=jde.exports.parse(e)}catch(i){throw new Q("effect:invalid-syntax","Invalid effect syntax",{value:e,error:i})}return t.map(i=>u4e(i))}function u4e(e){try{switch(e.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return h4e(e);case"opacity":return d4e(e);case"hue-rotate":return p4e(e);case"blur":return f4e(e);case"drop-shadow":return m4e(e);case"bloom":return g4e(e)}}catch(t){throw t.details.filter=e,t}throw new Q("effect:unknown-effect",`Effect '${e.name}' is not supported`,{effect:e})}function h4e(e){let t=1;return vS(e.parameters,1),e.parameters.length===1&&(t=vh(e.parameters[0])),new vC(e.name,t)}function d4e(e){let t=1;return vS(e.parameters,1),e.parameters.length===1&&(t=vh(e.parameters[0])),new DN(t)}function p4e(e){let t=0;return vS(e.parameters,1),e.parameters.length===1&&(t=x4e(e.parameters[0])),new $N(t)}function f4e(e){let t=0;return vS(e.parameters,1),e.parameters.length===1&&(t=bj(e.parameters[0]),VR(t,e.parameters[0])),new PN(t)}function m4e(e){const t=[];let i=null;for(const r of e.parameters)if(r.type==="color"){if(t.length&&Object.freeze(t),i)throw new Q("effect:type-error","Accepts only one color",{});i=T4e(r)}else{const s=bj(r);if(Object.isFrozen(t))throw new Q("effect:type-error","<length> parameters not consecutive",{lengths:t});t.push(s),t.length===3&&VR(s,r)}if(t.length<2||t.length>3)throw new Q("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${t.length}}`,{lengths:t});return new IN(t[0],t[1],t[2]||0,i||qde("black"))}function g4e(e){let t=1,i=0,r=0;return vS(e.parameters,3),e.parameters[0]&&(t=vh(e.parameters[0])),e.parameters[1]&&(i=bj(e.parameters[1]),VR(i,e.parameters[1])),e.parameters[2]&&(r=vh(e.parameters[2])),new MN(t,i,r)}function vS(e,t){if(e.length>t)throw new Q("effect:type-error",`Function supports up to ${t} parameters, Actual: ${e.length}`,{parameters:e})}function LN(e){if(e.type==="color")return"<color>";if(e.unit){if(_j[e.unit])return"<length>";if(vj[e.unit])return"<angle>";if(e.unit==="%")return"<percentage>"}return"<double>"}function VR(e,t){if(e<0)throw new Q("effect:type-error",`Negative values are not allowed, Actual: ${e}`,{term:t})}function y4e(e){if(e.type!=="quantity"||e.unit!==null)throw new Q("effect:type-error",`Expected <double>, Actual: ${LN(e)}`,{term:e})}function v4e(e){if(e.type!=="quantity"||e.unit!==null&&e.unit!=="%")throw new Q("effect:type-error",`Expected <double> or <percentage>, Actual: ${LN(e)}`,{term:e})}aQ=function(){function e(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function t(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,t.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function i(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function r(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:Wq},h=Wq,p="none",f=")",g=",",y="(",v="%",b="px",w="cm",S="mm",T="in",A="pt",C="pc",R="deg",L="rad",U="grad",N="turn",z="#",V=".",B="e",J=/^[ \t\n\r]/,Z=/^[a-z\-]/,te=/^[0-9a-fA-F]/,ie=/^[+\-]/,$=/^[0-9]/,F=Dp("none"),k=_n("none",!1),G=_n(")",!1),q=_n(",",!1),K=Dp("whitespace"),H=CS([" ","	",`
`,"\r"],!1,!1),ee=Dp("function"),ge=_n("(",!1),Ae=Dp("identifier"),Be=CS([["a","z"],"-"],!1,!1),Se=Dp("percentage"),xe=_n("%",!1),Re=Dp("length"),ke=_n("px",!1),Gi=_n("cm",!1),Hr=_n("mm",!1),Cs=_n("in",!1),Rs=_n("pt",!1),cs=_n("pc",!1),Os=Dp("angle"),nb=_n("deg",!1),t4=_n("rad",!1),Mt=_n("grad",!1),dO=_n("turn",!1),Qh=Dp("number"),ES=Dp("color"),AS=_n("#",!1),Gq=CS([["0","9"],["a","f"],["A","F"]],!1,!1),jq=CS(["+","-"],!1,!1),Vm=CS([["0","9"]],!1,!1),H_e=_n(".",!1),q_e=_n("e",!1),W_e=function(){return[]},X_e=function(W,fe){return{type:"function",name:W,parameters:fe||[]}},Y_e=function(W,fe){return fe.length>0?R1e(W,fe,3):[W]},Z_e=function(W){return{type:"quantity",value:W.value,unit:W.unit}},Q_e=function(W){return{type:"color",colorType:W.type,value:W.value}},J_e=function(W){return W},K_e=function(){return fO()},e1e=function(W){return{value:W,unit:"%"}},t1e=function(W){return{value:W,unit:"px"}},i1e=function(W){return{value:W,unit:"cm"}},r1e=function(W){return{value:W,unit:"mm"}},s1e=function(W){return{value:W,unit:"in"}},n1e=function(W){return{value:W,unit:"pt"}},o1e=function(W){return{value:W,unit:"pc"}},a1e=function(W){return{value:W,unit:"deg"}},l1e=function(W){return{value:W,unit:"rad"}},c1e=function(W){return{value:W,unit:"grad"}},u1e=function(W){return{value:W,unit:"turn"}},h1e=function(W){return{value:W,unit:null}},d1e=function(){return{type:"hex",value:fO()}},p1e=function(W){return{type:"function",value:W}},f1e=function(){return{type:"named",value:fO()}},m1e=function(){return parseFloat(fO())},ce=0,Fr=0,pO=[{line:1,column:1}],Jh=0,i4=[],ct=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function fO(){return s.substring(Fr,ce)}function _n(W,fe){return{type:"literal",text:W,ignoreCase:fe}}function CS(W,fe,Ce){return{type:"class",parts:W,inverted:fe,ignoreCase:Ce}}function g1e(){return{type:"end"}}function Dp(W){return{type:"other",description:W}}function Hq(W){var fe,Ce=pO[W];if(Ce)return Ce;for(fe=W-1;!pO[fe];)fe--;for(Ce={line:(Ce=pO[fe]).line,column:Ce.column};fe<W;)s.charCodeAt(fe)===10?(Ce.line++,Ce.column=1):Ce.column++,fe++;return pO[W]=Ce,Ce}function qq(W,fe){var Ce=Hq(W),Qt=Hq(fe);return{source:l,start:{offset:W,line:Ce.line,column:Ce.column},end:{offset:fe,line:Qt.line,column:Qt.column}}}function Ut(W){ce<Jh||(ce>Jh&&(Jh=ce,i4=[]),i4.push(W))}function y1e(W,fe,Ce){return new t(t.buildMessage(W,fe),W,fe,Ce)}function Wq(){var W;return(W=v1e())===a&&(W=_1e()),W}function v1e(){var W,fe;return ct++,W=ce,bn(),s.substr(ce,4)===p?(fe=p,ce+=4):(fe=a,ct===0&&Ut(k)),fe!==a?(bn(),Fr=W,W=W_e()):(ce=W,W=a),ct--,W===a&&ct===0&&Ut(F),W}function _1e(){var W,fe;if(W=[],(fe=r4())!==a)for(;fe!==a;)W.push(fe),fe=r4();else W=a;return W}function r4(){var W,fe,Ce,Qt;return W=ce,bn(),(fe=w1e())!==a?(bn(),(Ce=b1e())===a&&(Ce=null),bn(),s.charCodeAt(ce)===41?(Qt=f,ce++):(Qt=a,ct===0&&Ut(G)),Qt!==a?(bn(),Fr=W,W=X_e(fe,Ce)):(ce=W,W=a)):(ce=W,W=a),W}function b1e(){var W,fe,Ce,Qt,Hn,qr,Sc,mO;if(W=ce,(fe=s4())!==a){for(Ce=[],Qt=ce,Hn=bn(),s.charCodeAt(ce)===44?(qr=g,ce++):(qr=a,ct===0&&Ut(q)),qr===a&&(qr=null),Sc=bn(),(mO=s4())!==a?Qt=Hn=[Hn,qr,Sc,mO]:(ce=Qt,Qt=a);Qt!==a;)Ce.push(Qt),Qt=ce,Hn=bn(),s.charCodeAt(ce)===44?(qr=g,ce++):(qr=a,ct===0&&Ut(q)),qr===a&&(qr=null),Sc=bn(),(mO=s4())!==a?Qt=Hn=[Hn,qr,Sc,mO]:(ce=Qt,Qt=a);Fr=W,W=Y_e(fe,Ce)}else ce=W,W=a;return W}function s4(){var W,fe;return W=ce,(fe=x1e())===a&&(fe=T1e())===a&&(fe=S1e())===a&&(fe=E1e()),fe!==a&&(Fr=W,fe=Z_e(fe)),(W=fe)===a&&(W=ce,(fe=A1e())!==a&&(Fr=W,fe=Q_e(fe)),W=fe),W}function bn(){var W,fe;for(ct++,W=[],J.test(s.charAt(ce))?(fe=s.charAt(ce),ce++):(fe=a,ct===0&&Ut(H));fe!==a;)W.push(fe),J.test(s.charAt(ce))?(fe=s.charAt(ce),ce++):(fe=a,ct===0&&Ut(H));return ct--,fe=a,ct===0&&Ut(K),W}function w1e(){var W,fe,Ce;return ct++,W=ce,(fe=Xq())!==a?(s.charCodeAt(ce)===40?(Ce=y,ce++):(Ce=a,ct===0&&Ut(ge)),Ce!==a?(Fr=W,W=J_e(fe)):(ce=W,W=a)):(ce=W,W=a),ct--,W===a&&(fe=a,ct===0&&Ut(ee)),W}function Xq(){var W,fe,Ce;if(ct++,W=ce,fe=[],Z.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,ct===0&&Ut(Be)),Ce!==a)for(;Ce!==a;)fe.push(Ce),Z.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,ct===0&&Ut(Be));else fe=a;return fe!==a&&(Fr=W,fe=K_e()),ct--,(W=fe)===a&&(fe=a,ct===0&&Ut(Ae)),W}function x1e(){var W,fe,Ce;return ct++,W=ce,bn(),(fe=Tc())!==a?(s.charCodeAt(ce)===37?(Ce=v,ce++):(Ce=a,ct===0&&Ut(xe)),Ce!==a?(Fr=W,W=e1e(fe)):(ce=W,W=a)):(ce=W,W=a),ct--,W===a&&ct===0&&Ut(Se),W}function T1e(){var W,fe,Ce;return ct++,W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===b?(Ce=b,ce+=2):(Ce=a,ct===0&&Ut(ke)),Ce!==a?(Fr=W,W=t1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===w?(Ce=w,ce+=2):(Ce=a,ct===0&&Ut(Gi)),Ce!==a?(Fr=W,W=i1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===S?(Ce=S,ce+=2):(Ce=a,ct===0&&Ut(Hr)),Ce!==a?(Fr=W,W=r1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===T?(Ce=T,ce+=2):(Ce=a,ct===0&&Ut(Cs)),Ce!==a?(Fr=W,W=s1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===A?(Ce=A,ce+=2):(Ce=a,ct===0&&Ut(Rs)),Ce!==a?(Fr=W,W=n1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,bn(),(fe=Tc())!==a?(s.substr(ce,2)===C?(Ce=C,ce+=2):(Ce=a,ct===0&&Ut(cs)),Ce!==a?(Fr=W,W=o1e(fe)):(ce=W,W=a)):(ce=W,W=a)))))),ct--,W===a&&ct===0&&Ut(Re),W}function S1e(){var W,fe,Ce;return ct++,W=ce,(fe=Tc())!==a?(s.substr(ce,3)===R?(Ce=R,ce+=3):(Ce=a,ct===0&&Ut(nb)),Ce!==a?(Fr=W,W=a1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,(fe=Tc())!==a?(s.substr(ce,3)===L?(Ce=L,ce+=3):(Ce=a,ct===0&&Ut(t4)),Ce!==a?(Fr=W,W=l1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,(fe=Tc())!==a?(s.substr(ce,4)===U?(Ce=U,ce+=4):(Ce=a,ct===0&&Ut(Mt)),Ce!==a?(Fr=W,W=c1e(fe)):(ce=W,W=a)):(ce=W,W=a),W===a&&(W=ce,(fe=Tc())!==a?(s.substr(ce,4)===N?(Ce=N,ce+=4):(Ce=a,ct===0&&Ut(dO)),Ce!==a?(Fr=W,W=u1e(fe)):(ce=W,W=a)):(ce=W,W=a)))),ct--,W===a&&(fe=a,ct===0&&Ut(Os)),W}function E1e(){var W,fe;return ct++,W=ce,bn(),(fe=Tc())!==a?(Fr=W,W=h1e(fe)):(ce=W,W=a),ct--,W===a&&ct===0&&Ut(Qh),W}function A1e(){var W,fe,Ce,Qt;if(ct++,W=ce,s.charCodeAt(ce)===35?(fe=z,ce++):(fe=a,ct===0&&Ut(AS)),fe!==a){if(Ce=[],te.test(s.charAt(ce))?(Qt=s.charAt(ce),ce++):(Qt=a,ct===0&&Ut(Gq)),Qt!==a)for(;Qt!==a;)Ce.push(Qt),te.test(s.charAt(ce))?(Qt=s.charAt(ce),ce++):(Qt=a,ct===0&&Ut(Gq));else Ce=a;Ce!==a?(Fr=W,W=d1e()):(ce=W,W=a)}else ce=W,W=a;return W===a&&(W=ce,(fe=r4())!==a&&(Fr=W,fe=p1e(fe)),(W=fe)===a&&(W=ce,(fe=Xq())!==a&&(Fr=W,fe=f1e()),W=fe)),ct--,W===a&&(fe=a,ct===0&&Ut(ES)),W}function Tc(){var W,fe,Ce,Qt,Hn,qr,Sc;for(W=ce,ie.test(s.charAt(ce))?(s.charAt(ce),ce++):ct===0&&Ut(jq),fe=ce,Ce=[],$.test(s.charAt(ce))?(Qt=s.charAt(ce),ce++):(Qt=a,ct===0&&Ut(Vm));Qt!==a;)Ce.push(Qt),$.test(s.charAt(ce))?(Qt=s.charAt(ce),ce++):(Qt=a,ct===0&&Ut(Vm));if(s.charCodeAt(ce)===46?(Qt=V,ce++):(Qt=a,ct===0&&Ut(H_e)),Qt!==a){if(Hn=[],$.test(s.charAt(ce))?(qr=s.charAt(ce),ce++):(qr=a,ct===0&&Ut(Vm)),qr!==a)for(;qr!==a;)Hn.push(qr),$.test(s.charAt(ce))?(qr=s.charAt(ce),ce++):(qr=a,ct===0&&Ut(Vm));else Hn=a;Hn!==a?fe=Ce=[Ce,Qt,Hn]:(ce=fe,fe=a)}else ce=fe,fe=a;if(fe===a)if(fe=[],$.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,ct===0&&Ut(Vm)),Ce!==a)for(;Ce!==a;)fe.push(Ce),$.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,ct===0&&Ut(Vm));else fe=a;if(fe!==a){if(Ce=ce,s.charCodeAt(ce)===101?(Qt=B,ce++):(Qt=a,ct===0&&Ut(q_e)),Qt!==a){if(ie.test(s.charAt(ce))?(Hn=s.charAt(ce),ce++):(Hn=a,ct===0&&Ut(jq)),Hn===a&&(Hn=null),qr=[],$.test(s.charAt(ce))?(Sc=s.charAt(ce),ce++):(Sc=a,ct===0&&Ut(Vm)),Sc!==a)for(;Sc!==a;)qr.push(Sc),$.test(s.charAt(ce))?(Sc=s.charAt(ce),ce++):(Sc=a,ct===0&&Ut(Vm));else qr=a;qr!==a?Ce=Qt=[Qt,Hn,qr]:(ce=Ce,Ce=a)}else ce=Ce,Ce=a;Ce===a&&(Ce=null),Fr=W,W=m1e()}else ce=W,W=a;return W}function C1e(W,fe){return W.map(function(Ce){return Ce[fe]})}function R1e(W,fe,Ce){return[W].concat(C1e(fe,Ce))}if((o=h())!==a&&ce===s.length)return o;throw o!==a&&ce<s.length&&Ut(g1e()),y1e(i4,Jh<s.length?s.charAt(Jh):null,Jh<s.length?qq(Jh,Jh+1):qq(Jh,Jh))}return e(t,Error),t.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=i("",l.line.toString().length),f=a[l.line-1],g=l.line===h.line?h.column:f.length+1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+i("",l.column-1)+i("",g-l.column,"^")}else n+=`
 at `+c}return n},t.buildMessage=function(s,n){var o={literal:function(g){return'"'+l(g.text)+'"'},class:function(g){var y=g.parts.map(function(v){return Array.isArray(v)?c(v[0])+"-"+c(v[1]):c(v)});return"["+(g.inverted?"^":"")+y+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function a(g){return g.charCodeAt(0).toString(16).toUpperCase()}function l(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(g){return o[g.type](g)}function p(g){var y,v,b=g.map(h);if(b.sort(),b.length>0){for(y=1,v=1;y<b.length;y++)b[y-1]!==b[y]&&(b[v]=b[y],v++);b.length=v}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function f(g){return g?'"'+l(g)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:t,parse:r}},(oQ=jde).exports&&(oQ.exports=aQ());const vj={deg:1,grad:.9,rad:180/Math.PI,turn:360};function _4e(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&vj[e.unit]!=null))throw new Q("effect:type-error",`Expected <angle>, Actual: ${LN(e)}`,{term:e})}const _j={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function b4e(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&_j[e.unit]!=null))throw new Q("effect:type-error",`Expected <length>, Actual: ${LN(e)}`,{term:e})}function vh(e){v4e(e);const t=e.value;return VR(t,e),e.unit==="%"?.01*t:t}function w4e(e){return y4e(e),VR(e.value,e),e.value}function x4e(e){return _4e(e),e.value*vj[e.unit]||0}function bj(e){return b4e(e),e.value*_j[e.unit]||0}function T4e(e){switch(e.colorType){case"hex":return rSe(e.value);case"named":return qde(e.value);case"function":return A4e(e.value)}}function qde(e){if(!voe(e))throw new Q("effect:unknown-color",`color '${e}' isn't valid`,{namedColor:e});return iSe(e)}const S4e=/^rgba?/i,E4e=/^hsla?/i;function A4e(e){if(vS(e.parameters,4),S4e.test(e.name))return[vh(e.parameters[0]),vh(e.parameters[1]),vh(e.parameters[2]),e.parameters[3]?vh(e.parameters[3]):1];if(E4e.test(e.name))return _oe(w4e(e.parameters[0]),vh(e.parameters[1]),vh(e.parameters[2]),e.parameters[3]?vh(e.parameters[3]):1);throw new Q("effect:syntax-error",`Invalid color function '${e.name}'`,{colorFunction:e})}function zV(e,t,i){try{return R4e(e)}catch(s){var r;i==null||(r=i.messages)==null||r.push(s)}return null}function BV(e,t,i,r){try{const s=C4e(e);cc(i,s,t)}catch(s){r.messages&&r.messages.push(s)}}function C4e(e){const t=Hde(e);return t?c4e(t)?t.map(i=>i.toJSON()):t.map(({scale:i,effects:r})=>({scale:i,value:r.map(s=>s.toJSON())})):null}function R4e(e){if(!e||e.length===0)return null;if(O4e(e)){const t=[];for(const i of e)t.push({scale:i.scale,value:cQ(i.value)});return t}return cQ(e)}function O4e(e){const t=e[0];return!!t&&"scale"in t}function cQ(e){if(!e||!e.length)return"";const t=[];for(const i of e){let r=[];switch(i.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":r=[Np(i,"amount")];break;case"blur":r=[Np(i,"radius","pt")];break;case"hue-rotate":r=[Np(i,"angle","deg")];break;case"drop-shadow":r=[Np(i,"xoffset","pt"),Np(i,"yoffset","pt"),Np(i,"blurRadius","pt"),M4e(i,"color")];break;case"bloom":r=[Np(i,"strength"),Np(i,"radius","pt"),Np(i,"threshold")]}const s=`${i.type}(${r.filter(Boolean).join(" ")})`;Hde(s),t.push(s)}return t.join(" ")}function Np(e,t,i){if(e[t]==null)throw new Q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});return i?e[t]+i:""+e[t]}function M4e(e,t){if(e[t]==null)throw new Q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});const i=e[t];return`rgba(${i[0]||0}, ${i[1]||0}, ${i[2]||0}, ${i[3]/255||0})`}const P4e=e=>{let t=class extends e{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0}}}})],t.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":{read:{reader:zV},write:{allowNull:!0,writer:BV}}}}})],t.prototype,"effect",void 0),t=u([P("esri.layers.mixins.BlendLayer")],t),t},I4e=e=>{let t=class extends e{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:i=>({enabled:!!(i&&Object.keys(i).length>0)})}}})],t.prototype,"customParameters",void 0),t=u([P("esri.layers.mixins.CustomParametersMixin")],t),t};var VV;const v5=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),_5=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Od=VV=class extends ve{constructor(e){super(e),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(e={}){const{where:t,geometry:i,spatialRelationship:r,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new pa(I({geometry:se(i),objectIds:se(n),spatialRelationship:r,timeExtent:se(s),where:t,units:o,distance:a},e))}clone(){const{where:e,geometry:t,spatialRelationship:i,timeExtent:r,objectIds:s,units:n,distance:o}=this;return new VV({geometry:se(t),objectIds:se(s),spatialRelationship:i,timeExtent:se(r),where:e,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],Od.prototype,"where",void 0),u([d({types:V1,json:{write:!0}})],Od.prototype,"geometry",void 0),u([d({type:v5.apiValues,json:{name:"spatialRel",read:{reader:v5.read},write:{allowNull:!1,writer:v5.write,overridePolicy(){return{enabled:_(this.geometry)}}}}})],Od.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],Od.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],Od.prototype,"objectIds",void 0),u([d({type:_5.apiValues,json:{read:_5.read,write:{writer:_5.write,overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],Od.prototype,"units",void 0),u([d({type:Ap,json:{write:!0}})],Od.prototype,"timeExtent",void 0),Od=VV=u([P("esri.layers.support.FeatureFilter")],Od);const $4e=Od;var GV;let zv=GV=class extends ve{constructor(e){super(e),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(e,t){const i=super.write(e,t);if(t!=null&&t.origin){if(i.filter){const n=Object.keys(i.filter);var r;if(n.length>1||n[0]!=="where")return(r=t.messages)==null||r.push(new Q("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:t.layer,effect:this})),null}var s;if("showExcludedLabels"in i)return(s=t.messages)==null||s.push(new Q("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:t.layer,effect:this})),null}return i}clone(){return new GV({filter:_(this.filter)&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:$4e,json:{write:{allowNull:!0,writer(e,t,i,r){const s=e==null?void 0:e.write({},r);s&&Object.keys(s).length!==0?cc(i,s,t):cc(i,null,t)}}}})],zv.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:zV},write:{writer:BV,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}}}}})],zv.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:zV},write:{writer:BV,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}}}}})],zv.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":{name:"showExcludedLabels",default:!0}}}})],zv.prototype,"excludedLabelsVisible",void 0),zv=GV=u([P("esri.layers.support.FeatureEffect")],zv);const D4e=zv,L4e=e=>{let t=class extends e{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:D4e,json:{origins:{"web-map":{write:{allowNull:!0}}}}})],t.prototype,"featureEffect",void 0),t=u([P("esri.layers.mixins.FeatureEffectLayer")],t),t},N4e={"web-scene/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,OGCFeatureLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0}};function F4e(e){if(!e)return e;const{start:t,end:i}=e;return new Ap({start:_(t)?W_(t,-t.getTimezoneOffset(),"minutes"):t,end:_(i)?W_(i,-i.getTimezoneOffset(),"minutes"):i})}function U4e(e){if(!e)return e;const{start:t,end:i}=e;return new Ap({start:_(t)?W_(t,t.getTimezoneOffset(),"minutes"):t,end:_(i)?W_(i,i.getTimezoneOffset(),"minutes"):i})}var jV;let AE=jV=class extends ve{async collectRequiredFields(e,t){return pc(e,t,this.expression)}clone(){return new jV({expression:this.expression,title:this.title})}};u([d({type:String,json:{write:!0}})],AE.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],AE.prototype,"title",void 0),AE=jV=u([P("esri.layers.support.FeatureExpressionInfo")],AE);const uQ=AE;function k4e(e){return wT[e]!=null}function z4e(e){return 1/(wT[e]||1)}function B4e(){const e=Object.keys(wT);return e.sort(),e}const V4e=B4e();var HV;const aM=po()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),hQ=new si({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let mf=HV=class extends ve{constructor(){super(...arguments),this.offset=null}readFeatureExpressionInfo(e,t){return e!=null?e:t.featureExpression&&t.featureExpression.value===0?{expression:"0"}:void 0}writeFeatureExpressionInfo(e,t,i,r){t[i]=e.write({},r),e.expression==="0"&&(t.featureExpression={value:0})}get mode(){const{offset:e,featureExpressionInfo:t}=this;return this._isOverridden("mode")?this._get("mode"):_(e)||t?"relative-to-ground":"on-the-ground"}set mode(e){this._override("mode",e)}set unit(e){this._set("unit",e)}write(e,t){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(e,t):null}clone(){return new HV({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}};u([d({type:uQ,json:{write:!0}})],mf.prototype,"featureExpressionInfo",void 0),u([Fe("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],mf.prototype,"readFeatureExpressionInfo",null),u([Ge("featureExpressionInfo",{featureExpressionInfo:{type:uQ},"featureExpression.value":{type:[0]}})],mf.prototype,"writeFeatureExpressionInfo",null),u([d({type:aM.apiValues,nonNullable:!0,json:{type:aM.jsonValues,read:aM.read,write:{writer:aM.write,isRequired:!0}}})],mf.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],mf.prototype,"offset",void 0),u([d({type:V4e,json:{type:String,read:hQ.read,write:hQ.write}})],mf.prototype,"unit",null),mf=HV=u([P("esri.layers.support.ElevationInfo")],mf);const G4e=mf,j4e={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},Wde={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(e,t)=>!t.disablePopup},write:{enabled:!0,writer(e,t,i){t[i]=!e}}}},Xde={type:Boolean,value:!0,json:{name:"showLabels",write:!0}},H4e={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:s0}}},q4e={type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},W4e={value:null,type:G4e,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function spt(e){return{type:e,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const aI={type:Number,json:{origins:{"web-document":{write:!0,read:!0},"portal-item":{write:!0}}}},X4e=me(I({},aI),{json:me(I({},aI.json),{origins:{"web-document":me(I({},aI.json.origins["web-document"]),{write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}})},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(e,t,i)=>i&&i.origin!=="service"||!t.drawingInfo||t.drawingInfo.transparency===void 0?t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.transparency!==void 0?rC(t.layerDefinition.drawingInfo.transparency):void 0:rC(t.drawingInfo.transparency)}})}),npt={type:Ap,readOnly:!0,get(){var e,t;if((e=this.layer)==null||!e.timeInfo)return null;const{datesInUnknownTimezone:i,timeOffset:r,useViewTime:s}=this.layer,n=(t=this.view)==null?void 0:t.timeExtent;let o=this.layer.timeExtent;i&&(o=U4e(o));let a=s?n&&o?n.intersection(o):n||o:o;if(!a||a.isEmpty||a.isAllTime)return a;r&&(a=a.offset(-r.value,r.unit)),i&&(a=F4e(a));const l=this._get("timeExtent");return a.equals(l)?l:a}},opt={type:Zt,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(e,t)=>{const i=Zt.fromJSON(e);return t.spatialReference!=null&&typeof t.spatialReference=="object"&&(i.spatialReference=tt.fromJSON(t.spatialReference)),i}}}},read:!1}},Y4e={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},Z4e={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},Q4e={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},J4e=e=>{let t=class extends e{constructor(){super(...arguments),this.title=null}writeListMode(i,r,s,n){(n&&n.layerContainerType==="ground"||i&&Rwe(this,s,{},n))&&(r[s]=i)}writeOperationalLayerType(i,r,s,n){!i||n&&n.layerContainerType==="tables"||(r.layerType=i)}writeTitle(i,r){r.title=i||"Layer"}read(i,r){r&&(r.layer=this),Swe(this,i,s=>super.read(i,s),r)}write(i,r){if(r!=null&&r.origin){const l=`${r.origin}/${r.layerContainerType||"operational-layers"}`,c=N4e[l];let h=c&&c[this.operationalLayerType];var s;if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),!h)return(s=r.messages)==null||s.push(new Q("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const n=super.write(i,me(I({},r),{layer:this})),o=!!r&&!!r.messages&&!!r.messages.filter(l=>l instanceof Q&&l.name==="web-document-write:property-required").length;var a;return oT(n==null?void 0:n.url)?(r==null||(a=r.messages)==null||a.push(new Q("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&o?null:n}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],t.prototype,"id",void 0),u([d({json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}})],t.prototype,"listMode",void 0),u([Ge("listMode")],t.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],t.prototype,"operationalLayerType",void 0),u([Ge("operationalLayerType")],t.prototype,"writeOperationalLayerType",null),u([d(aI)],t.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],t.prototype,"title",void 0),u([Ge("title")],t.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],t.prototype,"visible",void 0),t=u([P("esri.layers.mixins.OperationalLayer")],t),t};var qV;const b5=new si({asc:"ascending",desc:"descending"});let xw=qV=class extends ve{constructor(e){super(e),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new qV({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],xw.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],xw.prototype,"valueExpression",void 0),u([d({type:b5.apiValues,json:{read:b5.read,write:b5.write}})],xw.prototype,"order",void 0),xw=qV=u([P("esri.layers.support.OrderByInfo")],xw);const Yde=xw;function K4e(e,t,i){if(!e)return null;const r=e.find(n=>!!n.field);if(!r)return null;const s=new Yde;return s.read(r,i),[s]}function e5e(e,t,i,r){const s=e.find(n=>!!n.field);s&&cc(i,[s.toJSON()],t)}const t5e=e=>{let t=class extends e{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[Yde],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:K4e},write:{target:"layerDefinition.orderBy",writer:e5e}}})],t.prototype,"orderBy",void 0),t=u([P("esri.layers.mixins.OrderedLayer")],t),t},i5e=he.getLogger("esri.portal.PortalItemResource");let zg=class extends we{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?me(I({},e),{path:this._normalizePath(e.path,e.portalItem)}):e}set path(e){_(e)&&oc(e)?i5e.error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",t){const i=this.url;if(O(i))throw new Q("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal._request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:bs(t,"signal")})}async update(e,t){return(await import("./resourceUtils.46564902.js")).addOrUpdateResource(this,"update",e,t)}hasPath(){return _(this.path)}_normalizePath(e,t){return O(e)?e:(e=e.replace(/^\/+/,""),_(t)&&oc(e)&&(e=DG(e,t.itemUrl)),e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],zg.prototype,"portalItem",void 0),u([d({type:String,value:null})],zg.prototype,"path",null),u([It("path")],zg.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],zg.prototype,"url",null),u([d({type:String,readOnly:!0})],zg.prototype,"itemRelativeUrl",null),zg=u([P("esri.portal.PortalItemResource")],zg);const r5e=zg;let CE=class extends we{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],CE.prototype,"created",void 0),u([d()],CE.prototype,"rating",void 0),CE=u([P("esri.portal.PortalRating")],CE);const w5=CE;var Tw;let Yt=Tw=class extends bR(mm){constructor(e){super(e),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}static from(e){return Xx(Tw,e)}destroy(){this.portal=null}get displayName(){const e=this.type,t=this.typeKeywords||[];let i=e;return e==="Feature Service"||e==="Feature Collection"?i=t.indexOf("Table")>-1?"Table":t.indexOf("Route Layer")>-1?"Route Layer":t.indexOf("Markup")>-1?"Markup":"Feature Layer":e==="Image Service"?i=t.indexOf("Elevation 3D Layer")>-1?"Elevation Layer":t.indexOf("Tiled Imagery")>-1?"Tiled Imagery Layer":"Imagery Layer":e==="Scene Service"?i="Scene Layer":e==="Media Service"?i="Media Layer":e==="Scene Package"?i="Scene Layer Package":e==="Stream Service"?i="Feature Layer":e==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?i=t.indexOf("Web Tool")>-1?"Tool":"Geoprocessing Service":e==="Geocoding Service"?i="Locator":e==="Geoenrichment Service"?i="GeoEnrichment Service":e==="Microsoft Powerpoint"?i="Microsoft PowerPoint":e==="GeoJson"?i="GeoJSON":e==="Globe Service"?i="Globe Layer":e==="Vector Tile Service"?i="Tile Layer":e==="netCDF"?i="NetCDF":e==="Map Service"?i=t.indexOf("Spatiotemporal")===-1&&(t.indexOf("Hosted Service")>-1||t.indexOf("Tiled")>-1)&&t.indexOf("Relational")===-1?"Tile Layer":"Map Image Layer":e&&e.toLowerCase().indexOf("add in")>-1?i=e.replace(/(add in)/gi,"Add-In"):e==="datastore catalog service"?i="Big Data File Share":e==="Compact Tile Package"?i="Tile Package (tpkx)":e==="OGCFeatureServer"?i="OGC Feature Layer":e==="web mapping application"&&t.indexOf("configurableApp")>-1&&(i="Instant App"),i}readExtent(e){return e&&e.length?new Zt(e[0][0],e[0][1],e[1][0],e[1][1]):null}get iconUrl(){const e=this.type&&this.type.toLowerCase()||"",t=this.typeKeywords||[],i="esri/images/portal/",r="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return e.indexOf("service")>0||e==="feature collection"||e==="kml"||e==="wms"||e==="wmts"||e==="wfs"?(n=t.indexOf("Hosted Service")>-1,e==="feature service"||e==="feature collection"||e==="kml"||e==="wfs"?(o=t.indexOf("Table")>-1,a=t.indexOf("Route Layer")>-1,l=t.indexOf("Markup")>-1,c=t.indexOf("Spatiotemporal")!==-1,h=t.indexOf("UtilityNetwork")!==-1,s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=e==="map service"||e==="wms"||e==="wmts"?n||t.indexOf("Tiled")>-1||e==="wmts"?"maptiles":"mapimages":e==="scene service"?t.indexOf("Line")>-1?"sceneweblayerline":t.indexOf("3DObject")>-1?"sceneweblayermultipatch":t.indexOf("Point")>-1?"sceneweblayerpoint":t.indexOf("IntegratedMesh")>-1?"sceneweblayermesh":t.indexOf("PointCloud")>-1?"sceneweblayerpointcloud":t.indexOf("Polygon")>-1?"sceneweblayerpolygon":t.indexOf("Building")>-1?"sceneweblayerbuilding":t.indexOf("Voxel")>-1?"sceneweblayervoxel":"sceneweblayer":e==="image service"?t.indexOf("Elevation 3D Layer")>-1?"elevationlayer":t.indexOf("Tiled Imagery")>-1?"tiledimagerylayer":"imagery":e==="stream service"?"streamlayer":e==="media service"?"mediaservice":e==="vector tile service"?"vectortile":e==="datastore catalog service"?"datastorecollection":e==="geocoding service"?"geocodeservice":e==="geoprocessing service"&&t.indexOf("Web Tool")>-1&&this.portal&&this.portal.isPortal?"tool":"layers"):s=e==="web map"||e==="cityengine web scene"?"maps":e==="web scene"?t.indexOf("ViewingMode-Local")>-1?"webscenelocal":"websceneglobal":e==="web mapping application"&&t.indexOf("configurableApp")>-1?"instantapps":e==="web mapping application"||e==="mobile application"||e==="application"||e==="operation view"||e==="desktop application"?"apps":e==="map document"||e==="map package"||e==="published map"||e==="scene document"||e==="globe document"||e==="basemap package"||e==="mobile basemap package"||e==="mobile map package"||e==="project package"||e==="project template"||e==="pro map"||e==="layout"||e==="layer"&&t.indexOf("ArcGIS Pro")>-1||e==="explorer map"&&t.indexOf("Explorer Document")?"mapsgray":e==="service definition"||e==="csv"||e==="shapefile"||e==="cad drawing"||e==="geojson"||e==="360 vr experience"||e==="netcdf"||e==="administrative report"?"datafiles":e==="explorer add in"||e==="desktop add in"||e==="windows viewer add in"||e==="windows viewer configuration"?"appsgray":e==="arcgis pro add in"||e==="arcgis pro configuration"?"addindesktop":e==="rule package"||e==="file geodatabase"||e==="sqlite geodatabase"||e==="csv collection"||e==="kml collection"||e==="windows mobile package"||e==="map template"||e==="desktop application template"||e==="gml"||e==="arcpad package"||e==="code sample"||e==="form"||e==="document link"||e==="earth configuration"||e==="operations dashboard add in"||e==="rules package"||e==="image"||e==="workflow manager package"||e==="explorer map"&&t.indexOf("Explorer Mapping Application")>-1||t.indexOf("Document")>-1?"datafilesgray":e==="network analysis service"||e==="geoprocessing service"||e==="geodata service"||e==="geometry service"||e==="geoprocessing package"||e==="locator package"||e==="geoprocessing sample"||e==="workflow manager service"?"toolsgray":e==="layer"||e==="layer package"||e==="explorer layer"?"layersgray":e==="scene package"?"scenepackage":e==="mobile scene package"?"mobilescenepackage":e==="tile package"||e==="compact tile package"?"tilepackage":e==="task file"?"taskfile":e==="report template"?"report-template":e==="statistical data collection"?"statisticaldatacollection":e==="insights workbook"?"workbook":e==="insights model"?"insightsmodel":e==="insights page"?"insightspage":e==="insights theme"?"insightstheme":e==="hub initiative"?"hubinitiative":e==="hubpage"?"hubpage":e==="hub event"?"hubevent":e==="hub site application"?"hubsite":e==="hub project"?"hubproject":e==="relational database connection"?"relationaldatabaseconnection":e==="big data file share"?"datastorecollection":e==="image collection"?"imagecollection":e==="style"?"style":e==="desktop style"?"desktopstyle":e==="dashboard"?"dashboard":e==="raster function template"?"rasterprocessingtemplate":e==="vector tile package"?"vectortilepackage":e==="ortho mapping project"?"orthomappingproject":e==="ortho mapping template"?"orthomappingtemplate":e==="solution"?"solutions":e==="geopackage"?"geopackage":e==="deep learning package"?"deeplearningpackage":e==="real time analytic"?"realtimeanalytics":e==="big data analytic"?"bigdataanalytics":e==="feed"?"feed":e==="excalibur imagery project"?"excaliburimageryproject":e==="notebook"?"notebook":e==="storymap"?"storymap":e==="survey123 add in"?"survey123addin":e==="mission"?"mission":e==="mission report"?"missionreport":e==="quickcapture project"?"quickcaptureproject":e==="pro report"?"proreport":e==="urban model"?"urbanmodel":e==="web experience"?"experiencebuilder":e==="web experience template"?"webexperiencetemplate":e==="experience builder widget"?"experiencebuilderwidget":e==="experience builder widget package"?"experiencebuilderwidgetpackage":e==="workflow"?"workflow":e==="insights script"?"insightsscript":e==="kernel gateway connection"?"kernelgatewayconnection":e==="hub initiative template"?"hubinitiativetemplate":e==="storymap theme"?"storymaptheme":e==="knowledge graph"?"knowledgegraph":e==="native application"?"nativeapp":e==="native application installer"?"nativeappinstaller":e==="link chart"?"linkchart":e==="investigation"?"investigation":e==="ogcfeatureserver"?"features":e==="pro project"?"proproject":e==="insights workbook package"?"insightsworkbookpackage":e==="apache parquet"?"apacheparquet":"maps",s?ui(i+s+r+".png"):null}get isLayer(){return["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","WMTS","WMS"].indexOf(this.type)>-1}get itemUrl(){const e=this.get("portal.restUrl");return e?e+"/content/items/"+this.id:null}get thumbnailUrl(){const e=this.itemUrl,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userItemUrl(){const e=this.get("portal.restUrl");if(!e)return null;const t=this.owner||this.get("portal.user.username");return t?`${e}/content/users/${this.ownerFolder?`${t}/${this.ownerFolder}`:t}/items/${this.id}`:null}load(e){this.portal||(this.portal=gl.getDefault());const t=this.portal.load(e).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?this.portal._request(this.itemUrl,{signal:_(e)?e.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}addRating(e){const t={method:"post",query:{}};return e instanceof w5&&(e=e.rating),isNaN(e)||typeof e!="number"||(t.query.rating=e),this.portal._request(this.itemUrl+"/addRating",t).then(()=>new w5({rating:e,created:new Date}))}clone(){const e={access:this.access,accessInformation:this.accessInformation,applicationProxies:se(this.applicationProxies),avgRating:this.avgRating,categories:se(this.categories),created:se(this.created),culture:this.culture,description:this.description,extent:se(this.extent),groupCategories:se(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:se(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:se(this.screenshots),size:this.size,snippet:this.snippet,tags:se(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:se(this.typeKeywords),url:this.url};return this.loaded&&(e.loadStatus="loaded"),new Tw({sourceJSON:this.sourceJSON}).set(e)}createPostQuery(){const e=this.toJSON();for(const t in e)t==="tags"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="typeKeywords"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="extent"&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}deleteRating(){return this.portal._request(this.itemUrl+"/deleteRating",{method:"post"}).then(()=>{})}fetchData(e="json",t){return this.portal._request(this.itemUrl+"/data",me(I({responseType:e},t),{query:{token:this.apiKey}}))}fetchRating(e){return this.portal._request(this.itemUrl+"/rating",I({query:{token:this.apiKey}},e)).then(t=>t.rating!=null?(t.created=new Date(t.created),new w5(t)):null)}fetchRelatedItems(e,t){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",I({query:me(I({},e),{token:this.apiKey})},t),Tw)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}reload(){return this.portal._request(this.itemUrl,{cacheBust:!0,query:{token:this.apiKey}}).then(e=>(this.sourceJSON=e,this.read(e),this))}update(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e&&e.data,i={method:"post"};i.query=this.createPostQuery();for(const r in i.query)i.query[r]===null&&(i.query[r]="");return i.query.clearEmptyFields=!0,t!=null&&(typeof t=="string"?i.query.text=t:typeof t=="object"&&(i.query.text=JSON.stringify(t))),this.portal._request(`${this.userItemUrl}/update`,i).then(()=>this.reload())}):Promise.reject(new Q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}updateThumbnail(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e.thumbnail,i=e.filename,r={method:"post"};if(typeof t=="string")Sp(t)?r.query={data:t}:r.query={url:yu(t)},_(i)&&(r.query.filename=i);else{const s=new FormData;_(i)?s.append("file",t,i):s.append("file",t),r.body=s}return this.portal._request(`${this.userItemUrl}/updateThumbnail`,r).then(()=>this.reload())}):Promise.reject(new Q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(e={},t){return(await import("./resourceUtils.46564902.js")).fetchResources(this,e,t)}async addResource(e,t,i){const r=await import("./resourceUtils.46564902.js");return e.portalItem=this,r.addOrUpdateResource(e,"add",t,i)}async removeResource(e,t){const i=await import("./resourceUtils.46564902.js");if(e.portalItem&&e.portalItem.itemUrl!==this.itemUrl)throw new Q("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return i.removeResource(this,e,t)}async removeAllResources(e){return(await import("./resourceUtils.46564902.js")).removeAllResources(this,e)}resourceFromPath(e){return new r5e({portalItem:this,path:e})}toJSON(){const e=this.extent,t={created:this.created&&this.created.getTime(),description:this.description,extent:e&&[[e.xmin,e.ymin],[e.xmax,e.ymax]],id:this.id,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,tags:this.tags,thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:this.typeKeywords,url:this.url};return nse(t)}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Tw({sourceJSON:e})}_getPostQuery(){const e=this.toJSON();for(const t in e)t==="tags"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="typeKeywords"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="extent"&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}};u([d({type:["private","shared","org","public"]})],Yt.prototype,"access",void 0),u([d()],Yt.prototype,"accessInformation",void 0),u([d({type:String})],Yt.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],Yt.prototype,"applicationProxies",void 0),u([d()],Yt.prototype,"avgRating",void 0),u([d()],Yt.prototype,"categories",void 0),u([d({type:Date})],Yt.prototype,"created",void 0),u([d()],Yt.prototype,"culture",void 0),u([d()],Yt.prototype,"description",void 0),u([d({readOnly:!0})],Yt.prototype,"displayName",null),u([d({type:Zt})],Yt.prototype,"extent",void 0),u([Fe("extent")],Yt.prototype,"readExtent",null),u([d()],Yt.prototype,"groupCategories",void 0),u([d({readOnly:!0})],Yt.prototype,"iconUrl",null),u([d()],Yt.prototype,"id",void 0),u([d({readOnly:!0})],Yt.prototype,"isLayer",null),u([d()],Yt.prototype,"itemControl",void 0),u([d({readOnly:!0})],Yt.prototype,"itemUrl",null),u([d()],Yt.prototype,"licenseInfo",void 0),u([d({type:Date})],Yt.prototype,"modified",void 0),u([d()],Yt.prototype,"name",void 0),u([d()],Yt.prototype,"numComments",void 0),u([d()],Yt.prototype,"numRatings",void 0),u([d()],Yt.prototype,"numViews",void 0),u([d()],Yt.prototype,"owner",void 0),u([d()],Yt.prototype,"ownerFolder",void 0),u([d({type:gl})],Yt.prototype,"portal",void 0),u([d()],Yt.prototype,"screenshots",void 0),u([d()],Yt.prototype,"size",void 0),u([d()],Yt.prototype,"snippet",void 0),u([d()],Yt.prototype,"sourceJSON",void 0),u([d()],Yt.prototype,"tags",void 0),u([d()],Yt.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Yt.prototype,"thumbnailUrl",null),u([d()],Yt.prototype,"title",void 0),u([d()],Yt.prototype,"type",void 0),u([d()],Yt.prototype,"typeKeywords",void 0),u([d()],Yt.prototype,"url",void 0),u([d({readOnly:!0})],Yt.prototype,"userItemUrl",null),Yt=Tw=u([P("esri.portal.PortalItem")],Yt);const gD=Yt;var Zde=Object.freeze(Object.defineProperty({__proto__:null,default:gD},Symbol.toStringTag,{value:"Module"}));const s5e=he.getLogger("esri.layers.mixins.PortalLayer"),n5e=e=>{let t=class extends e{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){var i;(i=this.portalItem)==null||i.destroy(),this.portalItem=null}set portalItem(i){i!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",i))}readPortalItem(i,r,s){if(r.itemId)return new gD({id:r.itemId,portal:s&&s.portal})}writePortalItem(i,r){i&&i.id&&(r.itemId=i.id)}async loadFromPortal(i,r){if(this.portalItem&&this.portalItem.id)try{const s=await import("./layersLoader.aa44a235.js").then(function(n){return n.l});return Jt(r),await s.load({instance:this,supportedTypes:i.supportedTypes,validateItem:i.validateItem,supportsData:i.supportsData},r)}catch(s){throw vr(s)||s5e.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(i){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(i).catch(r=>(Em(r),!0)))}async _fetchUserHasEditingPrivileges(i){const r=this.url?ws==null?void 0:ws.findCredential(this.url):null;if(!r)return!0;const s=lM.credential===r?lM.user:await this._fetchEditingUser(i);return lM.credential=r,lM.user=s,O(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(i){var r,s;const n=(r=this.portalItem)==null||(s=r.portal)==null?void 0:s.user;if(n)return n;const o=ws.findServerInfo(this.url);if(o==null||!o.owningSystemUrl)return null;const a=`${o.owningSystemUrl}/sharing/rest`,l=gl.getDefault();if(l&&l.loaded&&Ih(l.restUrl)===Ih(a))return l.user;const c=`${a}/community/self`,h=_(i)?i.signal:null,p=await Bh(Ci(c,{authMode:"no-prompt",query:{f:"json"},signal:h}));return p.ok?zG.fromJSON(p.value.data):null}read(i,r){r&&(r.layer=this),super.read(i,r)}write(i,r){const s=r&&r.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||gl.getDefault());return s&&n&&!Goe(n.restUrl,s.restUrl)?(r.messages&&r.messages.push(new Q("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save the scene, set the layer.portalItem to null or save the scene to the same portal as the item associated with the layer`,{layer:this})),null):super.write(i,me(I({},r),{layer:this}))}};return u([d({type:gD})],t.prototype,"portalItem",null),u([Fe("web-document","portalItem",["itemId"])],t.prototype,"readPortalItem",null),u([Ge("web-document","portalItem",{itemId:{type:String}})],t.prototype,"writePortalItem",null),u([d({clonable:!1})],t.prototype,"resourceReferences",void 0),u([d({readOnly:!0})],t.prototype,"userHasEditingPrivileges",void 0),t=u([P("esri.layers.mixins.PortalLayer")],t),t},lM={credential:null,user:null},_C=new pt,TA=new WeakMap;function o5e(e){Qde(e)&&_C.push(e)}function a5e(e){Qde(e)&&_C.includes(e)&&_C.remove(e)}function Qde(e){return e&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function Jde(e,t){return Number.isFinite(e)&&Number.isFinite(t)?t<=0?e:Jde(t,e%t):0}let x5=0,cM=0;function l5e(){const e=Date.now();for(const i of _C)if(i.refreshInterval){var t;e-((t=TA.get(i))!=null?t:0)+5>=6e4*i.refreshInterval&&(TA.set(i,e),i.refresh(e))}}Lse(()=>{const e=Date.now();let t=0;for(const i of _C)t=Jde(Math.round(6e4*i.refreshInterval),t),i.refreshInterval?TA.get(i)||TA.set(i,e):TA.delete(i);if(t!==cM){if(cM=t,clearInterval(x5),cM===0)return void(x5=0);x5=setInterval(l5e,cM)}});function c5e(e){return e&&typeof e=="object"&&"refreshTimestamp"in e&&"refresh"in e}const u5e=e=>{let t=class extends e{constructor(...i){super(...i),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=Ase(()=>this.hasDataChanged()),this.when().then(()=>{o5e(this)},()=>{})}destroy(){a5e(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(i=Date.now()){Qk(this._debounceHasDataChanged()).then(r=>{r&&this._set("refreshTimestamp",i),this.emit("refresh",{dataChanged:r})},r=>{he.getLogger(this.declaredClass).error(r),this.emit("refresh",{dataChanged:!1,error:r})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:i=>i>=.1?i:i<=0?0:.1,json:{write:!0}})],t.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],t.prototype,"refreshTimestamp",void 0),u([d()],t.prototype,"refreshParameters",null),t=u([P("esri.layers.mixins.RefreshableLayer")],t),t},h5e=e=>{let t=class extends e{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const i={minScale:this.minScale,maxScale:this.maxScale},r=this.parent;r&&"effectiveScaleRange"in r&&d5e(i,r.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===i.minScale&&s.maxScale===i.maxScale?s:i}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"maxScale",void 0),u([d({readOnly:!0})],t.prototype,"effectiveScaleRange",null),t=u([P("esri.layers.mixins.ScaleRangeLayer")],t),t};function d5e(e,t){return e.minScale=e.minScale>0?t.minScale>0?Math.min(e.minScale,t.minScale):e.minScale:t.minScale,e.maxScale=e.maxScale>0?t.maxScale>0?Math.max(e.maxScale,t.maxScale):e.maxScale:t.maxScale,e}const P_=po()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});var WV;let RE=WV=class extends ve{constructor(e){super(e),this.value=0,this.unit="milliseconds"}toMilliseconds(){return A3e(this.value,this.unit,"milliseconds")}clone(){return new WV({value:this.value,unit:this.unit})}};u([d({type:Number,json:{write:!0},nonNullable:!0})],RE.prototype,"value",void 0),u([d({type:P_.apiValues,json:{type:P_.jsonValues,read:P_.read,write:P_.write},nonNullable:!0})],RE.prototype,"unit",void 0),RE=WV=u([P("esri.TimeInterval")],RE);const bC=RE;var XV;let Sw=XV=class extends ve{constructor(e){super(e),this.respectsDaylightSaving=!1,this.timezone=null}readRespectsDaylightSaving(e,t){return t.respectsDaylightSaving!==void 0?t.respectsDaylightSaving:t.respectDaylightSaving!==void 0&&t.respectDaylightSaving}clone(){const{respectsDaylightSaving:e,timezone:t}=this;return new XV({respectsDaylightSaving:e,timezone:t})}};u([d({type:Boolean,json:{write:!0}})],Sw.prototype,"respectsDaylightSaving",void 0),u([Fe("respectsDaylightSaving",["respectsDaylightSaving","respectDaylightSaving"])],Sw.prototype,"readRespectsDaylightSaving",null),u([d({type:String,json:{read:{source:"timeZone"},write:{target:"timeZone"}}})],Sw.prototype,"timezone",void 0),Sw=XV=u([P("esri.layers.support.TimeReference")],Sw);const p5e=Sw;var YV;let xo=YV=class extends ve{constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,t){if(!t.timeExtent||!Array.isArray(t.timeExtent)||t.timeExtent.length!==2)return null;const i=new Date(t.timeExtent[0]),r=new Date(t.timeExtent[1]);return new Ap({start:i,end:r})}writeFullTimeExtent(e,t){e&&_(e.start)&&_(e.end)?t.timeExtent=[e.start.getTime(),e.end.getTime()]:t.timeExtent=null}readInterval(e,t){return t.timeInterval&&t.timeIntervalUnits?new bC({value:t.timeInterval,unit:P_.fromJSON(t.timeIntervalUnits)}):t.defaultTimeInterval&&t.defaultTimeIntervalUnits?new bC({value:t.defaultTimeInterval,unit:P_.fromJSON(t.defaultTimeIntervalUnits)}):null}writeInterval(e,t){if(e){const i=e.toJSON();t.timeInterval=i.value,t.timeIntervalUnits=i.unit}else t.timeInterval=null,t.timeIntervalUnits=null}clone(){const{cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:n,fullTimeExtent:o,trackIdField:a,useTime:l}=this;return new YV({cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:se(n),fullTimeExtent:se(o),trackIdField:a,useTime:l})}};u([d({type:Boolean,json:{read:{source:"exportOptions.timeDataCumulative"},write:{target:"exportOptions.timeDataCumulative"}}})],xo.prototype,"cumulative",void 0),u([d({type:String,json:{read:{source:"endTimeField"},write:{target:"endTimeField",allowNull:!0}}})],xo.prototype,"endField",void 0),u([d({type:Ap,json:{write:{enabled:!0,allowNull:!0}}})],xo.prototype,"fullTimeExtent",void 0),u([Fe("fullTimeExtent",["timeExtent"])],xo.prototype,"readFullTimeExtent",null),u([Ge("fullTimeExtent")],xo.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],xo.prototype,"hasLiveData",void 0),u([d({type:bC,json:{write:{enabled:!0,allowNull:!0}}})],xo.prototype,"interval",void 0),u([Fe("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],xo.prototype,"readInterval",null),u([Ge("interval")],xo.prototype,"writeInterval",null),u([d({type:String,json:{read:{source:"startTimeField"},write:{target:"startTimeField",allowNull:!0}}})],xo.prototype,"startField",void 0),u([d({type:p5e,json:{write:{enabled:!0,allowNull:!0}}})],xo.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],xo.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{read:{source:"exportOptions.useTime"},write:{target:"exportOptions.useTime"}}})],xo.prototype,"useTime",void 0),xo=YV=u([P("esri.layers.support.TimeInfo")],xo);const Kde=xo,f5e=e=>{let t=class extends e{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(i,r){const s=r.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=P_.fromJSON(s.timeOffsetUnits);return n&&o?new bC({value:n,unit:o}):null}set timeInfo(i){Yne(i,this.fieldsIndex),this._set("timeInfo",i)}};return u([d({type:Ap,json:{write:!1}})],t.prototype,"timeExtent",void 0),u([d({type:bC})],t.prototype,"timeOffset",void 0),u([Fe("service","timeOffset",["timeInfo.exportOptions"])],t.prototype,"readOffset",null),u([d({value:null,type:Kde,json:{write:!0,origins:{"web-document":{read:!1,write:!1}}}})],t.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],t.prototype,"useViewTime",void 0),t=u([P("esri.layers.mixins.TemporalLayer")],t),t};var ZV;let $f=ZV=class extends ve{constructor(e){super(e)}clone(){const{name:e,fields:t,isAscending:i,isUnique:r,description:s}=this;return new ZV({name:e,fields:t,isAscending:i,isUnique:r,description:s})}};u([d({constructOnly:!0})],$f.prototype,"name",void 0),u([d({constructOnly:!0})],$f.prototype,"fields",void 0),u([d({constructOnly:!0})],$f.prototype,"isAscending",void 0),u([d({constructOnly:!0})],$f.prototype,"isUnique",void 0),u([d({constructOnly:!0})],$f.prototype,"description",void 0),$f=ZV=u([P("esri.layers.support.FeatureIndex")],$f);let lI=class extends ve{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster"],readOnly:!0,json:{read:!1,write:!0}})],lI.prototype,"type",void 0),lI=u([P("esri.layers.support.FeatureReduction")],lI);const cI=lI;var QV;let Ew=QV=class extends ve{constructor(){super(...arguments),this.statisticType=null,this.onStatisticField=null,this.onStatisticValueExpression=null}clone(){return new QV({statisticType:this.statisticType,onStatisticField:this.onStatisticField,onStatisticValueExpression:this.onStatisticValueExpression})}};u([d({type:String,json:{write:!0}})],Ew.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Ew.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],Ew.prototype,"onStatisticValueExpression",void 0),Ew=QV=u([P("esri.layers.support.OutStatistic")],Ew);const m5e=Ew;var JV;let OE=JV=class extends ve{constructor(){super(...arguments),this.name=null}clone(){return new JV({name:this.name,outStatistic:this.outStatistic.clone()})}};u([d({type:String,json:{write:!0}})],OE.prototype,"name",void 0),u([d({type:m5e,json:{write:!0}})],OE.prototype,"outStatistic",void 0),OE=JV=u([P("esri.layers.support.AggregateField")],OE);const g5e=OE,wj="__begin__",xj="__end__",y5e=new RegExp(wj,"ig"),v5e=new RegExp(xj,"ig"),dQ=new RegExp("^"+wj,"i"),pQ=new RegExp(xj+"$","i"),yD='"',_5e=yD+" + ",b5e=" + "+yD;function w5e(e){return e.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function x5e(e){return e.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function NN(e){const t={expression:"",type:"none"};return e.labelExpressionInfo?e.labelExpressionInfo.value?(t.expression=e.labelExpressionInfo.value,t.type="conventional"):e.labelExpressionInfo.expression&&(t.expression=e.labelExpressionInfo.expression,t.type="arcade"):e.labelExpression!=null&&(t.expression=w5e(e.labelExpression),t.type="conventional"),t}function T5e(e){const t=NN(e);if(!t)return null;switch(t.type){case"conventional":return KV(t.expression);case"arcade":return t.expression}return null}function S5e(e){const t=NN(e);if(!t)return null;switch(t.type){case"conventional":return A5e(t.expression);case"arcade":return Tj(t.expression)}return null}function KV(e){let t;return e?(t=ap(e,i=>wj+'$feature["'+i+'"]'+xj),t=dQ.test(t)?t.replace(dQ,""):yD+t,t=pQ.test(t)?t.replace(pQ,""):t+yD,t=t.replace(y5e,_5e).replace(v5e,b5e)):t='""',t}const E5e=/^\s*\{([^}]+)\}\s*$/i;function A5e(e){const t=e.match(E5e);return t&&t[1].trim()||null}const C5e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,R5e=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,O5e=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function Tj(e){if(!e)return null;let t=C5e.exec(e)||R5e.exec(e);return t?t[1]||t[3]:(t=O5e.exec(e),t?t[2]:null)}var e8;let Bg=e8=class extends ve{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(e,t){return t.value?KV(t.value):e}writeExpression(e,t,i){this.value!=null&&(e=KV(this.value)),e!=null&&(t[i]=e)}clone(){return new e8({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],Bg.prototype,"expression",void 0),u([Fe("expression",["expression","value"])],Bg.prototype,"readExpression",null),u([Ge("expression")],Bg.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Bg.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],Bg.prototype,"value",void 0),Bg=e8=u([P("esri.layers.support.LabelExpressionInfo")],Bg);const epe=Bg,tpe=[252,146,31,255],apt=[153,153,153,255],M5e={type:"esriSMS",style:"esriSMSCircle",size:6,color:tpe,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},P5e={type:"esriSLS",style:"esriSLSSolid",width:.75,color:tpe},I5e={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},$5e={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},D5e={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},L5e={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},N5e={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},lpt=oS.fromJSON(M5e),cpt=Xh.fromJSON(P5e),upt=q1.fromJSON(I5e),F5e=aS.fromJSON($5e);oS.fromJSON(D5e);Xh.fromJSON(L5e);q1.fromJSON(N5e);var t8;const uM=new si({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function ipe(e){return!e||e.origin!=="service"&&!rpe(e.layer)}function rpe(e){return(e==null?void 0:e.type)==="map-image"}function spe(e){var t,i;return!!rpe(e)&&!((t=e.capabilities)==null||(i=t.exportMap)==null||!i.supportsArcadeExpressionForLabeling)}function U5e(e){return ipe(e)||spe(e.layer)}let hs=t8=class extends ve{constructor(e){super(e),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=F5e,this.useCodedValues=void 0,this.where=null}static evaluateWhere(e,t){const i=function(r,s,n){switch(s){case"=":return r==n;case"<>":return r!=n;case">":return r>n;case">=":return r>=n;case"<":return r<n;case"<=":return r<=n}return!1};try{if(e==null)return!0;const r=e.split(" ");if(r.length===3)return i(t[r[0]],r[1],r[2]);if(r.length===7){const s=i(t[r[0]],r[1],r[2]),n=r[3],o=i(t[r[4]],r[5],r[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+e)}}readLabelExpression(e,t){const i=t.labelExpressionInfo;if(!i||!i.value&&!i.expression)return e}writeLabelExpression(e,t,i){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)e=x5e(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const r=Tj(this.labelExpressionInfo.expression);r&&(e="["+r+"]")}}e!=null&&(t[i]=e)}writeLabelExpressionInfo(e,t,i,r){if(e==null&&this.labelExpression!=null&&ipe(r))e=new epe({expression:this.getLabelExpressionArcade()});else if(!e)return;const s=e.toJSON(r);s.expression&&(t[i]=s)}writeMaxScale(e,t){(e||this.minScale)&&(t.maxScale=e)}writeMinScale(e,t){(e||this.maxScale)&&(t.minScale=e)}getLabelExpression(){return NN(this)}getLabelExpressionArcade(){return T5e(this)}getLabelExpressionSingleField(){return S5e(this)}hash(){return JSON.stringify(this)}clone(){return new t8({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:se(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:se(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],hs.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],hs.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1}}}})],hs.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(e,t,i){return this.labelExpressionInfo&&(i==null?void 0:i.origin)==="service"&&spe(i.layer)?{enabled:!1}:{allowNull:!0}}}}})],hs.prototype,"labelExpression",void 0),u([Fe("labelExpression")],hs.prototype,"readLabelExpression",null),u([Ge("labelExpression")],hs.prototype,"writeLabelExpression",null),u([d({type:epe,json:{write:{overridePolicy:(e,t,i)=>U5e(i)?{allowNull:!0}:{enabled:!1}}}})],hs.prototype,"labelExpressionInfo",void 0),u([Ge("labelExpressionInfo")],hs.prototype,"writeLabelExpressionInfo",null),u([d({type:uM.apiValues,json:{type:uM.jsonValues,read:uM.read,write:uM.write}})],hs.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],hs.prototype,"labelPosition",void 0),u([d({type:Number})],hs.prototype,"maxScale",void 0),u([Ge("maxScale")],hs.prototype,"writeMaxScale",null),u([d({type:Number})],hs.prototype,"minScale",void 0),u([Ge("minScale")],hs.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:!1}}}})],hs.prototype,"repeatLabel",void 0),u([d({type:Number,cast:Bi,json:{write:!0,origins:{"web-scene":{write:!1}}}})],hs.prototype,"repeatLabelDistance",void 0),u([d({types:yEe,json:{origins:{"web-scene":{types:vEe,write:jZ,default:null}},write:jZ,default:null}})],hs.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],hs.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],hs.prototype,"where",void 0),hs=t8=u([P("esri.layers.support.LabelClass")],hs);const Sj=hs;var i8;let Il=i8=class extends ve{constructor(e){super(e),this.type="cluster",this.clusterRadius=Bi("80px"),this.clusterMinSize=Bi("12px"),this.clusterMaxSize=Bi("50px"),this.popupEnabled=!0,this.popupTemplate=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}clone(){return new i8({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:se(this.labelingInfo),labelsVisible:this.labelsVisible,fields:se(this.fields),popupEnabled:this.popupEnabled,popupTemplate:se(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],Il.prototype,"type",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Bi(e),json:{write:!0}})],Il.prototype,"clusterRadius",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Il.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:Bi,json:{write:!0}})],Il.prototype,"clusterMaxSize",void 0),u([d(Wde)],Il.prototype,"popupEnabled",void 0),u([d({type:UL,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],Il.prototype,"popupTemplate",void 0),u([d({types:mEe})],Il.prototype,"symbol",void 0),u([d({type:[Sj],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],Il.prototype,"labelingInfo",void 0),u([d(Xde)],Il.prototype,"labelsVisible",void 0),u([d({type:[g5e],json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],Il.prototype,"fields",void 0),Il=i8=u([P("esri.layers.support.FeatureReductionCluster")],Il);const fQ=Il;var r8;let uI=r8=class extends cI{constructor(e){super(e),this.type="selection"}clone(){return new r8}};u([d({type:["selection"]})],uI.prototype,"type",void 0),uI=r8=u([P("esri.layers.support.FeatureReductionSelection")],uI);const mQ=uI,k5e={types:{key:"type",base:cI,typeMap:{selection:mQ,cluster:fQ}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:{key:"type",base:cI,typeMap:{selection:fQ}}},"web-scene":{types:{key:"type",base:cI,typeMap:{selection:mQ}}}}}},gQ=new si({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let Vg=class extends bp(ve){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],Vg.prototype,"name",void 0),u([d({json:{write:!0}})],Vg.prototype,"description",void 0),u([d({json:{read:gQ.read,write:gQ.write}})],Vg.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],Vg.prototype,"prototype",void 0),u([d({json:{write:!0}})],Vg.prototype,"thumbnail",void 0),Vg=u([P("esri.layers.support.FeatureTemplate")],Vg);const Ej=Vg;let gf=class extends bp(ve){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const t={};for(const i of Object.keys(e))t[i]=N7(e[i]);return t}writeDomains(e,t){const i={};for(const s of Object.keys(e)){var r;e[s]&&(i[s]=(r=e[s])==null?void 0:r.toJSON())}t.domains=i}};u([d({json:{write:!0}})],gf.prototype,"id",void 0),u([d({json:{write:!0}})],gf.prototype,"name",void 0),u([d({json:{write:!0}})],gf.prototype,"domains",void 0),u([Fe("domains")],gf.prototype,"readDomains",null),u([Ge("domains")],gf.prototype,"writeDomains",null),u([d({type:[Ej],json:{write:!0}})],gf.prototype,"templates",void 0),gf=u([P("esri.layers.support.FeatureType")],gf);const npe=gf;function z5e(e){return e.type==="date"||e.type==="esriFieldTypeDate"}function yQ(e){return e.type==="oid"||e.type==="esriFieldTypeOID"}function vQ(e){return e.type==="global-id"||e.type==="esriFieldTypeGlobalID"}class B5e{constructor(t){if(this.fields=t,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!t)return;const i=[];for(const r of t){const s=r&&r.name;if(s){const n=_Q(s);this._fieldsMap.set(s,r),this._fieldsMap.set(n,r),i.push(n),z5e(r)?(this.dateFields.push(r),this._dateFieldsSet.add(r)):$L(r)&&(this._numericFieldsSet.add(r),this.numericFields.push(r)),yQ(r)||vQ(r)||(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable)}}i.sort(),this.uid=i.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const t of this.fields)yQ(t)||vQ(t)||t.nullable||STe(t)!==void 0||this._requiredFields.push(t)}return this._requiredFields}has(t){return this.get(t)!=null}get(t){return t!=null?this._fieldsMap.get(t)||this._fieldsMap.get(_Q(t)):void 0}isDateField(t){return this._dateFieldsSet.has(this.get(t))}isNumericField(t){return this._numericFieldsSet.has(this.get(t))}normalizeFieldName(t){const i=this.get(t);if(i)return i.name}}function _Q(e){return e.toLowerCase().trim()}const V5e=he.getLogger("esri.layers.support.fieldProperties");function G5e(){return{fields:{type:[IR],value:null},fieldsIndex:{readOnly:!0,get(){return new B5e(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(e){this._userOutFields=e,this.notifyChange("outFields")},get:function(){const e=this._userOutFields;if(!e||!e.length)return null;if(e.includes("*"))return["*"];if(!this.fields)return e;for(const t of e)this.fieldsIndex.has(t)||V5e.error("field-attributes-layer:invalid-field",`Invalid field ${t} found in outFields`,{layer:this,outFields:e});return Zne(this.fieldsIndex,e)}}}}let Aw=class extends bp(ve){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],Aw.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],Aw.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:e=>SAe.read(e)||EAe.read(e)}})],Aw.prototype,"units",void 0),Aw=u([P("esri.layers.support.GeometryFieldsInfo")],Aw);const j5e=Aw,H5e=/\[([^\[\]]+)\]/gi;function bQ(e,t,i){return e?e.map(r=>{const s=new Sj;if(s.read(r,i),s.labelExpression){const n=t.fields||t.layerDefinition&&t.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(H5e,(o,a)=>`[${q5e(a,n)}]`)}return s}):null}function q5e(e,t){if(!t)return e;const i=e.toLowerCase();for(let r=0;r<t.length;r++){const s=t[r].name;if(s.toLowerCase()===i)return s}return e}var s8;let Cw=s8=class extends ve{constructor(e){super(e),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new pt}clone(){return new s8({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],Cw.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],Cw.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],Cw.prototype,"viewAllLevelIds",void 0),Cw=s8=u([P("esri.layers.support.LayerFloorInfo")],Cw);const W5e=Cw,wQ=new si({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),xQ=new si({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let Gc=class extends bp(ve){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:wQ.read,write:wQ.write}})],Gc.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],Gc.prototype,"relationshipTableId",void 0),u([d({json:{read:xQ.read,write:xQ.write}})],Gc.prototype,"role",void 0),Gc=u([P("esri.layers.support.Relationship")],Gc);const X5e=Gc,oh=[];function Y5e(e,t){if(Gde(e.url))return!0;const{wkid:i}=t;for(const r of oh){if(e.version>=r[0])return!0;if(typeof r[1]=="function"&&(r[1]=r[1]()),r[1].has(i))return!1}return!0}oh.push([10.91,()=>{const e=new Set([9709,9716,9741,9761,9766]);for(let t=9712;t<=9713;t++)e.add(t);for(let t=9748;t<=9749;t++)e.add(t);for(let t=20904;t<=20932;t++)e.add(t);for(let t=21004;t<=21032;t++)e.add(t);for(let t=21207;t<=21264;t++)e.add(t);for(let t=21307;t<=21364;t++)e.add(t);for(let t=102759;t<=102760;t++)e.add(t);for(let t=102901;t<=102960;t++)e.add(t);return e}]),oh.push([10.9,()=>{const e=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let t=9356;t<=9360;t++)e.add(t);for(let t=9404;t<=9407;t++)e.add(t);for(let t=9476;t<=9482;t++)e.add(t);for(let t=9487;t<=9494;t++)e.add(t);for(let t=9697;t<=9699;t++)e.add(t);return e}]),oh.push([10.81,()=>{const e=new Set([9265,9333,103598,103699]);for(let t=9248;t<=9254;t++)e.add(t);for(let t=9271;t<=9273;t++)e.add(t);for(let t=9284;t<=9285;t++)e.add(t);for(let t=21453;t<=21463;t++)e.add(t);return e}]),oh.push([10.8,()=>{const e=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let t=8035;t<=8036;t++)e.add(t);for(let t=8455;t<=8456;t++)e.add(t);for(let t=8518;t<=8529;t++)e.add(t);for(let t=8533;t<=8536;t++)e.add(t);for(let t=8538;t<=8540;t++)e.add(t);for(let t=8677;t<=8679;t++)e.add(t);for(let t=8902;t<=8903;t++)e.add(t);for(let t=8907;t<=8910;t++)e.add(t);for(let t=8949;t<=8951;t++)e.add(t);for(let t=8972;t<=8987;t++)e.add(t);for(let t=9039;t<=9040;t++)e.add(t);for(let t=9068;t<=9069;t++)e.add(t);for(let t=9140;t<=9141;t++)e.add(t);for(let t=9148;t<=9150;t++)e.add(t);for(let t=9153;t<=9159;t++)e.add(t);for(let t=9205;t<=9218;t++)e.add(t);for(let t=9221;t<=9222;t++)e.add(t);for(let t=54098;t<=54101;t++)e.add(t);return e}]),oh.push([10.71,()=>{const e=new Set([6316]);for(let t=8351;t<=8353;t++)e.add(t);for(let t=9294;t<=9297;t++)e.add(t);for(let t=103586;t<=103594;t++)e.add(t);for(let t=103696;t<=103698;t++)e.add(t);return e}]),oh.push([10.7,()=>{const e=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let t=8065;t<=8068;t++)e.add(t);for(let t=8082;t<=8083;t++)e.add(t);for(let t=8379;t<=8385;t++)e.add(t);for(let t=8836;t<=8840;t++)e.add(t);for(let t=8857;t<=8860;t++)e.add(t);for(let t=53035;t<=53037;t++)e.add(t);for(let t=54090;t<=54091;t++)e.add(t);for(let t=102498;t<=102499;t++)e.add(t);return e}]),oh.push([10.61,()=>new Set([102497])]),oh.push([10.6,()=>{const e=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let t=7755;t<=7787;t++)e.add(t);for(let t=7791;t<=7795;t++)e.add(t);for(let t=7799;t<=7801;t++)e.add(t);for(let t=7825;t<=7831;t++)e.add(t);for(let t=7877;t<=7878;t++)e.add(t);for(let t=7882;t<=7883;t++)e.add(t);for(let t=7991;t<=7992;t++)e.add(t);for(let t=8042;t<=8043;t++)e.add(t);for(let t=8058;t<=8059;t++)e.add(t);for(let t=8311;t<=8348;t++)e.add(t);for(let t=9060;t<=9067;t++)e.add(t);for(let t=102562;t<=102568;t++)e.add(t);for(let t=102799;t<=102900;t++)e.add(t);return e}]),oh.push([10.51,()=>{const e=new Set([7683,7881,7886,7899,8888,9e3]);for(let t=8013;t<=8032;t++)e.add(t);for(let t=9053;t<=9057;t++)e.add(t);for(let t=104017;t<=104018;t++)e.add(t);for(let t=104971;t<=104974;t++)e.add(t);return e}]),oh.push([10.5,()=>{const e=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let t=4087;t<=4088;t++)e.add(t);for(let t=5896;t<=5899;t++)e.add(t);for(let t=7005;t<=7007;t++)e.add(t);for(let t=7057;t<=7070;t++)e.add(t);for(let t=7073;t<=7082;t++)e.add(t);for(let t=7109;t<=7128;t++)e.add(t);for(let t=7844;t<=7859;t++)e.add(t);return e}]);async function Z5e(e,t,i){const r=e&&e.getAtOrigin&&e.getAtOrigin("renderer",t.origin);if(r&&r.type==="unique-value"&&r.styleOrigin){const s=await Bh(r.populateFromStyle());if(Jt(i),s.ok===!1){const n=s.error;t&&t.messages&&t.messages.push(new uc("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:t})),e.clear("renderer",t.origin)}}}const Q5e=["oid","global-id"],J5e=["oid","global-id","guid"];function K5e({displayField:e,editFieldsInfo:t,fields:i,objectIdField:r,title:s},n){if(!i)return null;const o=nUe({editFieldsInfo:t,fields:i,objectIdField:r},n);if(!o.length)return null;const a=lUe({titleBase:s,fields:i,displayField:e}),l=aUe();return new UL({title:a,content:l,fieldInfos:o})}const eUe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],tUe=(e,{editFieldsInfo:t,objectIdField:i,visibleFieldNames:r})=>r?r.has(e.name):!ope(e.name,t)&&(!i||e.name!==i)&&!(Q5e.indexOf(e.type)>-1)&&!eUe.some(s=>s.test(e.name));function iUe(e,t){const i=e;return t&&(e=e.filter(r=>t.indexOf(r.type)===-1)),e===i&&(e=e.slice()),e.sort(rUe),e}function rUe(e,t){return e.type==="oid"?-1:t.type==="oid"?1:TQ(e)?-1:TQ(t)?1:(e.alias||e.name).toLocaleLowerCase().localeCompare((t.alias||t.name).toLocaleLowerCase())}function ope(e,t){if(!e||!t)return!1;const{creationDateField:i,creatorField:r,editDateField:s,editorField:n}=t;return[i&&i.toLowerCase(),r&&r.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].indexOf(e.toLowerCase())!==-1}function sUe(e,t){return e.editable&&J5e.indexOf(e.type)===-1&&!ope(e.name,t)}function nUe({editFieldsInfo:e,fields:t,objectIdField:i},r){return iUe(t,(r==null?void 0:r.ignoreFieldTypes)||cUe).map(s=>new SR({fieldName:s.name,isEditable:sUe(s,e),label:s.alias,format:oUe(s),visible:tUe(s,{editFieldsInfo:e,objectIdField:i,visibleFieldNames:r==null?void 0:r.visibleFieldNames})}))}function oUe(e){switch(e.type){case"small-integer":case"integer":case"single":return new oA({digitSeparator:!0,places:0});case"double":return new oA({digitSeparator:!0,places:2});case"date":return new oA({dateFormat:"long-month-day-year"});default:return null}}function aUe(){return[new rT,new KA]}function lUe(e){const t=_Te(e),{titleBase:i}=e;return t?`${i}: {${t.trim()}}`:i}function TQ(e){return(e.name&&e.name.toLowerCase())==="name"?!0:(e.alias&&e.alias.toLowerCase())==="name"||void 0}const cUe=["geometry","blob","raster","guid","xml"],T5=new si({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),uUe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"},us="FeatureLayer",SQ=he.getLogger("esri.layers.FeatureLayer");function EQ(e){return e&&e instanceof pt}function Pt(e,t,i){return!!(e&&e.hasOwnProperty(t)?e[t]:i)}function hM(e,t,i){return e&&e.hasOwnProperty(t)?e[t]:i}function hUe(e){var t;const i=e==null||(t=e.supportedSpatialAggregationStatistics)==null?void 0:t.map(r=>r.toLowerCase());return{envelope:!(i==null||!i.includes("envelopeaggregate")),centroid:!(i==null||!i.includes("centroidaggregate")),convexHull:!(i==null||!i.includes("convexhullaggregate"))}}const S5=G5e();function E5(e,t,i){const r=!(i==null||!i.writeLayerSchema);return{enabled:r,ignoreOrigin:r}}let Me=class extends L4e(P4e(t5e(f5e(h5e(u5e(XFe(J4e(n5e(Lde(I4e(zFe(bp(gj))))))))))))){constructor(...e){super(...e),this._handles=new Bt,this.capabilities=null,this.charts=null,this.copyright=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.dynamicDataSource=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.featureReduction=null,this.fields=null,this.fieldsIndex=null,this.floorInfo=null,this.formTemplate=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.layerId=void 0,this.legendEnabled=!0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.screenSizePerspectiveEnabled=!0,this.serviceDefinitionExpression=null,this.spatialReference=tt.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.trackIdField=null,this.type="feature",this.typeIdField=null,this.types=null,this.indexes=new(pt.ofType($f)),this.userIsAdmin=!1,this.version=void 0,this.visible=!0}destroy(){var e;(e=this.source)==null||e.destroy(),this._handles=it(this._handles)}normalizeCtorArgs(e,t){return typeof e=="string"?I({url:e},t):e}load(e){const t=_(e)?e.signal:null;if(this.portalItem&&this.portalItem.loaded&&this.source)return void this.addResolvingPromise(this.createGraphicsSource(t).then(r=>this._initLayerProperties(r)));const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch(Em).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const r=await this._fetchFirstLayerId(t);r!=null&&(this.layerId=r)}if(!this.url&&!this._hasMemorySource())throw new Q("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this._initLayerProperties(await this.createGraphicsSource(t))}).then(()=>this.finishLoadEditablePortalLayer(e));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(e,t){return t=t.layerDefinition||t,{attachment:this._readAttachmentCapabilities(t.attachmentProperties),data:this._readDataCapabilities(t),metadata:this._readMetadataCapabilities(t),operations:this._readOperationsCapabilities(t.capabilities||e,t),query:this._readQueryCapabilities(t),queryRelated:this._readQueryRelatedCapabilities(t),editing:this._readEditingCapabilities(t)}}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")||0)+1}get editingEnabled(){return!(this.loaded&&!this.capabilities.operations.supportsEditing)&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(e){e!=null?this._override("editingEnabled",e):this._clearOverride("editingEnabled")}readEditingEnabled(e,t){return this._readEditingEnabled(t,!1)}readEditingEnabledFromWebMap(e,t,i){return this._readEditingEnabled(t,!0,i)}writeEditingEnabled(e,t){this._writeEditingEnabled(e,t,!1)}writeEditingEnabledToWebMap(e,t,i,r){this._writeEditingEnabled(e,t,!0,r)}readEditingInfo(e,t){const{editingInfo:i}=t;return i?{lastEditDate:i.lastEditDate!=null?new Date(i.lastEditDate):null}:null}readIsTable(e,t){return(t=t&&t.layerDefinition||t).type==="Table"||!t.geometryType}writeIsTable(e,t,i,r){r!=null&&r.writeLayerSchema&&cc(i,e?"Table":"Feature Layer",t)}readMinScale(e,t){return t.effectiveMinScale||e||0}readMaxScale(e,t){return t.effectiveMaxScale||e||0}readGlobalIdFieldFromService(e,t){if((t=t.layerDefinition||t).globalIdField)return t.globalIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeGlobalID")return i.name}}readObjectIdFieldFromService(e,t){if((t=t.layerDefinition||t).objectIdField)return t.objectIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeOID")return i.name}}get parsedUrl(){const e=this.url?Gn(this.url):null;return e!=null&&(this.dynamicDataSource!=null?e.path=r0(e.path,"dynamicLayer"):this.layerId!=null&&(e.path=r0(e.path,this.layerId.toString()))),e}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){kW(e,this.fieldsIndex),this._set("renderer",e)}readRenderer(e,t,i){const r=(t=t.layerDefinition||t).drawingInfo&&t.drawingInfo.renderer||void 0;if(r){const s=bFe(r,t,i)||void 0;return s||SQ.error("Failed to create renderer",{rendererDefinition:t.drawingInfo.renderer,layer:this,context:i}),s}if(t.defaultSymbol)return t.types&&t.types.length?new pj({defaultSymbol:A5(t.defaultSymbol,t,i),field:t.typeIdField,uniqueValueInfos:t.types.map(s=>({id:s.id,symbol:A5(s.symbol,s,i)}))}):new dj({symbol:A5(t.defaultSymbol,t,i)})}set source(e){const t=this._get("source");t!==e&&(EQ(t)&&this._resetMemorySource(t),EQ(e)&&this._initMemorySource(e),this._set("source",e))}castSource(e){return e?Array.isArray(e)||e instanceof pt?new nQ({layer:this,items:e}):e:null}readSource(e,t){const i=Q1.fromJSON(t.featureSet);return new nQ({layer:this,items:i&&i.features||[]})}readServiceDefinitionExpression(e,t){return t.definitionQuery||t.definitionExpression}readTemplates(e,t){const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e=e&&e.map(n=>Ej.fromJSON(n)),this._fixTemplates(e,r),this._fixTemplates(e,s),e}readTitle(e,t){const i=t.layerDefinition&&t.layerDefinition.name||t.name,r=t.title||t.layerDefinition&&t.layerDefinition.title;if(i){const s=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?jFe(this.url,i):i;let n=i;if(!n&&this.url){const o=zR(this.url);_(o)&&(n=o.title)}return n?(this.sublayerTitleMode==="item-title-and-service-name"&&s&&s!==n&&(n=s+" - "+n),yj(n)):void 0}if(this.sublayerTitleMode==="item-title"&&r)return r}readTitleFromWebMap(e,t){return t.title||t.layerDefinition&&t.layerDefinition.name}readTypeIdField(e,t){let i=(t=t.layerDefinition||t).typeIdField;if(i&&t.fields){i=i.toLowerCase();const r=t.fields.find(s=>s.name.toLowerCase()===i);r&&(i=r.name)}return i}readTypes(e,t){e=(t=t.layerDefinition||t).types;const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e&&e.map(n=>(n=npe.fromJSON(n),this._fixTemplates(n.templates,r),this._fixTemplates(n.templates,s),n))}set url(e){const t=qFe({layer:this,url:e,nonStandardUrlAllowed:!0,logger:SQ});this._set("url",t.url),t.layerId!=null&&this._set("layerId",t.layerId)}writeUrl(e,t,i,r){WFe(this,e,null,t,r)}readVersion(e,t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}readVisible(e,t){return t.layerDefinition&&t.layerDefinition.defaultVisibility!=null?!!t.layerDefinition.defaultVisibility:t.visibility!=null?!!t.visibility:void 0}addAttachment(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("addAttachment"in this.source))throw new Q(us,"Layer source does not support addAttachment capability");return this.source.addAttachment(e,t)})}updateAttachment(e,t,i){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("updateAttachment"in this.source))throw new Q(us,"Layer source does not support updateAttachment capability");return this.source.updateAttachment(e,t,i)})}async applyEdits(e,t){const i=await import("./editingSupport.dc683926.js");return await this.load(),i.applyEdits(this,this.source,e,t)}on(e,t){return super.on(e,t)}createPopupTemplate(e){return K5e(this,e)}async createGraphicsSource(e){if(this._hasMemorySource())return this.source.load({signal:e});const{default:t}=await Ese(import("./FeatureLayerSource.9f10b53a.js"),e);return new t({layer:this}).load({signal:e})}createQuery(){const e=new pa,t=this.get("capabilities.data"),i=this.get("capabilities.query");e.dynamicDataSource=this.dynamicDataSource,e.historicMoment=this.historicMoment,e.gdbVersion=this.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),t&&(t.supportsZ&&this.returnZ!=null&&(e.returnZ=this.returnZ),t.supportsM&&this.returnM!=null&&(e.returnM=this.returnM)),e.outFields=["*"],e.where=this.definitionExpression||"1=1";const{timeOffset:r,timeExtent:s}=this;return e.timeExtent=r!=null&&s!=null?s.offset(-r.value,r.unit):s||null,e.multipatchOption=this.geometryType==="multipatch"?"xyFootprint":null,e}deleteAttachments(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("deleteAttachments"in this.source))throw new Q(us,"Layer source does not support deleteAttachments capability");return this.source.deleteAttachments(e,t)})}fetchRecomputedExtents(e){return this.load({signal:e==null?void 0:e.signal}).then(()=>{if(this.source.fetchRecomputedExtents)return this.source.fetchRecomputedExtents(e);throw new Q(us,"Layer source does not support fetchUpdates capability")})}getFeatureType(e){const{typeIdField:t,types:i}=this;if(!t||!e)return null;const r=e.attributes?e.attributes[t]:void 0;if(r==null)return null;let s=null;return i.some(n=>{const{id:o}=n;return o!=null&&(o.toString()===r.toString()&&(s=n),!!s)}),s}getFieldDomain(e,t){const i=t&&t.feature,r=this.getFeatureType(i);if(r){const s=r.domains&&r.domains[e];if(s&&s.type!=="inherited")return s}return this._getLayerDomain(e)}getField(e){return this.fieldsIndex.get(e)}queryAttachments(e,t){return e=tD.from(e),this.load().then(()=>{if(!this.get("capabilities.data.supportsAttachment"))throw new Q(us,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:r,globalIds:s,num:n,size:o,start:a,where:l}=e;if(!this.get("capabilities.operations.supportsQueryAttachments")){const c=r&&r.length>1,h=i&&i.length,p=s&&s.length,f=o&&o.length;if(c||h||p||f||n||a||l)throw new Q(us,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!(r&&r.length||l))throw new Q(us,"'objectIds' or 'where' are required to perform attachment query",e);if(!("queryAttachments"in this.source))throw new Q(us,"Layer source does not support queryAttachments capability",e);return this.source.queryAttachments(e)})}queryFeatures(e,t){return this.load().then(()=>this.source.queryFeatures(pa.from(e)||this.createQuery(),t)).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i})}queryObjectIds(e,t){return this.load().then(()=>{if(this.source.queryObjectIds)return this.source.queryObjectIds(pa.from(e)||this.createQuery(),t);throw new Q(us,"Layer source does not support queryObjectIds capability")})}queryFeatureCount(e,t){return this.load().then(()=>{if(this.source.queryFeatureCount)return this.source.queryFeatureCount(pa.from(e)||this.createQuery(),t);throw new Q(us,"Layer source does not support queryFeatureCount capability")})}queryExtent(e,t){return this.load().then(()=>{if(this.source.queryExtent)return this.source.queryExtent(pa.from(e)||this.createQuery(),t);throw new Q(us,"Layer source does not support queryExtent capability")})}queryRelatedFeatures(e,t){return this.load().then(()=>{if("queryRelatedFeatures"in this.source)return this.source.queryRelatedFeatures(y1.from(e),t);throw new Q(us,"Layer source does not support queryRelatedFeatures capability")})}queryRelatedFeaturesCount(e,t){return this.load().then(()=>{if("queryRelatedFeaturesCount"in this.source)return this.source.queryRelatedFeaturesCount(y1.from(e),t);throw new Q(us,"Layer source does not support queryRelatedFeaturesCount capability")})}queryTopFeatures(e,t){return this.load().then(()=>{if("queryTopFeatures"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopFeatures($y.from(e),t).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i});throw new Q(us,"Layer source does not support queryTopFeatures capability")})}queryTopObjectIds(e,t){return this.load().then(()=>{if("queryTopObjectIds"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopObjectIds($y.from(e),t);throw new Q(us,"Layer source does not support queryTopObjectIds capability")})}queryTopFeaturesExtent(e,t){return this.load().then(()=>{if("queryTopExtents"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopExtents($y.from(e),t);throw new Q(us,"Layer source does not support queryTopExtents capability")})}queryTopFeatureCount(e,t){return this.load().then(()=>{if("queryTopCount"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopCount($y.from(e),t);throw new Q(us,"Layer source does not support queryFeatureCount capability")})}read(e,t){const i=e.featureCollection;if(i){const r=i.layers;r&&r.length===1&&(super.read(r[0],t),i.showLegend!=null&&super.read({showLegend:i.showLegend},t))}super.read(e,t),t&&t.origin==="service"&&this.revert(["objectIdField","fields","timeInfo","spatialReference"],"service")}write(e,t){var i,r;const s=(t=me(I({},t),{writeLayerSchema:(i=(r=t)==null?void 0:r.writeLayerSchema)!=null?i:this._hasMemorySource()})).origin,n=t.layerContainerType,o=t.messages;if(this.isTable){if(s==="web-scene"||s==="web-map"&&n!=="tables")return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Table source cannot be written to web scenes and web maps`,{layer:this})),null;if(this._hasMemorySource())return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using an in-memory Table source cannot be written to web scenes and web maps`,{layer:this})),null}else if(this.loaded&&s==="web-map"&&n==="tables")return o&&o.push(new Q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a non-table source cannot be written to tables in web maps`,{layer:this})),null;return super.write(e,t)}clone(){if(this._hasMemorySource())throw new Q(us,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(e){return!!this.loaded&&(this.source.type==="memory"||Y5e(this,e))}_readEditingEnabled(e,t,i){var r;let s=(r=e.layerDefinition)==null?void 0:r.capabilities;return s?this._hasEditingCapability(s):(s=e.capabilities,t&&(i==null?void 0:i.origin)==="web-map"&&!this._hasMemorySource()&&s?this._hasEditingCapability(s):void 0)}_hasEditingCapability(e){return e.toLowerCase().split(",").map(t=>t.trim()).includes("editing")}_writeEditingEnabled(e,t,i,r){if(!e){var s,n;const o=(s=this.capabilities)!=null&&(n=s.operations)!=null&&n.supportsSync?"Query,Sync":"Query";cc("layerDefinition.capabilities",o,t),!i||r!=null&&r.writeLayerSchema||(t.capabilities=o)}}_checkAttachmentSupport(e){const{attributes:t}=e,{objectIdField:i}=this;return this.get("capabilities.data.supportsAttachment")?e?t?t[i]?void 0:Promise.reject(new Q(us,`feature is missing the identifying attribute ${i}`)):Promise.reject(new Q(us,"'attributes' are required on a feature to query attachments")):Promise.reject(new Q(us,"A feature is required to add/delete/update attachments")):Promise.reject(new Q(us,"this layer doesn't support attachments"))}_getLayerDomain(e){const t=this.fieldsIndex.get(e);return t?t.domain:null}_fetchFirstLayerId(e){return Ci(this.url,{query:me(I({f:"json"},this.customParameters),{token:this.apiKey}),responseType:"json",signal:e}).then(t=>{const i=t.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async _initLayerProperties(e){return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",url:this.parsedUrl})),this._verifySource(),this._verifyFields(),kW(this.renderer,this.fieldsIndex),Yne(this.timeInfo,this.fieldsIndex),Z5e(this,{origin:"service"})}async hasDataChanged(){var e;if((e=this.source)!=null&&e.refresh)try{var t;const{dataChanged:i,updates:r}=await((t=this.source)==null?void 0:t.refresh());if(_(r)&&(this.sourceJSON=I(I({},this.sourceJSON),r),this.read(r,{origin:"service",url:this.parsedUrl})),i)return!0}catch{}if(this.definitionExpression)try{return(await xFe(this.definitionExpression,this.fieldsIndex)).hasDateFunctions}catch{}return!1}_verifyFields(){const e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||e.search(/\/FeatureServer\//i)!==-1||this.fields&&this.fields.some(function(t){return t.type==="geometry"})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")}_fixTemplates(e,t){e&&e.forEach(i=>{const r=i.prototype&&i.prototype.attributes;r&&t&&delete r[t]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new Q("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new Q("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(e){e.forEach(t=>{t.layer=this,t.sourceLayer=this}),this._handles.add([e.on("after-add",t=>{t.item.layer=this,t.item.sourceLayer=this}),e.on("after-remove",t=>{t.item.layer=null,t.item.sourceLayer=null})],"fl-source")}_resetMemorySource(e){e.forEach(t=>{t.layer=null,t.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}_readAttachmentCapabilities(e){const t={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1};return e&&Array.isArray(e)&&e.forEach(i=>{const r=uUe[i.name];r&&(t[r]=!!i.isEnabled)}),t}_readDataCapabilities(e){return{isVersioned:Pt(e,"isDataVersioned",!1),supportsAttachment:Pt(e,"hasAttachments",!1),supportsM:Pt(e,"hasM",!1),supportsZ:Pt(e,"hasZ",!1)}}_readMetadataCapabilities(e){return{supportsAdvancedFieldProperties:Pt(e,"supportsFieldDescriptionProperty",!1)}}_readOperationsCapabilities(e,t){const i=e?e.toLowerCase().split(",").map(l=>l.trim()):[],r=i.includes("editing")&&!t.datesInUnknownTimezone;let s=r&&i.includes("create"),n=r&&i.includes("delete"),o=r&&i.includes("update");const a=i.includes("changetracking");return r&&!(s||n||o)&&(s=n=o=!0),{supportsCalculate:Pt(t,"supportsCalculate",!1),supportsTruncate:Pt(t,"supportsTruncate",!1),supportsValidateSql:Pt(t,"supportsValidateSql",!1),supportsAdd:s,supportsDelete:n,supportsEditing:r,supportsChangeTracking:a,supportsQuery:i.includes("query"),supportsQueryAttachments:Pt(t.advancedQueryCapabilities,"supportsQueryAttachments",!1),supportsResizeAttachments:Pt(t,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:o,supportsExceedsLimitStatistics:Pt(t,"supportsExceedsLimitStatistics",!1)}}_readQueryCapabilities(e){var t;const i=e.advancedQueryCapabilities,r=e.ownershipBasedAccessControlForFeatures,s=e.archivingInfo,n=(t=this.url)==null?void 0:t.includes("MapServer"),o=!ue("mapserver-pbf-enabled")&&n&&this.version<10.81,a=Gde(this.url),l=(e.supportedQueryFormats||"").split(",").reduce((c,h)=>{const p=h.toLowerCase().trim();return p&&c.add(p),c},new Set);return{supportsStatistics:Pt(i,"supportsStatistics",e.supportsStatistics),supportsPercentileStatistics:Pt(i,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:Pt(i,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:hUe(i),supportsCentroid:Pt(i,"supportsReturningGeometryCentroid",!1),supportsDistance:Pt(i,"supportsQueryWithDistance",!1),supportsDistinct:Pt(i,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:Pt(i,"supportsReturningQueryExtent",!1),supportsGeometryProperties:Pt(i,"supportsReturningGeometryProperties",!1),supportsHavingClause:Pt(i,"supportsHavingClause",!1),supportsOrderBy:Pt(i,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:Pt(i,"supportsPagination",!1),supportsQuantization:Pt(e,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:Pt(e,"supportsQuantizationEditMode",!1),supportsQueryGeometry:Pt(e,"supportsReturningQueryGeometry",!1),supportsResultType:Pt(i,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:Pt(i,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:Pt(i,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:Pt(e,"useStandardizedQueries",!1),supportsTopFeaturesQuery:Pt(i,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:Pt(r,"allowOthersToQuery",!0),supportsHistoricMoment:Pt(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!o&&l.has("pbf"),supportsDisjointSpatialRelationship:Pt(i,"supportsDisjointSpatialRel",!1),supportsCacheHint:Pt(i,"supportsQueryWithCacheHint",!1),supportsDefaultSpatialReference:Pt(i,"supportsDefaultSR",!1),supportsCompactGeometry:a,maxRecordCountFactor:hM(e,"maxRecordCountFactor",void 0),maxRecordCount:hM(e,"maxRecordCount",void 0),standardMaxRecordCount:hM(e,"standardMaxRecordCount",void 0),tileMaxRecordCount:hM(e,"tileMaxRecordCount",void 0)}}_readQueryRelatedCapabilities(e){const t=e.advancedQueryCapabilities,i=Pt(t,"supportsAdvancedQueryRelated",!1);return{supportsPagination:Pt(t,"supportsQueryRelatedPagination",!1),supportsCount:i,supportsOrderBy:i}}_readEditingCapabilities(e){const t=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:Pt(e,"allowGeometryUpdates",!0),supportsGlobalId:Pt(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:Pt(e,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:Pt(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:Pt(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:Pt(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:Pt(t,"allowAnonymousToDelete",!0),supportsDeleteByOthers:Pt(t,"allowOthersToDelete",!0),supportsUpdateByAnonymous:Pt(t,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:Pt(t,"allowOthersToUpdate",!0)}}};u([d({readOnly:!0,json:{read:!1}})],Me.prototype,"capabilities",void 0),u([Fe("service","capabilities",["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"])],Me.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Me.prototype,"charts",void 0),u([d({readOnly:!0})],Me.prototype,"createQueryVersion",null),u([d({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],Me.prototype,"copyright",void 0),u([d({type:Boolean})],Me.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],Me.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],Me.prototype,"definitionExpression",void 0),u([d({types:B_,readOnly:!0})],Me.prototype,"defaultSymbol",void 0),u([d({type:ql})],Me.prototype,"dynamicDataSource",void 0),u([d({readOnly:!0})],Me.prototype,"editFieldsInfo",void 0),u([d({type:Boolean})],Me.prototype,"editingEnabled",null),u([Fe(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],Me.prototype,"readEditingEnabled",null),u([Fe("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],Me.prototype,"readEditingEnabledFromWebMap",null),u([Ge(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],Me.prototype,"writeEditingEnabled",null),u([Ge("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],Me.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],Me.prototype,"editingInfo",void 0),u([Fe("editingInfo")],Me.prototype,"readEditingInfo",null),u([d(W4e)],Me.prototype,"elevationInfo",void 0),u([d(k5e)],Me.prototype,"featureReduction",void 0),u([d(me(I({},S5.fields),{json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:E5}}}}}))],Me.prototype,"fields",void 0),u([d(S5.fieldsIndex)],Me.prototype,"fieldsIndex",void 0),u([d({type:W5e,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],Me.prototype,"floorInfo",void 0),u([d({type:DFe,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],Me.prototype,"formTemplate",void 0),u([d({type:Zt,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],Me.prototype,"fullExtent",void 0),u([d()],Me.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:j5e,json:{read:{source:"geometryProperties"}}})],Me.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:T5.read},"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:E5,writer(e,t,i){const r=e?T5.toJSON(e):null;r&&cc(i,r,t)}}}},read:{source:"layerDefinition.geometryType",reader:T5.read}}})],Me.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],Me.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],Me.prototype,"hasZ",void 0),u([d({readOnly:!0,type:lS})],Me.prototype,"heightModelInfo",void 0),u([d({type:Date})],Me.prototype,"historicMoment",void 0),u([d(Y4e)],Me.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],Me.prototype,"infoFor3D",void 0),u([d({readOnly:!0,json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],Me.prototype,"isTable",void 0),u([Fe("service","isTable",["type","geometryType"]),Fe("isTable",["layerDefinition.type","layerDefinition.geometryType"])],Me.prototype,"readIsTable",null),u([Ge("web-map","isTable")],Me.prototype,"writeIsTable",null),u([d(Xde)],Me.prototype,"labelsVisible",void 0),u([d({type:[Sj],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:bQ},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:bQ},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],Me.prototype,"labelingInfo",void 0),u([d(X4e)],Me.prototype,"opacity",void 0),u([d({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],Me.prototype,"layerId",void 0),u([d(q4e)],Me.prototype,"legendEnabled",void 0),u([d({type:["show","hide"]})],Me.prototype,"listMode",void 0),u([d(Z4e)],Me.prototype,"minScale",void 0),u([Fe("service","minScale",["minScale","effectiveMinScale"])],Me.prototype,"readMinScale",null),u([d(Q4e)],Me.prototype,"maxScale",void 0),u([Fe("service","maxScale",["maxScale","effectiveMaxScale"])],Me.prototype,"readMaxScale",null),u([d({type:String})],Me.prototype,"globalIdField",void 0),u([Fe("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"]),Fe("service","globalIdField",["globalIdField","fields"])],Me.prototype,"readGlobalIdFieldFromService",null),u([d({type:String,json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:E5}}}}})],Me.prototype,"objectIdField",void 0),u([Fe("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),Fe("service","objectIdField",["objectIdField","fields"])],Me.prototype,"readObjectIdFieldFromService",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],Me.prototype,"operationalLayerType",void 0),u([d(S5.outFields)],Me.prototype,"outFields",void 0),u([d({readOnly:!0})],Me.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Me.prototype,"path",void 0),u([d(Wde)],Me.prototype,"popupEnabled",void 0),u([d({type:UL,json:{name:"popupInfo",write:!0}})],Me.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],Me.prototype,"defaultPopupTemplate",null),u([d({type:[X5e],readOnly:!0})],Me.prototype,"relationships",void 0),u([d({types:$de,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:vFe,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}})],Me.prototype,"renderer",null),u([Fe("service","renderer",["drawingInfo.renderer","defaultSymbol"]),Fe("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],Me.prototype,"readRenderer",null),u([d()],Me.prototype,"sourceJSON",void 0),u([d({type:Boolean})],Me.prototype,"returnM",void 0),u([d({type:Boolean})],Me.prototype,"returnZ",void 0),u([d(j4e)],Me.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],Me.prototype,"source",null),u([It("source")],Me.prototype,"castSource",null),u([Fe("portal-item","source",["featureSet"]),Fe("web-map","source",["featureSet"])],Me.prototype,"readSource",null),u([d({readOnly:!0})],Me.prototype,"serviceDefinitionExpression",void 0),u([Fe("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],Me.prototype,"readServiceDefinitionExpression",null),u([d({type:tt,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],Me.prototype,"spatialReference",void 0),u([d({type:Number})],Me.prototype,"subtypeCode",void 0),u([d({type:[Ej]})],Me.prototype,"templates",void 0),u([Fe("templates",["editFieldsInfo","creatorField","editorField","templates"])],Me.prototype,"readTemplates",null),u([d({type:Kde})],Me.prototype,"timeInfo",void 0),u([d()],Me.prototype,"title",void 0),u([Fe("service","title",["name"]),Fe("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],Me.prototype,"readTitle",null),u([Fe("web-map","title",["layerDefinition.name","title"])],Me.prototype,"readTitleFromWebMap",null),u([d({type:String})],Me.prototype,"sublayerTitleMode",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],Me.prototype,"trackIdField",void 0),u([d({json:{read:!1}})],Me.prototype,"type",void 0),u([d({type:String})],Me.prototype,"typeIdField",void 0),u([Fe("service","typeIdField"),Fe("typeIdField",["layerDefinition.typeIdField"])],Me.prototype,"readTypeIdField",null),u([d({type:[npe]})],Me.prototype,"types",void 0),u([Fe("service","types",["types"]),Fe("types",["layerDefinition.types"])],Me.prototype,"readTypes",null),u([d({readOnly:!0,json:{write:!1}})],Me.prototype,"serverGens",void 0),u([d({type:pt.ofType($f),readOnly:!0})],Me.prototype,"indexes",void 0),u([d(H4e)],Me.prototype,"url",null),u([Ge("url")],Me.prototype,"writeUrl",null),u([d({readOnly:!0})],Me.prototype,"userIsAdmin",void 0),u([d({json:{origins:{service:{read:!0}},read:!1}})],Me.prototype,"version",void 0),u([Fe("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],Me.prototype,"readVersion",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],Me.prototype,"visible",void 0),u([Fe("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],Me.prototype,"readVisible",null),Me=u([P("esri.layers.FeatureLayer")],Me);const A5=ZT({types:xae}),ape=Me;var hpt=Object.freeze(Object.defineProperty({__proto__:null,default:ape},Symbol.toStringTag,{value:"Module"}));const dUe=["$datastore","$map","$layer","$aggregatedfeatures"],pUe="esri.widgets.Feature.support.arcadeFeatureUtils",fUe=he.getLogger(pUe);function mUe(e){return typeof e=="string"?PR(P7(e)):Array.isArray(e)?gUe(e):(e==null?void 0:e.declaredClass)==="esri.arcade.Dictionary"?yUe(e):e}function gUe(e){return`<ul class="esri-widget__list">${e.map(t=>`<li>${typeof t=="string"?PR(P7(t)):t}</li>`).join("")}</ul>`}function yUe(e){return`<table class="esri-widget__table">${e.keys().map(t=>{const i=e.field(t);return`<tr><th>${t}</th><td>${typeof i=="string"?PR(P7(i)):i}</td></tr>`}).join("")}</table>`}function vUe({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:i,context:r,viewInfo:s,map:n,graphic:o,interceptor:a}){i.forEach(l=>{const c=l.toLowerCase(),h={map:n,spatialReference:s.sr,interceptor:a};if(c==="$map"&&(r.vars[c]=t.convertMapToFeatureSetCollection(h)),c==="$layer"&&(r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:s.sr,interceptor:a})),c==="$datastore"&&(r.vars[c]=t.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:s.sr,interceptor:a})),c==="$aggregatedfeatures"){const p=o.layer,{fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b}=p,w=new ape(me(I({fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b},p.type==="feature"?{templates:p.templates,typeIdField:p.typeIdField,types:p.types}:null),{source:e}));r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:w,spatialReference:s.sr,interceptor:a})}})}function lpe(){return import("./arcadeUtils.89120371.js").then(function(e){return e.q})}async function _Ue({graphic:e,view:t}){const{isAggregate:i,layer:r}=e;if(!i||!r||(t==null?void 0:t.type)!=="2d")return[];const s=await t.whenLayerView(r);if(!s.createQuery||!s.queryFeatures)return[];const n=s.createQuery();n.aggregateIds=[e.getObjectId()];const{features:o}=await s.queryFeatures(n);return o}async function cpe({expressionInfo:e,arcadeUtils:t,interceptor:i,spatialReference:r,map:s,graphic:n,view:o}){if(!e||!e.expression)return null;const a=t.createSyntaxTree(e.expression),l=dUe.filter(g=>t.hasVariable(a,g)),[c]=await U9([_Ue({graphic:n,view:o}),t.loadScriptDependencies(a,!0,l)]),h=t.getViewInfo({spatialReference:r}),p=t.createExecContext(n,h);p.interceptor=i,p.useAsync=!0,vUe({aggregatedFeatures:c,arcadeUtils:t,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:i});const f=t.createFunction(a,p);return t.executeAsyncFunction(f,p).catch(g=>fUe.error("arcade-execution-error",{error:g,graphic:n,expressionInfo:e}))}async function bUe({expressionInfos:e,spatialReference:t,graphic:i,interceptor:r,map:s,view:n}){if(!e||!e.length)return{};const o=await lpe(),a={};for(const h of e)a[`expression/${h.name}`]=cpe({expressionInfo:h,arcadeUtils:o,interceptor:r,spatialReference:t,map:s,graphic:i,view:n});const l=await Sa(a),c={};for(const h in l)c[h]=mUe(l[h].value);return c}const wUe=1;let $l=class extends Rm(we){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{var t,i;const r=(t=this.contentElement)==null?void 0:t.type;(i=this.contentElementViewModel)==null||i.destroy();const s=r==="fields"?new _N:r==="media"?new M_:r==="text"?new sD:null;this._set("contentElementViewModel",s)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=T7(this._compile,wUe,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:i,interceptor:r,spatialReference:s,map:n,view:o,_abortController:a}=this;if(!(t&&i&&s&&n))return void this._set("contentElement",null);const l=await lpe();if(a!==this._abortController)return;const c=await cpe({arcadeUtils:l,expressionInfo:t,graphic:i,interceptor:r,map:n,spatialReference:s,view:o});if(!c||c.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const h=await sj(c,a.signal),p=h==null?void 0:h.type,f=p==="media"?iC.fromJSON(h):p==="text"?sT.fromJSON(h):p==="fields"?rT.fromJSON(h):null;this._set("contentElement",f)},this.handles.add([Wt(this,["expressionInfo","graphic","map","spatialReference","view"],this._compileThrottled),Wt(this,"contentElement",this._createVM)])}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:i}=this;return e?"loading":t||i?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}};u([d()],$l.prototype,"_abortController",void 0),u([d({type:ioe})],$l.prototype,"expressionInfo",void 0),u([d({type:Bo})],$l.prototype,"graphic",void 0),u([d({readOnly:!0})],$l.prototype,"contentElement",void 0),u([d({readOnly:!0})],$l.prototype,"contentElementViewModel",void 0),u([d()],$l.prototype,"interceptor",void 0),u([d()],$l.prototype,"spatialReference",null),u([d({readOnly:!0})],$l.prototype,"state",null),u([d()],$l.prototype,"map",null),u([d()],$l.prototype,"view",void 0),$l=u([P("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],$l);const Aj=$l,dM={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let hI=class extends Ra{constructor(e,t){super(e,t),this.viewModel=new Aj}initialize(){Wt(this,"viewModel.contentElementViewModel",()=>this._setupExpressionWidget())}destroy(){this._destroyContentWidget()}renderLoading(){return le("div",{key:"loading-container",class:dM.loadingSpinnerContainer},le("span",{class:this.classes(dM.iconLoading,dM.spinner)}))}render(){var e;const{state:t}=this.viewModel;return le("div",{class:dM.base},t==="loading"?this.renderLoading():t==="disabled"?null:(e=this._contentWidget)==null?void 0:e.render())}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:t}=this.viewModel,i=t==null?void 0:t.type;this._destroyContentWidget();const r=e?i==="fields"?new Rue({viewModel:e}):i==="media"?new ahe({viewModel:e}):i==="text"?new z3({viewModel:e}):null:null;this._contentWidget=r,this.scheduleRender()}};u([d({type:Aj})],hI.prototype,"viewModel",void 0),hI=u([P("esri.widgets.Feature.FeatureExpression")],hI);const xUe=hI;class TUe{constructor(t,i){this.preLayerQueryCallback=t,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=r=>{}),this.preRequestCallback||(this.preLayerQueryCallback=r=>{})}}var dI;const SUe=1,AQ="content-view-models",upe="esri.widgets.FeatureViewModel",EUe=he.getLogger(upe),CQ={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let Ur=dI=class extends we{constructor(e){super(e),this._handles=new Bt,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=T7(this._graphicChanged,SUe,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities=I({},CQ),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:i}=this;return t.type==="attachments"&&i.attachmentsContent||t.type==="custom"&&i.customContent||t.type==="fields"&&i.fieldsContent||t.type==="media"&&i.mediaContent||t.type==="text"&&i.textContent||t.type==="expression"&&i.expressionContent},this._handles.add(Wt(this,["graphic","_effectivePopupTemplate","abilities"],()=>this.graphicChangedThrottled()))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return _(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return QPe(AY(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return yue(this.graphic)}castAbilities(e){return I(I({},CQ),e)}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof M_&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof M_&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof M_&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=new AbortController;this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(i){vr(i)||(this._error=i,EUe.error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContentElement(e,t){return e.type==="attachments"?this._compileAttachments(e,t):e.type==="custom"?this._compileCustom(e,t):e.type==="fields"?this._compileFields(e,t):e.type==="media"?this._compileMedia(e,t):e.type==="text"?this._compileText(e,t):e.type==="expression"?this._compileExpression(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((t,i)=>this._compileContentElement(t,i)):typeof e=="string"?this._compileText(new sT({text:e}),0).text:e}_destroyContentViewModels(){var e;(e=this._handles)==null||e.remove(AQ),this.contentViewModels.forEach(t=>t&&!t.destroyed&&t.destroy()),this._set("contentViewModels",[])}_setExpressionContentVM(e,t){const{formattedAttributes:i}=this,{contentElement:r,contentElementViewModel:s}=e,n=r==null?void 0:r.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createFieldsVMParams(r,t))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createMediaVMParams(r,t))),n==="text"&&s.set(this._createTextVMParams(r)))}_compileExpression(e,t){const{expressionInfo:i}=e,{graphic:r,map:s,spatialReference:n,view:o}=this,a=new Aj({expressionInfo:i,graphic:r,interceptor:dI.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[t]=a,this._handles.add(Wt(a,"contentElementViewModel",()=>this._setExpressionContentVM(a,t)),AQ),e}_compileAttachments(e,t){const{graphic:i}=this,{description:r,title:s}=e;return this.contentViewModels[t]=new $7(I({graphic:i},this._compileTitleAndDesc({title:s,description:r}))),e}_compileCustom(e,t){const{graphic:i}=this,{creator:r,destroyer:s}=e;return this.contentViewModels[t]=new sD({graphic:i,creator:r,destroyer:s}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:i,_sourceLayer:r,graphic:s,formattedAttributes:n,_expressionAttributes:o}=this,{attributes:a}=s,l=n.global;return{title:R_({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:e}),description:R_({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:t})}}_createFieldsVMParams(e,t){const{_effectivePopupTemplate:i,formattedAttributes:r}=this,s=I(I({},r.global),r.content[t]),n=(e==null?void 0:e.fieldInfos)||(i==null?void 0:i.fieldInfos),o=n==null?void 0:n.filter(({fieldName:h})=>_ue(h)||Wf(h)||s.hasOwnProperty(h)),a=i==null?void 0:i.expressionInfos,{description:l,title:c}=e;return I({attributes:s,expressionInfos:a,fieldInfos:o},this._compileTitleAndDesc({title:c,description:l}))}_compileFields(e,t){const i=e.clone(),r=new _N(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=r,i.fieldInfos=r.formattedFieldInfos.slice(0),i}_createMediaVMParams(e,t){const{abilities:i,graphic:r,_fieldInfoMap:s,formattedAttributes:n,_effectivePopupTemplate:o,relatedInfos:a,_sourceLayer:l,_expressionAttributes:c}=this,{attributes:h}=r,{description:p,mediaInfos:f,title:g}=e;return I({abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:h,layer:l,fieldInfoMap:s,formattedAttributes:I(I({},n.global),n.content[t]),expressionAttributes:c,mediaInfos:f,popupTemplate:o,relatedInfos:a},this._compileTitleAndDesc({title:g,description:p}))}_compileMedia(e,t){const i=e.clone(),r=new M_(this._createMediaVMParams(e,t));return i.mediaInfos=r.formattedMediaInfos.slice(0),this.contentViewModels[t]=r,i}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:i,_sourceLayer:r,_expressionAttributes:s}=this;if(e&&e.text){const{attributes:n}=t,o=this.formattedAttributes.global;e.text=R_({attributes:n,fieldInfoMap:i,globalAttributes:o,expressionAttributes:s,layer:r,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const i=e.clone();return this.contentViewModels[t]=new sD(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i}=this;if(!e)return;const{lastEditInfoEnabled:r}=e,s=t==null?void 0:t.editFieldsInfo;return r&&s?ZPe(s,i.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:r,_expressionAttributes:s}=this,{attributes:n}=r,o=this.formattedAttributes.global;return R_({attributes:n,fieldInfoMap:t,globalAttributes:o,expressionAttributes:s,layer:i,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.title;return iD(i,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.content;return iD(i,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:i,graphic:r,_effectivePopupTemplate:s,spatialReference:n,map:o,view:a}=this,{content:{value:l},title:{value:c}}=await Sa({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!r)return;await t3e({graphic:r,popupTemplate:s,layer:i,spatialReference:n},e);const{expressionAttributes:{value:h}}=await Sa({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:bUe({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:n,graphic:r,map:o,interceptor:dI.interceptor,view:a})});t===this._featureAbortController&&r&&(this._expressionAttributes=h,this._graphicExpressionAttributes=I(I({},r.attributes),h),this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){const{_effectivePopupTemplate:r,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;i.content[t]=G4({fieldInfos:r==null?void 0:r.fieldInfos,graphic:s,attributes:I(I({},l),e.attributes),layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){const{graphic:r,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;i.content[t]=G4({fieldInfos:e.fieldInfos,graphic:r,attributes:I(I({},a),e.attributes),layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:i,relatedInfos:r,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=t==null?void 0:t.fieldInfos,l={global:G4({fieldInfos:a,graphic:i,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:r}),content:[]};return Array.isArray(e)&&e.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,AY(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:r,_sourceLayer:s}=this;r.clear();const n=_(s.associatedLayer)?await s.associatedLayer.load(i):s;if(!n)return;const o=t.filter(c=>c&&Wf(c.fieldName));if(!o||!o.length)return;t.forEach(c=>this._configureRelatedInfo(c,n));const a=await v$e({relatedInfos:r,layer:n},i);Object.keys(a).forEach(c=>{var h;const p=r.get(c.toString()),f=(h=a[c])==null?void 0:h.value;p&&f&&(p.layerInfo=f.data)});const l=await _$e({graphic:e,relatedInfos:r,layer:n},i);Object.keys(l).forEach(c=>{var h;p$e((h=l[c])==null?void 0:h.value,r.get(c.toString()))})}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,r=yE(e.fieldName);if(!r)return;const{layerId:s,fieldName:n}=r;if(!s)return;const o=i.get(s.toString())||d$e(s,t);o&&(b$e({relatedInfo:o,fieldName:n,fieldInfo:e}),this.relatedInfos.set(s,o))}};Ur.interceptor=new TUe(s3e,n3e),u([d()],Ur.prototype,"_error",void 0),u([d()],Ur.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],Ur.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],Ur.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],Ur.prototype,"_sourceLayer",null),u([d()],Ur.prototype,"abilities",void 0),u([It("abilities")],Ur.prototype,"castAbilities",null),u([d({readOnly:!0})],Ur.prototype,"content",void 0),u([d({readOnly:!0})],Ur.prototype,"contentViewModels",void 0),u([d({type:Boolean})],Ur.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],Ur.prototype,"state",null),u([d({readOnly:!0})],Ur.prototype,"formattedAttributes",void 0),u([d({type:Bo,value:null})],Ur.prototype,"graphic",null),u([d({readOnly:!0})],Ur.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],Ur.prototype,"relatedInfos",void 0),u([d()],Ur.prototype,"spatialReference",null),u([d({readOnly:!0})],Ur.prototype,"title",void 0),u([d()],Ur.prototype,"map",null),u([d({readOnly:!0})],Ur.prototype,"waitingForContent",null),u([d()],Ur.prototype,"view",void 0),Ur=dI=u([P(upe)],Ur);const Cj=Ur,hpe=e=>{let t=class extends e{constructor(){super(...arguments),this.renderNodeContent=i=>Cue(i)&&!i.destroyed?le("div",{key:i},i.render()):i instanceof HTMLElement?le("div",{key:i,bind:i,afterCreate:this._attachToNode}):b3e(i)?le("div",{key:i,bind:i.domNode,afterCreate:this._attachToNode}):null}_attachToNode(i){const r=this;i.appendChild(r)}};return t=u([P("esri.widgets.Feature.ContentMixin")],t),t},qn={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},RQ={title:!0,content:!0,lastEditedInfo:!0};let Jn=class extends hpe(Ra){constructor(e,t){super(e,t),this._contentWidgets=[],this.graphic=null,this.defaultPopupTemplateEnabled=!1,this.headingLevel=2,this.label=void 0,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.spatialReference=null,this.title=null,this.visibleElements=I({},RQ),this.map=null,this.view=null,this.viewModel=new Cj}initialize(){this.own(Wt(this,"viewModel.contentViewModels",()=>this._setupContentWidgets()))}loadDependencies(){return import("./calcite-notice.e3727a1b.js")}destroy(){this._destroyContentWidgets()}castVisibleElements(e){return I(I({},RQ),e)}render(){const{state:e}=this.viewModel,t=le("div",{class:qn.container,key:"container"},this.renderTitle(),e==="error"?this.renderError():e==="loading"?this.renderLoading():this.renderContentContainer());return le("div",{class:this.classes(qn.base,qn.esriWidget)},t)}setActiveMedia(e,t){this.viewModel.setActiveMedia(e,t)}nextMedia(e){this.viewModel.nextMedia(e)}previousMedia(e){this.viewModel.previousMedia(e)}renderError(){const{messagesCommon:e,messages:t,visibleElements:i}=this;return le("calcite-notice",{active:!0,color:"red",icon:"exclamation-mark-circle",scale:"s"},i.title?le("div",{key:"error-title",slot:"title"},e.errorMessage):null,le("div",{key:"error-message",slot:"message"},t.loadingError))}renderLoading(){return le("div",{key:"loading-container",class:qn.loadingSpinnerContainer},le("span",{class:this.classes(qn.iconLoading,qn.spinner)}))}renderContentContainer(){const{visibleElements:e}=this;return e.content?le("div",{class:qn.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:e,title:t}=this;return e.title?le(D7,{level:this.headingLevel,class:qn.title,innerHTML:t}):null}renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?le("div",{key:`${t}-content-elements`},e.map(this.renderContentElement,this)):null;if(typeof e=="string"){const i=this._contentWidgets[0];return!i||i.destroyed?null:le("div",{key:`${t}-content`},i.render())}return this.renderNodeContent(e)}renderContentElement(e,t){const{visibleElements:i}=this;if(typeof i.content!="boolean"&&!i.content[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(t);case"text":return this.renderText(e,t);case"expression":return this.renderExpression(t);default:return null}}renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:i,attachmentInfos:r}=t.viewModel;return i==="loading"||r.length>0?le("div",{key:this._buildKey("attachments-element",e),class:this.classes(qn.contentElement)},t.render()):null}renderExpression(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("expression-element",e),class:qn.contentElement},t.render())}renderCustom(e,t){const{creator:i}=e,r=this._contentWidgets[t];return!r||r.destroyed?null:i?le("div",{key:this._buildKey("custom-element",t),class:qn.contentElement},r.render()):null}renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("fields-element",e),class:qn.contentElement},t.render())}renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("media-element",e),class:qn.contentElement},t.render())}renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:i}=this.viewModel;if(!i||!e.lastEditedInfo)return null;const{date:r,user:s}=i,n=i.type==="edit"?s?t.lastEditedByUser:t.lastEdited:s?t.lastCreatedByUser:t.lastCreated,o=lf(n,{date:r,user:s});return le("div",{key:"edit-info-element",class:this.classes(qn.lastEditedInfo,qn.contentElement)},o)}renderText(e,t){const i=e.text,r=this._contentWidgets[t];return!r||r.destroyed?null:i?le("div",{key:this._buildKey("text-element",t),class:this.classes(qn.contentElement,qn.text)},r.render()):null}_buildKey(e,...t){return`${e}__${this.get("viewModel.graphic.uid")||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach(e=>this._destroyContentWidget(e)),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,i=this.get("viewModel.content"),{contentViewModels:r}=this.viewModel;if(Array.isArray(i))i.forEach((s,n)=>{s.type==="attachments"&&(this._contentWidgets[n]=new m3e({displayType:s.displayType,headingLevel:t.title?e+1:e,viewModel:r[n]})),s.type==="fields"&&(this._contentWidgets[n]=new Rue({viewModel:r[n]})),s.type==="media"&&(this._contentWidgets[n]=new ahe({viewModel:r[n]})),s.type==="text"&&(this._contentWidgets[n]=new z3({viewModel:r[n]})),s.type==="custom"&&(this._contentWidgets[n]=new z3({viewModel:r[n]})),s.type==="expression"&&(this._contentWidgets[n]=new xUe({viewModel:r[n]}))},this);else{const s=r[0];s&&!s.destroyed&&(this._contentWidgets[0]=new z3({viewModel:s}))}this.scheduleRender()}};u([mt("viewModel.graphic")],Jn.prototype,"graphic",void 0),u([mt("viewModel.defaultPopupTemplateEnabled")],Jn.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],Jn.prototype,"headingLevel",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Jn.prototype,"label",void 0),u([d(),ul("esri/widgets/Feature/t9n/Feature")],Jn.prototype,"messages",void 0),u([d(),ul("esri/t9n/common")],Jn.prototype,"messagesCommon",void 0),u([d(),ul("esri/widgets/support/t9n/uriUtils")],Jn.prototype,"messagesURIUtils",void 0),u([mt("viewModel.spatialReference")],Jn.prototype,"spatialReference",void 0),u([mt("viewModel.title")],Jn.prototype,"title",void 0),u([d()],Jn.prototype,"visibleElements",void 0),u([It("visibleElements")],Jn.prototype,"castVisibleElements",null),u([mt("viewModel.map")],Jn.prototype,"map",void 0),u([mt("viewModel.view")],Jn.prototype,"view",void 0),u([d({type:Cj})],Jn.prototype,"viewModel",void 0),Jn=u([P("esri.widgets.Feature")],Jn);const AUe=Jn;let Bv=class extends wr.EventedAccessor{constructor(e){super(e),this._anchorHandles=new Bt,this.location=null,this.screenLocation=null,this.screenLocationEnabled=!1,this.view=null,this._anchorHandles.add([rr(this,["screenLocationEnabled","location","view.size","view.stationary"],()=>this._updateScreenPointAndHandle()),rr(this,["view","view.ready"],()=>this._wireUpView())])}destroy(){this.view=null,this._anchorHandles&&this._anchorHandles.destroy(),this._anchorHandles=null,this._viewpointHandle=null}_wireUpView(){const e="view";if(this._anchorHandles.remove(e),this._viewpointHandle=null,!this.get("view.ready"))return;this._setScreenLocation();const{view:t}=this,i=t.type==="3d"?"camera":"viewpoint",r=mMe(t,i,()=>this._viewpointChange());this._anchorHandles.add(r,e),this._viewpointHandle=r,this._toggleWatchingViewpoint()}_viewpointChange(){this._setScreenLocation(),this.emit("view-change")}_updateScreenPointAndHandle(){this._setScreenLocation(),this._toggleWatchingViewpoint()}_toggleWatchingViewpoint(){const{_viewpointHandle:e,location:t,screenLocationEnabled:i}=this;!e||(t&&i?e.resume():e.pause())}_setScreenLocation(){const{location:e,view:t,screenLocationEnabled:i}=this,r=this.get("view.ready"),s=i&&r&&_(e)?t.toScreen(e):null;this._set("screenLocation",s)}};u([d()],Bv.prototype,"location",void 0),u([d({readOnly:!0})],Bv.prototype,"screenLocation",void 0),u([d()],Bv.prototype,"screenLocationEnabled",void 0),u([d()],Bv.prototype,"view",void 0),Bv=u([P("esri.widgets.support.AnchorElementViewModel")],Bv);const dpe=Bv,CUe="esri.widgets.CompassViewModel";let pI=class extends dpe{constructor(e){super(e),this.visible=!1}};u([d()],pI.prototype,"visible",void 0),pI=u([P(CUe)],pI);const ppe=pI,C5={base:"esri-spinner",spinnerStart:"esri-spinner--start",spinnerFinish:"esri-spinner--finish"};let Vv=class extends Ra{constructor(e,t){super(e,t),this._animationDelay=500,this._animationPromise=null,this.location=null,this.view=null,this.viewModel=new ppe,this.visible=!1}initialize(){this.own([rr(this,"visible",e=>this._visibleChange(e))])}destroy(){this._animationPromise=null}show(e){const{location:t,promise:i}=e;t&&(this.viewModel.location=t),this.visible=!0;const r=()=>this.hide();i&&i.catch(()=>{}).then(r)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:t}=this.viewModel,i=!!t,r=e&&i,s=!e&&i,n={[C5.spinnerStart]:r,[C5.spinnerFinish]:s},o=this._getPositionStyles();return le("div",{class:this.classes(C5.base,n),styles:o})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const t=Wx(this._animationDelay);this._animationPromise=t,t.catch(()=>{}).then(()=>{this._animationPromise===t&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:t}=this.viewModel;if(!t||O(e))return{};const{padding:i}=t;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([mt("viewModel.location")],Vv.prototype,"location",void 0),u([mt("viewModel.view")],Vv.prototype,"view",void 0),u([d({type:ppe})],Vv.prototype,"viewModel",void 0),u([mt("viewModel.visible")],Vv.prototype,"visible",void 0),Vv=u([P("esri.widgets.Spinner")],Vv);const RUe=Vv;var OQ;(function(e){e[e.size=22]="size",e[e.lineWidth=50]="lineWidth",e[e.maxSize=120]="maxSize",e[e.maxOutlineSize=80]="maxOutlineSize",e[e.tallSymbolWidth=20]="tallSymbolWidth"})(OQ||(OQ={}));class OUe{constructor(t,i){this._storage=new uj,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i){this._storage.put(t,i,1,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}}function MUe(e){return typeof e=="function"}function dpt(e,t,i,r){return MUe(e)?e(t,i,r):e}function ppt(e){return[e.r,e.g,e.b,e.a]}function fpt(e,t,i){const r=` /-,
`,s=l=>{let c=l.length;for(;c--;)if(r.indexOf(l.charAt(c))===-1)return!1;return!0},n=[];let o=0,a=-1;do if(a=t.indexOf("[",o),a>=o){if(a>o){const l=t.substr(o,a-o);n.push([l,null,s(l)])}if(o=a+1,a=t.indexOf("]",o),a>=o){if(a>o){const l=e[t.substr(o,a-o)];l&&n.push([null,l,!1])}o=a+1}}while(a!==-1);if(o<t.length-1){const l=t.substr(o);n.push([l,null,s(l)])}return l=>{let c="",h=null;for(const p of n){const[f,g,y]=p;if(f)y?h=f:(h&&(c+=h,h=null),c+=f);else{const v=l.attributes[g];v&&(h&&(c+=h,h=null),c+=v)}}return PUe(c,i)}}function PUe(e,t){switch(typeof e!="string"&&(e=String(e)),t){case"LowerCase":return e.toLowerCase();case"Allcaps":return e.toUpperCase();default:return e}}function mpt(e,t,i,r,s,n,o=!0){const a=t/s,l=i/n,c=Math.ceil(a/2),h=Math.ceil(l/2);for(let p=0;p<n;p++)for(let f=0;f<s;f++){const g=4*(f+(o?n-p-1:p)*s);let y=0,v=0,b=0,w=0,S=0,T=0,A=0;const C=(p+.5)*l;for(let R=Math.floor(p*l);R<(p+1)*l;R++){const L=Math.abs(C-(R+.5))/h,U=(f+.5)*a,N=L*L;for(let z=Math.floor(f*a);z<(f+1)*a;z++){let V=Math.abs(U-(z+.5))/c;const B=Math.sqrt(N+V*V);B>=-1&&B<=1&&(y=2*B*B*B-3*B*B+1,y>0&&(V=4*(z+R*t),A+=y*e[V+3],b+=y,e[V+3]<255&&(y=y*e[V+3]/250),w+=y*e[V],S+=y*e[V+1],T+=y*e[V+2],v+=y))}}r[g]=w/v,r[g+1]=S/v,r[g+2]=T/v,r[g+3]=A/b}}function gpt(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function IUe(e){return e.type==="CIMMarkerPlacementAlongLineRandomSize"||e.type==="CIMMarkerPlacementAlongLineSameSize"||e.type==="CIMMarkerPlacementAlongLineVariableSize"||e.type==="CIMMarkerPlacementAtExtremities"||e.type==="CIMMarkerPlacementAtMeasuredUnits"||e.type==="CIMMarkerPlacementAtRatioPositions"||e.type==="CIMMarkerPlacementOnLine"||e.type==="CIMMarkerPlacementOnVertices"}const ypt=e=>isNaN(e)||!e?0:e,vpt=e=>{if(!e)return!1;for(const t of e)switch(t.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":return!0}return!1};function _pt(){return import("./geometryEngineJSON.1eda2436.js")}function fpe(e,t,i,r){if(e.type!=="CIMTextSymbol"){if(i&&e.effects)for(const s of e.effects)LUe(s,t);if(e.symbolLayers)for(const s of e.symbolLayers)switch(s.type){case"CIMPictureMarker":case"CIMVectorMarker":$Ue(s,t,r);break;case"CIMPictureStroke":case"CIMSolidStroke":r!=null&&r.preserveOutlineWidth||!s.width||(s.width*=t);break;case"CIMPictureFill":s.height&&(s.height*=t),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t);break;case"CIMHatchFill":fpe(s.lineSymbol,t,!0,me(I({},r),{preserveOutlineWidth:!1})),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t),s.separation&&(s.separation*=t)}}else e.height*=t}function $Ue(e,t,i){if(e.markerPlacement&&DUe(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&e.anchorPointUnits==="Absolute"&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size*=t,e.type==="CIMVectorMarker"&&e.markerGraphics)for(const r of e.markerGraphics)e.scaleSymbolsProportionally||fpe(r.symbol,t,!0,i)}function DUe(e,t){switch(IUe(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}function LUe(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const i=e.dashTemplate.map(r=>r*t);e.dashTemplate=i}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}new OUe(1e3);new Qe([128,128,128]);const MQ=/\/resource\/(.*?)\.svg$/,NUe=new Qe("white");function FUe(e,t){const i=t.resource.href;return!ue("esri-canvas-svg-support")&&e.styleOrigin&&MQ.test(i)?i.replace(MQ,"/resource/png/$1.png"):i}function vD(e,t){if(t==null)return e;const i=e.toRgba();return i[3]=i[3]*t,new Qe(i)}function UUe(e,t,i){const r=e.symbolLayers;if(!r)return;const s=n=>{const o=_(n)?n:null;return vD(t=t||o||i!=null&&NUe,i)};r.forEach(n=>{if(n.type!=="object"||n.resource.href==null||t)if(n.type==="water")n.color=s(n.color);else{const o=_(n.material)?n.material.color:null,a=s(o);O(n.material)?n.material=new nc({color:a}):n.material.color=a,i!=null&&"outline"in n&&_(n.outline)&&_(n.outline.color)&&(n.outline.color=vD(n.outline.color,i))}})}function kUe(e,t,i){(t=t||e.color)&&(e.color=vD(t,i)),i!=null&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=vD(e.outline.color,i))}function R5(e,t,i){e&&(t||i!=null)&&(t&&(t=new Qe(t)),oC(e)?UUe(e,t,i):qG(e)&&kUe(e,t,i))}async function zUe(e,t){const i=e.symbolLayers;i&&await ZL(i,async r=>BUe(r,t))}async function BUe(e,t){switch(e.type){case"extrude":GUe(e,t);break;case"icon":case"line":case"text":VUe(e,t);break;case"path":HUe(e,t);break;case"object":await jUe(e,t)}}function VUe(e,t){const i=mpe(t);_(i)&&(e.size=i)}function mpe(e){for(const t of e)if(typeof t=="number")return t;return null}function GUe(e,t){e.size=typeof t[2]=="number"?t[2]:0}async function jUe(e,t){const{resourceSize:i,symbolSize:r}=await qUe(e),s=gpe(t,i,r);e.width=SA(t[0],r[0],i[0],s),e.depth=SA(t[1],r[1],i[1],s),e.height=SA(t[2],r[2],i[2],s)}function HUe(e,t){const i=gpe(t,Kd,[e.width,void 0,e.height]);e.width=SA(t[0],e.width,1,i),e.height=SA(t[2],e.height,1,i)}function gpe(e,t,i){for(let r=0;r<3;r++){const s=e[r];switch(s){case"symbol-value":return i[r]!=null?i[r]/t[r]:1;case"proportional":break;default:if(s&&t[r])return s/t[r]}}return 1}async function qUe(e){const t=await import("./symbolLayerUtils.1d86b8f6.js"),i=await t.computeObjectLayerResourceSize(e,10),{width:r,height:s,depth:n}=e,o=[r,n,s];let a=1;for(let l=0;l<3;l++)if(o[l]!=null){a=o[l]/i[l];break}for(let l=0;l<3;l++)o[l]==null&&(o[l]=i[l]*a);return{resourceSize:i,symbolSize:o}}function SA(e,t,i,r){switch(e){case"proportional":return i*r;case"symbol-value":return t!=null?t:i;default:return e}}function WUe(e,t){const i=mpe(t);if(!O(i))switch(e.type){case"simple-marker":e.size=i;break;case"picture-marker":{const r=e.width/e.height;r>1?(e.width=i,e.height=i*r):(e.width=i*r,e.height=i);break}case"simple-line":e.width=i;break;case"text":e.font.size=i}}async function XUe(e,t){if(e&&t)return oC(e)?zUe(e,t):void(qG(e)&&WUe(e,t))}function YUe(e,t,i){if(e&&t!=null)if(oC(e)){const r=e.symbolLayers;r&&r.forEach(s=>{if(s&&s.type==="object")switch(i){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}})}else qG(e)&&(e.type!=="simple-marker"&&e.type!=="picture-marker"&&e.type!=="text"||(e.angle=t))}function ype(e){return e&&"opacity"in e?e.opacity*ype(e.parent):1}async function ZUe(e,t){var i,r;if(!e)return;const s=e.sourceLayer,n=(i=_(t)&&(r=t.useSourceLayer)!=null&&r?s:e.layer)!=null?i:s,o=ype(n);if(_(e.symbol)&&(!_(t)||t.ignoreGraphicSymbol!==!0)){const S=e.symbol.type==="web-style"?await e.symbol.fetchSymbol(_(t)?t.abortOptions:null):e.symbol.clone();return R5(S,null,o),S}const a=_(t)&&t.renderer||n&&"renderer"in n&&n.renderer;let l=a&&"getSymbolAsync"in a?await a.getSymbolAsync(e,t):null;if(!l)return;if(l=l.type==="web-style"?await l.fetchSymbol(_(t)?t.abortOptions:null):l.clone(),!("visualVariables"in a)||!a.visualVariables||!a.visualVariables.length)return R5(l,null,o),l;if("arcadeRequiredForVisualVariables"in a&&a.arcadeRequiredForVisualVariables&&(O(t)||O(t.arcade))){const S=I({},t);S.arcade=await cp(),t=S}const c=await Promise.resolve().then(function(){return BNe}),h=[],p=[],f=[],g=[];for(const S of a.visualVariables)switch(S.type){case"color":h.push(S);break;case"opacity":p.push(S);break;case"rotation":g.push(S);break;case"size":S.target||f.push(S)}const y=!!h.length&&h[h.length-1],v=y?c.getColor(y,e,t):null,b=!!p.length&&p[p.length-1];let w=b?c.getOpacity(b,e,t):null;if(o!=null&&(w=w!=null?w*o:o),R5(l,v,w),f.length){const S=c.getAllSizes(f,e,t);await XUe(l,S)}for(const S of g)YUe(l,c.getRotationAngle(S,e,t),S.axis);return l}class PQ{constructor(t=i=>i.values().next().value){this._peeker=t,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let t;for(t of this._items);return t}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(t){this.contains(t)||this._items.add(t)}contains(t){return this._items.has(t)}pop(){if(this.length===0)return;const t=this.peek();return this._items.delete(t),t}popLast(){if(this.length===0)return;const t=this.last();return this._items.delete(t),t}remove(t){this._items.delete(t)}filter(t){return this._items.forEach(i=>{t(i)||this._items.delete(i)}),this}}const QUe=ue("mac")?"Meta":"Ctrl",FN={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let e=48;e<58;e++)FN[e]=String.fromCharCode(e);for(let e=1;e<25;e++)FN[111+e]=`F${e}`;for(let e=65;e<91;e++)FN[e]=[String.fromCharCode(e+32),String.fromCharCode(e)];function JUe(e){if(e.key!==void 0)return l_(e);const t=FN[e.keyCode];return Array.isArray(t)?e.shiftKey?t[1]:t[0]:t}function KUe(e){switch(e){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}class eke{constructor(t,i=[]){this.eventType=t,this.keyModifiers=i}matches(t){if(t.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const i=t.modifiers;for(const r of this.keyModifiers)if(!i.has(r))return!1;return!0}}const IQ=he.getLogger("esri.views.input.InputHandler");class jn{constructor(t){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=t}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const t in this._incoming){const i=this._incoming[t];for(const r of i)this._incomingEventMatches.push(r.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(t=>t.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(t){this._manager?IQ.error("This InputHandler has already been registered with an InputManager"):(t.setEventCallback(i=>this._handleEvent(i)),t.setUninstallCallback(()=>this._onUninstall()),this._manager=t)}onUninstall(){}registerIncoming(t,i,r){let s;typeof i=="function"?(r=i,s=[]):s=i||[];const n=typeof t=="string"?new eke(t,s):t,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new tke(n,r,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&p.indexOf(h)===-1&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(t){if(this._outgoing[t])throw Error("There is already a callback registered for this outgoing InputEvent: "+t);const i=new ike(t,{onEmit:(r,s,n,o)=>{this._manager.emit(r.eventType,s,n,o)},onRemove:r=>{delete this._outgoing[r.eventType],this._manager.updateDependencies()}});return this._outgoing[t]=i,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),i}startCapturingPointer(t){this._manager.setPointerCapture(t,!0)}stopCapturingPointer(t){this._manager.setPointerCapture(t,!1)}refreshHasPendingInputs(){this._manager.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):IQ.error("This InputHandler is not registered with an InputManager")}_handleEvent(t){const i=this._incoming[t.type];if(i){for(const r of i)if(r.match.matches(t)&&(r.callback(t),t.shouldStopPropagation()))break}}}class tke{constructor(t,i,r){this.match=t,this._callback=i,this._handler=r}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class ike{constructor(t,i){this.eventType=t,this._removed=!1,this._handler=i}emit(t,i,r){this._removed||this._handler.onEmit(this,t,i,r)}remove(){this._removed=!0,this._handler.onRemove(this)}}class rke extends jn{constructor(t){super(!0),this._onChange=t,this._value="mouse",this.registerIncoming("pointer-down",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler=this.registerIncoming("pointer-move",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler.pause()}_setValue(t){t!==this._value&&(t==="touch"?this._moveHandler.resume():this._moveHandler.pause(),this._value=t,this._onChange(t))}}const O5=he.getLogger("esri.views.input.InputManager");let Gv=class extends we{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=QUe,this.latestPointerType="mouse",this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource=null,this._currentPropagation=null}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}installHandlers(e,t,i=qy.INTERNAL){if(this._nameToGroup[e])return void O5.error("There is already an InputHandler group registered under the name `"+e+"`");if(t.length===0)return void O5.error("Can't register a group of zero handlers");const r={name:e,handlers:t.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=r;for(let s=r.handlers.length-1;s>=0;s--){const n=r.handlers[s];this._handlers.push(n),n.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,a,l,c,h)=>{this._emitInputEvent(n.priorityIndex+1,o,a,l,h,c)},setPointerCapture:(o,a)=>{this._setPointerCapture(r,n,o,a)},setEventCallback:o=>{n.eventCallback=o},setUninstallCallback:o=>{n.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):O5.error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let s=r.handler.hasSideEffects;if(!s){for(const n of r.handler.outgoingEventTypes)if(e.has(n)){s=!0;break}}if(s)for(const n of r.handler.incomingEventMatches){e.add(n.eventType);for(const o of n.keyModifiers)KUe(o)||t.add(o)}r.active=s}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointerType(e){this._set("latestPointerType",e)}_onEventReceived(e,t){if(e==="pointer-capture-lost"){const s=t;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(e,t);const i=this.test.timestamp!=null?this.test.timestamp:t.native?t.native.timestamp:void 0,r=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{if(!i){const o=new Set;this._activeKeyModifiers.forEach(a=>{o.add(a)}),this._activeKeyModifiers=o,i=!0}},s=(o,a)=>{a&&!this._activeKeyModifiers.has(o)?(r(),this._activeKeyModifiers.add(o)):!a&&this._activeKeyModifiers.has(o)&&(r(),this._activeKeyModifiers.delete(o))};if(e==="key-down"||e==="key-up"){const o=t.key;this._keyModifiers.has(o)&&s(o,e==="key-down")}const n=t.native;s("Alt",!(!n||!n.altKey)),s("Ctrl",!(!n||!n.ctrlKey)),s("Shift",!(!n||!n.shiftKey)),s("Meta",!(!n||!n.metaKey)),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerTypeHandler=new rke(e=>this._setLatestPointerType(e)),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,qy.INTERNAL),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],qy.INTERNAL)}_setPointerCapture(e,t,i,r){const s=e.name+"-"+t.priorityIndex,n=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,n),r?(n.add(s),n.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):n.has(s)&&(n.delete(s),n.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,s,n){const o=r!==void 0?r:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=s!==void 0&&s,l={event:new ske(t,i,o,n||this._activeKeyModifiers,a),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(e){this._currentPropagation={events:new PQ,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){const e=this._currentPropagation;if(e){for(;this._currentPropagation.events.length>0;){const{event:t,priorityIndex:i}=this._currentPropagation.events.pop(),r=t.data&&t.data.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback(t),t.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new PQ;for(t.push(e);this._currentPropagation.events.length;)t.push(this._currentPropagation.events.pop());this._currentPropagation.events=t,this._currentPropagation.currentHandler=null}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const r of t.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const s=i.keyModifiers.filter(n=>r.keyModifiers.indexOf(n)!==-1);if(s.length===i.keyModifiers.length!=(s.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let r=0;for(;r<t.length&&this._compareHandlerPriority(i,t[r])>=0;)r++;t.splice(r,0,i)}return t}get debug(){const e=t=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},t(),this._setPointerCapture=i};return{injectEvent:(t,i)=>{e(()=>{this._onEventReceived(t,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],Gv.prototype,"hasPendingInputs",null),u([d()],Gv.prototype,"eventSource",void 0),u([d()],Gv.prototype,"recognizers",void 0),u([d({readOnly:!0})],Gv.prototype,"latestPointerType",void 0),Gv=u([P("esri.views.input.InputManager")],Gv);class ske{constructor(t,i,r,s,n){this.type=t,this.data=i,this.timestamp=r,this.modifiers=s,this.cancelable=n,this._propagationState=ny.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=ny.STOPPED}shouldStopPropagation(){return(this._propagationState&ny.STOPPED)!=0}async(t){this._propagationState|=ny.PAUSED;const i=(r,s)=>{this._propagationState&=~ny.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw r;return r};return(typeof t=="function"?t():t).then(r=>i(r,!1),r=>i(r,!0))}shouldPausePropagation(t){return!!(this._propagationState&ny.PAUSED)&&(this._resumeCallback=t,!0)}preventDefault(){this.data.native.preventDefault()}}var ny;(function(e){e[e.NONE=0]="NONE",e[e.STOPPED=1]="STOPPED",e[e.PAUSED=2]="PAUSED"})(ny||(ny={}));const qy={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};function nke(e){return e&&typeof e.highlight=="function"}function oke(e){return e&&typeof e.maskOccludee=="function"}function bpt(e,t,i){return O(e)||e>i&&(t===0||e<t)}function wpt(e,t){return e>0||t>0}function xpt(e){var t,i;const r=e.effectiveScaleRange;return{minScale:(t=r==null?void 0:r.minScale)!=null?t:0,maxScale:(i=r==null?void 0:r.maxScale)!=null?i:0}}const UN={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},I_=new QT({id:"zoom-to-feature",title:"{messages.zoom}",className:UN.iconZoom}),$Q=new QT({id:"remove-selected-feature",title:"{messages.remove}",className:UN.iconTrash}),sx=new QT({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:UN.iconZoom}),nx=new QT({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:UN.iconBrowseClusteredFeatures}),ake="esri.widgets.Popup.PopupViewModel",l0=he.getLogger(ake),lke=function(e){const{event:t,view:i}=e,{action:r}=t,s=i&&i.popup;if(!r)return Promise.reject(new Q("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new Q("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=r;if(!o)return Promise.reject(new Q("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new Q("trigger-action:invalid-action","Action is disabled"));if(o===I_.id)return uke(s.viewModel).catch(Zk);if(o===sx.id)return hke(s.viewModel);if(o===nx.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===$Q.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new Q(`trigger-action:${$Q.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):i.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function vpe(e){const{selectedFeature:t,location:i,view:r}=e;return r?r.type==="3d"?t||i:e.get("selectedFeature.geometry")||i:null}function cke(e,t){if((t==null?void 0:t.type)!=="3d"||!e||e.declaredClass!=="esri.Graphic")return!0;const i=t.getViewForGraphic(e);if(i&&"whenGraphicBounds"in i){let r=!1;return i.whenGraphicBounds(e,{useViewElevation:!0}).then(s=>{r=!s||!s.boundingBox||s.boundingBox[0]===s.boundingBox[3]&&s.boundingBox[1]===s.boundingBox[4]&&s.boundingBox[2]===s.boundingBox[5]}).catch(()=>{const s=new Q("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});l0.error(s)}),r}return!0}async function uke(e){const{location:t,selectedFeature:i,view:r,zoomFactor:s}=e,n=vpe(e);if(!n){const c=new Q("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:r});return l0.error(c),Promise.reject(c)}const o=r.scale/s,a=e.get("selectedFeature.geometry")||t,l=a&&a.type==="point"&&cke(i,r);I_.active=!0,I_.disabled=!0;try{await e.view.goTo({target:n,scale:l?o:void 0})}finally{I_.active=!1,I_.disabled=!1,e.zoomToLocation=null,l&&(e.location=a)}}async function hke(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new Q("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw l0.error(a),a}if(!t.isAggregate){const a=new Q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw l0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],sx.active=!0,sx.disabled=!0;const{extent:o}=await s.queryExtent(n);await i.goTo({target:o}),sx.active=!1,sx.disabled=!1}async function dke(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new Q("displayClusterExtent:invalid-view","View must be 2d MapView.",{view:i});throw l0.error(a),a}if(!t.isAggregate){const a=new Q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw l0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()];const{extent:o}=await s.queryExtent(n);e.selectedClusterBoundaryFeature.geometry=o,i.graphics.add(e.selectedClusterBoundaryFeature)}async function pke(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new Q("browseAggregateFeatures:invalid-view","View must be 2d MapView.",{view:i});throw l0.error(a),a}if(!t.isAggregate){const a=new Q("browseAggregateFeatures:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw l0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],nx.active=!0,nx.disabled=!0;const{features:o}=await s.queryFeatures(n);nx.active=!1,nx.disabled=!1,i.popup.open({features:[t].concat(o),featureMenuOpen:!0})}function fke(e){var t;(t=e.selectedFeature)!=null&&t.isAggregate&&(e.features=e.features.filter(i=>i.isAggregate))}const _pe=e=>{let t=class extends e{constructor(...i){super(...i),this.goToOverride=null,this.view=null}callGoTo(i){const{view:r}=this;return this.goToOverride?this.goToOverride(r,i):r.goTo(i.target,i.options)}};return u([d()],t.prototype,"goToOverride",void 0),u([d()],t.prototype,"view",void 0),t=u([P("esri.widgets.support.GoTo")],t),t},EA=pt.ofType({key:"type",defaultKeyValue:"button",base:FL,typeMap:{button:QT,toggle:goe}}),mke=()=>[I_.clone()],gke=()=>[sx.clone(),nx.clone()],bpe="esri.widgets.Popup.PopupViewModel",DQ=he.getLogger(bpe);let li=class extends _pe(dpe){constructor(e){super(e),this._handles=new Bt,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new EA,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new Bo({symbol:new q1({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}get isLoadingFeature(){return this.featureViewModels.some(e=>e.waitingForContent)}initialize(){this._handles.add([Wt(this,["autoOpenEnabled","view"],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),rr(this,["highlightEnabled","selectedFeature","visible","view"],()=>this._highlightFeature()),rr(this,"view.animation.state",e=>this._animationStateChange(e)),rr(this,"location",e=>this._locationChange(e)),rr(this,"selectedFeature",e=>this._selectedFeatureChange(e)),rr(this,["selectedFeatureIndex","featureCount","featuresPerPage"],()=>this._selectedFeatureIndexChange()),rr(this,["featurePage","selectedFeatureIndex","featureCount","featuresPerPage, featureViewModels"],()=>this._setGraphicOnFeatureViewModels()),rr(this,"featureViewModels",()=>this._featureViewModelsChange()),this.on("trigger-action",e=>lke({event:e,view:this.view})),X$(this,"waitingForResult",()=>this._waitingForResultChange(),!0),rr(this,["features","view","view.map","view.spatialReference"],()=>this._updateFeatureVMs()),rr(this,["view.scale"],this._viewScaleChange),X$(this,"visible",()=>this.browseClusterEnabled=!1),rr(this,"browseClusterEnabled",e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new EA;e.removeAll();const{actions:t,defaultActions:i,defaultPopupTemplateEnabled:r,includeDefaultActions:s,selectedFeature:n}=this,o=s?i.concat(t):t,a=n&&(typeof n.getEffectivePopupTemplate=="function"&&n.getEffectivePopupTemplate(r)||n.popupTemplate),l=a&&a.actions,c=a&&a.overwriteActions?l:l?l.concat(o):o;return c&&c.filter(Boolean).forEach(h=>e.add(h)),e}get defaultActions(){var e;const t=this._get("defaultActions")||new EA;return t.removeAll(),t.addMany((e=this.selectedFeature)!=null&&e.isAggregate?gke():mke()),t}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:i,promiseCount:r,selectedFeatureIndex:s}=this,n=r&&t.length;n&&i&&s===-1?this.selectedFeatureIndex=0:n&&s!==-1||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=Kf(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach(t=>{this._pendingPromises.add(t);const i=s=>{this._pendingPromises.has(t)&&this._updateFeatures(s),this._updatePendingPromises(t)},r=()=>this._updatePendingPromises(t);t.then(i,r)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return t===-1?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=vpe(this);if(!t){const i=new Q("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return DQ.error(i),Promise.reject(i)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:i}=this;if(!i||!e){const r=new Q("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return DQ.error(r),Promise.reject(r)}return i.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t=me(I({updateLocationEnabled:!1,promises:[],fetchFeatures:!1},e),{visible:!0}),{fetchFeatures:i}=t;delete t.fetchFeatures,i&&this._setFetchFeaturesPromises(t.location);const r=["actionsMenuOpen","collapsed","featureMenuOpen"];for(const s of r)delete t[s];this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){fke(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){await dke(this),await pke(this)}_animationStateChange(e){this.zoomToLocation||(I_.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var e;const t=(e=this.view)==null?void 0:e.graphics;t&&(t.remove(this.selectedClusterBoundaryFeature),t.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){var e;if((e=this.selectedFeature)!=null&&e.isAggregate)return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.browseClusterEnabled=!1,this.features=[this.selectedFeature])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:i}=this;i&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:i,featuresPerPage:r,featureViewModels:s}=this;if(i===null)return;const n=((i-1)*r+t)%t,o=n+r;s.slice(n,o).forEach((a,l)=>{a&&!a.graphic&&(a.graphic=e[n+l])})}async _selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:i,view:r}=this;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),e.isAggregate?void 0:(e.symbol=await ZUe(e),this._selectedClusterFeature=e,void r.graphics.add(this._selectedClusterFeature));!i&&t||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then(()=>{this.location=r.center.clone()}):this.location=this._getPointFromGeometry(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then(t=>{const{clientOnlyGraphics:i,promisesPerLayerView:r}=t,s=Promise.resolve(i),n=r.map(o=>o.promise);this.promises=[s,...n]})}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:i}=this;if(e!=null&&e.isAggregate||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t||!t.length)return;const r=i.slice(0),s=[];t.forEach((n,o)=>{if(!n)return;let a=null;if(r.some((h,p)=>(h&&h.graphic===n&&(a=h,r.splice(p,1)),!!a)),a)s[o]=a;else{var l,c;const h=new Cj({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(l=this.view)==null?void 0:l.spatialReference,graphic:n===e?n:null,map:(c=this.view)==null?void 0:c.map,view:this.view});s[o]=h}}),r.forEach(n=>n&&!n.destroyed&&n.destroy()),this._set("featureViewModels",s)}_getScreenPoint(e){const{view:t}=this;return t&&e&&typeof t.toScreen=="function"?t.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:i}=this;if(t.remove(e),i&&this.view){const r=this.view.on("click",s=>{s.pointerType==="mouse"&&s.button!==0||this._fetchFeaturesAndOpen(s)},qy.WIDGET);t.add(r,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const i=new AbortController,{signal:r}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const s=this.fetchFeatures(e,{signal:r,event:t});return s.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),s}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:i}=e,{view:r}=this;this._fetchFeaturesWithController(t,e).then(s=>{const{clientOnlyGraphics:n,promisesPerLayerView:o,location:a}=s,l=[Promise.resolve(n),...o.map(c=>c.promise)];return r.popup.open({location:a||i,promises:l}),s})}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_getPointFromGeometry(e){return O(e)?null:e.type==="point"?e:e.type==="extent"?e.center:e.type==="polygon"?e.centroid:e.type==="multipoint"||e.type==="polyline"?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:i,view:r,visible:s}=this;if(!(t&&r&&i&&s))return;let{layer:n,sourceLayer:o}=t;if((o==null?void 0:o.type)!=="map-notes"&&(o==null?void 0:o.type)!=="subtype-group"||(n=o),!(n&&n instanceof gj))return;const a=this._getLayerView(r,n);this._highlightPromise=a;const l=await a;if(!(l&&nke(l)&&this._highlightPromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const c=n.type==="imagery"?void 0:"objectIdField"in n&&n.objectIdField,h=t.attributes,p=h&&c&&h[c],f=l.highlight(p||t);this._handles.add(f,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const i=e.filter(r=>t.indexOf(r)===-1);this.features=t.concat(i)}};u([d()],li.prototype,"featurePage",void 0),u([d()],li.prototype,"isLoadingFeature",null),u([d({type:EA})],li.prototype,"actions",void 0),u([d({readOnly:!0})],li.prototype,"active",null),u([d({readOnly:!0})],li.prototype,"allActions",null),u([d({type:Boolean})],li.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],li.prototype,"autoCloseEnabled",void 0),u([d()],li.prototype,"autoOpenEnabled",void 0),u([d()],li.prototype,"browseClusterEnabled",void 0),u([d()],li.prototype,"content",void 0),u([d({type:EA,readOnly:!0})],li.prototype,"defaultActions",null),u([d({readOnly:!0})],li.prototype,"featureCount",null),u([d()],li.prototype,"features",null),u([d()],li.prototype,"featuresPerPage",void 0),u([d()],li.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],li.prototype,"featureViewModels",void 0),u([d()],li.prototype,"highlightEnabled",void 0),u([d()],li.prototype,"includeDefaultActions",void 0),u([d({type:Ke})],li.prototype,"location",null),u([d({readOnly:!0})],li.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],li.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],li.prototype,"waitingForResult",null),u([d({readOnly:!0})],li.prototype,"promiseCount",null),u([d()],li.prototype,"promises",null),u([d({value:null,readOnly:!0})],li.prototype,"selectedFeature",null),u([d({value:-1})],li.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],li.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],li.prototype,"state",null),u([d()],li.prototype,"title",void 0),u([d()],li.prototype,"updateLocationEnabled",void 0),u([d()],li.prototype,"view",void 0),u([d()],li.prototype,"visible",void 0),u([d()],li.prototype,"zoomFactor",void 0),u([d()],li.prototype,"zoomToLocation",void 0),u([d()],li.prototype,"centerAtLocation",null),li=u([P(bpe)],li);const wpe=li,LQ="selected-index",yke=0,NQ="popup-spinner",Oe={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",featureMenuObserver:"esri-popup__feature-menu-observer",featureMenuLoader:"esri-popup__feature-menu-loader",collapseButton:"esri-popup__collapse-button"},FQ={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},UQ="esri-popup";function Fp(e,t){return t===void 0?`${UQ}__${e}`:`${UQ}__${e}-${t}`}const xpe="esri.widgets.Popup",kQ=he.getLogger(xpe),zQ={closeButton:!0,featureNavigation:!0};let _t=class extends hpe(Ra){constructor(e,t){super(e,t),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new Bt,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverCallback=([i])=>{i!=null&&i.isIntersecting&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=T7(()=>this._displaySpinner(),yke),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.headingLevel=2,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new wpe,this.visible=null,this.visibleElements=I({},zQ),this._addSelectedFeatureIndexHandle(),this.own([rr(this,"viewModel.screenLocation",()=>this._positionContainer()),rr(this,["viewModel.active","dockEnabled"],()=>this._toggleScreenLocationEnabled()),rr(this,"viewModel.screenLocation",(i,r)=>{!!i!=!!r&&this.reposition()}),rr(this,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],()=>this.reposition()),rr(this,"spinnerEnabled",i=>this._spinnerEnabledChange(i)),rr(this,"viewModel.view.size",(i,r)=>this._updateDockEnabledForViewSize(i,r)),rr(this,"viewModel.view",(i,r)=>this._viewChange(i,r)),rr(this,"viewModel.view.ready",(i,r)=>this._viewReadyChange(i,r)),rr(this,["viewModel.waitingForResult","viewModel.location"],()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),rr(this,["selectedFeatureWidget.viewModel.title","selectedFeatureWidget.viewModel.state"],()=>this._setTitleFromFeatureWidget()),rr(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.state"],()=>this._setContentFromFeatureWidget()),X$(this,"collapsed",()=>{var i,r;((i=this.viewModel)==null||(r=i.view)==null?void 0:r.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),mp(this,"viewModel.allActions","change",()=>this._watchActions()),Wt(this,"viewModel.allActions",()=>this._watchActions()),rr(this,"viewModel.featureViewModels",()=>this._featureMenuViewportScrollTop())])}destroy(){var e,t;this._destroySelectedFeatureWidget(),this._destroySpinner(),(e=this._handles)==null||e.destroy(),this._unobserveFeatureMenuObserver(),(t=this._featureMenuIntersectionObserver)==null||t.disconnect(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var e,t,i,r,s,n,o;return!!(this.selectedFeatureWidget?((e=this.selectedFeatureWidget)==null||(t=e.viewModel)==null?void 0:t.waitingForContent)||((i=this.selectedFeatureWidget)==null||(r=i.viewModel)==null?void 0:r.state)==="error"||((s=this.selectedFeatureWidget)==null||(n=s.viewModel)==null?void 0:n.content):(o=this.viewModel)==null?void 0:o.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||FQ}set dockOptions(e){const t=I({},FQ),i=this.get("viewModel.view.breakpoints"),r={};i&&(r.width=i.xsmall,r.height=i.xsmall);const s=I(I({},t),e),n=I(I({},t.breakpoint),r),{breakpoint:o}=s;o===!0?s.breakpoint=n:typeof o=="object"&&(s.breakpoint=I(I({},n),o)),this._set("dockOptions",s),this._setCurrentDockPosition(),this.reposition()}get selectedFeatureWidget(){const{_feature:e,visibleElements:t,headingLevel:i}=this,{selectedFeatureViewModel:r}=this.viewModel,s=me(I({},t),{title:!1});return r?(e?(e.viewModel=r,e.visibleElements=s):this._feature=new AUe({headingLevel:i+1,viewModel:r,visibleElements:s}),this._feature):null}castVisibleElements(e){return I(I({},zQ),e)}blur(){const{active:e}=this.viewModel;e||kQ.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||kQ.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var t,i;this._handles.remove(LQ);const r=!!e&&!!e.featureMenuOpen,s=!!e&&!!e.actionsMenuOpen,n={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:s,featureMenuOpen:r};((t=this.viewModel)==null||(i=t.view)==null?void 0:i.widthBreakpoint)==="xsmall"&&(n.collapsed=!0),this.set(n),this.viewModel.open(e),this._shouldFocus(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){this.viewModel.triggerAction(e)}render(){var e,t,i,r;const{actionsMenuOpen:s,dockEnabled:n,featureMenuVisible:o,dividedActions:a,currentAlignment:l,currentDockPosition:c}=this,{active:h}=this.viewModel,{menuActions:p}=a,f=h&&p.length>1&&s,g=h&&n,y=h&&!n,v=(e=this.selectedFeature)==null||(t=e.layer)==null?void 0:t.title,b=(i=this.selectedFeature)==null||(r=i.layer)==null?void 0:r.id,w={[Oe.alignTopCenter]:l==="top-center",[Oe.alignBottomCenter]:l==="bottom-center",[Oe.alignTopLeft]:l==="top-left",[Oe.alignBottomLeft]:l==="bottom-left",[Oe.alignTopRight]:l==="top-right",[Oe.alignBottomRight]:l==="bottom-right",[Oe.isDocked]:g,[Oe.shadow]:y,[Oe.isDockedTopLeft]:c==="top-left",[Oe.isDockedTopCenter]:c==="top-center",[Oe.isDockedTopRight]:c==="top-right",[Oe.isDockedBottomLeft]:c==="bottom-left",[Oe.isDockedBottomCenter]:c==="bottom-center",[Oe.isDockedBottomRight]:c==="bottom-right",[Oe.isFeatureMenuOpen]:o,[Oe.isActionsMenuOpen]:f};return le("div",{class:this.classes(Oe.base,w),role:"presentation","data-layer-title":v,"data-layer-id":b,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},h?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,Oe.iconLoading,Oe.rotating)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?le("div",{key:Fp("loading-container"),role:"presentation",class:Oe.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=Py(this.container),t={[Oe.iconRightTriangleArrow]:e,[Oe.paginationPreviousIconRTL]:e,[Oe.iconLeftTriangleArrow]:!e,[Oe.paginationPreviousIconLTR]:!e};return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,t)})}renderPreviousButton(){const{messages:e}=this;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Oe.button,Oe.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=Py(this.container),t={[Oe.iconLeftTriangleArrow]:e,[Oe.paginationNextIconRTL]:e,[Oe.iconRightTriangleArrow]:!e,[Oe.paginationNextIconLTR]:!e};return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,t)})}renderNextButton(){const{messages:e}=this;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Oe.button,Oe.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:i}=this,{featureCount:r,selectedFeatureIndex:s}=this.viewModel;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Oe.button,Oe.featureMenuButton),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(r,s))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:e}=this,t=this._wouldDockTo(),i={[Oe.iconUndock]:e,[Oe.iconDock]:!e,[Oe.iconDockToRight]:!e&&(t==="top-right"||t==="bottom-right"),[Oe.iconDockToLeft]:!e&&(t==="top-left"||t==="bottom-left"),[Oe.iconDockToTop]:!e&&t==="top-center",[Oe.iconDockToBottom]:!e&&t==="bottom-center"};return le("span",{"aria-hidden":"true",class:this.classes(i,Oe.icon)})}renderDockButton(){var e,t,i;const{dockEnabled:r,messages:s}=this,n=(e=this.viewModel)==null||(t=e.view)==null?void 0:t.widthBreakpoint,o=r?s.undock:s.dock;return n!=="xsmall"&&(i=this.dockOptions)!=null&&i.buttonEnabled?le("div",{role:"button","aria-label":o,title:o,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Oe.button,Oe.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:t,collapsible:i,contentCollapsed:r,messagesCommon:s}=this,n={[Oe.headerContainerButton]:i},o=le(D7,{level:this.headingLevel,class:Oe.headerTitle,innerHTML:e}),a=i?le("button",{key:`${e}--collapsible`,id:t,title:r?s.expand:s.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Oe.headerContainer,n),"aria-expanded":r?"false":"true",onclick:this._toggleCollapsed,type:"button"},o):le("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Oe.headerContainer,n)},o);return e?a:null}renderCloseIcon(){return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,Oe.iconClose)})}renderCloseButton(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?le("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Oe.button,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return le("header",{class:Oe.header},this.renderTitle(),le("div",{class:Oe.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:t,contentCollapsed:i}=this,{content:r}=this.viewModel;return t&&!i?le("article",{key:r,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:Oe.content},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r,messagesCommon:s}=this,n=i?s.close:s.open,{menuActions:o}=r;return o.length?le("div",{key:Fp("actions-menu-button"),class:this.classes(Oe.button,Oe.actionsMenuButton),role:"button",id:t,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":n,title:n},le("span",{"aria-hidden":"true",class:Oe.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r}=this,{menuActions:s}=r;return s.length&&i?le("ul",{id:e,role:"menu","aria-labelledby":t,key:Fp("actions"),class:Oe.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},s.toArray().map(n=>this.renderAction({action:n,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(t=>this.renderAction({action:t,type:"inline"}))}renderInlineActionsContainer(){const{inlineActions:e,menuActions:t}=this.dividedActions,i=!!e.length,r=!!t.length;return i||r?le("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":r.toString(),class:Oe.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?le("section",{key:Fp("navigation"),class:this.classes(Oe.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:i,menuActions:r}=t,s=!!i.length,n=!!r.length,o={[Oe.footerHasPagination]:e,[Oe.footerHasActions]:s,[Oe.footerHasActionsMenu]:n};return e||s?le("div",{key:Fp("feature-buttons"),class:this.classes(Oe.footer,o)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:t,isLoadingFeature:i}=this.viewModel,r=lf(e.selectedFeatures,{total:t.length});return le("section",{key:Fp("menu"),class:Oe.featureMenu},le("strong",{class:Oe.featureMenuHeader},r),le("nav",{bind:this,class:Oe.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:dB},this.renderFeatureMenu(),le("div",{class:Oe.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?le("div",{class:Oe.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:le("div",{key:Fp("pointer"),class:Oe.pointer,role:"presentation"},le("div",{class:this.classes(Oe.pointerDirection,Oe.shadow)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:i,titleId:r,contentId:s,collapsible:n,hasContent:o,contentCollapsed:a,visibleElements:l}=this,{title:c}=this.viewModel,h=t==="bottom-left"||t==="bottom-center"||t==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",p=t==="top-left"||t==="top-center"||t==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",f={[Oe.shadow]:e,[Oe.isCollapsible]:n,[Oe.isCollapsed]:a};return le("div",{class:this.classes(Oe.main,Oe.widget,f),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":c?r:"","aria-describedby":o&&!a?s:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},h?this.renderFooter():null,h?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null)}renderContent(){var e;const t=(e=this.viewModel)==null?void 0:e.content;return t?typeof t=="string"?le("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null}renderActionText(e){return le("span",{key:"text",class:Oe.actionText},e)}renderActionIcon(e){const t=this._getActionClass(e),i=this._getActionImage(e),r={[Oe.iconLoading]:e.active,[Oe.rotating]:e.active,[Oe.icon]:!!t,[Oe.actionImage]:!e.active&&!!i};return t&&(r[t]=!e.active),le("span",{key:"icon","aria-hidden":"true",class:this.classes(Oe.icon,r),styles:this._getIconStyles(i)})}renderAction(e){const{action:t,type:i}=e,r=this._getActionTitle(t),s={[Oe.action]:t.type!=="toggle",[Oe.actionToggle]:t.type==="toggle",[Oe.actionToggleOn]:t.type==="toggle"&&t.value,[Oe.buttonDisabled]:t.disabled},n=[this.renderActionIcon(t),this.renderActionText(r)],o=i==="menu-item"?le("li",{key:t.uid,role:"menuitem",tabIndex:0,title:r,"aria-label":r,class:this.classes(Oe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n):le("div",{key:t.uid,role:"button",tabIndex:0,title:r,"aria-label":r,class:this.classes(Oe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n);return t.visible?o:null}renderFeatureMenuItem(e,t){const{messages:i,messagesCommon:r}=this,{selectedFeatureIndex:s,selectedFeatureViewModel:n}=this.viewModel,o=e===n,a={[Oe.featureMenuSelected]:o},l=o?le("span",{key:Fp(`feature-menu-selected-feature-${s}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:Oe.iconCheckMark}):null,c=le("span",{innerHTML:e.title||r.untitled});return le("li",{role:"menuitem",tabIndex:-1,key:Fp(`feature-menu-feature-${s}`),class:this.classes(a,Oe.featureMenuItem),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},le("span",{class:Oe.featureMenuTitle},c,l))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?le("ol",{class:Oe.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.filter(i=>!!i.graphic).map((i,r)=>this.renderFeatureMenuItem(i,r))):null}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:r}=this,{id:s}=e,n=i==null?void 0:i.attributes,o=s==="zoom-to-feature"?lf(e.title,{messages:t}):s==="remove-selected-feature"?lf(e.title,{messages:r}):s==="zoom-to-clustered-features"||s==="browse-clustered-features"?lf(e.title,{messages:t}):e.title;return o&&n?lf(o,n):o}_getActionClass(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{className:r,image:s}=e,n=s||r?r:Oe.iconDefaultAction;return n&&i?lf(n,i):n}_getActionImage(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{image:r}=e;return r&&i?lf(r,i):r}_createFeatureUpdatedAnimation(){return QOe("enter",Oe.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if(typeof e!="number")return null;const i=Math.round(e);return Math.max(t?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach(i=>{this._handles.add(rr(i,["uid","active","className","disabled","id","title","image","visible"],()=>this.scheduleRender()),t)})}_divideActions(){const{allActions:e}=this.viewModel,t=e.filter(n=>n.visible),i=this._getInlineActionCount(),r=i===null,s=i===0;return{inlineActions:r?t.slice(0):s?new pt:t.slice(0,i),menuActions:r?new pt:s?t.slice(0):t.slice(i)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:e,messagesCommon:t}=this;var i,r;e&&(this.viewModel.title=((i=e.viewModel)==null?void 0:i.state)==="error"?t.errorMessage:((r=e.viewModel)==null?void 0:r.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e}_handleFeatureMenuKeyup(e){l_(e)==="Escape"&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){l_(e)==="Escape"&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_handleFeatureMenuItemKeyup(e){const t=l_(e),{_featureMenuNode:i}=this,r=e.currentTarget["data-feature-index"];if(!i)return;const s=i.querySelectorAll("li"),n=s.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),s[s.length-1].focus()):(e.stopPropagation(),s[0].focus()):(e.stopPropagation(),s[(r+1+n)%n].focus()):(e.stopPropagation(),s[(r-1+n)%n].focus())}_handleActionMenuItemKeyup(e){const t=l_(e),{_actionsMenuNode:i}=this,r=e.currentTarget.dataset.actionUid,{menuActions:s}=this.dividedActions,n=s.findIndex(l=>l.uid===r);if(!i)return;const o=i.querySelectorAll("li"),a=o.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),o[o.length-1].focus()):(e.stopPropagation(),o[0].focus()):(e.stopPropagation(),o[(n+1+a)%a].focus()):(e.stopPropagation(),o[(n-1+a)%a].focus())}_handleMainKeyup(e){const t=l_(e);t==="ArrowLeft"&&(e.stopPropagation(),this.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i?e.show({location:t}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}async _shouldFocus(e){e.shouldFocus&&(await P$(()=>{var t;return((t=this.viewModel)==null?void 0:t.active)===!0}),this.focus())}_addSelectedFeatureIndexHandle(){const e=rr(this,"viewModel.selectedFeatureIndex",(t,i)=>this._selectedFeatureIndexUpdated(t,i));this._handles.add(e,LQ)}_selectedFeatureIndexUpdated(e,t){const{featureCount:i}=this;i&&e!==t&&e!==-1&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height}_isOutsideView(e){const{popupHeight:t,popupWidth:i,screenLocation:r,side:s,view:n}=e;if(isNaN(i)||isNaN(t)||!n||!r)return!1;const o=n.padding;return s==="right"&&r.x+i/2>n.width-o.right||s==="left"&&r.x-i/2<o.left||s==="top"&&r.y-t<o.top||s==="bottom"&&r.y+t>n.height-o.bottom}_calculateAutoAlignment(e){if(e!=="auto")return e;const{_pointerOffsetInPx:t,_containerNode:i,_mainContainerNode:r,viewModel:s}=this,{screenLocation:n,view:o}=s;if(O(n)||!o||!i)return"top-center";if(!this._isScreenLocationWithinView(n,o))return this._get("currentAlignment")||"top-center";function a(T){return parseInt(T.replace(/[^-\d\.]/g,""),10)}const l=r?window.getComputedStyle(r,null):null,c=l?a(l.getPropertyValue("max-height")):0,h=l?a(l.getPropertyValue("height")):0,{height:p,width:f}=i.getBoundingClientRect(),g=f+t,y=Math.max(p,c,h)+t,v=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"right",view:o}),b=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"left",view:o}),w=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"top",view:o}),S=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"bottom",view:o});return b?w?"bottom-right":"top-right":v?w?"bottom-left":"top-left":w?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return typeof e=="function"?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return Py(this.container)&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])}_callDockPosition(e){return typeof e=="function"?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((e=this.dockOptions)==null?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var t;if(e!=="auto")return e;const i=(t=this.viewModel)==null?void 0:t.view,r=Py(this.container)?"top-left":"top-right";if(!i)return r;const s=i.padding||{left:0,right:0,top:0,bottom:0},n=i.width-s.left-s.right,{breakpoints:o}=i;return o&&n<=o.xsmall?"bottom-center":r}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:i}=e.getBoundingClientRect(),r=this._calculatePositionStyle(t,i);r&&(e.style.top=r.top,e.style.left=r.left,e.style.bottom=r.bottom,e.style.right=r.right)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:i}=this;return t==="top-left"||t==="bottom-left"||t==="top-right"||t==="bottom-right"?e+i:e}_calculateAlignmentPosition(e,t,i,r){const{currentAlignment:s,_pointerOffsetInPx:n}=this,o=r/2,a=i.height-t,l=i.width-e,{padding:c}=this.view;return s==="bottom-center"?{top:t+n-c.top,left:e-o-c.left}:s==="top-left"?{bottom:a+n-c.bottom,right:l+n-c.right}:s==="bottom-left"?{top:t+n-c.top,right:l+n-c.right}:s==="top-right"?{bottom:a+n-c.bottom,left:e+n-c.left}:s==="bottom-right"?{top:t+n-c.top,left:e+n-c.left}:s==="top-center"?{bottom:a+n-c.bottom,left:e-o-c.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:i,view:r}=this;if(!r)return;if(i)return{left:"",top:"",right:"",bottom:""};if(O(e)||!t)return;const s=this._calculateFullWidth(t),n=this._calculateAlignmentPosition(e.x,e.y,r,s);return n?{top:n.top!==void 0?`${n.top}px`:"auto",left:n.left!==void 0?`${n.left}px`:"auto",bottom:n.bottom!==void 0?`${n.bottom}px`:"auto",right:n.right!==void 0?`${n.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){if(e){const i=this.get("viewModel.view");this._wireUpView(i)}else t&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,i){const[r,s]=e,[n,o]=t,{width:a,height:l}=i;return r<=a&&n>a||r>a&&n<=a||s<=l&&o>l||s>l&&o<=l}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},r=i.left+i.right,s=i.top+i.bottom,n=[],o=[];n[0]=e[0]-r,n[1]=e[1]-s,o[0]=t[0]-r,o[1]=t[1]-s;const{dockOptions:a}=this,l=a.breakpoint;this._dockingThresholdCrossed(n,o,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const i=t.active&&!e;t.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var t,i;const r=e.breakpoint,s=(t=this.viewModel)==null||(i=t.view)==null?void 0:i.ui;if(!s)return!1;const{width:n,height:o}=s;if(isNaN(n)||isNaN(o))return!1;const a=r.hasOwnProperty("width")&&n<=r.width,l=r.hasOwnProperty("height")&&o<=r.height;return a||l}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,t){return this.featureNavigationVisible?lf(this.messages.pageText,{index:t+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,NQ),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new RUe({view:e}),e.ui.add(this._spinner,{key:NQ,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const t=e.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,r=i.findIndex(n=>n.uid===t),s=i.getItemAt(r);s&&s.type==="toggle"&&(s.value=!s.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(r)}_selectFeature(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],_t.prototype,"actionsMenuId",null),u([d({readOnly:!0})],_t.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],_t.prototype,"featureMenuId",null),u([d({readOnly:!0})],_t.prototype,"titleId",null),u([d({readOnly:!0})],_t.prototype,"contentId",null),u([d({readOnly:!0})],_t.prototype,"hasContent",null),u([d({readOnly:!0})],_t.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],_t.prototype,"collapsible",null),u([d({readOnly:!0})],_t.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],_t.prototype,"contentCollapsed",null),u([d({readOnly:!0})],_t.prototype,"dividedActions",null),u([mt("viewModel.actions")],_t.prototype,"actions",void 0),u([d()],_t.prototype,"actionsMenuOpen",null),u([d()],_t.prototype,"alignment",void 0),u([mt("viewModel.autoCloseEnabled")],_t.prototype,"autoCloseEnabled",void 0),u([mt("viewModel.autoOpenEnabled")],_t.prototype,"autoOpenEnabled",void 0),u([mt("viewModel.defaultPopupTemplateEnabled")],_t.prototype,"defaultPopupTemplateEnabled",void 0),u([mt("viewModel.content")],_t.prototype,"content",void 0),u([d()],_t.prototype,"collapsed",void 0),u([d()],_t.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],_t.prototype,"currentAlignment",null),u([d({readOnly:!0})],_t.prototype,"currentDockPosition",null),u([d()],_t.prototype,"dockOptions",null),u([d()],_t.prototype,"dockEnabled",void 0),u([mt("viewModel.featureCount")],_t.prototype,"featureCount",void 0),u([d()],_t.prototype,"featureMenuOpen",void 0),u([mt("viewModel.features")],_t.prototype,"features",void 0),u([mt("viewModel.goToOverride")],_t.prototype,"goToOverride",void 0),u([d()],_t.prototype,"headingLevel",void 0),u([mt("viewModel.highlightEnabled")],_t.prototype,"highlightEnabled",void 0),u([mt("viewModel.location")],_t.prototype,"location",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],_t.prototype,"label",void 0),u([d()],_t.prototype,"maxInlineActions",void 0),u([d(),ul("esri/widgets/Popup/t9n/Popup")],_t.prototype,"messages",void 0),u([d(),ul("esri/t9n/common")],_t.prototype,"messagesCommon",void 0),u([mt("viewModel.promises")],_t.prototype,"promises",void 0),u([mt("viewModel.selectedFeature")],_t.prototype,"selectedFeature",void 0),u([mt("viewModel.selectedFeatureIndex")],_t.prototype,"selectedFeatureIndex",void 0),u([d({readOnly:!0})],_t.prototype,"selectedFeatureWidget",null),u([d()],_t.prototype,"spinnerEnabled",void 0),u([mt("viewModel.title")],_t.prototype,"title",void 0),u([mt("viewModel.updateLocationEnabled")],_t.prototype,"updateLocationEnabled",void 0),u([mt("viewModel.view")],_t.prototype,"view",void 0),u([d({type:wpe}),_3e(["triggerAction","trigger-action"])],_t.prototype,"viewModel",void 0),u([mt("viewModel.visible")],_t.prototype,"visible",void 0),u([d()],_t.prototype,"visibleElements",void 0),u([It("visibleElements")],_t.prototype,"castVisibleElements",null),u([Kc()],_t.prototype,"_close",null),u([Kc()],_t.prototype,"_toggleDockEnabled",null),u([Kc()],_t.prototype,"_toggleFeatureMenu",null),u([Kc()],_t.prototype,"_toggleActionsMenu",null),u([Kc()],_t.prototype,"_triggerAction",null),u([Kc()],_t.prototype,"_selectFeature",null),u([Kc()],_t.prototype,"_next",null),u([Kc()],_t.prototype,"_previous",null),_t=u([P(xpe)],_t);const BQ=_t,M5=[0,0];function vke(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return M5[0]=i.left+t.pageXOffset,M5[1]=i.top+t.pageYOffset,M5}function VQ(e){e&&(Eae(e),e.parentNode&&e.parentNode.removeChild(e))}function _ke(e){const t=document.createElement("div");return e.appendChild(t),t}const YS=16,pM=750,bke=512,wke=2,xke=e=>{let t=class extends e{constructor(...i){super(...i),this._freqInfo={freq:YS,time:pM},this._overlayRenderTaskHandle=null,this.height=0,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.handles.add([this.watch("cursor",r=>{const s=this.surface;s&&s.setAttribute("data-cursor",r)}),this.watch("interacting",r=>{const s=this.surface;s&&s.setAttribute("data-interacting",r.toString())})])}initialize(){this.handles.add(this.watch("ui",(i,r)=>this._handleUIChange(i,r))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}set container(i){const r=this._get("container");if(r===i)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),VQ(this.root),this._set("root",null),pX(this.userContent,r),VQ(this.userContent),this._set("userContent",null)),i){i.classList.add("esri-view");const n=document.createElement("div");n.className="esri-view-user-storage",pX(i,n),i.appendChild(n),this._set("userContent",n);const o=document.createElement("div");o.className="esri-view-root",i.insertBefore(o,i.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const l=new cY;o.appendChild(l.surface),this._set("overlay",l),l.watch("needsRender",c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=e1({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)}),this.forceDOMReadyCycle(),this.handles.add(Nt(()=>this.size,c=>{const[h,p]=c,f="esri-view-surface--inset-outline";h>=document.body.clientWidth||p>=document.body.clientHeight?a.classList.add(f):a.classList.remove(f)},un),s),this._set("container",i),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}get focused(){const i=document.activeElement===this.surface;return document.hasFocus()&&i}get popup(){return this._get("popup")||new BQ({view:this})}set popup(i){const r=this._get("popup");r&&r!==i&&r.destroy(),this._set("popup",i)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(i,r,s){const n=this.position;return i-=n[0],r-=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}containerToPage(i,r,s){const n=this.position;return i+=n[0],r+=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}_handleUIChange(i,r){r&&(this.handles.remove("ui"),r.destroy()),i&&this._wireUI(i),this._set("ui",i)}_wireUI(i){this.handles.remove("ui"),i&&(i.view=this,this.handles.add([Nt(()=>this.root,r=>{i.container=r?_ke(r):null},un),Nt(()=>this.popup,(r,s)=>{const n="popup",o="manual";s&&i.remove(s,n),r&&(r.view=i.view,i.add(r,{key:n,position:o}))},un)],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const i=this._freqInfo;i.freq=YS,i.time=pM,this.handles.add([(()=>{const r=()=>{i.freq=YS,i.time=pM};return window.addEventListener("resize",r),{remove(){window.removeEventListener("resize",r)}}})(),e1({prepare:r=>{const s=this._measure(),n=this._freqInfo;if(n.time+=r.deltaTime,s&&(n.freq=YS,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?YS:Math.min(pM,n.freq*wke),!s&&n.freq>=bke&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const i=this.container,r=i?i.clientWidth:0,s=i?i.clientHeight:0;if(r===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return r===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:r,height:s}),!0)}_position(){const i=this.container,r=this.position,s=vke(i);return(!r||s[0]!==r[0]||s[1]!==r[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d({value:null,cast:i=>QL(i)})],t.prototype,"container",null),u([d({readOnly:!0})],t.prototype,"focused",null),u([d({readOnly:!0})],t.prototype,"height",void 0),u([d({type:BQ})],t.prototype,"popup",null),u([d({type:cY})],t.prototype,"overlay",void 0),u([d({readOnly:!0})],t.prototype,"position",void 0),u([d({readOnly:!0})],t.prototype,"resizing",void 0),u([d({readOnly:!0})],t.prototype,"root",void 0),u([d({value:null,readOnly:!0})],t.prototype,"size",null),u([d({readOnly:!0})],t.prototype,"surface",void 0),u([d({readOnly:!0})],t.prototype,"suspended",void 0),u([d()],t.prototype,"ui",void 0),u([d({readOnly:!0})],t.prototype,"userContent",void 0),u([d({readOnly:!0})],t.prototype,"width",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),t=u([P("esri.views.DOMContainer")],t),t},Rj=he.getLogger("esri.layers.support.ElevationSampler");class Tpe{queryElevation(t){return Spe(t.clone(),this)}on(){return Cke}projectIfRequired(t,i){return Epe(t,i)}}class Tke extends Tpe{constructor(t,i,r){super(),this.tile=t,this.noDataValue=r,this.extent=kL(t.tile.extent,i.spatialReference);const s=bl(i.spatialReference),n=i.lodAt(t.tile.level).resolution*s;this.demResolution={min:n,max:n}}get spatialReference(){return this.extent.spatialReference}contains(t){const i=this.projectIfRequired(t,this.spatialReference);return xR(this.extent,i)}elevationAt(t){const i=this.projectIfRequired(t,this.spatialReference);if(O(i))return null;if(!this.contains(t)){const r=this.extent,s=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return Rj.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler extent (${s})`),this.noDataValue}return this.tile.sample(i.x,i.y)}}class Tpt extends Tpe{constructor(t,i,r){let s;super(),typeof i=="number"?(this.noDataValue=i,s=null):(s=i,this.noDataValue=r),this.samplers=s?t.map(o=>new Tke(o,s,this.noDataValue)):t;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=kL(Dt(),s.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(t){const i=this.projectIfRequired(t,this.spatialReference);if(!i)return null;for(const r of this.samplers)if(r.contains(i))return r.elevationAt(i);return Rj.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler`),this.noDataValue}}function Spe(e,t){const i=Epe(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":Ske(e,i,t);break;case"polyline":Eke(e,i,t);break;case"multipoint":Ake(e,i,t)}return e}function Epe(e,t){if(O(e))return null;const i=e.spatialReference;if(i.equals(t))return e;const r=z1(e,t);return r||Rj.error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),r}function Ske(e,t,i){e.z=gt(i.elevationAt(t),0)}function Eke(e,t,i){Dy.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],o=t.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Dy.x=c[0],Dy.y=c[1],r&&(l[3]=l[2]),l[2]=gt(i.elevationAt(Dy),0)}}e.hasZ=!0}function Ake(e,t,i){Dy.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],o=t.points[s];Dy.x=o[0],Dy.y=o[1],r&&(n[3]=n[2]),n[2]=gt(i.elevationAt(Dy),0)}e.hasZ=!0}const Dy=new Ke,Cke={remove(){}};function _D(e){return e.type==="point"}class Ape{constructor(t,i=null,r=0){this.array=t,this.spatialReference=i,this.offset=r}}function Cpe(e){return"array"in e}function Mh(e,t,i="ground"){if(_D(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(Cpe(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,gt(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}var n8;let Md=n8=class extends ve{constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new n8({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Md.prototype,"cols",void 0),u([d({type:mr,json:{write:!0}})],Md.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],Md.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Md.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],Md.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Md.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],Md.prototype,"scale",void 0),Md=n8=u([P("esri.layers.support.LOD")],Md);const Rpe=Md;var Gg;const GQ=new si({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let on=Gg=class extends ve{constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}static create(e={}){const{resolutionFactor:t=1,scales:i,size:r=256,spatialReference:s=tt.WebMercator,numLODs:n=24}=e;if(!hc(s)){const p=[];if(i)for(let f=0;f<i.length;f++){const g=i[f];p.push({level:f,scale:g,resolution:g})}else{let f=5e-4;for(let g=n-1;g>=0;g--)p.unshift({level:g,scale:f,resolution:f}),f*=2}return new Gg({dpi:96,lods:p,origin:new Ke(0,0,s),size:[r,r],spatialReference:s})}const o=Gy(s),a=e.origin?new Ke({x:e.origin.x,y:e.origin.y,spatialReference:s}):new Ke(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(bl(s)*39.37*l),h=[];if(i)for(let p=0;p<i.length;p++){const f=i[p],g=f*c;h.push({level:p,scale:f,resolution:g})}else{let p=xne(s)?512/r*5916575275917094e-7:256/r*591657527591555e-6;const f=Math.ceil(n/t);h.push({level:0,scale:p,resolution:p*c});for(let g=1;g<f;g++){const y=p/2**t,v=y*c;h.push({level:g,scale:y,resolution:v}),p=y}}return new Gg({dpi:l,lods:h,origin:a,size:[r,r],spatialReference:s})}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const i=Gy(e);return e.isWrappable&&Math.abs(i.origin[0]-t.x)<=i.dx}return!1}readOrigin(e,t){return Ke.fromJSON(I({spatialReference:t.spatialReference},e))}set lods(e){let t=0,i=0;const r=[];this._levelToLOD={},e&&(t=-1/0,i=1/0,e.forEach(s=>{r.push(s.scale),t=s.scale>t?s.scale:t,i=s.scale<i?s.scale:i,this._levelToLOD[s.level]=s})),this._set("scales",r),this._set("minScale",t),this._set("maxScale",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];{const i=Math.floor(e),r=i+1;return t[i]/(t[i]/t[r])**(e-i)}}scaleToZoom(e){const t=this.scales,i=t.length-1;let r=0;for(;r<i;r++){const s=t[r],n=t[r+1];if(s<=e)return r;if(n===e)return r+1;if(s>e&&n<e)return r+Math.log(s/e)/Math.log(s/n)}return r}snapScale(e,t=.95){const i=this.scaleToZoom(e);return i%Math.floor(i)>=t?this.zoomToScale(Math.ceil(i)):this.zoomToScale(Math.floor(i))}tileAt(e,t,i,r){const s=this.lodAt(e);if(!s)return null;let n,o;if(typeof t=="number")n=t,o=i;else if(bc(t.spatialReference,this.spatialReference))n=t.x,o=t.y,r=i;else{const c=z1(t,this.spatialReference);if(O(c))return null;n=c.x,o=c.y,r=i}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return r||(r={id:null,level:0,row:0,col:0,extent:Dt()}),r.level=e,r.row=Math.floor((this.origin.y-o)/l+.001),r.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(r),r}updateTileInfo(e,t=Gg.ExtrapolateOptions.NONE){let i=this.lodAt(e.level);if(!i&&t===Gg.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<e.level&&(i=o)}if(!i)return;const r=e.level-i.level,s=i.resolution*this.size[0]/2**r,n=i.resolution*this.size[1]/2**r;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=Dt()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*n,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+n}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||t.parentLevel===-1)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)}getTileBounds(e,t){const{resolution:i}=this.lodAt(t.level),r=i*this.size[0],s=i*this.size[1];return e[0]=this.origin.x+t.col*r,e[1]=this.origin.y-(t.row+1)*s,e[2]=e[0]+r,e[3]=e[1]+s,e}lodAt(e){return this._levelToLOD&&this._levelToLOD[e]||null}clone(){return Gg.fromJSON(this.write({}))}getOrCreateCompatible(e,t){if(this.size[0]===256&&this.size[1]===256)return e===256?this:null;const i=[],r=this.lods.length;for(let s=0;s<r;s++){const n=this.lods[s],o=n.resolution*t;i.push(new Rpe({level:n.level,scale:n.scale,resolution:o}))}return new Gg({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:i})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let i=0;i<e.length;i++){const r=e[i];this._upsampleLevels[r.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/r.resolution:0},t=r}}};u([d({type:Number,json:{write:!0}})],on.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],on.prototype,"dpi",void 0),u([d({type:String,json:{read:GQ.read,write:GQ.write,origins:{"web-scene":{read:!1,write:!1}}}})],on.prototype,"format",void 0),u([d({readOnly:!0})],on.prototype,"isWrappable",null),u([d({type:Ke,json:{write:!0}})],on.prototype,"origin",void 0),u([Fe("origin")],on.prototype,"readOrigin",null),u([d({type:[Rpe],value:null,json:{write:!0}})],on.prototype,"lods",null),u([d({readOnly:!0})],on.prototype,"minScale",void 0),u([d({readOnly:!0})],on.prototype,"maxScale",void 0),u([d({readOnly:!0})],on.prototype,"scales",void 0),u([d({cast:e=>Array.isArray(e)?e:typeof e=="number"?[e,e]:[256,256]})],on.prototype,"size",void 0),u([Fe("size",["rows","cols"])],on.prototype,"readSize",null),u([Ge("size",{cols:{type:mr},rows:{type:mr}})],on.prototype,"writeSize",null),u([d({type:tt,json:{write:!0}})],on.prototype,"spatialReference",void 0),on=Gg=u([P("esri.layers.support.TileInfo")],on),function(e){var t;(t=e.ExtrapolateOptions||(e.ExtrapolateOptions={}))[t.NONE=0]="NONE",t[t.POWER_OF_TWO=1]="POWER_OF_TWO"}(on||(on={}));const fI=on,Rke=12;class sr{constructor(t){const i=sr.checkUnsupported(t);if(_(i))throw i;const r=t;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=f1(this.spatialReference)||wp(this.spatialReference)||xp(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce(function(c,h,p){return h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c},{min:1/0,minIndex:0,max:-1/0}),n=r.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*r.size[0],a*r.size[1]]},a/=2,l/=2}clone(){return new sr(this.toTileInfo())}toTileInfo(){return new fI({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((t,i)=>({level:i,scale:t.scale,resolution:t.resolution}))})}getExtent(t,i,r,s){const n=this.levels[t],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+r*o,s[2]=s[0]+o,s[3]=this.origin[1]-i*a,s[1]=s[3]-a}convertExtentToRadians(t,i){this._isWebMercator?(i[0]=PW(t[0]),i[1]=w$(t[1]),i[2]=PW(t[2]),i[3]=w$(t[3])):this._isGCS&&(i[0]=Ct(t[0]),i[1]=Ct(t[1]),i[2]=Ct(t[2]),i[3]=Ct(t[3]))}getExtentGeometry(t,i,r,s=new Zt){return this.getExtent(t,i,r,td),s.spatialReference=this.spatialReference,s.xmin=td[0],s.ymin=td[1],s.xmax=td[2],s.ymax=td[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(t){if(t==null)return!1;let i=!1;for(;this.levels.length<=t;){const r=this.levels[this.levels.length-1],s=r.resolution/2;this.levels.push({resolution:s,scale:r.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),i=!0}return i}capMaxLod(t){this.levels.length>t+1&&(this.levels.length=t+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(t){return this.levels[0].scale/2**t}levelAtScale(t){const i=this.levels[0].scale;return t>=i?0:Math.log(i/t)*Math.LOG2E}resolutionAtLevel(t){return this.levels[0].resolution/2**t}compatibleWith(t){if(!(t instanceof sr)){if(sr.checkUnsupported(t))return!1;t=new sr(t)}if(!t.spatialReference.equals(this.spatialReference)||t.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,t.levels.length)-1,r=this.levels[i].resolution;let s=.5*r;return!u4(t.origin[0],this.origin[0],s)||!u4(t.origin[1],this.origin[1],s)?!1:(s=.5*r/2**i/this.pixelSize*Rke,u4(r,t.levels[i].resolution,s))}rootTilesInExtent(t,i=null,r=1/0){const s=new Array,n=this.levels[0].tileSize;if(O(t)||n[0]===0||n[1]===0)return s;sr.computeRowColExtent(t,n,this.origin,td);let o=td[1],a=td[3],l=td[0],c=td[2];const h=c-l,p=a-o;if(h*p>r){const f=Math.floor(Math.sqrt(r));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let g=l;g<c;g++)s.push([0,f,g]);return _(i)&&(i[0]=this.origin[0]+l*n[0],i[1]=this.origin[1]-a*n[1],i[2]=this.origin[0]+c*n[0],i[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(t,i,r,s){const n=.001*(t[2]-t[0]+(t[3]-t[1]));s[0]=Math.max(0,Math.floor((t[0]+n-r[0])/i[0])),s[2]=Math.max(0,Math.ceil((t[2]-n-r[0])/i[0])),s[1]=Math.max(0,Math.floor((r[1]-t[3]+n)/i[1])),s[3]=Math.max(0,Math.ceil((r[1]-t[1]-n)/i[1]))}static isPowerOfTwo(t){const i=t.lods,r=i[0].resolution*2**i[0].level;return!i.some(function(s){return!fxe(s.resolution,r/2**s.level)})}static hasGapInLevels(t){const i=t.lods.map(function(r){return r.level});i.sort(function(r,s){return r-s});for(let r=1;r<i.length;r++)if(i[r]!==i[0]+r)return!0;return!1}static tileSizeSupported(t){const i=t.size[1];return i===t.size[0]&&(i&i-1)==0&&i>=128&&i<=512}static hasOriginPerLODs(t){const i=t.origin;return t.lods.some(r=>r.origin!=null&&(r.origin[0]!==i.x||r.origin[1]!==i.y))}static getMissingTileInfoError(){return new Q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(t){return O(t)?Oj():t.lods.length<1?new Q("tilingscheme:generic","Tiling scheme must have at least one level"):sr.isPowerOfTwo(t)?sr.hasGapInLevels(t)?new Q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):sr.tileSizeSupported(t)?sr.hasOriginPerLODs(t)?new Q("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new Q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new Q("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(t,i){const r=t[2]-t[0],s=t[3]-t[1],n=bl(i),o=1.2*Math.max(r,s),a=256,l=96,c=.0254,h=new sr(new fI({size:[a,a],origin:{x:t[0]-.5*(o-r),y:t[3]+.5*(o-s)},lods:[{level:0,resolution:o/a,scale:1/(a/l*c/(o*n))}],spatialReference:i}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(t){const i=new sr(sr.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(t),i}static makeGCSWithTileSize(t,i=256,r=16){const s=256/i,n=new sr(new fI({size:[i,i],origin:{x:-180,y:90,spatialReference:t},spatialReference:t,lods:[{level:0,resolution:.703125*s,scale:295497598570834e-6*s}]}));return n.ensureMaxLod(r),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}function Oj(){return new Q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}sr.WebMercatorAuxiliarySphereTileInfo=new fI({size:[256,256],origin:{x:-20037508342787e-6,y:20037508342787e-6,spatialReference:tt.WebMercator},spatialReference:tt.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527591555e-6}]}),sr.WebMercatorAuxiliarySphere=sr.makeWebMercatorAuxiliarySphere(19);const td=Dt(),ox=64,GR=512,Oke=2.5,wC=mxe(fz/10),Ope=4,Mke=4,mI=e=>e<4?3:Mke,Mpe=Dt();sr.WebMercatorAuxiliarySphere.getExtent(0,0,0,Mpe);const Pke=Dt([-180,-90,180,90]),Ike="Cannot extend surface to encompass all layers because it would result in too many root tiles.",$ke="Surface extent is too large for tile resolution at level 0.",Ppe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",bD=5,jQ=he.getLogger("esri.views.support.GroundViewElevationSampler");let jg=class extends wr.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=wC}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;return _(e.extent)&&e.spatialReference?kL(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,i=this.spatialReference;if(!Jf(t,i)){const r=t?t.wkid:"unknown";return jQ.error(`Cannot sample elevation at a location with spatial reference (${r}) different from the view (${i.wkid})`),null}if(O(this.extent)||!xR(this.extent,e)){const r=_(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return jQ.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${r})`),this.noDataValue}return Mh(this.view.elevationProvider,e)}queryElevation(e){return Spe(e.clone(),this)}};u([d({readOnly:!0})],jg.prototype,"demResolution",void 0),u([d({readOnly:!0})],jg.prototype,"extent",null),u([d({readOnly:!0})],jg.prototype,"noDataValue",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],jg.prototype,"spatialReference",void 0),u([d({constructOnly:!0})],jg.prototype,"view",void 0),jg=u([P("esri.views.support.GroundViewElevationSampler")],jg);const Dke=jg;let Hg=class extends we{constructor(e){super(e),this.handles=new Bt,this.view=null,this.layerViews=new pt}initialize(){this.handles.add(S7(this,"view.map.ground",e=>e.load())),this.handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new Dke({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map(e=>e.watch("updating",()=>this._updateUpdating(),!0)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],Hg.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],Hg.prototype,"updating",null),u([d({constructOnly:!0})],Hg.prototype,"view",void 0),u([d({type:pt,readOnly:!0})],Hg.prototype,"layerViews",void 0),u([d({readOnly:!0})],Hg.prototype,"suspended",null),Hg=u([P("esri.views.GroundView")],Hg);const Lke=Hg,Nke=e=>{let t=class extends e{async fetchPopupFeatures(i,r){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(i,r),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,r),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:xbe([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}_queryLayerPopupFeatures(i,r,s){return r.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:_(s)?s.event:null,signal:_(s)?s.signal:null,defaultPopupTemplateEnabled:!!_(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(i,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(_(r)&&r.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(i,r){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(i,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(i,r){const{results:s,mapPoint:n}=await this.popupHitTest(i),o=s.filter(l=>this._isValidPopupGraphic(l.graphic,r)),a=o.length?o[0].mapPoint:null;return{clientGraphics:o.map(l=>l.graphic),queryArea:n,location:n||a}}_getFetchPopupLayerViews(){const i=[];return this.allLayerViews.forEach(r=>{this._isValidPopupLayerView(r)&&i.push(r)}),_(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&i.push(this.graphicsView),i.reverse()}_isValidPopupLayerView(i){return _(i)&&(!("layer"in i)||!i.suspended)&&"fetchPopupFeatures"in i}_graphicsPerFetchPopupLayerView(i,r){const s=[],n=new Map,o=r.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of i){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return t=u([P("esri.views.PopupView")],t),t};async function Fke(e){if(!e)return;const t=e.indexOf("-vector")>-1?e.slice(0,e.indexOf("-vector")):e,i=await Pae("esri/t9n/basemaps");return i[e]||i[t]}const o8={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Boundaries and Places",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return ui("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return ui("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return ui("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return ui("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return ui("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return ui("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return ui("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return ui("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return ui("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return ui("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]}},Uke=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),kke=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","ogc-feature","route","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function zke(e){return e.layerContainerType==="basemap"?Uke:e.layerContainerType==="operational-layers"?kke:null}function Mj(e){return!(e.type!=="feature"||e.url||!e.source||e.source.type!=="memory")}function Bke(e,t){if(t.restrictedWebMapWriting){const i=zke(t);return!_(i)||i.has(e.type)&&!Mj(e)}return!0}function Vke(e,t){if(Mj(e)){const i=YT("featureCollection.layers",t),r=i&&i[0]&&i[0].layerDefinition;r&&P5(e,r)}else e.type==="stream"?P5(e,t.layerDefinition=t.layerDefinition||{}):e.type!=="group"&&P5(e,t)}function P5(e,t){"maxScale"in e&&(t.maxScale=v$(e.maxScale)),"minScale"in e&&(t.minScale=v$(e.minScale))}function Gke(e,t){if(Vke(e,t),"blendMode"in e&&(t.blendMode=e.blendMode,t.blendMode==="normal"&&delete t.blendMode),t.opacity=v$(e.opacity),t.title=e.title||"Layer",t.visibility=e.visible,"legendEnabled"in e&&e.type!=="wmts")if(Mj(e)){const i=t.featureCollection;i&&(i.showLegend=e.legendEnabled)}else t.showLegend=e.legendEnabled}function HQ(e,t,i){if(!("write"in e)||!e.write)return i&&i.messages&&i.messages.push(new Q("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted`,{layer:e})),null;if(Bke(e,i)){const r={};return e.write(r,i)?r:null}return _(t)&&Gke(e,t=se(t)),t}var gI;let jke=0;const I5=he.getLogger("esri.Basemap");let jc=gI=class extends bR(mm){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+jke++,this.baseLayers=new pt,this.referenceLayers=new pt;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&I5.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=r=>{r.parent=null};this.baseLayers.on("after-add",r=>t(r.item)),this.referenceLayers.on("after-add",r=>t(r.item)),this.baseLayers.on("after-remove",r=>i(r.item)),this.referenceLayers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{I5.error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var e;const t=this.baseLayers.removeAll();for(const r of t)r.destroy();const i=this.referenceLayers.removeAll();for(const r of i)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(e=this.portalItem)==null||e.destroy(),this.portalItem=null}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=I({},e)).resourceInfo),e}set baseLayers(e){this._set("baseLayers",h1(e,this._get("baseLayers")))}_writeBaseLayers(e,t,i){const r=[];e&&(i=me(I({},i),{layerContainerType:"basemap"}),this.baseLayers.forEach(s=>{const n=HQ(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&r.push(n)}),this.referenceLayers.forEach(s=>{const n=HQ(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&(n.isReference=!0,r.push(n))})),t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",h1(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return Sae(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(e.loadStatus="loaded"),new gI({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t&&t.origin||(t=I({origin:"web-map"},t)),super.write(e,t),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(i=>{const r=se(i);return r.url&&dp(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&dp(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:i}=this;Jt(e);const r=[];if(t){const s=t.context?t.context.url:null;if(r.push(this._loadLayersFromJSON(t.data,s,e)),t.data.id&&!t.data.title){const n=t.data.id;r.push(Fke(n).then(o=>{o&&this.read({title:o},t.context)}))}}else i&&r.push(this._loadFromItem(i,e));await Promise.all(r)}async _loadLayersFromJSON(e,t,i){const r=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||r&&r.portal||null,n=r&&r.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await import("./layersCreator.61465506.js"),a=[];if(Jt(i),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const l={context:{origin:n,url:t,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=o(this.baseLayers,e.baseMapLayers.filter(p=>!p.isReference),l);a.push(c);const h=o(this.referenceLayers,e.baseMapLayers.filter(p=>p.isReference),l);a.push(h)}await Sa(a)}async _loadFromItem(e,t){const i=await e.load(t),r=await i.fetchData("json",t),s=Gn(e.itemUrl);return this._set("resourceInfo",{data:r.baseMap,context:{origin:"web-map",portal:e.portal||gl.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||gl.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)}static fromId(e){const t=o8[e];if(t){if(t.deprecated){let i=null;e==="dark-gray"?i="dark-gray-vector":e==="gray"?i="gray-vector":e==="streets"?i="streets-vector":e==="topo"&&(i="topo-vector"),jx(I5,`The ${e} basemap has entered mature support and is no longer being updated.`,{replacement:i,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return gI.fromJSON(t)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,i,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:pt}},writer(e,t,i,r){this._writeBaseLayers(e,t,r)}}}}}})],jc.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],jc.prototype,"id",void 0),u([d({type:gD})],jc.prototype,"portalItem",void 0),u([d()],jc.prototype,"referenceLayers",null),u([d({readOnly:!0})],jc.prototype,"resourceInfo",void 0),u([d({type:tt})],jc.prototype,"spatialReference",void 0),u([d()],jc.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],jc.prototype,"title",void 0),u([Ge("title")],jc.prototype,"writeTitle",null),jc=gI=u([P("esri.Basemap")],jc);const wD=jc;var Hke=Object.freeze(Object.defineProperty({__proto__:null,default:wD},Symbol.toStringTag,{value:"Module"}));let Rw=class extends Rm(pt){constructor(e){super(e),this.getCollections=null}initialize(){this.handles.add(Lse(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=_(this.getCollections)?this.getCollections():null;if(O(e))return void this.removeAll();let t=0;for(const i of e)_(i)&&(t=this._processCollection(t,i));this.splice(t,this.length)}_createNewInstance(e){return new pt(e)}_processCollection(e,t){if(!t)return e;const i=this.itemFilterFunction?this.itemFilterFunction:r=>!!r;for(const r of t)if(r){if(i(r)){const s=this.indexOf(r,e);s>=0?s!==e&&this.reorder(r,e):this.add(r,e),++e}if(this.getChildrenFunction){const s=this.getChildrenFunction(r);if(Array.isArray(s))for(const n of s)e=this._processCollection(e,n);else e=this._processCollection(e,s)}}return e}};u([d()],Rw.prototype,"getCollections",void 0),u([d()],Rw.prototype,"getChildrenFunction",void 0),u([d()],Rw.prototype,"itemFilterFunction",void 0),Rw=u([P("esri.core.CollectionFlattener")],Rw);const Mx=Rw;function qke(e){var t;return!!(e&&e.loaded&&"capabilities"in e&&e!=null&&(t=e.capabilities)!=null&&t.operations&&"supportsEditing"in e.capabilities.operations&&e.capabilities.operations.supportsEditing===!0)&&!("editingEnabled"in e&&!e.editingEnabled)}const qQ=he.getLogger("esri.support.basemapUtils");function Wke(){return{}}function Xke(e){for(const t in e){const i=e[t];(i==null?void 0:i.destroyed)===!1&&i.destroy(),delete e[t]}}function Yke(e,t){var i;let r;if(typeof e=="string"){if(!(e in o8)){const s=Object.entries(o8).filter(([n,o])=>zi.apiKey&&!o.classic||!zi.apiKey&&o.classic&&!o.deprecated).map(([n])=>`"${n}"`).join(", ");return qQ.warn(`Unable to find basemap definition for: ${e}. Try one of these: ${s}`),null}t&&(r=t[e]),r||(r=wD.fromId(e),t&&(t[e]=r))}else r=ns(wD,e);return(i=r)!=null&&i.destroyed&&(qQ.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}const Zke=he.getLogger("esri.support.groundUtils"),WQ={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function Qke(e){let t=null;if(typeof e=="string")if(e in WQ){const i=WQ[e];t=new aC({resourceInfo:{data:{layers:[i]}}})}else Zke.warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=ns(aC,e);return t}function Jke(e){return e&&e.type==="group"}function a8(e,t,i){let r,s;if(e)for(let n=0,o=e.length;n<o;n++){if(r=e.getItemAt(n),r[t]===i)return r;if(Jke(r)&&(s=a8(r.layers,t,i),s))return s}}const XQ=he.getLogger("esri.support.LayersMixin"),Kke=e=>{let t=class extends e{constructor(...i){super(...i),this.layers=new pt;const r=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||XQ.error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>r(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const i=this.layers.removeAll();for(const r of i)this.layerRemoved(r),r.destroy();this.layers.destroy()}set layers(i){this._set("layers",h1(i,this._get("layers")))}add(i,r){const s=this.layers;if(r=s.getNextIndex(r),i instanceof gj){const n=i;n.parent===this?this.reorder(n,r):s.add(n,r)}else _c(i)?i.then(n=>{this.destroyed||this.add(n,r)}):XQ.error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(i,r){const s=this.layers;r=s.getNextIndex(r),i.slice().forEach(n=>{n.parent!==this?(s.add(n,r),r+=1):this.reorder(n,r)})}findLayerById(i){return a8(this.layers,"id",i)}findLayerByUid(i){return a8(this.layers,"uid",i)}remove(i){return this.layers.remove(i)}removeMany(i){return this.layers.removeMany(i)}removeAll(){return this.layers.removeAll()}reorder(i,r){return this.layers.reorder(i,r)}layerAdded(i){}layerRemoved(i){}};return u([d()],t.prototype,"layers",null),t=u([P("esri.support.LayersMixin")],t),t},Ipe="esri.support.TablesMixin",eze=he.getLogger(Ipe);function tze(e){return e&&e.type==="group"}function l8(e,t,i){if(e)for(let r=0,s=e.length;r<s;r++){const n=e.getItemAt(r);if(n[t]===i)return n;if(tze(n)){const o=l8(n.tables,t,i);if(o)return o}}}const ize=e=>{let t=class extends e{constructor(...i){super(...i),this.tables=new pt,this.tables.on("after-add",r=>{const s=r.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&eze.error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",r=>{r.item.parent=null})}destroy(){const i=this.tables.removeAll();for(const r of i)r.destroy();this.tables.destroy()}set tables(i){this._set("tables",h1(i,this._get("tables")))}findTableById(i){return l8(this.tables,"id",i)}findTableByUid(i){return l8(this.tables,"uid",i)}};return u([d()],t.prototype,"tables",null),t=u([P(Ipe)],t),t};let Pd=class extends ize(Kke(wr.EventedMixin(we))){constructor(e){super(e),this.allLayers=new Mx({getCollections:()=>{var t,i,r;return[(t=this.basemap)==null?void 0:t.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(r=this.basemap)==null?void 0:r.referenceLayers]},getChildrenFunction:t=>"layers"in t?t.layers:null}),this.allTables=new Mx({getCollections:()=>[this.tables,this.layers],getChildrenFunction:t=>{const i=[];return"tables"in t&&i.push(t.tables),"layers"in t&&i.push(t.layers),i},itemFilterFunction:t=>{const i=t.parent;return i&&"tables"in i&&i.tables.includes(t)}}),this.basemap=null,this.editableLayers=new Mx({getCollections:()=>[this.allLayers],itemFilterFunction:qke}),this.ground=new aC,this._basemapCache=Wke()}destroy(){var e,t;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(e=this.ground)==null||e.destroy(),(t=this.basemap)==null||t.destroy(),Xke(this._basemapCache),this._basemapCache=null}castBasemap(e){return Yke(e,this._basemapCache)}castGround(e){const t=Qke(e);return O(t)?this._get("ground"):t}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};u([d({readOnly:!0,dependsOn:[]})],Pd.prototype,"allLayers",void 0),u([d({readOnly:!0})],Pd.prototype,"allTables",void 0),u([d({type:wD})],Pd.prototype,"basemap",void 0),u([It("basemap")],Pd.prototype,"castBasemap",null),u([d({readOnly:!0})],Pd.prototype,"editableLayers",void 0),u([d({type:aC,nonNullable:!0})],Pd.prototype,"ground",void 0),u([It("ground")],Pd.prototype,"castGround",null),Pd=u([P("esri.Map")],Pd);const rze=Pd;let AA=class extends dA{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([fG({Type:Bo,ensureType:ns(Bo)})],AA.prototype,"itemType",void 0),AA=u([P("esri.support.GraphicsCollection")],AA);let qg=class extends we{constructor(e){super(e),this.view=null,this.baseLayerViews=new pt,this.referenceLayerViews=new pt,this._loadingHandle=Wt(this,"view.map.basemap",t=>{t&&t.load().catch(()=>{})})}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){var e,t;if(this.view&&this.view.suspended)return!1;const i=(e=this.view)==null||(t=e.map)==null?void 0:t.basemap;return!!i&&!!i.loaded&&(this.baseLayerViews.some(r=>r.updating)||this.referenceLayerViews.some(r=>r.updating))}};u([d({constructOnly:!0})],qg.prototype,"view",void 0),u([d({readOnly:!0})],qg.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],qg.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],qg.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],qg.prototype,"updating",null),qg=u([P("esri.views.BasemapView")],qg);const sze=he.getLogger("esri.views.LayerViewManager");class nze{constructor(t,i,r){this.layer=t,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=Jy(),this._started=!1,this.done=!1,co(this._controller.signal,()=>{const s=new Q("cancelled:layerview-create","layerview creation cancelled",{layer:t});this._deferred.reject(s)})}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:t}=this;if(!t)return;const{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:t}),r.emit("layerview-destroy",{layer:i,layerView:t}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:t},layer:i,view:r}=this;this._map=r.map;try{var s,n;let o,a;if(await i.load({signal:t}),"prefetchResources"in i&&await i.prefetchResources({signal:t}),i.createLayerView)o=await i.createLayerView(r,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new Q("layer:view-not-supported","No layerview implementation was found");const c=await this.layerViewImporter.importLayerView(i);Jt(t),o="default"in c?new c.default({layer:i,view:r}):new c({layer:i,view:r})}const l=()=>{a=Ys(a),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};a=co(t,l),Jt(t);try{await o.when()}catch(c){throw l(),c}if(!(!((s=this._map)==null||(n=s.allLayers)==null)&&n.includes(i)))return l(),void this._deferred.reject(new Q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=o,i.emit("layerview-create",{view:r,layerView:o}),r.emit("layerview-create",{layer:i,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(o){i.emit("layerview-create-error",{view:r,error:o}),r.emit("layerview-create-error",{layer:i,error:o}),this.done=!0,this._deferred.reject(new Q("layerview:create-error","layerview creation failed",{layer:i,error:o}))}}}let Hc=class extends aT{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new rp,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var t;const i=(t=this.view.map)==null?void 0:t.allLayers;if(i)for(const r of i)this.layerViewImporter.hasLayerViewModule(r)&&this.layerViewImporter.importLayerView(r)},this._reschedule=()=>(O(this._workPromise)&&(this._workPromise=Jy()),this.handles.remove("reschedule"),this.handles.add(vR(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var t,i,r;const s=this.view.map;if(this._map!==s&&(this.clear(),this._map=s),O(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const n=new Mx({getCollections:()=>this._rootCollectionNames.map(l=>this.get(l)),getChildrenFunction:l=>l&&"layers"in l?l.layers:null});if(!n)return this._workPromise.resolve(),void(this._workPromise=null);for(const l of n)this._createLayerView(l);this._refreshCollections();for(const[l,c]of this._layerLayerViewInfoMap)n.includes(l)||(this._layerLayerViewInfoMap.delete(c.layer),c.destroy());const o=n.filter(l=>l.type==="group").map(l=>l.layers),a=[s==null||(t=s.ground)==null?void 0:t.layers,s==null||(i=s.basemap)==null?void 0:i.baseLayers,s==null||(r=s.basemap)==null?void 0:r.referenceLayers,s==null?void 0:s.layers,...o].filter(l=>!!l);this.handles.add(a.map(l=>this._watchUpdatingTracking.addOnCollectionChange(()=>l,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([Tx(()=>{var e,t;return(e=this.view)==null||(t=e.map)==null?void 0:t.allLayers},"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),Nt(()=>{const e=this.view,t=e==null?void 0:e.map;return[t==null?void 0:t.basemap,t==null?void 0:t.ground,t==null?void 0:t.layers,e==null?void 0:e.ready]},()=>this._reschedule(),Yl)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return _(this._workPromise)||this._watchUpdatingTracking.updating||Vr(this._layerLayerViewInfoMap,e=>!e.done)}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e))throw new Q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(const s of e){const n=this._layerLayerViewInfoMap.get(s);if(!n||!n.layerView)continue;const o=n.layerView;o.layer=s,o.parent=i,t.getItemAt(r)!==o&&t.splice(r,0,o),s.layers&&this._populateLayerViewsOwners(s.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),this.notifyChange("updating"),void this.notifyChange("updatingRemaining");e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new nze(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),i=>{var r,s;i&&(vr(i)||i.name==="cancelled:layerview-create")||sze.error(`Failed to create layerview for layer title:'${(r=e.title)!=null?r:"no title"}', id:'${(s=e.id)!=null?s:"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],Hc.prototype,"_workPromise",void 0),u([d({readOnly:!0})],Hc.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],Hc.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],Hc.prototype,"_rootCollectionNames",null),u([d()],Hc.prototype,"layerViewImporter",void 0),u([d()],Hc.prototype,"supportsGround",void 0),u([d({readOnly:!0})],Hc.prototype,"updating",null),u([d({readOnly:!0})],Hc.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],Hc.prototype,"view",void 0),Hc=u([P("esri.views.LayerViewManager")],Hc);const oze=Hc;let Dl=class extends we{constructor(e){super(e),this.factor=1.5,this.offset=zh(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],Dl.prototype,"factor",void 0),u([d({nonNullable:!0})],Dl.prototype,"offset",void 0),u([d()],Dl.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],Dl.prototype,"size",void 0),u([d()],Dl.prototype,"maskUrl",void 0),u([d()],Dl.prototype,"maskEnabled",void 0),u([d()],Dl.prototype,"overlayUrl",void 0),u([d()],Dl.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],Dl.prototype,"version",null),u([d({type:Boolean})],Dl.prototype,"visible",void 0),Dl=u([P("esri.views.Magnifier")],Dl);const $pe=Dl;let yI=class extends we{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.push(new YQ(r,s,e,t,i)))}unshift(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.unshift(new YQ(r,s,e,t,i)))}_process(e){if(this._tasks.length===0)return!1;const t=this._tasks.shift();try{const i=Ls(t.signal);if(i&&!t.abortCallback)t.reject(pi());else{const r=i?t.abortCallback(pi()):t.callback(e);_c(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const e=pi();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this.running=!1}};u([d()],yI.prototype,"running",void 0),yI=u([P("esri.layers.support.PromiseQueue")],yI);class YQ{constructor(t,i,r,s,n){this.resolve=t,this.reject=i,this.callback=r,this.signal=s,this.abortCallback=n}}let ME=class extends we{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],ME.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],ME.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),ME=u([P("esri.views.support.DebugFlags")],ME);const aze=new ME,lze=he.getLogger("esri.views.support.Scheduler");function cze(e){return new xD.Scheduler({nowFunc:e})}var ut;(function(e){e.RESOURCE_CONTROLLER="schedule",e.SLIDE="slide",e.STREAM_DATA_LOADER="stream loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.GRAPHICS_CORE="Graphics3D",e.I3S_CONTROLLER="I3S",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.OVERLAY="overlay",e.STAGE="stage",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.LABELER="labeler",e.FEATURE_QUERY_ENGINE="feature query",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e.SNAPPING="snapping",e.SHADOW_ACCUMULATOR="shadow accumulator",e.CLOUDS_GENERATOR="cloud generator",e[e.TEST_PRIO=1]="TEST_PRIO"})(ut||(ut={}));const Hd=0,ZQ=new Map([[ut.RESOURCE_CONTROLLER,Hd],[ut.SLIDE,Hd],[ut.STREAM_DATA_LOADER,Hd],[ut.ELEVATION_QUERY,Hd],[ut.TERRAIN_SURFACE,1],[ut.SURFACE_GEOMETRY_UPDATES,1],[ut.GRAPHICS_CORE,2],[ut.I3S_CONTROLLER,2],[ut.POINT_CLOUD_LAYER,2],[ut.FEATURE_TILE_FETCHER,2],[ut.OVERLAY,4],[ut.STAGE,4],[ut.GRAPHICS_DECONFLICTOR,4],[ut.FILTER_VISIBILITY,4],[ut.SCALE_VISIBILITY,4],[ut.FRUSTUM_VISIBILITY,4],[ut.POINT_OF_INTEREST_FREQUENT,6],[ut.POINT_OF_INTEREST_INFREQUENT,30],[ut.LABELER,8],[ut.FEATURE_QUERY_ENGINE,8],[ut.FEATURE_TILE_TREE,16],[ut.FEATURE_TILE_TREE_ACTIVE,Hd],[ut.ELEVATION_ALIGNMENT,12],[ut.TEXT_TEXTURE_ATLAS,12],[ut.CLOUDS_GENERATOR,12],[ut.TEXTURE_UNLOAD,12],[ut.LINE_OF_SIGHT_TOOL,16],[ut.LINE_OF_SIGHT_TOOL_INTERACTIVE,Hd],[ut.SNAPPING,Hd],[ut.SHADOW_ACCUMULATOR,30]]);function QQ(e){return ZQ.has(e)?ZQ.get(e):typeof e=="number"?e:1}var js;(function(e){e[e.ANIMATING=0]="ANIMATING",e[e.INTERACTING=1]="INTERACTING",e[e.IDLE=2]="IDLE"})(js||(js={}));const JQ=6.5,KQ=1,uze=30,eJ=1e3/30,tJ=100,iJ=.9;var xD,N0;(function(e){let t=class extends we{constructor(s){super(s),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new Vy("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=js.INTERACTING,this._tasks=new $t,this._runQueue=new $t,this._load=0,this._idleStateCallbacks=new $t,this._idleUpdatesStartFired=!1,this._maxReschedule=fM,this._forceTask=!1,this._debug=!1,this._debugHandle=Nt(()=>aze.SCHEDULER_LOG_SLOW_TASKS,a=>this._debug=a,un),this._budget=new r(s.nowFunc);for(const a of Object.keys(ut))this.performanceInfo.tasks.set(ut[a],new Vy(ut[a]));let n;const o=this;this._test={get state(){return gt(n,o._state)},set state(a){n=a},FRAME_SAFETY_BUDGET:JQ,INTERACTING_BUDGET:eJ,IDLE_BUDGET:tJ,get budget(){return o._budget.budget},usedBudget:0,setBudget:a=>o._budget=a,updateTask:a=>this._updateTask(a),getState:a=>this._getState(a),getRuntime:a=>this._getRuntime(a),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(s=>s.remove()),this._tasks.clear(),Ys(this._debugHandle),this._microTaskQueued=!1,this.updating=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=fM,this._schedule(),this.frame()))}))}registerTask(s,n){const o=QQ(s),a=new i(this,s,n,o);return this._tasks.push(a),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new Vy(s)),a}registerIdleStateCallbacks(s,n){const o={idleBegin:s,idleEnd:n};this._idleStateCallbacks.push(o),this.state===js.IDLE&&this._idleUpdatesStartFired&&o.idleBegin();const a=this;return{remove:()=>this._removeIdleStateCallbacks(o),set idleBegin(l){a._idleUpdatesStartFired&&(o.idleEnd(),a._state===js.IDLE&&l()),o.idleBegin=l},set idleEnd(l){o.idleEnd=l}}}get now(){return this.nowFunc()}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==js.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(n=>n.idleEnd())))}get state(){return O(this._test.state)?this._state:this._test.state}updateBudget(s){this._test.usedBudget=0;let n=JQ,o=s.frameDuration,a=KQ;switch(this.state){case js.IDLE:n=0,o=Math.max(tJ,s.frameDuration),a=uze;break;case js.INTERACTING:o=Math.max(eJ,s.frameDuration);case js.ANIMATING:}return o=o-s.elapsedFrameTime-n,this.state!==js.IDLE&&o<KQ&&!this._forceTask?(this._forceTask=!0,!1):(o=Math.max(o,a),this._budget.reset(o,this.state),this._maxReschedule=fM,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case js.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case js.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s)}_updateTask(s){this._tasks.forAll(n=>{n.name===s&&n.setPriority(s)})}_getState(s){if(this._runQueue.some(o=>o.name===s))return N0.SCHEDULED;let n=N0.IDLE;return this._tasks.forAll(o=>{o.name===s&&o.needsUpdate&&(o.schedulePriority<=1?n=N0.READY:n!==N0.READY&&(n=N0.WAITING))}),n}_getRuntime(s){let n=0;return this._tasks.forAll(o=>{o.name===s&&(n+=o.runtime)}),n}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(o=>{o.needsUpdate&&s.set(o.name,(s.get(o.name)||0)+1)}),s.size===0)return null;let n="";return s.forEach((o,a)=>{n+=o>1?` ${o}x ${a}`:` ${a}`}),n}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((n,o)=>o.needsUpdate?++n:n,0);this._load=this._load*iJ+s*(1-iJ)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===Hd&&s.needsUpdate&&!this._runQueue.some(n=>n===s)&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,n=0;if(this._tasks.forAll(o=>{o.needsUpdate&&o.schedulePriority!==0&&o.basePriority!==Hd&&(s=!0,n=Math.max(n,o.basePriority),o.schedulePriority===1?(o.schedulePriority=0,this._runQueue.push(o)):--o.schedulePriority)}),!s)return this.updating=!1,!1;this._maxReschedule===fM&&(this._maxReschedule=n),--this._maxReschedule}return this.updating=!0,!0}_run(){const s=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const n=this._budget.now(),o=this._runQueue.pop();this._budget.resetProgress();try{o.task.runTask(this._budget)}catch(l){lze.error(`Exception in task "${o.name}"`,l)}o.schedulePriority=o.basePriority;const a=this._budget.now()-n;if(o.runtime+=a,this._frameTaskTimes.set(o.priority,this._frameTaskTimes.get(o.priority)+a),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",o.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this.updating=this._tasks.some(l=>l.needsUpdate),void this._recordFrameTaskTimes(this._budget.now()-s)}while(this._schedule());this.updating=this._tasks.some(n=>n.needsUpdate),this._recordFrameTaskTimes(this._budget.now()-s)}_startFrameTaskTimes(){for(const s of Object.keys(ut))this._frameTaskTimes.set(ut[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((n,o)=>this.performanceInfo.tasks.get(o).record(n)),this.performanceInfo.total.record(s)}get test(){return this._test}};u([d()],t.prototype,"updating",void 0),u([d()],t.prototype,"nowFunc",void 0),t=u([P("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends we{constructor(s,n,o,a){super({}),this._scheduler=s,this.name=n,this._basePriority=a,this.runtime=0,this._queue=new yI,this._handles=new Bt,this.schedulePriority=this._basePriority,this.task=_(o)?o:this._queue,this._handles.add(JL(()=>this.task.running,()=>s.activate()))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(_S),this._scheduler.removeTask(this),this.schedule=TT.schedule,this.reschedule=TT.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){this.name=s;const n=QQ(s);this._basePriority!==Hd&&this.schedulePriority===0||(this.schedulePriority=n),this._basePriority=n}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,n,o){return this._queue.push(s,n,o)}reschedule(s,n,o){return this._queue.unshift(s,n,o)}processQueue(s){this._queue.runTask(s)}};u([d({constructOnly:!0})],i.prototype,"task",void 0),u([d({readOnly:!0})],i.prototype,"updating",null),i=u([P("esri.views.support.SchedulerTask")],i);class r{constructor(n){this.now=n,this._begin=0,this._budget=0,this._state=js.IDLE,this._didWork=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=r})(xD||(xD={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(N0||(N0={}));const _S=(()=>{const e=new xD.Budget(()=>performance.now());return e.enabled=!1,e})();class hze{remove(){}processQueue(){}schedule(t,i,r){try{if(Ls(i)){const s=pi();return r?Promise.resolve(r(s)):Promise.reject(s)}return Jk(t(_S))}catch(s){return Promise.reject(s)}}reschedule(t,i,r){return this.schedule(t,i,r)}}const TT=new hze,fM=Number.MAX_SAFE_INTEGER;let ax=class extends we{constructor(e,t){var i;super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(i=t==null?void 0:t.registerTask(ut.TEXTURE_UNLOAD))!=null?i:TT}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}get updating(){return this._frameTask.updating}fromData(e,t,i){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(s.texture),this._stage.loadImmediate(s.texture)),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture,release:()=>this._release(r)}}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.onRemove&&e.onRemove(),e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return _(t)?`${e}.${t}px`:e}};u([d()],ax.prototype,"_frameTask",void 0),u([d()],ax.prototype,"updating",null),ax=u([P("esri.views.3d.support.TextureCollection")],ax);var rJ;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"})(rJ||(rJ={}));const Dpe=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],Lpe={};function Npe(e){return!!Lpe[e]}function dze(e){for(const t of e)if(!Npe(t))return!1;return!0}Dpe.forEach(e=>{Lpe[e]=!0});class pze{constructor(t){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=t,this.inputManager=null}connect(t){t&&this.disconnect(),this.inputManager=t,this.handlers.forEach(({handler:i,priority:r},s)=>this.inputManager.installHandlers(s,[i],r))}disconnect(){this.inputManager&&this.handlers.forEach((t,i)=>this.inputManager.uninstallHandlers(i)),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(t,i,r,s){const n=Array.isArray(t)?t:t.split(",");if(!dze(n))return n.some(Npe)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(i)?a=i:(o=i,a=[]),typeof r=="function"?o=r:s=r,s=s!=null?s:qy.DEFAULT;const l=this._createUniqueGroupName(),c=new fze(this.view,n,a,o);this.handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this.handlerCounts.get(h)||0;this.handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(t){return!!this.handlerCounts.get(t)}_removeHandler(t,i){if(this.handlers.has(t)){this.handlers.delete(t);for(const r of i){const s=this.handlerCounts.get(r);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",r):s===1?this.handlerCounts.delete(r):this.handlerCounts.set(r,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(t)}_createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class fze extends jn{constructor(t,i,r,s){super(!0),this.view=t;for(const n of i)switch(n){case"click":this.registerIncoming("click",r,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",r,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",r,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",r,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",r,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",r,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",r,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",r,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",r,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",r,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",r,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",r,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",r,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",r,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",r,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",r,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",r,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",r,o=>{s(this._wrapBlur(o))})}}_wrapFocus(t){return{type:"focus",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapBlur(t){return{type:"blur",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:zh(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapImmediateClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapImmediateDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapHold(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>t.stopPropagation(),async:h=>t.async(h),preventDefault:()=>t.preventDefault()}}_getMapPoint(t,i){return this.view.toMap(zh(t,i),{exclude:[]})}_wrapDrag(t){const i=t.data,{x:r,y:s}=i.center,{action:n,pointerType:o,button:a}=i;if(n==="start"&&(this.latestDragStart=i),!this.latestDragStart)return;const l=i.pointer.native,c=i.buttons,{cancelable:h,timestamp:p}=t,f={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return n==="end"&&(this.latestDragStart=void 0),{type:"drag",action:n,x:r,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:i.radius,angle:pl(i.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:g=>t.async(g),preventDefault:()=>t.preventDefault()}}_wrapKeyDown(t){const{key:i,repeat:r,native:s}=t.data,{cancelable:n,timestamp:o}=t;return{type:"key-down",key:i,repeat:r,native:s,timestamp:o,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:a=>t.async(a),preventDefault:()=>t.preventDefault()}}_wrapKeyUp(t){const{key:i,native:r}=t.data,{cancelable:s,timestamp:n}=t;return{type:"key-up",key:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>t.stopPropagation(),async:o=>t.async(o),preventDefault:()=>t.preventDefault()}}_wrapPointer(t,i){const{x:r,y:s,button:n,buttons:o,native:a,eventId:l}=t.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=t;return{type:i,x:r,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>t.stopPropagation(),async:g=>t.async(g),preventDefault:()=>t.preventDefault()}}_wrapPointerDrag(t){const{x:i,y:r,buttons:s,native:n,eventId:o}=t.data.currentEvent,{button:a}=t.data.startEvent,l=t.data.startEvent.native.pointerId,c=t.data.startEvent.native.pointerType,h=t.data.action,p={x:t.data.startEvent.x,y:t.data.startEvent.y},{cancelable:f,timestamp:g}=t;return{type:"pointer-drag",x:i,y:r,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:g,eventId:o,cancelable:f,stopPropagation:()=>t.stopPropagation(),async:y=>t.async(y),preventDefault:()=>t.preventDefault()}}_wrapMouseWheel(t){const{cancelable:i,data:r,timestamp:s}=t,{x:n,y:o,deltaY:a,native:l}=r;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:i,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}_wrapGamepad(t){const{action:i,state:r,device:s}=t.data,{cancelable:n,timestamp:o}=t,{buttons:a,axes:l}=r;return{type:"gamepad",device:s,timestamp:o,action:i,buttons:a,axes:l,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}}var xC,sJ,nJ;(function(e){e[e.USER=0]="USER",e[e.MANAGER=1]="MANAGER"})(xC||(xC={})),function(e){e[e.None=0]="None",e[e.Unfocused=1]="Unfocused",e[e.Focused=2]="Focused",e[e.Unselected=4]="Unselected",e[e.Selected=8]="Selected",e[e.All=15]="All"}(sJ||(sJ={})),function(e){e[e.None=0]="None",e[e.Custom1=16]="Custom1",e[e.Custom2=32]="Custom2",e[e.Custom3=64]="Custom3",e[e.Custom4=128]="Custom4",e[e.Custom5=256]="Custom5",e[e.Custom6=512]="Custom6",e[e.Custom7=1024]="Custom7",e[e.Custom8=2048]="Custom8",e[e.Custom9=4096]="Custom9",e[e.Custom10=8192]="Custom10",e[e.Custom11=16384]="Custom11",e[e.Custom12=32768]="Custom12",e[e.All=65520]="All"}(nJ||(nJ={}));const mze=he.getLogger("esri.views.interactive.interactiveToolUtils");function gze(e){return[e.on("before-add",t=>{const i=t.item;if(i==null||e.includes(i))return mze.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault()}),e.on("after-remove",t=>{const i=t.item;i.visible=!1,i.active&&(i.view.activeTool=null),i.destroy()})]}function TD(e){return e.visible&&e.getEditableFlag(xC.USER)&&e.getEditableFlag(xC.MANAGER)}function Id(e){return zh(e.x,e.y)}function Fpe(e,t){const i=(e instanceof HTMLElement?e:e.surface).getBoundingClientRect();return zh(t.clientX-i.left,t.clientY-i.top)}function oJ(e,t){return t instanceof Event?Fpe(e,t):Id(t)}function aJ(e){if(e instanceof Event)return!0;if(typeof e=="object"&&"type"in e)switch(e.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}class yze{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._currentlyActiveTool=null,this._revertToActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(t,i){const r=()=>t.stopPropagation();switch(t.type){case"pointer-move":lJ(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),t.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!cJ(t))break;const s=Id(t),n=this._intersect(s,t.pointerType,i.forEachTool);if(O(n))break;const o=this._findToolAndManipulatorByKey(n,i.forEachTool,mM),a=oo(o,c=>c.manipulator),l=oo(o,c=>c.tool);!(_(a)&&_(l)&&a.interactive)||a.grabbable&&a.grabbableForEvent(t)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,l,t),_(a)&&a.interactive&&a.grabbable&&a.grabbableForEvent(t)&&!a.grabbing&&(this._grabbedManipulators.set(t.pointerId,{key:n,start:s,pointerType:t.pointerType}),this._grabbedManipulators.size===1&&i.activeTool!==n.tool&&(this._currentlyActiveTool=i.activeTool,this._revertToActiveTool=!0,i.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:s}),r());break}case"pointer-up":this._handlePointerEnd(t,i);break;case"pointer-drag":{if(!cJ(t))break;const s=this._grabbedManipulators.get(t.pointerId),n=this._draggedManipulators.get(t.pointerId),o=oo(s||n,({key:h})=>h),a=this._findManipulatorByKey(o,i.forEachTool);if(O(a))break;const l=Id(t);l.x=ze(l.x,0,i.view.width),l.y=ze(l.y,0,i.view.height);const c=(s||n).start;switch(t.action){case"start":case"update":t.action!=="update"&&this._grabbedManipulators.size!==1||(a.dragging=!0,n?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{key:o,start:c}));break;case"end":a.dragging=!1,n&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,i)}r();break}case"immediate-click":{const s=Id(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findToolAndManipulatorByKey(n,i.forEachTool,mM);if(vze(t)||i.forEachTool(h=>{if((!_(o)||o.tool!==h||h.automaticManipulatorSelection)&&h.manipulators){let p=!1;h.manipulators.forEach(({manipulator:f})=>{f.selected&&(f.selected=!1,p=!0)}),p&&h.manipulatorSelectionChanged&&h.manipulatorSelectionChanged()}}),O(o))break;const{manipulator:a,tool:l}=o;if(!a.interactive)break;a.selectable&&l.automaticManipulatorSelection&&(a.selected=!a.selected,l.manipulatorSelectionChanged&&l.manipulatorSelectionChanged());const c=t.native.shiftKey;a.events.emit("immediate-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:c,stopPropagation:r});break}case"click":{const s=Id(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(O(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit(t.type,{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a}),r();break}case"double-click":{const s=Id(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(O(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}case"immediate-double-click":{const s=Id(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(O(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}}this._updateCursor(i.forEachTool)}_ungrabManipulatorBeforeDragging(t,i,r){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:Id(r)}),this._grabbedManipulators.forEach(({key:s},n)=>{s.tool===i&&i.manipulators.findById(s.manipulatorId)===t&&this._grabbedManipulators.delete(n)})}_handlePointerEnd(t,i){const r=oo(this._grabbedManipulators.get(t.pointerId),({key:n})=>n),s=this._findManipulatorByKey(r,i.forEachTool);_(s)&&!s.dragging&&(this._grabbedManipulators.size===1&&this._draggedManipulators.size===0&&this._revertToActiveTool&&(i.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),s.grabbing&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:Id(t)})),this._grabbedManipulators.delete(t.pointerId))}_cursorFromMap(t,i){let r=null;return Vr(t,({key:s})=>{const n=this._findManipulatorByKey(s,i);return!!(_(n)&&n.interactive&&"cursor"in n&&n.cursor)&&(r=n.cursor,!0)}),r}_updateCursor(t){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,t)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,t)||"pointer":this._cursor=null}clearPointers(t,i,r=!0,s){const n=o=>o.tool===t&&(O(s)||o.manipulatorId===s);this._grabbedManipulators.forEach(({key:o,pointerType:a},l)=>{if(n(o)){this._grabbedManipulators.delete(l);const c=this._findManipulatorByKey(o,i);_(c)&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:a}))}}),this._draggedManipulators.forEach(({key:o},a)=>{if(n(o)){this._draggedManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}}),r&&this._hoveredManipulators.forEach(({key:o},a)=>{if(n(o)){this._hoveredManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.hovering=!1)}}),this._updateCursor(i)}_intersect(t,i,r){let s=null;return r(n=>{if(n.manipulators==null||!TD(n))return!1;const o=n.manipulators.intersect(t,i);return!O(o)&&(s={manipulatorId:o.id,tool:n},!0)}),s}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(zh(i.x,i.y),r,i.pointerType,t)})}handleHoverEvent(t,i){t.type!=="pointer-up"&&t.type!=="immediate-click"&&t.type!=="pointer-move"||!lJ(t.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(Id(t),t.pointerId,t.pointerType,i)}_updateHoveredStateForPointerAtScreenPosition(t,i,r,s){const n=this._intersect(t,r,s);let o=this._findManipulatorByKey(n,s);const a=oo(this._hoveredManipulators.get(i),({key:c})=>c),l=this._findManipulatorByKey(a,s);_(o)&&!o.interactive&&(o=null),l!==o&&(_(l)&&(l.hovering=!1),_(o)?(o.hovering=!0,this._hoveredManipulators.set(i,{key:n})):this._hoveredManipulators.delete(i),this._updateCursor(s))}_findManipulatorByKey(t,i){return this._findToolAndManipulatorByKey(t,i,mM)?mM.manipulator:null}_findToolAndManipulatorByKey(t,i,r){return O(t)?null:(r.tool=null,r.manipulator=null,i(s=>{if(s!==t.tool||s.manipulators==null||!TD(s))return!1;const n=s.manipulators.findById(t.manipulatorId);return!!_(n)&&(r.manipulator=n,r.tool=s,!0)}),r.manipulator?r:null)}}function lJ(e){return e==="mouse"}function cJ(e){return e.pointerType!=="mouse"||e.button===0}function vze(e){return!!e.native.shiftKey}const mM={manipulator:null,tool:null},uJ=he.getLogger("esri.views.ToolViewManager"),hJ="attached",$5="tools";let yf=class extends aT{constructor(e){super(e),this._manipulatorState=new yze,this.tools=new pt,this.cursor=null,this._forEachTool=t=>{for(const i of this.tools.items)if(t(i))return}}initialize(){this.handles.add([this.view.on(Dpe,e=>{this._handleInputEvent(e)},qy.TOOL),...gze(this.tools),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}set activeTool(e){if(_(e)&&!this.view.ready)return void uJ.error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return void(_(e)&&uJ.warn("Tool is already active - ignoring activation request."));const t=this.activeTool;this._set("activeTool",e),_(t)&&t.deactivate(),_(e)&&e.activate(),this._removeIncompleteTools(e);const i=O(this.activeTool);for(const r of this.tools){r.setEditableFlag(xC.MANAGER,i||r===this.activeTool);const s=TD(r);!i&&s||this._manipulatorState.clearPointers(r,this._forEachTool,!s)}this._updateCursor()}get updating(){var e,t;return this.updatingHandles.updating||this.tools.some(i=>i.updating)||(e=(t=this.textures)==null?void 0:t.updating)!=null&&e}attach(){this.view.type==="3d"?(this._set("textures",new ax(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([this.view.state.watch("camera",()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}),this.view.elevationProvider.on("elevation-change",e=>{this._forEachManipulator(t=>{t.onElevationChange!=null&&t.onElevationChange(e)})}),Sm(()=>this._set("textures",it(this.textures)))],hJ)):this.handles.add(this.view.watch("extent",()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}))}detach(){_(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(hJ)}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1;const i=me(I({},e),{stopPropagation:()=>{t=!0,e.stopPropagation()}});_(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!t&&r.visible&&r.handleInputEvent(i)}),!t&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:r=>{this.activeTool=r},view:this.view}),!t&&_(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove($5),this._forEachTool(e=>{if(e instanceof we){const t=rr(e,["cursor","visible","editable"],()=>{TD(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()});this.handles.add(t,$5)}e.manipulators&&this.handles.add(e.manipulators.on("change",t=>{t.removed.forEach(({id:i})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,i)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}),$5)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let e=this._manipulatorState.cursor;this._forEachTool(t=>!(!_(t.cursor)||!t.visible)&&(e=t.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(t=>(O(e)||t!==e)&&!t.created).forEach(t=>{this.tools.remove(t)})}};u([d({constructOnly:!0,nonNullable:!0})],yf.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],yf.prototype,"textures",void 0),u([d({value:null})],yf.prototype,"activeTool",null),u([d({readOnly:!0,type:pt})],yf.prototype,"tools",void 0),u([d({readOnly:!0})],yf.prototype,"cursor",void 0),u([d({readOnly:!0})],yf.prototype,"updating",null),yf=u([P("esri.views.ToolViewManager")],yf);const _ze=yf;let Ow=class extends we{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":bze.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){return(navigator.getGamepads?navigator.getGamepads():[])[this.nativeIndex]}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return wze[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],Ow.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],Ow.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],Ow.prototype,"axisThreshold",null),Ow=u([P("esri.views.input.gamepad.GamepadInputDevice")],Ow);const bze=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),wze={standard:.15,spacemouse:.025,unknown:0},Pj=Ow;let PE=class extends we{constructor(...e){super(...e),this.devices=new pt,this.enabledFocusMode="document"}};u([d({type:pt.ofType(Pj),readOnly:!0})],PE.prototype,"devices",void 0),u([d({type:["document","view","none"]})],PE.prototype,"enabledFocusMode",void 0),PE=u([P("esri.views.input.gamepad.GamepadSettings")],PE);const xze=PE;let vI=class extends we{constructor(){super(...arguments),this.gamepad=new xze}};u([d({readOnly:!0})],vI.prototype,"gamepad",void 0),vI=u([P("esri.views.input.Input")],vI);const Tze=vI;let Wg=class extends we{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],Wg.prototype,"enabled",void 0),u([d({type:Pj})],Wg.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],Wg.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],Wg.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],Wg.prototype,"velocityFactor",void 0),Wg=u([P("esri.views.navigation.gamepad.GamepadSettings")],Wg);const Upe=Wg;let jv=class extends we{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new Upe,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],jv.prototype,"browserTouchPanEnabled",void 0),u([d({type:Upe,nonNullable:!0})],jv.prototype,"gamepad",void 0),u([d({type:Boolean})],jv.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],jv.prototype,"mouseWheelZoomEnabled",void 0),jv=u([P("esri.views.navigation.Navigation")],jv);const kpe=jv;function Sze(e,t,i){const r=zpe(e),s=t,n=Eze(r,s,i);if(r){const o=lS.deriveUnitFromSR(r,e.spatialReference).heightUnit;if(!i&&o!==r.heightUnit){const a=new Q("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new Q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r,error:a})}}if(!Aze(e)||n===qa.Unsupported)return new Q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r});switch(n){case qa.Units:{const o=r.heightUnit||"unknown",a=s.heightUnit||"unknown",l=new Q("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new Q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case qa.HeightModel:{const o=r.heightModel||"unknown",a=s.heightModel||"unknown",l=new Q("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new Q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case qa.CRS:{const o=r.vertCRS||"unknown",a=s.vertCRS||"unknown",l=new Q("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new Q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}}return null}function Eze(e,t,i){if(!dJ(e)||!dJ(t))return qa.Unsupported;if(e==null||t==null)return qa.Ok;if(!i&&e.heightUnit!==t.heightUnit)return qa.Units;if(e.heightModel!==t.heightModel)return qa.HeightModel;switch(e.heightModel){case"gravity-related-height":return qa.Ok;case"ellipsoidal":return e.vertCRS===t.vertCRS?qa.Ok:qa.CRS;default:return qa.Unsupported}}var qa;function dJ(e){return e==null||e.heightModel!=null&&e.heightUnit!=null}function Aze(e){return"heightModelInfo"in e&&e.heightModelInfo!=null||e.spatialReference!=null||!Gpe(e)}function zpe(e){const t=e.url&&zR(e.url);return!((e.spatialReference&&e.spatialReference.vcsWkid)==null&&_(t)&&t.serverType==="ImageServer")&&Bpe(e)&&e.heightModelInfo?e.heightModelInfo:Gpe(e)?lS.deriveUnitFromSR(Cze,e.spatialReference):null}function Bpe(e){return"heightModelInfo"in e}function Vpe(e){if(e.type==="unknown"||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function Gpe(e){return Vpe(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):Hpe(e)}function jpe(e){return e.layers!=null||Hpe(e)||Vpe(e)||Bpe(e)}function Hpe(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"analysis":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(e){e[e.Ok=0]="Ok",e[e.Units=1]="Units",e[e.HeightModel=2]="HeightModel",e[e.CRS=3]="CRS",e[e.Unsupported=4]="Unsupported"})(qa||(qa={}));const Cze=new lS({heightModel:"gravity-related-height"});var $e;function pJ(e){return e==="global"?$e.Global:$e.Local}function CA(e){return e===$e.Global?"global":"local"}(function(e){e[e.Global=1]="Global",e[e.Local=2]="Local"})($e||($e={}));let c8,D5=null;async function Rze(e){D5||(D5=Promise.resolve().then(function(){return tit}).then(t=>c8=t)),await D5,Jt(e)}async function qpe(e,t,i,r){if(!e)return null;const s=e.spatialReference;return rle()||hT(s,t)?RR(e,t):c8?c8.projectGeometry(e,t,i,r):(await Promise.race([Rze(r),J6(r)]),qpe(e,t,i,r))}const Wpe=he.getLogger("esri.views.support.DefaultsFromMap");Wpe.level="info";let Qi=class extends we{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.logDebugInformation=!1,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=xu(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return _(this.userSpatialReference)?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return O(this.userSpatialReference)||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){var e,t,i,r;const s=(e=this.map)==null?void 0:e.call(this),n=[];return _(this.priorityCollection)&&n.push(this.priorityCollection),n.push({parent:s==null?void 0:s.basemap,layers:s==null||(t=s.basemap)==null?void 0:t.baseLayers},{layers:s==null?void 0:s.layers},{parent:s==null?void 0:s.ground,layers:s==null||(i=s.ground)==null?void 0:i.layers},{parent:s==null?void 0:s.basemap,layers:s==null||(r=s.basemap)==null?void 0:r.referenceLayers}),n}get _allLayers(){var e,t;const i=this._collectLayers(this.mapCollections);return this._debug("Collected",(e=(t=i.layers)==null?void 0:t.length)!=null?e:0,"layers, updating",i.updating),i}get _spatialReferenceTask(){var e,t;if(this.suspended)return(t=this._get("_spatialReferenceTask"))!=null?t:{updating:!1};const{layers:i,updating:r}=this._allLayers,s={candidates:null};for(const o of i)if(this._processSpatialReferenceCandidates(o,s),s.candidates&&s.candidates.length===1)break;if(((e=s.candidates)==null?void 0:e.length)!==1&&r)return{updating:!0};const n=this._pickSpatialReferenceCandidate(s.candidates);return this._debug("Finished spatial reference",_(n)?`${n.spatialReference.wkid}:${_(n.viewingMode)?CA(n.viewingMode):"global/local"}`:"none available"),{spatialReference:_(n)?n.spatialReference:null,viewingMode:_(n)?n.viewingMode:null,updating:!1}}get _tileInfoTask(){var e,t,i,r,s,n,o,a;if(!this.required.tileInfo)return(a=this._get("_tileInfoTask"))!=null?a:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:c}=this._collectLayers([{parent:(e=this.map)==null||(t=e.call(this))==null?void 0:t.basemap,layers:(i=this.map)==null||(r=i.call(this))==null||(s=r.basemap)==null?void 0:s.baseLayers},{layers:(n=this.map)==null||(o=n.call(this))==null?void 0:o.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const h=l[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:c}}get _heightModelInfoTask(){var e,t;if(!this.required.heightModelInfo||this.suspended&&(e=this._get("_heightModelInfoTask"))!=null&&e.heightModelInfo)return(t=this._get("_heightModelInfoTask"))!=null?t:{updating:!1};const{layers:i,updating:r}=this._allLayers;for(const l of i){var s,n;if(this._debug("Considering",(s=(n=l.title)!=null?n:l.id)!=null?s:l.declaredClass,"for height model info"),jpe(l)){const c=zpe(l);var o,a;if(c)return this._debug("Derived height model info",c),{heightModelInfo:c,vcsWkid:(o=l.spatialReference)==null?void 0:o.vcsWkid,latestVcsWkid:(a=l.spatialReference)==null?void 0:a.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",r),{updating:r}}get _extentCandidatesTask(){var e;if(this.suspended||!this.required.extent)return(e=this._get("_extentCandidatesTask"))!=null?e:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const t=this._allLayers,i=t.updating,r=[];for(const n of t.layers){var s;const o="fullExtents"in n&&n.fullExtents||(_(n.fullExtent)?[n.fullExtent]:[]),a=this.requiresExtentInSpatialReference?null:o[0],l=(s=o.find(c=>c.spatialReference.equals(this.spatialReference)))!=null?s:a;if(l)return{candidates:[{extent:l,layer:n}],updating:!1};if(this._getSupportedSpatialReferences(n).length>0)for(const c of o)r.push({extent:c,layer:n})}return{candidates:r,updating:i}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(O(e)||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:_(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(_(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=xu(this._projectExtentTask.task)),this._debug("Starting project extent task for",i.extent),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:yR(async s=>{try{const n=await qpe(i.extent,r,i.layer.portalItem,s);this._debug("Project extent task finished",n),this._projectExtentTask=me(I({},this._projectExtentTask),{task:null,output:n})}catch{if(Ls(s))return;this._projectExtentTask=me(I({},this._projectExtentTask),{task:null})}})},{updating:!0})}_processSpatialReferenceCandidates(e,t){var i;const r=this._getSupportedSpatialReferences(e);if(r.length!==0)if(this._debug("Spatial reference candidates from",(i=e.title)!=null?i:e.id,":",r.map(s=>`${s.spatialReference.wkid}:${_(s.viewingMode)?CA(s.viewingMode):"global/local"}`).join(", ")),t.candidates){const s=[],n=(o,a)=>O(o.viewingMode)?a.viewingMode:(O(a.viewingMode)||o.viewingMode===a.viewingMode)&&o.viewingMode;for(const o of t.candidates)for(const a of r){if(!o.spatialReference.equals(a.spatialReference))continue;const l=n(o,a);if(l!==!1){s.push({spatialReference:o.spatialReference,viewingMode:l});break}}s.length>0&&(t.candidates=s)}else t.candidates=r}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return!e||e.length<1?_(t)?{spatialReference:t,viewingMode:null}:null:(_(t)&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==$e.Local)&&(e=e.filter(({viewingMode:i})=>i!==$e.Local)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];const i=[];for(const r of t){const s=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(_(s)){const n=_(s.constraints)?s.constraints:[{spatialReference:r}];for(const{spatialReference:o,viewingMode:a}of n)(!this.requiresExtentInSpatialReference||O(this.userSpatialReference)||o.equals(this.userSpatialReference))&&i.push({spatialReference:o,viewingMode:a})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e){var t;if(this._loadMaybe((t=this.map)==null?void 0:t.call(this))!=="loaded")return{layers:[],updating:!0};const i={layers:[],preloading:-1,updating:!1};for(const r of e)if(this._collectCollection(r,i),i.preloading===this.sourcePreloadCount)break;return{layers:i.layers,updating:i.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const s of e.layers){switch(this._loadMaybe(s)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":var i,r;t.updating||(this._debug("Considering layer",(i=(r=s.title)!=null?r:s.id)!=null?i:s.declaredClass),t.layers.push(s)),"layers"in s&&this._collectCollection({layers:s.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e?e.loadStatus==="not-loaded"?(this._debug("Triggering load",(t=(i=e.title)!=null?i:e.id)!=null?t:e.declaredClass),e.load(),"loading"):e.loadStatus:"loaded";var t,i}_debug(...e){this.logDebugInformation&&Wpe.info(...e)}};u([d()],Qi.prototype,"required",void 0),u([d({constructOnly:!0})],Qi.prototype,"map",void 0),u([d({constructOnly:!0})],Qi.prototype,"getSpatialReferenceSupport",void 0),u([d()],Qi.prototype,"defaultSpatialReference",void 0),u([d()],Qi.prototype,"userSpatialReference",void 0),u([d()],Qi.prototype,"sourcePreloadCount",void 0),u([d()],Qi.prototype,"priorityCollection",void 0),u([d()],Qi.prototype,"logDebugInformation",void 0),u([d()],Qi.prototype,"requiresExtentInSpatialReference",void 0),u([d()],Qi.prototype,"suspended",void 0),u([d({readOnly:!0})],Qi.prototype,"ready",null),u([d({readOnly:!0})],Qi.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],Qi.prototype,"spatialReference",null),u([d({readOnly:!0})],Qi.prototype,"extent",null),u([d({readOnly:!0})],Qi.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Qi.prototype,"vcsWkid",null),u([d({readOnly:!0})],Qi.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],Qi.prototype,"viewingMode",null),u([d({readOnly:!0})],Qi.prototype,"tileInfo",null),u([d({readOnly:!0})],Qi.prototype,"mapCollections",null),u([d({readOnly:!0})],Qi.prototype,"_allLayers",null),u([d({readOnly:!0})],Qi.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],Qi.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],Qi.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],Qi.prototype,"_extentCandidatesTask",null),u([d()],Qi.prototype,"_extentTask",null),u([d()],Qi.prototype,"_projectExtentTask",void 0),Qi=u([P("esri.views.support.DefaultsFromMap")],Qi);const Oze=Qi;var _I;const gM=he.getLogger("esri.views.View");let Et=_I=class extends Rm(wr.EventedMixin(AR(we))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new Mx({getCollections:()=>{var t,i,r;return[(t=this.basemapView)==null?void 0:t.baseLayerViews,(i=this.groundView)==null?void 0:i.layerViews,this.layerViews,(r=this.basemapView)==null?void 0:r.referenceLayerViews]},getChildrenFunction:t=>t.layerViews}),this.groundView=null,this.animation=null,this.basemapView=null,this.fatalError=null,this.extent=null,this.graphics=new AA,this.analyses=new yT,this.navigating=!1,this.typeSpecificPreconditionsReady=!0,this.layerViews=new pt,this.magnifier=new $pe,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new Tze,this.navigation=new kpe,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new pze(this),this.persistableViewModels=new pt,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",t=>{var i,r;t?(this._currentSpatialReference=this.spatialReference,_I.views.add(this)):(this._currentSpatialReference=null,_I.views.remove(this)),this.notifyChange("spatialReference"),!t&&this.ready?((i=this.layerViewManager)==null||i.clear(),(r=this.toolViewManager)==null||r.detach(),_(this.analysisViewManager)&&this.analysisViewManager.detach(),this._teardown()):t&&!this.ready&&(_(this.analysisViewManager)&&this.analysisViewManager.attach(),this._startup(),this.toolViewManager.attach())},!0))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,P$(()=>this.ready)))),this.basemapView=new qg({view:this}),this.layerViewManager=new oze({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new _ze({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([Nt(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required=me(I({},this.defaultsFromMap.required),{extent:e}),{sync:!0,initial:!0}),Nt(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},{sync:!0}),Nt(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.handles.add([Nt(()=>{var t;return(t=this.defaultsFromMap)==null?void 0:t.ready},t=>{var i;const r=((i=this.map)==null?void 0:i.allLayers.length)>0;if(t&&!this.spatialReference&&r){if(_(e))return;const s=Sm(()=>e=xu(e));e=yR(async n=>{try{await Wx(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{e=null}gM.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=it(this.graphics),this.analyses=it(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager=it(this.toolViewManager),this.layerViewManager=it(this.layerViewManager),this.basemapView=it(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,e==null||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return gM.error("#toMap()","Not implemented on this instance of View"),null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Oze(I({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e)},this._defaultsFromMapSettings))}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){var e;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||mm.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!(this._currentSpatialReference||(e=this.defaultsFromMap)!=null&&e.ready)||!this.typeSpecificPreconditionsReady)}set map(e){var t;e!==this._get("map")&&((t=e)!=null&&t.destroyed&&(gM.warn("#map","The provided map is already destroyed",{map:e}),e=null),mm.isLoadable(e)&&e.load().catch(()=>{}),this.initialized&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}get spatialReference(){var e,t;let i=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return i&&(e=this.defaultsFromMap)!=null&&(t=e.required)!=null&&t.heightModelInfo&&(i=i.clone(),i.vcsWkid=this.defaultsFromMap.vcsWkid,i.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),i}set spatialReference(e){const t=!bc(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){var e;return(e=this.defaultsFromMap)==null?void 0:e.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return _(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getDefaultSpatialReference(){var e;return(e=this.defaultsFromMap)==null?void 0:e.spatialReference}getDefaultHeightModelInfo(){var e,t,i;return(e=(t=this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)!=null?t:(i=this.defaultsFromMap)==null?void 0:i.heightModelInfo)!=null?e:null}importLayerView(e){throw new Q("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{}}_validateSpatialReference(e){return _(this.getSpatialReferenceSupport({spatialReference:e}))}when(e,t){return this.isResolved()&&!this.ready&&gM.warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(JL(()=>this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Et.views=new pt,u([d()],Et.prototype,"_userSpatialReference",void 0),u([mt("toolViewManager.activeTool")],Et.prototype,"activeTool",void 0),u([d({readOnly:!0})],Et.prototype,"allLayerViews",void 0),u([d()],Et.prototype,"groundView",void 0),u([d()],Et.prototype,"animation",void 0),u([d()],Et.prototype,"basemapView",void 0),u([d({readOnly:!0})],Et.prototype,"_defaultsFromMapSettings",null),u([d()],Et.prototype,"defaultsFromMap",null),u([d()],Et.prototype,"fatalError",void 0),u([d({type:Zt})],Et.prototype,"extent",void 0),u([d(V6(AA,"graphics"))],Et.prototype,"graphics",void 0),u([d(V6(yT,"analyses"))],Et.prototype,"analyses",void 0),u([d({readOnly:!0,type:lS})],Et.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Et.prototype,"interacting",null),u([d({readOnly:!0})],Et.prototype,"navigating",void 0),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Et.prototype,"preconditionsReady",null),u([d({readOnly:!0})],Et.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:pt,readOnly:!0})],Et.prototype,"layerViews",void 0),u([d({type:$pe})],Et.prototype,"magnifier",void 0),u([d({value:null,type:rze})],Et.prototype,"map",null),u([d()],Et.prototype,"padding",void 0),u([d({readOnly:!0})],Et.prototype,"ready",void 0),u([d({type:tt})],Et.prototype,"spatialReference",null),u([d()],Et.prototype,"spatialReferenceWarningDelay",void 0),u([d()],Et.prototype,"stationary",null),u([d({readOnly:!0})],Et.prototype,"supportsGround",void 0),u([d({type:Ap})],Et.prototype,"timeExtent",void 0),u([mt("toolViewManager.tools")],Et.prototype,"tools",void 0),u([d()],Et.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],Et.prototype,"type",void 0),u([d({type:Number})],Et.prototype,"scale",void 0),u([d({readOnly:!0})],Et.prototype,"updating",void 0),u([d({readOnly:!0})],Et.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],Et.prototype,"initialExtent",null),u([d()],Et.prototype,"cursor",null),u([d({readOnly:!0})],Et.prototype,"input",void 0),u([d({type:kpe,nonNullable:!0})],Et.prototype,"navigation",void 0),u([d()],Et.prototype,"layerViewManager",void 0),u([d()],Et.prototype,"analysisViewManager",void 0),u([d()],Et.prototype,"width",void 0),u([d()],Et.prototype,"height",void 0),u([d({readOnly:!0})],Et.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],Et.prototype,"size",null),u([d({readOnly:!0})],Et.prototype,"suspended",void 0),u([d({readOnly:!0})],Et.prototype,"viewEvents",void 0),u([d({readOnly:!0})],Et.prototype,"persistableViewModels",void 0),u([d()],Et.prototype,"_isValid",void 0),u([d()],Et.prototype,"_readyCycleForced",void 0),u([d()],Et.prototype,"_currentSpatialReference",void 0),Et=_I=u([P("esri.views.View")],Et);const Mze=Et;let Xg=class extends M${constructor(e){super(e),this.state="running",this.target=null}initialize(){this.addResolvingPromise(new Promise((e,t)=>this._dfd={resolve:e,reject:t}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._dfd.reject(new Q("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._dfd.resolve())}update(e,t){t||(t=_c(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};u([d({readOnly:!0})],Xg.prototype,"done",null),u([d({readOnly:!0,type:String})],Xg.prototype,"state",void 0),u([d()],Xg.prototype,"target",void 0),Xg=u([P("esri.views.ViewAnimation")],Xg),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Xg||(Xg={}));const ST=Xg,ZS=()=>import("./TileLayerView3D.327f5c6b.js"),fJ=()=>Promise.resolve().then(function(){return Art}),mJ={analysis:()=>import("./AnalysisLayerView3D.ab6a9916.js"),"base-dynamic":()=>import("./BaseDynamicLayerView3D.7838967f.js"),"base-elevation":fJ,"base-tile":ZS,"bing-maps":ZS,"building-scene":()=>import("./BuildingSceneLayerView3D.56d6a261.js"),csv:()=>import("./CSVLayerView3D.f7cad309.js"),elevation:fJ,feature:()=>import("./FeatureLayerView3D.caee51fb.js"),geojson:()=>import("./GeoJSONLayerView3D.a38adc43.js"),graphics:()=>import("./GraphicsLayerView3D.743fe4aa.js"),group:()=>import("./GroupLayerView.623bfeba.js"),imagery:()=>import("./ImageryLayerView3D.e6cbc8cb.js"),"integrated-mesh":()=>import("./IntegratedMeshLayerView3D.22d1c87e.js"),"map-image":()=>import("./MapImageLayerView3D.b70a84b3.js"),"ogc-feature":()=>import("./OGCFeatureLayerView3D.a733bd02.js"),"open-street-map":ZS,"point-cloud":()=>import("./PointCloudLayerView3D.9837b414.js").then(function(e){return e.P}),voxel:()=>import("./VoxelLayerView3D.9e6f71ce.js"),route:()=>import("./RouteLayerView3D.654f7300.js"),scene:e=>e.profile==null||e.profile==="mesh-pyramids"?import("./SceneLayerView3D.49ebb9a9.js"):import("./SceneLayerGraphicsView3D.e228613a.js"),stream:()=>import("./StreamLayerView3D.2e95f416.js"),tile:ZS,"imagery-tile":()=>import("./ImageryTileLayerView3D.665c3bd8.js"),"vector-tile":()=>import("./VectorTileLayerView3D.024bf42c.js"),wcs:()=>import("./ImageryTileLayerView3D.665c3bd8.js"),"web-tile":ZS,wfs:()=>import("./WFSLayerView3D.39787223.js"),wms:()=>import("./WMSLayerView3D.77e320ea.js"),wmts:()=>import("./WMTSLayerView3D.a4f309c1.js"),"geo-rss":null,kml:null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function Pze(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Q(`${i}:view-not-supported`,`${t} is not supported in 3D`)}const gJ={hasLayerViewModule:e=>_(mJ[e.type]),importLayerView:e=>{const t=mJ[e.type];if(!_(t))throw Pze(e);return t(e)}},Ize=he.getLogger("esri.views.3d.analysis.AnalysisViewManager3D"),yJ="analyses-owner-handles";var lx,m_;(function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"})(lx||(lx={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(m_||(m_={}));let Hv=class extends Rm(we){constructor(e){super(e),this._allAnalysisViews=new pt,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this.detach()}attach(){this.handles.add(this._connectOwner(this.view),yJ)}detach(){this.handles.remove(yJ),this._update(),this._creatingViewCount=0}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}whenAnalysisView(e){const t=this._items.get(e);if(O(t)||t.state.list===m_.REMOVED){const i=new Q("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return Promise.reject(i)}return t.createAnalysisViewTask.promise}_connectOwner(e){return this._connectAnalysesCollection(e.analyses)}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return{remove:()=>{t.remove(),i.remove();for(const r of e)this._removeAnalysis(r)}}}_addAnalysis(e){const t=this._items.get(e);if(t==null){const i={state:{view:lx.PENDING,list:m_.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=yR(r=>this._createAnalysisViewPromise(i,r))}else t.state.list=m_.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=m_.REMOVED,this._scheduleUpdate()):Ize.error("Trying to remove analysis which was not added")}_scheduleUpdate(){_(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=vR(()=>this._update()))}_update(){this._scheduledUpdateHandle=Ys(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===m_.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case lx.PENDING:e.createAnalysisViewTask=xu(e.createAnalysisViewTask);break;case lx.CREATED:_(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=it(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,O(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(Ls(t))throw this._creatingViewCount-=1,pi("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(Ls(t))throw this._creatingViewCount-=1,n.destroy(),pi("AnalysisView creation aborted");return e.view=n,e.state.view=lx.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./AreaMeasurementAnalysisView3D.918065be.js").then(function(t){return t.A});case"direct-line-measurement":return import("./DirectLineMeasurementAnalysisView3D.0d18b695.js").then(function(t){return t.D});case"line-of-sight":return import("./LineOfSightAnalysisView3D.9a2aadfc.js");case"slice":return import("./SliceAnalysisView3D.ee6e0c81.js").then(function(t){return t.S});default:return null}}};u([d()],Hv.prototype,"updating",null),u([d({constructOnly:!0})],Hv.prototype,"view",void 0),u([d()],Hv.prototype,"_allAnalysisViews",void 0),u([d()],Hv.prototype,"_creatingViewCount",void 0),Hv=u([P("esri.views.3d.analysis.AnalysisViewManager3D")],Hv);const $ze=Hv,Dze=he.getLogger("esri.views.3d.state.Constraints");let vf=class extends we{constructor(e){super(e),this.collision=new IE,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return this.mode===$e.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==$e.Local?this._set("altitude",e):Dze.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ze(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return ze(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===$e.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=L5)=>(i.min=$n.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?f3([[4e3,$n.max],[1e4,Ct(88)],[6e6,Ct(88)]]):()=>$n.max;return(t,i=L5)=>(i.min=$n.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?f3([[4e3,$n.max],[5e4,Ct(88)],[6e6,Ct(88)],[2e7,$n.min]]):f3([[3e5,$n.max],[3e6,Ct(88)],[6e6,Ct(88)],[2e7,$n.min]]);return(t,i=L5)=>(i.min=$n.min,i.max=e(t),i)}};function Lze(e){return{min:-2e5,max:4*e.radius}}u([d()],vf.prototype,"altitude",null),u([d({readOnly:!0})],vf.prototype,"collision",void 0),u([d()],vf.prototype,"distance",void 0),u([d({readOnly:!0})],vf.prototype,"minimumPoiDistance",void 0),u([d()],vf.prototype,"tilt",void 0),u([d({constructOnly:!0})],vf.prototype,"mode",void 0),vf=u([P("esri.views.3d.state.Constraints")],vf);const vJ=Lze(ai),$n={min:Ct(.5),max:Ct(179.5)},L5={min:0,max:0};let IE=class extends we{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],IE.prototype,"enabled",void 0),u([d({type:Number})],IE.prototype,"elevationMargin",void 0),IE=u([P("esri.views.3d.state.Constraints.CollisionConstraint")],IE);const Nze=vf;let $E=class extends we{constructor(){super(...arguments),this.min=vJ.min,this.max=vJ.max}set mode(e){jx(he.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return jx(he.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};u([d({type:Number})],$E.prototype,"min",void 0),u([d({type:Number})],$E.prototype,"max",void 0),$E=u([P("esri.views.3d.constraints.AltitudeConstraint")],$E);const Xpe=$E;let Yg=class extends we{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};u([d({type:Number,value:1e-8})],Yg.prototype,"near",null),u([It("near")],Yg.prototype,"castNear",null),u([d({type:Number,value:1e-8})],Yg.prototype,"far",null),u([It("far")],Yg.prototype,"castFar",null),u([d({type:["auto","manual"]})],Yg.prototype,"mode",void 0),Yg=u([P("esri.views.3d.constraints.ClipDistanceConstraint")],Yg);const Ype=Yg,u8={min:pl($n.min),max:pl($n.max)};let Mw=class extends we{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ze(e,u8.min,u8.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],Mw.prototype,"mode",void 0),u([d({type:Number,value:u8.max})],Mw.prototype,"max",null),u([It("max")],Mw.prototype,"castMax",null),Mw=u([P("esri.views.3d.constraints.TiltConstraint")],Mw);const Zpe=Mw;let Pw=class extends we{constructor(){super(...arguments),this.tilt=new Zpe,this.altitude=new Xpe,this.clipDistance=new Ype}};u([d({type:Zpe})],Pw.prototype,"tilt",void 0),u([d({type:Xpe})],Pw.prototype,"altitude",void 0),u([d({type:Ype})],Pw.prototype,"clipDistance",void 0),Pw=u([P("esri.views.3d.constraints.Constraints")],Pw);const Qpe=Pw;var h8;let ah=h8=class extends ve{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new h8(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date.getTime())),e}};u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],ah.prototype,"date",void 0),u([Fe("date",["datetime"])],ah.prototype,"readDate",null),u([Ge("date")],ah.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],ah.prototype,"directShadowsEnabled",void 0),u([Fe("directShadowsEnabled",["directShadows"])],ah.prototype,"readDirectShadowsEnabled",null),u([Ge("directShadowsEnabled")],ah.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],ah.prototype,"displayUTCOffset",void 0),u([Ge("displayUTCOffset")],ah.prototype,"writeDisplayUTCOffset",null),ah=h8=u([P("esri.webscene.Lighting")],ah);const ET=ah;var Iw;let lh=Iw=class extends wr.EventedMixin(ET){constructor(e){super(e),this.type="sun",this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=new Date().getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new Iw(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){e!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=Iw.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;e!=null&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=Iw.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(N5.target=this,N5.timezoneOffset=s,this.emit("timezone-will-change",N5)),e!=null)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new Iw(me(I({},this.cloneConstructProperties()),{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return e.date!=null&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};u([d({readOnly:!0})],lh.prototype,"type",void 0),u([d({type:Boolean})],lh.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],lh.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],lh.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],lh.prototype,"defaultDate",null),u([d({type:Date})],lh.prototype,"date",null),lh=Iw=u([P("esri.views.3d.environment.SunLighting")],lh),function(e){function t({hours:i,minutes:r,seconds:s}){return Math.round(i+r/60+s/3600)}e.calculateTimezoneOffset=t}(lh||(lh={}));const N5={target:null,timezoneOffset:0},qv=lh;var d8;let $w=d8=class extends wr.EventedMixin(ET){constructor(e){super(e),this.type="virtual",this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1}clone(){return new d8(me(I({},this.cloneConstructProperties()),{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}))}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}};u([d({readOnly:!0})],$w.prototype,"type",void 0),u([d({type:Boolean})],$w.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],$w.prototype,"waterReflectionEnabled",void 0),$w=d8=u([P("esri.views.3d.environment.VirtualLighting")],$w);const Jpe=$w,Fze={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:qv,virtual:Jpe}};var p8;let bI=p8=class extends we{set quality(e){["low","high"].indexOf(e)!==-1&&this._set("quality",e)}clone(){return new p8({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],bI.prototype,"quality",null),bI=p8=u([P("esri.views.3d.environment.SceneViewAtmosphere")],bI);const Kpe=bI;var f8;let DE=f8=class extends ve{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new f8({cloudCover:this.cloudCover})}};u([ht({sunny:"sunny"})],DE.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],DE.prototype,"cloudCover",void 0),DE=f8=u([P("esri.views.3d.environment.SunnyWeather")],DE);const efe=DE;var m8;let LE=m8=class extends ve{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new m8({cloudCover:this.cloudCover})}};u([ht({cloudy:"cloudy"})],LE.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],LE.prototype,"cloudCover",void 0),LE=m8=u([P("esri.views.3d.environment.CloudyWeather")],LE);const Uze=LE;var g8;let NE=g8=class extends ve{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new g8({fogStrength:this.fogStrength})}};u([ht({foggy:"foggy"})],NE.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],NE.prototype,"fogStrength",void 0),NE=g8=u([P("esri.views.3d.environment.FoggyWeather")],NE);const kze=NE;var y8;let Dw=y8=class extends ve{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new y8({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ht({rainy:"rainy"})],Dw.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Dw.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Dw.prototype,"precipitation",void 0),Dw=y8=u([P("esri.views.3d.environment.RainyWeather")],Dw);const zze=Dw;var v8;let Lw=v8=class extends we{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5}clone(){return new v8({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ht({snowy:"snowy"})],Lw.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Lw.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Lw.prototype,"precipitation",void 0),Lw=v8=u([P("esri.views.3d.environment.SnowyWeather")],Lw);const Bze=Lw,tfe={key:"type",base:null,typeMap:{sunny:efe,cloudy:Uze,rainy:zze,snowy:Bze,foggy:kze}},_J=Object.keys(tfe.typeMap);function Vze(){return ue("enable-feature:precipitation")?_J:_J.filter(e=>e!=="snowy")}function Gze(e,t){return!!Vze().includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)}const su=1e4;let wI=class extends ve{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],wI.prototype,"type",void 0),wI=u([P("esri.webscene.background.Background")],wI);const ife=wI;var _8;const jze=me(I({},Cm),{nonNullable:!0});let FE=_8=class extends ife{constructor(e){super(e),this.type="color",this.color=new Qe([0,0,0,1])}clone(){return new _8(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([ht({color:"color"},{readOnly:!0})],FE.prototype,"type",void 0),u([d(jze)],FE.prototype,"color",void 0),FE=_8=u([P("esri.webscene.background.ColorBackground")],FE);const rfe=FE,bJ={base:ife,key:"type",typeMap:{color:rfe}};function Hze(e){return(t,i,r)=>{if(!t)return t;for(const s in e.typeMap)if(t.type===s){const n=new e.typeMap[s];return n.read(t,r),n}}}const qze={types:bJ,json:{read:Hze(bJ),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var b8;const wJ=(e,t,i)=>({enabled:!i||!i.isPresentation});let Wv=b8=class extends ve{constructor(e){super(e),this.lighting=new ET,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new b8(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:ET.prototype.clone.call(this.lighting),background:se(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};u([d({type:ET,json:{write:!0}})],Wv.prototype,"lighting",void 0),u([d(qze)],Wv.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:wJ}}})],Wv.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:wJ}}})],Wv.prototype,"starsEnabled",void 0),Wv=b8=u([P("esri.webscene.Environment")],Wv);const sfe=Wv;var UE;const Wze=he.getLogger("esri.views.3d.environment.SceneViewEnvironment");let Xv=UE=class extends sfe{constructor(e){super(e),this.atmosphere=new Kpe,this.lighting=new qv}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new UE(me(I({},t),{lighting:qv.fromWebsceneLighting(t.lighting)}))}set weather(e){Gze(e==null?void 0:e.type,Wze)&&this._set("weather",e)}castLighting(e){return this._convertLighting(e)}applyLighting(e){this.lighting=this._convertLighting(e)}_convertLighting(e){return e?e instanceof qv||e instanceof Jpe?e:e instanceof ET?((t=this.lighting)==null?void 0:t.type)==="sun"?this.lighting.cloneWithWebsceneLighting(e):qv.fromWebsceneLighting(e):Fh(Fze,e):new qv;var t}clone(){return new UE({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:se(this.background)})}cloneWithWebsceneEnvironment(e){return new UE(me(I({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:se(this.background)},e.cloneConstructProperties()),{lighting:this.lighting.type&&this.lighting.type!=="sun"?qv.fromWebsceneLighting(e.lighting):this.lighting.cloneWithWebsceneLighting(e.lighting)}))}};u([d({type:Kpe,json:{read:!1},nonNullable:!0})],Xv.prototype,"atmosphere",void 0),u([d({types:tfe,nonNullable:!0,json:{write:!1},value:new efe})],Xv.prototype,"weather",null),u([d({nonNullable:!0})],Xv.prototype,"lighting",void 0),u([It("lighting")],Xv.prototype,"castLighting",null),Xv=UE=u([P("esri.views.3d.environment.SceneViewEnvironment")],Xv);const Nw=Xv;function Fs(e,t){return e[0]=t[0],e[1]=t[1],e}function tr(e,t,i){return e[0]=t,e[1]=i,e}function _h(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function Qd(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function nfe(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function ofe(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function Xze(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function Yze(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function Zze(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function Qze(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function Jze(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function tl(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function Kze(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e}function Px(e,t){const i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}function SD(e,t){const i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r}function Ij(e){const t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function afe(e){const t=e[0],i=e[1];return t*t+i*i}function $j(e,t){return e[0]=-t[0],e[1]=-t[1],e}function e6e(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function TC(e,t){const i=t[0],r=t[1];let s=i*i+r*r;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e}function ps(e,t){return e[0]*t[0]+e[1]*t[1]}function t6e(e,t,i){const r=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=r,e}function Fw(e,t,i,r){const s=t[0],n=t[1];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e}function i6e(e,t){t=t||1;const i=2*Sh()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function w8(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s,e[1]=i[1]*r+i[3]*s,e}function Yv(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s+i[4],e[1]=i[1]*r+i[3]*s+i[5],e}function r6e(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[3]*s+i[6],e[1]=i[1]*r+i[4]*s+i[7],e}function s6e(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[4]*s+i[12],e[1]=i[1]*r+i[5]*s+i[13],e}function n6e(e,t,i,r){const s=t[0]-i[0],n=t[1]-i[1],o=Math.sin(r),a=Math.cos(r);return e[0]=s*a-n*o+i[0],e[1]=s*o+n*a+i[1],e}function o6e(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];let o=i*i+r*r;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(i*s+r*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function a6e(e){return"vec2("+e[0]+", "+e[1]+")"}function lfe(e,t){return e[0]===t[0]&&e[1]===t[1]}function l6e(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];return Math.abs(i-s)<=wt*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-n)<=wt*Math.max(1,Math.abs(r),Math.abs(n))}function c6e(e,t,i,r,s){let n=t[0]-i[0],o=t[1]-i[1];const a=(r[0]*n+r[1]*o)*(s-1);return n=r[0]*a,o=r[1]*a,e[0]=t[0]+n,e[1]=t[1]+o,e}const u6e=Ij,h6e=Qd,d6e=nfe,p6e=ofe,cfe=Px,f6e=SD,m6e=afe;Object.freeze({__proto__:null,copy:Fs,set:tr,add:_h,subtract:Qd,multiply:nfe,divide:ofe,ceil:Xze,floor:Yze,min:Zze,max:Qze,round:Jze,scale:tl,scaleAndAdd:Kze,distance:Px,squaredDistance:SD,length:Ij,squaredLength:afe,negate:$j,inverse:e6e,normalize:TC,dot:ps,cross:t6e,lerp:Fw,random:i6e,transformMat2:w8,transformMat2d:Yv,transformMat3:r6e,transformMat4:s6e,rotate:n6e,angle:o6e,str:a6e,exactEquals:lfe,equals:l6e,projectAndScale:c6e,len:u6e,sub:h6e,mul:d6e,div:p6e,dist:cfe,sqrDist:f6e,sqrLen:m6e});function ufe(e){return Math.min(1,Math.max(0,(e-1e5)/(1e6-1e5)))}const x8=1e4,pb=je(5802e-9,13558e-9,331e-7),F5=3,U5=je(65e-8*F5,1881e-9*F5,85e-9*F5),g6e=3996e-9,y6e=.085,xI=1e5;function x(e,...t){let i="";for(let r=0;r<t.length;r++)i+=e[r]+t[r];return i+=e[e.length-1],i}(function(e){function t(r){return Math.round(r).toString()}function i(r){return r.toPrecision(8)}e.int=t,e.float=i})(x||(x={}));var E;(function(e){e.POSITION="position",e.NORMAL="normal",e.UV0="uv0",e.AUXPOS1="auxpos1",e.AUXPOS2="auxpos2",e.MAPPOS="mapPos",e.COLOR="color",e.SYMBOLCOLOR="symbolColor",e.SIZE="size",e.TANGENT="tangent",e.OFFSET="offset",e.SUBDIVISIONFACTOR="subdivisionFactor",e.COLORFEATUREATTRIBUTE="colorFeatureAttribute",e.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",e.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",e.DISTANCETOSTART="distanceToStart",e.UVMAPSPACE="uvMapSpace",e.BOUNDINGRECT="boundingRect",e.UVREGION="uvRegion",e.NORMALCOMPRESSED="normalCompressed",e.PROFILERIGHT="profileRight",e.PROFILEUP="profileUp",e.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",e.FEATUREVALUE="featureValue",e.MODELORIGINHI="modelOriginHi",e.MODELORIGINLO="modelOriginLo",e.MODEL="model",e.MODELNORMAL="modelNormal",e.INSTANCECOLOR="instanceColor",e.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",e.LOCALTRANSFORM="localTransform",e.GLOBALTRANSFORM="globalTransform",e.BOUNDINGSPHERE="boundingSphere",e.MODELORIGIN="modelOrigin",e.MODELSCALEFACTORS="modelScaleFactors",e.FEATUREATTRIBUTE="featureAttribute",e.STATE="state",e.LODLEVEL="lodLevel",e.POSITION0="position0",e.POSITION1="position1",e.NORMALA="normalA",e.NORMALB="normalB",e.COMPONENTINDEX="componentIndex",e.VARIANTOFFSET="variantOffset",e.VARIANTSTROKE="variantStroke",e.VARIANTEXTENSION="variantExtension",e.U8PADDING="u8padding",e.U16PADDING="u16padding",e.SIDENESS="sideness",e.START="start",e.END="end",e.UP="up",e.EXTRUDE="extrude"})(E||(E={}));function tm(e,t){t.attributeTextureCoordinates===mn.Default&&(e.attributes.add(E.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
}`)),t.attributeTextureCoordinates===mn.Atlas&&(e.attributes.add(E.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(E.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`)),t.attributeTextureCoordinates===mn.None&&e.vertex.code.add(x`void forwardTextureCoordinates() {}`)}var mn;(function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.COUNT=3]="COUNT"})(mn||(mn={}));function Yh(e){e.code.add(x`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function As(e){e.include(Yh),e.code.add(x`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function kN(e){e.fragment.code.add(x`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}const v6e=he.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class hfe{constructor(){this.includedModules=new Map}include(t,i){this.includedModules.has(t)?this.includedModules.get(t)!==i&&v6e.error("Trying to include shader module multiple times with different sets of options."):(this.includedModules.set(t,i),t(this.builder,i))}}class Ri extends hfe{constructor(){super(...arguments),this.vertex=new xJ,this.fragment=new xJ,this.attributes=new w6e,this.varyings=new x6e,this.extensions=new AT,this.constants=new zr}get fragmentUniforms(){return this.fragment.uniforms}get builder(){return this}generateSource(t){const i=this.extensions.generateSource(t),r=this.attributes.generateSource(t),s=this.varyings.generateSource(),n=t==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=t==="vertex"?S6e:T6e,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${i.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${r.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}}class _6e{constructor(){this._entries=new Map}add(t,i,r){const s=`${t}_${i}_${r}`;return this._entries.set(s,{name:t,type:i,arraySize:r}),this}generateSource(){const t=i=>i?`[${i}]`:"";return Array.from(this._entries.values()).map(i=>`uniform ${i.type} ${i.name}${t(i.arraySize)};`)}get entries(){return Array.from(this._entries.values())}}class b6e{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class xJ extends hfe{constructor(){super(...arguments),this.uniforms=new _6e,this.code=new b6e,this.constants=new zr}get builder(){return this}}class w6e{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(t){return t==="fragment"?[]:this._entries.map(i=>`attribute ${i[1]} ${i[0]};`)}}class x6e{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(){return this._entries.map(t=>`varying ${t[1]} ${t[0]};`)}}class AT{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const i=t==="vertex"?AT.ALLOWLIST_VERTEX:AT.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(r=>i.includes(r)).map(r=>`#extension ${r} : enable`)}}AT.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],AT.ALLOWLIST_VERTEX=[];class zr{constructor(){this._entries=[]}add(t,i,r){let s="ERROR_CONSTRUCTOR_STRING";switch(i){case"float":s=zr._numberToFloatStr(r);break;case"int":s=zr._numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${zr._numberToFloatStr(r[0])},                            ${zr._numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${zr._numberToFloatStr(r[0])},                            ${zr._numberToFloatStr(r[1])},                            ${zr._numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${zr._numberToFloatStr(r[0])},                            ${zr._numberToFloatStr(r[1])},                            ${zr._numberToFloatStr(r[2])},                            ${zr._numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${zr._numberToIntStr(r[0])},                             ${zr._numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${zr._numberToIntStr(r[0])},                             ${zr._numberToIntStr(r[1])},                             ${zr._numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${zr._numberToIntStr(r[0])},                             ${zr._numberToIntStr(r[1])},                             ${zr._numberToIntStr(r[2])},                             ${zr._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${i}(${Array.prototype.map.call(r,n=>zr._numberToFloatStr(n)).join(", ")})`}return this._entries.push(`const ${i} ${t} = ${s};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}const T6e=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,S6e=`precision highp float;
precision highp sampler2D;`;function E6e(e){const t=new Ri;return t.attributes.add(E.POSITION,"vec2"),t.include(tm,{attributeTextureCoordinates:mn.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("betaMie","float").add("hazeStrength","float"),t.include(kN),e.haze&&t.fragment.include(As),t.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(x`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),t.fragment.code.add(x`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),t.fragment.code.add(x`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?x`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?x``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":x`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${e.haze?x`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:x`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?x`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:x`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${e.haze?x`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:x`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":x`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),t}const A6e=Object.freeze({__proto__:null,build:E6e});class Li{constructor(t,i){this._module=t,this._loadModule=i}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}class Vi{constructor(t,i,r){this.release=r,i&&(this._config=i.snapshot()),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}destroy(){this._program=et(this._program),this._pipeline=this._config=null}reload(t){et(this._program),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}get program(){return this._program}get key(){return this._config.key}get configuration(){return this._config}bindPass(t,i){}bindMaterial(t,i){}bindDraw(t){}bindPipelineState(t,i=null,r){t.setPipelineState(this.getPipelineState(i,r))}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}get primitiveType(){return Tt.TRIANGLES}getPipelineState(t,i){return this._pipeline}}class dr{constructor(){this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const t=this._parameterNames,i={key:this.key};for(const r of t)i[r]=this[r];return i}}function Y(e={}){return(t,i)=>{var r,s;t._parameterNames=(r=t._parameterNames)!=null?r:[],t._parameterNames.push(i);const n=t._parameterNames.length-1,o=e.count||2,a=Math.ceil(Math.log2(o)),l=(s=t._parameterBits)!=null?s:[0];let c=0;for(;l[c]+a>16;)c++,c>=l.length&&l.push(0);t._parameterBits=l;const h=l[c],p=(1<<a)-1<<h;l[c]+=a,Object.defineProperty(t,i,{get(){return this[n]},set(f){if(this[n]!==f&&(this[n]=f,this._keyDirty=!0,this._parameterBits[c]=this._parameterBits[c]&~p|+f<<h&p,typeof f!="number"&&typeof f!="boolean"))throw"Configuration value for "+i+" must be boolean or number, got "+typeof f}})}}const mi=new Map([[E.POSITION,0],[E.NORMAL,1],[E.UV0,2],[E.COLOR,3],[E.SIZE,4],[E.TANGENT,4],[E.AUXPOS1,5],[E.SYMBOLCOLOR,5],[E.AUXPOS2,6],[E.FEATUREATTRIBUTE,6],[E.INSTANCEFEATUREATTRIBUTE,6],[E.INSTANCECOLOR,7],[E.MODEL,8],[E.MODELNORMAL,12],[E.MODELORIGINHI,11],[E.MODELORIGINLO,15]]),C6e=he.getLogger("esri/views/webgl");function R6e(e,t){switch(t){case e.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case e.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case e.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case e.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case e.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case e.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const dfe=!!ue("enable-feature:webgl-debug");function eu(){return dfe}function SC(){return dfe}function Ly(e){if(eu()){const t=e.getError();if(t){const i=R6e(e,t),r=new Error().stack;C6e.error(new Q("webgl-error","WebGL error occured",{message:i,stack:r}))}}}class Oi{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new $t({deallocator:null}),this._glProgram=t.programCache.acquire(i.generateSource("vertex"),i.generateSource("fragment"),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this._fragmentUniforms=eu()?i.fragmentUniforms.entries:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get isCompiled(){return this._glProgram.isCompiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i){this._glProgram.setUniform1f(t,i)}setUniform1fv(t,i){this._glProgram.setUniform1fv(t,i)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2f(t,i,r){this._glProgram.setUniform2f(t,i,r)}setUniform2fv(t,i){this._glProgram.setUniform2fv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform2iv(t,i)}setUniform3f(t,i,r,s){this._glProgram.setUniform3f(t,i,r,s)}setUniform3fv(t,i){this._glProgram.setUniform3fv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4f(t,i,r,s,n){this._glProgram.setUniform4f(t,i,r,s,n)}setUniform4fv(t,i){this._glProgram.setUniform4fv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}setUniformMatrix3fv(t,i){this._glProgram.setUniformMatrix3fv(t,i)}setUniformMatrix4fv(t,i){this._glProgram.setUniformMatrix4fv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,i){if(O(t)||t.glName==null){const s=this._textures.get(i);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(i)),null}let r=this._textures.get(i);return r==null?(r=this._allocTextureUnit(t),this._textures.set(i,r)):r.texture=t,this._context.useProgram(this),this.setUniform1i(i,r.unit),this._context.bindTexture(t,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,i)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(i,t.unit)}),_(this._fragmentUniforms)&&this._fragmentUniforms.forEach(t=>{if((t.type==="sampler2D"||t.type==="samplerCube")&&!this._textures.has(t.name))throw new Error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}}var $i,_1,g_,at,ts,ua,ba,CT,vm,wa,Wy,RT,Ai,b1;(function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.COUNT=3]="COUNT"})($i||($i={})),function(e){e[e.Less=0]="Less",e[e.Lequal=1]="Lequal",e[e.COUNT=2]="COUNT"}(_1||(_1={})),function(e){e[e.NONE=0]="NONE",e[e.SMAA=1]="SMAA"}(g_||(g_={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.FrontFace=2]="FrontFace",e[e.NONE=3]="NONE",e[e.COUNT=4]="COUNT"}(at||(at={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.UPDATE=1]="UPDATE"}(ts||(ts={})),function(e){e[e.NOT_LOADED=0]="NOT_LOADED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(ua||(ua={})),function(e){e[e.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",e[e.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(ba||(ba={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(CT||(CT={})),function(e){e[e.Highlight=0]="Highlight",e[e.MaskOccludee=1]="MaskOccludee",e[e.COUNT=2]="COUNT"}(vm||(vm={})),function(e){e[e.Triangle=0]="Triangle",e[e.Point=1]="Point",e[e.Line=2]="Line"}(wa||(wa={})),function(e){e[e.STRETCH=1]="STRETCH",e[e.PAD=2]="PAD"}(Wy||(Wy={})),function(e){e[e.CHANGED=0]="CHANGED",e[e.UNCHANGED=1]="UNCHANGED"}(RT||(RT={})),function(e){e[e.Blend=0]="Blend",e[e.Opaque=1]="Opaque",e[e.Mask=2]="Mask",e[e.MaskBlend=3]="MaskBlend",e[e.COUNT=4]="COUNT"}(Ai||(Ai={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(b1||(b1={}));function gc(e,t,i=fp.ADD,r=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function Vn(e,t,i,r,s=fp.ADD,n=fp.ADD,o=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const Dj={face:ma.BACK,mode:gT.CCW},pfe={face:ma.FRONT,mode:gT.CCW},zN=e=>e===$i.Back?Dj:e===$i.Front?pfe:null,Aa={zNear:0,zFar:1},Ft={r:!0,g:!0,b:!0,a:!0};function O6e(e){return F6e.intern(e)}function M6e(e){return U6e.intern(e)}function P6e(e){return k6e.intern(e)}function I6e(e){return z6e.intern(e)}function $6e(e){return B6e.intern(e)}function D6e(e){return V6e.intern(e)}function L6e(e){return G6e.intern(e)}function N6e(e){return j6e.intern(e)}function Rt(e){return H6e.intern(e)}class Mm{constructor(t,i){this.makeKey=t,this.makeRef=i,this.interns=new Map}intern(t){if(!t)return null;const i=this.makeKey(t),r=this.interns;return r.has(i)||r.set(i,this.makeRef(t)),r.get(i)}}function Pm(e){return"["+e.join(",")+"]"}const F6e=new Mm(ffe,e=>I({__tag:"Blending"},e));function ffe(e){return e?Pm([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const U6e=new Mm(mfe,e=>I({__tag:"Culling"},e));function mfe(e){return e?Pm([e.face,e.mode]):null}const k6e=new Mm(gfe,e=>I({__tag:"PolygonOffset"},e));function gfe(e){return e?Pm([e.factor,e.units]):null}const z6e=new Mm(yfe,e=>I({__tag:"DepthTest"},e));function yfe(e){return e?Pm([e.func]):null}const B6e=new Mm(vfe,e=>I({__tag:"StencilTest"},e));function vfe(e){return e?Pm([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const V6e=new Mm(_fe,e=>I({__tag:"DepthWrite"},e));function _fe(e){return e?Pm([e.zNear,e.zFar]):null}const G6e=new Mm(bfe,e=>I({__tag:"ColorWrite"},e));function bfe(e){return e?Pm([e.r,e.g,e.b,e.a]):null}const j6e=new Mm(wfe,e=>I({__tag:"StencilWrite"},e));function wfe(e){return e?Pm([e.mask]):null}const H6e=new Mm(q6e,e=>({blending:O6e(e.blending),culling:M6e(e.culling),polygonOffset:P6e(e.polygonOffset),depthTest:I6e(e.depthTest),stencilTest:$6e(e.stencilTest),depthWrite:D6e(e.depthWrite),colorWrite:L6e(e.colorWrite),stencilWrite:N6e(e.stencilWrite)}));function q6e(e){return e?Pm([ffe(e.blending),mfe(e.culling),gfe(e.polygonOffset),yfe(e.depthTest),vfe(e.stencilTest),_fe(e.depthWrite),bfe(e.colorWrite),wfe(e.stencilWrite)]):null}class W6e{constructor(t){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=t}setPipeline(t){(this._pipelineInvalid||t!==this._pipeline)&&(this._setBlending(t.blending),this._setCulling(t.culling),this._setPolygonOffset(t.polygonOffset),this._setDepthTest(t.depthTest),this._setStencilTest(t.stencilTest),this._setDepthWrite(t.depthWrite),this._setColorWrite(t.colorWrite),this._setStencilWrite(t.stencilWrite),this._pipeline=t),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(t){this._blending=this._setSubState(t,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(t){this._culling=this._setSubState(t,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(t){this._polygonOffset=this._setSubState(t,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(t){this._depthTest=this._setSubState(t,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(t){this._stencilTest=this._setSubState(t,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(t){this._depthWrite=this._setSubState(t,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(t){this._colorWrite=this._setSubState(t,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(t){this._stencilWrite=this._setSubState(t,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(t,i,r,s){return(r||t!==i)&&(s(t),this._pipelineInvalid=!0),t}}class EC extends Vi{initializeProgram(t){const i=EC.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new Oi(t.rctx,s,mi)}initializePipeline(){return this.configuration.haze?Rt({blending:Vn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Ft}):Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}EC.shader=new Li(A6e,()=>import("./ChapmanAtmosphere.glsl.41fb391c.js"));class xfe extends dr{constructor(){super(...arguments),this.haze=!1}}u([Y()],xfe.prototype,"haze",void 0);class gn{constructor(t,i,r,s,n,o=!1,a=0){this.name=t,this.count=i,this.type=r,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}}new gn(E.POSITION,3,nt.FLOAT,0,12);new gn(E.POSITION,3,nt.FLOAT,0,20),new gn(E.UV0,2,nt.FLOAT,12,20);new gn(E.POSITION,3,nt.FLOAT,0,32),new gn(E.NORMAL,3,nt.FLOAT,12,32),new gn(E.UV0,2,nt.FLOAT,24,32);new gn(E.POSITION,3,nt.FLOAT,0,16),new gn(E.COLOR,4,nt.UNSIGNED_BYTE,12,16);const Lj=[new gn(E.POSITION,2,nt.FLOAT,0,8)],jR=[new gn(E.POSITION,2,nt.FLOAT,0,16),new gn(E.UV0,2,nt.FLOAT,8,16)],Tl=he.getLogger("esri.views.webgl.BufferObject");function X6e(e){return F1e(e)}class jt{constructor(t,i,r,s){this._context=t,this.bufferType=i,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,t.instanceCounter.increment(Ns.Buffer,this),this._glName=this._context.gl.createBuffer(),Ly(this._context.gl),s&&this.setData(s)}static createIndex(t,i,r){return new jt(t,ft.ELEMENT_ARRAY_BUFFER,i,r)}static createVertex(t,i,r){return new jt(t,ft.ARRAY_BUFFER,i,r)}static createUniform(t,i,r){if(t.type!==Kt.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new jt(t,ft.UNIFORM_BUFFER,i,r)}static createPixelPack(t,i=ri.STREAM_READ,r){if(t.type!==Kt.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new jt(t,ft.PIXEL_PACK_BUFFER,i);return r&&s.setSize(r),s}static createPixelUnpack(t,i=ri.STREAM_DRAW,r){if(t.type!==Kt.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new jt(t,ft.PIXEL_UNPACK_BUFFER,i,r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===ft.ELEMENT_ARRAY_BUFFER?this._indexType===nt.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===ft.ELEMENT_ARRAY_BUFFER||this.bufferType===ft.ARRAY_BUFFER}dispose(){var t;(t=this._context)!=null&&t.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(Ns.Buffer,this),this._context=null):this._glName&&Tl.warn("Leaked WebGL buffer object")}setSize(t,i=null){if(t<=0&&Tl.error("Buffer size needs to be positive!"),this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&_(i))switch(this._indexType=i,i){case nt.UNSIGNED_SHORT:t*=2;break;case nt.UNSIGNED_INT:t*=4}this._setBufferData(t)}setData(t){if(!t)return;let i=t.byteLength;this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&(r$(t)&&(i/=2,this._indexType=nt.UNSIGNED_SHORT),s$(t)&&(i/=4,this._indexType=nt.UNSIGNED_INT)),this._setBufferData(i,t)}_setBufferData(t,i=null){this._size=t;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;_(i)?s.bufferData(this.bufferType,i,this.usage):s.bufferData(this.bufferType,t,this.usage),Ly(s),this._isVAOAware&&this._context.bindVAO(r)}setSubData(t,i=0,r=0,s=t.byteLength){if(!t)return;(i<0||i>=this._size)&&Tl.error("offset is out of range!");let n=i,o=r,a=s,l=t.byteLength;this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&(r$(t)?(l/=2,n*=2,o*=2,a*=2):s$(t)&&(l/=4,n*=4,o*=4,a*=4)),s===void 0&&(s=l-1),r>=s&&Tl.error("end must be bigger than start!"),i+r-s>this._size&&Tl.error("An attempt to write beyond the end of the buffer!");const c=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const h=this._context.gl,p=ArrayBuffer.isView(t)?t.buffer:t,f=o===0&&a===t.byteLength?p:p.slice(o,a);h.bufferSubData(this.bufferType,n,f),Ly(h),this._isVAOAware&&this._context.bindVAO(c)}setSubDataFromView(t,i,r,s){if(!t)return;(i<0||i>=this._size)&&Tl.error("offset is out of range!"),r>=s&&Tl.error("end must be bigger than start!"),i+r-s>this._size&&Tl.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===Kt.WEBGL2)o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,t,r,s-r);else{const a=r===0&&s===t.length?t:t.subarray(r,s);o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,a)}Ly(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(t,i=0,r,s){if(this._context.type!==Kt.WEBGL2)return void Tl.error("Get buffer subdata is supported in WebGL2 only!");if(r<0||s<0)return void Tl.error("Problem getting subdata: offset and length were less than zero!");const n=X6e(t)?t.BYTES_PER_ELEMENT:1;if(n*((r!=null?r:0)+(s!=null?s:0))>t.byteLength)return void Tl.error("Problem getting subdata: offset and length exceeded destination size!");i+n*(s!=null?s:0)>this.byteSize&&Tl.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,ft.COPY_READ_BUFFER),o.getBufferSubData(ft.COPY_READ_BUFFER,i,t,r,s),this._context.unbindBuffer(ft.COPY_READ_BUFFER)}async getSubDataAsync(t,i=0,r,s){this._context.type===Kt.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(t,i,r,s)):Tl.error("Get buffer subdata is supported in WebGL2 only!")}}function Ws(e){return window.WebGL2RenderingContext&&e instanceof window.WebGL2RenderingContext}const TJ=4;class Ze{constructor(t,i,r=null){if(this._context=t,this.type="texture",this._glName=null,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,t.instanceCounter.increment(Ns.Texture,this),this._descriptor=I({target:rt.TEXTURE_2D,samplingMode:Ve.LINEAR,wrapMode:lt.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},i),t.type!==Kt.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),F0(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===rt.TEXTURE_CUBE_MAP?this._setDataCubeMap(r):this.setData(r)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTextureAllUnits(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(Ns.Texture,this))}release(){this.dispose()}resize(t,i){const r=this._descriptor;if(r.width!==t||r.height!==i){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");r.width=t,r.height=i,this._descriptor.target===rt.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(t=null){for(let i=rt.TEXTURE_CUBE_MAP_POSITIVE_X;i<=rt.TEXTURE_CUBE_MAP_NEGATIVE_Z;i++)this._setData(t,i)}setData(t){this._setData(t)}_setData(t,i){if(!this._context||!this._context.gl)return;const r=this._context.gl;this._glName||(this._glName=r.createTexture()),t===void 0&&(t=null);const s=this._descriptor;i!=null||(i=s.target);const n=F0(i);var o;t===null&&(s.width=s.width||TJ,s.height=s.height||TJ,n&&(s.depth=(o=s.depth)!=null?o:1));const a=this._context.bindTexture(this,Ze.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(Ze.TEXTURE_UNIT_FOR_UPDATES),Ze._validateTexture(this._context,s),this._configurePixelStorage();const l=s.pixelFormat;let c=s.internalFormat?s.internalFormat:this._deriveInternalFormat(l,s.dataType);if(k5(t)){let h=t.width,p=t.height;const f=1;t instanceof HTMLVideoElement&&(h=t.videoWidth,p=t.videoHeight),s.width&&s.height,n&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,c,s.hasMipmap,h,p,f),this._texImage(i,0,c,h,p,f,t),Ly(r),s.hasMipmap&&this.generateMipmap(),s.width===void 0&&(s.width=h),s.height===void 0&&(s.height=p),n&&s.depth===void 0&&(s.depth=f)}else{const{width:h,height:p,depth:f}=s;if(h!=null&&p!=null||console.error("Width and height must be specified!"),n&&f==null&&console.error("Depth must be specified!"),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,c,s.hasMipmap,h,p,f),r.DEPTH24_STENCIL8&&c===r.DEPTH_STENCIL&&(c=r.DEPTH24_STENCIL8),TI(t)){const g=t.levels,y=SJ(i,h,p,f),v=Math.min(y-1,g.length-1);Ws(r)?r.texParameteri(s.target,r.TEXTURE_MAX_LEVEL,v):s.hasMipmap=s.hasMipmap&&y===g.length;const b=c;if(!Z6e(b))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel((w,S,T,A)=>{const C=g[Math.min(w,g.length-1)];this._compressedTexImage(i,w,b,S,T,A,C)},v)}else _(t)?(this._texImage(i,0,c,h,p,f,t),Ly(r),s.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel((g,y,v,b)=>{this._texImage(i,g,c,y,v,b,null),Ly(r)})}Ze._applySamplingMode(r,this._descriptor),Ze._applyWrapMode(r,this._descriptor),Ze._applyAnisotropicFilteringParameters(this._context,this._descriptor),Ly(r),this._context.bindTexture(a,Ze.TEXTURE_UNIT_FOR_UPDATES)}updateData(t,i,r,s,n,o){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const a=this._context.gl,l=this._descriptor,{pixelFormat:c,internalFormat:h,dataType:p,isImmutable:f,target:g}=l;if(f&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const y=this._context.bindTexture(this,Ze.TEXTURE_UNIT_FOR_UPDATES);(i<0||r<0||s>l.width||n>l.height||i+s>l.width||r+n>l.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),k5(o)?a.texSubImage2D(g,t,i,r,c,p,o):TI(o)?a.compressedTexSubImage2D(g,t,i,r,s,n,h,o.levels[t]):a.texSubImage2D(g,t,i,r,s,n,c,p,o),this._context.bindTexture(y,Ze.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(t,i,r,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._context.gl;if(!Ws(c))throw new Error("3D textures are not supported in WebGL1");const h=this._descriptor,{pixelFormat:p,dataType:f,isImmutable:g,target:y,internalFormat:v}=h;if(g&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");F0(y)||console.warn("Attempting to set 3D texture data on a non-3D texture");const b=this._context.bindTexture(this,Ze.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(Ze.TEXTURE_UNIT_FOR_UPDATES),(i<0||r<0||s<0||n>h.width||o>h.height||a>h.depth||i+n>h.width||r+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),TI(l))l=l.levels[t],c.compressedTexSubImage3D(y,t,i,r,s,n,o,a,v,l);else{const w=l;c.texSubImage3D(y,t,i,r,s,n,o,a,p,f,w)}this._context.bindTexture(b,Ze.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const t=this._descriptor;if(!t.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");t.hasMipmap=!0,this._samplingModeDirty=!0,Ze._validateTexture(this._context,t)}t.samplingMode===Ve.LINEAR?(this._samplingModeDirty=!0,t.samplingMode=Ve.LINEAR_MIPMAP_NEAREST):t.samplingMode===Ve.NEAREST&&(this._samplingModeDirty=!0,t.samplingMode=Ve.NEAREST_MIPMAP_NEAREST);const i=this._context.bindTexture(this,Ze.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(Ze.TEXTURE_UNIT_FOR_UPDATES),this._context.gl.generateMipmap(t.target),this._context.bindTexture(i,Ze.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(t){t!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=t,this._samplingModeDirty=!0)}setWrapMode(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,Ze._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const t=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(Ze._applySamplingMode(t,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(Ze._applyWrapMode(t,i),this._wrapModeDirty=!1)}_deriveInternalFormat(t,i){if(this._context.type===Kt.WEBGL1)return t;switch(i){case yt.FLOAT:switch(t){case Ie.RGBA:return st.RGBA32F;case Ie.RGB:return st.RGB32F;default:throw new Error("Unable to derive format")}case yt.UNSIGNED_BYTE:switch(t){case Ie.RGBA:return st.RGBA8;case Ie.RGB:return st.RGB8}default:return t}}_configurePixelStorage(){const t=this._context.gl,{unpackAlignment:i,flipped:r,preMultiplyAlpha:s}=this._descriptor;t.pixelStorei(t.UNPACK_ALIGNMENT,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(t,i,r,s,n,o){const a=this._context.gl;if(!Ws(a))throw new Error("Immutable textures are not supported in WebGL1");if(!Y6e(i))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=r?SJ(t,s,n,o):1;F0(t)?a.texStorage3D(t,l,i,s,n,o):a.texStorage2D(t,l,i,s,n),this._wasImmutablyAllocated=!0}_texImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=this._context.type===Kt.WEBGL2,p=F0(t),{isImmutable:f,pixelFormat:g,dataType:y}=this._descriptor;if(h&&(c=l),h||!k5(a))if(f){if(_(a)){const v=a;p?c.texSubImage3D(t,i,0,0,0,s,n,o,g,y,v):l.texSubImage2D(t,i,0,0,s,n,g,y,v)}}else{const v=a;p?c.texImage3D(t,i,r,s,n,o,0,g,y,v):l.texImage2D(t,i,r,s,n,0,g,y,v)}else l.texImage2D(t,0,r,g,y,a)}_compressedTexImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=F0(t),p=this._descriptor.isImmutable;if(h){if(this._context.type!==Kt.WEBGL2)throw new Error("3D textures are not supported in WebGL1");c=l}p?_(a)&&(h?c.compressedTexSubImage3D(t,i,0,0,0,s,n,o,r,a):l.compressedTexSubImage2D(t,i,0,0,s,n,r,a)):h?c.compressedTexImage3D(t,i,r,s,n,o,0,a):l.compressedTexImage2D(t,i,r,s,n,0,a)}_forEachMipmapLevel(t,i=1/0){let{width:r,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===rt.TEXTURE_3D;for(let c=0;t(c,r,s,n),o&&(r!==1||s!==1||l&&n!==1)&&!(c>=i);++c)r=Math.max(1,r>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}static _validateTexture(t,i){(i.width<0||i.height<0||i.depth<0)&&console.error("Negative dimension parameters are not allowed!");const r=Ws(t.gl),s=Qx(i.width)&&Qx(i.height);r||!i.isImmutable&&!F0(i.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),r||s||(typeof i.wrapMode=="number"?i.wrapMode!==lt.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):i.wrapMode.s===lt.CLAMP_TO_EDGE&&i.wrapMode.t===lt.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),i.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(t,i){let r=i.samplingMode,s=i.samplingMode;r===Ve.LINEAR_MIPMAP_NEAREST||r===Ve.LINEAR_MIPMAP_LINEAR?(r=Ve.LINEAR,i.hasMipmap||(s=Ve.LINEAR)):r!==Ve.NEAREST_MIPMAP_NEAREST&&r!==Ve.NEAREST_MIPMAP_LINEAR||(r=Ve.NEAREST,i.hasMipmap||(s=Ve.NEAREST)),t.texParameteri(i.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(i.target,t.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(t,i){typeof i.wrapMode=="number"?(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode)):(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode.s),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode.t))}static _applyAnisotropicFilteringParameters(t,i){var r;const s=t.capabilities.textureFilterAnisotropic;!s||t.gl.texParameterf(i.target,s.TEXTURE_MAX_ANISOTROPY,(r=i.maxAnisotropy)!=null?r:1)}}function Y6e(e){return e in st}function Z6e(e){return e in Er}function TI(e){return _(e)&&"type"in e&&e.type==="compressed"}function Q6e(e){return _(e)&&"byteLength"in e}function k5(e){return _(e)&&!TI(e)&&!Q6e(e)}function F0(e){return e===rt.TEXTURE_3D||e===rt.TEXTURE_2D_ARRAY}function SJ(e,t,i,r=1){let s=Math.max(t,i);return e===rt.TEXTURE_3D&&(s=Math.max(s,r)),Math.round(Math.log(s)/Math.LN2)+1}Ze.TEXTURE_UNIT_FOR_UPDATES=0;function EJ(e){const t=e.gl;switch(t.getError()){case t.NO_ERROR:return null;case t.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case t.INVALID_VALUE:return"A numeric argument is out of range";case t.INVALID_OPERATION:return"The specified command is not allowed for the current state";case t.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case t.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case t.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function fn(e,t){return e.vertexBuffers[t].size/J6e(e.layout[t])}function J6e(e){return e[0].stride}function Nj(e,t,i,r,s=0){const n=e.gl,o=e.capabilities.instancing;e.bindBuffer(i);for(const a of r){const l=t.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function Fj(e,t,i,r){const s=e.gl,n=e.capabilities.instancing;e.bindBuffer(i);for(const o of r){const a=t.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}e.unbindBuffer(ft.ARRAY_BUFFER)}function Tfe(e){switch(e){case Ie.ALPHA:case Ie.LUMINANCE:case Ie.RED:case Ie.RED_INTEGER:case st.R8:case st.R8I:case st.R8UI:case st.R8_SNORM:case Lo.STENCIL_INDEX8:return 1;case Ie.LUMINANCE_ALPHA:case Ie.RG:case Ie.RG_INTEGER:case st.RGBA4:case st.R16F:case st.R16I:case st.R16UI:case st.RG8:case st.RG8I:case st.RG8UI:case st.RG8_SNORM:case st.RGB565:case st.RGB5_A1:case Lo.DEPTH_COMPONENT16:return 2;case Ie.DEPTH_COMPONENT:case Ie.RGB:case Ie.RGB_INTEGER:case st.RGB8:case st.RGB8I:case st.RGB8UI:case st.RGB8_SNORM:case st.SRGB8:case Lo.DEPTH_COMPONENT24:return 3;case Ie.DEPTH_STENCIL:case Ie.RGBA:case Ie.RGBA_INTEGER:case st.RGBA8:case st.R32F:case st.R11F_G11F_B10F:case st.RG16F:case st.R32I:case st.R32UI:case st.RG16I:case st.RG16UI:case st.RGBA8I:case st.RGBA8UI:case st.RGBA8_SNORM:case st.SRGB8_ALPHA8:case st.RGB9_E5:case st.RGB10_A2UI:case st.RGB10_A2:case Lo.DEPTH_STENCIL:case Lo.DEPTH_COMPONENT32F:case Lo.DEPTH24_STENCIL8:return 4;case Lo.DEPTH32F_STENCIL8:return 5;case st.RGB16F:case st.RGB16I:case st.RGB16UI:return 6;case st.RG32F:case st.RG32I:case st.RG32UI:case st.RGBA16F:case st.RGBA16I:case st.RGBA16UI:return 8;case st.RGB32F:case st.RGB32I:case st.RGB32UI:return 12;case st.RGBA32F:case st.RGBA32I:case st.RGBA32UI:return 16;case Er.COMPRESSED_RGB_S3TC_DXT1_EXT:case Er.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Er.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Er.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Er.COMPRESSED_R11_EAC:case Er.COMPRESSED_SIGNED_R11_EAC:case Er.COMPRESSED_RGB8_ETC2:case Er.COMPRESSED_SRGB8_ETC2:case Er.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Er.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Er.COMPRESSED_RG11_EAC:case Er.COMPRESSED_SIGNED_RG11_EAC:case Er.COMPRESSED_RGBA8_ETC2_EAC:case Er.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}function Xy(e){if(O(e))return 0;if("descriptor"in e)return e.glName?Xy(e.descriptor):0;const t=e.internalFormat||"pixelFormat"in e&&e.pixelFormat;if(!t)return 0;const i="hasMipmap"in e&&e.hasMipmap?1.3:1,r=e.width*e.height;return Tfe(t)*r*i}const U0=he.getLogger("esri.views.webgl.VertexArrayObject");class as{constructor(t,i,r,s,n=null){this._context=t,this._locations=i,this._layout=r,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,t.instanceCounter.increment(Ns.VAO,this)}get glName(){return this._glName}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((t,i)=>t+this._buffers[i].size,_(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(t=!0){if(!this._context)return void((this._glName||t&&Object.getOwnPropertyNames(this._buffers).length>0)&&U0.warn("Leaked WebGL VAO"));if(this._glName){var i,r;const s=(i=this._context)==null||(r=i.capabilities)==null?void 0:r.vao;s?(s.deleteVertexArray(this._glName),this._glName=null):U0.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),t){for(const s in this._buffers)this._buffers[s].dispose(),delete this._buffers[s];this._indexBuffer=et(this._indexBuffer)}this._context.instanceCounter.decrement(Ns.VAO,this),this._context=null}initialize(){if(this._initialized)return;const t=this._context.capabilities.vao;if(t){const i=t.createVertexArray();t.bindVertexArray(i),this._bindLayout(),t.bindVertexArray(null),this._glName=i}this._initialized=!0}bind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:t,_layout:i,_indexBuffer:r}=this;t||U0.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in t){const o=t[n];o||U0.error("Vertex buffer is uninitialized!");const a=i[n];a||U0.error("Vertex element descriptor is empty!"),Nj(this._context,this._locations,o,a)}_(r)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glName):this._context.bindBuffer(r))}unbind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:t,_layout:i}=this;t||U0.error("Vertex buffer dictionary is empty!");for(const r in t){const s=t[r];s||U0.error("Vertex buffer is uninitialized!");const n=i[r];Fj(this._context,this._locations,s,n)}_(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}}function fo(e,t=Lj,i=mi,r=-1,s=1){let n=null;return t===jR?n=new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):n=new Float32Array([r,r,s,r,r,s,s,s]),new as(e,i,{geometry:t},{geometry:jt.createVertex(e,ri.STATIC_DRAW,n)})}function K6e(e,t=Lj,i=mi){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new as(e,i,{geometry:t},{geometry:jt.createVertex(e,ri.STATIC_DRAW,r)})}const Sfe=4;function Efe(e,t=Sfe){return new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:t,height:t})}function AJ(e,t,i=Sfe){const r=new Uint8Array(i*i*4);for(let s=0;s<r.length;s+=4)r[s+0]=255*t[0],r[s+1]=255*t[1],r[s+2]=255*t[2],r[s+3]=255*t[3];return new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:i,height:i},r)}function Afe(e){return new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}class CJ{constructor(t){this._view=t,this.type="realistic",this.canRender=!0,this._cameraPosition=M(),this._projectionInverse=Te(),this._viewInverse=Te(),this._heightParameters=ni(),this._betasRayleigh=M(),this._betasCombined=M(),this._scaleHeight=0,this._radii=Xe(),this._nearFar=Xe(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=ai.radius,this._hazeStrength=1,this._darkenHaze=!1,this._updateRadius(ai.radius)}destroy(){this._atmosphereTechnique=Wi(this._atmosphereTechnique),this._atmosphereHazeTechnique=Wi(this._atmosphereHazeTechnique),this._vao=et(this._vao),this._handles=it(this._handles)}when(){return Promise.resolve()}initializeRenderContext(t){const i=t.renderContext.rctx;this._handles=new Bt,_(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(mp(this._view,"basemapTerrain","elevation-change",s=>this._updateElevation(s),()=>this._updateElevation())),this._handles.add(mp(this._view,"basemapTerrain","elevation-bounds-change",()=>this._updateVisibleElevationBounds()));const r=new xfe;r.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRepository.acquire(EC,r),r.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRepository.acquire(EC,r),this._vao=fo(i,jR),this._scaleHeight=y6e*xI,oe(this._betasRayleigh,pb[0],pb[1],pb[2]),oe(this._betasCombined,pb[0]+U5[0],pb[1]+U5[1],pb[2]+U5[2])}render(t){this._render(t,this._atmosphereTechnique,t.offscreenRenderingHelper.depthTexture)}renderHaze(t,i){this._darkenHaze=i,this._render(t,this._atmosphereHazeTechnique,t.offscreenRenderingHelper.linearDepthTexture)}_render(t,i,r){this._update(t.camera);const s=t.rctx.useTechnique(i);t.offscreenRenderingHelper.renderDepthDetached(()=>{s.bindTexture(r,"depthTex"),this._renderCommon(i.program,t)})}_renderCommon(t,i){if(O(this._vao))return;const r=i.rctx;i.scenelightingData.setLightDirectionUniform(t),t.setUniform4fv("heightParameters",this._heightParameters),t.setUniform3fv("cameraPosition",this._cameraPosition),t.setUniformMatrix4fv("inverseProjectionMatrix",this._projectionInverse),t.setUniformMatrix4fv("inverseViewMatrix",this._viewInverse),t.setUniform2fv("nearFar",this._nearFar),t.setUniform2fv("radii",this._radii),t.setUniform1f("scaleHeight",this._scaleHeight),t.setUniform1f("betaMie",g6e),t.setUniform3fv("betaRayleigh",this._betasRayleigh),t.setUniform3fv("betaCombined",this._betasCombined),t.setUniform1f("innerFadeDistance",this._innerFadeDistance),t.setUniform1f("altitudeFade",this._altitudeFade),t.setUniform1f("hazeStrength",this._hazeStrength),r.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Tt.TRIANGLE_STRIP,0,4)}_adjustRadiusForTesselation(t){return t*Math.cos(Math.PI/16/16)}_updateElevation(t){const i=t?t.tile:gt(this._view.basemapTerrain.rootTiles,[null])[0];if(O(i)||i.level!==0)return;const r=this._adjustRadiusForTesselation(ai.radius+i.elevationBounds[0]);r!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=r,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const t=this._adjustRadiusForTesselation(ai.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||t<this._lowerBoundEarthRadius)&&this._updateRadius(t)}_updateRadius(t){this._lowerBoundEarthRadius=t,tr(this._radii,t,t+xI),this._innerFadeDistance=2*Math.sqrt((2*t-x8)*x8)}_update(t){if(O(t))return;this._cameraHeight=Pe(t.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const i=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/xI));this._heightParameters=yi(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,i),ne(this._cameraPosition,t.eye),hr(this._projectionInverse,t.projectionMatrix),hr(this._viewInverse,t.viewMatrix),tr(this._nearFar,t.near,t.far),this._altitudeFade=ufe(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?qt(.6,1,Jx(9500,10500,this._cameraHeight-ai.radius)):1}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}function eBe(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function Cfe(e,t,i){i*=.5;const r=Math.sin(i);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e}function Rfe(e,t){const i=2*Math.acos(t[3]),r=Math.sin(i/2);return r>wt?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),i}function Ofe(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*h+o*a+s*c-n*l,e[1]=s*h+o*l+n*a-r*c,e[2]=n*h+o*c+r*l-s*a,e[3]=o*h-r*a-s*l-n*c,e}function tBe(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+o*a,e[1]=s*l+n*a,e[2]=n*l-s*a,e[3]=o*l-r*a,e}function iBe(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l-n*a,e[1]=s*l+o*a,e[2]=n*l+r*a,e[3]=o*l-s*a,e}function rBe(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*a,e[1]=s*l-r*a,e[2]=n*l+o*a,e[3]=o*l-n*a,e}function sBe(e,t){const i=t[0],r=t[1],s=t[2];return e[0]=i,e[1]=r,e[2]=s,e[3]=Math.sqrt(Math.abs(1-i*i-r*r-s*s)),e}function SI(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];let l,c,h,p,f,g=i[0],y=i[1],v=i[2],b=i[3];return c=s*g+n*y+o*v+a*b,c<0&&(c=-c,g=-g,y=-y,v=-v,b=-b),1-c>wt?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-r)*l)/h,f=Math.sin(r*l)/h):(p=1-r,f=r),e[0]=p*s+f*g,e[1]=p*n+f*y,e[2]=p*o+f*v,e[3]=p*a+f*b,e}function nBe(e){const t=Sh(),i=Sh(),r=Sh(),s=Math.sqrt(1-t),n=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*i),e[1]=s*Math.cos(2*Math.PI*i),e[2]=n*Math.sin(2*Math.PI*r),e[3]=n*Math.cos(2*Math.PI*r),e}function oBe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i*i+r*r+s*s+n*n,a=o?1/o:0;return e[0]=-i*a,e[1]=-r*a,e[2]=-s*a,e[3]=n*a,e}function HR(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function Mfe(e,t){const i=t[0]+t[4]+t[8];let r;if(i>0)r=Math.sqrt(i+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{let s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;r=Math.sqrt(t[3*s+s]-t[3*n+n]-t[3*o+o]+1),e[s]=.5*r,r=.5/r,e[3]=(t[3*n+o]-t[3*o+n])*r,e[n]=(t[3*n+s]+t[3*s+n])*r,e[o]=(t[3*o+s]+t[3*s+o])*r}return e}function aBe(e,t,i,r){const s=.5*Math.PI/180;t*=s,i*=s,r*=s;const n=Math.sin(t),o=Math.cos(t),a=Math.sin(i),l=Math.cos(i),c=Math.sin(r),h=Math.cos(r);return e[0]=n*l*h-o*a*c,e[1]=o*a*h+n*l*c,e[2]=o*l*c-n*a*h,e[3]=o*l*h+n*a*c,e}function lBe(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}const Pfe=fa,cBe=zo,uBe=Q9,hBe=Ofe,dBe=wR,pBe=yne,fBe=eG,Ife=J9,mBe=Ife,$fe=K9,gBe=$fe,Uj=gne,yBe=t1,vBe=vne;function _Be(e,t,i){const r=_e(t,i);return r<-.999999?(dt(id,bBe,t),Z9(id)<1e-6&&dt(id,wBe,t),be(id,id),Cfe(e,id,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(dt(id,t,i),e[0]=id[0],e[1]=id[1],e[2]=id[2],e[3]=1+r,Uj(e,e))}const id=M(),bBe=je(1,0,0),wBe=je(0,1,0);function xBe(e,t,i,r,s,n){return SI(RJ,t,s,n),SI(OJ,i,r,n),SI(e,RJ,OJ,2*n*(1-n)),e}const RJ=T0(),OJ=T0();function TBe(e,t,i,r){const s=SBe;return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=r[0],s[4]=r[1],s[7]=r[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],Uj(e,Mfe(e,s))}const SBe=br();Object.freeze({__proto__:null,identity:eBe,setAxisAngle:Cfe,getAxisAngle:Rfe,multiply:Ofe,rotateX:tBe,rotateY:iBe,rotateZ:rBe,calculateW:sBe,slerp:SI,random:nBe,invert:oBe,conjugate:HR,fromMat3:Mfe,fromEuler:aBe,str:lBe,copy:Pfe,set:cBe,add:uBe,mul:hBe,scale:dBe,dot:pBe,lerp:fBe,length:Ife,len:mBe,squaredLength:$fe,sqrLen:gBe,normalize:Uj,exactEquals:yBe,equals:vBe,rotationTo:_Be,sqlerp:xBe,setAxes:TBe});function bS(e=ABe){return[e[0],e[1],e[2],e[3]]}function AC(e,t){return EBe(e[0],e[1],e[2],t,c7.get())}function EBe(e,t,i,r,s=bS()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function CC(e,t,i=bS()){return dt(i,e,t),be(i,i),i[3]=h7(e,t),i}const ABe=[0,0,1,0];function fi(){return new Float32Array(3)}function ED(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Ht(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function Dfe(e,t){return new Float32Array(e,t,3)}function kj(){return fi()}function Lfe(){return Ht(1,1,1)}function Nfe(){return Ht(1,0,0)}function Ffe(){return Ht(0,1,0)}function Ufe(){return Ht(0,0,1)}const CBe=kj(),RBe=Lfe(),OBe=Nfe(),MBe=Ffe(),PBe=Ufe();Object.freeze({__proto__:null,create:fi,clone:ED,fromValues:Ht,createView:Dfe,zeros:kj,ones:Lfe,unitX:Nfe,unitY:Ffe,unitZ:Ufe,ZEROS:CBe,ONES:RBe,UNIT_X:OBe,UNIT_Y:MBe,UNIT_Z:PBe});function kfe(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function zj(e,t){e.include(tm,t),e.fragment.code.add(x`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),t.attributeTextureCoordinates===mn.Default&&e.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return texture2D(tex, params.uv);
}`),t.attributeTextureCoordinates===mn.Atlas&&(e.include(kfe),e.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
}`))}const Spt=Ht(0,.6,.2);var xt;function Bj(e,t){const i=e.fragment,r=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;t.pbrMode===xt.Normal&&r&&e.include(zj,t),t.pbrMode!==xt.Schematic?(t.pbrMode===xt.Disabled&&i.code.add(x`float getBakedOcclusion() { return 1.0; }`),t.pbrMode===xt.Normal&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(x`vec3 mrr;
vec3 emission;
float occlusion;`),t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(x`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),t.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(x`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),t.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(x`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(x`float getBakedOcclusion() { return 1.0; }`),i.code.add(x`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(x`const vec3 mrr = vec3(0.0, 0.6, 0.2);
const vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function zfe(e,t,i=!1){i||(e.setUniform3fv("mrrFactors",t.mrrFactors),e.setUniform3fv("emissionFactor",t.emissiveFactor))}(function(e){e[e.Disabled=0]="Disabled",e[e.Normal=1]="Normal",e[e.Schematic=2]="Schematic",e[e.Water=3]="Water",e[e.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",e[e.COUNT=5]="COUNT"})(xt||(xt={}));function Vj(e,t){const i=e.fragment,r=t.lightingSphericalHarmonicsOrder!==void 0?t.lightingSphericalHarmonicsOrder:2;r===0?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===1?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===2&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||i.code.add(x`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}function BN(e){const t=e.fragment;t.uniforms.add("lightingMainDirection","vec3"),t.uniforms.add("lightingMainIntensity","vec3"),t.uniforms.add("lightingFixedFactor","float"),t.uniforms.add("lightingSpecularStrength","float"),t.uniforms.add("lightingEnvironmentStrength","float"),t.code.add(x`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}function VN(e){e.vertex.code.add(x`const float PI = 3.141592653589793;`),e.fragment.code.add(x`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}function Bfe(e){e.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2").add("cubeMap","samplerCube"),e.fragment.code.add(x`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(cameraPosition - sphereOriginOffset, dir);
float C = dot(cameraPosition - sphereOriginOffset, cameraPosition - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.fragment.code.add(x`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.fragment.code.add(x`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),e.fragment.code.add(x`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.fragment.code.add(x`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),e.fragment.code.add(x`vec4 renderCloud(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),e.fragment.code.add(x`vec4 renderCloudCrossFade(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}function Rp(e){e.code.add(x`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function IBe(){const e=new Ri;return e.attributes.add(E.POSITION,"vec2"),e.varyings.add("worldRay","vec3"),e.vertex.uniforms.add("inverseProjectionMatrix","mat4"),e.vertex.uniforms.add("inverseViewMatrix","mat4"),e.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3"),e.fragment.include(Rp),e.fragment.include(Yh),e.include(BN),e.include(Vj,{pbrMode:xt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(VN),e.include(kN),e.include(Bfe),e.fragment.code.add(x`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay), cameraPosition) : renderCloudCrossFade(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}const $Be=Object.freeze({__proto__:null,build:IBe});class GN extends Vi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=GN.shader.get().build();return new Oi(t.rctx,i,mi)}initializePipeline(){return Rt({blending:gc(Ee.ONE,Ee.SRC_ALPHA),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}GN.shader=new Li($Be,()=>import("./CloudsComposition.glsl.2cb18ade.js"));let Uw=class extends we{constructor(e){super(e),this._inverseProjectionMatrix=Te(),this._inverseViewMatrix=Te(),this._technique=new GN(e),this._vao=fo(e.rctx),this._setDefaultParallax(e.radius)}destroy(){this._technique=Wi(this._technique),this._vao=et(this._vao)}render(e,t,i){this._parameters.clouds=t;const r=e.camera;if(O(this._vao)||O(r))return;const s=e.rctx,n=s.useTechnique(this._technique);e.scenelightingData.setLightDirectionUniform(n),e.scenelightingData.setUniforms(n,!1,!1),hr(this._inverseProjectionMatrix,r.projectionMatrix),hr(this._inverseViewMatrix,r.viewMatrix),n.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),n.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),n.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(r.eye,i),e.cloudsCompositionParams=this._parameters,Vfe(n,r,this._parameters),s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Tt.TRIANGLE_STRIP,0,4)}get isFading(){return this._parameters.crossFade.stage!==Zc.FINISHED||this._parameters.fadeInOut.stage!==$o.FINISHED||this._parameters.fadeIn.stage!==Yc.FINISHED||this._parameters.fadeInOutHeight.stage!==y_.FINISHED}_setDefaultParallax(e){this._parameters={parallax:{anchorPointClouds:M(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Te()},parallaxNew:{anchorPointClouds:M(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Te()},crossFade:{stage:Zc.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:$o.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:Yc.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:y_.FINISHED,factor:-1},cameraPositionLastFrame:M(),startTime:0,startTimeHeightFade:0,clouds:null}}_isCameraPositionFinal(e){return Yx(this._parameters.cameraPositionLastFrame,e)}_setFadeInStage(e){const t=this._isCameraPositionFinal(e);this._parameters.fadeIn.stage===Yc.FINISHED&&(this._parameters.fadeIn.factor=1,ne(this._parameters.parallax.anchorPointClouds,Up),this._parameters.fadeIn.stage=Yc.CHANGE_ANCHOR,this._parameters.crossFade.stage=Zc.FINISHED,this._parameters.fadeInOut.stage=$o.FINISHED),this._parameters.fadeIn.stage===Yc.CHANGE_ANCHOR&&t&&(ne(this._parameters.parallax.anchorPointClouds,Up),this._parameters.fadeIn.stage=Yc.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===Yc.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===Yc.FADE_IN&&(this._parameters.fadeIn.stage=Yc.FINISHED,this._parameters.fadeIn.factor=0)}_setCrossFadingStage(){this._parameters.crossFade.stage===Zc.FINISHED&&(ne(this._parameters.parallaxNew.anchorPointClouds,Up),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=Zc.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===Zc.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===Zc.CROSS_FADE&&(this._parameters.crossFade.stage=Zc.FINISHED,this._parameters.crossFade.factor=1,ne(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e){this._parameters.fadeInOut.stage===$o.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=$o.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===$o.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===$o.FADE_OUT&&(this._parameters.fadeInOut.factor=1,ne(this._parameters.parallax.anchorPointClouds,Up)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===$o.FADE_OUT&&this._isCameraPositionFinal(e)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=$o.FADE_IN,this._parameters.crossFade.stage=Zc.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===$o.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===$o.FADE_IN&&(this._parameters.fadeInOut.stage=$o.FINISHED,this._parameters.fadeInOut.factor=0)}_setFadeInOutHeight(e){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===y_.FINISHED?t:this._parameters.startTimeHeightFade,e?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=ze(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=y_.HEIGHT_FADE}_setParallaxParams(e,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=Pe(e)-this._parameters.parallax.radius>su?1:0),be(Up,e),ae(Up,Up,this._parameters.parallax.radius),this._parameters.parallax.anchorPointClouds[0]===0&&this._parameters.parallax.anchorPointClouds[1]===0&&this._parameters.parallax.anchorPointClouds[2]===0&&ne(this._parameters.parallax.anchorPointClouds,Up);const i=Pe(de(DBe,this._parameters.parallax.anchorPointClouds,Up));let r=!0;i>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==Yc.FINISHED?this._setFadeInStage(e):i>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==$o.FINISHED?this._setFadeInOutStage(e):i>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==Zc.FINISHED?this._setCrossFadingStage():r=!1;const s=Pe(e),n=s-this._parameters.parallax.radius;(n>1.7*su||n<-su)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(n>su||n<-.35*su)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):n<su&&n>-.35*su&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=y_.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/s,CC(MJ,this._parameters.parallax.anchorPointClouds,fb),this._parameters.parallax.transform=Te(),nl(this._parameters.parallax.transform,this._parameters.parallax.transform,fb[3],fb),r&&(CC(MJ,this._parameters.parallaxNew.anchorPointClouds,fb),this._parameters.parallaxNew.transform=Te(),nl(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,fb[3],fb)),ne(this._parameters.cameraPositionLastFrame,e)}};var Yc,$o,Zc,y_;function Vfe(e,t,i){e.bindTexture(i.clouds.cubeMap.colorTexture,"cubeMap"),e.setUniform1f("cloudsHeight",i.parallax.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",i.parallax.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",i.parallaxNew.transform),e.setUniform3fv("anchorPosition",i.parallax.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",i.parallaxNew.anchorPointClouds),i.fadeInOut.stage!==$o.FINISHED?e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(ze(i.fadeInOut.factor,0,1))):e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(ze(i.fadeIn.factor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",i.parallax.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",i.crossFade.stage),e.setUniform1f("crossFadeAnchorFactor",ze(i.crossFade.factor,0,1)),e.setUniform1f("radius",i.parallax.radius),e.setUniform3fv("cameraPosition",t.eye)}u([d({constructOnly:!0})],Uw.prototype,"rctx",void 0),u([d({constructOnly:!0})],Uw.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],Uw.prototype,"radius",void 0),Uw=u([P("esri.views.3d.environment.CloudsComposition")],Uw),function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(Yc||(Yc={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.FADE_IN=2]="FADE_IN"}($o||($o={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.CROSS_FADE=1]="CROSS_FADE"}(Zc||(Zc={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(y_||(y_={}));const MJ=je(0,0,1),fb=bS(),Up=M(),DBe=M();function LBe(e){return _(e)&&_(e.cubeMap)&&!e.running&&e.coverage>0}function Eu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function RC(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Gj(e,t,i,r,s,n,o,a,l,c){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e}function jj(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Au(e,t){if(e===t){const i=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function w1(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l;let y=i*p+r*f+s*g;return y?(y=1/y,e[0]=p*y,e[1]=(-h*r+s*c)*y,e[2]=(a*r-s*o)*y,e[3]=f*y,e[4]=(h*i-s*l)*y,e[5]=(-a*i+s*n)*y,e[6]=g*y,e[7]=(-c*i+r*l)*y,e[8]=(o*i-r*n)*y,e):null}function NBe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return e[0]=o*h-a*c,e[1]=s*c-r*h,e[2]=r*a-s*o,e[3]=a*l-n*h,e[4]=i*h-s*l,e[5]=s*n-i*a,e[6]=n*c-o*l,e[7]=r*l-i*c,e[8]=i*o-r*n,e}function FBe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*n-o*l)+i*(-c*s+o*a)+r*(l*s-n*a)}function jN(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],g=i[1],y=i[2],v=i[3],b=i[4],w=i[5],S=i[6],T=i[7],A=i[8];return e[0]=f*r+g*o+y*c,e[1]=f*s+g*a+y*h,e[2]=f*n+g*l+y*p,e[3]=v*r+b*o+w*c,e[4]=v*s+b*a+w*h,e[5]=v*n+b*l+w*p,e[6]=S*r+T*o+A*c,e[7]=S*s+T*a+A*h,e[8]=S*n+T*l+A*p,e}function AD(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],g=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=l,e[6]=f*r+g*o+c,e[7]=f*s+g*a+h,e[8]=f*n+g*l+p,e}function Hj(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=Math.sin(i),g=Math.cos(i);return e[0]=g*r+f*o,e[1]=g*s+f*a,e[2]=g*n+f*l,e[3]=g*o-f*r,e[4]=g*a-f*s,e[5]=g*l-f*n,e[6]=c,e[7]=h,e[8]=p,e}function qj(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=n*t[6],e[7]=n*t[7],e[8]=n*t[8],e}function UBe(e,t,i){const r=i[0],s=i[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e}function kBe(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function zBe(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=-i,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function BBe(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function VBe(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function Wj(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return e[0]=1-p-y,e[3]=h-w,e[6]=f+b,e[1]=h+w,e[4]=1-c-y,e[7]=g-v,e[2]=f-b,e[5]=g+v,e[8]=1-c-p,e}function Gfe(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l,y=i*p+r*f+s*g;if(!y)return null;const v=1/y;return e[0]=p*v,e[1]=(-h*r+s*c)*v,e[2]=(a*r-s*o)*v,e[3]=f*v,e[4]=(h*i-s*l)*v,e[5]=(-a*i+s*n)*v,e[6]=g*v,e[7]=(-c*i+r*l)*v,e[8]=(o*i-r*n)*v,e}function OT(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15],S=i*a-r*o,T=i*l-s*o,A=i*c-n*o,C=r*l-s*a,R=r*c-n*a,L=s*c-n*l,U=h*v-p*y,N=h*b-f*y,z=h*w-g*y,V=p*b-f*v,B=p*w-g*v,J=f*w-g*b;let Z=S*J-T*B+A*V+C*z-R*N+L*U;return Z?(Z=1/Z,e[0]=(a*J-l*B+c*V)*Z,e[1]=(l*z-o*J-c*N)*Z,e[2]=(o*B-a*z+c*U)*Z,e[3]=(s*B-r*J-n*V)*Z,e[4]=(i*J-s*z+n*N)*Z,e[5]=(r*z-i*B-n*U)*Z,e[6]=(v*L-b*R+w*C)*Z,e[7]=(b*A-y*L-w*T)*Z,e[8]=(y*R-v*A+w*S)*Z,e):null}function GBe(e,t,i){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/i,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function jBe(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function HBe(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2)}function qBe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e}function jfe(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e}function WBe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e}function XBe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e}function YBe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function ZBe(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=t[0],f=t[1],g=t[2],y=t[3],v=t[4],b=t[5],w=t[6],S=t[7],T=t[8];return Math.abs(i-p)<=wt*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(r-f)<=wt*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(s-g)<=wt*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(n-y)<=wt*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-v)<=wt*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-b)<=wt*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-w)<=wt*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(c-S)<=wt*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(h-T)<=wt*Math.max(1,Math.abs(h),Math.abs(T))}function Xj(e){const t=wt,i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const QBe=jN,JBe=jfe;Object.freeze({__proto__:null,fromMat4:Eu,copy:RC,set:Gj,identity:jj,transpose:Au,invert:w1,adjoint:NBe,determinant:FBe,multiply:jN,translate:AD,rotate:Hj,scale:qj,scaleByVec2:UBe,fromTranslation:kBe,fromRotation:zBe,fromScaling:BBe,fromMat2d:VBe,fromQuat:Wj,normalFromMat4Legacy:Gfe,normalFromMat4:OT,projection:GBe,str:jBe,frob:HBe,add:qBe,subtract:jfe,multiplyScalar:WBe,multiplyScalarAndAdd:XBe,exactEquals:YBe,equals:ZBe,isOrthoNormal:Xj,mul:QBe,sub:JBe});function C0(e,t=!0){e.attributes.add(E.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(x`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?x`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}function KBe(){const e=new Ri;e.include(C0,!1),e.fragment.uniforms.add("tileRows","float").add("tileSize","float");const t=2,i=8;return e.fragment.code.add(x`
    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    vec4 taylorInvSqrt(vec4 r) {
      return 1.79284291400159 - 0.85373472095314 * r;
    }

    vec4 mod289(vec4 x) {
      return x - floor( x * (1.0 / 289.0)) * 289.0;
    }

    vec4 permute(vec4 x) {
      return mod289(((x * 34.0) + 1.0) * x);
    }

    vec4 fade(vec4 t) {
      return (t * t * t) * (t * (t * vec4(6.0) - vec4(15.0)) + vec4(10.0));
    }

    float glmPerlin(vec4 Position, vec4 rep) {
      vec4 Pi0 = mod(floor(Position), rep);
      vec4 Pi1 = mod(Pi0 + 1.0, rep);
      vec4 Pf0 = fract(Position);
      vec4 Pf1 = Pf0 - 1.0;
      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);
      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);

      vec4 ixy = permute(permute(ix) + iy);
      vec4 ixy0 = permute(ixy + vec4(Pi0.z));
      vec4 ixy1 = permute(ixy + vec4(Pi1.z));
      vec4 ixy00 = permute(ixy0 + vec4(Pi0.w));
      vec4 ixy01 = permute(ixy0 + vec4(Pi1.w));
      vec4 ixy10 = permute(ixy1 + vec4(Pi0.w));
      vec4 ixy11 = permute(ixy1 + vec4(Pi1.w));

      vec4 gx00 = ixy00 / 7.0;
      vec4 gy00 = floor(gx00) / 7.0;
      vec4 gz00 = floor(gy00) / 6.0;
      gx00 = fract(gx00) - 0.5;
      gy00 = fract(gy00) - 0.5;
      gz00 = fract(gz00) - 0.5;
      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);
      vec4 sw00 = step(gw00, vec4(0.0));
      gx00 -= sw00 * (step(0.0, gx00) - 0.5);
      gy00 -= sw00 * (step(0.0, gy00) - 0.5);

      vec4 gx01 = ixy01 / 7.0;
      vec4 gy01 = floor(gx01) / 7.0;
      vec4 gz01 = floor(gy01) / 6.0;
      gx01 = fract(gx01) - 0.5;
      gy01 = fract(gy01) - 0.5;
      gz01 = fract(gz01) - 0.5;
      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);
      vec4 sw01 = step(gw01, vec4(0.0));
      gx01 -= sw01 * (step(0.0, gx01) - 0.5);
      gy01 -= sw01 * (step(0.0, gy01) - 0.5);

      vec4 gx10 = ixy10 / 7.0;
      vec4 gy10 = floor(gx10) / 7.0;
      vec4 gz10 = floor(gy10) / 6.0;
      gx10 = fract(gx10) - 0.5;
      gy10 = fract(gy10) - 0.5;
      gz10 = fract(gz10) - 0.5;
      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);
      vec4 sw10 = step(gw10, vec4(0.0));
      gx10 -= sw10 * (step(0.0, gx10) - 0.5);
      gy10 -= sw10 * (step(0.0, gy10) - 0.5);

      vec4 gx11 = ixy11 / 7.0;
      vec4 gy11 = floor(gx11) / 7.0;
      vec4 gz11 = floor(gy11) / 6.0;
      gx11 = fract(gx11) - 0.5;
      gy11 = fract(gy11) - 0.5;
      gz11 = fract(gz11) - 0.5;
      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);
      vec4 sw11 = step(gw11, vec4(0.0));
      gx11 -= sw11 * (step(0.0, gx11) - 0.5);
      gy11 -= sw11 * (step(0.0, gy11) - 0.5);

      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);
      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);
      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);
      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);
      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);
      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);
      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);
      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);
      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);
      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);
      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);
      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);
      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);
      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);
      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);
      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);

      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));
      g0000 *= norm00.x;
      g0100 *= norm00.y;
      g1000 *= norm00.z;
      g1100 *= norm00.w;

      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));
      g0001 *= norm01.x;
      g0101 *= norm01.y;
      g1001 *= norm01.z;
      g1101 *= norm01.w;

      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));
      g0010 *= norm10.x;
      g0110 *= norm10.y;
      g1010 *= norm10.z;
      g1110 *= norm10.w;

      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));
      g0011 *= norm11.x;
      g0111 *= norm11.y;
      g1011 *= norm11.z;
      g1111 *= norm11.w;

      float n0000 = dot(g0000, Pf0);
      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));
      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));
      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));
      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));
      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));
      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));
      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));
      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));
      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));
      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));
      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));
      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));
      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));
      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));
      float n1111 = dot(g1111, Pf1);

      vec4 fade_xyzw = fade(Pf0);
      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);
      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);
      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);
      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);
      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);
      return 2.2 * n_xyzw;
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float hash(float p) {
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);;
    }

    float noise(vec3 x) {
      vec3 p = floor(x);
      vec3 f = fract(x);

      f = f * f * (3.0 - 2.0 * f);
      float n = p.x + p.y * 57.0 + 113.0 * p.z;

      return mix(
      mix(
        mix(hash(n + 0.0), hash(n + 1.0), f.x),
        mix(hash(n + 57.0), hash(n + 58.0), f.x),
        f.y),
      mix(
        mix(hash(n + 113.0), hash(n + 114.0), f.x),
        mix(hash(n + 170.0), hash(n + 171.0), f.x),
        f.y),
      f.z);
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - noise(mod(tp, numCells));
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv, float tileRows) {
      vec2 tile = floor(uv);
      float z = floor(tileRows * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${x.float(i)});

      float worley0 = worley(p, ${x.float(t)} * 2.0);
      float worley1 = worley(p, ${x.float(t)} * 8.0);
      float worley2 = worley(p, ${x.float(t)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${x.float(t)});
      float worley1 = worley(p, ${x.float(t)} * 2.0);
      float worley2 = worley(p, ${x.float(t)} * 4.0);
      float worley3 = worley(p, ${x.float(t)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.code.add(x`void main() {
float padWidth = 1.0;
float paddedSize = tileSize + 2.0 * padWidth;
float tileCount = tileRows * tileRows;
vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);
bool padCell = false;
if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
padCell = true;
}
if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
padCell = true;
}
bool startPadX = false;
bool startPadY = false;
bool endPadX = false;
bool endPadY = false;
if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
startPadX = true;
}
if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
startPadY = true;
}
if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
endPadX = true;
}
if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
endPadY = true;
}
vec2 padding = vec2(2.0 * padWidth) * tile;
vec2 uv;
if (padCell) {
vec2 pixel = gl_FragCoord.xy - padWidth - padding;
if (startPadX) {
pixel.x += tileSize;
}
if (startPadY) {
pixel.y += tileSize;
}
if (endPadX) {
pixel.x -= tileSize;
}
if (endPadY) {
pixel.y -= tileSize;
}
uv = vec2(pixel.xy / tileSize);
} else {
vec2 pixel = gl_FragCoord.xy - padWidth - padding;
uv = vec2(pixel.xy / tileSize);
}
vec3 p_ = get3Dfrom2D(uv, tileRows);
vec3 p = p_;
p.z /= (tileRows * tileRows);
float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
float worleyNoise = getTextureForPointWorley(p);
gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
p_ = mod(p_ + 1.0, tileRows * tileRows);
p = p_;
p.z /= (tileRows * tileRows);
worleyPerlinNoise = getTextureForPointPerlinWorley(p);
worleyNoise = getTextureForPointWorley(p);
gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
gl_FragColor.ba = vec2(0.0, 1.0);
}`),e}const eVe=Object.freeze({__proto__:null,build:KBe});class HN extends Vi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=HN.shader.get().build();return new Oi(t.rctx,i,mi)}initializePipeline(){return Rt({blending:gc(Ee.ONE,Ee.ZERO),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}HN.shader=new Li(eVe,()=>import("./NoiseTextureAtlas.glsl.0d249d56.js"));class kw{constructor(t,i){this._context=t,this._desc=i,this.type="renderbuffer",this._context.instanceCounter.increment(Ns.Renderbuffer,this);const r=this._context.gl;this.glName=r.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=i;if(a){if(this._context.type!==Kt.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,o,s,n)}else r.renderbufferStorage(r.RENDERBUFFER,o,s,n)}get descriptor(){return this._desc}get samples(){const t=this._desc.samples,i=this._context.parameters.maxSamples;return t?Math.min(t,i):i}resize(t,i){const r=this._desc;if(r.width===t&&r.height===i)return;r.width=t,r.height=i;const s=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):s.renderbufferStorage(s.RENDERBUFFER,r.internalFormat,r.width,r.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(Ns.Renderbuffer,this),this._context=null)}}const tVe=he.getLogger("esri.views.webgl.FrameBufferObject");class ki{constructor(t,i,r=null,s=null){if(this._context=t,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._initialized=!1,this._desc=I({},i),t.instanceCounter.increment(Ns.Framebuffer,this),_(r)){Array.isArray(r)||(r=[r]);for(let o=0;o<r.length;++o){const a=r[o],l=kl.COLOR_ATTACHMENT0+o;let c;IJ(a)?(_f(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new Ze(this._context,c))),yM(c,this._desc)):(PJ(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new kw(this._context,c))),z5(c,this._desc)),this._validateColorAttachmentPoint(l)}}if(_(s)){let o,a;if(IJ(s))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),_f(s)?(a=s.descriptor,this._depthStencilTexture=s):(a=s,this._depthStencilTexture=new Ze(this._context,a)),yM(a,this._desc);else{var n;PJ(s)?(a=s.descriptor,o=s):(a=s,o=new kw(this._context,a));const l=(n=this._desc.depthStencilTarget)!=null?n:ti.DEPTH_STENCIL_RENDER_BUFFER;l===ti.STENCIL_RENDER_BUFFER?this._stencilAttachment=o:l===ti.DEPTH_RENDER_BUFFER||l===ti.DEPTH_STENCIL_RENDER_BUFFER?this._depthAttachment=o:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),z5(a,this._desc)}}}dispose(){if(!this._desc)return;const t=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(t),this._context.instanceCounter.decrement(Ns.Framebuffer,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const t=this._colorAttachments.get(kl.COLOR_ATTACHMENT0);return t&&_f(t)?t:null}get colorAttachment(){return this._colorAttachments.get(kl.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width}get height(){return this._desc.height}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((t,[i,r])=>t+Xy(r),0)+Xy(this.depthStencilAttachment)}getColorTexture(t){const i=this._colorAttachments.get(t);return i&&_f(i)?i:null}attachColorTexture(t,i=kl.COLOR_ATTACHMENT0){!t||(this._validateColorAttachmentPoint(i),yM(t.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,i)),this._colorAttachments.set(i,t))}detachColorTexture(t=kl.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(t);if(_f(i)){const r=i;return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)),this._colorAttachments.delete(t),r}}setColorTextureTarget(t,i=kl.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(i);_f(r)&&this._framebufferTexture2D(r.glName,i,t)}attachDepthStencilTexture(t){if(O(t))return;const i=t.descriptor;i.pixelFormat!==Ie.DEPTH_STENCIL&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),i.dataType!==yt.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),yM(i,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==ti.DEPTH_STENCIL_TEXTURE&&(this._desc.depthStencilTarget=ti.DEPTH_STENCIL_TEXTURE),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,WX)),this._depthStencilTexture=t}detachDepthStencilTexture(){const t=this._depthStencilTexture;return t&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,WX)),this._depthStencilTexture=null,t}attachDepthStencilBuffer(t){if(O(t))return;const i=t.descriptor;if(i.internalFormat!==Lo.DEPTH_STENCIL&&i.internalFormat!==Lo.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),z5(i,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=i.internalFormat===Lo.DEPTH_STENCIL?ti.DEPTH_STENCIL_RENDER_BUFFER:ti.DEPTH_RENDER_BUFFER,this._initialized){this._context.bindFramebuffer(this);const r=this._context.gl,s=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(Gs.FRAMEBUFFER,s,r.RENDERBUFFER,t.glName)}this._depthAttachment=t}detachDepthStencilBuffer(){const t=this._context.gl,i=this._depthAttachment;if(i&&this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(Gs.FRAMEBUFFER,r,t.RENDERBUFFER,null)}return this._depthAttachment=null,i}detachAll(){this._colorAttachments.forEach((t,i)=>this._detachColorAttachment(i)),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(t,i,r,s,n,o,a){(t<0||i<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==rt.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(t+r>l.width||i+s>l.height||n+r>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,Ze.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(Ze.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(rt.TEXTURE_2D,0,n,o,t,i,r,s),h.bindTexture(p,Ze.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,i,r,s,n,o,a){(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(t,i,r,s,n,o,a)}async readPixelsAsync(t,i,r,s,n,o,a){if(this._context.type!==Kt.WEBGL2)return eu()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(t,i,r,s,n,o,a);const l=this._context.gl,c=jt.createPixelPack(this._context,ri.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(t,i,r,s,n,o,0),this._context.unbindBuffer(ft.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(t,i){const r=this._desc;if(r.width!==t||r.height!==i){if(!this._initialized)return r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(t,i));r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(t,i):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(t,i),this._stencilAttachment&&this._stencilAttachment.resize(t,i)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(t=Gs.FRAMEBUFFER){var i,r,s,n;const o=this._context.gl;if(this._initialized)return void o.bindFramebuffer(t,this.glName);this._glName&&o.deleteFramebuffer(this._glName);const a=this._context,l=o.createFramebuffer(),c=this._desc,h=(i=c.colorTarget)!=null?i:gr.RENDER_BUFFER,p=(r=c.width)!=null?r:1,f=(s=c.height)!=null?s:1;if(o.bindFramebuffer(t,l),this._colorAttachments.size===0)if(h===gr.TEXTURE||h===gr.CUBEMAP)this._colorAttachments.set(kl.COLOR_ATTACHMENT0,iVe(a,c,this.descriptor.colorTarget===gr.CUBEMAP?rt.TEXTURE_CUBE_MAP:rt.TEXTURE_2D));else{const y=new kw(a,{internalFormat:st.RGBA4,width:p,height:f});this._colorAttachments.set(kl.COLOR_ATTACHMENT0,y)}this._colorAttachments.forEach((y,v)=>{y&&(_f(y)?this._framebufferTexture2D(y.glName,v,$J(y),t):o.framebufferRenderbuffer(t,v,o.RENDERBUFFER,y.glName))});const g=(n=c.depthStencilTarget)!=null?n:ti.NONE;switch(g){case ti.DEPTH_RENDER_BUFFER:case ti.DEPTH_STENCIL_RENDER_BUFFER:{this._depthAttachment||(this._depthAttachment=new kw(a,{internalFormat:c.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?Lo.DEPTH_COMPONENT16:Lo.DEPTH_STENCIL,width:p,height:f}));const y=g===ti.DEPTH_RENDER_BUFFER?o.DEPTH_ATTACHMENT:o.DEPTH_STENCIL_ATTACHMENT;o.framebufferRenderbuffer(t,y,o.RENDERBUFFER,this._depthAttachment.glName);break}case ti.STENCIL_RENDER_BUFFER:this._stencilAttachment||(this._stencilAttachment=new kw(a,{internalFormat:Lo.STENCIL_INDEX8,width:p,height:f})),o.framebufferRenderbuffer(t,o.STENCIL_ATTACHMENT,o.RENDERBUFFER,this._stencilAttachment.glName);break;case ti.DEPTH_STENCIL_TEXTURE:if(!this._depthStencilTexture){a.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const y={target:rt.TEXTURE_2D,pixelFormat:Ie.DEPTH_STENCIL,dataType:yt.UNSIGNED_INT_24_8,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:p,height:f};this._depthStencilTexture=new Ze(a,y)}this._framebufferTexture2D(this._depthStencilTexture.glName,o.DEPTH_STENCIL_ATTACHMENT,$J(this._depthStencilTexture),t)}SC()&&o.checkFramebufferStatus(t)!==o.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=l,this._initialized=!0}_framebufferTexture2D(t,i=kl.COLOR_ATTACHMENT0,r=rt.TEXTURE_2D,s=Gs.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,i,r,t,n)}_detachColorAttachment(t){eu()&&console.warn("Detaching an FBO attachment can be a slow due to invalidating framebuffer completeness!");const i=this._context.gl,r=this._colorAttachments.get(t);return _f(r)?this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)):this._initialized&&(this._context.bindFramebuffer(this),i.framebufferRenderbuffer(Gs.FRAMEBUFFER,t,i.RENDERBUFFER,null)),this._colorAttachments.delete(t),r}_disposeColorAttachments(){this._colorAttachments.forEach((t,i)=>{this._detachColorAttachment(i),t.dispose()}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(Gs.FRAMEBUFFER,i,t.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),t.framebufferRenderbuffer(Gs.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateColorAttachmentPoint(t){if(ki._MAX_COLOR_ATTACHMENTS===-1){const r=this._context.capabilities.drawBuffers;if(r){const s=this._context.gl;ki._MAX_COLOR_ATTACHMENTS=s.getParameter(r.MAX_COLOR_ATTACHMENTS)}else ki._MAX_COLOR_ATTACHMENTS=1}const i=t-kl.COLOR_ATTACHMENT0;i+1>ki._MAX_COLOR_ATTACHMENTS&&tVe.error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${ki._MAX_COLOR_ATTACHMENTS} color attachments`)}}function _f(e){return"type"in e&&e.type==="texture"}function PJ(e){return"type"in e&&e.type==="renderbuffer"}function IJ(e){return _f(e)||"pixelFormat"in e}function iVe(e,t,i){return new Ze(e,{target:i,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:t.width,height:t.height})}function yM(e,t){e.target!==rt.TEXTURE_2D&&e.target!==rt.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Color attachment texture must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function z5(e,t){t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function $J(e){return e.descriptor.target===rt.TEXTURE_CUBE_MAP?rt.TEXTURE_CUBE_MAP_POSITIVE_X:rt.TEXTURE_2D}ki._MAX_COLOR_ATTACHMENTS=-1;const MT=ue("esri-mobile")?64:128,rVe=MT/128,Yj=Math.ceil(Math.sqrt(MT)),oy=(MT+2)*Yj;class sVe{constructor(t,i){this._frameBuffer=new ki(t,{colorTarget:gr.TEXTURE,width:oy,height:oy},{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,hasMipmap:!1,width:oy,height:oy}),this._vao=fo(t),this._technique=new HN({rctx:t,viewingMode:i.state.viewingMode})}get textureAtlas(){return this._frameBuffer.colorTexture}destroy(){this._technique=Wi(this._technique),this._frameBuffer=et(this._frameBuffer),this._vao=et(this._vao)}render(t){if(O(this._vao)||O(this.textureAtlas))return;const i=t.getViewport();t.setViewport(0,0,oy,oy),t.bindFramebuffer(this._frameBuffer);const r=t.useTechnique(this._technique);r.setUniform1f("tileSize",MT),r.setUniform1f("tileRows",Yj),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.gl.drawArrays(t.gl.TRIANGLE_STRIP,0,4),t.setViewport(i.x,i.y,i.width,i.height)}}var fu;function nVe(e){const t=new Ri;return t.include(C0,!1),t.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("view","mat3").add("cloudShapeTexture","sampler2D"),t.fragment.code.add(x`
    const int STEPS = ${e.steps===fu.SIXTEEN?x`16`:e.steps===fu.HUNDRED?x`100`:x`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);

    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.fragment.code.add(x`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${x.float(oy)};
      const float dataWidth = ${x.float(oy)};
      const float tileRows = ${x.float(Yj)};
      const vec3 atlasDimensions = vec3(${x.float(MT)}, ${x.float(MT)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${x.float(rVe)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }`),t.fragment.code.add(x`float clouds(vec3 p) {
float cloudVariations = getCloudShape(0.002 * p, 0.5);
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
cloud += (cloudVariations * 0.6 - 0.3) * ( -4.0 * (coverage * coverage - coverage));
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));
float shape = getCloudShape(cloudSize * p, 0.0);
shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));
cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.fragment.code.add(x`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.fragment.code.add(`
    vec3 multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      vec3 luminance = vec3(0);

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.fragment.code.add(x`vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.fragment.code.add(x`vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return vec3(0);
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
vec3 color = vec3(0.0);
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return color;
}`),t.fragment.code.add(x`void main() {
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
if (hitsPlanet) {
gl_FragColor = vec4(vec3(0), 1);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
float totalTransmittance = 1.0;
vec3 sunDirection = normalize(vec3(0, 0, 1));
vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;
gl_FragColor = vec4(col, totalTransmittance);
}`),t}(function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"})(fu||(fu={}));const oVe=Object.freeze({__proto__:null,get RayMarchingSteps(){return fu},build:nVe});class QS{constructor(t,i,r,s,n,o,a,l,c=.5){this.coverage=t,this.density=i,this.absorption=r,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingStepType=l,this.median=c}}const Hfe={sunny:new QS([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05],fu.SIXTEEN),cloudy:new QS([.24,.7],[.135,.2],[0,0],[.5,.5],[.65,.7],[.3,.3],[1,1],fu.TWOHUNDRED),rainy:new QS([.5,.9],[.2,.5],[.3,.6],[.4,.4],[.7,.7],[.5,.5],[1,1],fu.TWOHUNDRED),snowy:new QS([.5,.9],[.2,.5],[0,0],[.4,.4],[.7,.7],[.5,.5],[1,1],fu.TWOHUNDRED),foggy:new QS([.8,.8],[.5,.5],[0,0],[.85,.85],[.75,.75],[.8,.8],[.3,.3],fu.HUNDRED)};class qN extends Vi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=qN.shader.get().build({steps:this.configuration.steps});return new Oi(t.rctx,i,mi)}initializePipeline(){return Rt({blending:Vn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ZERO),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}qN.shader=new Li(oVe,()=>import("./Clouds.glsl.6727a025.js"));class qfe extends dr{constructor(){super(...arguments),this.steps=fu.SIXTEEN}}u([Y({count:fu.COUNT})],qfe.prototype,"steps",void 0);let To=class extends we{constructor(e){super(e),this._frameTask=null,this._handles=new Bt,this._cubeMapSize=ue("esri-mobile")?1024:2048,this._techniques=[],this._techniqueConfiguration=new qfe,this.coverage=qt(Go.coverage[0],Go.coverage[1],.5),this.density=qt(Go.density[0],Go.density[1],.5),this.absorption=qt(Go.absorption[0],Go.absorption[1],.5),this.cloudSize=qt(Go.cloudSize[0],Go.cloudSize[1],.5),this.detailSize=qt(Go.detailSize[0],Go.detailSize[1],.5),this.smoothness=qt(Go.smoothness[0],Go.smoothness[1],.5),this.cloudHeight=qt(Go.cloudHeight[0],Go.cloudHeight[1],.5),this.raymarchingStepType=Go.raymarchingStepType,this._cloudRadius=0,this._viewMatrix=Te(),this._viewMatrix3=br(),this.running=!1}_getTechnique(e){return this._techniques[e]||(this._techniqueConfiguration.steps=e,this._techniques[e]=new qN({rctx:this.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[e])}initialize(){this._vao=fo(this.rctx);const e=di(this.view.spatialReference);this._cloudRadius=.5*e.radius,this.setDirty(),this._frameTask=this.view.resourceController.scheduler.registerTask(ut.CLOUDS_GENERATOR,this),this._handles.add(this._frameTask),this._handles.add(Wt(this,"coverage",()=>this.setDirty())),["coverage","density","absorption","cloudSize","detailSize","smoothness","cloudHeight","raymarchingStepType"].forEach(t=>this._handles.add(Wt(this,t,()=>this.setDirty())))}destroy(){this._handles.destroy(),this._techniques.forEach(e=>Wi(e)),this._techniques=null,this._frameBufferCube=et(this._frameBufferCube),this._vao=et(this._vao),this._noiseTexture=it(this._noiseTexture)}_ensureNoiseTexture(){return O(this._noiseTexture)&&(this._noiseTexture=new sVe(this.rctx,this.view),this._noiseTexture.render(this.rctx)),this._noiseTexture.textureAtlas}get frameBufferCube(){if(O(this._frameBufferCube)){const e={target:rt.TEXTURE_CUBE_MAP,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new ki(this.rctx,{colorTarget:gr.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},e)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}applyPreset(e,t){const i=e.median,r=s=>{const n=qt(s[0],s[1],i);return t<.5?qt(s[0],n,2*t):qt(n,s[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingStepType=e.raymarchingStepType}setDirty(){this.running=!0}runTask(e){if(this.coverage===0||O(this._vao))return void(this.running=!1);const t=this._ensureNoiseTexture();if(O(t))return void(this.running=!1);const i=this._getTechnique(this.raymarchingStepType);if(!this.rctx.isTechniqueCompiled(i))return;const r=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this.frameBufferCube);const s=this.rctx.useTechnique(i),n=1+this.absorption,o=qt(35,120,this.absorption);s.bindTexture(t,"cloudShapeTexture"),s.setUniform1f("cloudRadius",this._cloudRadius),s.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),s.setUniform1f("power",o),s.setUniform1f("sigmaE",n),s.setUniform1f("density",qt(0,.3,this.density)),s.setUniform1f("cloudSize",qt(0,.02,Math.max(.01,1-this.cloudSize))),s.setUniform1f("detailSize",qt(0,.2,Math.max(.01,1-this.detailSize))),s.setUniform1f("smoothness",qt(0,.5,1-this.smoothness)),s.setUniform1f("cloudHeight",qt(0,1500,this.cloudHeight)),s.setUniform1f("coverage",this.coverage),this.rctx.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);for(let a=0;a<5;a++){const l=aVe[a],c=lVe[a];Qae(this._viewMatrix,cVe,l,c),Eu(this._viewMatrix3,this._viewMatrix),s.setUniformMatrix3fv("view",this._viewMatrix3);const h=rt.TEXTURE_CUBE_MAP_POSITIVE_X+a;this.frameBufferCube.setColorTextureTarget(h),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush()}this.running=!1,this.rctx.setViewport(r.x,r.y,r.width,r.height),this.requestRender(),e.madeProgress()}};u([d({constructOnly:!0})],To.prototype,"rctx",void 0),u([d({constructOnly:!0})],To.prototype,"view",void 0),u([d({constructOnly:!0})],To.prototype,"requestRender",void 0),u([d()],To.prototype,"_frameTask",void 0),u([d()],To.prototype,"coverage",void 0),u([d()],To.prototype,"density",void 0),u([d()],To.prototype,"absorption",void 0),u([d()],To.prototype,"cloudSize",void 0),u([d()],To.prototype,"detailSize",void 0),u([d()],To.prototype,"smoothness",void 0),u([d()],To.prototype,"cloudHeight",void 0),u([d()],To.prototype,"raymarchingStepType",void 0),u([d()],To.prototype,"running",void 0),To=u([P("esri.views.3d.environment.CloudsGenerator")],To);const aVe=[Ht(1,0,0),Ht(-1,0,0),Ht(0,1,0),Ht(0,-1,0),Ht(0,0,1)],lVe=[Ht(0,1,0),Ht(0,1,0),Ht(0,0,-1),Ht(0,0,1),Ht(0,1,0)],cVe=kj(),Go=Hfe.sunny;function uVe(e){const t=new Ri;return t.attributes.add(E.POSITION,"vec2"),t.include(tm,{attributeTextureCoordinates:mn.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("atmosphereC","float").add("cameraPosition","vec3").add("nearFar","vec2").add("depthTex","sampler2D").add("fogStrength","float").add("fogAmount","float").add("fogColor","vec3"),t.include(kN),t.fragment.include(As),t.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(x`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),t.fragment.code.add(x`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${e.haze?x`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),t}const hVe=Object.freeze({__proto__:null,build:uVe});class OC extends Vi{initializeProgram(t){const i=OC.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new Oi(t.rctx,s,mi)}initializePipeline(){return this.configuration.haze?Rt({blending:Vn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Ft}):Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE),colorWrite:Ft})}}OC.shader=new Li(hVe,()=>import("./Fog.glsl.3cb98528.js"));class T8 extends dr{constructor(){super(...arguments),this.haze=!1}}u([Y()],T8.prototype,"haze",void 0);let kE=class extends we{constructor(e){super(e),this._projectionInverse=Te(),this._viewInverse=Te(),this._nearFar=Xe(),this._fogColor=fi(),this._fogColorAtNight=fi(),this._cameraDirection=fi(),this._foggyFadeStart=.3,this._foggyFadeEnd=.6,this._hazeFadeStart=.7,this._hazeFadeEnd=1,this._strength=4e-6;const t=e.context.renderContext.rctx;this._vao=fo(t,jR);const i=di(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+xI}destroy(){this._hazeFogTechnique=Wi(this._hazeFogTechnique),this._thickFogTechnique=Wi(this._thickFogTechnique),this._vao=et(this._vao)}get _shaderTechniqueRepository(){return this.context.shaderTechniqueRepository}set strength(e){this._strength=e}get strength(){return this._strength}get thickFogTechnique(){if(O(this._thickFogTechnique)){const e=new T8;e.haze=!1,this._thickFogTechnique=this._shaderTechniqueRepository.acquire(OC,e)}return this._thickFogTechnique}get hazeFogTechnique(){if(O(this._hazeFogTechnique)){const e=new T8;e.haze=!0,this._hazeFogTechnique=this._shaderTechniqueRepository.acquire(OC,e)}return this._hazeFogTechnique}when(){return Promise.resolve()}render(e,t,i){if(this.view.basemapTerrain.baseOpacity===0&&!t||(this._update(e,t,i),this._fogAmount<=0))return;const r=e.offscreenRenderingHelper,s=t?this.thickFogTechnique:this.hazeFogTechnique,n=e.rctx.useTechnique(s);r.renderDepthDetached(()=>{n.bindTexture(r.depthTexture,"depthTex"),this._renderFog(s.program,e)})}_renderFog(e,t){if(O(this._vao))return!1;const i=t.rctx;return e.setUniform3fv("cameraPosition",t.camera.eye),e.setUniformMatrix4fv("inverseProjectionMatrix",this._projectionInverse),e.setUniformMatrix4fv("inverseViewMatrix",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("fogStrength",this._strength),e.setUniform1f("fogAmount",this._fogAmount),e.setUniform3fv("fogColor",this._fogColor),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Tt.TRIANGLE_STRIP,0,4),!0}_update(e,t,i){if(O(e.camera))return;const r=t?.1:0;i?oe(this._fogColor,.5,.5,.5):t?oe(this._fogColor,1.5,1.5,1.5):oe(this._fogColor,.24,.44,.8),ae(this._fogColorAtNight,this._fogColor,r),be(this._cameraDirection,e.camera.eye);const s=Math.max(0,_e(this._cameraDirection,e.scenelightingData.lightingMainDirection));Ss(this._fogColor,this._fogColorAtNight,this._fogColor,s),hr(this._projectionInverse,e.camera.projectionMatrix),hr(this._viewInverse,e.camera.viewMatrix),tr(this._nearFar,e.camera.near,e.camera.far);const n=Pe(e.camera.eye),o=n*n;this._atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-Jx(this._foggyFadeStart*su,this._foggyFadeEnd*su,Math.abs(n-this._planetRadius)):1-Jx(this._hazeFadeStart*su,this._hazeFadeEnd*su,Math.abs(n-this._planetRadius))}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],kE.prototype,"context",void 0),u([d({constructOnly:!0})],kE.prototype,"view",void 0),kE=u([P("esri.views.3d.environment.Fog")],kE);async function Cu(e,t){const{data:i}=await Ci(e,I({responseType:"image"},t));return i}function Un(e,t){const i=I({hasModelTransformation:!1},t);if(i.hasModelTransformation)return i.linearDepth?void e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):void e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);i.linearDepth?e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}var Hh;function dVe(e){const t=new Ri;if(e.geometry===Hh.Underground)t.attributes.add(E.POSITION,"vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(x`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),t.fragment.code.add(x`void main() {
gl_FragColor = color;
}`);else{t.include(Un,{linearDepth:!1}),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const i=e.geometry===Hh.Cylinder;t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const r=6.2831853,s=1/128;t.vertex.code.add(x`
		void main(void) {
      ${i?x`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:x`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${x.float(r*s)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${x.float(s)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),t.fragment.uniforms.add("tex","sampler2D"),i||t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(x`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?x`gl_FragColor = atmosphereColor;`:x`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}(function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"})(Hh||(Hh={}));const pVe=Object.freeze({__proto__:null,get SimpleAtmosphereGeometry(){return Hh},build:dVe});class PT extends Vi{initializeProgram(t){const i=PT.shader.get(),r=this.configuration,s=i.build({geometry:r.geometry});return new Oi(t.rctx,s,mi)}initializePipeline(){return this.configuration.geometry===Hh.Cylinder?Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),culling:Dj,depthTest:{func:Di.LEQUAL},colorWrite:Ft}):Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}PT.shader=new Li(pVe,()=>import("./SimpleAtmosphere.glsl.25a0ca01.js"));class CD extends dr{constructor(){super(...arguments),this.geometry=Hh.Cone}}u([Y({count:Hh.COUNT})],CD.prototype,"geometry",void 0);const Wfe="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";function wl(e,t=0){const i=e.stride;return e.fieldNames.filter(r=>{const s=e.fields.get(r).optional;return!(s&&s.glPadding)}).map(r=>{const s=e.fields.get(r),n=s.constructor.ElementCount,o=fVe(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new gn(r,n,o,a,i,l,t)})}function fVe(e){const t=mVe[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const mVe={u8:nt.UNSIGNED_BYTE,u16:nt.UNSIGNED_SHORT,u32:nt.UNSIGNED_INT,i8:nt.BYTE,i16:nt.SHORT,i32:nt.INT,f32:nt.FLOAT};class Zj{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}Zj.ElementCount=9;class Qj{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}Qj.ElementCount=16;class Im{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}get(t){return this.typedBuffer[t*this.typedBufferStride]}set(t,i){this.typedBuffer[t*this.typedBufferStride]=i}get buffer(){return this.typedBuffer.buffer}}Im.ElementCount=1;class $m{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,tr(i,this.typedBuffer[t],this.typedBuffer[t+1])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t]=i[1]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}$m.ElementCount=2;class Dm{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,oe(i,this.typedBuffer[t],this.typedBuffer[t+1],this.typedBuffer[t+2])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t]=i[2]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t]=s}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Dm.ElementCount=3;class Lm{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,zo(i,this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t++]=i[2],this.typedBuffer[t]=i[3]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s,n){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t++]=s,this.typedBuffer[t]=n}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Lm.ElementCount=4;class qR extends Im{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}static fromTypedArray(t,i){return new qR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}qR.ElementType="f32";class Ru extends $m{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Ru,t,i)}static fromTypedArray(t,i){return new Ru(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Ru.ElementType="f32";class Ti extends Dm{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Ti,t,i)}static fromTypedArray(t,i){return new Ti(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Ti.ElementType="f32";class Js extends Lm{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Js,t,i)}static fromTypedArray(t,i){return new Js(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Js.ElementType="f32";class qh extends Zj{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(qh,t,i)}static fromTypedArray(t,i){return new qh(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}qh.ElementType="f32";class c0 extends Zj{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(c0,t,i)}static fromTypedArray(t,i){return new c0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}c0.ElementType="f64";class IT extends Qj{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(IT,t,i)}static fromTypedArray(t,i){return new IT(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}IT.ElementType="f32";class u0 extends Qj{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(u0,t,i)}static fromTypedArray(t,i){return new u0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}u0.ElementType="f64";class $T extends Im{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer($T,t,i)}static fromTypedArray(t,i){return new $T(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}$T.ElementType="f64";class DT extends $m{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(DT,t,i)}static fromTypedArray(t,i){return new DT(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}DT.ElementType="f64";class jr extends Dm{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(jr,t,i)}static fromTypedArray(t,i){return new jr(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}jr.ElementType="f64";class x1 extends Lm{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(x1,t,i)}static fromTypedArray(t,i){return new x1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}x1.ElementType="f64";class _m extends Im{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(_m,t,i)}static fromTypedArray(t,i){return new _m(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}_m.ElementType="u8";class T1 extends $m{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(T1,t,i)}static fromTypedArray(t,i){return new T1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}T1.ElementType="u8";class h0 extends Dm{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(h0,t,i)}static fromTypedArray(t,i){return new h0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}h0.ElementType="u8";class Ca extends Lm{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(Ca,t,i)}static fromTypedArray(t,i){return new Ca(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Ca.ElementType="u8";class S1 extends Im{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(S1,t,i)}static fromTypedArray(t,i){return new S1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}S1.ElementType="u16";class LT extends $m{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(LT,t,i)}static fromTypedArray(t,i){return new LT(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}LT.ElementType="u16";class E1 extends Dm{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(E1,t,i)}static fromTypedArray(t,i){return new E1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}E1.ElementType="u16";class d0 extends Lm{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(d0,t,i)}static fromTypedArray(t,i){return new d0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}d0.ElementType="u16";class A1 extends Im{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(A1,t,i)}static fromTypedArray(t,i){return new A1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}A1.ElementType="u32";class NT extends $m{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(NT,t,i)}static fromTypedArray(t,i){return new NT(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}NT.ElementType="u32";class MC extends Dm{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(MC,t,i)}static fromTypedArray(t,i){return new MC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}MC.ElementType="u32";class PC extends Lm{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(PC,t,i)}static fromTypedArray(t,i){return new PC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}PC.ElementType="u32";class FT extends Im{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(FT,t,i)}static fromTypedArray(t,i){return new FT(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}FT.ElementType="i8";class C1 extends $m{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(C1,t,i)}static fromTypedArray(t,i){return new C1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}C1.ElementType="i8";class IC extends Dm{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(IC,t,i)}static fromTypedArray(t,i){return new IC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}IC.ElementType="i8";class $C extends Lm{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer($C,t,i)}static fromTypedArray(t,i){return new $C(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}$C.ElementType="i8";class DC extends Im{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(DC,t,i)}static fromTypedArray(t,i){return new DC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}DC.ElementType="i16";class R1 extends $m{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(R1,t,i)}static fromTypedArray(t,i){return new R1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}R1.ElementType="i16";class LC extends Dm{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(LC,t,i)}static fromTypedArray(t,i){return new LC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}LC.ElementType="i16";class NC extends Lm{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(NC,t,i)}static fromTypedArray(t,i){return new NC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}NC.ElementType="i16";class FC extends Im{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(FC,t,i)}static fromTypedArray(t,i){return new FC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}FC.ElementType="i32";class UC extends $m{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(UC,t,i)}static fromTypedArray(t,i){return new UC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}UC.ElementType="i32";class kC extends Dm{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(kC,t,i)}static fromTypedArray(t,i){return new kC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}kC.ElementType="i32";class zC extends Lm{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(zC,t,i)}static fromTypedArray(t,i){return new zC(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}zC.ElementType="i32";function Xfe(e){switch(e){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8;default:return}}function gVe(e){switch(e){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0;default:return}}function yVe(e){switch(e){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1;default:return}}function vVe(e){switch(e){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303;default:return}}class RD{constructor(t,i){this.layout=t,this.buffer=typeof i=="number"?new ArrayBuffer(i*t.stride):i;for(const r of t.fieldNames){const s=t.fields.get(r);this[r]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(t,i){const r=this[t];return r&&r.elementCount===i.ElementCount&&r.elementType===i.ElementType?r:null}slice(t,i){return new RD(this.layout,this.buffer.slice(t*this.stride,i*this.stride))}copyFrom(t,i,r,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(t.buffer,i*n,s*n/4);new Uint32Array(this.buffer,r*n,s*n/4).set(o)}else{const o=new Uint8Array(t.buffer,i*n,s*n);new Uint8Array(this.buffer,r*n,s*n).set(o)}}}class Jj{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(t,i){return this._appendField(t,Ru,i),this}vec2f64(t,i){return this._appendField(t,DT,i),this}vec3f(t,i){return this._appendField(t,Ti,i),this}vec3f64(t,i){return this._appendField(t,jr,i),this}vec4f(t,i){return this._appendField(t,Js,i),this}vec4f64(t,i){return this._appendField(t,x1,i),this}mat3f(t,i){return this._appendField(t,qh,i),this}mat3f64(t,i){return this._appendField(t,c0,i),this}mat4f(t,i){return this._appendField(t,IT,i),this}mat4f64(t,i){return this._appendField(t,u0,i),this}vec4u8(t,i){return this._appendField(t,Ca,i),this}f32(t,i){return this._appendField(t,qR,i),this}f64(t,i){return this._appendField(t,$T,i),this}u8(t,i){return this._appendField(t,_m,i),this}u16(t,i){return this._appendField(t,S1,i),this}i8(t,i){return this._appendField(t,FT,i),this}vec2i8(t,i){return this._appendField(t,C1,i),this}vec2i16(t,i){return this._appendField(t,R1,i),this}vec2u8(t,i){return this._appendField(t,T1,i),this}vec4u16(t,i){return this._appendField(t,d0,i),this}u32(t,i){return this._appendField(t,A1,i),this}_appendField(t,i,r){const s=i.ElementCount*Xfe(i.ElementType),n=this.stride;this.fields.set(t,{size:s,constructor:i,offset:n,optional:r}),this.stride+=s,this.fieldNames.push(t)}alignTo(t){return this.stride=Math.floor((this.stride+t-1)/t)*t,this}hasField(t){return this.fieldNames.indexOf(t)>=0}createBuffer(t){return new RD(this,t)}createView(t){return new RD(this,t)}clone(){const t=new Jj;return t.stride=this.stride,t.fields=new Map,this.fields.forEach((i,r)=>t.fields.set(r,i)),t.fieldNames=this.fieldNames.slice(),t.BufferType=this.BufferType,t}}function Nr(){return new Jj}function R0(e,t,i){e.setUniform3f("cameraPosition",i[3]-t[0],i[7]-t[1],i[11]-t[2])}function xl(e,t){e.setUniformMatrix4fv("proj",t)}function Yfe(e,t,i){Vo(DJ,i,t),e.setUniform3fv("localOrigin",t),e.setUniformMatrix4fv("view",DJ)}function Op(e,t){Yfe(e,t.origin,t.camera.viewMatrix)}function Zfe(e,t){e.setUniform4fv("viewport",t.camera.fullViewport)}const DJ=BR();var S8;(function(e){function t(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function i(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function r(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}e.length=t,e.normalize=i,e.scale=r,e.add=s,e.subtract=n})(S8||(S8={}));const mo=ni();class _Ve{constructor(t){this.message=t}toString(){return`AssertException: ${this.message}`}}function ot(e,t){if(!e)throw t=t||"assert",console.log(new Error(t).stack),new _Ve(t)}function mb(e,t){e||(t=t||"",console.warn("Verify failed: "+t+`
`+new Error("verify").stack))}function LJ(e,t,i,r){let s,n=(i[0]-e[0])/t[0],o=(r[0]-e[0])/t[0];n>o&&(s=n,n=o,o=s);let a=(i[1]-e[1])/t[1],l=(r[1]-e[1])/t[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(i[2]-e[2])/t[2],h=(r[2]-e[2])/t[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function vM(e,t,i,r,s,n=Xe()){const o=(r[s]-i[s])*(t[0]-e[0])-(r[0]-i[0])*(t[s]-e[s]),a=(r[0]-i[0])*(e[s]-i[s])-(r[s]-i[s])*(e[0]-i[0]);if(o===0)return!1;const l=a/o;return n[0]=e[0]+l*(t[0]-e[0]),n[1]=e[s]+l*(t[s]-e[s]),!0}function NJ(e,t,i,r,s){s||(s=e),mo[0]=e[0],mo[1]=e[1],mo[2]=e[2],mo[3]=1,bu(mo,mo,t),s.length>2&&(s[2]=-mo[2]),bu(mo,mo,i),ot(mo[3]!==0),s[0]=mo[0]/mo[3],s[1]=mo[1]/mo[3],s[2]=mo[2]/mo[3],s[0]=(.5*s[0]+.5)*r[2]+r[0],s[1]=(.5*s[1]+.5)*r[3]+r[1]}function bVe(e,t){return Math.log(e)/Math.log(t)}function Qfe(e,t,i,r){e[12]=t,e[13]=i,e[14]=r}function Jfe(e){return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[15]===1}function wVe(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function xVe(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function TVe(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function SVe(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function Kj(e,t,i,r,s){const n=e;e[11]===0?(r[0]=2/(t*n[0]),r[1]=2/(i*n[5]),r[2]=(1+n[12])/n[0],r[3]=(1+n[13])/n[5],tr(s,0,1)):(r[0]=-2/(t*n[0]),r[1]=-2/(i*n[5]),r[2]=(1-n[8])/n[0],r[3]=(1-n[9])/n[5],tr(s,1,0))}class WN{constructor(t,i,r,s){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.indices=r,this.position=s,this.center=M(),ot(t.length>=1),ot(r.length%this._numIndexPerPrimitive==0),ot(r.length>=t.length*this._numIndexPerPrimitive),ot(s.size===3||s.size===4);const{data:n,size:o}=s,a=t.length;let l=o*r[this._numIndexPerPrimitive*t[0]];k0.clear(),k0.push(l),this.bbMin=je(n[l],n[l+1],n[l+2]),this.bbMax=Ts(this.bbMin);for(let h=0;h<a;++h){const p=this._numIndexPerPrimitive*t[h];for(let f=0;f<this._numIndexPerPrimitive;++f){l=o*r[p+f],k0.push(l);let g=n[l];this.bbMin[0]=Math.min(g,this.bbMin[0]),this.bbMax[0]=Math.max(g,this.bbMax[0]),g=n[l+1],this.bbMin[1]=Math.min(g,this.bbMin[1]),this.bbMax[1]=Math.max(g,this.bbMax[1]),g=n[l+2],this.bbMin[2]=Math.min(g,this.bbMin[2]),this.bbMax[2]=Math.max(g,this.bbMax[2])}}Ss(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let c=this.radius*this.radius;for(let h=0;h<k0.length;++h){l=k0.getItemAt(h);const p=n[l]-this.center[0],f=n[l+1]-this.center[1],g=n[l+2]-this.center[2],y=p*p+f*f+g*g;if(y<=c)continue;const v=Math.sqrt(y),b=.5*(v-this.radius);this.radius=this.radius+b,c=this.radius*this.radius;const w=b/v;this.center[0]+=p*w,this.center[1]+=f*w,this.center[2]+=g*w}k0.clear()}getCenter(){return this.center}getBSRadius(){return this.radius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getChildren(){if(this._children)return this._children;if(ko(this.bbMin,this.bbMax)>1){const t=Ss(M(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<i;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],g=n[f],y=n[f+1],v=n[f+2];for(let b=1;b<this._numIndexPerPrimitive;++b){f=o*this.indices[p+b];const w=n[f],S=n[f+1],T=n[f+2];w<g&&(g=w),S<y&&(y=S),T<v&&(v=T)}g<t[0]&&(h|=1),y<t[1]&&(h|=2),v<t[2]&&(h|=4),r[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array(8);for(let c=0;c<8;++c)l[c]!==void 0&&(this._children[c]=new WN(l[c],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}static prune(){k0.prune()}}const k0=new $t({deallocator:null});class WR{constructor(){this.id=va()}unload(){}}var Wh;(function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"})(Wh||(Wh={}));function FJ(e,t,i){const r=Px(e,t),s=Px(t,i),n=Px(i,e),o=(r+s+n)/2,a=o*(o-r)*(o-s)*(o-n);return a<=0?0:Math.sqrt(a)}function EVe(e,t,i){return de(B5,t,e),de(UJ,i,e),Pe(dt(B5,B5,UJ))/2}new Om(S0);new Om(()=>({p0:null,p1:null,p2:null}));const B5=M(),UJ=M();let ay=(()=>{const e=new Uint32Array(131072);for(let t=0;t<e.length;++t)e[t]=t;return e})();const Kfe=new Uint16Array([0]),OD=(()=>{const e=new Uint16Array(65536);for(let t=0;t<e.length;++t)e[t]=t;return e})();function UT(e){if(e===1)return Kfe;if(e<OD.length)return new Uint16Array(OD.buffer,0,e);if(e>ay.length){const t=Math.max(2*ay.length,e);ay=new Uint32Array(t);for(let i=0;i<ay.length;i++)ay[i]=i}return new Uint32Array(ay.buffer,0,e)}function Ept(e){if(e===1)return new Uint16Array(Kfe);if(e<OD.length)return new Uint16Array(OD.slice(0,e));if(e>ay.length){const t=new Uint32Array(e);for(let i=0;i<t.length;i++)t[i]=i;return t}return new Uint32Array(ay.slice(0,e))}function eme(e,t,i){if(!e)return!1;const{size:r,data:s}=e;oe(i,0,0,0),oe(tu,0,0,0);let n=0,o=0;for(let a=0;a<t.length-2;a+=3){const l=t[a+0]*r,c=t[a+1]*r,h=t[a+2]*r;oe(Hs,s[l+0],s[l+1],s[l+2]),oe(Gf,s[c+0],s[c+1],s[c+2]),oe(_M,s[h+0],s[h+1],s[h+2]);const p=EVe(Hs,Gf,_M);p?(pe(Hs,Hs,Gf),pe(Hs,Hs,_M),ae(Hs,Hs,1/3*p),pe(i,i,Hs),n+=p):(pe(tu,tu,Hs),pe(tu,tu,Gf),pe(tu,tu,_M),o+=3)}return(o!==0||n!==0)&&(n!==0?(ae(i,i,1/n),!0):o!==0&&(ae(i,tu,1/o),!0))}function tme(e,t,i){if(!e||!t)return!1;const{size:r,data:s}=e;oe(i,0,0,0);let n=-1,o=0;for(let a=0;a<t.length;a++){const l=t[a]*r;n!==l&&(i[0]+=s[l+0],i[1]+=s[l+1],i[2]+=s[l+2],o++),n=l}return o>1&&ae(i,i,1/o),o>0}function eH(e,t,i,r){if(!e)return!1;const{size:s,data:n}=e;oe(r,0,0,0),oe(tu,0,0,0);let o=0,a=0;const l=t?t.length-1:n.length/s-1,c=l+(i?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,g=(t?t[p]:p)*s,y=(t?t[f]:f)*s;Hs[0]=n[g+0],Hs[1]=n[g+1],Hs[2]=n[g+2],Gf[0]=n[y+0],Gf[1]=n[y+1],Gf[2]=n[y+2],ae(Hs,pe(Hs,Hs,Gf),.5);const v=X9(Hs,Gf);v>0?(pe(r,r,ae(Hs,Hs,v)),o+=v):(pe(tu,tu,Hs),a++)}return o!==0?(ae(r,r,1/o),!0):a!==0&&(ae(r,tu,1/a),!0)}const Hs=M(),Gf=M(),_M=M(),tu=M();class or extends WR{constructor(t,i=[],r=wa.Triangle,s=-1){super(),this._primitiveType=r,this.edgeIndicesLength=s,this.type=Wh.Geometry,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[n,o]of t)o&&this._vertexAttributes.set(n,I({},o));if(i==null||i.length===0){const n=AVe(this._vertexAttributes),o=UT(n);this.edgeIndicesLength=this.edgeIndicesLength<0?n:this.edgeIndicesLength;for(const a of this._vertexAttributes.keys())this._indices.set(a,o)}else for(const[n,o]of i)o&&(this._indices.set(n,CVe(o)),n===E.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(n).length:this.edgeIndicesLength))}cloneShallow(){const t=new or([],void 0,this._primitiveType,void 0),{_vertexAttributes:i,_indices:r}=t;return this._vertexAttributes.forEach((s,n)=>{i.set(n,s)}),this._indices.forEach((s,n)=>{r.set(n,s)}),t.screenToWorldRatio=this.screenToWorldRatio,t._boundingInfo=this._boundingInfo,t}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(t){const i=this._vertexAttributes.get(t);return i&&!i.exclusive&&(i.data=Array.from(i.data),i.exclusive=!0),i}get indices(){return this._indices}get indexCount(){const t=this._indices.values().next().value;return t?t.length:0}get primitiveType(){return this._primitiveType}get faceCount(){return this.indexCount/3}get boundingInfo(){return O(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return this.primitiveType===wa.Triangle?this._computeAttachmentOriginTriangles(t):this._computeAttachmentOriginPoints(t)}_computeAttachmentOriginTriangles(t){const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return eme(r,i,t)}_computeAttachmentOriginPoints(t){const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return tme(r,i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.indices.get(E.POSITION);if(t.length===0)return null;const i=this.primitiveType===wa.Triangle?3:1;ot(t.length%i==0,"Indexing error: "+t.length+" not divisible by "+i);const r=UT(t.length/i),s=this.vertexAttributes.get(E.POSITION);return new WN(r,i,t,s)}}function AVe(e){const t=e.values().next().value;return t==null?0:t.data.length/t.size}function CVe(e){if(e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return e;for(const t of e)if(t>=65536)return e;return new Uint16Array(e)}const gb=S8;var V5,G5,j5,E8;(function(e){const i=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],s=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),o=new Uint16Array(36);for(let c=0;c<6;c++)for(let h=0;h<6;h++)o[6*c+h]=c;const a=new Uint16Array(36);for(let c=0;c<6;c++)a[6*c+0]=0,a[6*c+1]=1,a[6*c+2]=2,a[6*c+3]=2,a[6*c+4]=3,a[6*c+5]=0;function l(c){Array.isArray(c)||(c=[c,c,c]);const h=new Array(24);for(let p=0;p<8;p++)h[3*p]=i[p][0]*c[0],h[3*p+1]=i[p][1]*c[1],h[3*p+2]=i[p][2]*c[2];return new or([[E.POSITION,{size:3,data:h,exclusive:!0}],[E.NORMAL,{size:3,data:r}],[E.UV0,{size:2,data:s}]],[[E.POSITION,n],[E.NORMAL,o],[E.UV0,a]])}e.createGeometry=l})(V5||(V5={})),function(e){const i=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],s=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function o(a){Array.isArray(a)||(a=[a,a,a]);const l=new Array(18);for(let c=0;c<6;c++)l[3*c]=i[c][0]*a[0],l[3*c+1]=i[c][1]*a[1],l[3*c+2]=i[c][2]*a[2];return new or([[E.POSITION,{size:3,data:l,exclusive:!0}],[E.NORMAL,{size:3,data:r}]],[[E.POSITION,s],[E.NORMAL,n]])}e.createGeometry=o}(G5||(G5={})),function(e){const r=Ht(-.5,0,-.5),s=Ht(.5,0,-.5),n=Ht(0,0,.5),o=Ht(0,0+.5,0),a=fi(),l=fi(),c=fi(),h=fi(),p=fi();de(a,r,o),de(l,r,s),dt(c,a,l),be(c,c),de(a,s,o),de(l,s,n),dt(h,a,l),be(h,h),de(a,n,o),de(l,n,r),dt(p,a,l),be(p,p);const f=[r,s,n,o],g=[0,-1,0,c[0],c[1],c[2],h[0],h[1],h[2],p[0],p[1],p[2]],y=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];function b(w){Array.isArray(w)||(w=[w,w,w]);const S=new Array(12);for(let T=0;T<4;T++)S[3*T]=f[T][0]*w[0],S[3*T+1]=f[T][1]*w[1],S[3*T+2]=f[T][2]*w[2];return new or([[E.POSITION,{size:3,data:S,exclusive:!0}],[E.NORMAL,{size:3,data:g}]],[[E.POSITION,new Uint16Array(y)],[E.NORMAL,new Uint16Array(v)]])}e.createGeometry=b}(j5||(j5={})),function(e){function t(T,A,C,R={uv:!0}){const L=-Math.PI,U=2*Math.PI,N=-Math.PI/2,z=Math.PI,V=Math.max(3,Math.floor(A)),B=Math.max(2,Math.floor(C)),J=(V+1)*(B+1),Z=new Float32Array(3*J),te=new Float32Array(3*J),ie=new Float32Array(2*J),$=[];let F=0;for(let K=0;K<=B;K++){const H=[],ee=K/B,ge=N+ee*z,Ae=Math.cos(ge);for(let Be=0;Be<=V;Be++){const Se=Be/V,xe=L+Se*U,Re=Math.cos(xe)*Ae,ke=Math.sin(ge),Gi=-Math.sin(xe)*Ae;Z[3*F]=Re*T,Z[3*F+1]=ke*T,Z[3*F+2]=Gi*T,te[3*F]=Re,te[3*F+1]=ke,te[3*F+2]=Gi,ie[2*F]=Se,ie[2*F+1]=ee,H.push(F),++F}$.push(H)}const k=new Uint32Array(2*V*(B-1)*3);F=0;for(let K=0;K<B;K++)for(let H=0;H<V;H++){const ee=$[K][H],ge=$[K][H+1],Ae=$[K+1][H+1],Be=$[K+1][H];K===0?(k[F++]=ee,k[F++]=Ae,k[F++]=Be):K===B-1?(k[F++]=ee,k[F++]=ge,k[F++]=Ae):(k[F++]=ee,k[F++]=ge,k[F++]=Ae,k[F++]=Ae,k[F++]=Be,k[F++]=ee)}const G=[[E.POSITION,k],[E.NORMAL,k]],q=[[E.POSITION,{size:3,data:Z,exclusive:!0}],[E.NORMAL,{size:3,data:te,exclusive:!0}]];return R.uv&&(q.push([E.UV0,{size:2,data:ie,exclusive:!0}]),G.push([E.UV0,k])),R.offset&&(G[0][0]=E.OFFSET,q[0][0]=E.OFFSET,G.push([E.POSITION,new Uint32Array(k.length)]),q.push([E.POSITION,{size:3,data:Float64Array.from(R.offset),exclusive:!0}])),new or(q,G)}function i(T,A,C){const R=T;let L,U;if(C)L=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],U=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const Z=R*(1+Math.sqrt(5))/2;L=[-R,Z,0,R,Z,0,-R,-Z,0,R,-Z,0,0,-R,Z,0,R,Z,0,-R,-Z,0,R,-Z,Z,0,-R,Z,0,R,-Z,0,-R,-Z,0,R],U=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let Z=0;Z<L.length;Z+=3)gb.scale(L,Z,T/gb.length(L,Z));let N={};function z(Z,te){Z>te&&([Z,te]=[te,Z]);const ie=Z.toString()+"."+te.toString();if(N[ie])return N[ie];let $=L.length;return L.length+=3,gb.add(L,3*Z,L,3*te,L,$),gb.scale(L,$,T/gb.length(L,$)),$/=3,N[ie]=$,$}for(let Z=0;Z<A;Z++){const te=U.length,ie=new Uint32Array(4*te);for(let $=0;$<te;$+=3){const F=U[$],k=U[$+1],G=U[$+2],q=z(F,k),K=z(k,G),H=z(G,F),ee=4*$;ie[ee]=F,ie[ee+1]=q,ie[ee+2]=H,ie[ee+3]=k,ie[ee+4]=K,ie[ee+5]=q,ie[ee+6]=G,ie[ee+7]=H,ie[ee+8]=K,ie[ee+9]=q,ie[ee+10]=K,ie[ee+11]=H}U=ie,N={}}const V=new Float32Array(L);for(let Z=0;Z<V.length;Z+=3)gb.normalize(V,Z);const B=[[E.POSITION,U],[E.NORMAL,U]],J=[[E.POSITION,{size:3,data:new Float32Array(L),exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}]];return new or(J,B)}function r(T,A,C,R,L,U,N){const z=A?[A[0],A[1],A[2]]:[0,0,0],V=T?[T[0],T[1],T[2]]:[0,0,1];U=U||[0,0];const B=C?[255*C[0],255*C[1],255*C[2],C.length>3?255*C[3]:255]:[255,255,255,255],J=R!=null&&R.length===2?R:[1,1],Z=[[E.POSITION,{size:3,data:z,exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}],[E.UV0,{size:U.length,data:U}],[E.COLOR,{size:4,data:B,exclusive:!0}],[E.SIZE,{size:2,data:J}]];if(L!=null){const te=new Float32Array([L[0],L[1],L[2],L[3]]);Z.push([E.AUXPOS1,{size:4,data:te}])}if(N!=null){const te=new Float32Array([N[0],N[1],N[2],N[3]]);Z.push([E.AUXPOS2,{size:4,data:te}])}return new or(Z,null,wa.Point)}function s(T,A,C,R,L,U,N,z){if(T!=null){const{data:V}=z.getMutableAttribute(E.NORMAL);V[0]=T[0],V[1]=T[1],V[2]=T[2]}if(A!=null){const{data:V}=z.getMutableAttribute(E.POSITION);V[0]=A[0],V[1]=A[1],V[2]=A[2]}if(C!=null){const{data:V}=z.getMutableAttribute(E.COLOR);V[0]=C[0],V[1]=C[1],V[2]=C[2],V[3]=C[3]}if(R!=null){const{data:V}=z.getMutableAttribute(E.SIZE);V[0]=R[0],V[1]=R[1]}if(L!=null){const{data:V}=z.getMutableAttribute(E.AUXPOS1);V[0]=L[0],V[1]=L[1],V[2]=L[2],V[3]=L[3]}if(U!=null){const{data:V}=z.getMutableAttribute(E.UV0);V[0]=U[0],V[1]=U[1]}if(N!=null){const{data:V}=z.getMutableAttribute(E.AUXPOS2);V[0]=N[0],V[1]=N[1],V[2]=N[2],V[3]=N[3]}}function n(T,A){const C=new Float32Array(3*T.length),R=new Float32Array(A?3*T.length:3),L=new Uint32Array(T.length),U=new Uint32Array(T.length);for(let B=0;B<T.length;B++)C[3*B]=T[B][0],C[3*B+1]=T[B][1],C[3*B+2]=T[B][2],A&&(R[3*B]=A[B][0],R[3*B+1]=A[B][1],R[3*B+2]=A[B][2]),L[B]=B,U[B]=0;A||(R[0]=0,R[1]=1,R[2]=0);const N=[0,0],z=[[E.POSITION,L],[E.NORMAL,A?L:U],[E.UV0,U]],V=[[E.POSITION,{size:3,data:C,exclusive:!0}],[E.NORMAL,{size:3,data:R,exclusive:!0}],[E.UV0,{size:2,data:N,exclusive:!0}]];return new or(V,z,wa.Point)}function o(){const T=[0,0,0,0,0,100,100,0,0],A=new Uint16Array([0,1,2]),C=[0,1,0],R=new Uint16Array([0,0,0]),L=[0,0],U=new Uint16Array([0,0,0]),N=[[E.POSITION,A],[E.NORMAL,R],[E.UV0,U]],z=[[E.POSITION,{size:3,data:T,exclusive:!0}],[E.NORMAL,{size:3,data:C,exclusive:!0}],[E.UV0,{size:2,data:L,exclusive:!0}]];return new or(z,N)}e.createBoxGeometry=V5.createGeometry,e.createDiamondGeometry=G5.createGeometry,e.createTetrahedronGeometry=j5.createGeometry,e.createSphereGeometry=t,e.createPolySphereGeometry=i,e.createPointGeometry=r,e.updatePointGeometry=s,e.createPointArrayGeometry=n,e.createTriangleGeometry=o;const a=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function l(T=a){const A=new Array(12);for(let B=0;B<4;B++)for(let J=0;J<3;J++)A[3*B+J]=T[B][J];const C=new Uint32Array([0,1,2,2,3,0]),R=[0,0,1],L=new Uint32Array([0,0,0,0,0,0]),U=[0,0,1,0,1,1,0,1],N=[255,255,255,255],z=[[E.POSITION,C],[E.NORMAL,L],[E.UV0,C],[E.COLOR,L]],V=[[E.POSITION,{size:3,data:A,exclusive:!0}],[E.NORMAL,{size:3,data:R,exclusive:!0}],[E.UV0,{size:2,data:U,exclusive:!0}],[E.COLOR,{size:4,data:N,exclusive:!0}]];return new or(V,z)}function c(T,A,C,R,L=!0,U=!0){let N=0;const z=A,V=T;let B=Ht(0,N,0),J=Ht(0,N+V,0),Z=Ht(0,-1,0),te=Ht(0,1,0);R&&(N=V,J=Ht(0,0,0),B=Ht(0,N,0),Z=Ht(0,1,0),te=Ht(0,-1,0));const ie=[J,B],$=[Z,te],F=C+2,k=Math.sqrt(V*V+z*z);if(R)for(let Se=C-1;Se>=0;Se--){const xe=Se*(2*Math.PI/C),Re=Ht(Math.cos(xe)*z,N,Math.sin(xe)*z);ie.push(Re);const ke=Ht(V*Math.cos(xe)/k,-z/k,V*Math.sin(xe)/k);$.push(ke)}else for(let Se=0;Se<C;Se++){const xe=Se*(2*Math.PI/C),Re=Ht(Math.cos(xe)*z,N,Math.sin(xe)*z);ie.push(Re);const ke=Ht(V*Math.cos(xe)/k,z/k,V*Math.sin(xe)/k);$.push(ke)}const G=new Uint32Array(2*(C+2)*3),q=new Uint32Array(2*(C+2)*3);let K=0,H=0;if(L){for(let Se=3;Se<ie.length;Se++)G[K++]=1,G[K++]=Se-1,G[K++]=Se,q[H++]=0,q[H++]=0,q[H++]=0;G[K++]=ie.length-1,G[K++]=2,G[K++]=1,q[H++]=0,q[H++]=0,q[H++]=0}if(U){for(let Se=3;Se<ie.length;Se++)G[K++]=Se,G[K++]=Se-1,G[K++]=0,q[H++]=Se,q[H++]=Se-1,q[H++]=1;G[K++]=0,G[K++]=2,G[K++]=ie.length-1,q[H++]=1,q[H++]=2,q[H++]=$.length-1}const ee=new Float32Array(3*F);for(let Se=0;Se<F;Se++)ee[3*Se]=ie[Se][0],ee[3*Se+1]=ie[Se][1],ee[3*Se+2]=ie[Se][2];const ge=new Float32Array(3*F);for(let Se=0;Se<F;Se++)ge[3*Se]=$[Se][0],ge[3*Se+1]=$[Se][1],ge[3*Se+2]=$[Se][2];const Ae=[[E.POSITION,G],[E.NORMAL,q]],Be=[[E.POSITION,{size:3,data:ee,exclusive:!0}],[E.NORMAL,{size:3,data:ge,exclusive:!0}]];return new or(Be,Ae)}function h(T,A,C,R,L,U){const N=R?ED(R):Ht(1,0,0),z=L?ED(L):Ht(0,0,0);U=U==null||U;const V=fi();be(V,N);const B=fi();ae(B,V,Math.abs(T));const J=fi();ae(J,B,-.5),pe(J,J,z);const Z=Ht(0,1,0);Math.abs(1-_e(V,Z))<.2&&oe(Z,0,0,1);const te=fi();dt(te,V,Z),be(te,te),dt(Z,te,V);const ie=2*C+(U?2:0),$=C+(U?2:0),F=new Float32Array(3*ie),k=new Float32Array(3*$),G=new Float32Array(2*ie),q=new Uint32Array(3*C*(U?4:2)),K=new Uint32Array(3*C*(U?4:2));U&&(F[3*(ie-2)+0]=J[0],F[3*(ie-2)+1]=J[1],F[3*(ie-2)+2]=J[2],G[2*(ie-2)]=0,G[2*(ie-2)+1]=0,F[3*(ie-1)+0]=F[3*(ie-2)+0]+B[0],F[3*(ie-1)+1]=F[3*(ie-2)+1]+B[1],F[3*(ie-1)+2]=F[3*(ie-2)+2]+B[2],G[2*(ie-1)]=1,G[2*(ie-1)+1]=1,k[3*($-2)+0]=-V[0],k[3*($-2)+1]=-V[1],k[3*($-2)+2]=-V[2],k[3*($-1)+0]=V[0],k[3*($-1)+1]=V[1],k[3*($-1)+2]=V[2]);const H=function(xe,Re,ke){q[xe]=Re,K[xe]=ke};let ee=0;const ge=fi(),Ae=fi();for(let xe=0;xe<C;xe++){const Re=xe*(2*Math.PI/C);ae(ge,Z,Math.sin(Re)),ae(Ae,te,Math.cos(Re)),pe(ge,ge,Ae),k[3*xe+0]=ge[0],k[3*xe+1]=ge[1],k[3*xe+2]=ge[2],ae(ge,ge,A),pe(ge,ge,J),F[3*xe+0]=ge[0],F[3*xe+1]=ge[1],F[3*xe+2]=ge[2],G[2*xe+0]=xe/C,G[2*xe+1]=0,F[3*(xe+C)+0]=F[3*xe+0]+B[0],F[3*(xe+C)+1]=F[3*xe+1]+B[1],F[3*(xe+C)+2]=F[3*xe+2]+B[2],G[2*(xe+C)+0]=xe/C,G[2*xe+1]=1;const ke=(xe+1)%C;H(ee++,xe,xe),H(ee++,xe+C,xe),H(ee++,ke,ke),H(ee++,ke,ke),H(ee++,xe+C,xe),H(ee++,ke+C,ke)}if(U){for(let xe=0;xe<C;xe++){const Re=(xe+1)%C;H(ee++,ie-2,$-2),H(ee++,xe,$-2),H(ee++,Re,$-2)}for(let xe=0;xe<C;xe++){const Re=(xe+1)%C;H(ee++,xe+C,$-1),H(ee++,ie-1,$-1),H(ee++,Re+C,$-1)}}const Be=[[E.POSITION,q],[E.NORMAL,K],[E.UV0,q]],Se=[[E.POSITION,{size:3,data:F,exclusive:!0}],[E.NORMAL,{size:3,data:k,exclusive:!0}],[E.UV0,{size:2,data:G,exclusive:!0}]];return new or(Se,Be)}function p(T,A,C,R,L){C=C||10,R=R==null||R,ot(T.length>1);const U=[[0,0,0]],N=[],z=[];for(let V=0;V<C;V++){N.push([0,-V-1,-(V+1)%C-1]);const B=V/C*2*Math.PI;z.push([Math.cos(B)*A,Math.sin(B)*A])}return e.createPathExtrusionGeometry(z,T,U,N,R,L)}function f(T,A,C,R,L,U=Ht(0,0,0)){const N=T.length,z=new Float32Array(A.length*N*3+(6*C.length||0)),V=new Float32Array(A.length*N*3+(C?6:0)),B=(A.length-1)*N*6+3*R.length*2,J=new Uint32Array(B),Z=new Uint32Array(B);let te=0,ie=0,$=0,F=0;const k=fi(),G=fi(),q=fi(),K=fi(),H=fi(),ee=fi(),ge=fi(),Ae=M(),Be=fi(),Se=fi(),xe=fi(),Re=fi(),ke=fi(),Gi=ii();oe(Be,0,1,0),de(G,A[1],A[0]),be(G,G),L?(pe(Ae,A[0],U),be(q,Ae)):oe(q,0,0,1),S(G,q,Be,Be,H,q,kJ),ne(K,q),ne(Re,H);for(let Mt=0;Mt<C.length;Mt++)ae(ee,H,C[Mt][0]),ae(Ae,q,C[Mt][2]),pe(ee,ee,Ae),pe(ee,ee,A[0]),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2];V[ie++]=-G[0],V[ie++]=-G[1],V[ie++]=-G[2];for(let Mt=0;Mt<R.length;Mt++)J[$++]=R[Mt][0]>0?R[Mt][0]:-R[Mt][0]-1+C.length,J[$++]=R[Mt][1]>0?R[Mt][1]:-R[Mt][1]-1+C.length,J[$++]=R[Mt][2]>0?R[Mt][2]:-R[Mt][2]-1+C.length,Z[F++]=0,Z[F++]=0,Z[F++]=0;let Hr=C.length;const Cs=C.length-1;for(let Mt=0;Mt<A.length;Mt++){let dO=!1;Mt>0&&(ne(k,G),Mt<A.length-1?(de(G,A[Mt+1],A[Mt]),be(G,G)):dO=!0,pe(Se,k,G),be(Se,Se),pe(xe,A[Mt-1],K),mT(A[Mt],Se,Gi),X1(Gi,fc(xe,k),Ae)?(de(Ae,Ae,A[Mt]),be(q,Ae),dt(H,Se,q),be(H,H)):S(Se,K,Re,Be,H,q,kJ),ne(K,q),ne(Re,H)),L&&(pe(Ae,A[Mt],U),be(ke,Ae));for(let Qh=0;Qh<N;Qh++)if(ae(ee,H,T[Qh][0]),ae(Ae,q,T[Qh][1]),pe(ee,ee,Ae),be(ge,ee),V[ie++]=ge[0],V[ie++]=ge[1],V[ie++]=ge[2],pe(ee,ee,A[Mt]),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2],!dO){const ES=(Qh+1)%N;J[$++]=Hr+Qh,J[$++]=Hr+N+Qh,J[$++]=Hr+ES,J[$++]=Hr+ES,J[$++]=Hr+N+Qh,J[$++]=Hr+N+ES;for(let AS=0;AS<6;AS++)Z[F++]=J[$-6+AS]-Cs}Hr+=N}const Rs=A[A.length-1];for(let Mt=0;Mt<C.length;Mt++)ae(ee,H,C[Mt][0]),ae(Ae,q,C[Mt][1]),pe(ee,ee,Ae),pe(ee,ee,Rs),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2];const cs=ie/3;V[ie++]=G[0],V[ie++]=G[1],V[ie++]=G[2];const Os=Hr-N;for(let Mt=0;Mt<R.length;Mt++)J[$++]=R[Mt][0]>=0?Hr+R[Mt][0]:-R[Mt][0]-1+Os,J[$++]=R[Mt][2]>=0?Hr+R[Mt][2]:-R[Mt][2]-1+Os,J[$++]=R[Mt][1]>=0?Hr+R[Mt][1]:-R[Mt][1]-1+Os,Z[F++]=cs,Z[F++]=cs,Z[F++]=cs;const nb=[[E.POSITION,J],[E.NORMAL,Z]],t4=[[E.POSITION,{size:3,data:z,exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}]];return new or(t4,nb)}function g(T,A,C){ot(T.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),ot(T[0].length===3,"createPolylineGeometry(): malformed vertex"),ot(A==null||A.length===T.length,"createPolylineGeometry: need same number of points and normals"),ot(A==null||A[0].length===3,"createPolylineGeometry(): malformed normal");const R=new Float64Array(3*T.length),L=new Uint32Array(2*(T.length-1));let U=0,N=0;for(let B=0;B<T.length;B++){for(let J=0;J<3;J++)R[U++]=T[B][J];B>0&&(L[N++]=B-1,L[N++]=B)}const z=[],V=[];if(z.push([E.POSITION,L]),V.push([E.POSITION,{size:3,data:R,exclusive:!0}]),A){const B=new Float32Array(3*A.length);let J=0;for(let Z=0;Z<T.length;Z++)for(let te=0;te<3;te++)B[J++]=A[Z][te];z.push([E.NORMAL,L]),V.push([E.NORMAL,{size:3,data:B,exclusive:!0}])}return C&&(V.push([E.COLOR,{size:4,data:C}]),z.push([E.COLOR,UT(C.length/4)])),new or(V,z,wa.Line)}function y(T,A,C,R,L=0){const U=new Array(18),N=[[-A,L,R/2],[C,L,R/2],[0,T+L,R/2],[-A,L,-R/2],[C,L,-R/2],[0,T+L,-R/2]],z=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let V=0;V<6;V++)U[3*V]=N[V][0],U[3*V+1]=N[V][1],U[3*V+2]=N[V][2];return new or([[E.POSITION,{size:3,data:U,exclusive:!0}]],[[E.POSITION,z]])}function v(T,A){const C=T.getMutableAttribute(E.POSITION).data;for(let R=0;R<C.length;R+=3){const L=C[R],U=C[R+1],N=C[R+2];oe(yb,L,U,N),Ue(yb,yb,A),C[R]=yb[0],C[R+1]=yb[1],C[R+2]=yb[2]}}function b(T,A=T){const C=T.vertexAttributes,R=C.get(E.POSITION).data,L=C.get(E.NORMAL).data;if(L){const U=A.getMutableAttribute(E.NORMAL).data;for(let N=0;N<L.length;N+=3){const z=L[N+1];U[N+1]=-L[N+2],U[N+2]=z}}if(R){const U=A.getMutableAttribute(E.POSITION).data;for(let N=0;N<R.length;N+=3){const z=R[N+1];U[N+1]=-R[N+2],U[N+2]=z}}return A}function w(T,A,C,R,L){return!(Math.abs(_e(A,T))>L)&&(dt(C,T,A),be(C,C),dt(R,C,T),be(R,R),!0)}function S(T,A,C,R,L,U,N){return w(T,A,L,U,N)||w(T,C,L,U,N)||w(T,R,L,U,N)}e.createSquareGeometry=l,e.createConeGeometry=c,e.createCylinderGeometry=h,e.createTubeGeometry=p,e.createPathExtrusionGeometry=f,e.createPolylineGeometry=g,e.createExtrudedTriangle=y,e.transformInPlace=v,e.cgToGIS=b,e.makeOrthoBasisDirUp=w,e.makeOrthoBasisDirUpFallback=S}(E8||(E8={}));const kJ=.99619469809,yb=fi(),Wa=E8,RVe=he.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class OVe{constructor(){this.type="panoramic",this._techniqueConfig=new CD,this._readyResolver=um(),this._readyController=new AbortController}destroy(){this._readyResolver.reject(),this._texture=et(this._texture),this._vao=et(this._vao),this._readyController=xu(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(t){this._techniqueConfig.geometry=Hh.Cylinder,this._technique=t.shaderTechniqueRepository.acquire(PT,this._techniqueConfig);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=fn(this._vao,"geometry"),Cu(Wfe,{signal:this._readyController.signal}).then(r=>{this._texture=new Ze(i,{pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!0},r),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(r=>{vr(r)||RVe.error("Unable to initialize atmosphere: image request failed",r),this._readyResolver.reject()})}get canRender(){return this._texture!=null}render(t){const i=t.rctx,r=i.useTechnique(this._technique);r.bindTexture(this._texture,"tex"),xl(r,t.camera.projectionMatrix),MVe(zJ,t.camera.viewMatrix),r.setUniformMatrix4fv("view",zJ),r.setUniform4f("uColor",1,1,1,1),t.scenelightingData.setLightDirectionUniform(r),i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Tt.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(t){const i=Wa.createPolySphereGeometry(1,2,!1),r=i.indices.get(E.POSITION);for(let a=0;a<r.length;a+=3){const l=r[a];r[a]=r[a+2],r[a+2]=l}const s=i.vertexAttributes.get(E.POSITION).data,n=BJ.createBuffer(r.length),o=n.position;for(let a=0;a<r.length;++a){const l=3*r[a];o.set(a,0,s[l]),o.set(a,1,s[l+1]),o.set(a,2,s[l+2])}return new as(t,mi,{geometry:wl(BJ)},{geometry:jt.createVertex(t,ri.STATIC_DRAW,n.buffer)})}}function MVe(e,t){Lr(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}const zJ=Te(),BJ=Nr().vec3f(E.POSITION);var Jl;function PVe(e){const t=new Ri;return t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add("cameraPosition","vec3").add("offset","vec3").add("width","float").add("proj","mat4").add("view","mat4").add("time","float"),t.varyings.add("vUv","vec2"),t.vertex.code.add(x`
    //https://www.shadertoy.com/view/4djSRW
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===Jl.RAIN?x`

            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:x`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add("opacity","float").add("particleColor","vec3"),t.fragment.code.add(x`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===Jl.RAIN?x`d = 0.5 * smoothstep(0.5, 0.0, d);`:x`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}(function(e){e[e.RAIN=0]="RAIN",e[e.SNOW=1]="SNOW"})(Jl||(Jl={}));const IVe=Object.freeze({__proto__:null,get PrecipitationType(){return Jl},build:PVe});class Yf extends Vi{initializeProgram(t){const i=Yf.shader.get(),r=this.configuration,s=i.build({type:r.type});return new Oi(t.rctx,s,Yf.attributeLocation)}initializePipeline(){return Rt({blending:Vn(Ee.ONE,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}}Yf.shader=new Li(IVe,()=>import("./Precipitation.glsl.89a1cbd2.js")),Yf.attributeLocation=new Map([[E.POSITION,0],[E.INSTANCEFEATUREATTRIBUTE,1]]);class A8 extends dr{constructor(){super(...arguments),this.type=Jl.RAIN}}u([Y()],A8.prototype,"type",void 0);class ime{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance(t){return _(t.forcedTime)?this._time!==t.forcedTime&&(this._time=t.forcedTime,!0):!(!this.enabled||t.dt===0)&&(this._time+=t.dt,!0)}}let Zv=class extends we{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._opacity=1,this._width=500,this._offset=M(),this._tile=M(),this._particleColor=fi(),this._particleColorAtNight=fi(),this._nightMultiplier=.7,this._cameraDirection=fi(),this._renderParameters={camera:null,time:0,radius:1},this._animation=new ime,this._updatingTracking=new rp,this._renderParameters.time=0,this._renderParameters.radius=di(e.view.spatialReference).radius,this._shaderTechniqueRepository=e.context.shaderTechniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechnique=Wi(this._snowTechnique),this._rainTechnique=Wi(this._rainTechnique),this._vao=et(this._vao),this._instanceIdBuffer=et(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get rainTechnique(){if(O(this._rainTechnique)){const e=new A8;e.type=Jl.RAIN,this._rainTechnique=this._shaderTechniqueRepository.acquire(Yf,e)}return this._rainTechnique}get snowTechnique(){if(O(this._snowTechnique)){const e=new A8;e.type=Jl.SNOW,this._snowTechnique=this._shaderTechniqueRepository.acquire(Yf,e)}return this._snowTechnique}update(e){return this._animation.advance(e)}render(e,t,i){const{rctx:r,camera:s}=e;this._ensureResources(r);const n=i===Jl.RAIN?this.rainTechnique:this.snowTechnique;if(O(n)||O(this._vao)||O(this._instanceIdBuffer)||(_(e.cloudsCompositionParams)&&(this._opacity=1-e.cloudsCompositionParams.fadeInOutHeight.factor),this._opacity<=0))return;const o=r.useTechnique(n);this._renderParameters.camera=s,this._renderParameters.time=(i===Jl.RAIN?this._rainSpeed:this._snowSpeed)*Rse(this._animation.time),this._update(o,s,i,e),r.bindVAO(this._vao);const a=Yf.attributeLocation;o.assertCompatibleVertexAttributeLocations(this._vao),Nj(r,a,this._instanceIdBuffer,VJ,0),r.capabilities.instancing.drawArraysInstanced(Tt.TRIANGLES,0,3,this._numParticles*t),Fj(r,a,this._instanceIdBuffer,VJ)}_update(e,t,i,r){const s=t.eye;this._tile[0]=Math.floor((s[0]+.5*this._width)/this._width),this._tile[1]=Math.floor((s[1]+.5*this._width)/this._width),this._tile[2]=Math.floor((s[2]+.5*this._width)/this._width),this._offset[0]=s[0]-this._tile[0]*this._width,this._offset[1]=s[1]-this._tile[1]*this._width,this._offset[2]=s[2]-this._tile[2]*this._width,e.setUniform1f("width",this._width),e.setUniform3fv("offset",this._offset),e.setUniformMatrix4fv("view",t.viewMatrix),e.setUniform3fv("cameraPosition",s),xl(e,t.projectionMatrix),e.setUniform1f("time",this._renderParameters.time),i===Jl.RAIN?oe(this._particleColor,.85,.85,.85):oe(this._particleColor,1,1,1),ae(this._particleColorAtNight,this._particleColor,this._nightMultiplier),be(this._cameraDirection,s);const n=Math.max(0,_e(this._cameraDirection,r.scenelightingData.lightingMainDirection));Ss(this._particleColor,this._particleColorAtNight,this._particleColor,n),e.setUniform3fv("particleColor",this._particleColor),e.setUniform1f("opacity",this._opacity)}_ensureResources(e){_(this._vao)||(this._vao=this._createVertexArrayObject(e),_(this._instanceIdBuffer)||(this._instanceIdBuffer=this._createInstanceIndices(e)))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return jt.createVertex(e,ri.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new as(e,Yf.attributeLocation,{geometry:wl($Ve)},{geometry:jt.createVertex(e,ri.STATIC_DRAW,t)})}};u([d({constructOnly:!0})],Zv.prototype,"context",void 0),u([d({constructOnly:!0})],Zv.prototype,"view",void 0),u([d({readOnly:!0})],Zv.prototype,"updating",null),u([d()],Zv.prototype,"_updatingTracking",void 0),Zv=u([P("esri.views.3d.environment.Precipitation")],Zv);const $Ve=Nr().vec3f(E.POSITION),VJ=wl(Nr().f32(E.INSTANCEFEATUREATTRIBUTE),1),DVe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==",LVe=he.getLogger("esri.views.3d.environment.SimpleAtmosphere"),bM=128,GJ=-x8,jJ=0,H5=50,NVe=()=>1-511/512,FVe=f3([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class UVe{constructor(t){this.view=t,this.type="simple",this._renderData={texV:Xe(),silCircleCenter:M(),silCircleV1:M(),silCircleV2:M(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._texture=null,this._fadeVaoCount=0,this._readyResolver=um(),this._readyController=new AbortController,this.texV1=1,this.canRender=!0,this.isOnMars=wp(t.spatialReference);const i=di(t.spatialReference);this.planetRadius=i.radius,this.outerRimWidth=i.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+GJ)/this.planetRadius,this.middleRimFactor=(this.planetRadius+jJ)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=jJ/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=Ys(this._cameraChangeHandle),this._texture=et(this._texture),this._fadeVao=et(this._fadeVao),this._vao=et(this._vao),this._readyController=xu(this._readyController)}when(){return this._readyResolver.promise}async initializeRenderContext(t){this._shaderTechniqueRepository=t.shaderTechniqueRepository;const i=t.renderContext.rctx;this._cameraChangeHandle=Wt(this.view,"state.camera",()=>t.requestRender(),!0),this._vao=this._createRibbon(i),this._vaoCount=fn(this._vao,"geometry"),this._fadeVao=fo(i),this._fadeVaoCount=fn(this._fadeVao,"geometry");const r=this.isOnMars?DVe:Wfe,s=this._readyController.signal;try{const n=await Cu(r,{signal:s});Jt(s),this._texture=new Ze(i,{pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!0},n),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}catch(n){vr(n)||LVe.error("Unable to initialize simple atmosphere: image request failed",n),this._readyResolver.reject(n)}}get coneTechnique(){if(O(this._coneTechnique)){const t=new CD;t.geometry=Hh.Cone,this._coneTechnique=this._shaderTechniqueRepository.acquire(PT,t)}return this._coneTechnique}get undergroundTechnique(){if(O(this._undergroundTechnique)){const t=new CD;t.geometry=Hh.Underground,this._undergroundTechnique=this._shaderTechniqueRepository.acquire(PT,t)}return this._undergroundTechnique}render(t){this._update(t.camera);const i=t.rctx;if(this._renderData.undergroundFadeAlpha<1){const r=i.useTechnique(this.coneTechnique);r.setUniformMatrix4fv("proj",t.camera.projectionMatrix),r.setUniformMatrix4fv("view",t.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),t.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),i.bindVAO(this._vao),i.drawArrays(Tt.TRIANGLES,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=i.useTechnique(this.undergroundTechnique);r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),t.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",t.camera.eye),i.bindVAO(this._fadeVao),i.drawArrays(Tt.TRIANGLE_STRIP,0,this._fadeVaoCount)}}renderHaze(){return!1}_update(t){const i=M(),r=this.planetRadius,s=Pe(t.eye),n=s-r;if(n<0){const g=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=g}else this._renderData.undergroundFadeAlpha=0;const o=Math.max(H5,n),a=r+GJ;this._renderData.innerScale=kVe(r+o,r,a)-1,this._renderData.altitudeFade=ufe(n),ae(i,t.eye,(r+H5)/s),HJ(i,t.center,t.up,r,this._renderData);const l=this._computeScreenRimWidth(t,i,t.up,this._renderData),c=NVe(),h=FVe(n);let p=this.texV0+c*this.texVScale,f=this.texV0+l*h*this.texVScale;if(n>H5){HJ(t.eye,t.center,t.up,r,this._renderData);const g=this._computeScreenRimWidth(t,t.eye,t.up,this._renderData),y=ze((g-1.5)/(l-1.5),0,1);p=this.texV0+y*c*this.texVScale,f=this.texV0+qt(this.texV1,l*h,y)*this.texVScale}tr(this._renderData.texV,p,f)}_createRibbon(t){const i=new Float32Array(3+3*bM*3),r=new Uint32Array(3*bM*5);i[0]=0,i[1]=0,i[2]=-1;for(let o=0;o<bM;o++){const a=9*o+3;i[a+0]=o,i[a+1]=this.innerRimFactor,i[a+2]=-1,i[a+3]=o,i[a+4]=this.middleRimFactor,i[a+5]=0,i[a+6]=o,i[a+7]=this.outerRimFactor,i[a+8]=1;const l=3*o+1,c=o===bM-1?1:l+3,h=15*o;r[h+0]=l,r[h+1]=l+1,r[h+2]=c+1,r[h+3]=c+1,r[h+4]=c,r[h+5]=l,r[h+6]=l+1,r[h+7]=l+2,r[h+8]=c+2,r[h+9]=c+2,r[h+10]=c+1,r[h+11]=l+1,r[h+12]=l,r[h+13]=c,r[h+14]=0}const s=qJ.createBuffer(r.length),n=s.position;for(let o=0;o<r.length;++o){const a=3*r[o];n.set(o,0,i[a]),n.set(o,1,i[a+1]),n.set(o,2,i[a+2])}return new as(t,mi,{geometry:wl(qJ)},{geometry:jt.createVertex(t,ri.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(t,i,r,s){return pe(JS,s.silCircleCenter,s.silCircleV2),ae(W5,JS,this.outerRimFactor),rN(q5,i,JS,r),NJ(JS,q5,t.projectionMatrix,t.viewport),NJ(W5,q5,t.projectionMatrix,t.viewport),xi(JS,W5)/t.height}}function HJ(e,t,i,r,s){const n=Pe(e),o=r*Math.sqrt(n*n-r*r)/n,a=Math.sqrt(r*r-o*o),l=s.silCircleV1,c=s.silCircleV2;return ae(s.silCircleCenter,e,a/n),dt(l,e,t),Fo(l)<1&&dt(l,e,i),ae(l,l,o/Pe(l)),dt(c,l,e),ae(c,c,o/Pe(c)),o}const q5=Te(),JS=M(),W5=M();function kVe(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}const qJ=Nr().vec3f(E.POSITION);function tH(e){const t=x`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=x`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}function zVe(){const e=new Ri;return e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.COLOR,"vec4"),e.attributes.add(E.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include(tH),e.vertex.code.add(x`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(x`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}const BVe=Object.freeze({__proto__:null,build:zVe});class XN extends Vi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=XN.shader.get().build();return new Oi(t.rctx,i,mi)}initializePipeline(){return Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Di.LEQUAL},colorWrite:Ft})}bindPass(t){const i=this._makeInfiniteProjectionMatrix(t.camera.projectionMatrix,t.camera.near,VVe);ur(i,i,t.camera.viewMatrix),ur(i,i,t.modelMatrix),this.program.setUniformMatrix4fv("transform",i),this.program.setUniform4fv("viewport",t.camera.fullViewport),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio)}_makeInfiniteProjectionMatrix(t,i,r){return Lr(r,t),r[10]=24e-8-1,r[11]=-1,r[14]=(24e-8-2)*i,r}}XN.shader=new Li(BVe,()=>import("./Stars.glsl.aaca0616.js"));const VVe=Te(),GVe=he.getLogger("esri.views.3d.environment.Stars");let Zg=class extends we{constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:Te()},this._updatingTracking=new rp}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return _(this._loadDataTask)&&!this._loadDataTask.finished}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=xu(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Wi(this._technique),this._vao=et(this._vao)}render(e){const{rctx:t,camera:i}=e;if(this._ensureResources(t),O(this._technique)||O(this._vao))return;const r=t.useTechnique(this._technique);this._renderParameter.camera=i,this._technique.bindPass(this._renderParameter),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Tt.POINTS,0,this._numPoints)}_ensureResources(e){if(_(this._technique)||O(vb))return;this._technique=new XN({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=vb.byteLength/WJ;const t=new Float32Array(vb,0,2*this._numPoints),i=new Uint8Array(vb,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add(()=>{var r;return(r=this.view)==null?void 0:r.environment.lighting.date},r=>this._update(r),un)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._renderParameter.modelMatrix;Lr(r,qVe),uT(r,r,-i*Math.PI),ur(r,HVe,r),uT(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=XJ.createBuffer(r),n=s.position,o=s.color,a=s.size;for(let l=0;l<r;l++){const c=t[2*l+0],h=t[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(h)),n.set(l,1,-Math.sin(c)*Math.sin(h)),n.set(l,2,-Math.cos(h));const p=this._unpackUint8Attributes(i[l]),f=this._hexToRGB(jVe[p[1]]);o.set(l,0,255*f[0]),o.set(l,1,255*f[1]),o.set(l,2,255*f[2]),o.set(l,3,255),a.set(l,p[0])}return new as(e,mi,{geometry:wl(XJ)},{geometry:jt.createVertex(e,ri.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(_(vb))return null;const e=yR(async t=>{const{data:i}=await FEe("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(i),vb=i});return e.promise.catch(t=>{vr(t)||GVe.error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new Q("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/WJ;if(t%1!=0||t>5e4||t<5e3)throw new Q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],Zg.prototype,"view",void 0),u([d({constructOnly:!0})],Zg.prototype,"requestRender",void 0),u([d({readOnly:!0})],Zg.prototype,"updating",null),u([d()],Zg.prototype,"_loadDataTask",void 0),u([d()],Zg.prototype,"_updatingTracking",void 0),Zg=u([P("esri.views.3d.environment.Stars")],Zg);const jVe=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],HVe=a7(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),qVe=a7(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),WJ=9,XJ=Nr().vec3f(E.POSITION).vec4u8(E.COLOR).f32(E.SIZE);let vb=null;var zE;const WVe=[ye.POSTPROCESSING_ENVIRONMENT_OPAQUE,ye.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let YJ,So=zE=class extends we{constructor(e){super(e),this._handles=new Bt,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._precipitationEnabled=hFe()}initialize(){this.view._stage.addRenderPlugin(WVe,this)}destroy(){var e;this._pendingAtmosphere=it(this._pendingAtmosphere),((e=this.view)==null?void 0:e._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._handles=it(this._handles),this._set("view",null)}get atmosphereType(){return _(this._pendingAtmosphere)?this._pendingAtmosphere.type:_(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){var e;return!((e=this.view.basemapTerrain)==null||!e.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._selectAtmosphereType()==="realistic"}updateAnimation(e){return!!_(this._precipitation)&&this._precipitation.update(e)}get updating(){return _(this._pendingAtmosphere)||_(this._stars)&&this._stars.updating||_(this._clouds)&&this._clouds.running}get weatherVisible(){return Pe(this.view.state.camera.eye)-di(this.view.spatialReference).radius<=su}get _stars(){var e,t;const i=this.view,r=(e=(t=i.environment)==null?void 0:t.starsEnabled)!=null&&e,s=this._get("_stars");return!r||O(this._context)?(it(s),null):_(s)?s:new Zg({view:i,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||O(this._context))return it(e),null;const t=this.view,i=this._context;return _(e)&&e.context===i?e:(it(e),new Zv({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||O(this._context))return it(e),null;if(_(e))return e;const t=this.view,i=this._context.renderContext.rctx;return it(e),new To({rctx:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudComposition(){const e=this._get("_cloudComposition");if(!this.weatherEnabled||O(this._context))return it(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=di(this.view.spatialReference).radius;return _(e)&&e.viewingMode===t&&e.radius===r?e:(it(e),new Uw({rctx:i,viewingMode:t,radius:r}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||O(this._context))return it(e),null;if(_(e))return e;const t=this.view,i=this._context;return it(e),new kE({context:i,view:t})}get weatherEnabled(){var e,t;return!((e=this.view)==null||(t=e.environmentManager)==null||!t.weatherEnabled)}get precipitationEnabled(){return this._precipitationEnabled}set precipitationEnabled(e){this._precipitationEnabled=e}initializeRenderContext(e=null){this._context=e,this._handles.add([S7(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0),Nt(()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality}),()=>this._updateAtmosphere(),Yl),Nt(()=>this._stars,()=>this._setNeedsRender()),Nt(()=>this._clouds,()=>this._updateWeather(this._weatherUpdateParameters),un),Nt(()=>this._precipitation,()=>this._setNeedsRender()),Nt(()=>this._fog,()=>this._updateFog(this._weatherUpdateParameters),un),Nt(()=>this._weatherUpdateParameters,t=>{this._updateWeather(t),this._updateFog(t)},Yl)])}uninitializeRenderContext(){this._context=null,this._atmosphere=it(this._atmosphere),this._set("_stars",it(this._stars)),this._set("_precipitation",it(this._precipitation)),this._set("_clouds",it(this._clouds)),this._set("_cloudComposition",it(this._cloudComposition)),this._set("_fog",it(this._fog))}render(e){if(e.pass===De.MATERIAL)switch(e.slot){case ye.POSTPROCESSING_ENVIRONMENT_OPAQUE:_(this._stars)&&this._stars.render(e),_(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e),LBe(this._clouds)&&_(this._cloudComposition)&&(this._cloudComposition.render(e,this._clouds,_(this.view.animation)),this._cloudComposition.isFading&&this._setNeedsRender()));break;case ye.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(_(this._atmosphere)&&this._atmosphere.canRender){const t=this.weatherEnabled?this.view.environment.weather.type:"disabled";if(this._atmosphere.renderHaze(e,t==="rainy"),_(this._fog)){const i=t==="foggy"||t==="rainy"||t==="snowy";(i||this._selectAtmosphereType()!=="realistic")&&this._fog.render(e,i,t==="rainy")}this.view.environment.weather.type!=="rainy"&&this.view.environment.weather.type!=="snowy"||!_(this._precipitation)||this._precipitation.render(e,this.view.environment.weather.precipitation,this.view.environment.weather.type==="rainy"?Jl.RAIN:Jl.SNOW)}}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return O(e)?null:e.type==="rainy"||e.type==="snowy"?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:e.type==="foggy"?e.fogStrength:e.cloudCover}}_updateWeather(e){O(e)||O(this._clouds)||(this._clouds.applyPreset(Hfe[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){_(this._context)&&this._context.requestRender()}_updateFog(e){if(!O(this._fog)&&!O(e))switch(e.type){case"foggy":this._fog.strength=qt(3e-5,.005,e.weatherAdjustment**3),this._setNeedsRender();break;case"rainy":case"snowy":this._fog.strength=qt(4e-6,8e-5,e.effect**3),this._setNeedsRender();break;default:this._fog.strength=4e-6,this._setNeedsRender()}}_updateAtmosphere(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;_(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return _(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);_(this._context)&&i.initializeRenderContext(this._context),O(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then(()=>{_(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)})}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return CJ;case"panoramic":return OVe;case"simple":return UVe;default:return}}_selectAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||t==null||xp(this.view.spatialReference)?"none":i==="local"?"panoramic":t==="high"&&_(this._context)&&CJ.isSupported(this._context)&&ZA(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=_(this._atmosphere)&&this.atmosphereType==="simple")}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{YJ=zE.prototype._getAtmosphereClass,zE.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{zE.prototype._getAtmosphereClass=YJ},precipitationEnabled:e=>{this.precipitationEnabled=e}}}};u([d({constructOnly:!0})],So.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],So.prototype,"updating",null),u([d()],So.prototype,"weatherVisible",null),u([d()],So.prototype,"_context",void 0),u([d()],So.prototype,"_pendingAtmosphere",void 0),u([d({readOnly:!0})],So.prototype,"_stars",null),u([d({readOnly:!0})],So.prototype,"_precipitation",null),u([d({readOnly:!0})],So.prototype,"_clouds",null),u([d({readOnly:!0})],So.prototype,"_cloudComposition",null),u([d({readOnly:!0})],So.prototype,"_fog",null),u([d()],So.prototype,"weatherEnabled",null),u([d()],So.prototype,"_precipitationEnabled",void 0),u([d({readOnly:!0})],So.prototype,"_weatherUpdateParameters",null),So=zE=u([P("esri.views.3d.environment.EnvironmentRenderer")],So);function ZJ(e,t,i){return XVe(e,t.longitude,t.latitude,i.longitude,i.latitude)}function XVe(e,t,i,r,s){const n=Ct(i),o=Ct(s),a=n-o,l=Ct(t)-Ct(r),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Uh(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*e;return Math.round(1e4*p)/1e4}function YVe(e,t,i){const r=t.spatialReference,s=di(r),n=new Ke(t.x,e.y,r),o=new Ke(i.x,e.y,r),a=new Ke(e.x,t.y,r),l=new Ke(e.x,i.y,r);return{lon:ZJ(s.radius,n,o),lat:ZJ(s.radius,a,l)}}function ZVe(e,t,i){const r=t/i,s=Ct(e),n=Math.sin(r/2),o=Math.cos(s),a=2*Uh(Math.sqrt(n*n/(o*o)));return pl(a)}function QVe(e,t){let i=e/15;return t||(i=Math.round(i)),i}function QJ(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=QVe(e[0],!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var JJ,KJ,eK,rme={exports:{}};JJ=rme,KJ=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=e/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f($){return $.valueOf()/l-.5+c}function g($){return new Date(($+.5-c)*l)}function y($){return f($)-h}var v=23.4397*a;function b($,F){return n(t($)*i(v)-r(F)*t(v),i($))}function w($,F){return s(t(F)*i(v)+i(F)*t(v)*t($))}function S($,F,k){return n(t($),i($)*t(F)-r(k)*i(F))}function T($,F,k){return s(t(F)*t(k)+i(F)*i(k)*i($))}function A($,F){return a*(280.16+360.9856235*$)-F}function C($){return a*(357.5291+.98560028*$)}function R($){return a*(1.9148*t($)+.02*t(2*$)+3e-4*t(3*$))}function L($,F){return $+F+102.9372*a+e}function U($,F){var k=C($),G=L(k,R(k));return F||(F={dec:0,ra:0}),F.dec=w(G,0),F.ra=b(G,0),F}var N={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function($,F,k,G){var q=a*-k,K=a*F,H=y($),ee=U(H,p),ge=A(H,q)-ee.ra;return G||(G={azimuth:0,altitude:0}),G.azimuth=S(ge,K,ee.dec),G.altitude=T(ge,K,ee.dec),G}},z=[[-.83,"sunrise","sunset"]];N.addTime=function($,F,k){z.push([$,F,k])};var V=9e-4;function B($,F){return Math.round($-V-F/(2*e))}function J($,F,k){return V+($+F)/(2*e)+k}function Z($,F,k){return h+$+.0053*t(F)-.0069*t(2*k)}function te($,F,k){return o((t($)-t(F)*t(k))/(i(F)*i(k)))}function ie($){var F=a*(134.963+13.064993*$),k=a*(93.272+13.22935*$),G=a*(218.316+13.176396*$)+6.289*a*t(F),q=5.128*a*t(k),K=385001-20905*i(F);return{ra:b(G,q),dec:w(G,q),dist:K}}return N.getTimes=function($,F,k){var G=a*-k,q=a*F,K=B(y($),G),H=J(0,G,K),ee=C(H),ge=R(ee),Ae=L(ee,ge),Be=w(Ae,0),Se=Z(H,ee,Ae);function xe(Os){return Z(J(te(Os,q,Be),G,K),ee,Ae)}function Re(Os){var nb=(t(Os)-t(q)*t(Be))/(i(q)*i(Be));return nb<-1?N.PolarException.MIDNIGHT_SUN:nb>1?N.PolarException.POLAR_NIGHT:N.PolarException.NORMAL}var ke,Gi,Hr,Cs,Rs,cs={solarNoon:g(Se),nadir:g(Se-.5),polarException:N.PolarException.NORMAL};for(ke=0,Gi=z.length;ke<Gi;ke+=1)Rs=Se-((Cs=xe((Hr=z[ke])[0]*a))-Se),cs[Hr[1]]=g(Rs),cs[Hr[2]]=g(Cs);return cs.polarException=Re(z[0][0]*a),cs},N.getMoonPosition=function($,F,k){var G=a*-k,q=a*F,K=y($),H=ie(K),ee=A(K,G)-H.ra,ge=T(ee,q,H.dec);return ge+=.017*a/r(ge+10.26*a/(ge+5.1*a)),{azimuth:S(ee,q,H.dec),altitude:ge,distance:H.dist}},N.getMoonFraction=function($){var F=y($),k=U(F),G=ie(F),q=149598e3,K=o(t(k.dec)*t(G.dec)+i(k.dec)*i(G.dec)*i(k.ra-G.ra)),H=n(q*t(K),G.dist-q*i(K));return(1+i(H))/2},N},(eK=KJ())!==void 0&&(JJ.exports=eK);const O1=rme.exports,qd={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function JVe(e,t,i,r,s,n,o){oe(o.ambient.color,1,1,1),o.ambient.intensity=qd.global.ambient,oe(o.direct.color,1,1,1),o.direct.intensity=qd.global.direct;const a=t[2],l=ze((Math.abs(a)-qd.local.altitude)/(qd.global.altitude-qd.local.altitude),0,1);let c;if(o.globalFactor=l,n==="sun"&&(c=O1.getTimes(e,t[1],t[0])),l<1){let h;if(n==="sun")h=o8e(e,c,r);else{const p=nme(r);h={direct:{intensity:qd.local.directAtNoon*p.direct,color:je(1,1,1)},ambient:{intensity:qd.local.ambientAtNoon*p.ambient,color:je(1,1,1)},timeOfDay:"early afternoon"}}Ss(o.ambient.color,h.ambient.color,o.ambient.color,l),o.ambient.intensity=qt(h.ambient.intensity,o.ambient.intensity,l),Ss(o.direct.color,h.direct.color,o.direct.color,l),o.direct.intensity=qt(h.direct.intensity,o.direct.intensity,l),o.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,o.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}o.noonFactor=n==="sun"?n8e(e,c):1,n==="sun"?e8e(e,t,i,o.direct.directionToLightSource):KVe(s,i,o.direct.directionToLightSource)}function KVe(e,t,i){t===$e.Global?be(xM,e.eye):oe(xM,0,0,1),yl(wM,a8e,e.viewRight),Ue(i,xM,wM),yl(wM,l8e,xM),Ue(i,i,wM)}function e8e(e,t,i,r){const s=s8e,n=pp(r8e);if(i===$e.Global)O1.getPosition(e,0,0,s),oe(r,0,0,-1),cT(n,n,-s.azimuth),tN(n,n,-s.altitude),Ue(r,r,n);else{const o=qd.planarDirection,a=o.globalAngles,l=t[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=ze(c,0,1),c<1?(O1.getPosition(e,t[1],t[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),oe(r,0,-1,0),uT(n,n,-s.azimuth),cT(n,n,-s.altitude),Ue(r,r,n)}}function t8e(e,t){if(t===$e.Global)return!0;const i=qd.planarDirection;return Math.abs(e)<i.localAltitude}const i8e=je(.5773502691896258,-.5773502691896258,.5773502691896258);class sme{constructor(){this.ambient={color:je(1,1,1),intensity:.55},this.direct={color:je(1,1,1),intensity:.55,directionToLightSource:Ts(i8e)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const r8e=Te(),s8e={azimuth:0,altitude:0};function n8e(e,t){const i=e.valueOf();let r,s;t.polarException===O1.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===O1.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-ze(Math.abs(i-n)/432e5,0,1)}function nme(e){switch(e){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function tK(e,t){const i=(e[0]+e[1]+e[2])/3;for(let r=0;r<3;r++)e[r]=e[r]+(i-e[r])*t;return e}function o8e(e,t,i){const r=e.valueOf();let s,n;t.polarException===O1.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===O1.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,g=s+p/2,y=n-p/2,v=n+p/2,b=qd.local,w=[.01,b.ambientAtNight],S=[.8,.8,1],T=[.01,.01,.01],A=[b.directAtTwilight,b.ambientAtTwilight],C=[1,.6,.5],R=[.8,.8,1],L=[.9*b.directAtNoon,b.ambientAtNoon],U=[1,.98,.98],N=[.98,.98,1],z=[b.directAtNoon,b.ambientAtNoon],V=[1,1,1],B=[1,1,1],J=L,Z=U,te=N,ie=A,$=C,F=R;let k,G,q=[0,0],K=[0,0,0],H=[0,0,0];r<f||r>v?(q=w,K=T,H=S,G="night"):r<g?(k=g-f,q=xn(r-f,k,w,A),K=xn(r-f,k,T,C),H=xn(r-f,k,S,R),G="sun rising"):r<c?(k=c-g,q=xn(r-g,k,A,L),K=xn(r-g,k,C,U),H=xn(r-g,k,R,N),G="early morning"):r<a?(k=a-c,q=xn(r-c,k,L,z),K=xn(r-c,k,U,V),H=xn(r-c,k,N,B),G="late morning"):r<h?(k=h-a,q=xn(r-a,k,z,J),K=xn(r-a,k,V,Z),H=xn(r-a,k,B,te),G="early afternoon"):r<y?(k=y-h,q=xn(r-h,k,J,ie),K=xn(r-h,k,Z,$),H=xn(r-h,k,te,F),G="late afternoon"):r<v&&(k=v-y,q=xn(r-y,k,ie,w),K=xn(r-y,k,$,T),H=xn(r-y,k,F,S),G="sun setting");let ee=0;switch(i){case"rainy":case"foggy":ee=.9;case"snowy":ee=.5}ee>0&&(K=tK(K,ee),H=tK(H,ee));const ge=je(K[0],K[1],K[2]),Ae=je(H[0],H[1],H[2]),Be=nme(i);return{direct:{intensity:q[0]*Be.direct,color:ge},ambient:{intensity:q[1]*Be.ambient,color:Ae},timeOfDay:G}}function xn(e,t,i,r){const s=[];for(let n=0;n<i.length;n++)s[n]=(r[n]-i[n])*e/t+i[n];return s}const wM=Te(),xM=M(),a8e=.35,l8e=-.5;class iH{constructor(t=M()){this.intensity=t}}class ome{constructor(t=M(),i=je(.57735,.57735,.57735)){this.intensity=t,this.direction=i}}class C8{constructor(t=M(),i=je(.57735,.57735,.57735),r=!0,s=1,n=1){this.intensity=t,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=n}}class ame{constructor(){this.r=[0],this.g=[0],this.b=[0]}}let ch=class extends wr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new Bt,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new C8,this._ambientLight=new iH,this._moonLight=new ome,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||(e=this._renderer)!=null&&e.updating)}get weatherEnabled(){var e,t,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((t=this._view)==null||(i=t.state)==null?void 0:i.viewingMode)===$e.Global&&ZA(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new So({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler(),r=()=>this._updateLighting();this._viewHandles.add([Nt(()=>e.environment.lighting,s=>this._updateLightingHandler(s),ph),Nt(()=>e.environment.lighting.date,s=>this._lightingDateHandler(s),ph),Nt(()=>e.stationary,()=>this._interactingStationaryHandler()),Nt(()=>e.environment.lighting.directShadowsEnabled,t,ph),Nt(()=>e.environment.lighting.ambientOcclusionEnabled,t,ph),Nt(()=>e.environment.lighting.waterReflectionEnabled,t,ph),Nt(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},t,ph),Nt(()=>e.spatialReference,()=>this._resetReferencePosition(!0),ph),Nt(()=>e.environment.weather.type,r,ph),Nt(()=>this.weatherEnabled,r,ph),Nt(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Yl),Nt(()=>e.environment.lighting.type==="sun"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),Yl),Nt(()=>e.state.camera,i,Yl),Nt(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=it(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type==="sun"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.date),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)==="sun"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!f1(i)){const r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(e),_(this._referencePosWGS84Comparable)){const r=QJ(this._referencePosWGS84Comparable,iK);_(r)&&(t.autoUpdate(null,r),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type==="sun"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=ZA(this._view.spatialReference);if(i&&!f1(this._view.spatialReference))return!1;const r=e.position;return O(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=M()),i?lCe(r,this._referencePosWGS84Comparable):oe(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){const t=this._view,i=e||t.environment.lighting.date,r=this._referencePosWGS84Comparable,s=_(r)?c8e:u8e;if(_(r)){const h=this.weatherVisible?t.environment.weather.type:"disabled";JVe(i,r,t.state.viewingMode,h,t.state.camera,t.environment.lighting.type,s)}const n=this._mainLight,o=s.direct;ae(n.intensity,o.color,o.intensity*Math.PI),ne(n.direction,o.directionToLightSource),n.specularStrength=s.specularStrength,n.environmentStrength=s.environmentStrength;const a=this._ambientLight;ae(a.intensity,s.ambient.color,s.ambient.intensity);const l=this._moonLight;Ss(l.intensity,d8e,p8e,s.globalFactor);const c=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));ae(l.intensity,l.intensity,c),ne(l.direction,o.directionToLightSource),t._stage.renderView.updateLightSources([n,a,l],1-s.noonFactor,s.globalFactor),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||O(e))return!1;const i=h8e;i.setTime((t||this._view.environment.lighting.date).getTime());const r=QJ(e,iK);if(O(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),o=i.getUTCMinutes()-(r.minutes-s.minutes),a=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(o),i.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=Qa(this._referencePosWGS84Comparable,!0,s=>t8e(s[2],this._view.state.viewingMode)),i=this._view.environment.background,r=i instanceof rfe?{type:"color",color:l7(Qe.toUnitRGBA(i.color))}:{type:"color",color:yi(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,fillLightsEnabled:this._view.environment.lighting.type==="sun",background:r})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=Wx(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const s=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(s)}}).catch(s=>{s.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),r=this._referencePosUpdateTimer=Wx(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===r&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const i=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[t[0],t[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};u([d({type:Boolean,readOnly:!0})],ch.prototype,"updating",null),u([d()],ch.prototype,"disableQueries",void 0),u([d()],ch.prototype,"_disableWeather",void 0),u([d()],ch.prototype,"weatherEnabled",null),u([d()],ch.prototype,"weatherVisible",null),u([d()],ch.prototype,"referencePositionWGS84Comparable",null),u([d()],ch.prototype,"_renderer",void 0),u([d()],ch.prototype,"_referencePosWGS84Comparable",void 0),ch=u([P("esri.views.3d.environment.SceneViewEnvironmentManager")],ch);const c8e=new sme,u8e=new sme,h8e=new Date,iK={hours:0,minutes:0,seconds:0},d8e=je(.22,.22,.33),p8e=je(.22,.22,.22);function BC(e,t){return(e&t)!=0}function MD(e,t,i,r,s,n){e!==0&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):r!=null?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}var Ot,Xi,Zs;(function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"})(Ot||(Ot={})),function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Xi||(Xi={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Zs||(Zs={}));const p0={selection:Xi.NONE,interactionType:Ot.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Zs.TUMBLE};function lme(e,t,i,r){return t=t||e.viewForward,ne(r,t),ae(r,r,Math.sign(_e(t,i))),r}function f8e(e,t,i,r){return _8e(e,t,i,y8e(r,t,i,!0))}function m8e(e,t,i,r){const s=_e(i,de(e,r,t));return pe(e,t,ae(e,i,s))}const g8e={dir:M(),len:0,clip:Xe()};function y8e(e,t,i,r){const s=g8e;return e?(i&&r&&(s.len=xi(t,i)),ne(s.dir,e)):r?(s.len=xi(t,i),de(s.dir,i,t),ae(s.dir,s.dir,1/s.len)):(de(s.dir,i,t),be(s.dir,s.dir)),s}function v8e(e,t,i){const r=_e(e,i.dir),s=-er(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function _8e(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<e.length;s++)if(!v8e(e[s],t,r))return!1;return!0}function b8e(e,t,i=p0){const r=rH(e,t,i);if(r===0)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,o=lme(t,i.interactionDirection,T8e(e,t,Math.sign(r),C8e),A8e),a=ne(R8e,t.viewForward),l=s.intersectInfiniteManifold(fc(t.eye,o),n,X5);return t.eye=_(l)?l:s.setAltitude(X5,n,t.eye),t.center=m8e(X5,t.eye,a,t.center),!0}function rH(e,t,i=p0){if(!w8e(e,i))return 0;const r=S8e(e.state.constraints.altitude,E8e);x8e(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=ze(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function w8e(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==Ot.TUMBLE||!BC(t.selection,Xi.TILT))}function x8e(e,t,i){const r=t.interactionType;if(r===Ot.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===Ot.TUMBLE||r===Ot.ZOOM,c=rH(e,o),h=c===0?0:e.renderCoordsHelper.getAltitude(o.eye);i.min=s,i.max=n,MD(c,h,l,a,.05*h,i)}function T8e(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),ae(r,r,i),r}function S8e(e,t){return t.min=e.min,t.max=e.max,t}const E8e={min:0,max:0},A8e=M(),C8e=M(),R8e=M(),X5=M();function sH(e,t,i=p0){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;TM.min=0,TM.max=r,M8e(e,i,TM);const s=nH(e,t),n=TM.max-s;return n>=-1e-6?0:n}function O8e(e,t,i=p0){const r=sH(e,t,i);if(r===0)return!1;const s=e.pointsOfInterest.surfaceOrigin,n=nH(e,t)+r,o=ne(I8e,t.eye),a=lme(t,i.interactionDirection,P8e(e,t,L8e),D8e);if(!E0(Fle(s.renderLocation,n),fc(t.eye,a),SM))return!1;t.eye=SM;const l=de($8e,t.eye,o);t.center=pe(SM,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,SM);return _(h)&&(t.center=h),!0}function M8e(e,t,i){const r=t.interactionType;if(r===Ot.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===Ot.ZOOM||r===Ot.PAN,c=sH(e,o),h=c===0?0:nH(e,o);i.min=s,i.max=n,MD(c,h,l,a,.05*h,i)}function nH(e,t){const i=e.pointsOfInterest.surfaceOrigin;return xi(t.eye,i.renderLocation)}function P8e(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return Am(i,t.eye,r.renderLocation)}const TM={min:0,max:0},I8e=M(),$8e=M(),D8e=M(),L8e=M(),SM=M();var lr,Bn;(function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"})(lr||(lr={}));class N8e{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=Bn.ALL}}(function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"})(Bn||(Bn={}));function Mp(e){return _(e)&&_(e.dist)}function rK(e){return(t,i,r)=>(Ss(sK,t,i,r),!g7(e,sK))}function cme(e){return Mp(e)&&e.intersector===lr.OBJECT&&!!e.target}function oH(e){return Mp(e)&&e.intersector===lr.HUD&&!!e.target&&_(e.target.center)}const sK=M();class F8e{constructor(){this._transform=Te(),this._transformInverse=new EM({value:this._transform},hr,Te),this._transformInverseTranspose=new EM(this._transformInverse,Ea,Te),this._transformTranspose=new EM({value:this._transform},Ea,Te),this._transformInverseRotation=new EM({value:this._transform},Gfe,br)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){Lr(this._transform,t)}multiplyTransform(t){ur(this._transform,this._transform,t)}set(t){Lr(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,i){this.setTransformMatrix(t),this.multiplyTransform(i),this._invalidateLazyTransforms()}}class EM{constructor(t,i,r){this.original=t,this.update=i,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}class U8e{constructor(t=0){this.offset=t,this.tmpVertex=M()}applyToVertex(t,i,r){const s=t+this.localOrigin[0],n=i+this.localOrigin[1],o=r+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=t+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(t){const i=t[0]+this.localOrigin[0],r=t[1]+this.localOrigin[1],s=t[2]+this.localOrigin[2],n=t[3]+this.localOrigin[0],o=t[4]+this.localOrigin[1],a=t[5]+this.localOrigin[2],l=this.offset/Math.sqrt(i*i+r*r+s*s);t[0]+=i*l,t[1]+=r*l,t[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return t[3]+=n*c,t[4]+=o*c,t[5]+=a*c,t}}class k8e{constructor(t=0){this.offset=t,this.componentLocalOriginLength=0,this.tmpVertex=M(),this.mbs=ni(),this.obb={center:M(),halfSize:fi(),quaternion:null}}set localOrigin(t){this.componentLocalOriginLength=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}applyToVertex(t,i,r){const s=t,n=i,o=r+this.componentLocalOriginLength,a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=t+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(t){const i=t[0],r=t[1],s=t[2]+this.componentLocalOriginLength,n=t[3],o=t[4],a=t[5]+this.componentLocalOriginLength,l=this.offset/Math.sqrt(i*i+r*r+s*s);t[0]+=i*l,t[1]+=r*l,t[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return t[3]+=n*c,t[4]+=o*c,t[5]+=a*c,t}applyToMbs(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/i;return this.mbs[0]=t[0]+t[0]*r,this.mbs[1]=t[1]+t[1]*r,this.mbs[2]=t[2]+t[2]*r,this.mbs[3]=t[3]+t[3]*this.offset/i,this.mbs}applyToObb(t){const i=t.center,r=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);this.obb.center[0]=i[0]+i[0]*r,this.obb.center[1]=i[1]+i[1]*r,this.obb.center[2]=i[2]+i[2]*r,Ky(this.obb.halfSize,t.halfSize,t.quaternion),pe(this.obb.halfSize,this.obb.halfSize,t.center);const s=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*s,this.obb.halfSize[1]+=this.obb.halfSize[1]*s,this.obb.halfSize[2]+=this.obb.halfSize[2]*s,de(this.obb.halfSize,this.obb.halfSize,t.center),HR(lK,t.quaternion),Ky(this.obb.halfSize,this.obb.halfSize,lK),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=t.quaternion,this.obb}}class z8e{constructor(t=0){this.offset=t,this.sphere=vn(),this.tmpVertex=M()}applyToVertex(t,i,r){const s=this.objectTransform.transform;let n=s[0]*t+s[4]*i+s[8]*r+s[12],o=s[1]*t+s[5]*i+s[9]*r+s[13],a=s[2]*t+s[6]*i+s[10]*r+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(t,i){const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r;const s=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]+=i[0]*s,i[1]+=i[1]*s,i[2]+=i[2]*s}applyToAabb(t){const i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i;const r=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*r,t[4]+=t[4]*r,t[5]+=t[5]*r,t}applyToBoundingSphere(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/i;return this.sphere[0]=t[0]+t[0]*r,this.sphere[1]=t[1]+t[1]*r,this.sphere[2]=t[2]+t[2]*r,this.sphere[3]=t[3]+t[3]*this.offset/i,this.sphere}}const nK=new z8e;function R8(e){return _(e)?(nK.offset=e,nK):null}const oK=new k8e;function Apt(e){return _(e)?(oK.offset=e,oK):null}const aK=new U8e;function B8e(e){return _(e)?(aK.offset=e,aK):null}const v_="terrain",lK=T0();function PD(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function V8e(e,t,i,r){for(let s=0;s<r;++s)cK[0]=e[s],PD(cK,Y5,1),t[s]=Y5[0],i[s]=Y5[1]}const cK=new Float64Array(1),Y5=new Float32Array(2);function O8(e,t){return O(e)&&(e=[]),e.push(t),e}function M8(e,t){if(O(e))return null;const i=e.filter(r=>r!==t);return i.length===0?null:i}function XR(e){return!!_(e)&&!e.visible}function G8e(e,t,i){const r=e.origin.vec3;Qfe(Z5,-r[0],-r[1],-r[2]),_(e.transformation)?ur(t,Z5,e.transformation):Lr(t,Z5),i&&(hr(i,t),Ea(i,i))}function j8e(e,t,i,r,s){AM[0]=e.get(t,0),AM[1]=e.get(t,1),AM[2]=e.get(t,2),PD(AM,z0,3),i.set(s,0,z0[0]),r.set(s,0,z0[1]),i.set(s,1,z0[2]),r.set(s,1,z0[3]),i.set(s,2,z0[4]),r.set(s,2,z0[5])}const AM=new Float64Array(3),z0=new Float32Array(6),Z5=Te(),kT=1e-5;class H8e{constructor(t){this.options=new N8e,this._results=new q8e,this.transform=new F8e,this.tolerance=kT,this.verticalOffset=null,this._ray=Fn(),this._rayEnd=M(),this._rayBeginTransformed=M(),this._rayEndTransformed=M(),this.viewingMode=t==null?$e.Global:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,i,r){this.resetWithRay(LCe(t,i,this._ray),r)}resetWithRay(t,i){this.camera=i,t!==this._ray&&B$(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===$e.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,pe(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,i,r,s,n){this.point=i,this.filterPredicate=s,this.tolerance=r==null?kT:r;const o=R8(this.verticalOffset);if(_(t)&&t.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of t){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();_(c)?(_(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(t){const i=t.geometryRecords;if(!i)return;const r=t.transformation,s=R8(this.verticalOffset);for(const n of i){const{geometry:o,material:a,instanceParameters:l}=n;if(XR(l))continue;const c=o.id;this.transform.setAndInvalidateLazyTransforms(r,n.getShaderTransformation()),Ue(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Ue(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;_(s)&&(s.objectTransform=this.transform),a.intersect(o,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(p,f,g,y,v,b)=>{if(p>=0){if(_(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,p))return;if(y){if(this._results.hud.dist==null||p<this._results.hud.dist){const S={object:t,geometryId:c,triangleNr:g,center:b};this._results.hud.set(lr.HUD,S,p,f,ss,v)}return}const w=S=>S.set(lr.OBJECT,{object:t,geometryId:c,triangleNr:g},p,f,h,v);if((this._results.min.drapedLayerOrder==null||v>=this._results.min.drapedLayerOrder)&&(this._results.min.dist==null||p<this._results.min.dist)&&w(this._results.min),this.options.store!==Bn.MIN&&(this._results.max.drapedLayerOrder==null||v<this._results.max.drapedLayerOrder)&&(this._results.max.dist==null||p>this._results.max.dist)&&w(this._results.max),this.options.store===Bn.ALL){const S=YN(this._ray);S.set(lr.OBJECT,{object:t,geometryId:c,triangleNr:g},p,f,h),this._results.all.push(S)}}},n.shaderTransformation)}}sortResults(){this._results.all.sort((t,i)=>t.dist!==i.dist?gt(t.dist,0)-gt(i.dist,0):t.drapedLayerOrder!==i.drapedLayerOrder?gt(t.drapedLayerOrder,Number.MAX_VALUE)-gt(i.drapedLayerOrder,Number.MAX_VALUE):gt(i.drapedLayerGraphicOrder,Number.MIN_VALUE)-gt(t.drapedLayerGraphicOrder,Number.MIN_VALUE))}}function Ou(e){return new H8e(e)}class q8e{constructor(){this._min=new BE(Fn()),this._max=new BE(Fn()),this._hud=new BE(Fn()),this._ground=new BE(Fn())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(t){this._min.init(t),this._max.init(t),this._hud.init(t),this._ground.init(t),this.all=[]}}class BE{constructor(t){this.intersector=lr.OBJECT,this.normal=M(),this.transformation=Te(),this._ray=Fn(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return _(this.dist)?(ae(CM,this.ray.direction,this.dist),Pe(CM)):null}getIntersectionPoint(t){return!!Mp(this)&&(ae(CM,this.ray.direction,this.dist),pe(t,this.ray.origin,CM),!0)}getTransformedNormal(t){return ne(KS,this.normal),KS[3]=0,bu(KS,KS,this.transformation),ne(t,KS),be(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=lr.OBJECT,B$(t,this._ray)}set(t,i,r,s,n,o,a){this.intersector=t,this.dist=r,ne(this.normal,gt(s,cne)),Lr(this.transformation,gt(n,ss)),this.target=i,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(t){B$(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,ne(this.normal,t.normal),Lr(this.transformation,t.transformation)}}function YN(e){return new BE(e)}const CM=M(),KS=ni();function ume(e,t,i,r){return _(e.renderCoordsHelper.fromRenderCoords(t.eye,ID,r))&&CG(i,ID)}function ZN(e,t){return e.elevationProvider?gt(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function ib(e,t,i,r){const s=e.state.camera.clone();t&&(s.eye=t,s.center=i,s.up=r),W8e(e,s.ray,Qm)||ne(Qm,s.center);const n=e.state.constraints,o=n.minimumPoiDistance;if(ko(s.eye,Qm)<o){const a=n.collision.enabled;ne(B0,s.viewForward),ae(B0,B0,o),a?s.eye=de(ID,Qm,B0):pe(Qm,s.eye,B0);const l=e.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(de(B0,Qm,s.eye),s.eye=l.setAltitude(ID,h,s.eye),pe(Qm,s.eye,B0))}return s.center=Qm,s}function uK(e,t,i){if(!e.state.isGlobal)return!1;const r=ZN(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(t,i,e.renderDataExtent,r,Y8e),o=n*n;return ko(t,i)>o}function W8e(e,t,i){let r=hK[e.viewingMode];r||(r=Ou(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,hK[e.viewingMode]=r);const{isGlobal:s}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||uK(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||uK(e,t.origin,i))||!!s&&X8e(t,i,di(e.spatialReference).radius)}function X8e(e,t,i){const r=_e(e.origin,e.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return ae(t,e.direction,s/Pe(e.direction)),pe(t,t,e.origin),!0}const hK={},ID=M(),Qm=M(),B0=M(),Y8e={near:0,far:0};function wS(e,t,i=_u.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=ZN(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),o=s+r.collision.elevationMargin;if(n>=o)return!1;const a=Pe(t.eye);if(de(RM,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Z8e,o,t.eye),i===_u.EYE_AND_CENTER)t.center=pe(RM,t.eye,RM);else if(i===_u.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;t.center=ae(RM,t.center,l)}return!0}var _u;(function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(_u||(_u={}));const RM=M(),Z8e=M();function f0(e,t,i){e.worldUpAtPosition(t,dK),de(Q5,i,t);const r=Pe(Q5);return r===0?0:Es(_e(Q5,dK)/r)}const dK=M(),Q5=M();function hme(e,t,i=p0,r=!0){e2.eyeCenterDistance=0,e2.requiresTwoSteps=!1;const s=aH(e,t,i,void 0,e2);if(s===0)return!1;switch(yl(OM,-s,t.viewRight),i.tiltMode){case Zs.LOOK_AROUND:Ue(Jm,t.viewForward,OM),ae(Jm,Jm,e2.eyeCenterDistance),t.center=pe(gy,t.eye,Jm);break;case Zs.TUMBLE:de(Jm,t.center,t.eye),Ue(Jm,Jm,OM),t.eye=de(gy,t.center,Jm);break;default:i.tiltMode}return t.up=Ue(gy,t.up,OM),!e2.requiresTwoSteps||!r||hme(e,t,i,!1)}function aH(e,t,i=p0,r=p0,s){if(!e.state.constraints.tilt)return 0;const n=t.distance,o=e.state.constraints.tilt(n,o9e);return n9e(e,i,o),r.interactionType===Ot.TUMBLE&&BC(r.selection,Xi.ALTITUDE)&&dme(e,r.interactionStartCamera,o),i.tiltMode===Zs.LOOK_AROUND||r.tiltMode===Zs.LOOK_AROUND?J8e(e,t,o,s):Q8e(e,t,o)}function Q8e(e,t,i){const r=f0(e.renderCoordsHelper,t.center,t.eye),s=r-ze(r,i.min,i.max);return VC(s)?s:0}function J8e(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return e9e(e,t,i,r);case"local":return K8e(e,t,i,r);default:return void(e.viewingMode,void 0)}}function K8e(e,t,i,r){const s=f0(e.renderCoordsHelper,t.center,t.eye),n=ze(s,i.min,i.max),o=s-n;if(!VC(o))return 0;if(r){const a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=t.distance}return o}function e9e(e,t,i,r){const s=t9e(e,t,a9e),n=ze(s.tiltAtCenter,i.min,i.max);if(!VC(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=i9e(s),a=r9e(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&o<Math.PI/2&&(r.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=s9e(s,o)),r&&(r.eyeCenterDistance=P8(s,o)),a}function t9e(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+di(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,gy);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,_(n)?(i.eyeCenterDistance=xi(t.eye,n),i.tiltAtCenter=f0(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=f0(e.renderCoordsHelper,t.center,t.eye):(cS(s,t.ray,gy),i.eyeCenterDistance=xi(t.eye,gy),i.tiltAtCenter=Es(-_e(t.viewForward,be(gy,gy)))),i.radius=s,i.eyeRadius=Pe(t.eye),i.constraints=e.state.constraints,i}function VC(e){return Math.abs(e)>1e-9}function i9e(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const o=P8(e,n);if(t.clampTilt(o,r)===n)return n;let a=0;for(;a<10&&VC(n-s);){const l=(s+n)/2,c=P8(e,l);VC(t.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function P8(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-ze(t,0,Math.PI),r=Uh(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const o=Math.PI-r,a=Math.PI-i-o;return Math.sin(a)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function r9e(e,t){const i=Uh(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Uh(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function s9e(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function n9e(e,t,i){if(t.interactionType===Ot.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:n,max:o}=i,a=aH(e,r,p0,t),l=a===0?0:f0(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=o,t.interactionType===Ot.TUMBLE?(BC(t.selection,Xi.ALTITUDE)&&dme(e,r,i),MD(a,l,!0,s,pK,i)):MD(a,l,!1,s,pK,i)}function dme(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=Fo(t.center),n=Math.sqrt(s),o=t.distance,a=di(e.spatialReference).radius,l=r.altitude.min+a,c=r.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);i.min=Math.max(i.min,Math.min(Math.PI-Es(p),i.max)),i.max=Math.min(i.max,Math.PI-Es(h))}const Jm=M(),OM=Te(),gy=M(),pK=Ct(5),o9e={min:0,max:0},a9e={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},e2={eyeCenterDistance:0,requiresTwoSteps:!1};function l9e(e){return e}const QN=e=>e*e,lH=e=>1-QN(1-e),c9e=e=>e<.5?QN(2*e)/2:(lH(2*(e-.5))+1)/2,cH=e=>e*e*e,pme=e=>1-cH(1-e),fme=e=>e<.5?cH(2*e)/2:(pme(2*(e-.5))+1)/2,uH=e=>e*e*e*e,mme=e=>1-uH(1-e),u9e=e=>e<.5?uH(2*e)/2:(mme(2*(e-.5))+1)/2,hH=e=>e*e*e*e*e,gme=e=>1-hH(1-e),h9e=e=>e<.5?hH(2*e)/2:(gme(2*(e-.5))+1)/2,dH=e=>1-Math.cos(e*Math.PI/2),yme=e=>1-dH(1-e),d9e=e=>e<.5?dH(2*e)/2:(yme(2*(e-.5))+1)/2,pH=e=>2**(10*(e-1)),YR=e=>1-pH(1-e),p9e=e=>e<.5?pH(2*e)/2:(YR(2*(e-.5))+1)/2,fH=e=>-(Math.sqrt(1-e*e)-1),vme=e=>1-fH(1-e),f9e=e=>e<.5?fH(2*e)/2:(vme(2*(e-.5))+1)/2;function Iu(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function $u(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const m9e=$u(Iu(1),1),g9e=$u(Iu(1),0),_me=$u(Iu(1),.5),y9e=$u(Iu(2),1),v9e=$u(Iu(2),0),_9e=$u(Iu(2),.5),b9e=$u(Iu(3),1),w9e=$u(Iu(3),0),x9e=$u(Iu(3),.5),T9e=$u(Iu(4),1),S9e=$u(Iu(4),0),E9e=$u(Iu(4),.5),A9e={linear:l9e,"in-quad":QN,"out-quad":lH,"in-out-quad":c9e,"in-coast-quad":m9e,"out-coast-quad":g9e,"in-out-coast-quad":_me,"in-cubic":cH,"out-cubic":pme,"in-out-cubic":fme,"in-coast-cubic":y9e,"out-coast-cubic":v9e,"in-out-coast-cubic":_9e,"in-quart":uH,"out-quart":mme,"in-out-quart":u9e,"in-coast-quart":b9e,"out-coast-quart":w9e,"in-out-coast-quart":x9e,"in-quint":hH,"out-quint":gme,"in-out-quint":h9e,"in-coast-quint":T9e,"out-coast-quint":S9e,"in-out-coast-quint":E9e,"in-sine":dH,"out-sine":yme,"in-out-sine":d9e,"in-expo":pH,"out-expo":YR,"in-out-expo":p9e,"in-circ":fH,"out-circ":vme,"in-out-circ":f9e};function Dr(e,t,i=M9e,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let a=0;a<P9e;a++){let l=0;for(const c of O9e)if(BC(i.selection,c.type)){const h=Math.abs(c.error(e,r,i));c.apply(e,r,i)&&(s=!0,l+=h)}if(l===0)break}const n=BC(i.selection,Xi.COLLISION),o=C9e(i.interactionType,e);return n&&wS(e,r,o)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function C9e(e,t){switch(e){case Ot.PAN:return _u.EYE_AND_CENTER;case Ot.ASCEND:return t.state.isGlobal?_u.EYE_AND_CENTER_SCALE:_u.EYE_AND_CENTER;default:return _u.EYE}}function wh(e,t){const i=typeof e=="number"?e:Px(e,t),r=Math.min(1,i/150);return fme(r)}function R9e(e,t,i){return aH(e,t,i)*t.distance}const O9e=[{type:Xi.TILT,error:R9e,apply:hme},{type:Xi.ALTITUDE,error:rH,apply:b8e},{type:Xi.DISTANCE,error:sH,apply:O8e}],M9e={selection:Xi.ALL,interactionType:Ot.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Zs.TUMBLE},P9e=5,Sl=M(),Oa=M(),Km=M(),Wn=M(),V0=M(),I9e=M(),El={upward:je(0,0,1),forward:je(0,1,0),sideway:je(1,0,0)},fK=br();class mK{constructor(t=$e.Global){this.viewingMode=t,this.center=M(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Ts(El.forward)}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,i){if(i||(i={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===$e.Global){const n=(Pe(this.center)+Pe(t.center))/2;i.pan=d4(this.center,t.center)*n}else i.pan=xi(this.center,t.center);let r=Math.abs(t.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(t.pitch-this.pitch);return i.rotate=Math.max(r,s),i.sourceZoom=this.distance,i.targetZoom=t.distance,i}interpolate(t,i,r){this.viewingMode===$e.Global?Pxe(t.center,i.center,r.pan,this.center):Ss(this.center,t.center,i.center,r.pan),this.distance=qt(t.distance,i.distance,r.zoom),this.pitch=qt(t.pitch,i.pitch,r.rotate);let s=t.yaw;const n=i.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=qt(s,n,r.rotate)}copyFrom(t){ne(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,ne(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){const i=this._lookAtOrientation(t.center,fK);ne(this.center,t.center),de(Wn,t.center,t.eye),rl(Wn,Wn,i),rl(V0,t.up,i),this.distance=Pe(Wn),Wn[0]/=this.distance,Wn[1]/=this.distance,Wn[2]/=this.distance,this.pitch=this._eyeUpToPitch(Wn),this.yaw=this._eyeUpToYaw(Wn,V0),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t)}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,fK);Au(i,i),this._axisAngleVec3(El.sideway,this.pitch-Math.PI/2,El.forward,Wn),this._axisAngleVec3(El.upward,this.yaw,Wn),this._axisAngleVec3(El.sideway,this.pitch-Math.PI/2,El.upward,V0),this._axisAngleVec3(El.upward,this.yaw,V0),ae(Wn,Wn,this.distance),rl(Wn,Wn,i),rl(V0,V0,i),t.center=this.center,t.eye=de(Wn,this.center,Wn),t.up=V0}_axisAngleVec3(t,i,r,s=r){const n=Math.cos(i),o=Math.sin(i);return ae(Sl,r,n),dt(Oa,t,r),ae(Oa,Oa,o),ae(Km,t,(1-n)*_e(t,r)),pe(s,pe(s,Sl,Oa),Km)}_lookAtOrientation(t,i=br()){return this._upAtLookAt(t,Km),dt(Sl,this.lookAtDirection,Km),be(Sl,Sl),Sl[0]===0&&Sl[1]===0&&Sl[2]===0&&ne(Sl,El.sideway),dt(Oa,Km,Sl),be(Oa,Oa),i[0]=Sl[0],i[1]=Oa[0],i[2]=Km[0],i[3]=Sl[1],i[4]=Oa[1],i[5]=Km[1],i[6]=Sl[2],i[7]=Oa[2],i[8]=Km[2],i}_upAtLookAt(t,i){return this.viewingMode===$e.Local?ne(i,El.upward):be(i,t)}_eyeUpToPitch(t){return Math.PI-d4(El.upward,t)}_eyeUpToYaw(t,i){const r=I9e;return Math.abs(i[2])<.5?(ne(r,i),t[2]>0&&ae(r,r,-1)):ne(r,t),dt(Oa,r,El.upward),be(Oa,Oa),d4(El.sideway,Oa,El.upward)}}function mH(e){return e?{ray:Fn(e.ray),c0:e.c0,c1:e.c1}:{ray:Fn(),c0:0,c1:Number.MAX_VALUE}}function $9e(e,t=mH()){return B$(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function D9e(e,t,i=mH()){const r=Pe(e.vector);return Nle(e.origin,t,i.ray),i.c0=0,i.c1=r,i}new Om(()=>({c0:0,c1:0,ray:null}));function GC(e){return e?[ii(e[0]),ii(e[1]),ii(e[2]),ii(e[3]),ii(e[4]),ii(e[5])]:[ii(),ii(),ii(),ii(),ii(),ii()]}function bme(){return[M(),M(),M(),M(),M(),M(),M(),M()]}function $D(e,t){for(let i=0;i<m0.NUM;i++)lN(e[i],t[i])}function wme(e,t,i,r=z9e){const s=ur(OR.get(),t,e);hr(s,s);for(let n=0;n<I8.NUM;++n){const o=bu(c7.get(),k9e[n],s);oe(r[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}xme(i,r)}function xme(e,t){ro(t[We.FAR_BOTTOM_LEFT],t[We.NEAR_BOTTOM_LEFT],t[We.NEAR_TOP_LEFT],e[qi.LEFT]),ro(t[We.NEAR_BOTTOM_RIGHT],t[We.FAR_BOTTOM_RIGHT],t[We.FAR_TOP_RIGHT],e[qi.RIGHT]),ro(t[We.FAR_BOTTOM_LEFT],t[We.FAR_BOTTOM_RIGHT],t[We.NEAR_BOTTOM_RIGHT],e[qi.BOTTOM]),ro(t[We.NEAR_TOP_LEFT],t[We.NEAR_TOP_RIGHT],t[We.FAR_TOP_RIGHT],e[qi.TOP]),ro(t[We.NEAR_BOTTOM_LEFT],t[We.NEAR_BOTTOM_RIGHT],t[We.NEAR_TOP_RIGHT],e[qi.NEAR]),ro(t[We.FAR_BOTTOM_RIGHT],t[We.FAR_BOTTOM_LEFT],t[We.FAR_TOP_LEFT],e[qi.FAR])}function Ny(e,t){for(let i=0;i<m0.NUM;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function L9e(e,t){return Sme(e,$9e(t,Eme.get()))}function N9e(e,t,i){return Sme(e,D9e(t,i,Eme.get()))}function Tme(e,t){for(let i=0;i<m0.NUM;i++)if(er(e[i],t)>0)return!1;return!0}function F9e(e,t){for(let i=0;i<m0.NUM;i++)if(iRe(e[i],t))return!1;return!0}function Sme(e,t){for(let i=0;i<m0.NUM;i++)if(!rRe(e[i],t))return!1;return!0}var qi,We;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.TOP=3]="TOP",e[e.NEAR=4]="NEAR",e[e.FAR=5]="FAR"})(qi||(qi={})),function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(We||(We={}));const U9e={bottom:[We.FAR_BOTTOM_RIGHT,We.NEAR_BOTTOM_RIGHT,We.NEAR_BOTTOM_LEFT,We.FAR_BOTTOM_LEFT],near:[We.NEAR_BOTTOM_LEFT,We.NEAR_BOTTOM_RIGHT,We.NEAR_TOP_RIGHT,We.NEAR_TOP_LEFT],far:[We.FAR_BOTTOM_RIGHT,We.FAR_BOTTOM_LEFT,We.FAR_TOP_LEFT,We.FAR_TOP_RIGHT],right:[We.NEAR_BOTTOM_RIGHT,We.FAR_BOTTOM_RIGHT,We.FAR_TOP_RIGHT,We.NEAR_TOP_RIGHT],left:[We.FAR_BOTTOM_LEFT,We.NEAR_BOTTOM_LEFT,We.NEAR_TOP_LEFT,We.FAR_TOP_LEFT],top:[We.FAR_TOP_LEFT,We.NEAR_TOP_LEFT,We.NEAR_TOP_RIGHT,We.FAR_TOP_RIGHT]};var m0,I8;(function(e){e[e.NUM=6]="NUM"})(m0||(m0={})),function(e){e[e.NUM=8]="NUM"}(I8||(I8={}));const k9e=[yi(-1,-1,-1,1),yi(1,-1,-1,1),yi(1,1,-1,1),yi(-1,1,-1,1),yi(-1,-1,1,1),yi(1,-1,1,1),yi(1,1,1,1),yi(-1,1,1,1)],Eme=new Om(mH),z9e=bme(),B9e=he.getLogger("esri.views.3d.webgl-engine.lib.Camera");class wi{constructor(t=null,i=null,r=null){this._viewUp=M(),this._viewForward=M(),this._viewRight=M(),this._ray=Fn(),this._viewport=yi(0,0,1,1),this._padding=yi(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=vi(1,1e3),this._viewDirty=!0,this._viewMatrix=Te(),this._projectionDirty=!0,this._projectionMatrix=Te(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Te(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Te(),this._frustumDirty=!0,this._frustum=GC(),this._fullViewport=ni(),this.pixelRatio=1,this.relativeElevation=0,_(t)&&ne(this._ray.origin,t),this._center=_(i)?Ts(i):M(),this._up=_(r)?Ts(r):je(0,0,1)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center)}get ray(){return de(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){Lr(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get x(){return this._viewport[0]}set x(t){t+=this._padding[bt.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(t){t+=this._padding[bt.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[bt.RIGHT]+this._padding[bt.LEFT]}set fullWidth(t){this.width=t-(this._padding[bt.RIGHT]+this._padding[bt.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[bt.TOP]+this._padding[bt.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[bt.TOP]+this._padding[bt.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[bt.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[bt.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[bt.TOP]===t[bt.TOP]&&this._padding[bt.RIGHT]===t[bt.RIGHT]&&this._padding[bt.BOTTOM]===t[bt.BOTTOM]&&this._padding[bt.LEFT]===t[bt.LEFT]||(this._viewport[0]+=t[bt.LEFT]-this._padding[bt.LEFT],this._viewport[1]+=t[bt.BOTTOM]-this._padding[bt.BOTTOM],this._viewport[2]-=t[bt.RIGHT]+t[bt.LEFT]-(this._padding[bt.RIGHT]+this._padding[bt.LEFT]),this._viewport[3]-=t[bt.TOP]+t[bt.BOTTOM]-(this._padding[bt.TOP]+this._padding[bt.BOTTOM]),fa(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(ur(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,i=this.height,r=this.near*Math.tan(this.fovY/2),s=r*this.aspect;Zae(this._projectionMatrix,-s*(1+2*this._padding[bt.LEFT]/t),s*(1+2*this._padding[bt.RIGHT]/t),-r*(1+2*this._padding[bt.BOTTOM]/i),r*(1+2*this._padding[bt.TOP]/i),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(t){Lr(this._projectionMatrix,t),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return TVe(this._fov,this.width,this.height)}set fovX(t){this._fov=wVe(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return SVe(this._fov,this.width,this.height)}set fovY(t){this._fov=xVe(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return xi(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(hr(this._viewInverseTransposeMatrix,this.viewMatrix),Ea(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const i=2*t-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){ne(this._ray.origin,t.eye),ne(this._center,t.center),ne(this._up,t.up),fa(this._viewport,t.viewport),fa(this._padding,t.padding),Fs(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const i=t;return this._viewDirty=i._viewDirty,this._viewDirty||(Lr(this._viewMatrix,t.viewMatrix),ne(this._viewRight,t.viewRight),ne(this._viewUp,t.viewUp),ne(this._viewForward,t.viewForward)),i._projectionDirty?this._projectionDirty=!0:(Lr(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=i._frustumDirty,this._frustumDirty||($D(this._frustum,t.frustum),this._frustumDirty=!1),i._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Lr(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),fa(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new wi().copyFrom(this)}equals(t){return sl(this.eye,t.eye)&&sl(this._center,t.center)&&sl(this._up,t.up)&&t1(this._viewport,t.viewport)&&t1(this._padding,t.padding)&&lfe(this._nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this.pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return!1;const i=5e-4,r=1-1e-10;lp(Xn,t.eye,t.center),lp(J5,this.eye,this._center);const s=_e(Xn,J5),n=dz(Xn),o=dz(J5);return s*s>=r*n*o&&Y9(t.eye,this.eye)<Math.max(n,o)*i*i&&b$(t.padding,this._padding)<.5&&b$(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(mA(this.viewForward,de(Xn,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,i){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(t=Cr()){return t[0]=(this.padding[bt.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[bt.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,i=.5,r=.5){return t[0]=this.padding[bt.LEFT]+this.width*i,t[1]=this.padding[bt.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const i=this.viewport,r=this.padding;t.setViewport(i[0]-r[3],i[1]-r[2],i[2]+r[1]+r[3],i[3]+r[0]+r[2])}applyProjection(t,i,r=!1){t!==ei&&ne(ei,t),ei[3]=1,r&&(i[2]=-ei[2]),bu(ei,ei,this.projectionMatrix),ae(ei,ei,1/Math.abs(ei[3]));const s=this.fullViewport;return i[0]=qt(0,s[0]+s[2],.5+.5*ei[0]),i[1]=qt(0,s[1]+s[3],.5+.5*ei[1]),r||(i[2]=.5*(ei[2]+1)),i}projectToScreen(t,i){this.projectToRenderScreen(t,K5),this.renderToScreen(K5,i)}projectToRenderScreen(t,i){if(ei[0]=t[0],ei[1]=t[1],ei[2]=t[2],ei[3]=1,bu(ei,ei,this.viewProjectionMatrix),ei[3]===0)return null;ae(ei,ei,1/Math.abs(ei[3]));const r=this.fullViewport;return"x"in i?(i.x=qt(0,r[0]+r[2],.5+.5*ei[0]),i.y=qt(0,r[1]+r[3],.5+.5*ei[1])):(i[0]=qt(0,r[0]+r[2],.5+.5*ei[0]),i[1]=qt(0,r[1]+r[3],.5+.5*ei[1]),i.length>2&&(i[2]=.5*(ei[2]+1))),i}unprojectFromScreen(t,i){return this.unprojectFromRenderScreen(this.screenToRender(t,K5),i)}unprojectFromRenderScreen(t,i){if(ur(MM,this.projectionMatrix,this.viewMatrix),!hr(MM,MM))return null;const r=this.fullViewport;return ei[0]=2*(t[0]-r[0])/r[2]-1,ei[1]=2*(t[1]-r[1])/r[3]-1,ei[2]=2*t[2]-1,ei[3]=1,bu(ei,ei,MM),ei[3]===0?null:(i[0]=ei[0]/ei[3],i[1]=ei[1]/ei[3],i[2]=ei[2]/ei[3],i)}constrainWindowSize(t,i,r,s=r){const n=t*this.pixelRatio,o=i*this.pixelRatio,a=Math.max(n-r/2,0),l=Math.max(this.fullHeight-o-s/2,0),c=-Math.min(n-r/2,0),h=-Math.min(this.fullHeight-o-s/2,0);return[a,l,r-c- -Math.min(this.fullWidth-n-r/2,0),s-h- -Math.min(o-s/2,0)]}computeUp(t){t===$e.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,i){const r=t[0]*this.pixelRatio,s=this.fullHeight-t[1]*this.pixelRatio;return i[0]=r,i[1]=s,i}renderToScreen(t,i){const r=t[0]/this.pixelRatio,s=(this.fullHeight-t[1])/this.pixelRatio;i[0]=r,i[1]=s}_computeUpGlobal(){de(Xn,this.center,this.eye);const t=Pe(this.center);t<1?(oe(this._up,0,0,1),this._markViewDirty()):Math.abs(_e(Xn,this.center))>.9999*Pe(Xn)*t||(dt(this._up,Xn,this.center),dt(this._up,this._up,Xn),be(this._up,this._up),this._markViewDirty())}_computeUpLocal(){Am(Xn,this.eye,this.center),Math.abs(Xn[2])<=.9999&&(ae(Xn,Xn,Xn[2]),oe(this._up,-Xn[0],-Xn[1],1-Xn[2]),be(this._up,this._up),this._markViewDirty())}_compareAndSetView(t,i){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?sl(t,i)||(ne(i,t),this._markViewDirty()):B9e.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(wme(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(rN(this._viewMatrix,this.eye,this._center,this._up),oe(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),oe(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),oe(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const ei=ni(),MM=Te(),Xn=M(),J5=M(),K5=Nn();var bt;(function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"})(bt||(bt={}));const DD={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};class gH{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:DD.desiredScreenFlow},this.source=t(),this.target=t()}clone(){const t=new gH(this.createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,i,r){this.source!==t&&this.source.copyFrom(t),this.target!==i&&this.target.copyFrom(i),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:DD.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const i=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class V9e{constructor(){this.segments=[]}get time(){return this.segments.reduce((t,i)=>t+i.time,0)}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1),t*=this.time;let r=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(t<=a.time||o===this.segments.length-1){i=this.segmentInterpolateComponentsAt(a,t/a.time,i),n.hasPan?i.pan=(r+l.compared.pan*i.pan)/n.compared.pan:i.pan=1,n.hasRotate?i.rotate=(s+l.compared.rotate*i.rotate)/n.compared.rotate:i.rotate=1;const c=i.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return n.hasZoom?i.zoom=(c-h)/(p-h):i.zoom=1,i}t-=a.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(t,i,r){return t.interpolateComponentsAt(i,r)}}class eU{constructor(t){t&&this.update(t)}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,i=t.compared,r=i.sourceZoom,s=i.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(r);const n=(t.source.pixelsPerRotateAtZoom(r)+t.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=i.rotate*n}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;r&&(s&&(o=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(r&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:r?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(t){if(t===0||t===1)return t;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(i*(i/r)**-t-i)/(r-i)}return t}_interpolateComponentsPan(t){if(t===0||t===1)return t;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1);const r=this._interpolateComponentsZoom(t),s=this._interpolateComponentsPan(t),n=this._interpolateComponentsRotate(t);return i?(i.zoom=r,i.pan=s,i.rotate=n):i={zoom:r,pan:s,rotate:n},i}}function G9e(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function j9e(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*o*l*c-e.halfWindowSize*s*n*o*l+e.halfWindowSize*s*n*o*c/(a*a)}function H9e(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,o=Math.log(e.compared.sourceZoom*n),a=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function q9e(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function W9e(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function X9e(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Y9e(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function Z9e(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function Q9e(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function J9e(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function K9e(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*a+e.halfWindowSize*r*s*n*l/(o*o)+e.halfWindowSize*s*n*a*l/t}function eGe(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function tGe(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function iGe(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function rGe(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function sGe(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}function nGe(e,t){let i=oGe(e,t);const r={ascensionFactor:t.ascensionFactor!=null?t.ascensionFactor:.5,descensionFactor:t.descensionFactor!=null?t.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,o=s?q9e:G9e,a=s?W9e:j9e,l=s?X9e:H9e,c=n?tGe:J9e,h=n?iGe:K9e,p=n?rGe:eGe,f=A=>o(e,A,r)+Y9e(e,A,r)+c(e,A,r),g=A=>a(e,A,r)+Z9e(e,A,r)+h(e,A,r),y=A=>l(e,A,r)+Q9e(e,A,r)+p(e,A,r);let v=f(i);const b=sGe(e);let w;const S=t.maximumIterations||20,T=t.maximumDistance!=null?t.maximumDistance:1/0;for(w=0;w<S;w++){const C=(g(i)+1e-6)/y(i);if(isNaN(C)||i>=T&&C<0){if(!isFinite(T))return null;i=T,v=f(i);break}if(i-=C,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const R=f(i);if(Math.abs(R-v)/v<=.005)break;v=R}return v>b*(1-.3)||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}function oGe(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?t.maximumDistance!=null?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}class aGe extends V9e{constructor(t,i){super(),this._preallocSegments=[new eU,new eU,new eU],this.update(t,i)}update(t,i){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let r=null;i&&i.apex&&(r=nGe(t,i.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,i.apex)}segmentInterpolateComponentsAt(t,i,r){return r=t.interpolateComponentsAt(i,r),t===this._ascensionSegment?r.zoom=lH(r.zoom):t===this._descensionSegment&&(r.zoom=QN(r.zoom)),r}_updateWithApex(t,i){const[r,s,n]=this._preallocSegments,o=i.ascensionFactor!=null?i.ascensionFactor:.5,a=Math.min(1-o,i.ascensionFactor!=null?i.descensionFactor:.5),l=1-o-a;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=t,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=t,s.definition.compared.targetZoom=t,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=t,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const lGe={zoom:0,pan:0,rotate:0};class cGe{constructor(t){this.createCamera=t,this._time=0,this.definition=new gH(t),this.path=new aGe}get time(){return this._time}update(t,i,r){this.definition.update(t,i,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(Cse(this.path.time),r),this._easing=r.easing?r.easing:this._time>=1e3?_me:YR}cameraAt(t,i){i=i||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const r=this.path.interpolateComponentsAt(t,lGe);return i.interpolate(this.definition.source,this.definition.target,r),i}_normalizedEasing(t){const i=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(t,this._time)-i)/(r-i)}_applyTimeSettings(t,i){const r=i.speedFactor!=null?i.speedFactor:1;i.duration!=null?t=i.duration:i.speedFactor!=null&&(t=t/r);const s=i.minDuration!=null?i.minDuration:DD.minDuration/r,n=i.maxDuration!=null?i.maxDuration:DD.maxDuration/r;return Math.min(Math.max(s,t),n)}}const uGe=M();class hGe{constructor(t){this.currentTime=0,this._animation=new cGe(()=>new mK(t)),this._current=new mK(t)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(t,i,r){const s=this._animation.definition.source,n=this._animation.definition.target,o=de(uGe,i.center,t.center),a=Pe(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),ne(s.lookAtDirection,o),ne(n.lookAtDirection,o),s.copyFromRenderCamera(t),n.copyFromRenderCamera(i),this._current.copyFrom(s),this._animation.update(s,n,r),this.currentTime=0,t.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(t,i){return this._animation.cameraAt(t,this._current),i=i||new wi,this._current.copyToRenderCamera(i),i}step(t,i){return this.finished||(this.currentTime=this.currentTime+Cse(t),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}}var ar;(function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"})(ar||(ar={}));let $_=class extends we{constructor(){super(...arguments),this.state=ar.Ready}get active(){return this.state===ar.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ar.Stopped,!0)}finishController(){this.state=ar.Finished}get steppingFinished(){return!1}};u([d({readOnly:!0})],$_.prototype,"active",null),u([d()],$_.prototype,"state",void 0),$_=u([P("esri.views.3d.state.controllers.CameraController")],$_);let jC=class extends $_{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(pi()),this._asyncResult=null),this.state===ar.Finished||this.state===ar.Stopped?this.state===ar.Finished?e.resolve():e.reject(pi()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ar.Running,_(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!_(this.viewAnimation)||this.state!==ar.Ready&&this.state!==ar.Running||(this.viewAnimation.state===ST.State.FINISHED?this.finish():this.viewAnimation.state===ST.State.STOPPED&&(this.state=ar.Stopped))}onControllerEnd(){_(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===ar.Finished?this.viewAnimation.finish():this.state===ar.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ar.Finished?this._asyncResult.resolve():this._asyncResult.reject(pi()))}finish(){this.finishController()}};jC=u([P("esri.views.3d.state.controllers.AnimationController")],jC);let Zf=class extends jC{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new hGe(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new ST}get isInteractive(){return this.mode==="interaction"}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);PM.copyFrom(this.view.state.camera);const r=Ou(this.view.state.viewingMode);this.intersectionHelper.intersectRay(PM.ray,r,gK)&&(PM.center=gK),this.animation.update(PM,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return me(I({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{easing:typeof e.easing=="string"?A9e[e.easing]:e.easing})}};u([d({constructOnly:!0})],Zf.prototype,"view",void 0),u([d({constructOnly:!0})],Zf.prototype,"mode",void 0),Zf=u([P("esri.views.3d.state.controllers.PointToPointAnimationController")],Zf);const PM=new wi,gK=M();function Ame(e,t,i){return dGe(e,e.screenToRender(t,Le.get()),i)}function dGe(e,t,i){const r=Fs(Le.get(),t);if(r[2]=0,!e.unprojectFromRenderScreen(r,i.origin))return null;const s=Fs(Le.get(),t);s[2]=1;const n=e.unprojectFromRenderScreen(s,Le.get());return O(n)?null:(de(i.direction,n,i.origin),i)}function xS(e,t,i){return yH(e,e.screenToRender(t,Le.get()),i)}function yH(e,t,i){ne(i.origin,e.eye);const r=oe(Le.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,Le.get());return O(s)?null:(de(i.direction,s,i.origin),i)}function vH(e,t,i,r){const s=xS(t,i,pGe);return E0(e,s,r)}const pGe=Fn(),Cme=30,LD=[1,3e8],Rme=70;function Z_(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function $8(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function g0(e,t,i){const r=yl(OR.get(),i[3],i);de(_i,e.eye,t),Ue(_i,_i,r),e.eye=pe(_i,_i,t),de(_i,e.center,t),Ue(_i,_i,r),e.center=pe(_i,_i,t),e.up=Ue(_i,e.up,r)}function fGe(e,t,i,r){return X1(e,Ame(t,i,wH),r)}function D8(e,t,i,r){return X1(e,xS(t,i,wH),r)}function _H(e,t,i,r){const s=Le.get();let n=1-i;de(s,t,e.eye);const o=Pe(s);let a=o*(1-n);n>=0&&a<r&&(a=r,n=-(a-o)/o),Math.abs(o-a)<1e-6||(ae(s,s,n),e.eye=pe(_i,e.eye,s),e.center=Ss(_i,e.center,t,n))}function Ome(e,t,i){t.getScreenCenter(yK),vH(e,t,yK,_i)&&(t.center=_i);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=ae(Le.get(),t.viewForward,s);t.eye=de(_i,t.center,n)}const yK=Cr();function tU(e,t){oe(t,0,0,0);for(const i of e)pe(t,t,i);ae(t,t,1/e.length)}function EI(e,t,i,r){return Math.sin(e/Pe(t))*(i+r.radius)}function vK(e,t,i,r){return EI(Math.PI/2,t,i,r)+(e-Math.PI/2)}var pn;(function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"})(pn||(pn={}));const _K={Elevation:3e4,Angle:Ct(6)},RA={Pole:.95,Angle:Ct(18),Tilt:45},Mme=Ct(80);function Pme(e,t,i,r,s){const n=M(),o=vn();let a=!0,l=!0;return e.intersectScreen(i,n)?o[3]=Pe(n):(l=!1,t.aboveGround?o[3]=Math.max(Pe(t.center),.9*s.radius):o[3]=Pe(t.eye)-t.relativeElevation,r?HC(o,t,i,n):a=vH(o,t,i,n)),{sphere:o,scenePickPoint:a?n:null,hasGeometryIntersection:l}}function JN(e,t,i,r){return Pe(e.eye)-r.radius>_K.Elevation?pn.Horizontal:i?(xS(e,t,CK),-Math.sign(e.relativeElevation)*(.5*Math.PI+h7(e.eye,CK.direction))<_K.Angle?pn.Vertical:pn.Horizontal):pn.Vertical}function Ime(e,t,i){de(iU,i,t),e.eye=de(_i,e.eye,iU),e.center=de(_i,e.center,iU)}const iU=M();function HC(e,t,i,r){const s=xS(t,i,wH);return!O(s)&&(cS(e,s,IM),E0(e,s,r)?!(ko(IM,s.origin)<ko(r,s.origin))||(ne(r,IM),!1):(de(_b,t.eye,t.center),be(_b,_b),Hle(_b,-_e(be(_b,_b),IM),bK),X1(bK,s,r),!1))}const IM=M(),_b=M(),bK=ii();function $me(e,t,i,r,s,n){let o;if(dt(UD,e,t),de(NM,e,t),Pe(e)<=s||!r.aboveGround){dt(i,NM,r.eye);const a=_e(e,t)/(Pe(e)*Pe(t)),l=Math.cos(ze(t0.normalize(Ct(n)),0,Mme));o=-Es(a)-Math.max(0,Pe(t)-s)/(l*s)}else de(wK,r.eye,r.center),dt(i,NM,wK),o=-Pe(NM)/s;return be(i,i),ae(i,i,Pe(UD)),o}const wK=M();function xK(e,t,i,r){let s,n;const o=Math.cos(ze(t0.normalize(Ct(r)),0,Mme));return s=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):Es(t/i),n=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):Es(e/i),(n-s)*i}function mGe(e,t,i,r,s,n,o,a,l,c){const h=xK(e[2],t[2],o[3],l),p=c?xK(e[0],t[0],o[3],180):t[0]-e[0],f=Math.sin(a)*p-Math.cos(a)*h,g=Math.cos(a)*p+Math.sin(a)*h;be(_i,s);const y=c?f/Math.sqrt(Math.abs(o[3]**2-_e(i,_i)**2)):f/o[3],v=g/Math.sqrt(Math.abs(o[3]**2-_e(i,r)**2));tr(n,y,v)}function Dme(e,t,i,r,s,n,o,a,l,c){dt(UD,e,t),cB(n.up,n.eye,$M,DM,LM),cB([0,0,1],n.eye,im,Yy,Ume),ne(i,Yy),ne(r,im),be(i,i),ae(i,i,Pe(UD)),GX(e,be(DM,DM),be(LM,LM),be($M,$M),TK),GX(t,DM,LM,$M,SK),mGe(TK,SK,e,im,Yy,s,o,a,l,c)}function gGe(e,t,i,r,s,n,o){yl(ND,s,r),yl(FD,o,n),ur(cx,ND,FD),de(t,e,i),Ue(t,t,cx),pe(t,t,i)}function Lme(e,t,i,r,s,n){yl(ND,r,i),yl(FD,n,s),ur(cx,ND,FD),de(_i,e.eye,t),Ue(_i,_i,cx),e.eye=pe(_i,_i,t),de(_i,e.center,t),Ue(_i,_i,cx),e.center=pe(_i,_i,t),de(_i,e.up,t),Ue(_i,_i,cx),e.up=pe(_i,_i,t)}function bH(e,t,i,r,s,n,o=RA.Pole,a=RA.Angle){const l=Math.abs(r)>Math.PI-a||Math.abs(r)<a,c=Math.abs(e[2])<i*o||Math.abs(t)>i;return!!(l&&c&&n.aboveGround&&s<RA.Tilt)}function Nme(e,t,i,r,s,n){if(n)CC(i,r,EK),g0(t,e,EK);else{const o=$me(i,r,AK,t,e[3],s);g0(t,e,AC(AK,o))}}function Fme(e,t,i,r,s,n,o){const a=o?20:1,l=1e-12;let c,h;ne(G0,r),FM.copyFrom(t);for(let p=0;p<a&&ko(i,G0)>l&&(c=ko(i,G0),Dme(i,G0,Yy,im,t2,FM,e,s,n,o),Lme(FM,e,im,t2[1],Yy,t2[0]),gGe(G0,G0,e,im,t2[1],Yy,t2[0]),h=ko(i,G0),h<c||p===0);p++)t.copyFrom(FM)}function yGe(e,t,i,r,s,n,o){bH(i,_e(t.up,i),e[3],-t0.normalize(Ct(s)),n,t,RA.Pole,RA.Angle)?Fme(e,t,i,r,-t0.normalize(Ct(s)),n,o):Nme(e,t,i,r,n,o)}function vGe(e,t,i,r,s,n){const{eye:o}=e;cB([0,0,1],o,im,Yy,Ume);const a=t.translation[0]*i.pan,l=s.mode==="zoom"?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-_e(e.center,im)**2/Pe(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(nl(r.pan.matrix,r.pan.matrix,h,im),r.pan.enabled=!0,s.mode){case"pan":nl(r.pan.matrix,r.pan.matrix,p,Yy),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function _Ge(e,t,i,r,s){const{eye:n,viewRight:o}=e,a=dt(Le.get(),o,n),l=t.translation[0]*i.pan;switch(l!==0&&(nl(r.pan.matrix,r.pan.matrix,-l,a),r.pan.enabled=!0),s.mode){case"pan":{const c=t.translation[1]*i.pan;c!==0&&(nl(r.pan.matrix,r.pan.matrix,c,o),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function bGe(e,t,i,r,s,n,o,a,l){bH(e.center,_e(e.up,e.center),Pe(e.center),-t0.normalize(Ct(n)),o,t)?vGe(t,i,r,a,l,-t0.normalize(Ct(s))):_Ge(t,i,r,a,l)}const im=M(),Yy=M(),Ume=M(),$M=M(),DM=M(),LM=M(),TK=M(),SK=M(),t2=Xe(),EK=bS(),ND=Te(),FD=Te(),cx=Te(),G0=M(),_i=M(),NM=M(),FM=new wi,UD=M(),AK=M(),wH={origin:M(),direction:M()},CK={origin:M(),direction:M()},RK=.6,rU=4,wGe=12,xGe=60,TGe=20;let kD=class extends Zf{constructor(){super(...arguments),this.zoomLocation=M(),this.tmpCamera=new wi,this.tmpViewDir=M(),this.tmpRayDir={origin:M(),direction:M()},this.targetOnSphere=M(),this.tmpCenter=M(),this.constraintOptions={selection:Xi.ALL_EXCEPT_COLLISION,interactionType:Ot.ZOOM,interactionFactor:null,interactionStartCamera:new wi,interactionDirection:null,tiltMode:Zs.TUMBLE},this.sphere=vn()}initialize(){this.intersector=Ou(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,n=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(s=e>0,n=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ne(this.zoomLocation,this.tmpCamera.center),this._updateCamera(this.tmpCamera,e,this.zoomLocation,t,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:YR}}_updateCamera(e,t,i,r,s){const n=di(this.view.spatialReference);if(JN(e,r,s,n)===pn.Horizontal){let o=RK**t;this.sphere[3]=Pe(i),de(this.tmpViewDir,e.center,e.eye);const a=Pe(this.tmpViewDir);let l=a*o;if(o<=1&&l<rU&&(l=rU,o=l/a),Math.abs(a-l)<1e-6)return;const c=Pe(e.center);if(this.sphere[3]!==c){const h=this.sphere[3]+o*(c-this.sphere[3]);e.center=ae(UM,e.center,h/c)}ae(this.tmpViewDir,this.tmpViewDir,-o),e.eye=pe(UM,e.center,this.tmpViewDir),Dr(this.view,e,this.constraintOptions),ko(i,e.center)>1e-12&&vH(this.sphere,e,r,this.targetOnSphere)&&yGe(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let o=RK**Math.abs(t);const a=t>0?1:-1;let l;xS(e,r,this.tmpRayDir),be(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(l=Math.abs(this.view.camera.position.z));let c=Math.max(wGe*l,TGe);const h=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,xGe);c=c>h?h:c,ae(this.tmpRayDir.direction,this.tmpRayDir.direction,c),pe(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let p=c*o;const f=Math.max(rU,1.01*e.nearFar[0]);if(t>0&&p<f&&(p=f,o=p/c),Math.abs(c-p)<1e-6)return;ae(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-o)),e.eye=pe(UM,e.eye,this.tmpRayDir.direction),e.center=pe(UM,e.center,this.tmpRayDir.direction)}wS(this.view,e)}};kD=u([P("esri.views.3d.state.controllers.global.ZoomStepController")],kD);const UM=M(),SGe=.6,EGe=4,AGe=60,CGe=14,RGe=20;let zD=class extends Zf{constructor(){super(...arguments),this.zoomLocation=M(),this.tmpCamera=new wi,this.tmpRayDir=M(),this.tmpCenter=M(),this.constraintOptions={selection:Xi.ALL,interactionType:Ot.ZOOM,interactionFactor:null,interactionStartCamera:new wi,interactionDirection:null,tiltMode:Zs.TUMBLE}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=Ou(this.view.state.viewingMode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ne(this.zoomLocation,this.tmpCamera.center);const n=SGe**e;let o=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],this.view.state.camera,AGe);const a=Math.max(CGe*Math.abs(this.view.camera.position.z),RGe);if(o=o?Math.min(o,a):a,o){const l=M();de(l,this.zoomLocation,this.tmpCamera.eye),o<Pe(l)&&(be(l,l),pe(this.zoomLocation,this.tmpCamera.eye,ae(l,l,o)))}this._updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:YR}}_updateCamera(e,t,i){de(this.tmpRayDir,i,e.eye);const r=Pe(this.tmpRayDir);let s=r*t;const n=t<=1,o=Math.max(EGe,1.01*e.nearFar[0]);n&&s<o&&(s=o,t=s/r),Math.abs(r-s)<1e-6||(ae(this.tmpRayDir,this.tmpRayDir,t),e.eye=de(OK,i,this.tmpRayDir),e.center=Ss(OK,e.center,i,1-t),Dr(this.view,e,this.constraintOptions))}};zD=u([P("esri.views.3d.state.controllers.local.ZoomStepController")],zD);const OK=M();function OGe(e,t){switch(t){case"primary":return e.pointerType==="touch"||e.button===0;case"secondary":return e.pointerType!=="touch"&&e.button===2;case"tertiary":return e.pointerType!=="touch"&&e.button===1}}function xH(e,t){if(e.pointerType==="touch")return!1;switch(t){case"primary":return e.button===0;case"secondary":return e.button===2;case"tertiary":return e.button===1}}class MGe extends jn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r))}_handleDoubleClick(t){const i=t.data;if(OGe(i,"primary")){const r=this.view.state.isGlobal?new kD({view:this.view,mode:"animation"}):new zD({view:this.view,mode:"animation"});this.view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),Cr(i.x,i.y)),t.stopPropagation()}}}let y0=class extends $_{constructor(){super(...arguments),this.startCamera=new wi,this.currentCamera=new wi}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ar.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};y0=u([P("esri.views.3d.state.controllers.InteractiveController")],y0);var Xa;(function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"})(Xa||(Xa={}));const PGe=7,sU=90;let ux=class extends y0{constructor(e){super(e),this.view=null,this.pivot=Xa.CENTER,this.lastPoint=Xe(),this.tmpWorldUp=M(),this.tmpViewDir=M(),this.tmpRotCurPoint=Xe(),this.tmpTransf=Te(),this.tmpAxis=M(),this.tmpPivotPoint=M(),this.pivotPos=M(),this.constraintOptions={selection:Xi.ALL,interactionType:Ot.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Zs.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=this.pivot===Xa.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Xa.EYE:ne(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=Ot.LOOK_AROUND,this.constraintOptions.tiltMode=Zs.LOOK_AROUND,this.constraintOptions.selection=Xi.NONE;break;case Xa.CENTER:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||ne(this.pivotPos,this.startCamera.center),this._constrainPivotPoint(e),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=Ot.TUMBLE,this.constraintOptions.tiltMode=Zs.TUMBLE,this.constraintOptions.selection=Xi.ALL&~Xi.DISTANCE}this.constraintOptions.interactionStartCamera=this.startCamera,Z_(this.startCamera,e,this.lastPoint)}}_constrainPivotPoint(e){const t=this.startCamera,i=M();de(i,this.pivotPos,t.eye);let r=Pe(i);this.view.camera.position.hasZ&&(r=Math.min(r,PGe*Math.abs(this.view.camera.position.z)));const s=di(this.view.spatialReference),n=Cr(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),o=JN(this.startCamera,n,!0,s);let a=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,2.5*sU,sU),l=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e[0],e[1],t,sU);a===void 0&&l===void 0||(a=a===void 0?l:a,l=l===void 0||o===pn.Horizontal?a:l,r=a>l?l:a),be(i,i),ne(this.pivotPos,pe(this.tmpPivotPoint,t.eye,ae(this.tmpPivotPoint,i,r)))}update(e){if(this.active){switch(this.pivot){case Xa.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case Xa.CENTER:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}Dr(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),Z_(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;de(this.tmpViewDir,i,r);const o=Pe(this.tmpViewDir),a=Es(_e(this.tmpViewDir,this.tmpWorldUp)/o);if(this.pivot===Xa.EYE){s*=-.5;const l=.5*Math.PI-a,c=.5*Math.PI*.99;s=l-Math.max(-c,Math.min(c,l+s))}return s=ze(s+a,$n.min,$n.max)-a,dt(this.tmpAxis,e.up,this.tmpViewDir),this.pivot===Xa.CENTER&&(n=-n),yl(this.tmpTransf,n,this.tmpWorldUp),nl(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),Ue(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=Ue(nU,e.up,this.tmpTransf),pe(nU,r,this.tmpViewDir),Fs(this.lastPoint,this.tmpRotCurPoint),nU}};u([d({constructOnly:!0})],ux.prototype,"view",void 0),u([d()],ux.prototype,"pivot",void 0),ux=u([P("esri.views.3d.state.controllers.RotateController")],ux);const nU=M();class oU extends jn{constructor(t,i,r,s){super(!0),this.view=t,this.pointerAction=i,this.pivot=r,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!xH(t.data,this.pointerAction))return;const r=Cr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new ux({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}let AI=class extends y0{constructor(e){super(e),this.view=null,this.pickPoint=M(),this.tmpP0=Xe(),this.panAxisAngle=bS(),this.tmpRayDir=M(),this.targetOnSphere=M(),this.tmpRay={origin:M(),direction:M()},this.dragBeginPoint=Cr(),this.normalizedAnchorPoint=Xe(),this.constraintOptions={selection:Xi.ALL_EXCEPT_COLLISION,interactionType:Ot.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Zs.TUMBLE},this.sphere=vn(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Fs(this.dragBeginPoint,e),Z_(this.startCamera,e,this.normalizedAnchorPoint);const t=di(this.view.spatialReference),i=Pme(this.intersectionHelper,this.startCamera,e,!1,t);if(this.navMode=JN(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===pn.Horizontal)this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let r;xS(this.startCamera,e,this.tmpRay),be(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=ze(Cme*r,LD[0],LD[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Rme);s=s>n?n:s,this.hasPickPoint=!0,ae(this.tmpRay.direction,this.tmpRay.direction,s),pe(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===pn.Horizontal){de(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Pe(this.tmpRayDir);Z_(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this.sphere[3]/Pe(this.currentCamera.center));this.currentCamera.center=ae(kM,this.currentCamera.center,n)}ae(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=pe(kM,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=wh(this.dragBeginPoint,e),Dr(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(HC(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),CC(this.pickPoint,this.targetOnSphere,this.panAxisAngle),g0(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=Pe(this.tmpRay.direction);Z_(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;ae(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=pe(kM,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=pe(kM,this.currentCamera.center,this.tmpRayDir)}wS(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],AI.prototype,"view",void 0),AI=u([P("esri.views.3d.state.controllers.global.ZoomController")],AI);const kM=M();let CI=class extends y0{constructor(e){super(e),this.view=null,this.tmpP=M(),this.tmpDir=M(),this.tmpN=M(),this.tmpP0=Xe(),this.tmpPoi=M(),this.tmpRayDir=M(),this.dragBeginPoint=Cr(),this.normalizedAnchorPoint=Xe(),this.constraintOptions={selection:Xi.ALL,interactionType:Ot.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:M(),tiltMode:Zs.TUMBLE},this.plane=ii()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;Fs(this.dragBeginPoint,e),Z_(this.startCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),de(this.tmpDir,this.tmpP,this.startCamera.eye),be(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=ze(Cme*t,LD[0],LD[1]);const r=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e[0],e[1],this.view.state.camera,Rme);i=i>r?r:i,ae(this.tmpDir,this.tmpDir,i),pe(this.tmpP,this.startCamera.eye,this.tmpDir),de(this.tmpN,this.startCamera.eye,this.startCamera.center),be(this.tmpN,this.tmpN),this.tmpN[1]<0&&lo(this.tmpN,this.tmpN),mT(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;fGe(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||ne(this.tmpPoi,this.currentCamera.center),Z_(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);Fs(this.normalizedAnchorPoint,this.tmpP0),de(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Pe(this.tmpRayDir);let r=i*(1-t);ne(this.constraintOptions.interactionDirection,this.tmpRayDir),ae(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(ae(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=pe(j0,this.currentCamera.eye,this.tmpRayDir),Ss(j0,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?j0[2]=Math.max(this.startCamera.center[2],j0[2]):j0[2]=Math.min(this.startCamera.center[2],j0[2]),this.currentCamera.center=j0,this.constraintOptions.interactionFactor=wh(this.dragBeginPoint,e),Dr(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],CI.prototype,"view",void 0),CI=u([P("esri.views.3d.state.controllers.local.ZoomController")],CI);const j0=M();class IGe extends jn{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!xH(t.data,this.pointerAction))return;const r=Cr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new AI({view:this.view}):this.cameraController=new CI({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}const $Ge=M(),zM=M();function TH(){return{direction:M(),up:M()}}function kme(e,t,i,r,s){let n=be($Ge,e),o=_e(n,r);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(_e(t,r)),o<.99?(ne(n,t),a&&ae(n,n,-1)):n=null);let l=0;if(n){ae(zM,r,_e(r,n)),de(n,n,zM);const h=_e(n,s)/(Pe(n)*Pe(s));dt(zM,n,s),l=(_e(zM,r)>0?1:-1)*pl(Es(h))}const c=pl(Es(-_e(r,e)/Pe(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const zme=je(0,1,0),Bme=je(0,0,1),i2=Te(),kp=M(),zp=M();function Vme(e,t,i,r=TH()){const{direction:s,up:n}=r;return Xae(i2,-Ct(t)),cT(i2,i2,Ct(i)),Ue(s,Bme,i2),ae(s,s,-1),Ue(n,zme,i2),r}function DGe(e,t,i,r){return kme(t,i,r,Bme,zme)}function LGe(e,t,i,r){const s=Vme(e,i,r),n=M();return ae(n,s.direction,-t),pe(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}}function NGe(e){return pl(e)}function FGe(e){return Ct(e)}function Gme(e,t,i,r,s){const n=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return Qs(t,kp,n),Qs(t,zp,n),kp[0]-=i/2,zp[0]+=i/2,kp[1]-=r/2,zp[1]+=r/2,yn(kp,n,kp,o),yn(zp,n,zp,o),s?(s.xmin=kp[0],s.ymin=kp[1],s.xmax=zp[0],s.ymax=zp[1],s.spatialReference=o):s=new Zt(kp[0],kp[1],zp[0],zp[1],o),s}const UGe=Object.freeze({__proto__:null,headingTiltToDirectionUp:Vme,directionToHeadingTilt:DGe,eyeForCenterWithHeadingTilt:LGe,lookAtTiltToEyeTilt:NGe,eyeTiltToLookAtTilt:FGe,toExtent:Gme}),jme=je(0,0,1),Hme=be(M(),je(1,1,1)),kGe=new e0(-180,180),r2=Te(),ly=M(),bb=M();function qme(e,t,i,r=TH()){dt(ly,e,jme),_e(ly,ly)===0&&dt(ly,e,Hme),yl(r2,-Ct(t),e),nl(r2,r2,-Ct(i),ly);const{up:s,direction:n}=r;return dt(s,ly,e),be(s,s),Ue(s,s,r2),be(n,e),lo(n,n),Ue(n,n,r2),r}function zGe(e,t,i,r){const s=ly,n=bb;return be(s,e),dt(bb,s,jme),_e(bb,bb)===0&&dt(bb,s,Hme),dt(n,bb,s),kme(t,i,r,s,n)}function BGe(e,t,i,r){const s={eye:M(),up:null,tilt:r,heading:i},n=ly;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const o=t,a=Ct(i),l=Ct(r),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),g=Pe(n);let y;if(Math.abs(l)<1e-8)y=o+g;else{const ie=g/p,$=Uh(o/ie),F=Math.PI-l-$;y=ie*Math.sin(F)}const v=f*o,b=o*o*(p*p),w=h*h*b,S=y-v,T=S*S,A=w*(w+T-n[1]*n[1]);if(A<0)return ae(s.eye,n,y/g),s.tilt=0,s;const C=Math.sqrt(A),R=n[1]*S,L=w+T;let U;if(U=h>0?-C+R:C+R,Math.abs(L)<1e-8)return g<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):ae(s.eye,n,y/g),s.tilt=0,aU(s.eye),lU(s,e);s.eye[1]=U/L;const N=c*c*b,z=p*o,V=h*z*s.eye[1],B=s.eye[1]*s.eye[1],J=1-B,Z=Math.sqrt(J),te=w*B+N-2*V*Z*S+J*T;return Math.abs(te)<1e-8?(ae(s.eye,n,y/g),s.tilt=0,aU(s.eye),lU(s,e)):(s.eye[0]=(J*(y*n[0]-v*n[0])-z*Z*(n[0]*s.eye[1]*h+n[2]*c))/te,s.eye[2]=(J*(y*n[2]-v*n[2])-z*Z*(n[2]*s.eye[1]*h-n[0]*c))/te,ae(s.eye,s.eye,y),aU(s.eye),lU(s,e))}function aU(e){const t=e[1];e[1]=-e[2],e[2]=t}function lU(e,t){const i=qme(t,e.heading,e.tilt);return e.up=i.up,e}function VGe(e,t,i){const r=Pe(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=Uh(i/(s/Math.sin(e)));return pl(e-n)}function GGe(e,t,i){const r=Ct(e),s=Pe(t);return Uh(i/(s/Math.sin(r)))+r}function Wme(e,t,i,r,s){let n,o,a,l;const c=t.latitude,h=di(e.spatialReference).radius,p=t.longitude,f=ZVe(c,i,h)/2;n=p-f,o=p+f;const g=Ct(c),y=(1+Math.sin(g))/(1-Math.sin(g)),v=(y+1)*Math.tan(r/h/2),b=v*v;function w(T){const A=Math.PI/2;return(T=Ixe.normalize(T,-A))>A&&(T=Math.PI-T),T}if(a=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+b))),l=a+r/h,a=w(a),l=w(l),l<a){const T=l;l=a,a=T}if(a=Math.max(pl(a),-90),l=Math.min(pl(l),90),o=kGe.monotonic(n,o),o-n>180){const T=(o-n-180)/2;n+=T,o-=T}const S=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:tt.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=S):s=new Zt(n,a,o,l,S),e.spatialReference&&e.spatialReference.isWebMercator&&Kf(s,!1,s),s}const jGe=Object.freeze({__proto__:null,headingTiltToDirectionUp:qme,directionToHeadingTilt:zGe,eyeForCenterWithHeadingTilt:BGe,lookAtTiltToEyeTilt:VGe,eyeTiltToLookAtTilt:GGe,toExtent:Wme});function BD(e,t){return e!=null&&(t==null||(t===$e.Local?!e.isGeographic||e.isWGS84||e.wkid===pu.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===pu.CGCS2000||e.wkid===pu.GCSMARS2000||e.wkid===pu.GCSMARS2000_SPHERE||e.wkid===pu.GCSMOON2000))}const Xme=he.getLogger("esri.views.3d.support.cameraUtils"),Yme=39.37,Zme=96,L8=1,HGe=8,qGe=5,Qme=1,MK=M(),BM=M(),WGe={heading:0,tilt:0},kf=new Ke,XGe=new e0(-20037508342788905e-9,20037508342788905e-9),YGe=new e0(-180,180);var kn;function ZR(e){return e.spatialReference||tt.WGS84}function TS(e){return e.viewingMode==="global"?jGe:UGe}function ZGe(e,t,i,r,s){return TS(e).headingTiltToDirectionUp(t,i,r,s)}function Df(e,t){if(O(t))return null;const i=e.renderSpatialReference,r=TS(e).headingTiltToDirectionUp,s=M();if(!Qs(t.position,s,i))return null;const n=r(s,t.heading,t.tilt);ae(n.direction,n.direction,e.state.camera.distance),pe(n.direction,n.direction,s);const o=ib(e,s,n.direction,n.up);return o.fov=Ct(t.fov),o}(function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"})(kn||(kn={}));const wb=M();function zT(e,t,i){const r=e.renderSpatialReference,s=KN(e,t.eye,t.viewForward,t.up,WGe);let n=ZR(e);return yn(t.eye,r,wb,n)||(n=tt.WGS84,yn(t.eye,r,wb,n)),O(i)?new ml(new Ke(wb,n),s.heading,s.tilt,pl(t.fov)):(i.position.x=wb[0],i.position.y=wb[1],i.position.z=wb[2],i.position.spatialReference=n,i.heading=s.heading,i.tilt=s.tilt,i.fov=pl(t.fov),i)}function SH(e,t,i){const r=e.state.camera,s=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===$e.Global&&i!=null&&(t*=Math.cos(Ct(i))),t/=e.renderCoordsHelper.unitInMeters,s/(Zme*Yme/t)/Math.tan(r.fovX/2)}function M1(e,t,i){const r=e.state.camera,s=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;let o=Zme*Yme/(n/s);return e.renderCoordsHelper.viewingMode===$e.Global&&(o/=Math.cos(Ct(i))),o*=e.renderCoordsHelper.unitInMeters,o}function Jme(e,t,i,r,s,n){return Kme(e,t,SH(e,i,t.latitude),r,s,n)}function Kme(e,t,i,r,s,n){if(Q_(n)){const a=new SS(n.signal);return qC(e,r.heading,r.tilt,t,i,s,a),void a.resolver.promise.then(l=>{const c=GD(e,l,r.fov);if(!O(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=qC(e,r.heading,r.tilt,t,i,s);return GD(e,o,r.fov,n)}function KN(e,t,i,r,s){return TS(e).directionToHeadingTilt(t,i,r,s)}function QGe(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,kf,e.spatialReference)&&gt(Mh(e.elevationProvider,kf),0)>kf.z-Qme)}async function JGe(e,t,i){if(!e.renderCoordsHelper.fromRenderCoords(t,kf,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(kf.x,kf.y,kf.z,kf.spatialReference,"ground",i);return gt(r,0)>kf.z-Qme}async function KGe(e,t,i){const r=M();if(t)if(t instanceof Ke){if(Qs(t,r,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const s=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return _(s)&&e.renderCoordsHelper.setAltitude(r,s),r}}else ne(r,t);else ne(r,e.state.camera.center);return r}function e7e(e,t){const i=M();if(t&&t instanceof Ke){if(Qs(t,i,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const r=Mh(e.elevationProvider,t);_(r)&&e.renderCoordsHelper.setAltitude(i,r)}}else ne(i,t||e.state.camera.center);return i}function qC(e,t,i,r,s,n,o){const a=r&&r instanceof Ke?r:null;if(Q_(o))return KGe(e,r,o.signal).then(c=>{N8(e,t,i,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=e7e(e,r);return N8(e,t,i,a,l,s,n,o)}function N8(e,t,i,r,s,n,o,a){if(O(r)){const p=e.renderSpatialReference;if(r=n0(s,p,ZR(e)),O(r))return null}n=Math.max(n,e.state.constraints.minimumPoiDistance);const l=r7e(e,t,i,s,n,o),c=(0,TS(e).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===kn.ADJUST&&e.viewingMode==="global"&&i>0){const p=()=>{const g=ege(e,s,n,n7e(e,n,i,s));return o=i-g<1?kn.LOCKED:kn.ADJUST,N8(e,t,g,r,s,n,o,a)},f=e.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(QGe(e,c.eye))return p();if(Q_(a))return JGe(e,c.eye,a.signal).then(g=>g?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:Ts(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||Q_(a)?{center:M(),eye:M(),up:M(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=Ts(s),h.heading=c.heading,h.tilt=c.tilt,Q_(a)&&a.resolver.resolve(h),h}function OA(e,t,i,r,s,n=null){const o=t.zmax!=null&&t.zmin!=null;let a,l,c;if(e.state.isGlobal){if(!BD(t.spatialReference,$e.Global))return Q_(n)&&n.resolver.reject(),null;const w=new Ke(t.xmin,t.ymin,t.spatialReference),S=new Ke(t.xmax,t.ymax,t.spatialReference),T=t.spatialReference.isGeographic?YGe:XGe;a=new Ke({x:T.center(w.x,S.x),y:(S.y+w.y)/2,z:o?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const A=di(t.spatialReference),C=YVe(a,w,S);l=C.lon,c=C.lat,T.diff(w.x,S.x)>T.range/2&&(l+=A.halfCircumference),l=Math.min(l,A.halfCircumference),c=Math.min(c,A.halfCircumference)}else{const w=gt(e.renderSpatialReference,t.spatialReference);w.equals(t.spatialReference)||(t=RR(t,w)),l=t.xmax-t.xmin,c=t.ymax-t.ymin;const S=o?(t.zmax+t.zmin)/2:null;a=new Ke({x:t.xmin+.5*l,y:t.ymin+.5*c,z:S,spatialReference:w})}const h=o?t.zmax-t.zmin:0,p=e.state.camera,f=1/Math.tan(p.fovX/2),g=1/Math.tan(p.fovY/2),y=1/Math.tan(p.fov/2),v=Math.max(.5*l*f,.5*c*g,.5*h*y)/L8;if(Q_(n)){const w=new SS(n.signal);return qC(e,i,r,a,v,s,w),void w.resolver.promise.then(S=>{const T=GD(e,S,e.camera.fov);if(!O(T))return n.resolver.resolve(T);n.resolver.reject()},S=>n.resolver.reject(S))}const b=qC(e,i,r,a,v,s);return GD(e,b,e.camera.fov,n)}function t7e(e,t,i){const r=e.renderSpatialReference,s=n0(i,r,ZR(e));if(O(s))return null;const n=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),a=X9(t.eye,i),l=2*a*n*L8,c=2*a*o*L8;return e.viewingMode==="global"?Wme(e,s,l,c):Gme(e,s,l,c)}function i7e(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>HGe)return!0;const s=e.renderSpatialReference,n=ZR(e),o=n0(t,s,n),a=n0(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(O(o)||O(a))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return a.distance(o)/l>qGe}function r7e(e,t,i,r,s,n){let o=0;return n===kn.ADJUST&&i7e(e,r,s)?(t=0,o=s7e(e,s,i,r)):o=EH(e,r,s,i),o=e.state.constraints.clampTilt(s,o),{heading:t,tilt:i=ege(e,r,s,o)}}const VD=.7;function s7e(e,t,i,r){const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const n=s.min*(1-VD)+s.max*VD,o=EH(e,r,t,i);return Math.min(o,n)}function n7e(e,t,i,r){const s=e.state.constraints.tilt(t);let n=EH(e,r,t,i);return n=Math.min(n,.5*Math.PI),s.min*(1-VD)+n*VD}function ege(e,t,i,r){return TS(e).lookAtTiltToEyeTilt(r,t,i)}function EH(e,t,i,r){return TS(e).eyeTiltToLookAtTilt(r,t,i)}function GD(e,t,i,r){if(O(t))return null;const s=e.renderSpatialReference,n=n0(t.eye,s,ZR(e));return O(n)?null:_(r)?(r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new ml(n,t.heading,t.tilt,i)}function tge(e,t){var i;const r=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.levelAtScale(t);Xme.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function ige(e,t){var i;const r=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(t);Xme.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function o7e(e,t){return e.spatialReference?uce(t,e.spatialReference):void 0}function rge(e,t,i){const r=e.renderSpatialReference;let s,n;t||(t=e.state.camera);const o=tt.WGS84;return t instanceof ml?(s=t.position.latitude,Qs(t.position,MK,r),Qs(i,BM,r),n=xi(MK,BM)):(yn(t.center,r,BM,o),s=BM[1],n=t.distance),M1(e,n,s)}class SS{constructor(t){this.signal=t,this.resolver=um()}}function Q_(e){return e&&"resolver"in e}function zu(e){let t=e*e;return e<0&&(t*=-1),t}function PK(e,t,i){const r=i,s=e.state,n=e.device,o=t.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(r.translation[0]=zu(s.axes[0]),r.translation[1]=zu(s.axes[1]),r.translation[2]=zu(s.buttons[7])-zu(s.buttons[6]),r.heading=zu(s.axes[2]),r.tilt=zu(s.axes[3])):n.deviceType==="spacemouse"&&(r.translation[0]=1.2*zu(s.axes[0]),r.translation[1]=1.2*zu(s.axes[1]),r.translation[2]=2*-zu(s.axes[2]),r.heading=1.2*zu(s.axes[5]),r.tilt=1.2*zu(s.axes[3])),r.tilt*=o,ae(r.translation,r.translation,a),r}function IK(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function cU(e){return e.translation[0]===0&&e.translation[1]===0&&e.translation[2]===0&&e.heading===0&&e.tilt===0&&e.zoom===0}let yy=class extends y0{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new wi,this.constraintOptions={selection:Xi.ALL,interactionType:Ot.NONE,interactionStartCamera:new wi,interactionFactor:0,interactionDirection:null,tiltMode:Zs.LOOK_AROUND}}handleEventGamepad(e){const t=PK(e,this.view.navigation.gamepad,this.transformation);(e.action==="end"||cU(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,IK(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=IK(this.keysButtonState,this.transformation);cU(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,H0),this._applyDisabledMovementTypes(H0),this._applyPan(H0.pan),this._applyRotate(H0.rotate),this._applyZoom(H0.zoom),this._applyAscend(H0.ascend),this.constraintOptions.interactionType=Ot.NONE,this.constraintOptions.selection=Xi.COLLISION,Dr(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}_updateStartHeading(){this.transformation.heading!==0&&(this.headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;de(jo,t.center,t.eye),Ue(jo,jo,e.matrix),t.center=pe(jo,jo,t.eye),t.up=Ue(jo,t.up,e.matrix),this.constraintOptions.interactionType=Ot.LOOK_AROUND,this.constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,Dr(this.view,t,this.constraintOptions)}_applyPan(e,t=this.currentCamera){!e.enabled||(t.eye=Ue(jo,t.eye,e.matrix),t.center=Ue(jo,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Ue(jo,t.up,e.matrix)),this.constraintOptions.interactionType=Ot.PAN,this.constraintOptions.selection=Xi.ALL,Dr(this.view,t,this.constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=pe(jo,this.currentCamera.eye,ae(Le.get(),t,e)),ne(s2,t),lo(s2,s2),this.constraintOptions.interactionDirection=s2,this.constraintOptions.interactionType=Ot.ZOOM,this.constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,Dr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Le.get());if(this.constraintOptions.interactionDirection=ne(s2,t),this.view.state.isGlobal){const i=Pe(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=ae(jo,this.currentCamera.eye,r),this.currentCamera.center=ae(jo,this.currentCamera.center,r)}else{const i=ae(Le.get(),t,e);this.currentCamera.eye=pe(jo,this.currentCamera.eye,i),this.currentCamera.center=pe(jo,this.currentCamera.center,i)}this._updateCameraCenter(),this.constraintOptions.interactionType=Ot.ASCEND,this.constraintOptions.selection=Xi.COLLISION,Dr(this.view,this.currentCamera,this.constraintOptions)&&this._updateCameraCenter(),this.constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,Dr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){p7e(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,jo)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=oe(Le.get(),s[0],s[1],0);be(a,a);const l=n.translation[0]*e.pan;if(l!==0){const y=ae(Le.get(),r,l);Vo(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}switch(o.mode){case"pan":{const y=-n.translation[1]*e.pan;if(y!==0){const v=ae(Le.get(),a,y);Vo(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:o.mode}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(nl(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Le.get())),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=f0(this.view.renderCoordsHelper,t.center,t.eye),g=ze(f+p,$n.min,$n.max)-f;g&&(nl(i.rotate.matrix,i.rotate.matrix,g,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=dt(Le.get(),s,r);be(a,a),lo(a,a),bGe(this.startCamera,t,n,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this._applyPan(H0.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(nl(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=this._clampTiltDeltaGlobalToValidRange(p,t.ray,l);f!==0&&(nl(i.rotate.matrix,i.rotate.matrix,f,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=di(this.view.spatialReference),s=EI($n.min,t.origin,i,r);let n=0,o=0;const a=Le.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,a)){const l=f0(this.view.renderCoordsHelper,a,t.origin);n=EI(l,t.origin,i,r),o=EI($n.max,t.origin,i,r)}else{cS(i+r.radius,t,a);const l=Es(-_e(t.direction,be(a,a)));n=vK(l,t.origin,i,r),o=vK($n.max,t.origin,i,r)}return ze(n+e,s,o)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=ZGe(this.view,t,0,sge,d7e),n=i.intersectManifoldClosestSilhouette(fc(t,s),e,Le.get()),o=xi(t,n),a=i.intersectManifoldClosestSilhouette(fc(t,Am(Le.get(),t,r.center)),e,Le.get()),l=xi(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,Le.get());if(s){const o=de(Le.get(),e,n),a=Pe(o);ae(o,o,1/a);const l=be(Le.get(),e),c=Es(_e(l,o));return a*Math.sin(Math.min(l7e,c))}{const o=ne(Le.get(),e);return t.setAltitude(o,this.filteredSurfaceElevation),xi(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:c7e}_computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+di(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=Le.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),a=this._clampedDistanceToSurface(t,n),l=r.width/2,c=$K*r.width,h=$K*r.width,p=a*Math.tan(.5*r.fovX)/l,f=p/i,g=p/this._computeHeadingRotateRadius(n),y=o-t;return{pan:(s?f:p)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*y-y),zoom:2**(c*e/l)*a-a,rotate:ze(g*h,u7e,h7e)*e}}_applyDisabledMovementTypes(e){!_(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&pp(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&pp(e.rotate.matrix))}static activatesFor(e,t){const i=PK(t,e.navigation.gamepad,a7e);return!(t.action==="end"||cU(i))}};u([d({constructOnly:!0})],yy.prototype,"view",void 0),u([d({constructOnly:!0})],yy.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],yy.prototype,"disableMovements",void 0),yy=u([P("esri.views.3d.state.controllers.GamepadKeyboardController")],yy);const a7e={translation:[0,0,0],heading:0,tilt:0,zoom:0},sge=80,l7e=Ct(sge),$K=.75,c7e=5,u7e=Ct(30),h7e=Ct(80),H0={zoom:0,ascend:0,pan:{enabled:!1,matrix:Te()},rotate:{enabled:!1,matrix:Te()}},jo=M(),s2=M(),d7e=TH();function p7e(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,pp(e.pan.matrix),e.rotate.enabled=!1,pp(e.rotate.matrix)}class f7e extends jn{constructor(t){super(!0),this.view=t,this.watchHandles=new Bt,this.handle=this.registerIncoming("gamepad",i=>this._handleEventGamepad(i)),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([Wt(this.view.navigation.gamepad,"enabled",i=>{i?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))}),this.view.navigation.gamepad.watch("device",i=>{this.cameraControllerGamepad&&i&&this.cameraControllerGamepad.gamepadDevice!==i&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)})])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(t){const i=this.view.navigation.gamepad.device;if(i&&t.data.device!==i)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||yy.activatesFor(this.view,t.data)){if(!r){const s=new yy({view:this.view,gamepadDevice:t.data.device});this.view.state.switchCameraController(s)&&(this.cameraControllerGamepad=s)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===t.data.device&&this.cameraControllerGamepad.handleEventGamepad(t.data)}}}var Ga;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"})(Ga||(Ga={}));class m7e extends jn{constructor(t,i){super(!0),this.view=t,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:$e.Local},this.keyToNumber={[i.left]:Ga.LEFT,[i.right]:Ga.RIGHT,[i.forward]:Ga.FORWARD,[i.backward]:Ga.BACKWARD,[i.up]:Ga.UP,[i.down]:Ga.DOWN,[i.headingLeft]:Ga.HEADINGLEFT,[i.headingRight]:Ga.HEADINGRIGHT,[i.tiltUp]:Ga.TILTUP,[i.tiltDown]:Ga.TILTDOWN,[i.zoomIn]:Ga.ZOOMIN,[i.zoomOut]:Ga.ZOOMOUT},this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new yy({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(i),t.stopPropagation()))}_handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}_handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(i),t.stopPropagation())}}class g7e extends jn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("mouse-wheel",i,r=>this._handleMouseWheel(r))}_handleMouseWheel(t){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=t.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new kD({view:this.view,mode:"interaction"}):new zD({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,Cr(i.x,i.y)),t.preventDefault(),t.stopPropagation()}}class jD{constructor(t){this._gain=t}reset(t){this._value=t}set gain(t){this._gain=t}get value(){return this._value===void 0?0:this._value}update(t){this._value===void 0?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value}}let Zy=class extends jC{constructor(e){super(e),this.view=null,this.beginCamera=new wi,this.elapsedTimeSec=0,this.constraintOptions={selection:Xi.ALL,interactionType:Ot.PAN,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:Zs.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ST}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),Dr(this.view,t,this.constraintOptions)}};u([d({constructOnly:!0})],Zy.prototype,"view",void 0),Zy=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],Zy);let MA=class extends Zy{constructor(e){super(e),this.interactionType=Ot.PAN,this.tmpPan=M()}momentumStep(e,t){const i=this.momentum.value(e);ae(this.tmpPan,this.momentum.direction,i),t.eye=de(DK,t.eye,this.tmpPan),t.center=de(DK,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};u([d({constructOnly:!0})],MA.prototype,"momentum",void 0),MA=u([P("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],MA);const DK=M(),y7e=M(),VM=M();let RI=class extends Zy{constructor(e){super(e),this.interactionType=Ot.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);ne(VM,t.eye),be(VM,VM),dt(this.momentum.axis2,VM,this.momentum.axis1),Lme(t,y7e,this.momentum.axis1,i,this.momentum.axis2,r)}};u([d({constructOnly:!0})],RI.prototype,"momentum",void 0),RI=u([P("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],RI);let __=class extends Zy{constructor(e){super(e),this.interactionType=Ot.TUMBLE}set center(e){this._set("center",Ts(e))}set axis(e){this._set("axis",Ts(e))}momentumStep(e,t){const i=this.momentum.value(e);g0(t,this.center,AC(this.axis,i))}};u([d({constructOnly:!0})],__.prototype,"momentum",void 0),u([d({constructOnly:!0})],__.prototype,"center",null),u([d({constructOnly:!0})],__.prototype,"axis",null),__=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],__);let hx=class extends Zy{constructor(e){super(e),this.interactionType=Ot.ZOOM,this.constraintOptions.interactionDirection=M()}set zoomCenter(e){this._set("zoomCenter",Ts(e))}momentumStep(e,t){ne(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);_H(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=Am(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};u([d({constructOnly:!0})],hx.prototype,"momentum",void 0),u([d({constructOnly:!0})],hx.prototype,"zoomCenter",null),hx=u([P("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],hx);let Qv=class extends Zy{constructor(e){super(e),this.interactionType=Ot.ZOOM,this.radius=0,this.tmpSceneCenter=M(),this.tmpZoomAxisAngle=bS(),this.sphere=vn()}set screenCenter(e){this._set("screenCenter",Cr(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Ts(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Ome(this.sphere,t,i),this.constraintOptions.interactionType=Ot.ZOOM,Dr(this.view,t,this.constraintOptions),HC(this.sphere,t,this.screenCenter,this.tmpSceneCenter),CC(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),g0(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=Ot.PAN}};u([d({constructOnly:!0})],Qv.prototype,"momentum",void 0),u([d({constructOnly:!0})],Qv.prototype,"screenCenter",null),u([d({constructOnly:!0})],Qv.prototype,"sceneCenter",null),u([d({constructOnly:!0})],Qv.prototype,"radius",void 0),Qv=u([P("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Qv);class xh{constructor(t){this.gain=t}update(t){if(this.hasLastValue){const i=this.computeDelta(t);this._updateDelta(i)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(t){return t-this.lastValue}_updateDelta(t){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*t:this.filteredDelta=t}}class eF{constructor(t,i,r){this._initialVelocity=t,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,i){const r=this.value(t);return this.value(t+i)-r}valueFromInitialVelocity(t,i){i=Math.min(i,this.duration);const r=1-this.friction;return t*(r**i-1)/Math.log(r)}}class v7e extends eF{constructor(t,i,r,s,n){super(t,i,r),this.sceneVelocity=s,this.direction=n}value(t){return super.valueFromInitialVelocity(this.sceneVelocity,t)}}class nge{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.time=new xh(.6),this.screen=[new xh(.4),new xh(.4)],this.scene=[new xh(.6),new xh(.6),new xh(.6)],this.tmpDirection=M()}add(t,i,r){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(r)<.015)return;this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.scene[0].update(i[0]),this.scene[1].update(i[1]),this.scene[2].update(i[2]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){oe(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Pe(this.tmpDirection);s>0&&ae(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new v7e(t,i,r,n,this.tmpDirection)}}class LK{constructor(t){this.gain=t}update(t){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*t:this.filteredValue=t}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}}const NK=1e-5;class _7e extends eF{constructor(t,i,r,s,n,o=0,a){super(t,i,r),this.angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class b7e{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.tmpAxis1=M(),this.tmpAxis2=M(),this.tmpAngles=Xe(),this.time=new xh(.3),this.screen=[new xh(.4),new xh(.4)],this.angle1=new LK(.6),this.angle2=new LK(.6),this.axis1=M(),this.axis2=M(),this.lastScene=M()}addMomentumDirectRotation(t,i,r,s,n,o){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;let a=$me(this.lastScene,i,this.tmpAxis2,s,n,o);this.angle2.update(0),Fo(this.tmpAxis2)<NK?a=0:be(this.axis1,this.tmpAxis2),this.angle1.update(a),ne(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}addMomentumPreserveHeading(t,i,r,s,n,o,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;Dme(this.lastScene,i,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,s,n,o,a,!1),Fo(this.tmpAxis2)<NK?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),be(this.axis1,this.tmpAxis1),be(this.axis2,this.tmpAxis2)),ne(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){const s=this.angle1.filteredValue/this.time.filteredDelta,n=this.angle2.filteredValue/this.time.filteredDelta;return new _7e(t,i,r,s,this.axis1,n,this.axis2)}}class oge{constructor(t=2.5,i=.01,r=.95,s=12){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.maxVelocity=s,this.enabled=!0,this.value=new xh(.8),this.time=new xh(.3)}add(t,i){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;if(this.value.hasFilteredDelta){const r=this.value.computeDelta(t);this.value.filteredDelta*r<0&&this.value.reset()}}this.time.update(i),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=ze(t,-this.maxVelocity,this.maxVelocity),Math.abs(t)<this.minimumInitialVelocity?null:this.createMomentum(t,this.stopVelocity,this.friction)}createMomentum(t,i,r){return new eF(t,i,r)}}class age extends oge{constructor(t=3,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){if(this.value.hasLastValue){const r=this.value.lastValue;let s=t-r;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;t=r+s}super.add(t,i)}}class w7e extends eF{constructor(t,i,r){super(t,i,r)}value(t){const i=super.value(t);return Math.exp(i)}valueDelta(t,i){const r=super.value(t),s=super.value(t+i)-r;return Math.exp(s)}}class lge extends oge{constructor(t=2.5,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){super.add(Math.log(t),i)}createMomentum(t,i,r){return new w7e(t,i,r)}}let OI=class extends y0{constructor(e){super(e),this.view=null,this.smoothRotation=new jD(.05),this.rotationAxis=M(),this.panningPlane=ii(),this.smoothScaling=new jD(.05),this.zoomCenterScreen=Cr(),this.zoomMomentumEstimator=new lge,this.rotationMomentumEstimator=new age,this.panSphericalMomentumEstimator=new b7e,this.panPlanarMomentumEstimator=new nge,this.adjustedSphere=vn(),this.tmp3d=M(),this.tmpScreenPointArray=Cr(),this.beginScreenPoint=Cr(),this.beginScenePoint=M(),this.screenPickPoint=Cr(),this.navMode=pn.Horizontal,this.tmpInteractionDirection=M(),this.constraintOptions={selection:Xi.ALL,interactionType:Ot.NONE,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:Zs.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-t0.normalize(Ct(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),zf(e.center,this.screenPickPoint),Fs(this.beginScreenPoint,this.screenPickPoint);const i=di(this.view.spatialReference),r=Pme(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,ne(this.beginScenePoint,this.scenePickPoint),this.navMode=JN(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===pn.Vertical&&this._preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}_preparePlanarPanMode(e){const t=lo(this.tmp3d,this.startCamera.viewForward);mT(this.scenePickPoint,t,this.panningPlane);const i=Cr(this.screenPickPoint[0],0),r=M(),s=Pe(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],HC(this.adjustedSphere,this.startCamera,i,r);const n=Nn();this.startCamera.projectToRenderScreen(r,n);const o=.9*n[1];this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],o),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&mT(this.scenePickPoint,this.panningPlane,this.panningPlane);const a=M(),l=M(),c=M(),h=80,p=5,f=50;de(a,this.scenePickPoint,this.currentCamera.eye),be(a,a);const g=p*Math.max(Math.abs(this.view.camera.position.z),f),y=this.view._stage.renderView.getMinimalDepthForArea(null,this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,h),v=y?Math.min(y,g):g;ne(c,pe(l,this.currentCamera.eye,ae(l,a,v))),this.panningPlane[3]=-_e(this.panningPlane,c),this.startCamera.center=pe(l,this.startCamera.eye,ae(l,this.startCamera.viewForward,v));const b=zf(e.center,this.tmpScreenPointArray);D8(this.panningPlane,this.startCamera,b,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===pn.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===pn.Horizontal?new Qv({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new hx({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new __({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===pn.Horizontal){const r=this.panSphericalMomentumEstimator.evaluateMomentum();if(r)return new RI({view:this.view,momentum:r})}else{const r=this.panPlanarMomentumEstimator.evaluateMomentum();if(r)return new MA({view:this.view,momentum:r})}return null}_zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),Ome(this.sphere,this.currentCamera,this.smoothScaling.value),zf(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=Ot.ZOOM,this.constraintOptions.interactionFactor=wh(e.radius-this.beginRadius),Dr(this.view,this.currentCamera,this.constraintOptions)}_panningSpherical(e){const t=zf(e.center,this.tmpScreenPointArray);HC(this.sphere,this.currentCamera,t,this.tmp3d),bH(this.beginScenePoint,_e(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(Fme(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(Nme(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=Ot.PAN,this.constraintOptions.interactionFactor=wh(this.screenPickPoint,t),Dr(this.view,this.currentCamera,this.constraintOptions)}_rotateSpherical(e){be(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||lo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+$8(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),g0(this.currentCamera,this.sphere,AC(this.rotationAxis,s)),this.constraintOptions.interactionType=Ot.TUMBLE,this.constraintOptions.interactionFactor=wh(e.radius*i),Dr(this.view,this.currentCamera,this.constraintOptions)}_panningPlanar(e){const t=zf(e.center,this.tmpScreenPointArray);D8(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(Ime(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=Ot.PAN,this.constraintOptions.interactionFactor=wh(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),Dr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),_H(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=Ot.ZOOM,this.constraintOptions.interactionFactor=wh(e.radius-this.beginRadius),Dr(this.view,this.currentCamera,this.constraintOptions)}_rotatePlanar(e){ne(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||lo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=$8(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*e.timestamp),g0(this.currentCamera,this.sphere,AC(this.rotationAxis,n)),this.constraintOptions.interactionType=Ot.TUMBLE,this.constraintOptions.interactionFactor=wh(e.radius*n),Dr(this.view,this.currentCamera,this.constraintOptions)}};u([d({constructOnly:!0})],OI.prototype,"view",void 0),OI=u([P("esri.views.3d.state.controllers.global.PinchAndPanController")],OI);const FK=je(0,0,1),x7e={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},T7e=80;let MI=class extends y0{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new jD(.05),this.scalingValueSmooth=new jD(.05),this.planeHorizontal=ii(),this.planeVertical=ii(),this.rotationMomentumEstimator=new age,this.panMomentumEstimator=new nge(300,12,.9),this.zoomMomentumEstimator=new lge,this.beginCenter=M(),this.tmpPoints=[],this.beginCenterScreen=Cr(),this.tmpCentroid3d=M(),this.tmpCentroid2d=Cr(),this.tmp2d=Cr(),this.constraintOptions={selection:Xi.ALL,interactionType:Ot.NONE,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:Zs.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),zf(e.center,this.beginCenterScreen),Hle(FK,0,this.planeHorizontal);const i=M();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=M();lo(r,this.startCamera.viewForward);const s=M();ne(s,FK);const n=_e(r,s),o=Uh(n<0?-n:n);if(this.panMode=o>=x7e.ANGLE_THRESHOLD?pn.Horizontal:pn.Vertical,oB(this.planeHorizontal,this.planeHorizontal,i),this.startCamera.aboveGround||aB(this.planeHorizontal,this.planeHorizontal),this.panMode===pn.Vertical){ae(s,s,n),de(this.planeVertical,r,s),be(this.planeVertical,this.planeVertical),oB(this.planeVertical,this.planeVertical,i);const a=M(),l=M(),c=M();de(a,i,this.currentCamera.eye),be(a,a);const h=5*Math.max(Math.abs(this.view.camera.position.z),50),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,T7e),f=p?Math.min(p,h):h;ne(c,pe(l,this.currentCamera.eye,ae(l,a,f))),this.planeVertical[3]=-_e(this.planeVertical,c),this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),tU(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),tU(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===pn.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const s=this.beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=n,this.scalingValueSmooth.update(s),_H(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=Ot.ZOOM,this.constraintOptions.interactionFactor=wh(Math.abs(e.radius-this.beginRadius)),Dr(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),tU(this.tmpPoints,this.tmpCentroid3d),zf(e.center,this.tmpCentroid2d),Ime(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=Ot.PAN,this.constraintOptions.interactionFactor=wh(this.beginCenterScreen,this.tmpCentroid2d),Dr(this.view,this.currentCamera,this.constraintOptions),t){const s=this.planeHorizontal,n=r,o=this.rotationValueSmooth.value,a=o+$8(e.angle-o),l=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=l,this.rotationValueSmooth.update(a);const c=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(c,.001*e.timestamp),g0(this.currentCamera,n,AC(s,c)),this.constraintOptions.interactionType=Ot.TUMBLE,this.constraintOptions.interactionFactor=wh(Math.abs(e.radius*c)),Dr(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new hx({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new __({view:this.view,momentum:i,center:this.beginCenter,axis:this.planeHorizontal});const r=this.panMomentumEstimator.evaluateMomentum();return r?new MA({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let n=0;return e.forEach(o=>{s[0]=o.x,s[1]=o.y,r[n]===void 0&&(r[n]=M()),D8(t,i,s,r[n]),n+=1}),r}};u([d({constructOnly:!0})],MI.prototype,"view",void 0),MI=u([P("esri.views.3d.state.controllers.local.PinchAndPanController")],MI);class UK extends jn{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){if(t.data.pointerType==="mouse"&&!xH(t.data,this.pointerAction))return;const i=t.timestamp-this.lastEndTimestamp,r=40,s=this.momentum&&this.momentum.active&&i<r;switch(t.data.action){case"start":case"update":if(s)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this._startController(t);break;case"end":case"removed":this._endController(t,!0);break;case"added":this._endController(t,!1),this._startController(t)}t.stopPropagation()}_endController(t,i){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const r=this.controller.end(t.data);i&&r&&(this.momentum=r,this.view.state.switchCameraController(this.momentum))}this.controller=null}_startController(t){this.controller=this._createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp}_createController(){return this.view.state.isGlobal?new OI({view:this.view}):new MI({view:this.view})}}class S7e extends jn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}}class cge extends jn{constructor(t,i){super(!0),this.key=t,this.registerIncoming("key-down",i,r=>this._handleKeyDown(r))}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation())}}class E7e extends cge{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({heading:0}).catch(()=>{})}}class A7e extends cge{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({tilt:0}).catch(()=>{})}}class C7e extends jn{constructor(t,i=!1){super(!0),this.view=t,this.invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(t){var i,r,s;const n=this.invert?-1:1,o=Cr(0,t.data.delta*n);switch(t.data.action){case"begin":(i=this.cameraController)==null||i.end(),this.cameraController=new ux({view:this.view,pivot:Xa.CENTER}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(o);break;case"update":(r=this.cameraController)==null||r.update(o);break;case"end":(s=this.cameraController)==null||s.end(),this.cameraController=null}}}function kK(e){const t=e.native;return t?{buttons:t.buttons.map(i=>i.pressed?i.value?i.value:1:0),axes:t.axes.map(i=>M7e(i,e.axisThreshold))}:{buttons:[],axes:[]}}function R7e(e,t){if(e.axes.length!==t.axes.length||e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}function O7e(e){for(let t=0;t<e.axes.length;t++)if(e.axes[t]!==0)return!1;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]!==0)return!1;return!0}function M7e(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}class P7e{constructor(t,i){this.element=t,this.input=i,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this.inputDevices[a];l&&(this._emitGamepadEvent(o,kK(l),!1),this.inputDevices.splice(a,1),this.latestUpdate.splice(a,1),this.input.gamepad.devices.remove(l),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this.callback=t}_connectGamepad(t){const i=new Pj(t);i.deviceType!=="unknown"&&(this.inputDevices[t.index]=i,this.input.gamepad.devices.add(i)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this.frameTask==null&&(this.frameTask=e1({update:()=>this._readGamepadState()}))}_stopPolling(){this.frameTask!=null&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}_readGamepadState(){const t=document.hasFocus(),i=this.element.contains(document.activeElement),r=this.input.gamepad.enabledFocusMode==="document"&&!t||this.input.gamepad.enabledFocusMode==="view"&&!i;this._forEachGamepad(s=>{const n=this.inputDevices[s.index];if(!n)return;const o=this.latestUpdate[s.index],a=kK(n),l=r||O7e(a);o&&(o.timestamp===s.timestamp||!o.active&&l||R7e(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(t){const i=window.navigator.getGamepads();for(let r=0;r<i.length;r++){const s=i[r];this._validate(s)&&t(s)}}_emitGamepadEvent(t,i,r){const s=this.latestUpdate[t.index],n=s&&s.active;if(!n&&!r)return;const o=!n&&r?"start":n&&r?"update":"end";this.latestUpdate[t.index]={timestamp:t.timestamp,state:i,active:r},this.callback&&this.callback({device:this.inputDevices[t.index],state:i,action:o})}_validate(t){if(!t||!t.connected)return!1;for(let i=0;i<t.axes.length;i++)if(isNaN(t.axes[i]))return!1;return!0}}const zK=ue("trident"),BK=ue("edge"),I7e=ue("chrome"),$7e=ue("ff"),D7e=ue("safari"),xb={touchNone:"esri-view-surface--touch-none",touchPan:"esri-view-surface--touch-pan"};class tF{constructor(t,i){this.input=i,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new P7e(t,this.input),this._gamepadSource.onEvent=r=>this._callback("gamepad",r)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach(t=>{this._releasePointerCaptureSafe(t)}),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const i in this._active)if(!t||!t.has(i)){const r=this._active[i];this._element.removeEventListener(uU[i],r),delete this._active[i]}t&&t.forEach(i=>{if(!this._active[i]&&uU[i]){const r=(this._eventHandlers[i]||this._handleDefault).bind(this,i);this._element.addEventListener(uU[i],r),this._active[i]=r}}),this._gamepadSource.hasEventListeners=t&&t.has("gamepad")}setPointerCapture(t,i){i?(this._element.setPointerCapture(t.pointerId),this._activePointerCaptures.add(t.pointerId)):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?xb.touchNone:xb.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?xb.touchPan:xb.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(xb.touchNone),this._element.classList.remove(xb.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch{}}_updateNormalizedPointerLikeEvent(t,i){const r=Fpe(this._element,t);return tF.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),i.x=r.x,i.y=r.y,i}_handleKey(t,i){const r=JUe(i);r&&t==="key-up"&&this._keyDownState.delete(r);const s={native:i,key:r,repeat:r&&this._keyDownState.has(r)};r&&t==="key-down"&&this._keyDownState.add(s.key),this._callback(t,s)}_handlePointer(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});this._callback(t,r)}_handlePointerPreventDefault(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});i.preventDefault(),this._callback(t,r)}_handleMouseWheel(t,i){let r=i.deltaY;switch(i.deltaMode){case 0:(zK||BK)&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}zK||BK?r*=.7:I7e||D7e?r*=.6:$7e&&(r*=1.375);const s=100,n=Math.abs(r);n>s&&(r=r/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,deltaY:r});this._callback(t,o)}_handlePointerCaptureLost(t,i){this._activePointerCaptures.delete(i.pointerId),this._handleDefault(t,i)}_handleDefault(t,i){const r={native:i};i.preventDefault(),this._callback(t,r)}_preventAltKeyDefault(t){t.key==="Alt"&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}}tF.test={disableSubpixelCoordinates:!1};const uU={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class L7e extends jn{constructor(){super(!0),this.registerIncoming("context-menu",t=>{t.data.native.preventDefault()})}}function uge(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function N7e(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function F7e(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:zh()},e.length===0)return t;if(e.length===1)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(e.length===2){const[T,A]=e,[C,R]=[A.x-T.x,A.y-T.y];return t.radius=Math.sqrt(C*C+R*R)/2,t.center.x=(T.x+A.x)/2,t.center.y=(T.y+A.y)/2,t}let i=0,r=0;for(let T=0;T<e.length;T++)i+=e[T].x,r+=e[T].y;i/=e.length,r/=e.length;const s=e.map(T=>T.x-i),n=e.map(T=>T.y-r);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let T=0;T<s.length;T++){const A=s[T],C=n[T],R=A*A,L=C*C;o+=R,a+=L,l+=A*C,c+=R*A,h+=L*C,p+=A*L,f+=C*R}const g=.5*(c+p),y=.5*(h+f),v=o*a-l*l,b=(g*a-y*l)/v,w=(o*y-l*g)/v,S=zh(b+i,w+r);return{radius:Math.sqrt(b*b+w*w+(o+a)/e.length),center:S}}class U7e extends jn{constructor(t){super(!1),this.navigationTouch=t,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,i,r,s){return{action:t,pointerType:this.pointerType,button:this.mouseButton,buttons:i.buttons,timestamp:s,pointers:k7e(this.activePointerMap),pointer:i,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(t){const i=t.native.pointerId,r=GM(this.activePointerMap).angle,s={event:t,initialAngle:0,lastAngle:0};this.activePointerMap.set(i,s);const n=PI(s,hge(this.activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(r)}_updatePointer(t){if(t&&t.x==null&&t.y==null)return;const i=t.native.pointerId,r=this.activePointerMap.get(i);r?r.event=t:this._addPointer(t)}_removePointer(t){const i=GM(this.activePointerMap).angle;this.activePointerMap.delete(t),this._updatePointerAngles(i)}_updatePointerAngles(t){const i=GM(this.activePointerMap);this.activePointerMap.forEach(r=>{r.initialAngle=PI(r,i)-t,r.lastAngle=PI(r,i)-t})}_emitEvent(t,i,r){const s=GM(this.activePointerMap);this.drag.emit(this._createPayload(t,i,s,r),void 0,this.startStateModifiers)}_handlePointerUpAndPointerLost(t){const i=t.data.native.pointerId,r=t.timestamp;this.activePointerMap.get(i)&&(this.activePointerMap.size===1?(this._updatePointer(t.data),!this.isCurrentDragSuppressed&&this._emitEvent("end",t.data,r),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",t.data,t.timestamp)))}_handlePointerDrag(t){const i=t.data,r=i.currentEvent,s=t.timestamp;switch(i.action){case"start":case"update":this.isDragging?this.activePointerMap.has(r.native.pointerId)?(this._updatePointer(r),!this.isCurrentDragSuppressed&&this._emitEvent("update",r,s)):(this._addPointer(r),this._emitEvent("added",r,s),this.isCurrentDragSuppressed=this.isSuppressed):(this._updatePointer(r),this.pointerType=t.data.startEvent.pointerType,this.mouseButton=t.data.startEvent.button,this.startStateModifiers=t.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this._emitEvent("start",r,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&this.pointerType==="touch"&&this.activePointerMap.size===1}}function hge(e){const t=[];return e.forEach(i=>{t.push(zh(i.event.x,i.event.y))}),F7e(t)}function GM(e){const t=hge(e);let i=0;return e.forEach(r=>{let s=PI(r,t),n=s-r.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=r.lastAngle+n,r.lastAngle=s,i+=s-r.initialAngle}),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function k7e(e){const t=new Map;return e.forEach((i,r)=>t.set(r,i.event)),t}function PI(e,t){const i=e.event,r=i.x-t.center.x,s=i.y-t.center.y;return Math.atan2(s,r)}var VK;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"})(VK||(VK={}));const Fy={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class z7e extends jn{constructor(t=Fy.maximumDoubleClickDelay,i=Fy.maximumDoubleClickDistance,r=Fy.maximumDoubleTouchDelay,s=Fy.maximumDoubleTouchDistance,n=AL){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach(t=>t.doubleClickTimeout=Ys(t.doubleClickTimeout))}get hasPendingInputs(){return Vr(this._pointerState,t=>t.doubleClickTimeout!=null)}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_handleImmediateClick(t){const i=t.data,r=this._pointerId(i),s=this._pointerState.get(r);if(s){const n=i.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;uge(s.event.data,i)>n?(this._clearDoubleClickTimeout(r,!0),this._startClick(t)):(this._clearDoubleClickTimeout(r,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(t)}_startClick(t){const i=this._pointerId(t.data),r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(i,{event:t,doubleClickTimeout:this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(i),r)}),this.refreshHasPendingInputs()}_handlePointerDrag(t){const i=this._pointerId(t.data.currentEvent);this._clearDoubleClickTimeout(i,!0)}_handleDrag(t){const i=this._pointerId(t.data.pointer);this._clearDoubleClickTimeout(i,!0)}_clearDoubleClickTimeout(t,i){const r=this._pointerState.get(t);r&&(r.doubleClickTimeout.remove(),r.doubleClickTimeout=null,i&&this._doubleClickTimeoutExceeded(t),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){const i=this._pointerState.get(t);this._click.emit(i.event.data,void 0,i.event.modifiers),i.doubleClickTimeout=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}}class B7e extends jn{constructor(t=Fy.maximumDoubleClickDelay,i=Fy.maximumDoubleClickDistance,r=Fy.maximumDoubleTouchDelay,s=Fy.maximumDoubleTouchDistance,n=AL){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",o=>{this._handlePointerLoss(o,"pointer-up")}),this.registerIncoming("pointer-capture-lost",o=>{this._handlePointerLoss(o,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",o=>{this._handlePointerLoss(o,"pointer-cancel")})}onUninstall(){this._pointerState.forEach(t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=this._pointerId(i);if(!this._pointerState.has(r)){const s={downButton:i.native.button,immediateDoubleClick:null};this._pointerState.set(r,s),this.startCapturingPointer(i.native)}}_handlePointerLoss(t,i){const r=t.data,s=this._pointerId(r),n=this._pointerState.get(s);if(n&&i==="pointer-up"&&n.downButton===r.native.button){const o=n.immediateDoubleClick;if(o){o.timeoutHandle.remove();const a=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;uge(o,t.data)>a?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,o.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,i){const r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;i.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(t.data),r)}}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_removeState(t){const i=this._pointerId(t);this._pointerState.delete(i),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}}const n2={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};class V7e extends jn{constructor(t=n2.maximumClickDelay,i=n2.movementUntilMouseDrag,r=n2.movementUntilPenDrag,s=n2.movementUntilTouchDrag,n=n2.holdDelay,o=AL){super(!1),this.maximumClickDelay=t,this.movementUntilMouseDrag=i,this.movementUntilPenDrag=r,this.movementUntilTouchDrag=s,this.holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(t=>{t.holdTimeout!=null&&(t.holdTimeout.remove(),t.holdTimeout=null)}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=i.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(r);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,t.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this.holdDelay));const n={startEvent:i,previousEvent:i,startTimestamp:t.timestamp,isDragging:!1,downButton:i.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(r,n),this.startCapturingPointer(i.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_createPointerDragData(t,i,r){return{action:t,startEvent:i.startEvent,previousEvent:i.previousEvent,currentEvent:r}}_handlePointerMove(t){const i=t.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,i),void 0,s.modifiers):N7e(i,s.startEvent)>this._getDragThreshold(i.native.pointerType)&&this._startDragging(t),s.previousEvent=i)}_getDragThreshold(t){switch(t){case"touch":return this.movementUntilTouchDrag;case"pen":return this.movementUntilPenDrag;default:return this.movementUntilMouseDrag}}_startDragging(t){const i=t.data,r=i.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=t.modifiers,s.isDragging=!0,r===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,i)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),t.timestamp))})}_handlePointerLoss(t,i){const r=t.data,s=r.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,i==="pointer-up"?r:n.previousEvent),void 0,n.modifiers):i==="pointer-up"&&n.downButton===r.native.button&&t.timestamp-n.startTimestamp<=this.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(s),this.stopCapturingPointer(r.native),this._pointerState.size===0&&this._moveHandle.pause())}}class G7e{constructor(t){this.callbacks=t,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(t){const i=t.data,r=i.pointers.size;switch(i.action){case"start":this.currentCount=r,this._emitStart(t);break;case"added":this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this.startEvent&&this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"end":this._emitEnd(t),this.currentCount=0}this.previousEvent=t}_emitStart(t){this.startEvent=t,this.callbacks.condition(this.currentCount,t)&&this.callbacks.start(this.currentCount,t,this.startEvent)}_emitUpdate(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.update(this.currentCount,t,this.startEvent)}_emitEnd(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.end(this.currentCount,t,this.startEvent),this.startEvent=null}}class j7e extends jn{constructor(t=20,i=40){super(!1),this._threshold=t,this._maxDelta=i,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new G7e({start:(r,s)=>this._observeStart(r,s),update:(r,s,n)=>this._observeUpdate(r,s,n),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this.dragEventSeparator.handle(r))}get failed(){return this.state==="failed"}_observeStart(t,i){t===1&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this.state=t===2?"ready":"failed"}_observeUpdate(t,i,r){if(this.state!=="failed"&&t===2)return this.state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this._checkMovementWithinLimits(i.data,r.data)?this._checkVerticalThresholdReached(i.data,r.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this.state="failed")}_observeEnd(t){this.state==="active"&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation())}_checkMovementWithinLimits(t,i){let r=-1/0,s=1/0,n=-1/0,o=1/0;i.pointers.forEach(v=>{r=Math.max(r,v.x),s=Math.min(s,v.x),n=Math.max(n,v.y),o=Math.min(o,v.y)});let a=-1/0,l=1/0,c=-1/0,h=1/0;t.pointers.forEach(v=>{a=Math.max(a,v.x),l=Math.min(l,v.x),c=Math.max(c,v.y),h=Math.min(h,v.y)});const p=r-s,f=n-o,g=a-l,y=c-h;return Math.abs(t.center.x-i.center.x)<this._threshold&&Math.abs(g-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}_checkVerticalThresholdReached(t,i){let r=Math.abs(t.center.y-i.center.y);return t.pointers.forEach((s,n)=>{const o=i.pointers.get(n);r=Math.min(r,Math.abs(s.y-o.y))}),r>=this._threshold}}let bf=class extends we{constructor(){super(...arguments),this._handles=new Bt}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new tF(this.view.surface,e.input);const t=[new B7e,new V7e,new z7e,new U7e(this.view.navigation),new j7e],i=new Gv({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new L7e],qy.INTERNAL),this._modeDragPan=new UK(e,"primary"),this._modeDragRotate=new oU(e,"secondary",Xa.CENTER),this._modeDragZoom=new IGe(e,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new S7e(e),new MGe(e),new f7e(e),new m7e(e,r.pan),new g7e(e),new A7e(e,r.resetTilt),new E7e(e,r.resetHeading),new oU(e,"primary",Xa.EYE,[r.lookAround]),new oU(e,"secondary",Xa.CENTER,[r.lookAround]),new UK(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new C7e(e)],qy.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),Wt(this.view.navigation,"browserTouchPanEnabled",s=>{this._source.browserTouchPanningEnabled=!s})}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=F8.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],bf.prototype,"view",void 0),u([d({value:"pan"})],bf.prototype,"primaryDragAction",null),u([d({value:"default"})],bf.prototype,"mode",null),u([d({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],bf.prototype,"hasPendingInputs",void 0),u([d({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],bf.prototype,"latestPointerType",void 0),u([d()],bf.prototype,"_inputManager",void 0),bf=u([P("esri.views.3d.input.SceneInputManager")],bf);const F8=new Map,hU=new Map,dU=new Map;hU.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),hU.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),dU.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),dU.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),F8.set("default",hU),F8.set("pro",dU);const H7e=bf;let nr=class extends we{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};u([d()],nr.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],nr.prototype,"SCENEVIEW_LOCKING_LOG",void 0),u([d()],nr.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),u([d()],nr.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),u([d()],nr.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],nr.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],nr.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],nr.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],nr.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],nr.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],nr.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],nr.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],nr.prototype,"SHOW_POI",void 0),u([d()],nr.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],nr.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],nr.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],nr.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],nr.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],nr.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],nr.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],nr.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],nr.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],nr.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],nr.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],nr.prototype,"LINE_WIREFRAMES",void 0),nr=u([P("esri.views.3d.support.DebugFlags")],nr);const hi=new nr;let Vl,Ix,U8=!1,k8=!1,z8=!1,B8=!1,PA=null;function q7e(e,t){if(!k8||!Ix)return;dge();const i=Ix;let r=0;for(let s=0;s<e.accBinsNumX;s++)for(let n=0;n<e.accBinsNumY;n++){const o=e.accBins[s][e.accBinsNumY-1-n];r+=o.length;const a=s*e.accBinsSizeX,l=(s+1)*e.accBinsSizeX,c=n*e.accBinsSizeY,h=(n+1)*e.accBinsSizeY;i.fillText(o.length.toFixed(),a+5,c+15),pge(a,l,c,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}function W7e(e){z8=hi.DECONFLICTOR_SHOW_VISIBLE,B8=hi.DECONFLICTOR_SHOW_INVISIBLE,U8=z8||B8,k8=hi.DECONFLICTOR_SHOW_GRID,PA=null,U8||k8?PA=()=>X7e(e):Vl&&(Vl.parentElement.removeChild(Vl),Vl=null)}function dge(){PA&&(PA(),PA=null)}function X7e(e){Vl==null&&(Vl=document.createElement("canvas"),Vl.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Vl));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;Vl.setAttribute("width",`${t}px`),Vl.setAttribute("height",`${i}px`),Vl.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),Ix=Vl.getContext("2d"),Ix.clearRect(0,0,e.width,e.height),Ix.font="12px Arial"}function pge(e,t,i,r,s){dge();const n=Vl.height,o=Ix;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(e,n-i),o.lineTo(t,n-i),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.closePath()}function Y7e(e,t){U8&&(t&&z8||!t&&B8)&&pge(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var hn,Kl;(function(e){e[e.GRAPHIC=0]="GRAPHIC",e[e.LABEL=1]="LABEL",e[e._COUNT=2]="_COUNT"})(hn||(hn={})),function(e){e[e.USER_SETTING=0]="USER_SETTING",e[e.SCALE_RANGE=1]="SCALE_RANGE",e[e.FILTER=2]="FILTER",e[e.DECONFLICTION=3]="DECONFLICTION",e[e._COUNT=4]="_COUNT"}(Kl||(Kl={}));function fge(e,t){return new iF(e,vge,t)}function Z7e(e,t){const{curvatureDependent:i,scaleStart:r,scaleFallOffRange:s}=vge;return new iF(e,{curvatureDependent:{min:{curvature:i.min.curvature,tiltAngle:i.min.tiltAngle,scaleFallOffFactor:pU.curvatureDependent.min.scaleFallOffFactor},max:{curvature:i.max.curvature,tiltAngle:i.max.tiltAngle,scaleFallOffFactor:pU.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:pU.minPixelSize},t)}function Q7e(e){return Math.abs(e*e*e)}function mge(e,t,i){const r=i.parameters,s=i.paddingPixelsOverride;return o2.scale=Math.min(r.divisor/(t-r.offset),1),o2.factor=Q7e(e),o2.minPixelSize=r.minPixelSize,o2.paddingPixels=s,o2}function gge(e,t){return e===0?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function AH(e,t){return Math.max(qt(e*t.scale,e,t.factor),gge(e,t))}function J7e(e,t,i){const r=mge(e,t,i);return r.minPixelSize=0,r.paddingPixels=0,AH(1,r)}function GK(e,t,i,r){r.scale=J7e(e,t,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function yge(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,gge(e[1],t)/Math.max(1e-5,e[1])),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}function K7e(e,t,i,r){return AH(e,mge(t,i,r))}class iF{constructor(t,i,r,s=eje(),n){this.viewingMode=t,this.description=i,this.ellipsoidRadius=r,this.parameters=s,this._paddingPixelsOverride=n,this.viewingMode===$e.Local?(this.coverageCompensation=this._surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this._surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(t){return(!this.parameters||this.parameters.camera.fovY!==t.fovY||this.parameters.camera.distance!==t.distance)&&(this._calculateParameters(t,this.ellipsoidRadius,this.parameters),!0)}overridePadding(t){return t!==this.paddingPixelsOverride?new iF(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,t):this}_calculateParameters(t,i,r){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this.description,{fovY:a,distance:l}=t,c=this.calculateCurvatureDependentParameters(t,i),h=this.coverageCompensation(t,i,c),{tiltAngle:p,scaleFallOffFactor:f}=c,g=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),v=g/Math.cos(y),b=y+a*n*h,w=(v-f*(g/Math.cos(b)))/(1-f);return r.camera.fovY=t.fovY,r.camera.distance=t.distance,r.offset=w,r.divisor=v-w,r.minPixelSize=o,r}_calculateCurvatureDependentParametersLocal(t,i,r=jK){return r.tiltAngle=this.description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(t,i,r=jK){const s=this.description.curvatureDependent,n=1+t.distance/i,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=ze((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return r.tiltAngle=qt(h.tiltAngle,p.tiltAngle,c),r.scaleFallOffFactor=qt(h.scaleFallOffFactor,p.scaleFallOffFactor,c),r}_surfaceCoverageCompensationLocal(t,i,r){return(t.fovY-r.tiltAngle)/t.fovY}_surfaceCoverageCompensationGlobal(t,i,r){const s=i*i,n=r.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=t,l=a*a+s-2*Math.cos(n)*a*i,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(i/(c/Math.sin(n)))+.5*o)/o}}const vge={curvatureDependent:{min:{curvature:Ct(10),tiltAngle:Ct(12),scaleFallOffFactor:.5},max:{curvature:Ct(70),tiltAngle:Ct(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},pU={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function eje(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const o2={scale:0,factor:0,minPixelSize:0,paddingPixels:0},jK={tiltAngle:0,scaleFallOffFactor:0};function tje(e){return e instanceof Float32Array&&e.length>=16}function ije(e){return Array.isArray(e)&&e.length>=16}function rje(e){return tje(e)||ije(e)}var j;(function(e){e[e.Color=0]="Color",e[e.Depth=1]="Depth",e[e.Normal=2]="Normal",e[e.Shadow=3]="Shadow",e[e.Highlight=4]="Highlight",e[e.Draped=5]="Draped",e[e.Occlusion=6]="Occlusion",e[e.Alpha=7]="Alpha",e[e.COUNT=8]="COUNT"})(j||(j={}));var iu;(function(e){e[e.OCCLUDED=0]="OCCLUDED",e[e.NOTOCCLUDED=1]="NOTOCCLUDED",e[e.BOTH=2]="BOTH",e[e.COUNT=3]="COUNT"})(iu||(iu={}));const jM=os();function rF(e,t,i,r,s,n,o){if(!XR(t))if(e.boundingInfo){ot(e.primitiveType===wa.Triangle);const a=i.tolerance;_ge(e.boundingInfo,r,s,a,n,o)}else{const a=e.indices.get(E.POSITION),l=e.vertexAttributes.get(E.POSITION);QR(r,s,0,a.length/3,a,l,void 0,n,o)}}const sje=M();function _ge(e,t,i,r,s,n){if(O(e))return;const o=wge(t,i,sje);if(Ioe(jM,e.getBBMin()),$oe(jM,e.getBBMax()),_(s)&&s.applyToAabb(jM),CH(jM,t,o,r)){const{primitiveIndices:a,indices:l,position:c}=e,h=a?a.length:l.length/3;if(h>cje){const p=e.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&_ge(p[f],t,i,r,s,n);return}}QR(t,i,0,h,l,c,a,s,n)}}const bge=M();function QR(e,t,i,r,s,n,o,a,l){if(o)return nje(e,t,i,r,s,n,o,a,l);const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;for(let w=i,S=3*i;w<r;++w){let T=h*s[S++],A=c[T++],C=c[T++],R=c[T];T=h*s[S++];let L=c[T++],U=c[T++],N=c[T];T=h*s[S++];let z=c[T++],V=c[T++],B=c[T];_(a)&&([A,C,R]=a.applyToVertex(A,C,R,w),[L,U,N]=a.applyToVertex(L,U,N,w),[z,V,B]=a.applyToVertex(z,V,B,w));const J=L-A,Z=U-C,te=N-R,ie=z-A,$=V-C,F=B-R,k=v*F-$*b,G=b*ie-F*y,q=y*$-ie*v,K=J*k+Z*G+te*q;if(Math.abs(K)<=Number.EPSILON)continue;const H=p-A,ee=f-C,ge=g-R,Ae=H*k+ee*G+ge*q;if(K>0){if(Ae<0||Ae>K)continue}else if(Ae>0||Ae<K)continue;const Be=ee*te-Z*ge,Se=ge*J-te*H,xe=H*Z-J*ee,Re=y*Be+v*Se+b*xe;if(K>0){if(Re<0||Ae+Re>K)continue}else if(Re>0||Ae+Re<K)continue;const ke=(ie*Be+$*Se+F*xe)/K;ke>=0&&l(ke,JR(J,Z,te,ie,$,F,bge),w,!1)}}function nje(e,t,i,r,s,n,o,a,l){const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;for(let w=i;w<r;++w){const S=o[w];let T=3*S,A=h*s[T++],C=c[A++],R=c[A++],L=c[A];A=h*s[T++];let U=c[A++],N=c[A++],z=c[A];A=h*s[T];let V=c[A++],B=c[A++],J=c[A];_(a)&&([C,R,L]=a.applyToVertex(C,R,L,w),[U,N,z]=a.applyToVertex(U,N,z,w),[V,B,J]=a.applyToVertex(V,B,J,w));const Z=U-C,te=N-R,ie=z-L,$=V-C,F=B-R,k=J-L,G=v*k-F*b,q=b*$-k*y,K=y*F-$*v,H=Z*G+te*q+ie*K;if(Math.abs(H)<=Number.EPSILON)continue;const ee=p-C,ge=f-R,Ae=g-L,Be=ee*G+ge*q+Ae*K;if(H>0){if(Be<0||Be>H)continue}else if(Be>0||Be<H)continue;const Se=ge*ie-te*Ae,xe=Ae*Z-ie*ee,Re=ee*te-Z*ge,ke=y*Se+v*xe+b*Re;if(H>0){if(ke<0||Be+ke>H)continue}else if(ke>0||Be+ke<H)continue;const Gi=($*Se+F*xe+k*Re)/H;Gi>=0&&l(Gi,JR(Z,te,ie,$,F,k,bge),S,!1)}}const HK=M(),qK=M();function JR(e,t,i,r,s,n,o){return oe(HK,e,t,i),oe(qK,r,s,n),dt(o,HK,qK),be(o,o),o}function wge(e,t,i){return oe(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function CH(e,t,i,r){return RH(e,t,i,r,1/0)}function RH(e,t,i,r,s){const n=(e[0]-r-t[0])*i[0],o=(e[3]+r-t[0])*i[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(e[1]-r-t[1])*i[1],h=(e[4]+r-t[1])*i[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(e[2]-r-t[2])*i[2],f=(e[5]+r-t[2])*i[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function xge(e,t,i,r,s){let n=(i.screenLength||0)*e.pixelRatio;s&&(n=K7e(n,r,t,s));const o=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return ze(o*t,i.minWorldLength||0,i.maxWorldLength!=null?i.maxWorldLength:1/0)}function WC(e,t,i){if(!e)return;const r=e.parameters,s=e.paddingPixelsOverride;t.setUniform4f(i,r.divisor,r.offset,r.minPixelSize,s)}function Tge(e,t){const i=t?Tge(t):{};for(const r in e){let s=e[r];s&&s.forEach&&(s=lje(s)),s==null&&r in i||(i[r]=s)}return i}function oje(e,t){let i=!1;for(const r in t){const s=t[r];s!==void 0&&(i=!0,Array.isArray(s)?e[r]=s.slice():e[r]=s)}return i}function aje(e,t,i,r,s,n){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(E.POSITION).data,a=e.vertexAttributes.get(E.SIZE),l=a&&a.data[0],c=r[0],h=r[1],p=((l+s)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,A=o[y+4]-b,C=ze((T*w+A*S)/(T*T+A*A),0,1),R=T*C-w,L=A*C-S,U=R*R+L*L;U<f&&(f=U,g=y/3)}f<p*p&&n(i.dist,i.normal,g,!1)}function lje(e){const t=[];return e.forEach(i=>t.push(i)),t}const V8={multiply:1,ignore:2,replace:3,tint:4},cje=1e3;function OH(e){e.vertex.code.add(x`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),e.vertex.code.add(x`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(x`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),e.vertex.code.add(x`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),e.vertex.code.add(x`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(x`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),e.vertex.code.add(x`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function uje(e,t){if(t.screenSizePerspective){WC(t.screenSizePerspective,e,"screenSizePerspective");const i=t.screenSizePerspectiveAlignment||t.screenSizePerspective;WC(i,e,"screenSizePerspectiveAlignment")}}var al;function Sge(e,t){const i=e;i.include(OH),i.attributes.add(E.POSITION,"vec3"),i.attributes.add(E.NORMAL,"vec3"),i.attributes.add(E.AUXPOS1,"vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("cameraPosition","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("renderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(x`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(x`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||i.vertex.code.add(x`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(x`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||t.screenCenterOffsetUnitsEnabled===al.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?x`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled!==al.Screen?x`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled===al.Screen?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled===al.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(x`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function Ege(e,t){e.setUniform1f("renderTransparentlyOccludedHUD",t.renderTransparentlyOccludedHUD===iu.OCCLUDED?1:t.renderTransparentlyOccludedHUD===iu.NOTOCCLUDED?0:.75)}(function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"})(al||(al={}));class Nm{constructor(t){this._material=t.material,this._techniqueRep=t.techniqueRep,this._output=t.output}dispose(){this._techniqueRep.release(this._technique)}get technique(){return this._technique}ensureTechnique(t,i,r=this._output){return this._technique=this._techniqueRep.releaseAndAcquire(t,this._material.getTechniqueConfig(r,i),this._technique),this._technique}ensureResources(t){return ua.LOADED}}class MH extends Nm{constructor(t){super(t),this._numLoading=0,this._disposed=!1,this._textureRepository=t.textureRep,this._textureId=t.textureId,this._acquire(t.textureId,i=>this._texture=i),this._acquire(t.normalTextureId,i=>this._textureNormal=i),this._acquire(t.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(t.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(t.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){this._texture=Wi(this._texture),this._textureNormal=Wi(this._textureNormal),this._textureEmissive=Wi(this._textureEmissive),this._textureOcclusion=Wi(this._textureOcclusion),this._textureMetallicRoughness=Wi(this._textureMetallicRoughness),this._disposed=!0}ensureResources(t){return this._numLoading===0?ua.LOADED:ua.LOADING}updateTexture(t){(O(this._texture)||t!==this._texture.id)&&(this._texture=Wi(this._texture),this._textureId=t,this._acquire(this._textureId,i=>this._texture=i))}bindTextures(t){_(this._texture)&&t.bindTexture(this._texture.glTexture,"tex"),_(this._textureNormal)&&t.bindTexture(this._textureNormal.glTexture,"normalTexture"),_(this._textureEmissive)&&t.bindTexture(this._textureEmissive.glTexture,"texEmission"),_(this._textureOcclusion)&&t.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),_(this._textureMetallicRoughness)&&t.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(t){const i=_(this._texture)?this._texture.glTexture:null;_(i)&&i.descriptor.textureCoordinateScaleFactor?t.setUniform2fv("textureCoordinateScaleFactor",i.descriptor.textureCoordinateScaleFactor):t.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(t,i){if(O(t))return void i(null);const r=this._textureRepository.acquire(t);if(_c(r))return++this._numLoading,void r.then(s=>{if(this._disposed)return Wi(s),void i(null);i(s)}).finally(()=>--this._numLoading);i(r)}}class Zh extends WR{constructor(t,i){super(),this.type=Wh.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=mi,this._parameters=Tge(t,i),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(t){return!1}setParameters(t){oje(this._parameters,t)&&(this.validateParameters(this._parameters),this.parametersChanged())}validateParameters(t){}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this.parametersChanged())}shouldRender(t){return this.isVisible()&&this.isVisibleInPass(t.pass)&&(this.renderOccluded&t.renderOccludedMask)!=0}isVisibleInPass(t){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(t){t!==this._insertOrder&&(this._insertOrder=t,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){_(this.repository)&&this.repository.materialChanged(this)}}var Ar;(function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"})(Ar||(Ar={}));const Du={renderOccluded:Ar.Occlude};function hje(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l)n[r]=t[e[l]],r+=o;else for(let l=0;l<a;++l){const c=t[e[l]];for(let h=0;h<s;h++)n[r]=c,r+=o}}function dje(e,t,i,r){const s=i.typedBuffer,n=i.typedBufferStride,o=e.length;r*=n;for(let a=0;a<o;++a){const l=2*e[a];s[r]=t[l],s[r+1]=t[l+1],r+=n}}function Age(e,t,i,r,s){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}else for(let l=0;l<a;++l){const c=3*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}}function BT(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l){const c=4*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}else for(let l=0;l<a;++l){const c=4*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}}function KR(e,t,i,r,s,n=1){if(!i)return void Age(e,t,r,s,n);const o=r.typedBuffer,a=r.typedBufferStride,l=e.length,c=i[0],h=i[1],p=i[2],f=i[4],g=i[5],y=i[6],v=i[8],b=i[9],w=i[10],S=i[12],T=i[13],A=i[14];if(s*=a,n===1)for(let C=0;C<l;++C){const R=3*e[C],L=t[R],U=t[R+1],N=t[R+2];o[s]=c*L+f*U+v*N+S,o[s+1]=h*L+g*U+b*N+T,o[s+2]=p*L+y*U+w*N+A,s+=a}else for(let C=0;C<l;++C){const R=3*e[C],L=t[R],U=t[R+1],N=t[R+2],z=c*L+f*U+v*N+S,V=h*L+g*U+b*N+T,B=p*L+y*U+w*N+A;for(let J=0;J<n;++J)o[s]=z,o[s+1]=V,o[s+2]=B,s+=a}}function PH(e,t,i,r,s,n=1){if(!i)return void Age(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!JG(o),A=1e-6,C=1-A;if(s*=l,n===1)for(let R=0;R<c;++R){const L=3*e[R],U=t[L],N=t[L+1],z=t[L+2];let V=h*U+g*N+b*z,B=p*U+y*N+w*z,J=f*U+v*N+S*z;if(T){const Z=V*V+B*B+J*J;if(Z<C&&Z>A){const te=1/Math.sqrt(Z);V*=te,B*=te,J*=te}}a[s+0]=V,a[s+1]=B,a[s+2]=J,s+=l}else for(let R=0;R<c;++R){const L=3*e[R],U=t[L],N=t[L+1],z=t[L+2];let V=h*U+g*N+b*z,B=p*U+y*N+w*z,J=f*U+v*N+S*z;if(T){const Z=V*V+B*B+J*J;if(Z<C&&Z>A){const te=1/Math.sqrt(Z);V*=te,B*=te,J*=te}}for(let Z=0;Z<n;++Z)a[s+0]=V,a[s+1]=B,a[s+2]=J,s+=l}}function pje(e,t,i,r,s,n=1){if(!i)return void BT(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!JG(o),A=1e-6,C=1-A;if(s*=l,n===1)for(let R=0;R<c;++R){const L=4*e[R],U=t[L],N=t[L+1],z=t[L+2],V=t[L+3];let B=h*U+g*N+b*z,J=p*U+y*N+w*z,Z=f*U+v*N+S*z;if(T){const te=B*B+J*J+Z*Z;if(te<C&&te>A){const ie=1/Math.sqrt(te);B*=ie,J*=ie,Z*=ie}}a[s+0]=B,a[s+1]=J,a[s+2]=Z,a[s+3]=V,s+=l}else for(let R=0;R<c;++R){const L=4*e[R],U=t[L],N=t[L+1],z=t[L+2],V=t[L+3];let B=h*U+g*N+b*z,J=p*U+y*N+w*z,Z=f*U+v*N+S*z;if(T){const te=B*B+J*J+Z*Z;if(te<C&&te>A){const ie=1/Math.sqrt(te);B*=ie,J*=ie,Z*=ie}}for(let te=0;te<n;++te)a[s+0]=B,a[s+1]=J,a[s+2]=Z,a[s+3]=V,s+=l}}function HD(e,t,i,r,s,n=1){const o=r.typedBuffer,a=r.typedBufferStride,l=e.length;if(s*=a,n===1){if(i===4)for(let c=0;c<l;++c){const h=4*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}else if(i===4)for(let c=0;c<l;++c){const h=4*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}function sF(e,t,i,r,s,n){for(const o of t.fieldNames){const a=e.vertexAttributes.get(o),l=e.indices.get(o);if(a&&l)switch(o){case E.POSITION:{ot(a.size===3);const c=s.getField(o,Ti);c&&KR(l,a.data,i,c,n);break}case E.NORMAL:{ot(a.size===3);const c=s.getField(o,Ti);c&&PH(l,a.data,r,c,n);break}case E.UV0:{ot(a.size===2);const c=s.getField(o,Ru);c&&dje(l,a.data,c,n);break}case E.COLOR:{ot(a.size===3||a.size===4);const c=s.getField(o,Ca);c&&HD(l,a.data,a.size,c,n);break}case E.SYMBOLCOLOR:{ot(a.size===3||a.size===4);const c=s.getField(o,Ca);c&&HD(l,a.data,a.size,c,n);break}case E.TANGENT:{ot(a.size===4);const c=s.getField(o,Js);c&&pje(l,a.data,r,c,n);break}}}}function qD(e,t,i=0){const r=ze(e,0,gje);for(let s=0;s<4;s++)t[i+s]=Math.floor(256*yje(r*fje[s]))}function IH(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*mje[r];return i}const fje=[1,256,65536,16777216],mje=[1/256,1/65536,1/16777216,1/4294967296],gje=IH(new Uint8ClampedArray([255,255,255,255]));function yje(e){return e-Math.floor(e)}function vje(){if(O(fU)){const e=t=>ui(`esri/libs/basisu/${t}`);fU=import("./basis_transcoder.9e487389.js").then(t=>t.b).then(({default:t})=>t({locateFile:e}).then(i=>(i.initializeBasis(),delete i.then,i)))}return fU}let fU;var b_;(function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"})(b_||(b_={}));let Dh=null,HM=null;async function Cge(){return O(HM)&&(HM=vje(),Dh=await HM),HM}function _je(e,t){if(O(Dh))return e.byteLength;const i=new Dh.BasisFile(new Uint8Array(e)),r=Oge(i)?Rge(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function bje(e,t){if(O(Dh))return e.byteLength;const i=new Dh.KTX2File(new Uint8Array(e)),r=Mge(i)?Rge(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function Rge(e,t,i,r,s){const n=Tfe(t?Er.COMPRESSED_RGBA8_ETC2_EAC:Er.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*o)}function Oge(e){return e.getNumImages()>=1&&!e.isUASTC()}function Mge(e){return e.getFaces()>=1&&e.isETC1S()}async function wje(e,t,i){O(Dh)&&(Dh=await Cge());const r=new Dh.BasisFile(new Uint8Array(i));if(!Oge(r))return null;r.startTranscoding();const s=Pge(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,o)=>r.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>r.transcodeImage(a,0,n,o,0,0));return r.close(),r.delete(),s}async function xje(e,t,i){O(Dh)&&(Dh=await Cge());const r=new Dh.KTX2File(new Uint8Array(i));if(!Mge(r))return null;r.startTranscoding();const s=Pge(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,o)=>r.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>r.transcodeImage(a,n,0,0,o,0,-1,-1));return r.close(),r.delete(),s}function Pge(e,t,i,r,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[h,p]=l?r?[b_.ETC2_RGBA,Er.COMPRESSED_RGBA8_ETC2_EAC]:[b_.ETC1_RGB,Er.COMPRESSED_RGB8_ETC2]:c?r?[b_.BC3_RGBA,Er.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[b_.BC1_RGB,Er.COMPRESSED_RGB_S3TC_DXT1_EXT]:[b_.RGBA32,Ie.RGBA],f=t.hasMipmap?i:Math.min(1,i),g=[];for(let w=0;w<f;w++)g.push(new Uint8Array(o(w,h))),a(w,h,g[w]);const y=g.length>1,v=y?Ve.LINEAR_MIPMAP_LINEAR:Ve.LINEAR,b=me(I({},t),{samplingMode:v,hasMipmap:y,internalFormat:p,width:s,height:n});return new Ze(e,b,{type:"compressed",levels:g})}const a2=he.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Tje=542327876,Sje=131072,Eje=4;function $H(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function Aje(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const Cje=$H("DXT1"),Rje=$H("DXT3"),Oje=$H("DXT5"),Mje=31,Pje=0,Ije=1,$je=2,Dje=3,Lje=4,Nje=7,Fje=20,Uje=21;function kje(e,t,i){const{textureData:r,internalFormat:s,width:n,height:o}=zje(i,t.hasMipmap);return t.samplingMode=r.levels.length>1?Ve.LINEAR_MIPMAP_LINEAR:Ve.LINEAR,t.hasMipmap=r.levels.length>1,t.internalFormat=s,t.width=n,t.height=o,new Ze(e,t,r)}function zje(e,t){const i=new Int32Array(e,0,Mje);if(i[Pje]!==Tje)return a2.error("Invalid magic number in DDS header"),null;if(!(i[Fje]&Eje))return a2.error("Unsupported format, must contain a FourCC code"),null;const r=i[Uje];let s,n;switch(r){case Cje:s=8,n=Er.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Rje:s=16,n=Er.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Oje:s=16,n=Er.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return a2.error("Unsupported FourCC code:",Aje(r)),null}let o=1,a=i[Lje],l=i[Dje];(3&a)==0&&(3&l)==0||(a2.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;i[$je]&Sje&&t!==!1&&(o=Math.max(1,i[Nje])),o===1||Qx(a)&&Qx(l)||(a2.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let g=i[Ije]+4;const y=[];for(let v=0;v<o;++v)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(e,g,f),y.push(p),g+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}class Kr extends WR{constructor(t,i){super(),this.data=t,this.type=Wh.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new wr,this.params=i||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:lt.REPEAT,t:lt.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||Wy.STRETCH,this.estimatedTexMemRequired=Kr._estimateTexMemRequired(this.data,this.params),this._startPreload()}_startPreload(){const t=this.data;O(t)||(t instanceof HTMLVideoElement?this._startPreloadVideoElement(t):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){oT(t.src)||t.preload==="auto"&&t.crossOrigin||(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src)}_startPreloadImageElement(t){Sp(t.src)||oT(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}static _getDataDimensions(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}static _estimateTexMemRequired(t,i){if(O(t))return 0;if(RS(t)||a_(t))return i.encoding===Kr.KTX2_ENCODING?bje(t,i.mipmap):i.encoding===Kr.BASIS_ENCODING?_je(t,i.mipmap):t.byteLength;const{width:r,height:s}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?Kr._getDataDimensions(t):i;return(i.mipmap?4/3:1)*r*s*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(t){var i;return{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?Ve.LINEAR_MIPMAP_LINEAR:Ve.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:(i=this.params.maxAnisotropy)!=null?i:this.params.mipmap?t.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(t,i){if(_(this._glTexture))return this._glTexture;if(_(this._loadingPromise))return this._loadingPromise;const r=this.data;return O(r)?(this._glTexture=new Ze(t,this._createDescriptor(t),null),this._glTexture):typeof r=="string"?this._loadFromURL(t,i,r):r instanceof Image?this._loadFromImageElement(t,i,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(t,i,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(t,r,i):(RS(r)||a_(r))&&this.params.encoding===Kr.DDS_ENCODING?(this.data=void 0,this._loadFromDDSData(t,r)):(RS(r)||a_(r))&&this.params.encoding===Kr.KTX2_ENCODING?(this.data=void 0,this._loadFromKTX2(t,r)):(RS(r)||a_(r))&&this.params.encoding===Kr.BASIS_ENCODING?(this.data=void 0,this._loadFromBasis(t,r)):a_(r)?this._loadFromPixelData(t,r):RS(r)?this._loadFromPixelData(t,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(t,i,r){if(!(this.data instanceof HTMLVideoElement)||O(this._glTexture)||this.data.readyState<IA.HAVE_CURRENT_DATA||r===this.data.currentTime)return r;if(_(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this.data),this._drawStretchedTexture(t,i,s,n,o,this._glTexture)}else{const{width:s,height:n}=this.data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}_loadFromDDSData(t,i){return this._glTexture=kje(t,this._createDescriptor(t),i),this._glTexture}_loadFromKTX2(t,i){return this._loadAsync(()=>xje(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,i){return this._loadAsync(()=>wje(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,i){ot(this.params.width>0&&this.params.height>0);const r=this._createDescriptor(t);return r.pixelFormat=this.params.components===1?Ie.LUMINANCE:this.params.components===3?Ie.RGB:Ie.RGBA,r.width=this.params.width,r.height=this.params.height,this._glTexture=new Ze(t,r,i),this._glTexture}_loadFromURL(t,i,r){return this._loadAsync(async s=>{const n=await Cu(r,{signal:s});return Jt(s),this._loadFromImage(t,n,i)})}_loadFromImageElement(t,i,r){return r.complete?this._loadFromImage(t,r,i):this._loadAsync(async s=>{const n=await tae(r,r.src,!1,s);return Jt(s),this._loadFromImage(t,n,i)})}_loadFromVideoElement(t,i,r){return r.readyState>=IA.HAVE_CURRENT_DATA?this._loadFromImage(t,r,i):this._loadFromVideoElementAsync(t,i,r)}_loadFromVideoElementAsync(t,i,r){return this._loadAsync(s=>new Promise((n,o)=>{const a=()=>{r.removeEventListener("loadeddata",l),r.removeEventListener("error",c),Ys(h)},l=()=>{r.readyState>=IA.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(t,r,i)))},c=p=>{a(),o(p||new Q("Failed to load video"))};r.addEventListener("loadeddata",l),r.addEventListener("error",c);const h=co(s,()=>c(pi()))}))}_loadFromImage(t,i,r){const s=Kr._getDataDimensions(i);this.params.width=s.width,this.params.height=s.height;const n=this._createDescriptor(t);return n.pixelFormat=this.params.components===3?Ie.RGB:Ie.RGBA,!this._requiresPowerOfTwo(t,n)||Qx(s.width)&&Qx(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new Ze(t,n,i),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(t,i,s,n,r),this._glTexture)}_loadAsync(t){const i=new AbortController;this._loadingController=i;const r=t(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}_requiresPowerOfTwo(t,i){const r=lt.CLAMP_TO_EDGE,s=typeof i.wrapMode=="number"?i.wrapMode===r:i.wrapMode.s===r&&i.wrapMode.t===r;return!Ws(t.gl)&&(i.hasMipmap||!s)}_makePowerOfTwoTexture(t,i,r,s,n){const{width:o,height:a}=r,l=Zx(o),c=Zx(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case Wy.PAD:s.textureCoordinateScaleFactor=[o/l,a/c],h=new Ze(t,s),h.updateData(0,0,0,o,a,i);break;case Wy.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(t,i,s,n());break;default:this.params.powerOfTwoResizeMode}return s.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(t,i,r,s){const n=new Ze(t,r),o=new ki(t,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},n),a=new Ze(t,{target:rt.TEXTURE_2D,pixelFormat:r.pixelFormat,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},i),l=fo(t),c=t.getBoundFramebufferObject();return this._drawStretchedTexture(t,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),t.bindFramebuffer(c),n}_drawStretchedTexture(t,i,r,s,n,o){t.bindFramebuffer(r);const a=t.getViewport();t.setViewport(0,0,o.descriptor.width,o.descriptor.height);const l=t.useTechnique(i);l.setUniform4f("uColor",1,1,1,1),l.bindTexture(n,"tex"),t.bindVAO(s),t.drawArrays(Tt.TRIANGLE_STRIP,0,fn(s,"geometry")),t.bindFramebuffer(null),t.setViewport(a.x,a.y,a.width,a.height)}unload(){if(_(this._powerOfTwoStretchInfo)){const{framebuffer:t,vao:i,sourceTexture:r}=this._powerOfTwoStretchInfo;i.dispose(!0),r.dispose(),t.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(_(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),_(this._loadingController)){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}}var IA;Kr.DDS_ENCODING="image/vnd-ms.dds",Kr.KTX2_ENCODING="image/ktx2",Kr.BASIS_ENCODING="image/x.basis",function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(IA||(IA={}));const XC=128,DH=.5;function Ige(e,t=XC,i=t*DH,r=0){const s=Bje(e,t,i,r);return new Kr(s,{mipmap:!1,wrap:{s:lt.CLAMP_TO_EDGE,t:lt.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function Bje(e,t=XC,i=t*DH,r=0){switch(e){case"circle":default:return Vje(t,i);case"square":return Gje(t,i);case"cross":return Hje(t,i,r);case"x":return qje(t,i,r);case"kite":return jje(t,i);case"triangle":return Wje(t,i);case"arrow":return Xje(t,i)}}function Vje(e,t){const i=e/2-.5;return eO(e,Lge(i,i,t/2))}function Gje(e,t){return $ge(e,t,!1)}function jje(e,t){return $ge(e,t,!0)}function Hje(e,t,i=0){return Dge(e,t,!1,i)}function qje(e,t,i=0){return Dge(e,t,!0,i)}function Wje(e,t){return eO(e,Nge(e/2,t,t/2))}function Xje(e,t){const i=t,r=t/2,s=e/2,n=.8*i,o=Lge(s,(e-t)/2-n,Math.sqrt(n*n+r*r)),a=Nge(s,i,r);return eO(e,(l,c)=>Math.max(a(l,c),-o(l,c)))}function $ge(e,t,i){return i&&(t/=Math.SQRT2),eO(e,(r,s)=>{let n=r-.5*e+.25,o=.5*e-s-.75;if(i){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*t})}function Dge(e,t,i,r=0){t-=r,i&&(t*=Math.SQRT2);const s=.5*t;return eO(e,(n,o)=>{let a,l=n-.5*e,c=.5*e-o-1;if(i){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=r/2,a})}function Lge(e,t,i){return(r,s)=>{const n=r-e,o=s-t;return Math.sqrt(n*n+o*o)-i}}function Nge(e,t,i){const r=Math.sqrt(t*t+i*i);return(s,n)=>{const o=Math.abs(s-e)-i,a=n-e+t/2+.75,l=(t*o+i*a)/r,c=-a;return Math.max(l,c)}}function eO(e,t){const i=new Uint8Array(4*e*e);for(let r=0;r<e;r++)for(let s=0;s<e;s++){const n=s+e*r;let o=t(s,r);o=o/e+.5,qD(o,i,4*n)}return i}function Rr(e,t){if(t.slicePlaneEnabled){e.extensions.add("GL_OES_standard_derivatives"),t.sliceEnabledForVertexPrograms&&(e.vertex.uniforms.add("slicePlaneOrigin","vec3"),e.vertex.uniforms.add("slicePlaneBasis1","vec3"),e.vertex.uniforms.add("slicePlaneBasis2","vec3")),e.fragment.uniforms.add("slicePlaneOrigin","vec3"),e.fragment.uniforms.add("slicePlaneBasis1","vec3"),e.fragment.uniforms.add("slicePlaneBasis2","vec3");const i=x`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,r=x`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,s=t.sliceHighlightDisabled?x`#define highlightSlice(_color_, _pos_) (_color_)`:x`
        ${r}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i),e.fragment.code.add(s)}else{const i=x`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i)}}function rb(e,t,i){v0(e,t,i.slicePlane,{origin:i.origin})}function v0(e,t,i,r){if(t.slicePlaneEnabled)if(_(i)){if(ne(Bp,i.origin),ne(eg,i.basis1),ne(tg,i.basis2),_(r)&&_(r.origin)&&de(Bp,i.origin,r.origin),_(r)&&_(r.view)){const s=_(r.origin)?Vo(Yje,r.view,r.origin):r.view;pe(eg,eg,Bp),pe(tg,tg,Bp),Ue(Bp,Bp,s),Ue(eg,eg,s),Ue(tg,tg,s),de(eg,eg,Bp),de(tg,tg,Bp)}e.setUniform3fv("slicePlaneOrigin",Bp),e.setUniform3fv("slicePlaneBasis1",eg),e.setUniform3fv("slicePlaneBasis2",tg)}else e.setUniform3fv("slicePlaneBasis1",cl),e.setUniform3fv("slicePlaneBasis2",cl),e.setUniform3fv("slicePlaneOrigin",cl)}const Bp=M(),eg=M(),tg=M(),Yje=Te();function Fge(e){e.include(As),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("nearFar","vec2"),e.code.add(x`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function Uge(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}function Zje(e,t){t.multipassGeometryEnabled&&e.vertex.include(Fge),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(x`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?x`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(As),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(Yh),e.fragment.code.add(x`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?x`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const Qje=yi(1,1,0,1),kge=yi(1,0,1,1);function Fm(e){e.fragment.uniforms.add("depthTex","sampler2D"),e.fragment.uniforms.add("highlightViewportPixelSz","vec4"),e.fragment.constants.add("occludedHighlightFlag","vec4",Qje).add("unoccludedHighlightFlag","vec4",kge),e.fragment.code.add(x`void outputHighlight() {
vec4 fragCoord = gl_FragCoord;
float sceneDepth = texture2D(depthTex, (fragCoord.xy - highlightViewportPixelSz.xy) * highlightViewportPixelSz.zw).r;
if (fragCoord.z > sceneDepth + 5e-7) {
gl_FragColor = occludedHighlightFlag;
}
else {
gl_FragColor = unoccludedHighlightFlag;
}
}`)}function Pp(e,t){e.bindTexture(t.highlightDepthTexture,"depthTex"),e.setUniform4f("highlightViewportPixelSz",0,0,t.inverseViewport[0],t.inverseViewport[1])}function $x(e,t){t.vvInstancingEnabled&&(t.vvSize||t.vvColor)&&e.attributes.add(E.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.uniforms.add("vvSymbolRotationMatrix","mat3"),e.vertex.uniforms.add("vvSymbolAnchor","vec3"),e.vertex.code.add(x`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),e.vertex.code.add(x`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.vvInstancingEnabled?x`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):e.vertex.code.add(x`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`
      uniform float vvColorValues[vvColorNumber];
      uniform vec4 vvColorColors[vvColorNumber];

      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${t.vvInstancingEnabled?x`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):e.vertex.code.add(x`vec4 vvColor() { return vec4(1.0); }`)}function LH(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function zge(e,t){LH(e,t),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function Jje(e,t){LH(e,t),t.vvSizeEnabled&&(e.setUniform3fv("vvSymbolAnchor",t.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",t.vvSymbolRotationMatrix))}const WD=.1,zn=.001;function rm(e,t){const i=e.fragment;switch(t.alphaDiscardMode){case Ai.Blend:i.code.add(x`
        #define discardOrAdjustAlpha(color) { if (color.a < ${x.float(zn)}) { discard; } }
      `);break;case Ai.Opaque:i.code.add(x`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case Ai.Mask:i.uniforms.add("textureAlphaCutoff","float"),i.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case Ai.MaskBlend:e.fragment.uniforms.add("textureAlphaCutoff","float"),e.fragment.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function Kje(e){const t=new Ri,i=e.signedDistanceFieldEnabled;if(t.include(tH),t.include(Sge,e),t.include(Rr,e),e.output===j.Occlusion)return t.include(Zje,e),t;t.include(OH),t.fragment.include(Yh),t.fragment.include(Rp),t.include($x,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.COLOR,"vec4"),t.attributes.add(E.SIZE,"vec2"),t.attributes.add(E.AUXPOS2,"vec4"),t.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?x`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:x`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=x`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,s=e.pixelSnappingEnabled?i?x`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:x`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:x`posProj += quadOffset;`;t.vertex.code.add(x`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${x.float(zn)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${x.float(zn)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${s}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?x`} else { vtc = vec2(0.0);
        ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const n=e.debugDrawLabelBorder?x`(isBorder > 0.0 ? 0.0 : ${x.float(WD)})`:x.float(WD),o=x`
    ${e.debugDrawLabelBorder?x`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?x`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${x.float(XC)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${x.float(zn)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:x`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?x`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return e.output===j.Alpha&&t.fragment.code.add(x`
      void main() {
        ${o}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),e.output===j.Color&&t.fragment.code.add(x`
    void main() {
      ${o}
      ${e.frontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),e.output===j.Highlight&&(t.include(Fm),t.fragment.code.add(x`
    void main() {
      ${o}
      ${e.binaryHighlightOcclusionEnabled?x`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function Bge(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",H_),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",XD(t))}function XD(e,t=tHe){return e.textureIsSignedDistanceField?eHe(e.anchorPos,e.distanceFieldBoundingBox,t):Fs(t,e.anchorPos),t}function eHe(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}const tHe=Xe(),iHe=Object.freeze({__proto__:null,build:Kje,bindHUDMaterialUniforms:Bge,calculateAnchorPosForRendering:XD});function Vge(e,t){const i=e.vertex.code;t.verticalOffsetEnabled?(e.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&(e.include(OH),e.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4")),i.add(x`
    vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
      ${t.viewingMode===$e.Global?x`vec3 worldNormal = normalize(worldPos + localOrigin);`:x`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
      ${t.screenSizePerspectiveEnabled?x`
          float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
          float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:x`
          float verticalOffsetScreenHeight = verticalOffset.x;`}
      // Screen sized offset in world space, used for example for line callouts
      float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
      return worldNormal * worldOffset;
    }

    vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      return worldPos + calculateVerticalOffset(worldPos, localOrigin);
    }
    `)):i.add(x`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}function NH(e,t,i){if(!t.verticalOffset)return;const r=rHe(t.verticalOffset,i.camera.fovY,i.camera.fullViewport[3]),s=i.camera.pixelRatio||1;e.setUniform4f("verticalOffset",r.screenLength*s,r.perDistance,r.minWorldLength,r.maxWorldLength)}function rHe(e,t,i,r=sHe){return r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*t)/(.5*i),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}const sHe={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};function yc(e,t){e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.code.add(x`
    // Compare the linearized depths of fragment and terrain. Discard fragments on the wrong side of the terrain.
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){

      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${t.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `)}function Um(e,t){t.multipassTerrainEnabled&&t.terrainLinearDepthTexture&&e.bindTexture(t.terrainLinearDepthTexture,"terrainDepthTexture")}const dl=Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),nHe=gc(Ee.ONE,Ee.ONE),Gge=gc(Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA);function km(e){return e===at.FrontFace?null:e===at.Alpha?Gge:nHe}function nF(e){return e===at.FrontFace?Aa:null}const oF=5e5,aF={factor:-1,units:-2};function lF(e){return e?aF:null}function O0(e,t=Di.LESS){return e===at.NONE||e===at.FrontFace?t:Di.LEQUAL}class tO extends Vi{initializeProgram(t){const i=tO.shader.get(),r=this.configuration,s=i.build({output:r.output,frontFacePass:r.transparencyPassType===at.FrontFace,viewingMode:t.viewingMode,occlusionTestEnabled:r.occlusionTestEnabled,signedDistanceFieldEnabled:r.sdf,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawLabelBorder:r.debugDrawLabelBorder,binaryHighlightOcclusionEnabled:r.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,pixelSnappingEnabled:r.pixelSnappingEnabled,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!1,isDraped:r.isDraped,multipassGeometryEnabled:r.multipassGeometryEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,mi)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),NH(this.program,t,i),uje(this.program,t),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio||1),Zfe(this.program,i),this.configuration.output===j.Occlusion?(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Uge(this.program,i),Um(this.program,i)):(Ege(this.program,i),Bge(this.program,t,i.camera.pixelRatio||1),LH(this.program,t),this.configuration.occlusionTestEnabled&&this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture")),this.configuration.output===j.Highlight&&Pp(this.program,i)}bindDraw(t){Op(this.program,t),R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),rb(this.program,this.configuration,t),this.program.rebindTextures()}_setPipelineState(t){const i=this.configuration,r=t===at.NONE,s=t===at.FrontFace,n=Di.LEQUAL,o=this.configuration.polygonOffsetEnabled&&oHe,a=(r||s)&&i.output!==j.Highlight?(i.depthEnabled||i.output===j.Occlusion)&&Aa:null;return Rt({blending:i.output===j.Color||i.output===j.Alpha||i.output===j.Highlight?r?aHe:km(t):null,depthTest:{func:n},depthWrite:a,colorWrite:Ft,polygonOffset:o})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===j.Occlusion?Tt.POINTS:Tt.TRIANGLES}}tO.shader=new Li(iHe,()=>import("./HUDMaterial.glsl.c48e0c58.js"));const oHe={factor:0,units:-4},aHe=gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA);class Bs extends dr{constructor(){super(...arguments),this.output=j.Color,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=al.World,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=at.NONE,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],Bs.prototype,"output",void 0),u([Y()],Bs.prototype,"occlusionTestEnabled",void 0),u([Y()],Bs.prototype,"sdf",void 0),u([Y()],Bs.prototype,"vvSize",void 0),u([Y()],Bs.prototype,"vvColor",void 0),u([Y()],Bs.prototype,"verticalOffset",void 0),u([Y()],Bs.prototype,"screenSizePerspective",void 0),u([Y({count:al.COUNT})],Bs.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([Y()],Bs.prototype,"debugDrawLabelBorder",void 0),u([Y()],Bs.prototype,"binaryHighlightOcclusion",void 0),u([Y()],Bs.prototype,"slicePlaneEnabled",void 0),u([Y()],Bs.prototype,"polygonOffsetEnabled",void 0),u([Y()],Bs.prototype,"depthEnabled",void 0),u([Y({count:at.COUNT})],Bs.prototype,"transparencyPassType",void 0),u([Y()],Bs.prototype,"pixelSnappingEnabled",void 0),u([Y()],Bs.prototype,"isDraped",void 0),u([Y()],Bs.prototype,"multipassGeometryEnabled",void 0),u([Y()],Bs.prototype,"multipassTerrainEnabled",void 0),u([Y()],Bs.prototype,"cullAboveGround",void 0);class VT extends Zh{constructor(t){super(t,yHe),this.techniqueConfig=new Bs}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?al.Screen:al.World,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,t===j.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),t===j.Highlight&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=i.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedHudGeometry(t,o,a,l,c):this._intersectHudGeometry(t,i,r,s,a,l)}_intersectDrapedHudGeometry(t,i,r,s,n){const o=t.vertexAttributes.get(E.POSITION),a=t.vertexAttributes.get(E.SIZE),l=this.parameters,c=XD(l);let h=1,p=1;if(_(s)){const g=s(YK);h=g[0],p=g[5]}h*=t.screenToWorldRatio,p*=t.screenToWorldRatio;const f=mHe*t.screenToWorldRatio;for(let g=0;g<o.data.length/o.size;g++){const y=g*o.size,v=o.data[y],b=o.data[y+1],w=g*a.size;let S;ig[0]=a.data[w]*h,ig[1]=a.data[w+1]*p,l.textureIsSignedDistanceField&&(S=l.outlineSize*t.screenToWorldRatio/2),WK(i,v,b,ig,f,S,l,c)&&r(n.dist,n.normal,-1,!0)}}_intersectHudGeometry(t,i,r,s,n,o){if(!s.options.selectionMode||!s.options.hud||XR(i))return;const a=this.parameters;let l=1,c=1;if(Eu(gU,r),_(o)){const S=o(YK);l=S[0],c=S[5],uHe(gU)}const h=t.vertexAttributes.get(E.POSITION),p=t.vertexAttributes.get(E.SIZE),f=t.vertexAttributes.get(E.NORMAL),g=t.vertexAttributes.get(E.AUXPOS1);ot(h.size>=3);const y=s.point,v=s.camera,b=XD(a);l*=v.pixelRatio,c*=v.pixelRatio;const w=this.parameters.centerOffsetUnits==="screen";for(let S=0;S<h.data.length/h.size;S++){const T=S*h.size;oe(go,h.data[T],h.data[T+1],h.data[T+2]),Ue(go,go,r);const A=S*p.size;ig[0]=p.data[A]*l,ig[1]=p.data[A+1]*c,Ue(go,go,v.viewMatrix);const C=S*g.size;if(oe(Bu,g.data[C+0],g.data[C+1],g.data[C+2]),!w&&(go[0]+=Bu[0],go[1]+=Bu[1],Bu[2]!==0)){const L=Bu[2];be(Bu,go),de(go,go,ae(Bu,Bu,L))}const R=S*f.size;if(oe(l2,f.data[R],f.data[R+1],f.data[R+2]),this._normalAndViewAngle(l2,gU,v,yU),this._applyVerticalOffsetTransformationView(go,yU,v,mU),v.applyProjection(go,q0),q0[0]>-1){let L=Math.floor(q0[0])+this.parameters.screenOffset[0],U=Math.floor(q0[1])+this.parameters.screenOffset[1];w&&(L+=Bu[0],Bu[1]!==0&&(U+=AH(Bu[1],mU.factorAlignment))),yge(ig,mU.factor,ig);const N=fHe*v.pixelRatio;let z;if(a.textureIsSignedDistanceField&&(z=a.outlineSize*v.pixelRatio/2),WK(y,L,U,ig,N,z,a,b)){const V=s.ray;if(Ue(XK,go,hr(pHe,v.viewMatrix)),q0[0]=y[0],q0[1]=y[1],v.unprojectFromRenderScreen(q0,go)){const B=M();ne(B,V.direction);const J=1/Pe(B);ae(B,B,J),n(xi(V.origin,go)*J,B,-1,!0,1,XK)}}}}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(E.POSITION),n=t.indices.get(E.POSITION);return tme(s,n,i)}createBufferWriter(){return new _He(this)}_normalAndViewAngle(t,i,r,s){return rje(i)&&(i=Eu(dHe,i)),rl(s.normal,t,i),Ue(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=_e(Hge,gHe),s}_updateScaleInfo(t,i,r){const s=this.parameters;s.screenSizePerspective?GK(r,i,s.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minPixelSize=0,t.factor.paddingPixels=0),s.screenSizePerspectiveAlignment?GK(r,i,s.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minPixelSize=t.factor.minPixelSize,t.factorAlignment.paddingPixels=t.factor.paddingPixels)}applyShaderOffsetsView(t,i,r,s,n,o,a){const l=this._normalAndViewAngle(i,r,n,yU);return this._applyVerticalGroundOffsetView(t,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(t,i,r,s,n){return this._applyCenterOffsetNDC(t,i,r,s),_(n)&&ne(n,s),this._applyPolygonOffsetNDC(s,i,r,s),s}_applyPolygonOffsetView(t,i,r,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(r);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return ne(n,t);const c=ze(Math.abs(i.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return ae(n,t,l>0?h:1/h),n}_applyVerticalGroundOffsetView(t,i,r,s){const n=Pe(t),o=r.aboveGround?1:-1,a=.5*r.computeRenderPixelSizeAtDist(n),l=ae(go,i.normal,o*a);return pe(s,t,l),s}_applyVerticalOffsetTransformationView(t,i,r,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Pe(t);this._updateScaleInfo(s,c,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return t}const o=Pe(t),a=n.screenSizePerspectiveAlignment||n.screenSizePerspective,l=xge(r,o,n.verticalOffset,i.cosAngle,a);return this._updateScaleInfo(s,o,i.cosAngle),ae(i.normal,i.normal,l),pe(t,t,i.normal)}_applyCenterOffsetView(t,i,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==t&&ne(r,t),s&&(r[0]+=i[0],r[1]+=i[1],i[2]&&(be(l2,r),pe(r,r,ae(l2,l2,i[2])))),r}_applyCenterOffsetNDC(t,i,r,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==t&&ne(s,t),n||(s[0]+=i[0]/r.fullWidth*2,s[1]+=i[1]/r.fullHeight*2),s}_applyPolygonOffsetNDC(t,i,r,s){const n=this.parameters.shaderPolygonOffset;if(t!==s&&ne(s,t),n){const o=r.aboveGround?1:-1,a=o*Math.sign(i[3]);s[2]-=(a||o)*n}return s}requiresSlot(t){if(t===ye.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:r}=this.parameters;return t===(i?ye.LABEL_MATERIAL:ye.HUD_MATERIAL)||r&&t===ye.OCCLUSION_PIXELS}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha?new lHe(t):t.output===j.Highlight?new jge(t):null}calculateRelativeScreenBounds(t,i,r=Dt()){return cHe(this.parameters,t,i,r),r[2]=r[0]+t[0],r[3]=r[1]+t[1],r}}class jge extends MH{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(t)}selectProgram(t){return this.ensureTechnique(tO,t)}beginSlot(t){return this.updateParameters(t)}bind(t,i){this.bindTextures(i.program),this.bindTextureScale(i.program),i.bindPass(this._material.parameters,t)}}class lHe extends jge{_isOcclusionSlot(t){return t.slot===ye.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===j.Color||this._output===j.Alpha)}selectProgram(t){return this.ensureTechnique(tO,t,this._isOcclusionSlot(t)?j.Occlusion:this._output)}bind(t,i){this._isOcclusionSlot(t)||(this.bindTextures(i.program),this.bindTextureScale(i.program)),i.bindPass(this._material.parameters,t)}}function cHe(e,t,i,r=hHe){return Fs(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i,r}function uHe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=s*p,e[4]=n*p,e[5]=o*p,e[6]=a*f,e[7]=l*f,e[8]=c*f,e}function WK(e,t,i,r,s,n,o,a){let l=t-s-(a[0]>0?r[0]*a[0]:0),c=l+r[0]+2*s,h=i-s-(a[1]>0?r[1]*a[1]:0),p=h+r[1]+2*s;if(o.textureIsSignedDistanceField){const f=o.distanceFieldBoundingBox;l+=r[0]*f[0],h+=r[1]*f[1],c-=r[0]*(1-f[2]),p-=r[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n}return e[0]>l&&e[0]<c&&e[1]>h&&e[1]<p}const mU={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},hHe=Xe(),go=M(),l2=M(),q0=Nn(),Hge=M(),XK=M(),gU=br(),dHe=br(),pHe=Te(),Bu=M(),yU={normal:Hge,cosAngle:0},YK=Te(),fHe=1,mHe=2,ig=[0,0],gHe=je(0,0,1),yHe=I({texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:vi(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawLabelBorder:!1,isDraped:!1},Du),vHe=Nr().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4u8(E.COLOR).vec2f(E.SIZE).vec4f(E.AUXPOS1).vec4f(E.AUXPOS2);class _He{constructor(t){this.material=t,this.vertexBufferLayout=vHe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(E.POSITION).length}write(t,i,r,s){KR(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,6),PH(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,t.invTranspTransformation,r.normal,s,6);{const n=i.vertexAttributes.get(E.UV0).data;let o,a,l,c;if(n==null||n.length<4){const g=this.material.parameters;o=0,a=0,l=g.texCoordScale[0],c=g.texCoordScale[1]}else o=n[0],a=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);const h=i.indices.get(E.POSITION).length,p=r.uv0;let f=s;for(let g=0;g<h;++g)p.set(f,0,o),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,a),f+=1}HD(i.indices.get(E.COLOR),i.vertexAttributes.get(E.COLOR).data,4,r.color,s,6);{const n=i.indices.get(E.SIZE),o=i.vertexAttributes.get(E.SIZE).data,a=n.length,l=r.size;let c=s;for(let h=0;h<a;++h){const p=o[2*n[h]],f=o[2*n[h]+1];for(let g=0;g<6;++g)l.set(c,0,p),l.set(c,1,f),c+=1}}i.indices.get(E.AUXPOS1)&&i.vertexAttributes.get(E.AUXPOS1)&&BT(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,r.auxpos1,s,6),i.indices.get(E.AUXPOS2)&&i.vertexAttributes.get(E.AUXPOS2)&&BT(i.indices.get(E.AUXPOS2),i.vertexAttributes.get(E.AUXPOS2).data,r.auxpos2,s,6)}}const rd=M(),Tb=ni(),c2=ni(),vU=M(),bHe=Te(),wHe=vn(),_U=Fn(),xHe=M(),THe=Dt();class SHe{constructor(){this.aabr=Dt(),this.distance=0,this.culled=!1,this.visible=!1}}class EHe{constructor(t,i,r={}){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this.info=r}}class AHe{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class CHe{}class RHe{constructor(){this.sortArray=new $t({allocator:t=>t||new CHe})}}var Ha;(function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"})(Ha||(Ha={}));class qge{constructor(){this.camera=new wi,this.slicePlane=Y1(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),uS(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}let dx=class extends we{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new qge,this._state=Ha.Idle,this.graphics=new AHe,this.iterators=new RHe,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==Ha.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Ha.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(e){switch(this._state){case Ha.Idle:this._startUpdate(),e.madeProgress();case Ha.Process:if(this._state=Ha.Process,!this._processActiveGraphics(e))return;case Ha.Sort:if(this._state=Ha.Sort,!this._sortVisibleGraphics(e))return;case Ha.Deconflict:if(this._state=Ha.Deconflict,!this._deconflictVisibleGraphics(e))return;default:q7e(this,this.graphics.visible),this._state=Ha.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach(i=>this.addToActiveGraphics(i)):e.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(e){if(O(e)||e.type!=="object3d")return!1;const t=e.stageObject;return(t?t.geometryRecords.length:0)!==1?!1:t.geometryRecords[0].material instanceof VT}_startUpdate(){W7e(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new SHe,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._removeFromVisibleGraphics(e),OHe(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}_removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=hr(bHe,this._runningViewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?wHe:null;let s=0;for(_(r)&&(Ue(r,cl,this._runningViewState.camera.viewMatrix),r[3]=di(this.view.spatialReference).radius,s=Ble(r,cl));!e.done;){e.madeProgress();const n=t.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,i,r,s),a.culled?this._removeFromVisibleGraphics(o):this._addToVisibleGraphics(o))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===hn.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!i||o.isVisible())&&!this._isConflicted(s);a&&this._addToBins(s),n.visible=a,this._setGraphicVisibility(s,a),Y7e(n,a)}return!1}_resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}_ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=ZK(this.graphics.active)),this.iterators.active}_resetActiveGraphicsIterator(){this.iterators.active=null}_ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=ZK(this.graphics.visible)),this.iterators.visible}_resetVisibleGraphicsIterator(){this.iterators.visible=null}_ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=MHe(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}_resetSortGraphicsIterator(){this.iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const n=e.info[this.visibilityGroup];if(!s.isVisible(hn.GRAPHIC,Kl.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);Tu(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometryRecords[0].material;if(O(a)){if(a=this._getProjectionInfo(l,t,$He),a.isOutsideScreen||this._isCulledBySlice(e,rd)||_(i)&&this._isCulledByHorizon(a,i,r))return void(n.culled=!0);!hi.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this._expandBoundingRect(n,l,c,a)}O(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,n=s.geometryRecords[0],o=n.material,a=mc(s.boundingVolumeWorldSpace.bounds);Ue(rd,a,r.viewMatrix);const l=n.geometry.vertexAttributes,c=l.get(E.NORMAL).data,h=l.get(E.AUXPOS1).data;return o.applyShaderOffsetsView(rd,c,s.transformation,h,r,i.scaleInfo,rd),zo(Tb,rd[0],rd[1],rd[2],1),bu(c2,Tb,r.projectionMatrix),ae(i.positionNDC,c2,1/c2[3]),o.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,vU),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(vU[2]),i.distance=vU[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),zo(c2,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),bu(Tb,c2,t),wR(Tb,Tb,1/Tb[3]),oe(i.positionView,rd[0],rd[1],rd[2]),i}_isCulledByHorizon(e,t,i){return ne(_U.direction,e.positionView),oe(_U.origin,0,0,0),!!E0(t,_U,xHe)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&g7(this._runningViewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const n=this._runningViewState.camera,o=t.getScreenSize(PHe);yge(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=A$(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,THe),qt(0,n.fullWidth,.5+.5*r[0]),qt(0,n.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(Bf(a),l1(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}jy(e.aabr,a,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let r=Math.floor(i.aabr[0]/this.accBinsSizeX);r<=Math.floor(i.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(let s=Math.floor(i.aabr[1]/this.accBinsSizeY);s<=Math.floor(i.aabr[3]/this.accBinsSizeY);s++){if(s<0||s>=this.accBinsNumY)continue;const n=this.accBins[r][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,zL(l.aabr,i.aabr)))return!0}}return!1}_initBins(e,t){if(this.accBins==null){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const r=this.accBins[this.accBins.length-1];for(let s=0;s<this.accBinsNumY;s++)r.push(new $t)}}else for(let i=0;i<this.accBinsNumX;i++)for(let r=0;r<this.accBinsNumY;r++)this.accBins[i][r].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),n=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=i;o<=r;o++)if(!(o<0||o>=this.accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this.accBinsNumY||this.accBins[o][a].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(Kl.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===hn.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function OHe(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(Kl.DECONFLICTION,t)}function*ZK(e){if(Map.prototype.entries){const t=e.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*e.values()}function*MHe(e,t,i){t.clear(),e.forEach((s,n)=>{const o=t.pushNew();o.id=n,o.prio=s.info?-s.info[i].distance:Number.MAX_VALUE}),yield;const r=t.iterableSort((s,n)=>n.prio-s.prio);for(let s=r.next();!s.done;s=r.next())yield;t.forAll(s=>{const n=e.get(s.id);n&&(e.delete(s.id),e.set(s.id,n))}),t.clear()}u([d({constructOnly:!0})],dx.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],dx.prototype,"updating",null),dx=u([P("esri.views.3d.layers.graphics.Deconflictor")],dx);const PHe=Xe();class IHe{constructor(){this.positionView=M(),this.positionNDC=M(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1}}const $He=new IHe,DHe=2e3;let II=class extends dx{constructor(){super(...arguments),this.visibilityGroup=hn.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(e.state===js.IDLE||t-this._lastDeconfliction>DHe)&&(super.runTask(e),this.state===Ha.Idle&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};u([d({constructOnly:!0})],II.prototype,"parent",void 0),II=u([P("esri.views.3d.layers.graphics.LabelDeconflictor")],II);let G8=class extends dx{constructor(){super(...arguments),this._handles=new Bt,this._contexts=new Map,this._viewState=new qge,this.visibilityGroup=hn.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",()=>{this._updateViewState(),this.setDirty()}),this.view.watch("map.ground.opacity",(e,t)=>{e!==1&&t!==1||this.setDirty()}),Wt(this.view,"slicePlane",()=>{this._updateSlicePlane(),this._slicePlaneChanged()})]),this._frameTask=this.view.resourceController.scheduler.registerTask(ut.GRAPHICS_DECONFLICTOR,this),this._labels=new II({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&bU(e));t.setVisibilityFlag(Kl.DECONFLICTION,i,hn.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;_(e)&&ice(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=_(e)}_slicePlaneChanged(){Vr(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return t==null&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new EHe(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),bU(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=bU(e);i||LHe(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.graphics;if(!t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}};function bU(e){const t=e.layer;return!(!t||!t.featureReduction||t.featureReduction.type!=="selection")}function LHe(e){const t=e.graphics3DGraphics;t&&t.forEach(i=>i.clearVisibilityFlag(Kl.DECONFLICTION))}G8=u([P("esri.views.3d.layers.graphics.GraphicsDeconflictor")],G8);const FH=(e,t,i)=>[t,i],GT=(e,t,i)=>[t,i,e[2]],UH=(e,t,i)=>[t,i,e[2],e[3]];function Cpt(e){return e?{originPosition:e.originPosition==="upper-left"?"upperLeft":e.originPosition==="lower-left"?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:_(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function Wge({scale:e,translate:t},i){return i*e[0]+t[0]}function Xge({scale:e,translate:t},i){return t[1]-i*e[1]}function Yge(e,t,i){const r=new Array(i.length);if(!i.length)return r;const[s,n]=e.scale;let o=Wge(e,i[0][0]),a=Xge(e,i[0][1]);r[0]=t(i[0],o,a);for(let l=1;l<i.length;l++){const c=i[l];o+=c[0]*s,a-=c[1]*n,r[l]=t(c,o,a)}return r}function Zge(e,t,i){const r=new Array(i.length);for(let s=0;s<i.length;s++)r[s]=Yge(e,t,i[s]);return r}function NHe(e,t,i,r){return Yge(e,i?r?UH:GT:r?GT:FH,t)}function FHe(e,t,i,r){return Zge(e,i?r?UH:GT:r?GT:FH,t)}function UHe(e,t,i,r){return Zge(e,i?r?UH:GT:r?GT:FH,t)}function Qge(e,t,i,r,s){return _(i)&&(t.points=NHe(e,i.points,r,s)),t}function Jge(e,t,i,r,s){return O(i)||(t.x=Wge(e,i.x),t.y=Xge(e,i.y),t!==i&&(r&&(t.z=i.z),s&&(t.m=i.m))),t}function Kge(e,t,i,r,s){return _(i)&&(t.rings=UHe(e,i.rings,r,s)),t}function eye(e,t,i,r,s){return _(i)&&(t.paths=FHe(e,i.paths,r,s)),t}function tye(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],s=t[i];if(r.length!==s.length)return!1;for(let n=0;n<r.length;n++)if(r[n]!==s[n])return!1}return!0}function iye(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!tye(e[i],t[i]))return!1;return!0}function kHe(e,t){return!!iO(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function zHe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!iO(e.spatialReference,t.spatialReference)&&iye(e.paths,t.paths)}function BHe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!iO(e.spatialReference,t.spatialReference)&&iye(e.rings,t.rings)}function VHe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!iO(e.spatialReference,t.spatialReference)&&tye(e.points,t.points)}function GHe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!iO(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}function iO(e,t){return e===t||e&&t&&e.equals(t)}function jHe(e,t){if(e===t)return!0;if(O(e)||O(t)||e.type!==t.type)return!1;switch(e.type){case"point":return kHe(e,t);case"extent":return GHe(e,t);case"polyline":return zHe(e,t);case"polygon":return BHe(e,t);case"multipoint":return VHe(e,t);case"mesh":return!1;default:return}}function HHe(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const s of i)if(e[s]!==t[s])return!1;return!0}function Rpt(e,t){return e===t||e!=null&&t!=null&&e.objectId===t.objectId&&!!jHe(e.geometry,t.geometry)&&!!HHe(e.attributes,t.attributes)}class Opt{constructor(t,i,r){this.uid=t,this.geometry=i,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}}function Mpt(e){return _(e.geometry)}class Ppt{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function Ipt(e){const t=Hne.fromJSON(e.geometryType),i=tt.fromJSON(e.spatialReference),r=e.transform,s=e.features.map(n=>{const o=qHe(n,t,i,e.objectIdFieldName),a=o.geometry;if(_(a)&&r)switch(a.type){case"point":o.geometry=Jge(r,a,a,a.hasZ,a.hasM);break;case"multipoint":o.geometry=Qge(r,a,a,a.hasZ,a.hasM);break;case"polygon":o.geometry=Kge(r,a,a,a.hasZ,a.hasM);break;case"polyline":o.geometry=eye(r,a,a,a.hasZ,a.hasM);break;case"extent":case"mesh":o.geometry=a}return o});return{geometryType:t,features:s,spatialReference:i,fields:e.fields?e.fields.map(n=>IR.fromJSON(n)):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function qHe(e,t,i,r){return{uid:va(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:WHe(e.geometry,t,i),visible:!0}}function WHe(e,t,i){if(O(e))return null;switch(t){case"point":{const r=e;return{x:r.x,y:r.y,z:r.z,m:r.m,hasZ:r.z!=null,hasM:r.m!=null,type:"point",spatialReference:i}}case"polyline":{const r=e;return{paths:r.paths,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polyline",spatialReference:i}}case"polygon":{const r=e;return{rings:r.rings,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const r=e;return{points:r.points,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"multipoint",spatialReference:i}}}}function zm(e,t,i,r){return{x:e,y:t,z:i,hasZ:i!=null,hasM:!1,spatialReference:r,type:"point"}}function XHe(e){if(O(e))return 0;let t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(e.hasZ?1:0)+(e.hasM?1:0),s=e.type==="polyline"?e.paths:e.rings;for(const n of s)i+=n.length;t+=8*i*r+64,t+=128*i,t+=34,t+=32*(s.length+1);break}case"multipoint":{const i=2+(e.hasZ?1:0)+(e.hasM?1:0),r=e.points.length;t+=8*r*i+64,t+=128*r,t+=34,t+=32;break}case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=yO(e.vertexAttributes.position),t+=yO(e.vertexAttributes.normal),t+=yO(e.vertexAttributes.uv),t+=yO(e.vertexAttributes.tangent)}return t}function $pt(e){let t=32;return t+=ble(e.attributes),t+=3,t+=8+XHe(e.geometry),t}function YHe(e){if(O(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function Dpt(e){if(O(e))return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function Lpt(e,t){switch(Ui(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)T4(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)T4(t,e.rings[i],e.hasZ);break;case"multipoint":T4(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,e.zmin!=null&&(t[2]=e.zmin),e.zmax!=null&&(t[5]=e.zmax)}}function ZHe(e,t){switch(Tu(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)x4(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)x4(t,e.rings[i]);break;case"multipoint":x4(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function Npt(e,t){return e.objectId!=null?e.objectId:e.attributes&&t?e.attributes[t]:null}os();Dt();function rye(e){return"declaredClass"in e}function QK(e){return"declaredClass"in e}function QHe(e){return"declaredClass"in e}function JHe(e,t){if(!e)return null;if(QHe(e))return e;const i=new Bo({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=se(e.symbol),i.attributes=se(e.attributes),i.geometry=sye(e.geometry),i}function sye(e){return O(e)?null:rye(e)?e:dm(KHe(e))}function KHe(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:s,m:n}=e;return{x:i,y:r,z:s,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:s}=e;return{rings:JK(i),hasZ:r,hasM:s,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:s}=e;return{paths:JK(i),hasZ:r,hasM:s,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p}=e;return{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:s}=e;return{points:oye(i)?nye(i):i,hasZ:r,hasM:s,spatialReference:t}}default:return}}function JK(e){return eqe(e)?e.map(t=>nye(t)):e}function nye(e){return e.map(t=>X1e(t))}function eqe(e){for(const t of e)if(t.length!==0)return oye(t);return!1}function oye(e){return e.length&&(rse(e[0])||sse(e[0]))}function tqe(e,t){if(!e)return null;let i;if(QK(e)){if(t==null)return e.clone();if(QK(t))return t.copy(e)}return t!=null?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=zm(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}const iqe=he.getLogger("esri.layers.support.labelFormatUtils"),KK={type:"simple",evaluate:()=>null},rqe={getAttribute:(e,t)=>e.field(t)};async function aye(e,t,i){if(!e||!e.symbol)return KK;const r=e.where,s=NN(e),n=r?await import("./WhereClause.184162be.js"):null;let o;if(s.type==="arcade"){const a=await fTe(s.expression,i,t);o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l});if(c!=null)return c.toString()}catch{iqe.error(new Q("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>Tj(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=t.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":lye(p,h)})};if(r){let a;try{a=n.WhereClause.create(r,t)}catch{return KK}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:rqe;return a.testFeature(c,h)?l(c):null}}return o}function lye(e,t){if(e==null)return"";const i=t.domain;if(i){if(i.type==="codedValue"||i.type==="coded-value"){const s=e;for(const n of i.codedValues)if(n.code===s)return n.name}else if(i.type==="range"){const s=+e,n="range"in i?i.range[0]:i.minValue,o="range"in i?i.range[1]:i.maxValue;if(n<=s&&s<=o)return i.name}}let r=e;return t.type==="date"||t.type==="esriFieldTypeDate"?r=pm(r,_G("short-date")):$L(t)&&(r=fm(+r)),r||""}var Fpt=Object.freeze(Object.defineProperty({__proto__:null,createLabelFunction:aye,formatField:lye},Symbol.toStringTag,{value:"Module"}));function kH(e,t){if(e.type==="point")return rg(e,t,!1);if(rye(e))switch(e.type){case"extent":return rg(e.center,t,!1);case"polygon":return rg(e.centroid,t,!1);case"polyline":return rg(eee(e),t,!0);case"mesh":return rg(e.origin,t,!1)}else switch(e.type){case"extent":return rg(sqe(e),t,!0);case"polygon":return rg(nqe(e),t,!0);case"polyline":return rg(eee(e),t,!0)}}function eee(e){const t=e.paths[0];if(!t||t.length===0)return null;const i=Mne(t,One(t)/2);return zm(i[0],i[1],i[2],e.spatialReference)}function sqe(e){const t=isFinite(e.zmin);return zm(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}function nqe(e){const t=e.rings[0];if(!t||t.length===0)return null;const i=Pne(e.rings,e.hasZ);return zm(i[0],i[1],i[2],e.spatialReference)}function rg(e,t,i){const r=i?e:tqe(e);return t&&e?sCe(e,r,t)?r:null:r}function Upt(e,t,i,r=0){if(e){t||(t=Dt());const s=e;let n=.5*s.width*(i-1),o=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),zo(t,s.xmin-n-r,s.ymin-o-r,s.xmax+n+r,s.ymax+o+r),t}return null}function cye(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(E.AUXPOS1);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[i]))}}function $A(e,t){const i=oN(Zd);return _(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),_(t)?i[3]=t:_(e)&&e.length>3&&(i[3]=e[3]),i}function kpt(e,t,i,r,s,n=[0,0,0,0]){for(let o=0;o<3;++o)_(e)&&e[o]!=null?n[o]=e[o]:_(i)&&i[o]!=null?n[o]=i[o]:n[o]=s[o];return _(t)?n[3]=t:_(r)?n[3]=r:n[3]=s[3],n}function tee(e=Kd,t,i,r=1){const s=new Array(3);if(O(t)||O(i))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=e[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=i[a];l==="symbol-value"||p?c=f!==0?t[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=r;return aa(s)}function oqe(e){return e.isPrimitive!=null}function cF(e){return oqe(e)&&(e=[e.width,e.depth,e.height]),YD(e)?null:"Symbol sizes may not be negative values"}function YD(e){if(Array.isArray(e)){for(const t of e)if(!YD(t))return!1;return!0}return e==null||e>=0}function aqe(e,t,i,r=Te()){const s=e||0,n=t||0,o=i||0;return s!==0&&uT(r,r,-s/180*Math.PI),n!==0&&cT(r,r,n/180*Math.PI),o!==0&&tN(r,r,o/180*Math.PI),r}function zH(e,t){return t.minDemResolution!=null?t.minDemResolution:VL(e)?t.minDemResolutionForPoints:.01*PSe(e)}function uye(e,t,i,r,s,n,o,a,l,c,h){const p=mqe[h.mode];let f,g,y=0;if(_r(e,t,i,r,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(r,s,n,o,a,l,c,h),f=n,g=o):(f=r,g=s),_r(f,l.spatialReference,g,n,c.spatialReference,o,a)?y:void 0}function bm(e,t,i,r,s){const n=(_D(e)?e.z:Cpe(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const o=gt(Mh(t,e,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=gt(Mh(t,e,"ground"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=gt(Mh(t,e,"scene"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=i.geometryZWithOffset(n,r),a=gt(Mh(t,e,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return i.mode,void(s.z=0)}}function lqe(e,t,i,r){return bm(e,t,i,r,px),px.z}function rO(e,t,i){return t==null||i==null?e.definedChanged:t==="on-the-ground"&&i==="on-the-ground"?e.staysOnTheGround:t===i||t!=="on-the-ground"&&i!=="on-the-ground"?yr.UPDATE:e.onTheGroundChanged}function Mu(e){return e==="relative-to-ground"||e==="relative-to-scene"}function _0(e){return e!=="absolute-height"}function cqe(e,t,i,r,s){bm(t,i,s,r,px),cye(e,px.verticalDistanceToGround);const n=px.sampledElevation,o=Lr(gqe,e.transformation);return qM[0]=t.x,qM[1]=t.y,qM[2]=px.z,Gh(t.spatialReference,qM,o,r.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function uqe(e,t,i,r,s,n){let o=0;const a=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const c=e[t+0],h=e[t+1],p=e[t+2],f=gt(n.getElevation(c,h,p,a,"ground"),0);o+=f,i[r+0]=c,i[r+1]=h,i[r+2]=f,t+=3,r+=3}return o/s}function hqe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const g=e[t+0],y=e[t+1],v=e[t+2],b=gt(n.getElevation(g,y,v,p,"ground"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,t+=3,r+=3}return l/s}function dqe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const g=e[t+0],y=e[t+1],v=e[t+2],b=gt(n.getElevation(g,y,v,p,"scene"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,t+=3,r+=3}return l/s}function pqe(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return t!==0||i!=null}function fqe(e,t,i,r,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,r*=3;for(let h=0;h<s;++h){const p=e[t+0],f=e[t+1],g=e[t+2];i[r+0]=p,i[r+1]=f,i[r+2]=c==null?g+l:l,t+=3,r+=3}return 0}class sO{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var yr;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(yr||(yr={}));const mqe={"absolute-height":{applyElevationAlignmentBuffer:fqe,requiresAlignment:pqe},"on-the-ground":{applyElevationAlignmentBuffer:uqe,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:hqe,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:dqe,requiresAlignment:()=>!0}},gqe=Te(),px=new sO,qM=M();function hye(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;for(const a of n){const{update:l,averageGeometrySampledElevation:c}=pye(a,t,i,r);o+=c,l&&s.geometryVertexAttrsUpdated(a)}return o/n.length}function YC(e,t,i,r){const s=e.stageObject,n=t.centerPointInElevationSR;let o=0;s.metadata.usesVerticalDistanceToGround?(bm(n,i,t,r,da),cye(s,da.verticalDistanceToGround),o=da.sampledElevation):(bm(n,i,t,r,da),t.mode!=="absolute-height"&&(o=da.sampledElevation));const a=Lr(yqe,s.transformation),l=oe(dye,a[12],a[13],a[14]);hi.TESTS_DISABLE_OPTIMIZATIONS?(ha[0]=n.x,ha[1]=n.y,ha[2]=da.z,Gh(n.spatialReference,ha,a,r.spatialReference)&&(s.transformation=a)):r.setAltitudeOfTransformation(da.z,a);const c=BH/r.unitInMeters;return(Math.abs(a[12]-l[0])>=c||Math.abs(a[13]-l[1])>=c||Math.abs(a[14]-l[2])>=c)&&(s.transformation=a),o}const yqe=Te();function vqe(e,t,i,r){const s=e.graphics3DSymbolLayer.lodRenderer;if(O(s))return 0;const n=t.centerPointInElevationSR;bm(n,i,t,r,da);const o=t.mode!=="absolute-height"?da.sampledElevation:0,a=s.instanceData,l=e.instanceIndex,c=bqe;a.getGlobalTransform(l,c);const h=oe(dye,c[12],c[13],c[14]);hi.TESTS_DISABLE_OPTIMIZATIONS?(ha[0]=n.x,ha[1]=n.y,ha[2]=da.z,Gh(n.spatialReference,ha,c,r.spatialReference)&&a.setGlobalTransform(l,c)):r.setAltitudeOfTransformation(da.z,c);const p=BH/r.unitInMeters;return(hi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&a.setGlobalTransform(l,c),o}function _qe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;if(n.length===0)return 0;let o=0,a=null,l=0,c=!1;for(const h of n){const p=h.geometry.vertexAttributes.get(E.POSITION);if(p!==a){const{update:f,averageGeometrySampledElevation:g}=pye(h,t,i,r);l=g,a=p,c=f}c&&s.geometryVertexAttrsUpdated(h),o+=l}return o/n.length}const BH=.01,ha=M(),Cc=M(),Sb=M(),bqe=Te(),dye=M(),da=new sO;function pye(e,t,i,r){let s=!1;const n=i.spatialReference,o=e.geometry,a=e.getShaderTransformation(),l=t.requiresSampledElevationInfo;Cc[0]=a[12],Cc[1]=a[13],Cc[2]=a[14],o.invalidateBoundingInfo();const c=o.getMutableAttribute(E.POSITION),h=c.data,p=o.vertexAttributes.get(E.MAPPOS).data,f=c.size,g=h.length/f,y=new Ape(p,n);let v=0,b=0;for(let w=0;w<g;w++){if(Sb[0]=h[v],Sb[1]=h[v+1],Sb[2]=h[v+2],bm(y,i,t,r,da),l&&(b+=da.sampledElevation),hi.TESTS_DISABLE_OPTIMIZATIONS)h[v]=y.array[y.offset],h[v+1]=y.array[y.offset+1],h[v+2]=da.z,_r(h,n,v,h,r.spatialReference,v,1),h[v]-=Cc[0],h[v+1]-=Cc[1],h[v+2]-=Cc[2],s=!0;else{ha[0]=h[v]+Cc[0],ha[1]=h[v+1]+Cc[1],ha[2]=h[v+2]+Cc[2],r.setAltitude(ha,da.z),h[v]=ha[0]-Cc[0],h[v+1]=ha[1]-Cc[1],h[v+2]=ha[2]-Cc[2];const S=BH/r.unitInMeters;(Math.abs(Sb[0]-h[v])>=S||Math.abs(Sb[1]-h[v+1])>=S||Math.abs(Sb[2]-h[v+2])>=S)&&(s=!0)}v+=f,y.offset+=3}return b/=g,{update:s,averageGeometrySampledElevation:b}}const wqe=he.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function xqe(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function zpt(e){const t=e&&e.expression;if(typeof t=="string"){const i=gye(t);if(i!=null)return{cachedResult:i}}return null}async function Bpt(e,t,i){const r=e&&e.expression;if(typeof r!="string")return null;const s=gye(r);if(s!=null)return{cachedResult:s};const n=await cp(),o=n.arcadeUtils,a=o.createSyntaxTree(r);return o.dependsOnView(a)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(a),context:o.createExecContext(null,{sr:t}),modules:n}}}function fye(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function VH(e,t){if(e!=null&&!mye(e)){if(!t||!e.arcade)return void wqe.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=sye(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function Tqe(e){if(e!=null){if(mye(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof i!="number"&&(e.cachedResult=0,i=0),i}return 0}function Vpt(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||r==="0"||(i=null),i}const Sqe={cachedResult:0};function mye(e){return e.cachedResult!=null}function gye(e){return e==="0"?0:null}class xc{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=z4e(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=Tqe(r)*this._metersPerElevationInfoUnit),i/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=k4e(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=gt(t.offset,0)}updateFeatureExpressionInfoContext(t,i,r){if(O(t))return void(this._featureExpressionInfoContext=null);const s=t&&t.arcade;s&&_(i)&&_(r)?(this._featureExpressionInfoContext=xqe(t),VH(this._featureExpressionInfoContext,fye(s.modules,i,r))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){const i=new xc;return _(t)&&i.setFromElevationInfo(t),i}}var At;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OPAQUE=2]="OPAQUE"})(At||(At={}));class Ip{constructor(t,i,r,s,n,o,a,l=null){this.graphics3DSymbolLayer=t,this.stageObject=i,this._uniqueGeometries=r,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=t,this.stageObject=i}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(t,i){this._stageLayer=i,this._stage=t,t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){const t=this._stage;this._stageLayer&&(t.removeMany(this._uniqueMaterials),t.removeMany(this._uniqueGeometries)),t.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)&&i.removeObject(this.stageObject),this.stageObject.dispose(),_(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(t,i){if(O(this._edgeState))return;const r=iee(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==r&&(n.objectTransparency=r,s=!0);s&&this._resetEdgeObject(i),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t])}slicePlaneEnabledChanged(t,i){O(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:t},!i),this._edgeState.properties.slicePlaneEnabled=t)}setVisibility(t){if(this._stage!=null&&this._visible!==t&&(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),_(this._edgeState))){const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)?i.updateObjectVisibility(this.stageObject,t):t&&this._addOrUpdateEdgeObject(i,!1)}}get visible(){return this._visible}alignWithElevation(t,i,r,s){this.elevationAligner!=null&&(_(r)&&VH(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,t,i),this._resetEdgeObject(s))}getCenterObjectSpace(t=M()){return ne(t,mc(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(t=os()){const i=this.stageObject.boundingVolumeObjectSpace;return Ioe(t,i.min),$oe(t,i.max),t}computeAttachmentOrigin(t){if(this.useObjectOriginAsAttachmentOrigin){const i=this.stageObject.transformation;t.render.origin[0]+=i[12],t.render.origin[1]+=i[13],t.render.origin[2]+=i[14],t.render.num++}else for(const i of this.stageObject.geometryRecords)i.computeAttachmentOrigin(Vp)&&(Ue(Vp,Vp,this.stageObject.transformation),pe(t.render.origin,t.render.origin,Vp),t.render.num++)}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=Eqe,l=VL(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];sg[0]=o[p[0]],sg[1]=o[p[1]],sg[2]=o[p[2]],Ue(sg,sg,this.stageObject.transformation),W0[3*h+0]=sg[0],W0[3*h+1]=sg[1],W0[3*h+2]=sg[2]}if(!t(W0,0,l))return null;Ui(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],W0[h+p]),o[p+3]=Math.max(o[p+3],W0[h+p]);c&&r.push({location:W0.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&i.service&&this.elevationContext.mode!=="absolute-height"){Eh(o,Vp);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(i.useViewElevation)p=gt(i.service.getElevation(Vp[0],Vp[1],h),0);else try{const f=zH(o,i);p=gt(await i.service.queryElevation(Vp[0],Vp[1],s,f,h),0)}catch{}Poe(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(t,i){t===vm.Highlight&&i.addObject(this.stageObject,this.stageObject.highlight()),t===vm.MaskOccludee&&i.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(t){t.removeObject(this.stageObject)}_resetEdgeObject(t){if(O(this._edgeState))return;const i=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(i,t):i.removeObject(this.stageObject)}_addOrUpdateEdgeObject(t,i){const r=this._edgeState;if(O(r))return;const s=iee(r.baseMaterial);for(const n of r.edgeMaterials)n.objectTransparency=s;t.addOrUpdateObject3D(this.stageObject,r.edgeMaterials,r.properties,!i).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}}function iee(e){return e.isVisible?e.parameters.transparent?At.TRANSPARENT:At.OPAQUE:At.INVISIBLE}const W0=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],sg=M(),Vp=M(),Eqe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var xs;(function(e){e[e.Recreate_Symbol=0]="Recreate_Symbol",e[e.Recreate_Graphics=1]="Recreate_Graphics",e[e.Fast_Update=2]="Fast_Update"})(xs||(xs={}));class GH{constructor(t){this.schedule=t,this._loadStatus=Xl.LOADING,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(t,i){return this._loadStatus===Xl.LOADED?(t&&t(),this._loader):this._loadStatus===Xl.FAILED?(i&&i(this._loadError),this._loader):(O(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=Xl.LOADED},r=>{throw this._loadError=r,this._abortController=null,this._loadStatus=Xl.FAILED,!vr(r)&&this.logger&&r.message&&this.logger.warn(r.message),r})),this._loader.then(t,i).catch(()=>{}),this._loader)}abortLoad(){_(this._abortController)?this._abortController=xu(this._abortController):this._loadStatus===Xl.LOADING&&(this._loadStatus=Xl.FAILED),this._loader=null}}var Xl;(function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"})(Xl||(Xl={}));function Aqe(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function yye(e,t){const i=(r,s,n=!1)=>({levels:r.map(o=>{const a=s(o.tesselation);return n&&Wa.cgToGIS(a),{components:[{geometry:a,material:t}],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],r=>Wa.createPolySphereGeometry(.5,r,!0));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Wa.createBoxGeometry(1));case"cone":return i(wU,r=>Wa.createConeGeometry(1,.5,r,!1),!0);case"inverted-cone":return i(wU,r=>Wa.createConeGeometry(1,.5,r,!0),!0);case"cylinder":return i(wU,r=>Wa.createCylinderGeometry(1,.5,r,[0,0,1],[0,0,.5]));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Wa.createTetrahedronGeometry(1),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Wa.createDiamondGeometry(1),!0);default:return}}const wU=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function Cqe(e){return e.type==="fill"}function Rqe(e){return e.type==="extrude"}function Oqe(e){return e&&e.enabled&&(Rqe(e)||Cqe(e))&&_(e.edges)}function Mqe(e){return e&&e.enabled&&e.edges||null}function vye(e,t){return Pqe(Mqe(e),t)}function Pqe(e,t){if(O(e))return null;const i=_(e.color)?l7(Qe.toUnitRGBA(e.color)):yi(0,0,0,0),r=ao(e.size),s=ao(e.extensionLength);switch(e.type){case"solid":return Iqe(I({color:i,size:r,extensionLength:s},t));case"sketch":return $qe(I({color:i,size:r,extensionLength:s},t));default:return}}function Iqe(e){return me(I(I({},Dqe),e),{type:"solid"})}function $qe(e){return me(I(I({},Lqe),e),{type:"sketch"})}const Dqe={color:yi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:At.OPAQUE},Lqe={color:yi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:At.OPAQUE};function WM(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.material)})}),wL(t)}function Nqe(e){const t=new Array;return e.levels.forEach(i=>{i.components.forEach(r=>{r.textures&&t.push(...r.textures)})}),wL(t)}function jH(e){const t=[];return e.components.forEach(i=>{t.push(i.geometry)}),wL(t)}function Fqe(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.geometry)})}),wL(t)}function Uqe(e){return jH(e).reduce((t,i)=>t+i.indexCount/3,0)}const HH={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Gpt(e){return e.type==="web-style"?HH:qH(e.symbolLayers.toArray().map(t=>_ye(e,t)))}function qH(e){let t=0,i=0,r=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of e)O(a)||(t+=a.primitivesPerFeature,i+=a.primitivesPerCoordinate,r+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:o,numComplexities:n}}function jpt(e){const t=qH(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const ree={};function _ye(e,t){const i=bye(e,t),r=Oqe(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return e.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:_(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:me(I({},kqe(t.resource&&t.resource.primitive||nae)),{memory:i});case"path":{let a=0,l=0;switch(t.profile){case"circle":a=10;break;case"quad":a=4;break;default:return void(t.profile,void 0)}switch(t.join){case"round":l=3;break;case"miter":case"bevel":l=1;break;default:return void(t.join,void 0)}const c=2*a,h=a*l*2;let p=-2*h-c;switch(t.cap){case"none":break;case"butt":case"square":p+=2*(a-1);break;case"round":p+=2*(a*(3-1)*2+a);break;default:return}return{primitivesPerFeature:p,primitivesPerCoordinate:h+c,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function bye(e,t){const i=e.type==="point-3d";switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Ho.EXTRUDE_EDGES:Ho.EXTRUDE;case"fill":return _(t.outline)&&t.outline.size>0?Ho.FILL_OUTLINE:Ho.FILL;case"water":return Ho.FILL;case"line":return t.join==="round"?Ho.LINE_ROUND:Ho.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Ho.PATH_ROUND_CIRCLE;case"quad":return Ho.PATH_ROUND_QUAD;default:return void(t.profile,void 0)}case"miter":case"bevel":switch(t.profile){case"circle":return Ho.PATH_MITER_CIRCLE;case"quad":return Ho.PATH_MITER_QUAD;default:return void(t.profile,void 0)}default:return void(t.join,void 0)}case"object":return i?Ho.OBJECT_POINT:Ho.OBJECT_POLYGON;case"icon":case"text":return i?Ho.ICON_POINT:Ho.ICON_POLYGON;default:return}}function kqe(e){let t=ree[e];if(t)return t;const i=yye(e,null);return t={primitivesPerFeature:jH(i.levels[0]).reduce((r,s)=>r+s.indices.get(E.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},ree[e]=t,t}const Ho={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},XM=he.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class $p extends GH{constructor(t,i,r,s){super(r.schedule),this._context=r,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=XM,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=t,this.symbolLayer=i,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new xc,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=see(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(t){if(this._ignoreDrivers)return!1;const i=this._drivenProperties,r=see(t);return r.color!==i.color||r.opacity!==i.opacity||r.opacityAlwaysOpaque!==i.opacityAlwaysOpaque||r.size!==i.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(t,i,r,s){const n=t.projectionSuccess,o="polygons"in t?t.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!i.length||i.length===1&&!i[0].length?l=`${a} (no ${r} were defined)`:Array.isArray(i)&&Array.isArray(i[0])?o&&o.length===0&&r==="rings"&&i.length>0&&i[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (${r} should be defined as a 2D array)`:l=`${a} (failed to project geometry to view spatial reference)`,l&&XM.warnOncePerTick(l)}_validateGeometry(t,i=null,r=null){if(_(i)&&!i.includes(t.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${t.type}`),!1;if(t.type==="point"){const s=t;if(!isFinite(s.x)||!isFinite(s.y))return XM.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return zqe}_defaultElevationInfoZ(){return Bqe}_updateElevationContext(){_(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(t){return t.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(t,i=this.getDefaultElevationInfo(t)){return this._elevationContext.mode||i.mode}setElevationInfoOverride(t){this._elevationInfoOverride=t,this._updateElevationContext()}setGraphicElevationContext(t,i){const r=t.geometry,s=this.getDefaultElevationInfo(r);i.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,i.mode=this.getGeometryElevationMode(r,s),i.offsetMeters=gt(this._elevationContext.meterUnitOffset,gt(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&i.mode==="on-the-ground";n&&(i.mode="relative-to-ground",i.offsetMeters=0);const o=n?Sqe:this._elevationContext.featureExpressionInfoContext;return i.updateFeatureExpressionInfoContext(o,t,this._context.layer),i}prepareSymbolLayerPatch(t){}updateGeometry(t,i){return!1}onRemoveGraphic(t){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;const t=this._context.layer.opacity;return t==null?1:t}_getCombinedOpacity(t,i=nee){let r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||(_(t)?r*=t.a:i.hasIntrinsicColor||(r=0)),r}_getCombinedOpacityAndColor(t,i=nee){const r=this._getCombinedOpacity(t,i);if(this._drivenProperties.color)return $A(null,r);const s=_(t)?Qe.toUnitRGB(t):Kd;return $A(s,r)}_getVertexOpacityAndColor(t,i=null){const r=this._drivenProperties.color?t.color:null,s=this._drivenProperties.opacity?t.opacity:null,n=$A(r,s);return _(i)&&(n[0]*=i,n[1]*=i,n[2]*=i,n[3]*=i),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return _ye(this.symbol,this.symbolLayer)}globalPropertyChanged(t,i,r){switch(t){case"opacity":return this.layerOpacityChanged(i,r);case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(i,r,s)!==yr.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(i,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(t,i,r){let s=yr.UPDATE;return t.forEach(n=>{const o=i(n);if(_(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=r(o.elevationContext.mode)}else s=yr.RECREATE}),s}applyRendererDiff(t,i){return xs.Recreate_Symbol}getFastUpdateAttrValues(t){if(!this._fastUpdates.enabled)return null;const i=this._fastUpdates.visualVariables,r=i.size?sm(i.size.field,t):0,s=i.color?sm(i.color.field,t):0,n=i.opacity?sm(i.opacity.field,t):0;return yi(r,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(t){return this._draped==null?(this._draped=t,!0):(t!==this.draped&&XM.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function sm(e,t){const i=e!=null?t.attributes[e]:0;return i!=null&&isFinite(i)?i:0}function see(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(i=>{switch(i.type){case"color":if(t.color=!0,i.stops)for(let r=0;r<i.stops.length;r++){const s=i.stops[r].color;s&&(t.opacity=!0,s.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}}),t}const zqe={mode:"on-the-ground",offset:0,unit:"meters"},Bqe={mode:"absolute-height",offset:0,unit:"meters"},nee={hasIntrinsicColor:!1};class P1{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,i,r,s,n,o){this.id=va(),this.geometry=t,this.material=i,this.transformation=r,this.instanceParameters=s,this.origin=n,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return _(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(Ue(t,t,this.getStaticTransformation()),!0)}}P1.pool=new Gr(P1);class ZD{constructor(t){this.channel=t,this.id=va()}}class Bm extends WR{constructor(t={}){super(),this.type=Wh.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Te(),this._bvObjectSpace=new oee,this._bvWorldSpace=new oee,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=t.castShadow==null||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new wye),this.transformation=Te();const{geometries:i,materials:r,transformations:s,origins:n}=t;if(Array.isArray(i)){ot(r.length===i.length,"Object3D: materials don't match geometries"),ot(s.length===i.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=i.length,this._geometries.length=i.length;for(let o=0;o<i.length;o++)this._geometries[o]=i[o],this._geometryRecords[o]=P1.pool.acquire(i[o],r[o],j_(s[o]),{highlights:null,occludees:null,visible:this._visible},n&&n[o])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){Lr(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){ot(this._parentLayer==null||t==null,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,i,r,s,n){r=r||ss,this._geometries.push(t);const o=P1.pool.acquire(t,i,r,{highlights:null,occludees:null,visible:this._visible},s,n);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||_(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const i=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=_(i.shaderTransformation)?this._geometryRecords.some(r=>_(r.shaderTransformation)):this._hasVolatileTransformation,i.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:i}),this._invalidateBoundingVolume(),i}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const i of this._geometryRecords)i.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new ZD(vm.MaskOccludee);for(const i of this._geometryRecords)i.instanceParameters.occludees=O8(i.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const i of this._geometryRecords)i.instanceParameters.occludees=M8(i.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new ZD(vm.Highlight);for(const i of this._geometryRecords)i.instanceParameters.highlights=O8(i.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const i of this._geometryRecords)i.instanceParameters.highlights=M8(i.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,i){return ur(gt(i,Te()),this.transformation,t.getStaticTransformation())}_getCombinedShaderTransformation(t,i){return i=i||Te(),ur(i,this.transformation,t.getShaderTransformation()),i}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s],o=this._geometryRecords[s],a=n.boundingInfo;_(a)&&(this._calculateTransformedBoundingVolume(a,this._bvObjectSpace,o.getShaderTransformation()),this._calculateTransformedBoundingVolume(a,this._bvWorldSpace,this._getCombinedShaderTransformation(o)))}Ss(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Ss(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const t=M(),i=M(),r=r1(this.transformation);for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s].boundingInfo;if(O(n))continue;const o=this._geometryRecords[s].getShaderTransformation(),a=r1(o);Ue(t,n.getCenter(),o);const l=xi(t,this._bvObjectSpace.bounds),c=n.getBSRadius()*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),Ue(i,t,this.transformation);const h=xi(i,this._bvWorldSpace.bounds),p=c*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,i,r){const s=t.getBBMin(),n=t.getBBMax(),o=Ts(s),a=Ts(n);Ue(o,o,r),Ue(a,a,r);for(let l=0;l<3;++l)i.min[l]=Math.min(i.min[l],o[l],a[l]),i.max[l]=Math.max(i.max[l],o[l],a[l]);for(let l=0;l<3;++l){ne(o,s),ne(a,n),o[l]=n[l],a[l]=s[l],Ue(o,o,r),Ue(a,a,r);for(let c=0;c<3;++c)i.min[c]=Math.min(i.min[c],o[c],a[c]),i.max[c]=Math.max(i.max[c],o[c],a[c])}}_invalidateBoundingVolume(){this._bvDirty=!0,_(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,i){_(this._parentLayer)&&this._parentLayer.events.emit(t,i)}get test(){const t=this;return{hasGeometry:i=>t._geometries.indexOf(i)>-1,getGeometryIndex:i=>t._geometries.indexOf(i)}}}class wye{constructor(){this.min=je(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=je(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class oee extends wye{constructor(){super(...arguments),this.bounds=vn()}init(){oe(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),oe(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),Ule(this.bounds)}}const Uy=M();function WH(e,t,i,r,s,n,o,a){const l=i?i.length:0,c=e.clippingExtent;if(Qs(t,Uy,e.elevationProvider.spatialReference),_(c)&&!RG(c,Uy))return null;Qs(t,Uy,e.renderCoordsHelper.spatialReference);const h=e.localOriginFactory.getOrigin(Uy),p=new Bm({castShadow:!1,metadata:{layerUid:n,graphicUid:o,usesVerticalDistanceToGround:!0}});for(let f=0;f<l;f++){const g=ss;p.addGeometry(i[f],r[f],g,h,a)}return{object:p,sampledElevation:cqe(p,t,e.elevationProvider,e.renderCoordsHelper,s)}}function ZC(e,t,i){const r=e.elevationContext,s=i.spatialReference;Qs(t,Uy,s),r.centerPointInElevationSR=zm(Uy[0],Uy[1],t.hasZ?Uy[2]:0,s)}function QC(e){switch(e.type){case"point":return e;case"polygon":case"extent":return kH(e);case"polyline":{const t=e.paths[0];if(!t||t.length===0)return null;const i=Mne(t,One(t)/2);return zm(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function XH(){return new Float32Array(2)}function Vqe(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t}function lu(e,t){const i=new Float32Array(2);return i[0]=e,i[1]=t,i}function Gqe(e,t){return new Float32Array(e,t,2)}function xye(){return XH()}function Tye(){return lu(1,1)}function Sye(){return lu(1,0)}function Eye(){return lu(0,1)}const jqe=xye(),Hqe=Tye(),qqe=Sye(),Wqe=Eye();Object.freeze({__proto__:null,create:XH,clone:Vqe,fromValues:lu,createView:Gqe,zeros:xye,ones:Tye,unitX:Sye,unitY:Eye,ZEROS:jqe,ONES:Hqe,UNIT_X:qqe,UNIT_Y:Wqe});function Xqe(e){const t=new Ri;return t.include(tH),t.include(Sge,e),t.include(Rr,e),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?x`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?x`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:x`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?x`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:x`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?x`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:x`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("uColor","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(Fge,e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(x`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?x`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:x`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function Aye(e,t,i){aee(e,"uColor",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),t.borderColor!==null?(aee(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}function aee(e,t,i){i.length===3?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}const Yqe=Object.freeze({__proto__:null,build:Xqe,bindLineCalloutUniforms:Aye});class uF extends Vi{initializeProgram(t){const i=uF.shader.get(),r=this.configuration,s=i.build({occlusionTestEnabled:r.occlusionTestEnabled,verticalOffsetEnabled:r.verticalOffset,screenSizePerspectiveEnabled:r.screenSizePerspective,depthHudEnabled:r.depthHudEnabled,depthHudAlignStartEnabled:r.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:t.viewingMode,isDraped:!1,multipassGeometryEnabled:r.multipassGeometryEnabled});return new Oi(t.rctx,s,mi)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),Aye(this.program,t,i.camera.pixelRatio||1),NH(this.program,t,i),Ege(this.program,i),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Uge(this.program,i),this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),Zfe(this.program,i),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/i.camera.fullViewport[2],2/i.camera.fullViewport[3]);const r=i.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(t.size)*r),WC(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(t){Op(this.program,t),R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),rb(this.program,this.configuration,t),this.program.rebindTextures()}setPipelineState(t){const i=t?Di.ALWAYS:Di.LESS;return this.configuration.depthHudEnabled?Rt({depthTest:{func:i},depthWrite:Aa}):Rt({blending:Vn(Ee.ONE,Ee.SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:i},colorWrite:Ft})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}uF.shader=new Li(Yqe,()=>import("./LineCallout.glsl.1b478a9c.js"));class wf extends dr{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=al.World,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}u([Y()],wf.prototype,"occlusionTestEnabled",void 0),u([Y()],wf.prototype,"verticalOffset",void 0),u([Y()],wf.prototype,"screenSizePerspective",void 0),u([Y()],wf.prototype,"depthHudEnabled",void 0),u([Y()],wf.prototype,"depthHudAlignStartEnabled",void 0),u([Y({count:al.COUNT})],wf.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([Y()],wf.prototype,"slicePlaneEnabled",void 0),u([Y()],wf.prototype,"multipassGeometryEnabled",void 0);class D_ extends Zh{constructor(t){super(t,Qqe),this.techniqueConfig=new wf,this._uniqueMaterialIdentifier=D_.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(t,i){const r=(i==null?void 0:i.slot)!==ye.LINE_CALLOUTS;return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=r,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?al.Screen:al.World,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!i&&i.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(t){switch(t){case ye.LINE_CALLOUTS:case ye.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(t){return t.output===j.Color?new Zqe(t):null}createBufferWriter(){return new Kqe}validateParameters(t){const i=D_.uniqueMaterialIdentifier(t);i!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=i)}static uniqueMaterialIdentifier(t){return JSON.stringify({screenOffset:t.screenOffset||[0,0],centerOffsetUnits:t.centerOffsetUnits||"world"})}}class Zqe extends Nm{updateParameters(t){return this.ensureTechnique(uF,t)}beginSlot(t){return this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const Qqe=I({verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1},Du),Jqe=Nr().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4f(E.AUXPOS1),lee=[lu(0,0),lu(1,0),lu(0,1),lu(1,0),lu(1,1),lu(0,1)];class Kqe{constructor(){this.vertexBufferLayout=Jqe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(E.POSITION).length}write(t,i,r,s){KR(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,6),PH(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,t.invTranspTransformation,r.normal,s,6),BT(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,r.auxpos1,s,6);for(let n=0;n<lee.length;++n)r.uv0.setVec(s+n,lee[n])}}class hF extends $p{constructor(t,i){super(t,null,i,iWe),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new D_(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(t){const i=this.materialParameters;return i.screenOffset=t.screenOffset||[0,0],i.centerOffsetUnits=t.centerOffsetUnits||"world",i}get materialParameters(){const t=this.symbol,i=t.callout,r=_(i.color)?Qe.toUnitRGBA(i.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const s=ao(i.size||0);let n=null;if(t.verticalOffset){const{screenLength:p,minWorldLength:f,maxWorldLength:g}=t.verticalOffset;n={screenLength:ao(p),minWorldLength:f||0,maxWorldLength:g!=null?g:1/0}}const o=_(i.border)&&_(i.border.color)?Qe.toUnitRGBA(i.border.color):null,a=t.symbolLayers.getItemAt(0).type==="object",l=!a,c=a?0:void 0,h=t.type==="label-3d";return{color:r,size:s,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:o,occlusionTest:l,shaderPolygonOffset:c,depthHUDAlignStart:h,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:Du.renderOccluded}}_defaultElevationInfoNoZ(){return tWe}createGraphics3DGraphic(t){const i=t.renderingInfo,r=t.graphic,s=this.setGraphicElevationContext(r,new xc,i.elevationOffset||0),n=i.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!uae(l)))return null;const a=kH(r.geometry);return O(a)?null:this._createAs3DShape(a,s,i,r.uid)}layerOpacityChanged(){return O(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=rO(hF.elevationModeChangeTypes,r,s);return n!==yr.UPDATE||t.forEach(o=>{const a=i(o);_(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return O(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=Mu(i.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:HH.memory}}_createVertexData(t){const{translation:i,centerOffset:r}=t,s=i?{size:3,data:[i[0],i[1],i[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},n=r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return[[E.POSITION,s],[E.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[E.AUXPOS1,n]]}_getOrCreateMaterial(t){const i=this._perInstanceMaterialParameters(t),r=D_.uniqueMaterialIdentifier(i);if(_(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(t.materialCollection){let s=t.materialCollection.get(r);return O(s)&&(s=new D_(i),t.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new D_(i),isUnique:!0}}_createAs3DShape(t,i,r,s){const n=[new or(this._createVertexData(r),eWe,wa.Point)],o=this._getOrCreateMaterial(r),a=WH(this._context,t,n,[o.material],i,this._context.layer.uid,s);if(a===null)return null;const l=new Ip(this,a.object,n,o.isUnique?[o.material]:null,null,YC,i);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=a.sampledElevation,l.needsElevationUpdates=Mu(i.mode),ZC(l,t,this._context.elevationProvider),l}}hF.elevationModeChangeTypes={definedChanged:yr.UPDATE,staysOnTheGround:yr.UPDATE,onTheGroundChanged:yr.RECREATE};const xU=new Uint16Array([0]),eWe=[[E.POSITION,xU],[E.NORMAL,xU],[E.AUXPOS1,xU]],tWe={mode:"relative-to-ground",offset:0},iWe={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},cee=he.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function rWe(e,t){if(!jG(e))return cee.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=sWe[e.callout.type];return i?new i(e,t):(cee.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const sWe={line:hF};class nWe{constructor(t,i,r){this.graphic=t,this.renderingInfo=i,this.layer=r}}const uee=new Gr(Array,e=>BL(e,Doe),null,10,5),oWe=Dt();class aWe{constructor(t,i,r,s,n){this.graphic=t,this.graphics3DSymbol=i,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=lWe(hn._COUNT,Kl._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?fye(n,t,s):null;for(const o of r)_(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(t,i,r){this._layer=i,this._stage=t,this._forEachSymbolLayerGraphic(s=>{s.initialize(t,i,r),s.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(t=>t.destroy()),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.graphics==null}clearLabelGraphics(){this._forEachLabelGraphic(t=>t.destroy()),this._labelGraphics.length=0}addLabelGraphic(t,i,r){this._labelGraphics.push(t),t.initialize(i,r),t.setVisibility(this.isVisible(hn.LABEL))}addAuxiliaryGraphic(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._stage,this._layer),t.setVisibility(this.isVisible()))}get isDraped(){let t=!1;return this._forEachSymbolLayerGraphic(i=>{i.type==="draped"&&(t=!0)}),t}isVisible(t=hn.GRAPHIC,i){for(let r=0;r<=t;r++){const s=this._visibilityFlags[r];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==i)return!1}return!0}hasVisibilityFlag(t,i){return this._visibilityFlags[i][t]!=null}setVisibilityFlag(t,i,r){const s=this.isVisible(r);this._visibilityFlags[r][t]=i;const n=this.isVisible(r);if(s===n)return!1;if(r===hn.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(hn.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(t,i=hn.GRAPHIC){return this.setVisibilityFlag(t,void 0,i)}computeExtent(t){if(!this._extent){const i=this.graphic.geometry;if(O(i))return!1;this._extent=Dt(),ZHe(i,this._extent);const r=i.spatialReference;if(!r.equals(t)&&!sN(this._extent,r,this._extent,t))return this._extent=null,!1}return!0}getAsOptimizedGeometry(t,i){return _(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===t&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,t,i),this._optimizedGeometry.hasZ=t,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(t,i,r){let s=t.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=dc.fromExtent(s.type==="mesh"?s.extent:s)),LIe(s,i,r)}get usedMemory(){let t=ble(this.graphic.attributes);return this._forEachSymbolLayerGraphic(i=>{const r=i.graphics3DSymbolLayer.complexity;if(O(r))return;const s=i.type==="draped"?r.memory.draped:r.memory;t+=s.bytesPerFeature,s.bytesPerCoordinate&&(t+=YHe(this.graphic.geometry)*s.bytesPerCoordinate)}),t}computeAttachmentOrigin(){const t={render:{origin:M(),num:0},draped:{origin:Xe(),num:0}};for(const i of this.graphics)O(i)||i.computeAttachmentOrigin(t);return t.render.num&&ae(t.render.origin,t.render.origin,1/t.render.num),t.draped.num&&tl(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(t,i,r,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Ui(n.boundingBox):n.boundingBox=Ui(),n.requiresDrapedElevation=!1,await ZL(this.graphics,async o=>{if(O(o))return;const a=o.type==="draped"?i:t,l=uee.acquire(),c=await o.getProjectedBoundingBox(a,r,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&nT(n.boundingBox,l),uee.release(l)}),OSe(n.boundingBox)||t6(OG(n.boundingBox,oWe))?n:null}needsElevationUpdates(){for(const t of this.graphics)if(_(t)&&(t.type==="object3d"||t.type==="lod-instance")&&t.needsElevationUpdates)return!0;for(const t of this._labelGraphics)if(t&&t.needsElevationUpdates)return!0;return!1}alignWithElevation(t,i,r){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(t,i,this._featureExpressionFeature,r)})}addObjectStateSet(t,i){this._forEachSymbolLayerGraphic(r=>r.addObjectState(t,i))}removeObjectState(t){this._forEachSymbolLayerGraphic(i=>i.removeObjectState(t))}_forEachGraphicList(t,i){t.forEach(r=>r&&i(r))}_forEachSymbolLayerGraphic(t){this._forEachGraphicList(this.graphics,t),this._forEachGraphicList(this._auxiliaryGraphics,t)}_forEachLabelGraphic(t){this._forEachGraphicList(this._labelGraphics,t)}_forEachRenderedGraphic(t){this._forEachSymbolLayerGraphic(t),this._forEachLabelGraphic(t)}}function lWe(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}var hee,dee,pee,Cye={exports:{}};hee=Cye,dee=function(){function e($,F,k){k=k||2;var G,q,K,H,ee,ge,Ae,Be=F&&F.length,Se=Be?F[0]*k:$.length,xe=t($,0,Se,k,!0),Re=[];if(!xe||xe.next===xe.prev)return Re;if(Be&&(xe=l($,F,xe,k)),$.length>80*k){G=K=$[0],q=H=$[1];for(var ke=k;ke<Se;ke+=k)(ee=$[ke])<G&&(G=ee),(ge=$[ke+1])<q&&(q=ge),ee>K&&(K=ee),ge>H&&(H=ge);Ae=(Ae=Math.max(K-G,H-q))!==0?1/Ae:0}return r(xe,Re,k,G,q,Ae),Re}function t($,F,k,G,q){var K,H;if(q===ie($,F,k,G)>0)for(K=F;K<k;K+=G)H=J(K,$[K],$[K+1],H);else for(K=k-G;K>=F;K-=G)H=J(K,$[K],$[K+1],H);if(H&&C(H,H.next)){var ee=H.next;Z(H),H=ee}return H}function i($,F){if(!$)return $;F||(F=$);var k,G=$;do if(k=!1,G.steiner||!C(G,G.next)&&A(G.prev,G,G.next)!==0)G=G.next;else{var q=G.prev;if(Z(G),(G=F=q)===G.next)break;k=!0}while(k||G!==F);return F}function r($,F,k,G,q,K,H){if($){!H&&K&&y($,G,q,K);for(var ee,ge,Ae=$;$.prev!==$.next;)if(ee=$.prev,ge=$.next,K?n($,G,q,K):s($))F.push(ee.i/k),F.push($.i/k),F.push(ge.i/k),Z($),$=ge.next,Ae=ge.next;else if(($=ge)===Ae){H?H===1?r($=o(i($),F,k),F,k,G,q,K,2):H===2&&a($,F,k,G,q,K):r(i($),F,k,G,q,K,1);break}}}function s($){var F=$.prev,k=$,G=$.next;if(A(F,k,G)>=0)return!1;for(var q=$.next.next;q!==$.prev;){if(S(F.x,F.y,k.x,k.y,G.x,G.y,q.x,q.y)&&A(q.prev,q,q.next)>=0)return!1;q=q.next}return!0}function n($,F,k,G){var q=$.prev,K=$,H=$.next;if(A(q,K,H)>=0)return!1;for(var ee=q.x<K.x?q.x<H.x?q.x:H.x:K.x<H.x?K.x:H.x,ge=q.y<K.y?q.y<H.y?q.y:H.y:K.y<H.y?K.y:H.y,Ae=q.x>K.x?q.x>H.x?q.x:H.x:K.x>H.x?K.x:H.x,Be=q.y>K.y?q.y>H.y?q.y:H.y:K.y>H.y?K.y:H.y,Se=b(ee,ge,F,k,G),xe=b(Ae,Be,F,k,G),Re=$.prevZ,ke=$.nextZ;Re&&Re.z>=Se&&ke&&ke.z<=xe;){if(Re!==$.prev&&Re!==$.next&&S(q.x,q.y,K.x,K.y,H.x,H.y,Re.x,Re.y)&&A(Re.prev,Re,Re.next)>=0||(Re=Re.prevZ,ke!==$.prev&&ke!==$.next&&S(q.x,q.y,K.x,K.y,H.x,H.y,ke.x,ke.y)&&A(ke.prev,ke,ke.next)>=0))return!1;ke=ke.nextZ}for(;Re&&Re.z>=Se;){if(Re!==$.prev&&Re!==$.next&&S(q.x,q.y,K.x,K.y,H.x,H.y,Re.x,Re.y)&&A(Re.prev,Re,Re.next)>=0)return!1;Re=Re.prevZ}for(;ke&&ke.z<=xe;){if(ke!==$.prev&&ke!==$.next&&S(q.x,q.y,K.x,K.y,H.x,H.y,ke.x,ke.y)&&A(ke.prev,ke,ke.next)>=0)return!1;ke=ke.nextZ}return!0}function o($,F,k){var G=$;do{var q=G.prev,K=G.next.next;!C(q,K)&&R(q,G,G.next,K)&&z(q,K)&&z(K,q)&&(F.push(q.i/k),F.push(G.i/k),F.push(K.i/k),Z(G),Z(G.next),G=$=K),G=G.next}while(G!==$);return i(G)}function a($,F,k,G,q,K){var H=$;do{for(var ee=H.next.next;ee!==H.prev;){if(H.i!==ee.i&&T(H,ee)){var ge=B(H,ee);return H=i(H,H.next),ge=i(ge,ge.next),r(H,F,k,G,q,K),void r(ge,F,k,G,q,K)}ee=ee.next}H=H.next}while(H!==$)}function l($,F,k,G){var q,K,H,ee=[];for(q=0,K=F.length;q<K;q++)(H=t($,F[q]*G,q<K-1?F[q+1]*G:$.length,G,!1))===H.next&&(H.steiner=!0),ee.push(w(H));for(ee.sort(c),q=0;q<ee.length;q++)k=i(k=p(ee[q],k),k.next);return k}function c($,F){return $.x-F.x}function h($){if($.next.prev===$)return $;let F=$;for(;;){const k=F.next;if(k.prev===F||k===F||k===$)break;F=k}return F}function p($,F){var k=f($,F);if(!k)return F;var G=B(k,$),q=i(k,k.next);let K=h(G);return i(K,K.next),q=h(q),h(F===k?q:F)}function f($,F){var k,G=F,q=$.x,K=$.y,H=-1/0;do{if(K<=G.y&&K>=G.next.y&&G.next.y!==G.y){var ee=G.x+(K-G.y)*(G.next.x-G.x)/(G.next.y-G.y);if(ee<=q&&ee>H){if(H=ee,ee===q){if(K===G.y)return G;if(K===G.next.y)return G.next}k=G.x<G.next.x?G:G.next}}G=G.next}while(G!==F);if(!k)return null;if(q===H)return k;var ge,Ae=k,Be=k.x,Se=k.y,xe=1/0;G=k;do q>=G.x&&G.x>=Be&&q!==G.x&&S(K<Se?q:H,K,Be,Se,K<Se?H:q,K,G.x,G.y)&&(ge=Math.abs(K-G.y)/(q-G.x),z(G,$)&&(ge<xe||ge===xe&&(G.x>k.x||G.x===k.x&&g(k,G)))&&(k=G,xe=ge)),G=G.next;while(G!==Ae);return k}function g($,F){return A($.prev,$,F.prev)<0&&A(F.next,$,$.next)<0}function y($,F,k,G){var q=$;do q.z===null&&(q.z=b(q.x,q.y,F,k,G)),q.prevZ=q.prev,q.nextZ=q.next,q=q.next;while(q!==$);q.prevZ.nextZ=null,q.prevZ=null,v(q)}function v($){var F,k,G,q,K,H,ee,ge,Ae=1;do{for(k=$,$=null,K=null,H=0;k;){for(H++,G=k,ee=0,F=0;F<Ae&&(ee++,G=G.nextZ);F++);for(ge=Ae;ee>0||ge>0&&G;)ee!==0&&(ge===0||!G||k.z<=G.z)?(q=k,k=k.nextZ,ee--):(q=G,G=G.nextZ,ge--),K?K.nextZ=q:$=q,q.prevZ=K,K=q;k=G}K.nextZ=null,Ae*=2}while(H>1);return $}function b($,F,k,G,q){return($=1431655765&(($=858993459&(($=252645135&(($=16711935&(($=32767*($-k)*q)|$<<8))|$<<4))|$<<2))|$<<1))|(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=32767*(F-G)*q)|F<<8))|F<<4))|F<<2))|F<<1))<<1}function w($){var F=$,k=$;do(F.x<k.x||F.x===k.x&&F.y<k.y)&&(k=F),F=F.next;while(F!==$);return k}function S($,F,k,G,q,K,H,ee){return(q-H)*(F-ee)-($-H)*(K-ee)>=0&&($-H)*(G-ee)-(k-H)*(F-ee)>=0&&(k-H)*(K-ee)-(q-H)*(G-ee)>=0}function T($,F){return $.next.i!==F.i&&$.prev.i!==F.i&&!N($,F)&&(z($,F)&&z(F,$)&&V($,F)&&(A($.prev,$,F.prev)||A($,F.prev,F))||C($,F)&&A($.prev,$,$.next)>0&&A(F.prev,F,F.next)>0)}function A($,F,k){return(F.y-$.y)*(k.x-F.x)-(F.x-$.x)*(k.y-F.y)}function C($,F){return $.x===F.x&&$.y===F.y}function R($,F,k,G){var q=U(A($,F,k)),K=U(A($,F,G)),H=U(A(k,G,$)),ee=U(A(k,G,F));return q!==K&&H!==ee||!(q!==0||!L($,k,F))||!(K!==0||!L($,G,F))||!(H!==0||!L(k,$,G))||!(ee!==0||!L(k,F,G))}function L($,F,k){return F.x<=Math.max($.x,k.x)&&F.x>=Math.min($.x,k.x)&&F.y<=Math.max($.y,k.y)&&F.y>=Math.min($.y,k.y)}function U($){return $>0?1:$<0?-1:0}function N($,F){var k=$;do{if(k.i!==$.i&&k.next.i!==$.i&&k.i!==F.i&&k.next.i!==F.i&&R(k,k.next,$,F))return!0;k=k.next}while(k!==$);return!1}function z($,F){return A($.prev,$,$.next)<0?A($,F,$.next)>=0&&A($,$.prev,F)>=0:A($,F,$.prev)<0||A($,$.next,F)<0}function V($,F){var k=$,G=!1,q=($.x+F.x)/2,K=($.y+F.y)/2;do k.y>K!=k.next.y>K&&k.next.y!==k.y&&q<(k.next.x-k.x)*(K-k.y)/(k.next.y-k.y)+k.x&&(G=!G),k=k.next;while(k!==$);return G}function B($,F){var k=new te($.i,$.x,$.y),G=new te(F.i,F.x,F.y),q=$.next,K=F.prev;return $.next=F,F.prev=$,k.next=q,q.prev=k,G.next=k,k.prev=G,K.next=G,G.prev=K,G}function J($,F,k,G){var q=new te($,F,k);return G?(q.next=G.next,q.prev=G,G.next.prev=q,G.next=q):(q.prev=q,q.next=q),q}function Z($){$.next.prev=$.prev,$.prev.next=$.next,$.prevZ&&($.prevZ.nextZ=$.nextZ),$.nextZ&&($.nextZ.prevZ=$.prevZ)}function te($,F,k){this.i=$,this.x=F,this.y=k,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ie($,F,k,G){for(var q=0,K=F,H=k-G;K<k;K+=G)q+=($[H]-$[K])*($[K+1]+$[H+1]),H=K;return q}return e.deviation=function($,F,k,G){var q=F&&F.length,K=q?F[0]*k:$.length,H=Math.abs(ie($,0,K,k));if(q)for(var ee=0,ge=F.length;ee<ge;ee++){var Ae=F[ee]*k,Be=ee<ge-1?F[ee+1]*k:$.length;H-=Math.abs(ie($,Ae,Be,k))}var Se=0;for(ee=0;ee<G.length;ee+=3){var xe=G[ee]*k,Re=G[ee+1]*k,ke=G[ee+2]*k;Se+=Math.abs(($[xe]-$[ke])*($[Re+1]-$[xe+1])-($[xe]-$[Re])*($[ke+1]-$[xe+1]))}return H===0&&Se===0?0:Math.abs((Se-H)/H)},e.flatten=function($){for(var F=$[0][0].length,k={vertices:[],holes:[],dimensions:F},G=0,q=0;q<$.length;q++){for(var K=0;K<$[q].length;K++)for(var H=0;H<F;H++)k.vertices.push($[q][K][H]);q>0&&(G+=$[q-1].length,k.holes.push(G))}return k},e},(pee=dee())!==void 0&&(hee.exports=pee);const jT=Cye.exports,dF=he.getLogger("esri.views.3d.support.buffer.math");function nO(e,t,i){if(e.count!==t.count)return void dF.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[4],l=i[5],c=i[6],h=i[8],p=i[9],f=i[10],g=i[12],y=i[13],v=i[14],b=e.typedBuffer,w=e.typedBufferStride,S=t.typedBuffer,T=t.typedBufferStride;for(let A=0;A<r;A++){const C=A*w,R=A*T,L=S[R],U=S[R+1],N=S[R+2];b[C]=s*L+a*U+h*N+g,b[C+1]=n*L+l*U+p*N+y,b[C+2]=o*L+c*U+f*N+v}}function I1(e,t,i){if(e.count!==t.count)return void dF.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,b=t.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,A=v[T],C=v[T+1],R=v[T+2];g[S]=s*A+a*C+h*R,g[S+1]=n*A+l*C+p*R,g[S+2]=o*A+c*C+f*R}}function j8(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2]}}function YH(e,t){const i=Math.min(e.count,t.count),r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride;for(let a=0;a<i;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],g=Math.sqrt(h*h+p*p+f*f);if(g>0){const y=1/g;r[l]=y*h,r[l+1]=y*p,r[l+2]=y*f}}}function cWe(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i}}Object.freeze({__proto__:null,transformMat4:nO,transformMat3:I1,scale:j8,normalize:YH,shiftRight:cWe});function pF(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&_(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function uWe(e,t){if(_(e.symbol))return e.symbol;const i=pF(e,t);return _(i)&&i.type!=="dot-density"?i.getSymbol(e,t):null}function Hpt(e,t){const i=pF(e,t),r=uWe(e,t);if(O(r))return null;const s={renderer:i,symbol:r};if(O(i)||!("visualVariables"in i)||!i.visualVariables)return s;const n=lj(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function hWe(e,t){if(_(e.symbol))return e.symbol;const i=pF(e,t);return _(i)&&i.getSymbolAsync(e,me(I({},t),{abortOptions:{signal:t.signal}}))}async function qpt(e,t){const i=pF(e,t),r=await hWe(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=lj(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Qe.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function dWe(e,t=0){const i=e[t];return typeof i=="number"&&isFinite(i)?i:null}function pWe(e){for(let t=0;t<3;t++){const i=e[t];if(typeof i=="number")return isFinite(i)?i:0}return 0}function Rye(e,t,i){var r;const s=e.byteLength/(4*t),n=new Uint32Array(e,0,s*t);let o=new Uint32Array(s);const a=(r=i==null?void 0:i.minReduction)!=null?r:0,l=(i==null?void 0:i.originalIndices)||null,c=l?l.length:0,h=(i==null?void 0:i.componentOffsets)||null;let p=0;if(h)for(let R=0;R<h.length-1;R++){const L=h[R+1]-h[R];L>p&&(p=L)}else p=s;const f=Math.floor(1.1*p)+1;(sd==null||sd.length<2*f)&&(sd=new Uint32Array(Zx(2*f)));for(let R=0;R<2*f;R++)sd[R]=0;let g=0;const y=!!h&&!!l,v=y?c:s,b=y?new Uint32Array(c):null,w=1.96;let S=a!==0?Math.ceil(4*w*w/(a*a)*a*(1-a)):v,T=1,A=h?h[1]:v;for(let R=0;R<v;R++){if(R===S){const B=1-g/R;if(B+w*Math.sqrt(B*(1-B)/R)<a)return null;S*=2}if(R===A){for(let B=0;B<2*f;B++)sd[B]=0;if(l)for(let B=h[T-1];B<h[T];B++)b[B]=o[l[B]];A=h[++T]}const L=y?l[R]:R,U=L*t,N=gWe(n,U,t);let z=N%f,V=g;for(;sd[2*z+1]!==0;){if(sd[2*z]===N){const B=sd[2*z+1]-1;if(fWe(n,U,B*t,t)){V=o[B];break}}z++,z>=f&&(z-=f)}V===g&&(sd[2*z]=N,sd[2*z+1]=L+1,g++),o[L]=V}if(a!==0&&1-g/s<a)return null;if(y){for(let R=h[T-1];R<b.length;R++)b[R]=o[l[R]];o=b}const C=new Uint32Array(t*g);g=0;for(let R=0;R<v;R++)o[R]===g&&(mWe(n,(y?l[R]:R)*t,C,g*t,t),g++);if(l&&!y){const R=new Uint32Array(c);for(let L=0;L<R.length;L++)R[L]=o[l[L]];o=R}return{buffer:C.buffer,indices:o,uniqueCount:g}}function fWe(e,t,i,r){for(let s=0;s<r;s++)if(e[t+s]!==e[i+s])return!1;return!0}function mWe(e,t,i,r,s){for(let n=0;n<s;n++)i[r+n]=e[t+n]}function gWe(e,t,i){let r=0;for(let s=0;s<i;s++)r=e[t+s]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let sd=null;function Wpt(e){const t=oO(e.rings,e.hasZ,yp.CCW_IS_HOLE),i=[];let r=0,s=0;for(const a of t.polygons){const l=a.count,c=a.index,h=new Float64Array(t.position.buffer,3*c*t.position.BYTES_PER_ELEMENT,3*l),p=a.holeIndices.map(g=>g-c),f=new Uint32Array(jT(h,p,3));i.push({position:h,faces:f}),r+=h.length,s+=f.length}const n=yWe(i,r,s),o=Rye(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function yWe(e,t,i){if(e.length===1)return e[0];const r=new Float64Array(t),s=new Uint32Array(i);let n=0,o=0,a=0;for(const l of e){for(let c=0;c<l.position.length;c++)r[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:r,faces:s}}function oO(e,t,i){const r=e.length,s=new Array(r),n=new Array(r),o=new Array(r);let a=0,l=0,c=0,h=0;for(let g=0;g<r;++g)h+=e[g].length;const p=new Float64Array(3*h);let f=0;for(let g=r-1;g>=0;g--){const y=e[g],v=i===yp.CCW_IS_HOLE&&vWe(y);if(v&&r!==1)s[a++]=y;else{let b=y.length;for(let S=0;S<a;++S)b+=s[S].length;const w={index:f,pathLengths:new Array(a+1),count:b,holeIndices:new Array(a)};w.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=v?YM(y,y.length-1,-1,p,f,y.length,t):YM(y,0,1,p,f,y.length,t);for(let S=0;S<a;++S){const T=s[S];w.holeIndices[S]=f,w.pathLengths[S+1]=T.length,T.length>0&&(o[c++]={index:f,count:T.length}),f=YM(T,0,1,p,f,T.length,t)}a=0,w.count>0&&(n[l++]=w)}}for(let g=0;g<a;++g){const y=s[g];y.length>0&&(o[c++]={index:f,count:y.length}),f=YM(y,0,1,p,f,y.length,t)}return l<r&&(n.length=l),c<r&&(o.length=c),{position:p,polygons:n,outlines:o}}function YM(e,t,i,r,s,n,o){s*=3;for(let a=0;a<n;++a){const l=e[t];r[s++]=l[0],r[s++]=l[1],r[s++]=o?l[2]:0,t+=i}return s/3}function vWe(e){return!aG(e,!1,!1)}var yp;(function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(yp||(yp={}));var DA,H8,fx;(function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"})(DA||(DA={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(H8||(H8={})),function(e){e[e.LAYER_VIEW=0]="LAYER_VIEW",e[e.EXTERNAL=1]="EXTERNAL"}(fx||(fx={}));var Jr,so,HT,ln,Xs;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(Jr||(Jr={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(so||(so={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(HT||(HT={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(ln||(ln={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(Xs||(Xs={}));class _We{constructor(t,i){this.vec3=t,this.id=i}}function LA(e,t,i,r){return new _We(je(e,t,i),r)}var On;(function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"})(On||(On={}));class fee{constructor(t,i){this.index=t,this.renderTargets=i,this.extent=Dt(),this.resolution=0,this.renderLocalOrigin=LA(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new wWe,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(i.renderTargets.length).fill(!1)}getValidTarget(t){return this.validTargets[t]?this.renderTargets.getTarget(t):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(t){const i=t===On.ColorAndWater?this.renderTargets.getTarget(ln.Color):t===On.Highlight?this.renderTargets.getTarget(ln.Highlight):this.renderTargets.getTarget(ln.Occluded);return i?i.getTexture():null}getNormalTexture(t){const i=t===On.ColorAndWater?this.renderTargets.getTarget(ln.Water):null;return i?i.getTexture():null}draw(t,i){const r=this.computeRenderTargetValidityBitfield(),s=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)n.type===ln.ColorNoRasterImage&&s===!1?this.validTargets[n.type]=!1:this.validTargets[n.type]=t.drawTarget(this,n,i);return r^this.computeRenderTargetValidityBitfield()?RT.CHANGED:RT.UNCHANGED}computeRenderTargetValidityBitfield(){const t=this.validTargets;return+t[ln.Color]|+t[ln.ColorNoRasterImage]<<1|+t[ln.Highlight]<<2|+t[ln.Water]<<3|+t[ln.Occluded]<<4}setupGeometryViewsCyclical(t){this.setupGeometryViewsDirect();const i=.001*t.range;if(this.extent[0]-i<=t.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];A$(this.extent,t.range,0,r)}if(this.extent[2]+i>=t.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];A$(this.extent,-t.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,i0(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const i=this.canvasGeometries.extents[t];if(i[0]!==i[2]&&i[1]!==i[3])return!0}return!1}applyViewport(t){t.setViewport(this.index===Jr.INNER?0:this.resolution,0,this.resolution,this.resolution)}}function bWe(e,t,i){return Math.min(Zx(Math.max(e,t)+256),i)}class wWe{constructor(){this.extents=[Dt(),Dt(),Dt()],this.numViews=0}}class Oye{constructor(t,i){this.size=XH(),this._fbo=null,this._fbo=new ki(t,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR_MIPMAP_LINEAR,hasMipmap:i,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=et(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(t,i){this.size[0]=t,this.size[1]=i,this._fbo.resize(this.size[0],this.size[1])}bind(t){t.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var t;(t=this._fbo)==null||t.resize(0,0)}get gpuMemoryUsage(){var t,i;return(t=(i=this._fbo)==null?void 0:i.gpuMemoryUsage)!=null?t:0}}class xWe{constructor(t){const i=(r,s,n=!0)=>({type:s,fbo:new Oye(t,n),renderPass:r,valid:!1,lastUsed:1/0});this.renderTargets=[i(De.MATERIAL,ln.Color),i(De.MATERIAL,ln.ColorNoRasterImage),i(De.MATERIAL_HIGHLIGHT,ln.Highlight,!1),i(De.MATERIAL_NORMAL,ln.Water),i(De.MATERIAL,ln.Occluded)]}getTarget(t){return this.renderTargets[t].fbo}dispose(){for(const t of this.renderTargets)t.fbo.dispose()}disposeRenderTargetMemory(){for(const t of this.renderTargets)t.fbo.disposeRenderTargetMemory()}validateUsageForTarget(t,i,r){if(t)i.lastUsed=r;else if(r-i.lastUsed>TWe)i.fbo.disposeRenderTargetMemory(),i.lastUsed=1/0;else if(i.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((t,i)=>t+i.fbo.gpuMemoryUsage,0)}}const TWe=1e3;class ZH{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(t,i){var r;return(r=this._outer.get(t))==null?void 0:r.get(i)}set(t,i,r){const s=this._outer.get(t);s?s.set(i,r):this._outer.set(t,new Map([[i,r]]))}delete(t,i){const r=this._outer.get(t);r&&(r.delete(i),r.size===0&&this._outer.delete(t))}forEach(t){this._outer.forEach((i,r)=>t(i,r))}}class SWe{constructor(t){this.technique=t,this.refCount=0,this.refZeroFrame=0}}class Mye{constructor(t){this._context=t,this._perConstructorInstances=new ZH,this._frameCounter=0,this._keepAliveFrameCount=mee}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach(t=>t.forEach(i=>i.technique.destroy())),this._perConstructorInstances.clear()}acquire(t,i){const r=i.key;let s=this._perConstructorInstances.get(t,r);if(O(s)){const n=new t(this._context,i,()=>this.release(n));s=new SWe(n),this._perConstructorInstances.set(t,r,s)}return++s.refCount,s.technique}releaseAndAcquire(t,i,r){if(_(r)){if(i.key===r.key)return r;this.release(r)}return this.acquire(t,i)}release(t){if(O(t)||this._perConstructorInstances.empty)return;const i=this._perConstructorInstances.get(t.constructor,t.key);O(i)||(--i.refCount,i.refCount===0&&(i.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==mee&&this._perConstructorInstances.forEach((t,i)=>{t.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.destroy(),this._perConstructorInstances.delete(i,s))})})}async reloadAll(){const t=new Array;this._perConstructorInstances.forEach((i,r)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>{l.technique.reload(this._context)}))};t.push(s(i,r))}),await Promise.all(t)}}const mee=-1,fF=e=>{class t extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const s of(r=this._managedDisposables)!=null?r:[]){var r;const n=this[s];this[s]=null,n&&typeof n.dispose=="function"&&n.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}}return t};class mF extends fF(class{}){}function Mn(){return(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=(i=(r=e._managedDisposables)==null?void 0:r.slice())!=null?i:[]),e._managedDisposables.unshift(t)}}class Pye{constructor(){this.adds=new $t,this.removes=new $t,this.updates=new $t({allocator:t=>t||new EWe,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class EWe{}class AWe{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function Iye(e){const t=new Map,i=r=>{let s=t.get(r);return s||(s=new AWe,t.set(r,s)),s};return e.removes.forAll(r=>{TU(r)&&i(r.material).removes.push(r)}),e.adds.forAll(r=>{TU(r)&&i(r.material).adds.push(r)}),e.updates.forAll(r=>{TU(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),t}function TU(e){return e.data.indexCount>=1}class $ye{constructor(t,i){this._material=t,this._repository=i,this._map=new Map}destroy(){this._map.forEach((t,i)=>{_(t)&&this._repository.release(this._material,$1(i))})}load(t,i){this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,$1(i)));const r=this._map.get(i);if(_(r)){if(r.ensureResources(t)===ua.LOADED)return r;this._repository.requestRender()}return null}}function $1(e){switch(e){default:case De.MATERIAL:return j.Color;case De.MATERIAL_ALPHA:return j.Alpha;case De.MATERIAL_DEPTH_SHADOWMAP_ALL:return j.Shadow;case De.MATERIAL_NORMAL:return j.Normal;case De.MATERIAL_DEPTH:return j.Depth;case De.MATERIAL_HIGHLIGHT:return j.Highlight;case De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return j.Shadow}}var Gt;(function(e){var t,i;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(i=e.State||(e.State={}))[i.VISIBILITIES=1]="VISIBILITIES",i[i.VERTEXATTRS=2]="VERTEXATTRS",i[i.TRANSFORMATION=4]="TRANSFORMATION",i[i.HIGHLIGHTS=8]="HIGHLIGHTS",i[i.OCCLUDEES=16]="OCCLUDEES"})(Gt||(Gt={}));function wm(e){e.fragment.include(Yh),e.fragment.uniforms.add("shadowMapTex","sampler2D"),e.fragment.uniforms.add("numCascades","int"),e.fragment.uniforms.add("cascadeDistances","vec4"),e.fragment.uniforms.add("shadowMapMatrix","mat4",4),e.fragment.uniforms.add("depthHalfPixelSz","float"),e.fragment.code.add(x`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = cascadeDistances;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= numCascades) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, depthHalfPixelSz, shadowMapTex);
}`)}function CWe(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function RWe(e,t,i){t.shadowMappingEnabled&&t.shadowMap.bindView(e,i)}function OWe(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}function MWe(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMatrix","mat4"),e.fragment.uniforms.add("proj","mat4"),e.fragment.code.add(x`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function PWe(e,t){e.bindTexture(t.lastFrameColorTexture,"lastFrameColorMap"),e.setUniformMatrix4fv("reprojectionMatrix",t.reprojectionMatrix),e.setUniformMatrix4fv("proj",t.camera.projectionMatrix)}function IWe(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("view","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(As),e.include(MWe),e.fragment.code.add(x`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function QH(e,t){t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("view",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),PWe(e,t))}function $We(e){e.fragment.code.add(x`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function DWe(e){e.fragment.code.add(x`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function gee(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include($We),e.fragment.code.add(x`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function LWe(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}function aO(e,t){t.output===j.Color&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(x`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):t.output===j.Depth||t.output===j.Shadow?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("nearFar","vec2"),e.vertex.code.add(x`void forwardLinearDepth() {
linearDepth = (-position_view().z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)):e.vertex.code.add(x`void forwardLinearDepth() {}`)}function ky(e,t){t.viewingMode===$e.Global?e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.viewingMode===$e.Global?e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function NWe(e){const t=e.fragment.code;t.add(x`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),t.add(x`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),t.add(x`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function gF(e,t){const i=e.fragment.code;e.include(VN),t.pbrMode===xt.Water||t.pbrMode===xt.WaterOnIntegratedMesh?(i.add(x`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(x`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),i.add(x`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),i.add(x`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),i.add(x`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||(e.include(NWe),i.add(x`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),i.add(x`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),i.add(x`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),i.add(x`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),i.add(x`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),i.add(x`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function Dye(e,t){e.include(gF,t),e.include(kN),e.include(DWe),t.cloudsReflectionsEnabled&&e.include(Bfe),t.ssrEnabled&&e.include(IWe,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),e.fragment.code.add(x`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(x`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudsReflectionsEnabled&&e.fragment.code.add(x`vec4 cloudsColor = crossFade == 0 ? renderCloud(reflectedWorld, position) : renderCloudCrossFade(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * (1.0 - totalFadeInOut);`),t.ssrEnabled?e.fragment.code.add(x`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view *vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);`):e.fragment.code.add(x`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudsReflectionsEnabled?t.ssrEnabled?e.fragment.code.add(x`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):e.fragment.code.add(x`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):e.fragment.code.add(x`return waterRenderedColor;
}`)}function FWe(e){const t=new Ri;return t.include(Un,{linearDepth:!1}),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),e.output!==j.Color&&e.output!==j.Alpha||(t.include(ky,e),t.include(aO,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.fragment.uniforms.add("localOrigin","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(zn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===j.Color?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),e.output===j.Alpha&&(t.include(Rr,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),e.output===j.Color&&(t.include(BN),t.include(Vj,{pbrMode:xt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(gee,e),t.include(Rr,e),e.receiveShadows&&t.include(wm,e),t.include(Dye,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("lightingSpecularStrength","float").add("lightingEnvironmentStrength","float").add("cameraPosition","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(Rp),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?x`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output===j.Normal&&(t.include(ky,e),t.include(gee,e),t.include(Rr,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(zn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),e.output===j.Draped&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(zn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`void main() {
gl_FragColor = waterColor;
}`)),e.output===j.Highlight&&(t.include(Fm),t.varyings.add("vpos","vec3"),t.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(zn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(Rr,e),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const UWe=Object.freeze({__proto__:null,build:FWe});class yF extends Vi{constructor(t,i,r){super(t,i,r),this._textureRepository=t.waterTextureRepository}initializeProgram(t){const i=yF.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:xt.Water,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,cloudsReflectionsEnabled:ue("enable-feature:clouds-reflections"),highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,mi)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),i.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i)),this.configuration.output===j.Color&&(i.lighting.setUniforms(this.program,!1,!1),QH(this.program,i),ue("enable-feature:clouds-reflections")&&_(i.cloudsCompositionParams)&&Vfe(this.program,i.camera,i.cloudsCompositionParams)),this.configuration.output!==j.Color&&this.configuration.output!==j.Normal||(LWe(this.program,t),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",t.color),this.configuration.output===j.Highlight&&Pp(this.program,i)}bindDraw(t){Op(this.program,t),this.program.rebindTextures(),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Color&&CWe(this.program,t),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha&&this.configuration.output!==j.Highlight||rb(this.program,this.configuration,t)}_setPipelineState(t){const i=this.configuration,r=t===at.NONE,s=t===at.FrontFace;return Rt({blending:i.output!==j.Normal&&i.output!==j.Highlight&&i.transparent?r?dl:km(t):null,depthTest:{func:O0(t)},depthWrite:r?i.writeDepth&&Aa:nF(t),colorWrite:Ft,polygonOffset:r||s?null:lF(i.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}yF.shader=new Li(UWe,()=>import("./WaterSurface.glsl.84984570.js"));class qc extends dr{constructor(){super(...arguments),this.output=j.Color,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],qc.prototype,"output",void 0),u([Y()],qc.prototype,"receiveShadows",void 0),u([Y()],qc.prototype,"slicePlaneEnabled",void 0),u([Y()],qc.prototype,"transparent",void 0),u([Y()],qc.prototype,"enableOffset",void 0),u([Y()],qc.prototype,"writeDepth",void 0),u([Y()],qc.prototype,"useSSR",void 0),u([Y()],qc.prototype,"isDraped",void 0),u([Y({count:at.COUNT})],qc.prototype,"transparencyPassType",void 0),u([Y()],qc.prototype,"multipassTerrainEnabled",void 0),u([Y()],qc.prototype,"cullAboveGround",void 0);class yee extends Nm{updateParameters(t){return this.ensureTechnique(yF,t)}setElapsedTimeUniform(t){const i=.001*this._material.animation.time;t.setUniform1f("timeElapsed",i*this._material.parameters.animationSpeed)}_updateShadowState(t){t.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:t.shadowMappingEnabled})}_updateSSRState(t){t.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:t.ssrEnabled})}ensureResources(t){const i=this._techniqueRep.constructionContext.waterTextureRepository;return i.ready||i.updating||i.loadTextures(t),i.ready?ua.LOADED:ua.LOADING}beginSlot(t){return this._output===j.Color&&(this._updateShadowState(t),this._updateSSRState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.parameters,t),this._output!==j.Normal&&this._output!==j.Color||this.setElapsedTimeUniform(i.program)}}const kWe=Nr().vec3f(E.POSITION),zWe=Nr().vec3f(E.POSITION).vec2f(E.UV0),Lye=Nr().vec3f(E.POSITION).vec4u8(E.COLOR);class vF{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){sF(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}const Nye=I({waveStrength:.06,waveTextureRepeat:32,waveDirection:vi(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1},Du),BWe={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};class Fye extends Zh{constructor(t){super(t,Nye),this._techniqueConfig=new qc,this.animation=new ime}getTechniqueConfig(t,i){return this._techniqueConfig.output=t,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=i.transparencyPassType,this._techniqueConfig.enableOffset=i.camera.relativeElevation<oF,this._techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=i.cullAboveGround,this._techniqueConfig}update(t){const i=Math.min(t.camera.relativeElevation,t.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*i<VWe;const r=this.animation.advance(t);return this.animation.enabled&&r}intersect(t,i,r,s,n,o,a){rF(t,i,s,n,o,void 0,a)}requiresSlot(t,i){switch($1(i)){case j.Normal:return t===ye.DRAPED_WATER;case j.Color:if(this.parameters.isDraped)return t===ye.DRAPED_MATERIAL;break;case j.Highlight:return t===ye.OPAQUE_MATERIAL||t===ye.DRAPED_MATERIAL}let r=ye.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),t===r}createGLMaterial(t){if(t.output===j.Color&&this.parameters.isDraped)return t.output=j.Draped,new yee(t);switch(t.output){case j.Color:case j.Normal:case j.Highlight:case j.Alpha:return new yee(t)}return null}createBufferWriter(){return new vF(zWe)}}const VWe=35e3;class vee{constructor(t){this.first=t.from,this.count=t.to-t.from}}class zw{constructor(t=0,i=0){this.from=t,this.to=i}}class GWe extends zw{constructor(t,i,r,s,n,o){super(i,r),this.id=t,this.isVisible=s,this.hasHighlights=n,this.hasOccludees=o}}function _ee(e){return Array.from(e.values()).sort(jWe)}function jWe(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function ZM(e,t){if(e.length===0)return void e.push(new vee(t));const i=e[e.length-1];if(HWe(i,t)){const r=t.from-i.first+t.to-t.from;i.count=r}else e.push(new vee(t))}function HWe(e,t){return e.first+e.count>=t.from}class qWe{constructor(t,i){this._pool=t,this._size=0,this._buffer=t.newBuffer(q8(i))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(t){this._resize(this._size+t,!0).dispose()}alloc(t){return this._resize(t,!1)}_resize(t,i){let r;const s=WWe(this._buffer.length,this._size,t);if(this._buffer.length!==s){const o=this._pool.newBuffer(s);i&&(o.array.set(this._buffer.array.subarray(0,Math.min(this._size,s))),o.vao.vertexBuffers.geometry.setSubData(o.array,0,0,o.array.byteLength)),r=this._buffer,this._buffer=o}const n=this._size;return this._size=t,r?{dispose:()=>{r.array.fill(0,0,n),this._pool.deleteBuffer(r)},copy:(o,a,l)=>this._buffer.array.set(r.array.subarray(a,l),o),hasNewBuffer:!0}:{dispose:()=>{},copy:(o,a,l)=>{o!==a&&this._buffer.array.copyWithin(o,a,l)},hasNewBuffer:!1}}erase(t,i){this._buffer.array.fill(0,t,i)}}const bee=65536;function q8(e){return Math.ceil(e/bee)*bee}function WWe(e,t,i){return t<=i?e>=i?e:q8(Math.max(2*e,i)):e<=2*i?e:q8(i)}class XWe{constructor(t,i,r,s){this.vao=new as(t,i,{geometry:r},{geometry:jt.createVertex(t,ri.STATIC_DRAW)}),this.array=new Float32Array(s),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const YWe=K3+1;class ZWe{constructor(t,i,r){this._rctx=t,this._locations=i,this._layout=r,this._cache=t.newCache(`MergedRenderer pool ${va()}`,QWe)}dispose(){this._cache.destroy()}newBuffer(t){const i=t.toString(),r=this._cache.pop(i);if(_(r)){const s=r.pop();return r.length>0&&this._cache.put(i,r,s.array.byteLength*r.length,YWe),s}return new XWe(this._rctx,this._locations,this._layout,t)}deleteBuffer(t){const i=t.array.byteLength,r=t.array.length.toString(),s=this._cache.pop(r);return _(s)?(s.push(t),this._cache.put(r,s,i*s.length,-1)):this._cache.put(r,[t],i,-1),null}}function QWe(e,t){if(t===Uf.ALL)return void e.forEach(s=>s.dispose());const i=e.pop(),r=e.length*i.array.byteLength;return i.dispose(),r}class Uye{constructor(t,i,r){this._rctx=t,this._materialRepository=i,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new $t,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new $ye(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new ZWe(t,r.vertexAttributeLocations,wl(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach(t=>t.buffer.dispose()),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof Fye}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==Ar.Occlude}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateRenderCommands()}_addAndRemoveGeometries(t,i){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,n=this._dataByOrigin,o=KWe(t,i);o.forEach((a,l)=>{o.delete(l);const c=a.toAdd.reduce((w,S)=>w+r.elementCount(S.data),0);let h=n.get(l);if(h==null)ot(a.toRemove.length===0),h=new tXe(a.origin,new qWe(this._bufferPool,c*s)),n.set(l,h);else if(a.toAdd.length===0&&h.instances.size===a.toRemove.length)return h.buffer.dispose(),void n.delete(l);let p=0;h.instances.forEach(w=>p+=w.to-w.from);const f=a.toRemove.reduce((w,S)=>w+r.elementCount(S.data),0),g=h.buffer.size,y=(p+c-f)*s,v=rXe;if(y<g/2?this._removeAndRebuild(h,a.toRemove,s,y,v):a.toRemove.length>0&&this._remove(h,a.toRemove,s,v),a.toAdd.length>0){const w=sXe;Qfe(w,-a.origin[0],-a.origin[1],-a.origin[2]),this._add(h,a.toAdd,s,w,v)}const b=h.buffer.vao.vertexBuffers.geometry;Tee(v),v.forAll(({from:w,to:S})=>{if(w<S){const T=h.buffer.array,A=4,C=w*A,R=S*A;b.setSubData(T,C,C,R)}}),v.clear(),h.drawCommandsDirty=!0})}_updateGeometries(t){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4;for(const s of t){const n=s.renderGeometry,o=this._dataByOrigin.get(n.origin.id),a=o&&o.instances.get(n.id);if(!a)return;const l=s.updateType;if(l&Gt.State.VISIBILITIES&&(a.isVisible=n.instanceParameters.visible),l&(Gt.State.HIGHLIGHTS|Gt.State.VISIBILITIES)){const c=n.instanceParameters.visible;a.hasHighlights=!!n.instanceParameters.highlights&&c}if(l&Gt.State.OCCLUDEES&&(a.hasOccludees=!!n.instanceParameters.occludees),l&(Gt.State.VERTEXATTRS|Gt.State.TRANSFORMATION)){const{array:c,vao:h}=o.buffer;G8e(n,SU,u2),i.write({transformation:SU,invTranspTransformation:u2},n.data,i.vertexBufferLayout.createView(c.buffer),a.from),ot(a.from+i.elementCount(n.data)===a.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(c,a.from*r*4,a.from*r*4,a.to*r*4)}o.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(i=>{i.hasHiddenInstances=!1,i.hasHighlights=!1,i.hasOccludees=!1,Vr(i.instances,r=>(r.isVisible?(r.hasHighlights&&(this._hasHighlights=!0,i.hasHighlights=!0),r.hasOccludees&&(this._hasOccludees=!0,i.hasOccludees=!0)):i.hasHiddenInstances=!0,i.hasHiddenInstances&&i.hasHighlights&&i.hasOccludees))});const t=i=>{if(i.drawCommandsDefault=null,i.drawCommandsHighlight=null,i.drawCommandsOccludees=null,i.drawCommandsShadowHighlightRest=null,i.instances.size===0)return;if(!xee(i)){const s=this._bufferWriter.vertexBufferLayout.stride,n=4*i.buffer.size/s;return void(i.drawCommandsDefault=[{first:0,count:n}])}const r=_ee(i.instances);i.drawCommandsDefault=[],i.drawCommandsHighlight=[],i.drawCommandsOccludees=[],i.drawCommandsShadowHighlightRest=[];for(const s of r)s.isVisible&&(s.hasOccludees?ZM(i.drawCommandsOccludees,s):ZM(i.drawCommandsDefault,s),s.hasHighlights?ZM(i.drawCommandsHighlight,s):ZM(i.drawCommandsShadowHighlightRest,s))};this._dataByOrigin.forEach(i=>{i.drawCommandsDirty&&(t(i),i.drawCommandsDirty=!1)})}updateAnimation(t){return this._material.update(t)}requiresSlot(t,i){return t==null||this._material.requiresSlot(t,i)}render(t,i,r){if(!this.requiresSlot(t,i))return!1;const s=i===De.MATERIAL_HIGHLIGHT||i===De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(s&&!this._hasHighlights)return!1;const n=i===De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,o=!(s||n);if(this._dataByOrigin.forEach(h=>{if(s&&!h.hasHighlights)return;const p=(s?h.drawCommandsHighlight:n&&xee(h)?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,f=o&&h.drawCommandsOccludees||null;(_(p)||_(f))&&this._renderCommandData.push(new iXe(h.origin,h.buffer,p,f))}),this._renderCommandData.length===0)return!1;const a=this._rctx,l=this._glMaterials.load(a,i);if(O(l))return this._renderCommandData.clear(),!1;const c=l.beginSlot(r);return a.useTechnique(c,t,!1),l.bind(r,c),this._renderCommandData.forAll(({origin:h,buffer:p,renderCommands:f,occludeeCommands:g})=>{r.origin=h,c.bindDraw(r),c.ensureAttributeLocations(p.vao),a.bindVAO(p.vao);const y=c.primitiveType;_(f)&&this._renderCommands(a,y,f),_(g)&&(c.bindPipelineState(a,t,!0),this._renderCommands(a,y,g),c.bindPipelineState(a,t,!1))}),this._renderCommandData.clear(),!0}_renderCommands(t,i,r){for(let s=0;s<r.length;s++)t.drawArrays(i,r[s].first,r[s].count)}_removeAndRebuild(t,i,r,s,n){for(const h of i)t.instances.delete(h.id);const o=_ee(t.instances);t.instances.clear();const a=t.buffer.size,l=t.buffer.alloc(s);let c=0;for(const h of o){const p=h.from*r,f=h.to*r;l.copy(c,p,f),h.from=c/r,c+=f-p,h.to=c/r,t.instances.set(h.id,h)}n.push(new zw(0,l.hasNewBuffer?t.buffer.array.length:a)),l.dispose(),t.buffer.erase(c,n.back().to),t.holes.clear()}_remove(t,i,r,s){for(const n of i){const o=n.id,a=t.instances.get(o),l=a.from*r,c=a.to*r;t.buffer.erase(l,c),t.holes.push(new zw(a.from,a.to)),t.instances.delete(o),s.push(new zw(l,c))}Tee(t.holes)}_add(t,i,r,s,n){if(i.length===0)return;const o=this._bufferWriter;let a=o.vertexBufferLayout.createView(t.buffer.array.buffer);const l=t.holes.length>0;let c=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;for(const p of i){const f=_(p.transformation)?ur(SU,s,p.transformation):s;hr(u2,f);const g=Ea(u2,u2),y=o.elementCount(p.data),v=y*r;let b=eXe(t.holes,y);O(b)&&(b=t.buffer.size/r,t.buffer.grow(v),a=o.vertexBufferLayout.createView(t.buffer.array.buffer)),o.write({transformation:f,invTranspTransformation:g},p.data,a,b);const w=p.instanceParameters.visible,S=!!p.instanceParameters.highlights&&w,T=!!p.instanceParameters.occludees,A=new GWe(p.id,b,b+y,w,S,T);ot(t.instances.get(p.id)==null),t.instances.set(p.id,A),l?n.push(new zw(A.from*r,A.to*r)):(c=Math.min(A.from,c),h=Math.max(A.to,h))}l||n.push(new zw(c*r,h*r))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class JWe{constructor(t){this.origin=t,this.toAdd=new Array,this.toRemove=new Array}}function KWe(e,t){const i=new Map;for(const r of e)wee(i,r,!0);for(const r of t)wee(i,r,!1);return i}function wee(e,t,i){const r=t.origin;if(O(r))return;let s=e.get(r.id);s==null&&(s=new JWe(r.vec3),e.set(r.id,s)),i?s.toAdd.push(t):s.toRemove.push(t)}function xee(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function eXe(e,t){let i;if(!e.some(s=>!(s.to-s.from<t)&&(i=s,!0)))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}function Tee(e){const t=new Map;e.forAll(r=>t.set(r.from,r));let i=!0;for(;i;)i=!1,e.forEach(r=>{const s=t.get(r.to);s&&(r.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0)})}class tXe{constructor(t,i){this.origin=t,this.buffer=i,this.instances=new Map,this.holes=new $t({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class iXe{constructor(t,i,r,s){this.origin=t,this.buffer=i,this.renderCommands=r,this.occludeeCommands=s}}const rXe=new $t({deallocator:null}),sXe=Te(),SU=Te(),u2=Te();let w_=class extends we{constructor(){super(...arguments),this._pending=new nXe,this._changes=new Pye,this._materialRenderers=new Map,this._sortedMaterialRenderers=new $t,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Vr(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=Iye(this._changes);let t=!1,i=!1,r=!1;return e.forEach((s,n)=>{let o=this._materialRenderers.get(n);if(!o&&s.adds.length>0&&(o=new Uye(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,o),t=!0,i=!0,r=!0),!o)return;const a=i||o.hasHighlights,l=r||o.hasWater;o.modify(s),i=i||a!==o.hasHighlights,r=r||l!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),t=!0)}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=Vr(this._materialRenderers,s=>s.hasHighlights)),r&&(this._hasWater=Vr(this._materialRenderers,s=>s.hasWater)),this.notifyChange("updating"),!0}add(e){if(e.length===0)return;const t=this._pending.empty;for(const i of e)this._pending.adds.add(i);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const i of e)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=this._changes.updates.length===0;for(const r of e){const s=this._changes.updates.pushNew();s.renderGeometry=r,s.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll(({materialRenderer:i})=>t=i.updateAnimation(e)||t),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(e)&&r.materialRenderer.render(t.slot,e.pass,t)}}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})}),this._sortedMaterialRenderers.sort((t,i)=>{const r=i.material.renderPriority-t.material.renderPriority;return r!==0?r:t.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],w_.prototype,"rctx",void 0),u([d()],w_.prototype,"materialRepository",void 0),u([d()],w_.prototype,"updating",null),w_=u([P("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],w_);class nXe{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Xpt=(()=>{if(!("document"in globalThis))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d"),i=512;return e.height=i,e.width=1,r=>{t.clearRect(0,0,1,e.height);const s=t.createLinearGradient(0,0,0,e.height);for(const{ratio:n,color:o}of r)s.addColorStop(Math.max(n,.001),`rgba(${o.r}, ${o.g}, ${o.b}, ${o.a})`);return t.fillStyle=s,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function Ypt(e,t,i,r){const{blurRadius:s,fieldOffset:n,field:o}=t,a=new Float64Array(i*r),l=kye(s),c=Math.round(3*s);let h,p=Number.NEGATIVE_INFINITY;const f=oXe(o,n),g=new Set;for(const y of e){const v=y.getCursor();for(;v.next();){const b=v.getObjectId();if(g.has(b))continue;g.add(b);const w=v.readLegacyPointGeometry(),S=128;if(w.x<-S||w.x>=i+S||w.y<-S||w.y>r+S)continue;const T=+f(v),A=Math.round(w.x)-c,C=Math.round(w.y)-c,R=Math.max(0,A),L=Math.max(0,C),U=Math.min(r,Math.round(w.y)+c),N=Math.min(i,Math.round(w.x)+c);for(let z=L;z<U;z++){const V=l[z-C];for(let B=R;B<N;B++){const J=l[B-A];h=a[z*i+B]+=V*J*T,h>p&&(p=h)}}}}return{matrix:a.buffer,max:p}}function kye(e){const t=Math.round(3*e),i=2*e*e,r=new Float64Array(2*t+1);for(let s=0;s<=r.length;s++)r[s]=Math.exp(-((s-t)**2)/i)/Math.sqrt(2*Math.PI)*(e/2);return r}function oXe(e,t){return e!=null?typeof t=="string"?i=>-1*+i.readAttribute(e):i=>+i.readAttribute(e)+t:i=>1}var vc;function aXe(e){const t=new Ri,{mode:i,isAttributeDriven:r}=e;return t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),e.isAttributeDriven&&(t.attributes.add(E.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add("radius","float"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),t.vertex.code.add(x`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${E.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${r?x`attributeValue = ${E.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),i===vc.KernelDensity?t.fragment.code.add(x`
      void main() {
        float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
        if (radiusRatioSquared > 1.0) {
          discard;
        }

        float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
        float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${r?x` * attributeValue`:""};
        gl_FragColor = vec4(density);
      }
    `):i===vc.GaussianBlur&&(t.fragment.uniforms.add("kernel","sampler2D"),t.fragment.code.add(x`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      vec2 uv = abs(unitCirclePos);
      vec2 uvX = vec2(uv.x, 0.5);
      vec2 uvY = vec2(uv.y, 0.5);
      float intensity = texture2D(kernel, uvX).r * texture2D(kernel, uvY).r${r?x` * attributeValue`:""};
      gl_FragColor = vec4(intensity);
    }
  `)),t}(function(e){e[e.GaussianBlur=0]="GaussianBlur",e[e.KernelDensity=1]="KernelDensity"})(vc||(vc={}));const lXe=Object.freeze({__proto__:null,get HeatmapMode(){return vc},build:aXe});var See;(function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"})(See||(See={}));class _F extends Vi{constructor(t,i,r){super(t,i,r),this._kernelBlurRadius=1;const{R32F:s,textureFloatLinear:n}=t.rctx.capabilities.textureFloat,o=s!=null;this._kernelTextureChannels=o?1:4,this._floatInterpolationDisabled=!n;const a={target:rt.TEXTURE_2D,pixelFormat:o?Ie.RED:Ie.RGBA,internalFormat:o?st.R32F:Ie.RGBA,dataType:yt.FLOAT,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:1,height:1};this._kernel=new Ze(t.rctx,a)}initializeProgram(t){const i=_F.shader.get().build({isAttributeDriven:this.configuration.isAttributeDriven,mode:this.configuration.mode});return new Oi(t.rctx,i,mi)}initializePipeline(){return Rt({blending:gc(Ee.ONE,Ee.ONE,fp.ADD),colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){const{camera:r}=i,{mode:s}=this.configuration;switch(xl(this.program,r.projectionMatrix),s){case vc.KernelDensity:this._bindKernelDensityPass(t,i);break;case vc.GaussianBlur:this._bindGaussianBlurPass(t,i)}}bindDraw(t){Op(this.program,t)}_bindKernelDensityPass({searchRadius:t,resolutionForScale:i},{camera:r,screenToWorldRatio:s}){i!==0&&(t/=s/i),this.program.setUniform1f("radius",t*r.pixelRatio/r.fullViewport[2])}_bindGaussianBlurPass({searchRadius:t,resolutionForScale:i},{camera:r,screenToWorldRatio:s}){const n=Math.round(t),o=3*(i===0?n:n*i/s);i===0||this._floatInterpolationDisabled?this._kernel.setSamplingMode(Ve.NEAREST):this._kernel.setSamplingMode(Ve.LINEAR),this._kernelBlurRadius!==n&&this._recomputeKernel(n),this.program.setUniform1f("radius",2*o*r.pixelRatio/r.fullViewport[2]),this.program.bindTexture(this._kernel,"kernel")}_recomputeKernel(t){const i=kye(t),r=Math.ceil(i.length/2),s=this._kernelTextureChannels,n=new Float32Array(r*s);for(let o=0;o<r;++o){const a=i[r-1-o];for(let l=0;l<s;++l)n[o*s+l]=a}this._kernel.resize(r,1),this._kernel.setData(n),this._kernelBlurRadius=t}destroy(){this._kernel=et(this._kernel),super.destroy()}}_F.shader=new Li(lXe,()=>import("./HeatmapDensity.glsl.f5dd87c1.js"));class W8 extends dr{constructor(){super(...arguments),this.isAttributeDriven=!1,this.mode=vc.GaussianBlur}}u([Y()],W8.prototype,"isAttributeDriven",void 0),u([Y()],W8.prototype,"mode",void 0);const cXe=I({searchRadius:128,resolutionForScale:0,colorRampData:null,isAttributeDriven:!1,minDensity:0,maxDensity:100,fieldTotal:0,pixelRatio:1},Du);class uXe extends Zh{constructor(t){super(t,cXe),this._techniqueConfig=new W8}requiresSlot(t,i){return t===ye.DRAPED_MATERIAL&&i===De.MATERIAL}getTechniqueConfig(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(t){return new hXe(t)}intersect(){}createBufferWriter(){return new dXe(this.parameters.isAttributeDriven?pXe:zye)}}class hXe extends Nm{constructor(t){super(t)}beginSlot(t){return this.updateParameters(t)}updateParameters(t){return this.ensureTechnique(_F,t)}bind(t,i){i.bindPass(this._material.parameters,t)}}class dXe{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length*EU}write(t,i,r,s){KR(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,EU);const n=i.indices.get(E.POSITION).length,o=r.uv0;let a=s;for(let c=0;c<n;++c)o.setValues(a++,-1,-1),o.setValues(a++,1,-1),o.setValues(a++,1,1),o.setValues(a++,1,1),o.setValues(a++,-1,1),o.setValues(a++,-1,-1);const l="featureAttribute"in r?r.featureAttribute:null;l&&hje(i.indices.get(E.FEATUREATTRIBUTE),i.vertexAttributes.get(E.FEATUREATTRIBUTE).data,l,s,EU)}}const zye=Nr().vec3f(E.POSITION).vec2f(E.UV0),pXe=zye.clone().f32(E.FEATUREATTRIBUTE),EU=6;function fXe(e){return e instanceof uXe}function mXe(e){const t=new Ri,{mode:i}=e;return t.include(C0),t.include(rm,{alphaDiscardMode:Ai.Blend}),t.fragment.uniforms.add("densityMap","sampler2D"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("densityNormalizer","float"),t.fragment.uniforms.add("minDensity","float"),i===vc.KernelDensity&&t.fragment.uniforms.add("densityMultiplier","float"),t.fragment.code.add(x`
    void main() {
      float density = texture2D(densityMap, uv).r${i===vc.KernelDensity?x` * densityMultiplier`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),t}const gXe=Object.freeze({__proto__:null,build:mXe,get HeatmapMode(){return vc}});class bF extends Vi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=bF.shader.get().build({mode:this.configuration.mode});return new Oi(t.rctx,i,mi)}initializePipeline(t){return Rt({blending:dl,colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){const{densityMap:r,colorRamp:s,maxDensity:n,minDensity:o,searchRadius:a}=t;this.program.bindTexture(r,"densityMap"),this.program.bindTexture(s,"tex"),this.configuration.mode===vc.KernelDensity&&this.program.setUniform1f("densityMultiplier",3/(a*a*Math.PI)),this.program.setUniform1f("densityNormalizer",1/(n-o)),this.program.setUniform1f("minDensity",o)}get primitiveType(){return Tt.TRIANGLE_STRIP}}bF.shader=new Li(gXe,()=>import("./Heatmap.glsl.caa6981b.js"));class Bye extends dr{constructor(){super(...arguments),this.mode=vc.GaussianBlur}}u([Y()],Bye.prototype,"mode",void 0);let QD=class extends w_{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:i}=t.colorBufferFloat,{textureFloatLinear:r}=t.textureFloat,s=i!=null,n={target:rt.TEXTURE_2D,pixelFormat:s?Ie.RED:Ie.RGBA,internalFormat:s?st.R32F:Ie.RGBA,dataType:yt.FLOAT,samplingMode:r?Ve.LINEAR:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new ki(this.rctx,e,n),this._quad=fo(this.rctx);const o={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:1,height:1},a=new Ze(this.rctx,o,new Uint8ClampedArray(4));this._colorRamp=a,this._technique=new bF({rctx:this.rctx,viewingMode:$e.Local},new Bye),this._heatmapParameters={colorRamp:a,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}}destroy(){this._technique=Wi(this._technique),this._densityMap=et(this._densityMap),this._quad=et(this._quad),this._colorRamp=et(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(yXe)}add(e){super.add(e)}remove(e){super.remove(e)}render(e,t){const i=this._heatmapDensityMaterialRenderers,r=i.length;if(r<1)return;const s=this.rctx.getBoundFramebufferObject(),n=this.rctx.getViewport(),o=i[0].material.parameters,{pixelRatio:a}=o,l=Math.ceil(n.width*a),c=Math.ceil(n.height*a);this._densityMap.resize(l,c),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,l,c),this.rctx.clear(bi.COLOR_BUFFER_BIT);let h=!1;for(let w=0;w<r;w++){const S=i[w];S.material.shouldRender(e)&&(h=h||S.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(s),this.rctx.setViewport(n.x,n.y,n.width,n.height),!h)return;const{searchRadius:p,minDensity:f,maxDensity:g,fieldTotal:y,colorRampData:v}=o,b=this._heatmapParameters;if(b.searchRadius=p,b.fieldTotal=y,b.searchRadius=p,b.minDensity=f,b.maxDensity=g,_(v)&&v!==this._colorRampData){const{colorRamp:w}=b,S=w.descriptor.width,T=v.length/4;T!==S&&w.resize(T,1),w.setData(v),this._colorRampData=v}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(b,t),this.rctx.drawArrays(this._technique.primitiveType,0,fn(this._quad,"geometry"))}};function yXe(e){return fXe(e.material)}QD=u([P("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],QD);const vXe=he.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class _Xe{constructor(t){this._glMaterial=t,this.refCnt=0,this._glMaterial=t}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,ot(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class Vye{constructor(t,i,r,s){this._textureRepository=t,this._techniqueRepository=i,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new ZH}dispose(){this._textureRepository.dispose()}acquire(t,i){this._ownMaterial(t);let r=this._id2glMaterialRef.get(i,t.id);if(O(r)){const s=t.createGLMaterial({material:t,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});r=new _Xe(s),this._id2glMaterialRef.set(i,t.id,r)}return r.incRefCnt(),r.glMaterial}release(t,i){const r=this._id2glMaterialRef.get(i,t.id);_(r)&&(r.decRefCnt(),r.getRefCnt()===0&&(et(r.glMaterial),this._id2glMaterialRef.delete(i,t.id)))}_ownMaterial(t){_(t.repository)&&t.repository!==this&&vXe.error("Material is already owned by a different material repository"),t.repository=this}}const bXe=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class Gye{constructor(t,i){this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Sr,this._objectCount=0,i&&(i.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=i.maximumObjectsPerNode),i.maximumDepth!==void 0&&(this._maximumDepth=i.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),Sr.clearPool(),X8[0]=null,X0.prune(),Jv.prune()}add(t,i=t.length){this._objectCount+=i,this._grow(t,i);const r=Sr.acquire();for(let s=0;s<i;s++){const n=t[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(r.init(this._root),this._add(n,r))}Sr.release(r)}remove(t,i=null){this._objectCount-=t.length;const r=Sr.acquire();for(const s of t){const n=_(i)?i:fT(this._objectToBoundingSphere(s),EXe);VE(n[3])?(r.init(this._root),this._remove(s,n,r)):this._degenerateObjects.delete(s)}Sr.release(r),this._shrink()}update(t,i){if(!VE(i[3])&&this._isDegenerate(t))return;const r=SXe(t);this.remove(r,i),this.add(r)}forEachAlongRay(t,i,r){const s=fc(t,i);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),!0})}forEachAlongRayWithVerticalOffset(t,i,r,s){const n=fc(t,i);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),!0})}forEach(t){this._forEachNode(this._root,i=>{const r=i.node;return r.terminals.forAll(t),r.residents!==null&&r.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,i,r,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=AU(t,i),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!Ny(r,f))return;const g=cy(t,i,mc(f)),y=g-f[3],v=g+f[3];y<o&&(o=y,a=v,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!Ny(r,p.bounds)||(ae(Rc,c,p.halfSize),pe(Rc,Rc,p.bounds),cy(t,i,Rc)>a))return!1;const f=p.node;return f.terminals.forAll(g=>h(g)),f.residents!==null&&f.residents.forAll(g=>h(g)),!0},t,i),l}forEachInDepthRange(t,i,r,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:v=>{r===rc.FRONT_TO_BACK?(l=Math.max(l,v.near),c=Math.min(c,v.far)):(l=Math.max(l,-v.far),c=Math.min(c,-v.near))}};h.setRange(s);const p=cy(i,r,t),f=AU(i,r),g=AU(i,-r),y=v=>{if(!a(v))return;const b=this._objectToBoundingSphere(v),w=mc(b),S=cy(i,r,w)-p,T=S-b[3],A=S+b[3];T>c||A<l||!Ny(o,b)||n(v,h)};this._forEachNodeDepthOrdered(this._root,v=>{if(!Ny(o,v.bounds)||(ae(Rc,f,v.halfSize),pe(Rc,Rc,v.bounds),cy(i,r,Rc)-p>c)||(ae(Rc,g,v.halfSize),pe(Rc,Rc,v.bounds),cy(i,r,Rc)-p<l))return!1;const b=v.node;return b.terminals.forAll(w=>y(w)),b.residents!==null&&b.residents.forAll(w=>y(w)),!0},i,r)}forEachNode(t){this._forEachNode(this._root,i=>t(i.node,i.bounds,i.halfSize))}_intersectsNode(t,i){return QM(i.bounds,2*-i.halfSize,Gl),QM(i.bounds,2*i.halfSize,jl),LJ(t.origin,t.direction,Gl,jl)}_intersectsNodeWithOffset(t,i,r){return QM(i.bounds,2*-i.halfSize,Gl),QM(i.bounds,2*i.halfSize,jl),r.applyToMinMax(Gl,jl),LJ(t.origin,t.direction,Gl,jl)}_intersectsObject(t,i){const r=this._objectToBoundingSphere(i);return!(r[3]>0)||sB(r,t)}_intersectsObjectWithOffset(t,i,r){const s=this._objectToBoundingSphere(i);return!(s[3]>0)||sB(r.applyToBoundingSphere(s),t)}_forEachNode(t,i){let r=Sr.acquire().init(t);const s=[r];for(;s.length!==0;){if(r=s.pop(),i(r)&&!r.isLeaf())for(let n=0;n<r.node.children.length;n++)r.node.children[n]&&s.push(Sr.acquire().init(r).advance(n));Sr.release(r)}}_forEachNodeDepthOrdered(t,i,r,s=rc.FRONT_TO_BACK){let n=Sr.acquire().init(t);const o=[n];for(TXe(r,s,Cee);o.length!==0;){if(n=o.pop(),i(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=Cee[a];n.node.children[l]&&o.push(Sr.acquire().init(n).advance(l))}Sr.release(n)}}_remove(t,i,r){X0.clear();const s=r.advanceTo(i,(n,o)=>{X0.push(n.node),X0.push(o)})?r.node.terminals:r.node.residents;if(s.removeUnordered(t),s.length===0)for(let n=X0.length-2;n>=0;n-=2){const o=X0.data[n],a=X0.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let i=0;i<t.children.length;i++)if(t.children[i])return!1;return!0}_purge(t,i){return i>=0&&(t.children[i]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new $t({shrink:!0})),!0)}_add(t,i){i.advanceTo(this._objectToBoundingSphere(t))?i.node.terminals.push(t):(i.node.residents.push(t),i.node.residents.length>this._maximumObjectsPerNode&&i.depth<this._maximumDepth&&this._split(i))}_split(t){const i=t.node.residents;t.node.residents=null;for(let r=0;r<i.length;r++){const s=Sr.acquire().init(t);this._add(i.getItemAt(r),s),Sr.release(s)}}_grow(t,i){if(i!==0&&(Eee(t,i,r=>this._objectToBoundingSphere(r),nd),VE(nd[3])&&!this._fitsInsideTree(nd)))if(this._nodeIsEmpty(this._root.node))fT(nd,this._root.bounds),this._root.halfSize=1.25*nd[3];else{const r=this._rootBoundsForRootAsSubNode(nd);this._placingRootViolatesMaxDepth(r)?this._rebuildTree(nd,r):this._growRootAsSubNode(r),Sr.release(r)}}_rebuildTree(t,i){ne(RU,i.bounds),RU[3]=i.halfSize,Eee([t,RU],2,s=>s,OU);const r=Sr.acquire().init(this._root);this._root.initFrom(null,OU,1.25*OU[3]),this._forEachNode(r,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Sr.release(r)}_placingRootViolatesMaxDepth(t){const i=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,s=>(r=Math.max(r,s.depth),r+i<=this._maximumDepth)),r+i>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const i=t[3],r=t;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let a=0;a<3;a++){const l=n[a]-o-(r[a]-i),c=r[a]+i-(n[a]+o),h=Math.max(0,Math.ceil(l/(2*o))),p=Math.max(0,Math.ceil(c/(2*o)))+1,f=2**Math.ceil(Math.log(h+p)*Math.LOG2E);s=Math.max(s,f),JM[a].min=h,JM[a].max=p}for(let a=0;a<3;a++){let l=JM[a].min,c=JM[a].max;const h=(s-(l+c))/2;l+=Math.ceil(h),c+=Math.floor(h);const p=n[a]-o-l*o*2;CU[a]=p+(c+l)*o}return CU[3]=s*o*Hye,Sr.acquire().initFrom(null,CU,s*o,0)}_growRootAsSubNode(t){const i=this._root.node;ne(nd,this._root.bounds),nd[3]=this._root.halfSize,this._root.init(t),t.advanceTo(nd,null,!0),t.node.children=i.children,t.node.residents=i.residents,t.node.terminals=i.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const i=this._root.node.children;let r=0,s=0;for(;s<i.length&&t==null;)r=s++,t=i[r];for(;s<i.length;)if(i[s++])return-1;return r}_isDegenerate(t){return!VE(this._objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const i=this._root.bounds,r=this._root.halfSize;return t[3]<=r&&t[0]>=i[0]-r&&t[0]<=i[0]+r&&t[1]>=i[1]-r&&t[1]<=i[1]+r&&t[2]>=i[2]-r&&t[2]<=i[2]+r}}class Sr{constructor(){this.bounds=vn(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,i,r,s=this.depth){return this.node=_(t)?t:Sr.createEmptyNode(),_(i)&&fT(i,this.bounds),this.halfSize=r,this.depth=s,this}advance(t){let i=this.node.children[t];i||(i=Sr.createEmptyNode(),this.node.children[t]=i),this.node=i,this.halfSize/=2,this.depth++;const r=jye[t];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.bounds[3]=this.halfSize*Hye,this}advanceTo(t,i,r=!1){for(;;){if(this.isTerminalFor(t))return i&&i(this,-1),!0;if(this.isLeaf()){if(!r)return i&&i(this,-1),!1;this.node.residents=null}const s=this._childIndex(t);i&&i(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const i=this.bounds;return(i[0]<t[0]?1:0)+(i[1]<t[1]?2:0)+(i[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new $t({shrink:!0}),residents:new $t({shrink:!0})}}static acquire(){return Sr._pool.acquire()}static release(t){Sr._pool.release(t)}static clearPool(){Sr._pool.prune()}}var rc;function wXe(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function xXe(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function QM(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function Eee(e,t,i,r){if(t===1){const s=i(e[0]);fT(s,r)}else{Gl[0]=1/0,Gl[1]=1/0,Gl[2]=1/0,jl[0]=-1/0,jl[1]=-1/0,jl[2]=-1/0;for(let s=0;s<t;s++){const n=i(e[s]);VE(n[3])&&(wXe(Gl,n),xXe(jl,n))}Ss(r,Gl,jl,.5),r[3]=Math.max(jl[0]-Gl[0],jl[1]-Gl[1],jl[2]-Gl[2])/2}}function TXe(e,t,i){if(!Jv.length)for(let r=0;r<8;++r)Jv.push({index:0,distance:0});for(let r=0;r<8;++r){const s=jye[r];Jv.data[r].index=r,Jv.data[r].distance=cy(e,t,s)}Jv.sort((r,s)=>r.distance-s.distance);for(let r=0;r<8;++r)i[r]=Jv.data[r].index}function AU(e,t){let i=1/0,r=null;for(let s=0;s<8;++s){const n=cy(e,t,Aee[s]);n<i&&(i=n,r=Aee[s])}return r}function cy(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function VE(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}Sr._pool=new Gr(Sr),function(e){e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(rc||(rc={}));const jye=[je(-1,-1,-1),je(1,-1,-1),je(-1,1,-1),je(1,1,-1),je(-1,-1,1),je(1,-1,1),je(-1,1,1),je(1,1,1)],Aee=[je(-1,-1,-1),je(-1,-1,1),je(-1,1,-1),je(-1,1,1),je(1,-1,-1),je(1,-1,1),je(1,1,-1),je(1,1,1)],Hye=Math.sqrt(3),X8=[null];function SXe(e){return X8[0]=e,X8}const CU=vn(),Rc=M(),Gl=M(),jl=M(),X0=new $t,EXe=vn(),nd=vn(),RU=vn(),OU=vn(),JM=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],Jv=new $t,Cee=[0,0,0,0,0,0,0,0];class qye extends WR{constructor(t,i=""){var r,s,n;super(),this.apiLayerUid=i,this.type=Wh.Layer,this.events=new wr,this.isSliceable=!1,this._objects=new $t,this._stageHandles=new Bt,this.apiLayerUid=i,this.isVisible=(r=t==null?void 0:t.isVisible)==null||r,this.isPickable=(s=t==null?void 0:t.isPickable)==null||s,this.updatePolicy=(n=t==null?void 0:t.updatePolicy)!=null?n:CT.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(t){this.detachStage(),this._stage=t;for(const i of bXe)this._stageHandles.add(this.events.on(i,r=>t.handleEvent(i,r)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),_(this._octree)&&this._octree.add([t])}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),_(this._octree)&&this._octree.remove([t]))}addMany(t){this._objects.pushArray(t);for(const i of t)i.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),_(this._octree)&&this._octree.add(t)}removeMany(t){const i=new Array;if(this._objects.removeUnorderedMany(t,t.length,i),i.length!==0){for(const r of i)r.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:i}),_(this._octree)&&this._octree.remove(i)}}sync(){_(this._stage)&&this.updatePolicy!==CT.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(t,i){_(this._octree)&&this._octree.update(t,i)}getSpatialQueryAccelerator(){return O(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=it(this._octree)}_createOctree(){this._octree=new Gye(t=>t.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)}}function JD(e){return _(e)&&e.type===Wh.Layer}const JH={vvSizeEnabled:!1,vvSizeMinSize:Ht(1,1,1),vvSizeMaxSize:Ht(100,100,100),vvSizeOffset:Ht(0,0,0),vvSizeFactor:Ht(1,1,1),vvSizeValue:Ht(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:br()};function Wye(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add(E.SIZEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(x`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(E.SIZE,"float"),e.vertex.code.add(x`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(E.OPACITYFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(x`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add(E.COLORFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add(E.COLOR,"vec4"),e.vertex.code.add(x`vec4 getColor(){
return applyOpacity(color);
}`))}function M0(e,t){e.fragment.include(Yh),t.output===j.Shadow?(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 2.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`)):t.output===j.Depth&&e.fragment.code.add(x`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}function Xye(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?AXe(e,t):CXe(e)}function AXe(e,t){const i=!(t.draped&&t.stipplePreferContinuous);e.fragment.include(Yh),e.vertex.uniforms.add("stipplePatternPixelSize","float"),e.vertex.uniforms.add("pixelRatio","float"),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("cameraPosition","vec3"),e.vertex.code.add(x`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),e.vertex.code.add(x`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${RXe};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),e.vertex.code.add(x`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),e.vertex.code.add(x`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),e.vertex.code.add(x`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?x`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),e.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),e.fragment.uniforms.add("stipplePatternTextureSize","float"),e.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(x`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),e.fragment.code.add(x`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?x`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:x`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?x`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${t.stippleRequiresStretchMeasure?x`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:x`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?x`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:x`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?e.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function CXe(e){e.fragment.code.add(x`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}const RXe=x.float(.4),KD=1;var Lh;function OXe(e){const t=new Ri,i=e.capType!==Lh.BUTT,r=e.capType===Lh.ROUND,s=e.stippleEnabled&&r,n=e.falloffEnabled||s,o=e.innerColorEnabled||r,a=e.stippleEnabled&&e.stippleScaleWithLineWidth||r,l=e.stippleEnabled&&e.stippleScaleWithLineWidth,c=e.stippleEnabled||r;return t.include(VN),t.include(Wye,e),t.include(Xye,me(I({},e),{stippleRequiresStretchMeasure:!0})),e.output===j.Depth&&t.include(M0,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.vertex.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.SUBDIVISIONFACTOR,"float"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3"),t.attributes.add(E.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),a&&t.varyings.add("vLineWidth","float"),l&&t.varyings.add("vLineSizeInv","float"),o&&t.varyings.add("vLineDistance","float"),n&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),r&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),t.vertex.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(x`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${a?x`vLineWidth = lineWidth;`:""}
      ${l?x`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),c&&t.vertex.code.add(x`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${r?x`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),t.vertex.code.add(x`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(x`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?x`min(1.0, subdivisionFactor * ${x.float((KD+2)/(KD+1))})`:x`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.vertex.code.add(x`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(x`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${i?x`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),t.vertex.code.add(x`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${n||o?x`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${o?x`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${n?x`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),r&&t.vertex.code.add(x`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped||t.vertex.code.add(x`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(x`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?t.vertex.code.add(x`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.vertex.code.add(x`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(x`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),t.vertex.code.add(x`
      // Convert back into NDC
      pos.xy = (pos.xy / screenSize) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
    }
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.include(Rr,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(Rp),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.wireframe?t.fragment.code.add(x`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(r&&t.fragment.code.add(x`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${x.float(zn)}) {
        discard;
      }
    `),s?t.fragment.code.add(x`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${x.float(zn)}, stippleCoverage);
      `):t.fragment.code.add(x`float stippleAlpha = getStippleAlpha();`),t.fragment.code.add(x`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&t.fragment.code.add(x`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),t.fragment.code.add(x`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(x`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),t.fragment.code.add(x`
    if (finalColor.a < ${x.float(zn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===j.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}(function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"})(Lh||(Lh={}));const MXe=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:KD,get CapType(){return Lh},build:OXe}),KH={func:Di.LESS},eL={func:Di.ALWAYS},vp={mask:255},Yye={mask:0},PXe=e=>({function:{func:Di.NOTEQUAL,ref:e,mask:e},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.KEEP}}),IXe=e=>({function:{func:Di.ALWAYS,ref:e,mask:e},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.REPLACE}}),P0={function:{func:Di.ALWAYS,ref:ba.OutlineVisualElementMask,mask:ba.OutlineVisualElementMask},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.ZERO}},b0={function:{func:Di.ALWAYS,ref:ba.OutlineVisualElementMask,mask:ba.OutlineVisualElementMask},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.REPLACE}},Zye={function:{func:Di.EQUAL,ref:ba.OutlineVisualElementMask,mask:ba.OutlineVisualElementMask},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.KEEP}},Qye={function:{func:Di.NOTEQUAL,ref:ba.OutlineVisualElementMask,mask:ba.OutlineVisualElementMask},operation:{fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.KEEP}},Jye=new Map([[E.POSITION,0],[E.SUBDIVISIONFACTOR,1],[E.UV0,2],[E.AUXPOS1,3],[E.AUXPOS2,4],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.OPACITYFEATUREATTRIBUTE,7]]);class wF extends Vi{constructor(t,i,r){super(t,i,r),this.stippleTextureRepository=t.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==j.Highlight}initializeProgram(t){const i=wF.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:r.stippleScaleWithLineWidth,stipplePreferContinuous:r.stipplePreferContinuous,capType:r.capType,roundJoins:r.roundJoins,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,falloffEnabled:r.falloffEnabled,innerColorEnabled:r.innerColorEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,wireframe:r.wireframe});return new Oi(t.rctx,s,Jye)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(xl(this.program,i.camera.projectionMatrix),this.configuration.output===j.Highlight&&Pp(this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i)),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform1f("miterLimit",t.join!=="miter"?0:t.miterLimit),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),zge(this.program,t),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const o=t.stippleOffColor;this.program.setUniform4f("stippleOffColor",o[0],o[1],o[2],o.length>3?o[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",t.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",gt(t.innerColor,t.color)),this.program.setUniform1f("innerWidth",t.innerWidth*i.camera.pixelRatio))}bindDraw(t){Op(this.program,t),this.stippleEnabled&&!this.configuration.draped&&R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),v0(this.program,this.configuration,t.slicePlane,{origin:t.origin,view:t.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",hr(OR.get(),t.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(t,i){const r=this.configuration,s=t===at.NONE,n=t===at.FrontFace;return Rt({blending:r.output===j.Color||r.output===j.Alpha?s?dl:km(t):null,depthTest:{func:O0(t)},depthWrite:s?r.writeDepth&&Aa:nF(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?vp:null,stencilTest:r.sceneHasOcludees?i?b0:P0:null,polygonOffset:s||n?r.polygonOffset&&Ree:aF})}initializePipeline(){const t=this.configuration,i=t.polygonOffset&&Ree;return t.occluder&&(this._occluderPipelineTransparent=Rt({blending:dl,polygonOffset:i,depthTest:eL,depthWrite:null,colorWrite:Ft,stencilWrite:null,stencilTest:Qye}),this._occluderPipelineOpaque=Rt({blending:dl,polygonOffset:i,depthTest:eL,depthWrite:null,colorWrite:Ft,stencilWrite:Yye,stencilTest:Zye}),this._occluderPipelineMaskWrite=Rt({blending:null,polygonOffset:i,depthTest:KH,depthWrite:null,colorWrite:null,stencilWrite:vp,stencilTest:b0})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Tt.LINES:Tt.TRIANGLE_STRIP}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===ye.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===ye.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}wF.shader=new Li(MXe,()=>import("./RibbonLine.glsl.a6a4ca63.js"));const Ree={factor:0,units:-4};class kr extends dr{constructor(){super(...arguments),this.output=j.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.capType=Lh.BUTT,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1}}u([Y({count:j.COUNT})],kr.prototype,"output",void 0),u([Y()],kr.prototype,"occluder",void 0),u([Y()],kr.prototype,"slicePlaneEnabled",void 0),u([Y()],kr.prototype,"transparent",void 0),u([Y()],kr.prototype,"polygonOffset",void 0),u([Y()],kr.prototype,"writeDepth",void 0),u([Y()],kr.prototype,"draped",void 0),u([Y()],kr.prototype,"stippleEnabled",void 0),u([Y()],kr.prototype,"stippleOffColorEnabled",void 0),u([Y()],kr.prototype,"stippleScaleWithLineWidth",void 0),u([Y()],kr.prototype,"stipplePreferContinuous",void 0),u([Y({count:Lh.COUNT})],kr.prototype,"capType",void 0),u([Y()],kr.prototype,"roundJoins",void 0),u([Y()],kr.prototype,"vvSize",void 0),u([Y()],kr.prototype,"vvColor",void 0),u([Y()],kr.prototype,"vvOpacity",void 0),u([Y()],kr.prototype,"falloffEnabled",void 0),u([Y()],kr.prototype,"innerColorEnabled",void 0),u([Y()],kr.prototype,"sceneHasOcludees",void 0),u([Y({count:at.COUNT})],kr.prototype,"transparencyPassType",void 0),u([Y()],kr.prototype,"multipassTerrainEnabled",void 0),u([Y()],kr.prototype,"cullAboveGround",void 0),u([Y()],kr.prototype,"wireframe",void 0);const $Xe=he.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var ja;(function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(ja||(ja={}));class mx extends Zh{constructor(t){super(t,LXe),this._vertexAttributeLocations=Jye,this.techniqueConfig=new kr,this.layout=this.createLayout()}isClosed(t,i){return Kye(this.parameters,t,i)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(t,i){this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===ye.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins=this.parameters.join==="round",this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&_(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===Ar.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedLineGeometry(t,s,c,o,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectDrapedLineGeometry(t,i,r,s,n){if(!i.options.selectionMode)return;const o=t.vertexAttributes.get(E.POSITION).data,a=t.vertexAttributes.get(E.SIZE);let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const y=t.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0];l*=ze(this.parameters.vvSizeOffset[0]+y*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a&&(l*=a.data[0]);const c=s[0],h=s[1],p=(l/2+4)*t.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,A=o[y+4]-b,C=ze((T*w+A*S)/(T*T+A*A),0,1),R=T*C-w,L=A*C-S,U=R*R+L*L;U<f&&(f=U,g=y/3)}f<p*p&&n(r.dist,r.normal,g,!1)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||XR(i))return;if(!Jfe(r))return void $Xe.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes,a=o.get(E.POSITION).data;let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const w=o.get(E.SIZEFEATUREATTRIBUTE).data[0];l*=ze(this.parameters.vvSizeOffset[0]+w*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o.has(E.SIZE)&&(l*=o.get(E.SIZE).data[0]);const c=s.camera,h=FXe;Fs(h,s.point);const p=l*c.pixelRatio/2+4*c.pixelRatio;oe(h2[0],h[0]-p,h[1]+p,0),oe(h2[1],h[0]+p,h[1]+p,0),oe(h2[2],h[0]+p,h[1]-p,0),oe(h2[3],h[0]-p,h[1]-p,0);for(let w=0;w<4;w++)if(!c.unprojectFromRenderScreen(h2[w],Gp[w]))return;ro(c.eye,Gp[0],Gp[1],PU),ro(c.eye,Gp[1],Gp[2],IU),ro(c.eye,Gp[2],Gp[3],$U),ro(c.eye,Gp[3],Gp[0],DU);let f=Number.MAX_VALUE,g=0;const y=Y8(this.parameters,o,t.indices)?a.length-2:a.length-5;for(let w=0;w<y;w+=3){qo[0]=a[w]+r[12],qo[1]=a[w+1]+r[13],qo[2]=a[w+2]+r[14];const S=(w+3)%a.length;if(Wo[0]=a[S]+r[12],Wo[1]=a[S+1]+r[13],Wo[2]=a[S+2]+r[14],er(PU,qo)<0&&er(PU,Wo)<0||er(IU,qo)<0&&er(IU,Wo)<0||er($U,qo)<0&&er($U,Wo)<0||er(DU,qo)<0&&er(DU,Wo)<0)continue;if(c.projectToRenderScreen(qo,Z0),c.projectToRenderScreen(Wo,Q0),Z0[2]<0&&Q0[2]>0){de(od,qo,Wo);const A=c.frustum,C=-er(A[qi.NEAR],qo)/_e(od,A[qi.NEAR]);ae(od,od,C),pe(qo,qo,od),c.projectToRenderScreen(qo,Z0)}else if(Z0[2]>0&&Q0[2]<0){de(od,Wo,qo);const A=c.frustum,C=-er(A[qi.NEAR],Wo)/_e(od,A[qi.NEAR]);ae(od,od,C),pe(Wo,Wo,od),c.projectToRenderScreen(Wo,Q0)}else if(Z0[2]<0&&Q0[2]<0)continue;Z0[2]=0,Q0[2]=0;const T=u7(q_(Z0,Q0,Pee),h);T<f&&(f=T,ne(Oee,qo),ne(Mee,Wo),g=w/3)}const v=s.rayBegin,b=s.rayEnd;if(f<p*p){let w=Number.MAX_VALUE;if(Lle(q_(Oee,Mee,Pee),q_(v,b,UXe),Y0)){de(Y0,Y0,v);const S=Pe(Y0);ae(Y0,Y0,1/S),w=S/xi(v,b)}n(w,Y0,g,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=t.indices,n=r.get(E.POSITION);return eH(n,s?s.get(E.POSITION):null,s&&Y8(this.parameters,r,s),i)}createLayout(){const t=Nr().vec3f(E.POSITION).f32(E.SUBDIVISIONFACTOR).vec2f(E.UV0).vec3f(E.AUXPOS1).vec3f(E.AUXPOS2);return this.parameters.vvSizeEnabled?t.f32(E.SIZEFEATUREATTRIBUTE):t.f32(E.SIZE),this.parameters.vvColorEnabled?t.f32(E.COLORFEATUREATTRIBUTE):t.vec4f(E.COLOR),this.parameters.vvOpacityEnabled&&t.f32(E.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new NXe(this.layout,this.parameters)}requiresSlot(t,i){if(t===ye.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Ar.OccludeAndTransparentStencil)return t===ye.OPAQUE_MATERIAL||t===ye.OCCLUDER_MATERIAL||t===ye.TRANSPARENT_OCCLUDER_MATERIAL;const r=$1(i);return r===j.Color||r===j.Alpha?t===(this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===ye.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth?new DXe(t):null}validateParameters(t){t.join!=="miter"&&(t.miterLimit=0),this._requiresTransparent(t)&&(t.transparent=!0)}_requiresTransparent(t){return!!((t.color&&t.color[3])<1||t.innerWidth>0&&this._colorRequiresTransparent(t.innerColor)||t.stipplePattern&&this._colorRequiresTransparent(t.stippleOffColor)||t.falloff>0)}_colorRequiresTransparent(t){return _(t)&&t[3]<1&&t[3]>0}}class DXe extends Nm{updateParameters(t){return this.ensureTechnique(wF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const LXe=I(I({width:0,color:[1,1,1,1],join:"miter",cap:Lh.BUTT,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,wireframe:!1},Du),JH);class NXe{constructor(t,i){this.parameters=i,this.numJoinSubdivisions=0,this.vertexBufferLayout=t;const r=i.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=KD+r}}_isClosed(t){return Y8(this.parameters,t.vertexAttributes,t.indices)}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){const r=t.indices.get(E.POSITION).length/2+1,s=this._isClosed(t);let n=s?2:2*2;return n+=((s?r:r-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this.parameters.wireframe&&(n=2+4*(n-2)),n}write(t,i,r,s){var n;const o=kXe,a=zXe,l=BXe,c=i.vertexAttributes.get(E.POSITION).data,h=i.indices&&i.indices.get(E.POSITION),p=(n=i.vertexAttributes.get(E.DISTANCETOSTART))==null?void 0:n.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,g=0;this.parameters.vvSizeEnabled?g=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(f=i.vertexAttributes.get(E.SIZE).data[0]);let y=[1,1,1,1],v=0;this.parameters.vvColorEnabled?v=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(y=i.vertexAttributes.get(E.COLOR).data);let b=0;this.parameters.vvOpacityEnabled&&(b=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const w=c.length/3,S=t.transformation,T=new Float32Array(r.buffer),A=this.vertexBufferLayout.stride/4;let C=s*A;const R=C;let L=0;const U=p?(J,Z,te)=>L=p[te]:(J,Z,te)=>L+=xi(J,Z),N=(J,Z,te,ie,$,F,k)=>{if(T[C++]=Z[0],T[C++]=Z[1],T[C++]=Z[2],T[C++]=ie,T[C++]=k,T[C++]=$,T[C++]=J[0],T[C++]=J[1],T[C++]=J[2],T[C++]=te[0],T[C++]=te[1],T[C++]=te[2],this.parameters.vvSizeEnabled?T[C++]=g:T[C++]=f,this.parameters.vvColorEnabled)T[C++]=v;else{const G=Math.min(4*F,y.length-4);T[C++]=y[G+0],T[C++]=y[G+1],T[C++]=y[G+2],T[C++]=y[G+3]}this.parameters.vvOpacityEnabled&&(T[C++]=b)};C+=A,oe(a,c[0],c[1],c[2]),S&&Ue(a,a,S);const z=this._isClosed(i);if(z){const J=c.length-3;oe(o,c[J],c[J+1],c[J+2]),S&&Ue(o,o,S)}else oe(l,c[3],c[4],c[5]),S&&Ue(l,l,S),N(a,a,l,1,ja.LEFT_CAP_START,0,0),N(a,a,l,1,ja.RIGHT_CAP_START,0,0),ne(o,a),ne(a,l);const V=z?0:1,B=z?w:w-1;for(let J=V;J<B;J++){const Z=(J+1)%w*3;oe(l,c[Z+0],c[Z+1],c[Z+2]),S&&Ue(l,l,S),U(o,a,J),N(o,a,l,0,ja.LEFT_JOIN_END,J,L),N(o,a,l,0,ja.RIGHT_JOIN_END,J,L);const te=this.numJoinSubdivisions;for(let ie=0;ie<te;++ie){const $=(ie+1)/(te+1);N(o,a,l,$,ja.LEFT_JOIN_END,J,L),N(o,a,l,$,ja.RIGHT_JOIN_END,J,L)}N(o,a,l,1,ja.LEFT_JOIN_START,J,L),N(o,a,l,1,ja.RIGHT_JOIN_START,J,L),ne(o,a),ne(a,l)}z?(oe(l,c[3],c[4],c[5]),S&&Ue(l,l,S),L=U(o,a,B),N(o,a,l,0,ja.LEFT_JOIN_END,V,L),N(o,a,l,0,ja.RIGHT_JOIN_END,V,L)):(L=U(o,a,B),N(o,a,a,0,ja.LEFT_CAP_END,B,L),N(o,a,a,0,ja.RIGHT_CAP_END,B,L)),MU(T,R+A,T,R,A),C=MU(T,C-A,T,C,A),this.parameters.wireframe&&this._addWireframeVertices(r,R,C,A)}_addWireframeVertices(t,i,r,s){const n=new Float32Array(t.buffer,r*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(t.buffer,i*Float32Array.BYTES_PER_ELEMENT,r-i);let a=0;const l=c=>a=MU(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}}function MU(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function Y8(e,t,i){return Kye(e,t.get(E.POSITION).data,i?i.get(E.POSITION):null)}function Kye(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const qo=M(),Wo=M(),od=M(),Y0=M(),FXe=M(),Z0=Nn(),Q0=Nn(),Oee=M(),Mee=M(),Pee=S0(),UXe=S0(),kXe=M(),zXe=M(),BXe=M(),h2=[Nn(),Nn(),Nn(),Nn()],Gp=[M(),M(),M(),M()],PU=ii(),IU=ii(),$U=ii(),DU=ii();class eq{constructor(t,i=125e4){this._originSR=t,this._gridSize=i,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+va()}getOrigin(t){const i=this._origins.get(this._rootOriginId);if(i==null){if(_(KM))return this._origins.set(this._rootOriginId,LA(KM[0],KM[1],KM[2],this._rootOriginId)),this.getOrigin(t);const h=LA(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,h),h}const r=this._gridSize,s=Math.round(t[0]/r),n=Math.round(t[1]/r),o=Math.round(t[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*r;if(de(Ks,t,i.vec3),Ks[0]=Math.abs(Ks[0]),Ks[1]=Math.abs(Ks[1]),Ks[2]=Math.abs(Ks[2]),Ks[0]<c&&Ks[1]<c&&Ks[2]<c){if(l){const h=Math.max(...Ks);if(de(Ks,t,l.vec3),Ks[0]=Math.abs(Ks[0]),Ks[1]=Math.abs(Ks[1]),Ks[2]=Math.abs(Ks[2]),Math.max(...Ks)<h)return l}return i}return l||(l=LA(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(t,i=[1,1,0,1]){const r=window.view,s=r._stage,n=i.toString();if(!this._objects.has(n)){this._material=new mx({width:2,color:i}),s.add(this._material);const g=new qye({isPickable:!1}),y=new Bm({castShadow:!1});s.add(y),g.add(y),s.add(g),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Uint16Array(2*(l-1)),p=.5*this._gridSize;for(let g=0;g<l;g++)c[3*g+0]=t[0]+(1&a[g]?p:-p),c[3*g+1]=t[1]+(2&a[g]?p:-p),c[3*g+2]=t[2]+(4&a[g]?p:-p),g>0&&(h[2*g+0]=g-1,h[2*g+1]=g);_r(c,this._originSR,0,c,r.renderSpatialReference,0,l);const f=new or([[E.POSITION,{size:3,data:c,exclusive:!0}]],[[E.POSITION,h]],wa.Line);s.add(f),o.addGeometry(f,this._material,ss)}}let KM=null;const Ks=M();class e0e{constructor(t){this.rctx=t,this.camera=null,this.lastFrameCamera=new wi,this.pass=De.MATERIAL,this.slot=ye.OPAQUE_MATERIAL,this.highlightDepthTexture=null,this.renderOccludedMask=Iee,this.hasOccludees=!1,this.hasFillLights=!0}resetRenderOccludedMask(){this.renderOccludedMask=Iee}get isHighlightPass(){return this.pass===De.MATERIAL_HIGHLIGHT}}class VXe extends e0e{constructor(t,i,r,s,n,o){super(t),this.offscreenRenderingHelper=i,this.scenelightingData=r,this.shadowMap=s,this.ssaoHelper=n,this.sliceHelper=o}}const Iee=Ar.Occlude|Ar.OccludeAndTransparent|Ar.OccludeAndTransparentStencil;function GXe(){const e=new Ri;return e.include(C0),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("uColor","vec4"),e.fragment.code.add(x`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),e}const jXe=Object.freeze({__proto__:null,build:GXe});class lO extends Vi{initializeProgram(t){const i=lO.shader.get().build();return new Oi(t.rctx,i,mi)}initializePipeline(){return this.configuration.hasAlpha?Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft}):Rt({colorWrite:Ft})}}lO.shader=new Li(jXe,()=>import("./TextureOnly.glsl.e0af5058.js"));class tq extends dr{constructor(){super(...arguments),this.hasAlpha=!1}}u([Y()],tq.prototype,"hasAlpha",void 0);function HXe(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function LU(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function Dx(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function t0e(e){return(e+1)*(e+1)}function qXe(e){return ze(Math.floor(Math.sqrt(e)-1),0,2)}function i0e(e,t,i){const r=e[0],s=e[1],n=e[2],o=i||[];return o.length=t0e(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*n,o[3]=.4886025119*s),t>=2&&(o[4]=1.09254843059*r*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*r*n,o[8]=.54627421529*(r*r-s*s)),o}function WXe(e,t){const i=t0e(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function XXe(e,t){const i=qXe(t.r.length);for(const r of e)lo(Z8,r.direction),i0e(Z8,i,jf),HXe(jf,$I),LU(jf,r.intensity[0],Eb),Dx(t.r,Eb),LU(jf,r.intensity[1],Eb),Dx(t.g,Eb),LU(jf,r.intensity[2],Eb),Dx(t.b,Eb);return t}function YXe(e,t){i0e(Z8,0,jf);for(const i of e)t.r[0]+=jf[0]*$I[0]*i.intensity[0]*4*Math.PI,t.g[0]+=jf[0]*$I[0]*i.intensity[1]*4*Math.PI,t.b[0]+=jf[0]*$I[0]*i.intensity[2]*4*Math.PI;return t}function ZXe(e,t,i,r){WXe(t,r),oe(i.intensity,0,0,0);let s=!1;const n=QXe,o=JXe,a=KXe;n.length=0,o.length=0,a.length=0;for(const l of e)l instanceof C8&&!s?(ne(i.direction,l.direction),ne(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof C8||l instanceof ome?n.push(l):l instanceof iH?o.push(l):l instanceof ame&&a.push(l);XXe(n,r),YXe(o,r);for(const l of a)Dx(r.r,l.r),Dx(r.g,l.g),Dx(r.b,l.b)}const QXe=[],JXe=[],KXe=[],jf=[0],Eb=[0],Z8=M(),$I=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class r0e{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:M(),ambient:{color:M(),intensity:1},diffuse:{color:M(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new ame,this._mainLight={intensity:M(),direction:je(1,0,0),castShadows:!1,specularStrength:1,environmentStrength:1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(t){t.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(t,i,r){const s=i?(1-this.groundLightingFactor)*(1-this.globalFactor):0;t.setUniform1f("lightingFixedFactor",s),t.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(t),t.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),t.setUniform1f("lightingSpecularStrength",this._mainLight.specularStrength),t.setUniform1f("lightingEnvironmentStrength",this._mainLight.environmentStrength),t.setUniform1f("ambientBoostFactor",this._ambientBoost),t.setUniform1b("hasFillLights",r);const n=this._sphericalHarmonics;this._shOrder===0?t.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):this._shOrder===1?(t.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),t.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),t.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):this._shOrder===2&&(t.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),t.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),t.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),t.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),t.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),t.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),t.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}set(t){ZXe(t,this._shOrder,this._mainLight,this._sphericalHarmonics),ne(this._oldSunlight.direction,this._mainLight.direction);const i=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,ae(this._oldSunlight.diffuse.color,this._mainLight.intensity,i),ne(eP,this._oldSunlight.diffuse.color),ae(eP,eP,this._ambientBoost*this.globalFactor),pe(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,eP)}get old(){return this._oldSunlight}}const eP=M();class s0e{constructor(t){this._rctx=t,this.cache=new Map}dispose(){this.cache.forEach(t=>t.texture=et(t.texture)),this.cache.clear()}_acquire(t){if(O(t))return null;const i=this._patternId(t),r=this.cache.get(i);if(r)return r.refCount++,r.bind;const s=t.pixelRatio,{encodedData:n,sdfNormalizer:o,pixels:a,paddedPixels:l}=eYe(t.pattern,s),c=a/s,h={refCount:1,texture:null,bind:p=>(O(h.texture)&&(h.texture=new Ze(this._rctx,{width:l,height:1,internalFormat:Ie.RGBA,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE},n)),p.bindTexture(h.texture,"stipplePatternTexture"),{pixelSize:c,sdfNormalizer:o,pixels:a})};return this.cache.set(i,h),h.bind}release(t){if(O(t))return;const i=this._patternId(t),r=this.cache.get(i);r&&(r.refCount--,r.refCount===0&&(_(r.texture)&&r.texture.dispose(),this.cache.delete(i)))}swap(t,i){const r=this._acquire(i);return this.release(t),r}_patternId(t){return`${t.pattern.join(",")}-r${t.pixelRatio}`}}function eYe(e,t){const i=e.map(y=>Math.round(y*t)),r=1/t,s=Math.floor(i.reduce((y,v)=>y+v)),n=i.reduce((y,v)=>Math.max(y,v)),o=(Math.floor(.5*(n-1))+.5)*r,a=[];let l=1;for(const y of i){for(let v=0;v<y;v++){const b=l*(Math.min(v,y-1-v)+.5)*r/o*.5+.5;a.push(b)}l=-l}const c=Math.round(i[0]/2),h=[...a.slice(c),...a.slice(0,c)],p=s+2,f=new Uint8Array(4*p);let g=4;for(const y of h)qD(y,f,g),g+=4;return f.copyWithin(0,g-4,g),f.copyWithin(g,4,8),{encodedData:f,sdfNormalizer:o,paddedPixels:p,pixels:s}}var ya;function tYe(e){const t=new Ri;return t.include(C0),t.fragment.uniforms.add("tex","sampler2D"),e.function===ya.Standard&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),e.function===ya.OverlayWithTransparency&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),e.function===ya.TransparentToHUDVisibility&&t.fragment.code.add(x`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),e.function===ya.Transparency&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(x`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}(function(e){e[e.Standard=0]="Standard",e[e.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",e[e.Transparency=2]="Transparency",e[e.OverlayWithTransparency=3]="OverlayWithTransparency",e[e.COUNT=4]="COUNT"})(ya||(ya={}));const iYe=Object.freeze({__proto__:null,get CompositingFunction(){return ya},build:tYe});var Ln;(function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"})(Ln||(Ln={}));class JC extends Vi{initializeProgram(t){const i=JC.shader.get().build(this.configuration);return new Oi(t.rctx,i,mi)}initializePipeline(){if(this.configuration.function===ya.TransparentToHUDVisibility)return Rt({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case Ln.None:return Rt({colorWrite:Ft});case Ln.Alpha:return Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft});default:return Rt({blending:gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft})}}}JC.shader=new Li(iYe,()=>import("./Compositing.glsl.19d0c546.js"));class DI extends dr{constructor(){super(...arguments),this.function=ya.Standard,this.alphaMode=Ln.None,this.hasOpacityFactor=!1}}u([Y({count:ya.COUNT})],DI.prototype,"function",void 0),u([Y({count:Ln.COUNT})],DI.prototype,"alphaMode",void 0),u([Y()],DI.prototype,"hasOpacityFactor",void 0);const $ee=he.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let uh=class extends fF(we){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new r0e,this._handles=new Bt,this._frameTask=TT,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new $t,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new wr,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new e0e(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new s0e(e.renderingContext),this._shaderTechniqueRepository=new Mye({rctx:this._rctx,viewingMode:$e.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([Wt(t,"loadingState",()=>this.events.emit("content-changed")),Wt(this,"spatialReference",i=>this._localOrigins=new eq(i))]),this._materialRepository=new Vye(e.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&tL)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")},()=>this.events.emit("content-changed")),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new iH(je(1,1,1))]),this._bindParameters={slot:ye.DRAPED_MATERIAL,highlightDepthTexture:Afe(this._rctx),camera:L_,inverseViewport:Xe(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ss,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:at.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._frameTask=this.view.resourceController.scheduler.registerTask(ut.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach(e=>e.destroy()),this._layerRenderers.clear(),this._debugTextureTechnique=Wi(this._debugTextureTechnique),this._debugPatternTexture=et(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=et(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=et(this._shaderTechniqueRepository),this._temporaryFBO=et(this._temporaryFBO),this._quadVAO=et(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||Vr(this._layerRenderers,e=>e.updating)}get hasOverlays(){return _(this._overlays)&&_(this._overlayRenderTarget)}get gpuMemoryUsage(){return _(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if(_(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return gt(this._overlays,[])}ensureDrapeTargets(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasTargetWithoutRasterImage=Ise(e,i=>i.drapeTargetType===H8.WithoutRasterImage)})}ensureDrapeSources(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasDrapedFeatureSource=Vr(e,(i,r)=>r.drapeSourceType===DA.Features),t.hasDrapedRasterSource=Vr(e,(i,r)=>r.drapeSourceType===DA.RasterImage)})}ensureOverlays(e,t){O(this._overlays)&&(this._overlayRenderTarget=new xWe(this._rctx),this._overlays=[new fee(Jr.INNER,this._overlayRenderTarget),new fee(Jr.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=et(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e,t=()=>!0){this._frameTask.processQueue(e),e.done||this._processLayers(e,t)}_processLayers(e,t){let i=!1;for(const[r,s]of this._layerRenderers){if(e.done)break;(r.destroyed||t(r))&&(s.commitChanges()&&(i=!0,e.madeProgress()),s.isEmpty&&(i=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r),s.destroy()))}this._updateSortedLayerRenderers(),i&&(_(this._overlays)&&this._layerRenderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncLayers(){this._processLayers(_S,e=>e.updatePolicy===CT.SYNC)}addGeometries(e,t,i,r=!1){for(const s of e)O(s.origin)&&(s.origin=this._localOrigins.getOrigin(s.boundingSphere)),this._geometries.set(s.id,s);this._ensureLayerRenderer(t,r).add(e),i===Gt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const s of e)this._geometries.delete(s.id);const r=this._layerRenderers.get(t);r&&(r.remove(e),i===Gt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case Gt.State.TRANSFORMATION:case Gt.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e,t);case Gt.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e,t)}else $ee.warn("Attempted to update geometry for nonexistent layer")}_notifyGraphicGeometryChanged(e,t){if(O(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const s=r.graphicUid;_(s)&&s!==i&&(t.notifyGraphicGeometryChanged(s),i=s)}}_notifyGraphicVisibilityChanged(e,t){if(O(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const s=r.graphicUid;_(s)&&s!==i&&(t.notifyGraphicVisibilityChanged(s),i=s)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,Gt.State.HIGHLIGHTS):$ee.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return this._geometries.size===0&&!hi.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._layerRenderers.forEach(i=>t=i.updateAnimation(e)||t),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(r.numViews===0)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const s=t.renderPass;if(this.isEmpty()||s===De.MATERIAL_HIGHLIGHT&&!this.hasHighlights||s===De.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;const n=t.fbo;if(!n.isValid())return!1;const o=2*e.resolution,a=e.resolution;n.resize(o,a);const l=this._rctx;L_.pixelRatio=e.pixelRatio*i,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=s===De.MATERIAL_NORMAL?ye.DRAPED_WATER:ye.DRAPED_MATERIAL,e.applyViewport(this._rctx),n.bind(l),e.index===Jr.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(bi.COLOR_BUFFER_BIT));const c=t.type===ln.ColorNoRasterImage?uy.ExcludeRasterImage:t.type===ln.Occluded?uy.OccludedOnly:uy.Normal;if(c===uy.OccludedOnly&&(this._renderContext.renderOccludedMask=tL),hi.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==uy.OccludedOnly)for(let h=0;h<r.numViews;h++)this._setViewParameters(r.extents[h],e,L_),this._drawDebugTexture(e.resolution,sYe[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll(({overlayLayer:h,renderer:p})=>{if(c===uy.ExcludeRasterImage&&h.drapeSourceType===DA.RasterImage)return;const{fullOpacity:f}=h,g=_(f)&&f<1&&s===De.MATERIAL;g&&(this.bindTemporaryFramebuffer(this._rctx,o,a),l.clearSafe(bi.COLOR_BUFFER_BIT));for(let y=0;y<r.numViews;y++)this._setViewParameters(r.extents[y],e,L_),p.render(this._renderContext,this._bindParameters);g&&_(this._temporaryFBO)&&(n.bind(l),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),Ln.PremultipliedAlpha,f,ya.OverlayWithTransparency,e.index))}),l.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){O(this._temporaryFBO)&&(this._temporaryFBO=new Oye(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(e,t,i,r){let s=0;this._geometries.forEach(n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,t,0,e,s);const o=this.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,i,t,o.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,i,t,-o.range,e,s)),s++})}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.instanceParameters.visible)return;let o=0;_(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),tP[0]=i[0]-r,tP[1]=i[1]-o,tP[2]=1,iP[0]=i[0]-r,iP[1]=i[1]-o,iP[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,tP,iP,(a,l,c)=>{nYe(t,c,e.material.renderPriority,n,s,e.layerUid,e.graphicUid)},e.calculateShaderTransformation,t)}_ensureLayerRenderer(e,t){let i=this._layerRenderers.get(e);return i&&t===i instanceof QD||(i=t?new QD({rctx:this._rctx,materialRepository:this._materialRepository}):new w_({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,i),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",()=>this.events.emit("content-changed")),e),this._handles.add(Wt(i,"updating",()=>this.notifyChange("updating")),e)),i}_updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty||(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),this._layerRenderers.size===0))return;const e=this.view.map.allLayers;this._layerRenderers.forEach((t,i)=>{const r=e.indexOf(i.layer);this._sortedLayerRenderers.push(new rYe(i,t,r<0?1/0:r))}),this._sortedLayerRenderers.sort((t,i)=>t.index-i.index)}_setViewParameters(e,t,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=t.resolution,QG(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),iN(i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}_updateHasWater(){const e=Vr(this._layerRenderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Vr(this._layerRenderers,t=>t.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Vr(this._layerRenderers,t=>t.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e);const i=this._rctx,r=i.useTechnique(this._debugTextureTechnique);r.setUniform4f("uColor",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let n=0;n<t;n++)for(let o=0;o<e;o++){const a=Math.floor(o/10),l=Math.floor(n/10);a<2||l<2||10*a>e-20||10*l>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&a&&1&l?1&o^1&n?0:255:1&a^1&l?0:128)}this._debugPatternTexture=new Ze(this._rctx,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:e,height:t},i);const s=new tq;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(lO,s),this._quadVAO=fo(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};var uy;u([d()],uh.prototype,"_frameTask",void 0),u([d()],uh.prototype,"_sortedLayerRenderersDirty",void 0),u([Mn()],uh.prototype,"_shaderTechniqueRepository",void 0),u([Mn()],uh.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],uh.prototype,"view",void 0),u([d()],uh.prototype,"worldToPCSRatio",void 0),u([d()],uh.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],uh.prototype,"updating",null),uh=u([P("esri.views.3d.terrain.OverlayRenderer")],uh),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(uy||(uy={}));class rYe{constructor(t,i,r){this.overlayLayer=t,this.renderer=i,this.index=r}}const sYe=[[1,.5,.5],[.5,.5,1]];function nYe(e,t,i,r,s,n,o){const a={layerUid:n,graphicUid:o,triangleNr:t},l=c=>{c.set(lr.OVERLAY,a,e.dist,e.normal,e.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Bn.MIN&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Bn.ALL){const c=YN(s.ray);l(c),s.results.all.push(c)}}const L_=new wi;L_.near=1,L_.far=1e4,L_.relativeElevation=null;const tP=M(),iP=M(),iq=-2,tL=Ar.OccludeAndTransparent;function Dee(e){const t=[[E.POSITION,e.indices]],i=[[E.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}]];return _(e.attributeData.color)&&(i.push([E.COLOR,{size:4,data:e.attributeData.color,exclusive:!0}]),t.push([E.COLOR,new Uint32Array(e.indices.length)])),_(e.attributeData.uvMapSpace)&&(i.push([E.UVMAPSPACE,{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push([E.UVMAPSPACE,e.indices])),_(e.attributeData.boundingRect)&&(i.push([E.BOUNDINGRECT,{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push([E.BOUNDINGRECT,e.indices])),_(e.attributeData.mapPosition)&&(i.push([E.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([E.MAPPOS,e.indices])),new or(i,t)}function Lee(e){const t=[[E.POSITION,e.indices],[E.UV0,e.indices]],i=[[E.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}],[E.UV0,{size:2,data:e.attributeData.uv0,exclusive:!0}]];return _(e.attributeData.mapPosition)&&(i.push([E.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([E.MAPPOS,e.indices])),new or(i,t)}function KC(e){switch(e.type){case"extent":if(e instanceof Zt)return dc.fromExtent(e);break;case"polygon":return e}return null}function rq(e,t,i,r){const s=oO(e.rings,e.hasZ,yp.CCW_IS_HOLE),n=new Float64Array(s.position.length),o=uye(s.position,e.spatialReference,0,n,0,s.position,0,s.position.length/3,t,i,r),a=o!=null;return{position:s.position,mapPosition:n,polygons:a0e(s.polygons,s.position,n),outlines:o0e(s.outlines,s.position,n),projectionSuccess:a,sampledElevation:o}}function n0e(e,t){const i=oO(e.rings,!1,yp.CCW_IS_HOLE),r=_r(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let s=2;s<i.position.length;s+=3)i.position[s]=iq;return{position:i.position,polygons:a0e(i.polygons,i.position),outlines:o0e(i.outlines,i.position),projectionSuccess:r}}function o0e(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({index:s,count:n,position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function a0e(e,t,i){const r=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of e){if(n<=1)continue;const l=3*s,c=l+3*n,h=o.map(p=>p-s);r.push({index:s,count:n,holeIndices:h,pathLengths:a,position:t.subarray(l,c),mapPosition:i?i.subarray(l,c):void 0})}return r}function l0e(e,t){const i=e.fragment;switch(i.code.add(x`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),t.doubleSidedMode){case cr.None:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case cr.View:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case cr.WindingOrder:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:t.doubleSidedMode;case cr.COUNT:}}var cr;(function(e){e[e.None=0]="None",e[e.View=1]="View",e[e.WindingOrder=2]="WindingOrder",e[e.COUNT=3]="COUNT"})(cr||(cr={}));function sq({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(x`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):e.add(x`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function xF(e){return!!ue("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}function c0e(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add(E.MODELORIGINHI,"vec3"),e.attributes.add(E.MODELORIGINLO,"vec3"),e.attributes.add(E.MODEL,"mat3"),e.attributes.add(E.MODELNORMAL,"mat3")),t.instancedDoublePrecision&&(e.vertex.include(sq,t),e.vertex.uniforms.add("viewOriginHi","vec3"),e.vertex.uniforms.add("viewOriginLo","vec3"));const i=[x`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,x`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?x`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,x`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,x`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,t.vertexTangents?x`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:x``];e.vertex.code.add(i[0]),e.vertex.code.add(i[1]),e.vertex.code.add(i[2]),t.output===j.Normal&&e.vertex.code.add(i[3]),e.vertex.code.add(i[4])}function oYe(e,t){V8e(t,Nee,Fee,3),e.setUniform3fv("viewOriginHi",Nee),e.setUniform3fv("viewOriginLo",Fee)}const Nee=M(),Fee=M();function aYe(e){const t=x`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;e.fragment.code.add(t),e.vertex.code.add(t)}function TF(e,t){t.normalType===Or.Attribute&&(e.attributes.add(E.NORMAL,"vec3"),e.vertex.code.add(x`vec3 normalModel() {
return normal;
}`)),t.normalType===Or.CompressedAttribute&&(e.include(aYe),e.attributes.add(E.NORMALCOMPRESSED,"vec2"),e.vertex.code.add(x`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),t.normalType===Or.ScreenDerivative&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}var Or;(function(e){e[e.Attribute=0]="Attribute",e[e.CompressedAttribute=1]="CompressedAttribute",e[e.Ground=2]="Ground",e[e.ScreenDerivative=3]="ScreenDerivative",e[e.COUNT=4]="COUNT"})(Or||(Or={}));function u0e(e){e.vertex.code.add(x`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}function SF(e){e.attributes.add(E.POSITION,"vec3"),e.vertex.code.add(x`vec3 positionModel() { return position; }`)}var vs;function lYe(e){switch(e){case"multiply":default:return vs.Multiply;case"ignore":return vs.Ignore;case"replace":return vs.Replace;case"tint":return vs.Tint}}function h0e(e,t,i){if(O(e)||t===vs.Ignore)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=ze(Math.round(e[3]*iL),0,iL),s=r===0||t===vs.Tint?0:t===vs.Replace?cYe:uYe;i[0]=ze(Math.round(e[0]*Ab),0,Ab),i[1]=ze(Math.round(e[1]*Ab),0,Ab),i[2]=ze(Math.round(e[2]*Ab),0,Ab),i[3]=r+s}(function(e){e[e.Multiply=1]="Multiply",e[e.Ignore=2]="Ignore",e[e.Replace=3]="Replace",e[e.Tint=4]="Tint"})(vs||(vs={}));const Ab=255,iL=85,cYe=iL,uYe=2*iL;function d0e(e){e.vertex.code.add(x`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${x.int(vs.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${x.int(vs.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${x.int(vs.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${x.int(vs.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function p0e(e,t){t.symbolColor?(e.include(d0e),e.attributes.add(E.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float")):e.fragment.uniforms.add("colorMixMode","int"),t.symbolColor?e.vertex.code.add(x`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`):e.vertex.code.add(x`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`)}function sb(e,t){t.attributeColor?(e.attributes.add(E.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(x`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(x`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(x`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function Lx(e,t){e.include(SF),e.vertex.include(sq,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),e.vertex.uniforms.add("transformWorldFromModelRS","mat3"),e.vertex.uniforms.add("transformWorldFromModelTH","vec3"),e.vertex.uniforms.add("transformWorldFromModelTL","vec3"),e.vertex.uniforms.add("transformWorldFromViewTH","vec3"),e.vertex.uniforms.add("transformWorldFromViewTL","vec3"),e.vertex.uniforms.add("transformViewFromCameraRelativeRS","mat3"),e.vertex.uniforms.add("transformProjFromView","mat4"),e.vertex.code.add(x`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 position_view() {
return transformViewFromCameraRelativeRS * positionWorldCameraRelative();
}
void forwardPosition() {
vPositionWorldCameraRelative = positionWorldCameraRelative();
vPosition_view = position_view();
gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
}
vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),e.fragment.uniforms.add("transformWorldFromViewTL","vec3"),e.fragment.code.add(x`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}class hYe{constructor(){this.transformWorldFromModelRS=br(),this.transformWorldFromModelTH=M(),this.transformWorldFromModelTL=M()}}class f0e{constructor(){this.transformWorldFromViewTH=M(),this.transformWorldFromViewTL=M(),this.transformViewFromCameraRelativeRS=br(),this.transformProjFromView=Te()}}function m0e(e,t){e.setUniformMatrix3fv("transformWorldFromModelRS",t.transformWorldFromModelRS),e.setUniform3fv("transformWorldFromModelTH",t.transformWorldFromModelTH),e.setUniform3fv("transformWorldFromModelTL",t.transformWorldFromModelTL)}function g0e(e,t){e.setUniform3fv("transformWorldFromViewTH",t.transformWorldFromViewTH),e.setUniform3fv("transformWorldFromViewTL",t.transformWorldFromViewTL),e.setUniformMatrix4fv("transformProjFromView",t.transformProjFromView),e.setUniformMatrix3fv("transformViewFromCameraRelativeRS",t.transformViewFromCameraRelativeRS)}function EF(e,t){t.normalType===Or.Attribute||t.normalType===Or.CompressedAttribute?(e.include(TF,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add("transformNormalGlobalFromModel","mat3"),e.vertex.uniforms.add("transformNormalViewFromGlobal","mat3"),e.vertex.code.add(x`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`)):t.normalType===Or.Ground?(e.include(Lx,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(x`
    void forwardNormal() {
      vNormalWorld = ${t.viewingMode===$e.Global?x`normalize(vPositionWorldCameraRelative);`:x`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(x`void forwardNormal() {}`)}function dYe(e,t){e.setUniformMatrix4fv("viewNormal",t)}function y0e(e,t){const i=e.vertex.code,r=e.fragment.code,s=t.hasModelTransformation;t.output!==j.Depth&&t.output!==j.Shadow||(e.include(Un,{linearDepth:!0,hasModelTransformation:s}),e.include(tm,t),e.include($x,t),e.include(M0,t),e.include(Rr,t),e.vertex.uniforms.add("nearFar","vec2"),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPositionWithDepth(proj, view, ${s?"model,":""} vpos, nearFar, depth);
        forwardTextureCoordinates();
      }
    `),e.include(rm,t),r.add(x`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),t.output===j.Normal&&(e.include(Un,{linearDepth:!1,hasModelTransformation:s}),e.include(TF,t),e.include(EF,t),e.include(tm,t),e.include($x,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vPositionView","vec3"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${t.normalType===Or.Attribute?x`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(Rr,t),e.include(rm,t),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${t.normalType===Or.ScreenDerivative?x`
            vec3 normal = screenDerivativeNormal(vPositionView);`:x`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),t.output===j.Highlight&&(e.include(Un,{linearDepth:!1,hasModelTransformation:s}),e.include(tm,t),e.include($x,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(Rr,t),e.include(rm,t),e.include(Fm),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}function v0e(e,t){const i=e.fragment;t.vertexTangents?(e.attributes.add(E.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),t.doubleSidedMode===cr.WindingOrder?i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),t.attributeTextureCoordinates!==mn.None&&(e.include(zj,t),i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),i.code.add(x`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}function AF(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(x`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
}`)):i.code.add(x`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}function D1(e,t){const i=e.fragment;e.include(BN),e.include(AF,t),t.pbrMode!==xt.Disabled&&e.include(gF,t),e.include(Vj,t),t.receiveShadows&&e.include(wm,t),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),i.uniforms.add("hasFillLights","bool"),e.include(VN),i.code.add(x`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${t.pbrMode===xt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.code.add(x`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${t.viewingMode===$e.Global?x`normalize(vPosWorld)`:x`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.code.add(x`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),t.pbrMode===xt.Disabled||t.pbrMode===xt.WaterOnIntegratedMesh?i.code.add(x`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`):t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||(i.code.add(x`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(x`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),i.code.add(x`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.code.add(x`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(x`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${t.pbrMode===xt.Schematic?x`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:x`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}function _0e(e,t){const i=x`
  /*
  *  ${t.name}
  *  ${t.output===j.Color?"RenderOutput: Color":t.output===j.Depth?"RenderOutput: Depth":t.output===j.Shadow?"RenderOutput: Shadow":t.output===j.Normal?"RenderOutput: Normal":t.output===j.Highlight?"RenderOutput: Highlight":""}
  */
  `;SC()&&(e.fragment.code.add(i),e.vertex.code.add(i))}function eR(e){e.include(Rp),e.code.add(x`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${x.int(vs.Multiply)}) {
        return allMixed;
      }
      else if (mode == ${x.int(vs.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(vs.Replace)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${x.int(vs.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(vs.Replace)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}function pYe(e){const t=new Ri,i=t.vertex.code,r=t.fragment.code;t.include(_0e,{name:"Default Material Shader",output:e.output}),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3");const s=e.hasModelTransformation;return s&&t.vertex.uniforms.add("model","mat4"),t.include(SF),t.varyings.add("vpos","vec3"),t.include($x,e),t.include(c0e,e),t.include(Vge,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(TF,e),t.include(Un,{linearDepth:!1,hasModelTransformation:s}),e.normalType===Or.Attribute&&e.offsetBackfaces&&t.include(u0e),t.include(v0e,e),t.include(EF,e),e.instancedColor&&t.attributes.add(E.INSTANCECOLOR,"vec4"),t.varyings.add("localvpos","vec3"),t.include(tm,e),t.include(aO,e),t.include(p0e,e),t.include(sb,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i.add(x`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${x.float(zn)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${e.normalType===Or.Attribute?x`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.vertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
          ${e.normalType===Or.Attribute&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),e.output===j.Alpha&&(t.include(Rr,e),t.include(rm,e),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(eR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===j.Color&&(t.include(Rr,e),t.include(D1,e),t.include(AF,e),t.include(rm,e),e.receiveShadows&&t.include(wm,e),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(Bj,e),t.include(gF,e),t.fragment.include(eR),t.include(l0e,e),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${e.normalType===Or.ScreenDerivative?x`
        vec3 normal = screenDerivativeNormal(localvpos);`:x`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${e.pbrMode===xt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===$e.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${e.hasNormalTexture?x`
              mat3 tangentSpace = ${e.vertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?e.viewingMode===$e.Global?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(y0e,e),t}const fYe=Object.freeze({__proto__:null,build:pYe}),mYe=he.getLogger("esri.views.3d.webgl-engine.shaders.DefaultTechnique");class cO extends Vi{initializeProgram(t){const i=cO.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,viewingMode:t.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?r.isSchematic?xt.Schematic:xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,hasColorTexture:r.hasColorTexture,hasModelTransformation:r.hasModelTransformation,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:r.normalsTypeDerivate?Or.ScreenDerivative:Or.Attribute,doubleSidedMode:r.doubleSidedMode,vertexTangents:r.vertexTangents,attributeTextureCoordinates:r.hasMetalnessAndRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture||r.hasColorTexture?mn.Default:mn.None,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:xF(t.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,mi)}bindPass(t,i){var r,s;xl(this.program,i.camera.projectionMatrix);const n=this.configuration.output;this.configuration.hasModelTransformation&&(_(t.modelTransformation)?this.program.setUniformMatrix4fv("model",t.modelTransformation):mYe.warnOnce("hasModelTransformation true, but no modelTransformation found.")),(this.configuration.output===j.Depth||i.multipassTerrainEnabled||n===j.Shadow)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i)),n===j.Alpha&&(this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",V8[t.colorMixMode])),n===j.Color?(i.lighting.setUniforms(this.program,!1,i.hasFillLights),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",V8[t.colorMixMode]),this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.configuration.usePBR&&zfe(this.program,t,this.configuration.isSchematic)):n===j.Highlight&&Pp(this.program,i),Jje(this.program,t),NH(this.program,t,i),WC(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),t.textureAlphaMode!==Ai.Mask&&t.textureAlphaMode!==Ai.MaskBlend||this.program.setUniform1f("textureAlphaCutoff",t.textureAlphaCutoff),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(t){const i=this.configuration.instancedDoublePrecision?je(t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]):t.origin;Yfe(this.program,i,t.camera.viewMatrix),this.program.rebindTextures(),(this.configuration.output===j.Color||this.configuration.output===j.Alpha||this.configuration.output===j.Depth&&this.configuration.screenSizePerspective||this.configuration.output===j.Normal&&this.configuration.screenSizePerspective||this.configuration.output===j.Highlight&&this.configuration.screenSizePerspective)&&R0(this.program,i,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Normal&&this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&oYe(this.program,i),v0(this.program,this.configuration,t.slicePlane,{origin:i}),this.configuration.output===j.Color&&RWe(this.program,t,i)}_convertDepthTestFunction(t){return t===_1.Lequal?Di.LEQUAL:Di.LESS}_setPipeline(t,i){const r=this.configuration,s=t===at.NONE,n=t===at.FrontFace;return Rt({blending:r.output!==j.Color&&r.output!==j.Alpha||!r.transparent?null:s?dl:km(t),culling:gYe(r)&&zN(r.cullFace),depthTest:{func:O0(t,this._convertDepthTestFunction(r.customDepthTest))},depthWrite:s||n?r.writeDepth&&Aa:null,colorWrite:Ft,stencilWrite:r.sceneHasOcludees?vp:null,stencilTest:r.sceneHasOcludees?i?b0:P0:null,polygonOffset:s||n?null:lF(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipeline(this.configuration.transparencyPassType,!0),this._setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}function gYe(e){return e.cullFace?e.cullFace!==$i.None:!e.slicePlaneEnabled&&!e.transparent&&!e.doubleSidedMode}cO.shader=new Li(fYe,()=>import("./DefaultMaterial.glsl.d1442405.js"));class ci extends dr{constructor(){super(...arguments),this.output=j.Color,this.alphaDiscardMode=Ai.Opaque,this.doubleSidedMode=cr.None,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=$i.None,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.hasModelTransformation=!1,this.customDepthTest=_1.Less}}u([Y({count:j.COUNT})],ci.prototype,"output",void 0),u([Y({count:Ai.COUNT})],ci.prototype,"alphaDiscardMode",void 0),u([Y({count:cr.COUNT})],ci.prototype,"doubleSidedMode",void 0),u([Y()],ci.prototype,"isSchematic",void 0),u([Y()],ci.prototype,"vertexColors",void 0),u([Y()],ci.prototype,"offsetBackfaces",void 0),u([Y()],ci.prototype,"symbolColors",void 0),u([Y()],ci.prototype,"vvSize",void 0),u([Y()],ci.prototype,"vvColor",void 0),u([Y()],ci.prototype,"verticalOffset",void 0),u([Y()],ci.prototype,"receiveShadows",void 0),u([Y()],ci.prototype,"slicePlaneEnabled",void 0),u([Y()],ci.prototype,"sliceHighlightDisabled",void 0),u([Y()],ci.prototype,"receiveAmbientOcclusion",void 0),u([Y()],ci.prototype,"screenSizePerspective",void 0),u([Y()],ci.prototype,"textureAlphaPremultiplied",void 0),u([Y()],ci.prototype,"hasColorTexture",void 0),u([Y()],ci.prototype,"usePBR",void 0),u([Y()],ci.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([Y()],ci.prototype,"hasEmissionTexture",void 0),u([Y()],ci.prototype,"hasOcclusionTexture",void 0),u([Y()],ci.prototype,"hasNormalTexture",void 0),u([Y()],ci.prototype,"instanced",void 0),u([Y()],ci.prototype,"instancedColor",void 0),u([Y()],ci.prototype,"instancedDoublePrecision",void 0),u([Y()],ci.prototype,"vertexTangents",void 0),u([Y()],ci.prototype,"normalsTypeDerivate",void 0),u([Y()],ci.prototype,"writeDepth",void 0),u([Y()],ci.prototype,"sceneHasOcludees",void 0),u([Y()],ci.prototype,"transparent",void 0),u([Y()],ci.prototype,"enableOffset",void 0),u([Y({count:$i.COUNT})],ci.prototype,"cullFace",void 0),u([Y({count:at.COUNT})],ci.prototype,"transparencyPassType",void 0),u([Y()],ci.prototype,"multipassTerrainEnabled",void 0),u([Y()],ci.prototype,"cullAboveGround",void 0),u([Y()],ci.prototype,"hasModelTransformation",void 0),u([Y({count:_1.COUNT})],ci.prototype,"customDepthTest",void 0);function yYe(e){const t=new Ri,i=t.vertex.code,r=t.fragment.code;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.include(SF),t.varyings.add("vpos","vec3"),t.include($x,e),t.include(c0e,e),t.include(Vge,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(TF,e),t.include(Un,{linearDepth:!1}),e.offsetBackfaces&&t.include(u0e),e.instancedColor&&t.attributes.add(E.INSTANCECOLOR,"vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.include(tm,e),t.include(aO,e),t.include(p0e,e),t.include(sb,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),i.add(x`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${x.float(zn)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${e.multipassTerrainEnabled?x`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),e.output===j.Alpha&&(t.include(Rr,e),t.include(rm,e),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(eR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===j.Color&&(t.include(Rr,e),t.include(D1,e),t.include(AF,e),t.include(rm,e),e.receiveShadows&&t.include(wm,e),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(Bj,e),t.include(gF,e),t.fragment.include(eR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${e.pbrMode===xt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===$e.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${x`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?e.viewingMode===$e.Global?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(y0e,e),t}const vYe=Object.freeze({__proto__:null,build:yYe});class CF extends cO{initializeProgram(t){const i=CF.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,viewingMode:t.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:r.hasColorTexture,hasModelTransformation:!1,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:Or.Attribute,doubleSidedMode:cr.WindingOrder,vertexTangents:!1,attributeTextureCoordinates:r.hasColorTexture?mn.Default:mn.None,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:xF(t.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,mi)}}CF.shader=new Li(vYe,()=>import("./RealisticTree.glsl.5905dba1.js"));class L1 extends Zh{constructor(t){super(t,bYe),this.supportsEdges=!0,this.techniqueConfig=new ci,this.vertexBufferLayout=xYe(this.parameters),this.instanceBufferLayout=t.instanced?b0e(this.parameters):null}isVisibleInPass(t){return t!==De.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;if(!super.isVisible()||t.layerOpacity===0)return!1;const i=t.instanced,r=t.vertexColors,s=t.symbolColors,n=!!i&&i.indexOf("color")>-1,o=t.vvColorEnabled,a=t.colorMixMode==="replace",l=t.opacity>0,c=t.externalColor&&t.externalColor[3]>0;return r&&(n||o||s)?!!a||l:r?a?c:l:n||o||s?!!a||l:a?c:l}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=this.parameters.verticalOffset!==null,this.techniqueConfig.screenSizePerspective=this.parameters.screenSizePerspective!==null,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate=this.parameters.normals==="screenDerivative",this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,_(this.parameters.customDepthTest)&&(this.techniqueConfig.customDepthTest=this.parameters.customDepthTest),this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?$i.None:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig.hasModelTransformation=_(this.parameters.modelTransformation),t!==j.Color&&t!==j.Alpha||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=cr.WindingOrder:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?cr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?cr.WindingOrder:cr.None,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!i.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<oF),this.techniqueConfig}intersect(t,i,r,s,n,o,a){if(this.parameters.verticalOffset!==null){const l=s.camera;oe(FU,r[12],r[13],r[14]);let c=null;switch(s.viewingMode){case $e.Global:c=be(Uee,FU);break;case $e.Local:c=ne(Uee,EYe)}let h=0;if(this.parameters.verticalOffset!==null){const p=de(AYe,FU,l.eye),f=Pe(p),g=ae(p,p,1/f);let y=null;this.parameters.screenSizePerspective&&(y=_e(c,g)),h+=xge(l,f,this.parameters.verticalOffset,y,this.parameters.screenSizePerspective)}ae(c,c,h),rl(NU,c,s.transform.inverseRotation),n=de(TYe,n,NU),o=de(SYe,o,NU)}rF(t,i,s,n,o,R8(s.verticalOffset),a)}requiresSlot(t){return t===(this.parameters.transparent?this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:ye.OPAQUE_MATERIAL)||t===ye.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Depth||t.output===j.Normal||t.output===j.Shadow||t.output===j.Highlight?new _Ye(t):null}createBufferWriter(){return new wYe(this.vertexBufferLayout,this.instanceBufferLayout)}}class _Ye extends MH{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){const i=this._material.parameters;return this.updateTexture(i.textureId),this.ensureTechnique(i.treeRendering?CF:cO,t)}_updateShadowState(t){t.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:t.shadowMappingEnabled})}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.parameters,t),this.bindTextures(i.program)}}const bYe=I({textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:$i.Back,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,fillLightsEnabled:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:br(),modelTransformation:null,transparent:!1,writeDepth:!0,customDepthTest:_1.Less,textureAlphaMode:Ai.Blend,textureAlphaCutoff:WD,textureAlphaPremultiplied:!1,sceneHasOcludees:!1},Du);class wYe{constructor(t,i){this.vertexBufferLayout=t,this.instanceBufferLayout=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){sF(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}function xYe(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=Nr().vec3f(E.POSITION).vec3f(E.NORMAL);return e.vertexTangents&&i.vec4f(E.TANGENT),t&&i.vec2f(E.UV0),e.vertexColors&&i.vec4u8(E.COLOR),e.symbolColors&&i.vec4u8(E.SYMBOLCOLOR),i}function b0e(e){let t=Nr();return t=e.instancedDoublePrecision?t.vec3f(E.MODELORIGINHI).vec3f(E.MODELORIGINLO).mat3f(E.MODEL).mat3f(E.MODELNORMAL):t.mat4f(E.MODEL).mat4f(E.MODELNORMAL),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f(E.INSTANCECOLOR)),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f(E.INSTANCEFEATUREATTRIBUTE)),t}const TYe=M(),SYe=M(),EYe=je(0,0,1),Uee=M(),NU=M(),FU=M(),AYe=M(),CYe=["polygon","extent"];class RYe extends $p{constructor(t,i,r,s){super(t,i,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=cF(this._getSymbolSize());if(a)throw new Q("graphics3dextrudesymbollayer:invalid-size",a)}const t=bs(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),r=aa(i),s=i[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:s,transparent:n,cullFace:n?$i.None:$i.Back,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new L1(o),this._bottomMaterial=new L1(me(I({},o),{cullFace:$i.Back})),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,CYe,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new xc);return this._createAs3DShape(i,t.renderingInfo,r,s,i.uid)}layerOpacityChanged(t,i){const r=bs(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(r),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();return t.forEach(a=>{const l=i(a);_(l)&&l.layerOpacityChanged(o,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,_0)}slicePlaneEnabledChanged(t,i){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(t){let i;var r;return t.size&&this._drivenProperties.size?i=(r=dWe(t.size,2))!=null?r:0:i=this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(t,i){return this._drivenPropertiesChanged(i)?xs.Recreate_Symbol:xs.Recreate_Graphics}_getSymbolSize(){var t;return(t=this.symbolLayer.size)!=null?t:1}_createAs3DShape(t,i,r,s,n){const o=KC(t.geometry);if(O(o))return null;const a=rq(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);if(this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer"),o.rings.length===0||!o.rings.some(te=>te.length>0))return null;const l=kH(o);if(O(l))return null;const c=new Array,h=new Array,p=new Array,f=os(),g=Te(),y=M(),v=this._context.renderCoordsHelper.viewingMode===$e.Global;v||this._context.renderCoordsHelper.worldUpAtPosition(null,y),Gh(o.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);const b=Te();hr(b,g);const w=br();OT(w,b);const{polygons:S,mapPosition:T,position:A}=a,C=A.length/3,R=new Float64Array(3*C*6),L=new Float64Array(3*C*6),U=new Float64Array(3*C*6),N=new Float64Array(1*C*6);let z=0;for(let te=0;te<S.length;++te){const ie=S[te],$=ie.count;if(this._context.clippingExtent&&(Ui(f),ic(f,ie.mapPosition),!Ah(f,this._context.clippingExtent)))continue;const F=jT(ie.mapPosition,ie.holeIndices,3);if(F.length===0)continue;const k=3*$*2+F.length,G=new Uint32Array(k),q=new Uint32Array(F.length),K=6*$,H=3*R.BYTES_PER_ELEMENT,ee=new jr(R.buffer,z*H,H,(z+K)*H),ge=3*L.BYTES_PER_ELEMENT,Ae=new jr(L.buffer,z*ge,ge,(z+K)*ge),Be=new Float64Array(U.buffer,3*z*U.BYTES_PER_ELEMENT,3*K),Se=new Float64Array(N.buffer,1*z*N.BYTES_PER_ELEMENT,1*K),xe=this._getExtrusionSize(i);OYe(A,T,F,ie,ee.typedBuffer,Be,Ae.typedBuffer,Se,0,G,q,xe,y,v),nO(ee,ee,b),I1(Ae,Ae,w),z+=6*$;const Re=kee(G,G.length-q.length,{positions:ee.typedBuffer,elevation:Be,normals:Ae.typedBuffer,heights:Se},r);c.push(Re),h.push(this._material),p.push(ss);const ke=kee(q,0,{positions:ee.typedBuffer,elevation:Be,normals:Ae.typedBuffer,heights:Se},r);c.push(ke),h.push(this._bottomMaterial),p.push(ss)}if(c.length===0)return null;const V=new Bm({geometries:c,materials:h,transformations:p,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});V.transformation=g;const B=vye(this.symbolLayer,{opacity:this._getLayerOpacity()}),J=_(B)?{baseMaterial:this._material,edgeMaterials:[B],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,Z=new Ip(this,V,c,null,null,IYe,s,J);return Z.alignedSampledElevation=a.sampledElevation,Z.needsElevationUpdates=_0(s.mode),Z}}function kee(e,t,i,r){const s=new Uint32Array(e.length),n=[[E.POSITION,{size:3,data:i.positions,exclusive:!0}],[E.NORMAL,{size:3,data:i.normals,exclusive:!0}],[E.COLOR,{size:4,data:r,exclusive:!0}],[E.SIZE,{size:1,data:i.heights,exclusive:!0}]],o=[[E.POSITION,e],[E.NORMAL,e],[E.COLOR,s]];return i.elevation&&(n.push([E.MAPPOS,{size:3,data:i.elevation}]),o.push([E.MAPPOS,e])),new or(n,o,wa.Triangle,t)}function OYe(e,t,i,r,s,n,o,a,l,c,h,p,f,g){const y=i.length/3;let v=0,b=2*r.count;MYe(e,t,r.index,r.count,i,0,y,s,n,o,a,l,c,h,b,p,f,g),l+=2*r.count,b=0,zee(s,n,a,o,v,r.pathLengths[0],r.count,l,c,b,p),l+=4*r.pathLengths[0],b+=2*r.pathLengths[0],v+=r.pathLengths[0];for(let w=1;w<r.pathLengths.length;++w)zee(s,n,a,o,v,r.pathLengths[w],r.count,l,c,b,p),l+=4*r.pathLengths[w],b+=2*r.pathLengths[w],v+=r.pathLengths[w]}function MYe(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b,w){ne(Xo,b);const S=v>0?1:-1;let T=3*i,A=p,C=3*A,R=p+r,L=3*R;for(let z=0;z<r;++z)w&&(Xo[0]=e[T+0],Xo[1]=e[T+1],Xo[2]=e[T+2],be(Xo,Xo)),a[C+0]=e[T+0],a[C+1]=e[T+1],a[C+2]=e[T+2],l[C+0]=t[T+0],l[C+1]=t[T+1],l[C+2]=t[T+2],c[C+0]=-S*Xo[0],c[C+1]=-S*Xo[1],c[C+2]=-S*Xo[2],h[A]=0,a[L+0]=e[T+0]+v*Xo[0],a[L+1]=e[T+1]+v*Xo[1],a[L+2]=e[T+2]+v*Xo[2],l[L+0]=t[T+0],l[L+1]=t[T+1],l[L+2]=t[T+2],c[L+0]=S*Xo[0],c[L+1]=S*Xo[1],c[L+2]=S*Xo[2],h[R]=v,C+=3,L+=3,T+=3,A+=1,R+=1;T=3*n,C=0,L=3*y;const U=v<0?qee:Hee,N=v<0?Hee:qee;for(let z=0;z<o;++z)g[C+0]=s[T+U[0]],g[C+1]=s[T+U[1]],g[C+2]=s[T+U[2]],f[L+0]=s[T+N[0]]+r,f[L+1]=s[T+N[1]]+r,f[L+2]=s[T+N[2]]+r,C+=3,L+=3,T+=3}function rP(e,t,i,r,s,n,o){r[n]=r[o],o*=3,e[(n*=3)+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],t[n+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const d2=M();function zee(e,t,i,r,s,n,o,a,l,c,h){let p=s,f=s+1,g=s+o,y=s+o+1,v=a,b=a+1,w=a+2*n,S=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let T=0;T<n;++T)T===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),PYe(e,p,f,g,d2),rP(e,t,r,i,d2,v,p),rP(e,t,r,i,d2,b,f),rP(e,t,r,i,d2,w,g),rP(e,t,r,i,d2,S,y),l[c++]=v,l[c++]=w,l[c++]=S,l[c++]=v,l[c++]=S,l[c++]=b,p++,f++,g++,y++,v+=2,b+=2,w+=2,S+=2}const UU=M(),Bee=M(),Vee=M(),Gee=M(),jee=M();function PYe(e,t,i,r,s){t*=3,i*=3,r*=3,oe(UU,e[t++],e[t++],e[t++]),oe(Bee,e[i++],e[i++],e[i++]),oe(Vee,e[r++],e[r++],e[r++]),de(Gee,Bee,UU),de(jee,Vee,UU),dt(s,jee,Gee),be(s,s)}const Cb=M();function IYe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords,o=n.length,a=t.mode!=="absolute-height";let l=0;const c=s.transformation,h=hr(Te(),c);for(let p=0;p<o;p+=2){const f=n[p].geometry,g=f.getMutableAttribute(E.POSITION).data,y=f.vertexAttributes.get(E.SIZE).data,v=f.vertexAttributes.get(E.MAPPOS).data,b=new Ape(v),w=g.length/3;let S=0,T=!1,A=0;const C=i.spatialReference;for(let R=0;R<w;R++){Cb[0]=g[S],Cb[1]=g[S+1],Cb[2]=g[S+2],bm(b,i,t,r,sP),a&&(A+=sP.sampledElevation),hi.TESTS_DISABLE_OPTIMIZATIONS?(oe(Ma,b.array[b.offset+0],b.array[b.offset+1],sP.z+y[S/3]),r.toRenderCoords(Ma,C,Ma),Ue(Ma,Ma,h)):(oe(Ma,g[S+0],g[S+1],g[S+2]),Ue(Ma,Ma,c),r.setAltitude(Ma,sP.z+y[S/3]),Ue(Ma,Ma,h)),g[S]=Ma[0],g[S+1]=Ma[1],g[S+2]=Ma[2];const L=$Ye/r.unitInMeters;(Math.abs(Cb[0]-g[S])>=L||Math.abs(Cb[1]-g[S+1])>=L||Math.abs(Cb[2]-g[S+2])>=L)&&(T=!0),b.offset+=3,S+=3}T&&(f.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p]),n[p+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p+1])),l+=A/w}return l/o}const Ma=M(),Xo=M(),sP=new sO,Hee=[0,2,1],qee=[0,1,2],$Ye=.01;function DYe(e,t,i,r,s){const n=e.referencesGeometry()&&s?LYe(t,r,s):t,o=e.repurposeFeature(n);try{return e.evaluate(me(I({},i),{$feature:o}))}catch(a){return he.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const kU=new Map;function LYe(e,t,i){const{transform:r,hasZ:s,hasM:n}=i;kU.has(t)||kU.set(t,NYe(t));const o=kU.get(t)(e.geometry,r,s,n);return me(I({},e),{geometry:o})}function NYe(e){const t={};switch(e){case"esriGeometryPoint":return(i,r,s,n)=>Jge(r,t,i,s,n);case"esriGeometryPolygon":return(i,r,s,n)=>Kge(r,t,i,s,n);case"esriGeometryPolyline":return(i,r,s,n)=>eye(r,t,i,s,n);case"esriGeometryMultipoint":return(i,r,s,n)=>Qge(r,t,i,s,n);default:return he.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Q("mapview-arcade",`Unable to handle geometryType: ${e}`)),i=>i}}const Zpt=1.2,FYe=H_,UYe=Zd;class RF{constructor(t,i,r){this.graphics3DSymbolLayer=t,this.renderGeometries=i,this.boundingBox=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._graphicsCoreOwner=null,this.isElevationSource=!1}initialize(t,i,r){this.stage=t,this._graphicsCoreOwner=r,this._overlayRenderer=this._graphicsCoreOwner.view.basemapTerrain.overlayManager.renderer}setVisibility(t){if(this.stage!=null&&this._visible!==t){if(this._visible=t,t&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.Geometry.ADD);if(t||this._addedToStage){for(const i of this.renderGeometries)i.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.State.VISIBILITIES)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(t=M()){return oe(t,0,0,0)}getBoundingBoxObjectSpace(t=os()){return Ui(t)}addObjectState(t,i){t===vm.Highlight&&(this.renderGeometries.forEach(r=>{const s=r.addHighlight();i.addRenderGeometry(r,s,this)}),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner))}removeObjectState(t){this.renderGeometries.forEach(i=>{t.removeRenderGeometry(i)})}removeRenderGeometryObjectState(t,i){t.removeHighlight(i),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner)}computeAttachmentOrigin(t){for(const i of this.renderGeometries)i.computeAttachmentOrigin(Rb)&&(t.draped.origin[0]+=Rb[0],t.draped.origin[1]+=Rb[1],t.draped.num++)}async getProjectedBoundingBox(t,i,r,s,n){Ui(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,t,Wee,r),CSe(n,Wee)}if(i){let o;Eh(n,Rb);const a=zH(n,i);try{o=await i.service.queryElevation(Rb[0],Rb[1],s,a,"ground")}catch{}_(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(t,i,r,s){if(this.boundingBox)BL(ad,this.boundingBox);else{const n=t.boundingSphere,o=n[3];ad[0]=n[0]-o,ad[1]=n[1]-o,ad[2]=n[2]-o,ad[3]=n[0]+o,ad[4]=n[1]+o,ad[5]=n[2]+o}return i(ad,0,2),this.calculateRelativeScreenBounds&&s.push({location:Eh(ad),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),OG(ad,r)}}const Wee=Dt(),ad=os(),Rb=M();class w0e{constructor(t,i,r,s=2048){this.text=t,this._alignment=i,this._parameters=r,this.maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetrics=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._ensureTextWidth()+2*this.backgroundHorizontalPadding)}get displayHeight(){const t=this.lineSpacing*(this._lines.length-1),i=this.lineHeight;return Math.ceil(t+i+2*this.haloSize+this.backgroundTopPadding+this.backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this.firstLineYOffset+this.baselinePosition)}get firstLineYOffset(){return this.backgroundTopPadding+this.haloSize}get heightMetrics(){return this._ensureHeightMetrics()}get lineSpacing(){return(this.lineHeight+this.linePadding)*this._parameters.definition.lineSpacingFactor}get lineHeight(){return this.heightMetrics.lineHeight}get linePadding(){return this.lineHeight*kYe}get baselinePosition(){return this.heightMetrics.baselinePosition}get renderedFontSize(){return this._toRenderUnit(this.fontSize)}get fontSize(){return this._parameters.definition.size}get renderedHaloSize(){return this._toRenderUnit(this.haloSize)}get haloSize(){return this._parameters.haloSize}get backgroundHorizontalPadding(){return this.hasBackground?this._parameters.definition.background.padding[0]:0}get backgroundVerticalPadding(){return this.hasBackground?this._parameters.definition.background.padding[1]:0}get backgroundTopPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingTop)}get backgroundBottomPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingBottom)}get hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(O(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this.maxSize/this.displayWidth,this.maxSize/this.displayHeight)):this._renderPixelRatio=t}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case Qy.Left:return this.backgroundHorizontalPadding;case Qy.Center:return(this.displayWidth-this._lineWidths[t])/2;case Qy.Right:return this.displayWidth-this.backgroundHorizontalPadding-this._lineWidths[t]}}render(t,i=0,r=0){t.save();const s=i/=this.renderPixelRatio,n=r/=this.renderPixelRatio,o=this.haloSize,a=this.firstLineYOffset;i+=o,r+=a+this.baselinePosition;const l=this.haloSize>0;l&&this._renderHalo(t,s,n,o,a),this._setFontProperties(t,this.renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,h,i+p,r),this._renderLineDecoration(t,i+p,r,this._textWidths[c])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,h,i+this._getLineXOffset(c),r),this._renderLineDecoration(t,i+p,r,this._textWidths[c]),r+=this.lineSpacing}if(hi.TEXT_SHOW_BASELINE){t.strokeStyle=Xee,t.setLineDash([2,2]),t.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this.baselinePosition;this._drawLine(t,[s,p],[s+this.displayWidth,p]),c+=this.lineSpacing}}if(hi.TEXT_SHOW_BORDER&&(t.strokeStyle=Xee,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,n],[this.displayWidth,this.displayHeight])),this.hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,n,c),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,i,r,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":r+=2*a;break;case"line-through":r-=.33*this.baselinePosition}const l=n?this.haloSize:0;t.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(a+2*l),t.beginPath(),t.moveTo(this._toRenderUnit(i-l),this._toRenderUnit(r)),t.lineTo(this._toRenderUnit(i+s+l),this._toRenderUnit(r)),t.stroke()}_roundedRect(t,i,r,s){i=this._toRenderUnit(i),r=this._toRenderUnit(r);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=ze(s,0,Math.floor(o/2)),t.beginPath(),t.moveTo(i,r+s),t.arcTo(i,r,i+s,r,s),t.lineTo(i+n-s,r),t.arcTo(i+n,r,i+n,r+s,s),t.lineTo(i+n,r+o-s),t.arcTo(i+n,r+o,i+n-s,r+o,s),t.lineTo(i+s,r+o),t.arcTo(i,r+o,i,r+o-s,s),t.closePath()):t.rect(i,r,n,o)}_renderHalo(t,i,r,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=LI(zU,Math.max(o,Ob),Math.max(a,Ob)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this.baselinePosition;for(let f=0;f<this._lines.length;++f){const g=this._getLineXOffset(f);this._renderLineDecoration(c,s+g,p,this._textWidths[f],!0),p+=this.lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(l,0,0,o,a,this._toRenderUnit(i),this._toRenderUnit(r),o,a),t.globalAlpha=1}_renderHaloEmulated(t,i,r){r+=this.baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of x0e)this._fillText(t,n,i+o+this.haloSize*a,r+this.haloSize*l);r+=this.lineSpacing}}_renderHaloNative(t,i,r){const s=2*this.haloSize;r+=this.baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;t.lineWidth=this._toRenderUnit(p*s),this._strokeText(t,o,i+a,r)}r+=this.lineSpacing}}_setFontProperties(t,i){t.font=this._parameters.fontString(i),t.textAlign="left",t.textBaseline="alphabetic"}_ensureTextWidth(){if(_(this._displayWidth))return this._displayWidth;const t=LI(zU,Ob,Ob).getContext("2d");this._setFontProperties(t,this.fontSize);let i=2*this.haloSize;const r=this._parameters.definition.font;r.style!=="italic"&&r.style!=="oblique"&&r.weight!=="bold"&&r.weight!=="bolder"||(i+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0;for(const n of this._lines){const o=t.measureText(n).width,a=o+i;this._textWidths.push(o),this._lineWidths.push(a),s=Math.max(s,a)}return this._displayWidth=s,this._displayWidth}_ensureHeightMetrics(){if(O(this._heightMetrics)){const t=LI(zU,Ob,Ob).getContext("2d");this._setFontProperties(t,this.fontSize);const i=t.measureText(this.text+zYe),r=this.hasBackground?t.measureText(this._lines[0]):i,s=this._lines.length===1?r:this.hasBackground?t.measureText(this._lines[this._lines.length-1]):i,n=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;this._heightMetrics={paddingTop:i.actualBoundingBoxAscent-r.actualBoundingBoxAscent,paddingBottom:i.actualBoundingBoxDescent-s.actualBoundingBoxDescent,lineHeight:n,baselinePosition:i.actualBoundingBoxAscent}}return this._heightMetrics}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,i,r,s){t.fillText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_strokeText(t,i,r,s){t.strokeText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_drawLine(t,i,r){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),t.stroke()}_drawBox(t,i,r){const s=this._toRenderUnit(i[0]),n=this._toRenderUnit(i[1]),o=this._toRenderUnit(r[0]),a=this._toRenderUnit(r[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;t.beginPath(),t.moveTo(l,h),t.lineTo(c,h),t.lineTo(c,p),t.lineTo(l,p),t.lineTo(l,h),t.stroke()}}const x0e=[];for(let t=0;t<360;t+=360/16)x0e.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var Qy;function LI(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}(function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"})(Qy||(Qy={}));const zU={canvas:null},kYe=.2,Ob=512,Xee="rgb(255, 0, 255, 0.5)",zYe=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),BYe={left:0,center:.5,right:1},NI={"bottom-left":vi(0,0),bottom:vi(.5,0),"bottom-right":vi(1,0),left:vi(0,.5),center:vi(.5,.5),right:vi(1,.5),"top-left":vi(0,1),top:vi(.5,1),"top-right":vi(1,1)};function T0e(e){switch(e){case"left":return Qy.Left;case"right":return Qy.Right;default:return Qy.Center}}function Yee(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function VYe(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function GYe(e,t){switch(t){case"bottom":return e==="left"?"bottom-left":e==="right"?"bottom-right":"bottom";case"center":return e;case"top":return e==="left"?"top-left":e==="right"?"top-right":"top"}}function jYe(e){return e==="justify"?"center":e}function HYe(e){return e==="middle"?"center":e}var no,Zee,rL;function p2(e){return e!=null}function Mb(e){return typeof e=="number"}function OF(e){return typeof e=="string"}function qYe(e){return e==null||OF(e)}function _s(e,t){e&&e.push(t)}function WYe(e,t,i,r=Te()){const s=e||0,n=t||0,o=i||0;return s!==0&&uT(r,r,-s/180*Math.PI),n!==0&&cT(r,r,n/180*Math.PI),o!==0&&tN(r,r,o/180*Math.PI),r}function ng(e,t,i,r,s){const n=e.minSize,o=e.maxSize;if(e.expression)return _s(s,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const a=r.symbolSize[i];return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=no.DefinedSize,!0}if(p2(e.field))return p2(e.stops)?e.stops.length===2&&Mb(e.stops[0].size)&&Mb(e.stops[1].size)?(Qee(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=no.DefinedSize,!0):(_s(s,"Could not convert size info: stops only supported with 2 elements"),!1):Mb(n)&&Mb(o)&&p2(e.minDataValue)&&p2(e.maxDataValue)?(Qee(n,o,e.minDataValue,e.maxDataValue,t,i),t.type[i]=no.DefinedSize,!0):wT[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/wT[e.valueUnit],t.type[i]=no.DefinedSize,!0):e.valueUnit==="unknown"?(_s(s,"Could not convert size info: proportional size not supported"),!1):(_s(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!p2(e.field)){if(e.stops&&e.stops[0]&&Mb(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=no.DefinedSize,!0;if(Mb(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=no.DefinedSize,!0}return _s(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Qee(e,t,i,r,s,n){const o=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=o>0?e:t,s.maxSize[n]=o>0?t:e,s.offset[n]=e-i*o,s.factor[n]=o}function XYe(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return _s(r,"Could not convert size info: unsupported property"),null;if(!qYe(e.field))return _s(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return _s(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[no.Undefined,no.Undefined,no.Undefined]};let s;switch(e.axis){case"width":return s=ng(e,t.size,0,i,r),s?t:null;case"height":return s=ng(e,t.size,2,i,r),s?t:null;case"depth":return s=ng(e,t.size,1,i,r),s?t:null;case"width-and-depth":return s=ng(e,t.size,0,i,r),s&&ng(e,t.size,1,i,r),s?t:null;case null:case void 0:case"all":return s=ng(e,t.size,0,i,r),s=s&&ng(e,t.size,1,i,r),s=s&&ng(e,t.size,2,i,r),s?t:null;default:return _s(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function YYe(e,t,i){for(let s=0;s<3;++s){let n=t.unitInMeters;e.type[s]===no.DefinedSize&&(n*=t.modelSize[s],e.type[s]=no.DefinedScale),e.minSize[s]=e.minSize[s]/n,e.maxSize[s]=e.maxSize[s]/n,e.offset[s]=e.offset[s]/n,e.factor[s]=e.factor[s]/n}let r;if(e.type[0]!==no.Undefined)r=0;else if(e.type[1]!==no.Undefined)r=1;else{if(e.type[2]===no.Undefined)return _s(i,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)e.type[s]===no.Undefined&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function Jee(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function ZYe(e,t,i){if(e.normalizationField)return _s(i,"Could not convert color info: unsupported property"),null;if(OF(e.field)){if(!e.stops)return _s(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return _s(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.color.values[s]=n.value,Jee(t.color.colors,s,n.color)}}}else{if(!(e.stops&&e.stops.length>=0))return _s(i,"Could not convert color info: no field and no colors/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.color.values[s]=1/0,Jee(t.color.colors,s,r)}}return t}function QYe(e,t,i){if(e.normalizationField)return _s(i,"Could not convert opacity info: unsupported property"),null;if(OF(e.field)){if(!e.stops)return _s(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return _s(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.opacity.values[s]=n.value,t.opacity.opacityValues[s]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return _s(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.opacity.values[s]=1/0,t.opacity.opacityValues[s]=r}}return t}function BU(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function JYe(e,t,i){if(!OF(e.field))return _s(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return _s(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return BU(e,t.rotation,0),t;case"roll":return BU(e,t.rotation,1),t;case null:case void 0:case"heading":return BU(e,t.rotation,2),t;default:return _s(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function S0e(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,s=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,o=!!t.supportedTypes&&!!t.supportedTypes.opacity,a=e.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return _s(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return r?XYe(c,l,t,i):l;case"color":return s?ZYe(c,l,i):l;case"opacity":return o?QYe(c,l,i):null;case"rotation":return n?JYe(c,l,i):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!YYe(a.size,t,i)?null:a:null}function nq(e){return e&&e.size!=null}function tR(e,t){if(!e)return{enabled:!1};if(hi.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=S0e(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:E0e(i,t),requiresShaderTransformation:nq(i)}:{enabled:!1}}function iR(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,s=S0e(t.visualVariables,i);return!!s&&!!(nP(r.size,s.size,"size")&&nP(r.color,s.color,"color")&&nP(r.rotation,s.rotation,"rotation")&&nP(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=E0e(s,i),e.requiresShaderTransformation=nq(s),!0)}function nP(e,t,i){if(!!e!=!!t||e&&e.field!==t.field)return!1;if(e&&i==="rotation"){const r=e,s=t;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}function E0e(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=nq(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=br(),pp(NA),WYe(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],NA),Eu(i.vvSymbolRotationMatrix,NA)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}(function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"})(no||(no={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(Zee||(Zee={})),function(e){const t=Te(),i=M();function r(n,o,a){if(!n.vvSizeEnabled)return a;Lr(t,a);const l=n.vvSymbolRotationMatrix;Ep(NA,l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1),ur(t,t,NA);for(let c=0;c<3;++c){const h=n.vvSizeOffset[c]+o[0]*n.vvSizeFactor[c];i[c]=ze(h,n.vvSizeMinSize[c],n.vvSizeMaxSize[c])}return eN(t,t,i),Vo(t,t,n.vvSymbolAnchor),t}function s(n,o,a){if(!o.vvSizeEnabled)return oe(n,1,1,1);for(let l=0;l<3;++l){const c=o.vvSizeOffset[l]+a[0]*o.vvSizeFactor[l];n[l]=ze(c,o.vvSizeMinSize[l],o.vvSizeMaxSize[l])}return n}e.evaluateModelTransform=r,e.evaluateModelTransformScale=s}(rL||(rL={}));const NA=Te(),Q8=rL.evaluateModelTransform,KYe=rL.evaluateModelTransformScale;class eZe{constructor(){this.visible=!0}}class qT{constructor(t,i,r={}){this.data=t,this.material=i,this.boundingSphere=ni(),this.instanceParameters=new eZe,this._transformation=Te(),this._shaderTransformationDirty=!0,this.layerUid=gt(r.layerUid,null),this.graphicUid=gt(r.graphicUid,null),this.id=r.id?r.id:va(),this.boundingInfo=gt(r.boundingInfo,null),this.calculateShaderTransformation=gt(this.calculateShaderTransformation,null),this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(t){t(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(t,i,r=r1(t)){O(this.boundingInfo)||(Ue(i,this.boundingInfo.getCenter(),t),i[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return _(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return O(this.calculateShaderTransformation)?gt(this.transformation,ss):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Te()),Lr(this._shaderTransformation,this.calculateShaderTransformation(gt(this.transformation,ss))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(t){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,t)&&(_(this._transformation)&&Ue(t,t,this._transformation),!0);const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return!!eme(r,i,t)&&(_(this._transformation)&&Ue(t,t,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const t=new ZD(vm.Highlight),i=this.instanceParameters;return i.highlights=O8(i.highlights,t),t}removeHighlight(t){const i=this.instanceParameters;i.highlights=M8(i.highlights,t)}}const tZe=Te(),Kee=je(0,0,1),iZe=16,rZe=1.5,N_=DH,sZe=[N_/2,N_/2,1-N_/2,1-N_/2],nZe=[XC*N_,XC*N_];class rR extends $p{constructor(t,i,r,s){super(t,i,r,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(t){this._validateOrThrow();const i=this._prepareMaterialParameters(),r=this._getPrimitive();if(_(r))this._prepareResourcesPrimitive(i,r);else{const s=FUe(this.symbol,this.symbolLayer),n=HL(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(i,JSON.parse(n.data),t):await this._prepareResourcesHref(i,s,t)}}_validateOrThrow(){if(this._drivenProperties.size)return;const t=cF(this._getIconSize());if(t)throw new Q("graphics3diconsymbollayer:invalid-size",t)}_getIconSize(){const t=this.symbolLayer,i=Math.round(t.size!=null?ao(t.size):iZe);return this._drivenProperties.size?Math.max(i,64):i}_generateTextureCIM(t){const i=this._getGraphicHash(t);let r=i===""?null:this._cimSymbolTextures.get(i);if(!r){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,t,"esriGeometryPoint",s,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:Wy.PAD};r=new Kr(n.imageData,o),this._cimSymbolTextures.set(i,r),this._context.stage.add(r)}return r}_computeSize(t,i){const r=t.width/t.height;return r>1?[i,Math.round(i/r)]:[Math.round(i*r),i]}_prepareMaterialParameters(){const t={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},i=this.symbol;if(oZe(i)){const{screenLength:r,minWorldLength:s,maxWorldLength:n}=i.verticalOffset;t.verticalOffset={screenLength:ao(r),minWorldLength:s||0,maxWorldLength:n!=null?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(t.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),t.occlusionTest=!0,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t}_prepareResourcesPrimitive(t,i){const r=this._getOutlineSize();if(VU(i)&&r===0)throw new Error("Nothing to render");this._outlineSize=r,t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize;const s=this._context.sharedResources.textures.fromData(i,()=>Ige(i));this._texture=s.texture,this._releaseTexture=s,t.textureIsSignedDistanceField=!0,t.distanceFieldBoundingBox=sZe,t.textureId=this._texture.id;const n=this._getIconSize();this._size=[n,n],this._symbolTextureRatio=1/N_,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesHref(t,i,r){if(!ue("esri-canvas-svg-support")&&FG(i))throw new Q("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.pixelRatio,o=await Bh(this._context.sharedResources.textures.fromUrl(i,n,{signal:r}));if(o.ok===!1)throw Em(o.error),new Q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${i})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),t.textureId=a.id,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesCIM(t,i,r){const s=new JT({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await import("./CIMSymbolRasterizer.6194cdef.js")).CIMSymbolRasterizer;Jt(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await mTe(p,this._context.layer.spatialReference,n);a=(g,y,v)=>{const b=DYe(f,g,{$view:v},"esriGeometryPoint",y);return b!==null?b:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Jt(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||R2e}_getOutlineSize(){let t=0;const i=this.symbolLayer;return _(i.outline)&&i.outline.size!=null?Math.max(ao(i.outline.size),0):(t=VU(this._getPrimitive())?rZe:0,Math.max(t,0))}_getOutlineColor(){const t=this._getLayerOpacity(),i=this.symbolLayer,r=bs(i,"outline","color");if(_(r)){const s=Qe.toUnitRGB(r),n=r.a*t;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(VU(this._getPrimitive()))return FYe;const t=O(this._getPrimitive()),i=bs(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:t})}_getAnchorPos(t,i){return t==="relative"?vi((i.x||0)+.5,.5-(i.y||0)):t in NI?NI[t]:NI.center}_createMaterialAndAddToStage(t,i){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=tR(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(t,this._fastUpdates.materialParameters),this._cimLayers){let r=this._cimSymbolMaterials.get(t.textureId);return r||(r=new VT(t),this._cimSymbolMaterials.set(t.textureId,r),i.add(r)),r}return this._material=new VT(t),i.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(t=>{t.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(t=>this._context.stage.remove(t)),this._cimSymbolTextures.clear(),this._releaseTexture=Wi(this._releaseTexture)}_getScaleFactor(t,i){if(this._drivenProperties.size&&t.size){for(let r=0;r<3;r++){const s=t.size[r];s&&s!=="symbol-value"&&s!=="proportional"&&(t.size[r]=ao(s))}if(t.size[0]==="symbol-value")return 1;if(isFinite(+t.size[0]))return+t.size[0]/i;if(isFinite(+t.size[2]))return+t.size[2]/i}return 1}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(i),f=I({textureId:p.id},this._cimMaterialParametersInfo);s=this._createMaterialAndAddToStage(f,this._context.stage),r=[p.params.width,p.params.height]}else r=this._size,s=this._material;const n=QC(i.geometry);if(O(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const o=t.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=r[0]>r[1]?r[0]:r[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],h=this.setGraphicElevationContext(i,new xc);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,n,s,a,c,t.layer.uid):this._createAs3DShape(i,n,s,a,c,h,i.uid)}layerOpacityChanged(){const t=this._getFillColor(),i=this._getOutlineColor();return this._forEachMaterial(r=>{r.setParameters({color:t}),r.setParameters({outlineColor:i})}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=rO(rR.elevationModeChangeTypes,r,s);if(n!==yr.UPDATE)return n;const o=Mu(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(t=>{t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!iR(this._fastUpdates,i,this._fastVisualVariableConvertOptions()))return xs.Recreate_Symbol;_(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return xs.Fast_Update}_defaultElevationInfoNoZ(){return aZe}_createAs3DShape(t,i,r,s,n,o,a){const l=this.getFastUpdateAttrValues(t),c=l?g=>Q8(this._fastUpdates.materialParameters,l,g):null,h=[Wa.createPointGeometry(Kee,null,s,n,lZe,null,l)],p=WH(this._context,i,h,[r],o,this._context.layer.uid,a,c);if(p===null)return null;const f=new Ip(this,p.object,h,null,null,YC,o);return f.alignedSampledElevation=p.sampledElevation,f.needsElevationUpdates=Mu(o.mode)||o.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(n,c),f.calculateRelativeScreenBounds=g=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,g),ZC(f,i,this._context.elevationProvider),f}_createAsOverlay(t,i,r,s,n,o){r.renderPriority=this._renderPriority;const a=ni();Qs(i,a,this._context.overlaySR),a[2]=iq;const l=this._context.clippingExtent;if(_(l)&&!RG(l,a))return null;const c=this.getFastUpdateAttrValues(t),h=c?y=>Q8(this._fastUpdates.materialParameters,c,y):null,p=Wa.createPointGeometry(Kee,a,s,n,null,null,c),f=new qT(p,r,{layerUid:o,graphicUid:t.uid,calculateShaderTransformation:h});a[3]=0,fa(f.boundingSphere,a);const g=new RF(this,[f],null);return g.getScreenSize=this._createScreenSizeGetter(n,h),g.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(g.getScreenSize(),1,y),g}_createScreenSizeGetter(t,i){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const s=t[0]/this._symbolTextureRatio,n=t[1]/this._symbolTextureRatio;return(o=Xe())=>{const a=i(tZe);return o[0]=a[0]*s+r,o[1]=a[5]*n+r,o}}{const s=t[0]/this._symbolTextureRatio+r,n=t[1]/this._symbolTextureRatio+r;return(o=Xe())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const t=this._size[0]>this._size[1]?this._size[0]:this._size[1],i=je(t,t,t),r=kh(1),s=t*r;return{modelSize:i,symbolSize:je(s,s,s),unitInMeters:r,transformation:{anchor:cl,scale:Kd,rotation:cl}}}_getGraphicHash(t){let i="";for(const r of this._cimRequiredFields)i+=r+t.attributes[r];return i}_forEachMaterial(t){_(this._material)&&t(this._material),this._cimSymbolMaterials.forEach(t)}get test(){return{material:this._material}}}function oZe(e){return e&&e.type==="point-3d"&&e.hasVisibleVerticalOffset()}function VU(e){return!!_(e)&&(e==="cross"||e==="x")}rR.PRIMITIVE_SIZE=nZe,rR.elevationModeChangeTypes={definedChanged:yr.UPDATE,staysOnTheGround:yr.NONE,onTheGroundChanged:yr.RECREATE};const aZe={mode:"relative-to-ground",offset:0},lZe=yi(0,0,0,1);function J8(e){const t=[],i=[];hZe(e,i,t);const r=i[0][1].data,s=t[0][1].length,n=new Uint16Array(s);return dZe(e,i,t),pZe(e,i,t,n),mZe(e,i,t,n),fZe(e,i,t,n),gZe(e,i,t,n),yZe(e,i,t,n),vZe(e,i,t,r),new or(i,t,wa.Line)}function cZe(e,t,i,r){const s=e.type==="polygon"?yp.CCW_IS_HOLE:yp.NONE,n=e.type==="polygon"?e.rings:e.paths,{position:o,outlines:a}=oO(n,e.hasZ,s),l=new Float64Array(o.length),c=uye(o,e.spatialReference,0,l,0,o,0,o.length/3,t,i,r),h=c!=null;return{lines:h?A0e(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function A0e(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function uZe(e,t){const i=e.type==="polygon"?yp.CCW_IS_HOLE:yp.NONE,r=e.type==="polygon"?e.rings:e.paths,{position:s,outlines:n}=oO(r,!1,i),o=_r(s,e.spatialReference,0,s,t,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=iq;return{lines:o?A0e(n,s):[],projectionSuccess:o}}function hZe(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,n=_Ze(r)&&s===N1.REMOVE,o=r.length/3-(n?1:0),a=new Uint32Array(2*(o-1)),l=n?$9(r,0,r.length-3):r;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;t.push([E.POSITION,{size:3,data:l,exclusive:n}]),i.push([E.POSITION,a])}function dZe(e,t,i){const r=e.attributeData.mapPosition;O(r)||(i.push([E.MAPPOS,i[0][1]]),t.push([E.MAPPOS,{size:3,data:r}]))}function pZe(e,t,i,r){if(_(e.attributeData.colorFeature))return;const s=e.attributeData.color;t.push([E.COLOR,{size:4,data:gt(s,UYe)}]),i.push([E.COLOR,r])}function fZe(e,t,i,r){const s=e.attributeData.colorFeature;O(s)||(t.push([E.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.COLOR,r]))}function mZe(e,t,i,r){if(_(e.attributeData.sizeFeature))return;const s=e.attributeData.size;t.push([E.SIZE,{size:1,data:[gt(s,1)]}]),i.push([E.SIZE,r])}function gZe(e,t,i,r){const s=e.attributeData.sizeFeature;O(s)||(t.push([E.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.SIZEFEATUREATTRIBUTE,r]))}function yZe(e,t,i,r){const s=e.attributeData.opacityFeature;O(s)||(t.push([E.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.OPACITYFEATUREATTRIBUTE,r]))}function vZe(e,t,i,r){if(O(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==$e.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(r.length),n=di(e.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)t7(r,f,s,f,n);const o=r.length/3,a=new Float32Array(o+1);let l=bZe,c=wZe,h=0,p=0;oe(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),oe(c,s[p++],s[p++],s[p++]),h+=cfe(l,c),a[f]=h,[l,c]=[c,l];t.push([E.DISTANCETOSTART,{size:1,data:a}]),i.push([E.DISTANCETOSTART,i[0][1]])}function _Ze(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}var N1;(function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"})(N1||(N1={}));const bZe=M(),wZe=M();function K8(e){switch(e){case"butt":return Lh.BUTT;case"square":return Lh.SQUARE;case"round":return Lh.ROUND;default:return null}}const sL=64,C0e=sL/2,R0e=C0e/5;function xZe(e,t){return _(t)?TZe(e,SZe(t.style)):null}function TZe(e,t){return e.fromData(t,()=>Ige(t,sL,C0e,R0e))}function SZe(e){return e==="diamond"?"kite":e}function EZe(e){const t=new Ri;return t.include(Wye,e),e.output===j.Depth&&t.include(M0,e),t.fragment.include(Yh),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.fragment.uniforms.add("tex","sampler2D"),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}`),t.vertex.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev) {
      float vnp = nearFar[0] * 0.99;

      if (prev.z > -nearFar[0]) {
        //previous behind ncp
        prev = mix(pos, prev, interp(vnp, pos, prev));
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(x`
    void main(void) {
      float coverage = 1.0;

      // Check for special value of uv0.y which is used by the Renderer when graphics
      // are removed before the VBO is recompacted. If this is the case, then we just
      // project outside of clip space.
      if (uv0.y == 0.0) {
        // Project out of clip space
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      }
      else {
        float lineSize = getSize();
        float lineWidth = max(lineSize, 1.0) * pixelRatio;

        vec4 pos  = view * vec4(position.xyz, 1.0);
        vec4 prev = view * vec4(auxpos1.xyz, 1.0);
        clipAndTransform(pos, prev);

        // normalize vector along line segment
        vec2 segment = pos.xy - prev.xy;
        float segmentLen = length(segment);
        segment = (segmentLen > 0.001) ? segment / segmentLen : vec2(0.0, 0.0);

        // displace according to position in the texture
        vec2 displacementDirU = uv0.x * PERPENDICULAR(segment);
        vec2 displacementDirV = uv0.y * segment;

        vSize = ${x.float(sL/R0e)} * lineWidth;
        pos.xy += displacementDirU * vSize + displacementDirV * vSize;

        // Convert back into NDC
        pos.xy = (pos.xy / screenSize) * pos.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        vColor = getColor();
        vColor.a *= coverage;

        // transform final position to camera space for slicing
        vpos = (inverseProjectionMatrix * pos).xyz;
        gl_Position = pos;
      }
    }
  `),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.include(Rr,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(Rp),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    // Offset texture coordinate s.t. we sample texel centers
    float texelSize = ${x.float(1/sL)};
    vec2 samplePos = vUV + vec2(0.5, -0.5) * texelSize;

    // Evaluate sdf
    float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
    float distance = sdf * vSize;

    // Grow by a halfpixel to make sure the line is fully covered by the cross marker
    // (otherwise there will be a halo if they are different colours)
    distance -= 0.5;

    finalColor.a *= clamp(0.5 - distance, 0.0, 1.0);

    if (finalColor.a < ${x.float(zn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===j.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}const AZe=Object.freeze({__proto__:null,build:EZe}),O0e=new Map([[E.POSITION,0],[E.UV0,2],[E.AUXPOS1,3],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.OPACITYFEATUREATTRIBUTE,7]]);class MF extends Vi{constructor(t,i,r){super(t,i,r)}initializeProgram(t){const i=MF.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,O0e)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),this.configuration.output===j.Highlight&&Pp(this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i)),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),zge(this.program,t)}bindDraw(t){Op(this.program,t),v0(this.program,this.configuration,t.slicePlane,{origin:t.origin,view:t.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",hr(OR.get(),t.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(t,i){const r=this.configuration,s=t===at.NONE;return Rt({blending:r.output===j.Color||r.output===j.Alpha?s?dl:km(t):null,depthTest:{func:O0(t)},depthWrite:s?r.writeDepth&&Aa:nF(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?vp:null,stencilTest:r.sceneHasOcludees?i?b0:P0:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Rt({blending:dl,depthTest:eL,depthWrite:null,colorWrite:Ft,stencilWrite:null,stencilTest:Qye}),this._occluderPipelineOpaque=Rt({blending:dl,depthTest:eL,depthWrite:null,colorWrite:Ft,stencilWrite:Yye,stencilTest:Zye}),this._occluderPipelineMaskWrite=Rt({blending:null,depthTest:KH,depthWrite:null,colorWrite:null,stencilWrite:vp,stencilTest:b0})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===ye.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===ye.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}MF.shader=new Li(AZe,()=>import("./LineMarker.glsl.b8c00417.js"));class za extends dr{constructor(){super(...arguments),this.output=j.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!1,this.draped=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],za.prototype,"output",void 0),u([Y()],za.prototype,"occluder",void 0),u([Y()],za.prototype,"slicePlaneEnabled",void 0),u([Y()],za.prototype,"transparent",void 0),u([Y()],za.prototype,"writeDepth",void 0),u([Y()],za.prototype,"draped",void 0),u([Y()],za.prototype,"vvSize",void 0),u([Y()],za.prototype,"vvColor",void 0),u([Y()],za.prototype,"vvOpacity",void 0),u([Y()],za.prototype,"sceneHasOcludees",void 0),u([Y({count:at.COUNT})],za.prototype,"transparencyPassType",void 0),u([Y()],za.prototype,"multipassTerrainEnabled",void 0),u([Y()],za.prototype,"cullAboveGround",void 0);class CZe extends Zh{constructor(t){super(t,OZe),this._vertexAttributeLocations=O0e,this.techniqueConfig=new za,this.layout=this.createLayout()}dispose(){}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===ye.DRAPED_MATERIAL,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===Ar.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(){}createLayout(){const t=Nr().vec3f(E.POSITION).vec2f(E.UV0).vec3f(E.AUXPOS1);return this.parameters.vvSizeEnabled?t.f32(E.SIZEFEATUREATTRIBUTE):t.f32(E.SIZE),this.parameters.vvColorEnabled?t.f32(E.COLORFEATUREATTRIBUTE):t.vec4f(E.COLOR),this.parameters.vvOpacityEnabled&&t.f32(E.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new MZe(this.layout,this.parameters)}requiresSlot(t,i){if(t===ye.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Ar.OccludeAndTransparentStencil)return t===ye.OPAQUE_MATERIAL||t===ye.OCCLUDER_MATERIAL||t===ye.TRANSPARENT_OCCLUDER_MATERIAL;const r=$1(i);return r===j.Color||r===j.Alpha?t===(this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===ye.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth?new RZe(t):null}validateParameters(t){t.color&&t.color[3]<1&&(t.transparent=!0)}}class RZe extends MH{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this.ensureTechnique(MF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){this.bindTextures(i.program),this.bindTextureScale(i.program),i.bindPass(this._material.parameters,t)}}const OZe=I(I({width:0,color:[1,1,1,1],placement:"end",textureId:null,writeDepth:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,sceneHasOcludees:!1},Du),JH);class MZe{constructor(t,i){this.vertexBufferLayout=t,this.parameters=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(){return this.parameters.placement==="begin-end"?12:6}write(t,i,r,s){const n=i.vertexAttributes.get(E.POSITION).data,o=n.length/3;let a=1,l=0;this.parameters.vvSizeEnabled?l=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(a=i.vertexAttributes.get(E.SIZE).data[0]);let c=[1,1,1,1],h=0;this.parameters.vvColorEnabled?h=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(c=i.vertexAttributes.get(E.COLOR).data);let p=0;this.parameters.vvOpacityEnabled&&(p=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const f=t.transformation,g=new Float32Array(r.buffer);let y=s*(this.vertexBufferLayout.stride/4);const v=(T,A,C,R)=>{if(g[y++]=T[0],g[y++]=T[1],g[y++]=T[2],g[y++]=C[0],g[y++]=C[1],g[y++]=A[0],g[y++]=A[1],g[y++]=A[2],this.parameters.vvSizeEnabled?g[y++]=l:g[y++]=a,this.parameters.vvColorEnabled)g[y++]=h;else{const L=Math.min(4*R,c.length-4);g[y++]=c[L+0],g[y++]=c[L+1],g[y++]=c[L+2],g[y++]=c[L+3]}this.parameters.vvOpacityEnabled&&(g[y++]=p)};let b;(function(T){T[T.ASCENDING=1]="ASCENDING",T[T.DESCENDING=-1]="DESCENDING"})(b||(b={}));const w=(T,A)=>{const C=oe(PZe,n[3*T],n[3*T+1],n[3*T+2]),R=IZe;let L=T+A;do oe(R,n[3*L],n[3*L+1],n[3*L+2]),L+=A;while(Yx(C,R)&&L>=0&&L<o);f&&(Ue(C,C,f),Ue(R,R,f)),v(C,R,[-1,-1],T),v(C,R,[1,-1],T),v(C,R,[1,1],T),v(C,R,[-1,-1],T),v(C,R,[1,1],T),v(C,R,[-1,1],T)},S=this.parameters.placement;S!=="begin"&&S!=="begin-end"||w(0,b.ASCENDING),S!=="end"&&S!=="begin-end"||w(o-1,b.DESCENDING)}}const PZe=M(),IZe=M(),Yn={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},$Ze={dash:Yn.dash,"dash-dot":[...Yn.dash,...Yn.dot],dot:Yn.dot,"long-dash":Yn["long-dash"],"long-dash-dot":[...Yn["long-dash"],...Yn.dot],"long-dash-dot-dot":[...Yn["long-dash"],...Yn.dot,...Yn.dot],none:null,"short-dash":Yn["short-dash"],"short-dash-dot":[...Yn["short-dash"],...Yn["short-dot"]],"short-dash-dot-dot":[...Yn["short-dash"],...Yn["short-dot"],...Yn["short-dot"]],"short-dot":Yn["short-dot"],solid:null},DZe=8;function LZe(e,t=2){return O(e)?e:{pattern:e.slice(),pixelRatio:t}}function Qpt(e,t=2){return{pattern:[e,e],pixelRatio:t}}function M0e(e){return _(e)&&e.type==="style"?NZe(e.style):null}function NZe(e){return _(e)?LZe($Ze[e],DZe):null}const FZe=["polyline","polygon","extent"];class PF extends $p{constructor(t,i,r,s){super(t,i,r,s),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=tR(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const t=this.symbolLayer.size!=null?this.symbolLayer.size:kh(1);if(t<0)throw new Q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t}this._markerTexture=xZe(this._context.sharedResources.textures,this.symbolLayer.marker)}_getMaterialParameters(t,i=!1){var r;const s=oo(this.symbolLayer.marker,c=>c.color),n=oo(this.symbolLayer.material,c=>c.color),o=this._getCombinedOpacityAndColor(i&&s||n);this._patternHidesLine&&!i&&(o[3]=0);const a=o[3],l={width:this._computeMaterialWidth((r=this.symbolLayer)==null?void 0:r.size),color:o,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:K8(this.symbolLayer.cap||"butt"),transparent:a<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:M0e(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?I(I({},l),this._fastUpdates.materialParameters):l}get lineMaterial(){return O(this._lineMaterial)&&(this._lineMaterial=new mx(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return O(this._ringMaterial)&&(this._ringMaterial=new mx(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}get wireframeLineMaterial(){return O(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new mx(me(I({},this._getMaterialParameters(!1)),{wireframe:!0})),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}get wireframeRingMaterial(){return O(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new mx(me(I({},this._getMaterialParameters(!0)),{wireframe:!0})),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}get markerMaterial(){return O(this._markerMaterial)&&_(this.symbolLayer.marker)&&_(this._markerTexture)&&(this._markerMaterial=new CZe(me(I({},this._getMaterialParameters(!1,!0)),{placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id})),this._context.stage.add(this._markerMaterial)),this._markerMaterial}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=Wi(this._markerTexture)}_getDrivenSize(t){return this._drivenProperties.size&&t.size?ao(pWe(t.size)):1}_getSizeFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?sm(this._fastUpdates.visualVariables.size.field,t):null}_getDrivenColor(t){const i=yi(1,1,1,1);return this._drivenProperties.color&&t.color&&(i[0]=t.color[0],i[1]=t.color[1],i[2]=t.color[2],t.color.length>0&&(i[3]=t.color[3])),this._drivenProperties.opacity&&t.opacity&&(i[3]=t.opacity),i}_getColorFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?sm(this._fastUpdates.visualVariables.color.field,t):null}_getOpacityFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?sm(this._fastUpdates.visualVariables.opacity.field,t):null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,FZe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new xc);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.draped?this._createAsOverlay(t,this._context.layer.uid):this._createAs3DShape(t,r,i.uid)}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!iR(this._fastUpdates,i,this._vvConvertOptions))return xs.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return xs.Fast_Update}prepareSymbolLayerPatch(t){var i,r;if(t.diff.type!=="partial")return;const s=t.diff.diff,n={};((i=s.size)==null?void 0:i.type)==="complete"&&(n.width=this._computeMaterialWidth(s.size.newValue),delete s.size),((r=s.cap)==null?void 0:r.type)==="complete"&&(n.cap=K8(gt(s.cap.newValue,"butt")),delete s.cap);const o=this._prepareMarkerPatch(t,s);this._prepareMaterialPatch(t,s,o),t.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a.setParameters(n)))}layerOpacityChanged(){return this._forEachMaterial((t,i)=>this._updateMaterialLayerOpacity(t,i)),!0}_forEachMaterial(t){_(this._lineMaterial)&&t(this._lineMaterial),_(this._ringMaterial)&&t(this._ringMaterial),_(this._wireframeLineMaterial)&&t(this._wireframeLineMaterial),_(this._wireframeRingMaterial)&&t(this._wireframeRingMaterial),_(this._markerMaterial)&&t(this._markerMaterial,!0)}_updateMaterialLayerOpacity(t,i=!1){const r=t.parameters.color,s=bs(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!i?0:this._getCombinedOpacity(s),o=n<1||this.needsDrivenTransparentPass,a=[r[0],r[1],r[2],n];t.setParameters({color:a,transparent:o})}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=rO(PF.elevationModeChangeTypes,r,s);if(n!==yr.UPDATE)return n;const o=Mu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){const t={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._forEachMaterial(i=>i.setParameters(t)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(t){switch(t.type){case"extent":if(t instanceof Zt)return dc.fromExtent(t);break;case"polygon":case"polyline":return t}return null}_createAs3DShape(t,i,r){const s=t.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=new Array,c=new Array,h=os(),p=cZe(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),f=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(p,o,f,"LineSymbol3DLayer");for(let v=0;v<p.lines.length;v++){const{position:b,mapPosition:w}=p.lines[v];if(_(this._context.clippingExtent)&&(Ui(h),ic(h,w),!Ah(h,this._context.clippingExtent)))continue;const S=this._createGeometry(t,b,w,n.type,FA.ELEVATED);a.push(S),l.push(n.type==="polygon"?this.ringMaterial:this.lineMaterial),c.push(ss),hi.LINE_WIREFRAMES&&(a.push(S.cloneShallow()),l.push(n.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial),c.push(ss));const T=this.markerMaterial;_(T)&&(a.push(S.cloneShallow()),l.push(T),c.push(ss))}if(a.length===0)return null;const g=new Bm({geometries:a,materials:l,transformations:c,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),y=new Ip(this,g,a,null,null,_qe,i);return y.alignedSampledElevation=p.sampledElevation,y.needsElevationUpdates=Mu(i.mode),y}_createGeometry(t,i,r,s,n){const o=s==="polygon"?N1.REMOVE:N1.KEEP,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return J8({overlayInfo:n===FA.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:o,uniformSize:this._uniformSize,attributeData:{position:i,mapPosition:r,size:l?null:this._getDrivenSize(t.renderingInfo),color:a?null:this._getDrivenColor(t.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(t.graphic),colorFeature:this._getColorFeatureAttributeData(t.graphic),opacityFeature:this._getOpacityFeatureAttributeData(t.graphic)}})}_createAsOverlay(t,i){const r=t.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this.ringMaterial:this.lineMaterial;o.renderPriority=this._renderPriority;const a=hi.LINE_WIREFRAMES?s.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial:null,l=this.markerMaterial;_(a)&&(a.renderPriority=this._renderPriority-.001),_(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=os(),p=Ui(),f=uZe(s,this._context.overlaySR),g=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,g,"LineSymbol3DLayer");for(const y of f.lines){if(Ui(h),ic(h,y.position),!Ah(h,this._context.clippingExtent))continue;nT(p,h);const v=this._createGeometry(t,y.position,null,s.type,FA.DRAPED),b=S=>{const T=new qT(v,S,{layerUid:i,graphicUid:r.uid});return c.push(T),T};if(_(l)){const S=b(l),T=this.symbolLayer.marker.placement;T!=="begin"&&T!=="begin-end"||ic(h,y.position,0,1),T!=="end"&&T!=="begin-end"||ic(h,y.position,y.position.length-3,1),this._updateBoundingSphere(S,h)}const w=b(o);if(this._updateBoundingSphere(w,h),hi.LINE_WIREFRAMES){const S=b(a);this._updateBoundingSphere(S,h)}}return new RF(this,c,p)}_updateBoundingSphere(t,i){zo(t.boundingSphere,.5*(i[0]+i[3]),.5*(i[1]+i[4]),0,.5*Math.sqrt((i[3]-i[0])*(i[3]-i[0])+(i[4]-i[1])*(i[4]-i[1])))}get _patternHidesLine(){const t=this.symbolLayer.pattern;return _(t)&&t.type==="style"&&t.style==="none"}_computeMaterialWidth(t){return t=gt(t,kh(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?ao(1):1:ao(t)}_prepareMaterialPatch(t,i,r){const s=i.material;if(O(s)||s.type==="collection")return;const n=s.type==="complete"?oo(s.newValue,a=>a.color):s.diff.color.type==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);r&&this._patchMaterialColor(oN(o),this._markerMaterial,t),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterial,t),delete i.material}_prepareMarkerPatch(t,i){const r=i.marker;if(O(r)||r.type!=="partial"||_(r.diff.style)||_(r.diff.placement)||_(r.diff.color)&&r.diff.color.type!=="complete")return!1;const s=r.diff.color;if(O(s))return delete i.marker,O(this.symbolLayer)||O(this.symbolLayer.marker)||O(this.symbolLayer.marker.color);const n=s.newValue;return O(n)?(delete i.marker,!0):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,t),delete i.marker,!1)}_patchMaterialColor(t,i,r){if(O(i))return;const s=t[3];r.symbolLayerStatePatches.push(()=>i.setParameters({color:t,transparent:s<1||this.needsDrivenTransparentPass}))}}var FA;PF.elevationModeChangeTypes={definedChanged:yr.RECREATE,staysOnTheGround:yr.NONE,onTheGroundChanged:yr.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(FA||(FA={}));const ete=2048,UZe=1.5,kZe=8;function zZe(e,t){const{format:i,quality:r,rotation:s,disableDecorations:n}=e||{},o=oq(e,t.padding),a=YZe(e,{width:t.width-o.left-o.right,height:t.height-o.top-o.bottom}),{width:l,height:c}=XZe(e,a),h=JZe(i),p=rQe[h];return{format:h,quality:ze(r!=null?r:p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!e||!e.ignoreBackground),ignorePadding:!(!e||!e.ignorePadding)}}function BZe(e,t){const i=zZe(e,t),r=i.area,s=i.width/r.width,n=oq(i,t.padding),o=n.left+n.right,a=n.top+n.bottom,l=t.width-o,c=t.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=e&&e.layers?e.layers:[],g=i.ignoreBackground,y=i.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(r.x*s)+n.left,y:Math.floor(r.y*s)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:f,disableDecorations:i.disableDecorations,ignoreBackground:g,ignorePadding:y}}function VZe(e,t,i,r){r.premultipliedAlpha&&eQe(e),i.width=e.width,i.height=e.height;const s=i.getContext("2d");s.putImageData(e,0,0),r.flipY&&KZe(s);const n=s.getImageData(0,0,e.width,e.height),o=GZe(i,t);return i.width=0,i.height=0,{dataUrl:o,data:n}}function GZe(e,t){const i=tQe[t.format],r=t.quality/100;return e.toDataURL(i,r)}function GU(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(nL)try{return new ImageData(e,t)}catch{nL=!1}return P0e(e,t,i)}function jZe(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(nL)try{return new ImageData(e,t,i)}catch{nL=!1}const s=P0e(t,i,r);return s.data.set(e,0),s}function HZe(e,t,i,r=0,s=0,n=e.width-r,o=e.height-s,a=!1){const{data:l}=e,{width:c,height:h,data:p}=t,f=n/c,g=o/h,y=Math.ceil(f/2),v=Math.ceil(g/2),b=e.width;for(let w=0;w<h;w++)for(let S=0;S<c;S++){const T=4*(S+(a?h-w-1:w)*c);let A=0,C=0,R=0,L=0,U=0,N=0;const z=(w+.5)*g;for(let V=Math.floor(w*g);V<(w+1)*g;V++){const B=Math.abs(z-(V+.5))/v,J=(S+.5)*f,Z=B*B;for(let te=Math.floor(S*f);te<(S+1)*f;te++){const ie=Math.abs(J-(te+.5))/y,$=Math.sqrt(Z+ie*ie);if($>=1)continue;let F=2*$*$*$-3*$*$+1;const k=4*(r+te+(s+V)*b);N+=F*l[k+3],C+=F,!i&&l[k+3]<255&&(F=F*l[k+3]/255),R+=F*l[k],L+=F*l[k+1],U+=F*l[k+2],A+=F}}p[T]=R/A,p[T+1]=L/A,p[T+2]=U/A,p[T+3]=N/C}return t}function qZe(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:o}=e,a=oq(e,i),l=a.left+a.right,c=a.top+a.bottom,h=r-l,p=s-c,f=Math.min(kZe,Math.min((ete-l)/h,(ete-c)/p));return f<UZe?e:me(I({},e),{framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:r,height:s}})}function P0e(e,t,i){return i||(i=WZe()),i.getContext("2d").createImageData(e,t)}let f2=null,nL=!0;function WZe(){return f2||(f2=document.createElement("canvas"),f2.width=1,f2.height=1),f2}function XZe(e,t){if(!e)return t;const i=e.width,r=e.height;if(i!=null&&r!=null)return{width:Math.floor(i),height:Math.floor(r)};if(i==null&&r==null)return t;const s=t.width/t.height;return r==null?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}function YZe(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e&&e.area){e.area.x!=null&&(i.x=Math.floor(e.area.x)),e.area.y!=null&&(i.y=Math.floor(e.area.y));const r=e.area.width!=null?Math.floor(e.area.width):null,s=e.area.height!=null?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,r!=null&&s!=null)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(r==null&&s!=null){const n=Math.min(i.width,r);i.height=n/i.width*i.height,i.width=n}else if(r!=null&&s==null){const n=Math.min(i.height,s);i.width=n/i.height*i.width,i.height=n}}return ZZe(QZe(i,e),t)}function ZZe(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),s={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},n=s.width/s.height,o=e.width/e.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function QZe(e,t){if(!t||t.width==null||t.height==null)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const n=Math.floor(e.height*i);return e.x-=(n-e.width)/2,e.width=n,e}const s=Math.floor(e.width/i);return e.y-=(s-e.height)/2,e.height=s,e}function oq(e,t){return!t||e&&e.ignorePadding?sQe:t}function JZe(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return iQe}}function KZe(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}function eQe(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const s=t[r+3];if(s>0){const n=s/255;t[r+0]=t[r+0]/n,t[r+1]=t[r+1]/n,t[r+2]=t[r+2]/n}}}const tQe={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},tte=98,iQe="png",rQe={png:100,jpg:tte,jpeg:tte},sQe={top:0,right:0,bottom:0,left:0};var Bw;const jU=new WeakMap;let nQe=0,$d=Bw=class extends ve{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const s={type:"image-element",src:u1(e.src,r),crossOrigin:e.crossOrigin};t[i]=s}else if(e instanceof HTMLCanvasElement){const s=e.getContext("2d").getImageData(0,0,e.width,e.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};t[i]=n}else if(e instanceof HTMLVideoElement){const s={type:"video-element",src:u1(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=s}else{const s={type:"image-data",imageData:this._encodeImageData(e)};t[i]=s}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this._decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this._decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this._imageDataContainsTransparent(e);if(t){const i=t.substr(t.length-4,4).toLowerCase(),r=t.substr(0,15).toLocaleLowerCase();if(i===".png"||r==="data:image/png;")return!0}return!1}set transparent(e){e!=null?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(i="")=>`d:${i},t:${this.transparent},w:${e}`;return this.url!=null?t(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(jU.has(this.data)||jU.set(this.data,++nQe),t(jU.get(this.data))):t()}clone(){const e={url:this.url,data:this.data,wrap:this._cloneWrap()};return new Bw(e)}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=this.clone();return e.set(this,i),i}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}_decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return jZe(i,e.width,e.height)}_imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(e.data[t]!==255)return!0;return!1}static from(e){return typeof e=="string"?new Bw({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new Bw({data:e}):Xx(Bw,e)}};u([d({type:String,json:{write:s0}})],$d.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],$d.prototype,"data",null),u([Ge("data")],$d.prototype,"writeData",null),u([Fe("data")],$d.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],$d.prototype,"transparent",null),u([d({json:{write:!0}})],$d.prototype,"wrap",void 0),u([d({readOnly:!0})],$d.prototype,"contentHash",null),$d=Bw=u([P("esri.geometry.support.MeshTexture")],$d);const UA=$d;var e9;let xf=e9=class extends ve{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new e9(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return{color:_(this.color)?this.color.clone():null,colorTexture:_(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:_(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};u([d({type:Qe,json:{write:!0}})],xf.prototype,"color",void 0),u([d({type:UA,json:{write:!0}})],xf.prototype,"colorTexture",void 0),u([d({type:UA,json:{write:!0}})],xf.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],xf.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],xf.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],xf.prototype,"doubleSided",void 0),xf=e9=u([P("esri.geometry.support.MeshMaterial")],xf);const aq=xf;var t9;let Tf=t9=class extends aq{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new t9(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return me(I({},super.clonePropertiesWithDeduplication(e)),{emissiveColor:_(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:_(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:_(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:_(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null})}};u([d({type:Qe,json:{write:!0}})],Tf.prototype,"emissiveColor",void 0),u([d({type:UA,json:{write:!0}})],Tf.prototype,"emissiveTexture",void 0),u([d({type:UA,json:{write:!0}})],Tf.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Tf.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Tf.prototype,"roughness",void 0),u([d({type:UA,json:{write:!0}})],Tf.prototype,"metallicRoughnessTexture",void 0),Tf=t9=u([P("esri.geometry.support.MeshMaterialMetallicRoughness")],Tf);const I0e=Tf;var FI;const Pb=he.getLogger("esri.geometry.support.MeshVertexAttributes");let Oc=FI=class extends ve{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return Vw(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},Pb)}castPosition(e){return e&&e instanceof Float32Array&&Pb.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),Vw(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},Pb)}castUv(e){return Vw(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},Pb)}castNormal(e){return Vw(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},Pb)}castTangent(e){return Vw(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},Pb)}clone(){const e={position:se(this.position),uv:se(this.uv),normal:se(this.normal),tangent:se(this.tangent),color:se(this.color)};return new FI(e)}clonePositional(){const e={position:se(this.position),normal:se(this.normal),tangent:se(this.tangent),uv:this.uv,color:this.color};return new FI(e)}};function HU(e,t,i,r){const{loggerTag:s,stride:n}=t;return e.length%n!=0?(r.error(s,`Invalid array length, expected a multiple of ${n}`),new i([])):e}function Vw(e,t,i,r,s){if(!e)return e;if(e instanceof t)return HU(e,r,t,s);for(const n of i)if(e instanceof n)return HU(new t(e),r,t,s);if(Array.isArray(e))return HU(new t(e),r,t,s);{const n=i.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${e.constructor.name}`),new t([])}}function m2(e,t,i){t[i]=oQe(e)}function oQe(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}u([d({json:{write:m2}})],Oc.prototype,"color",void 0),u([It("color")],Oc.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:m2}})],Oc.prototype,"position",void 0),u([It("position")],Oc.prototype,"castPosition",null),u([d({json:{write:m2}})],Oc.prototype,"uv",void 0),u([It("uv")],Oc.prototype,"castUv",null),u([d({json:{write:m2}})],Oc.prototype,"normal",void 0),u([It("normal")],Oc.prototype,"castNormal",null),u([d({json:{write:m2}})],Oc.prototype,"tangent",void 0),u([It("tangent")],Oc.prototype,"castTangent",null),Oc=FI=u([P("esri.geometry.support.MeshVertexAttributes")],Oc);var GE;const aQe=he.getLogger("esri.geometry.support.MeshComponent");let Sf=GE=class extends ve{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return Xx(GE,e)}castFaces(e){return Vw(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},aQe)}castMaterial(e){return Xx(e&&typeof e=="object"&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?I0e:aq,e)}clone(){return new GE({faces:se(this.faces),shading:this.shading,material:se(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){const i={faces:se(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new GE(i)}};u([d({json:{write:!0}})],Sf.prototype,"faces",void 0),u([It("faces")],Sf.prototype,"castFaces",null),u([d({type:aq,json:{write:!0}})],Sf.prototype,"material",void 0),u([It("material")],Sf.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],Sf.prototype,"shading",void 0),u([d({type:Boolean})],Sf.prototype,"trustSourceNormals",void 0),Sf=GE=u([P("esri.geometry.support.MeshComponent")],Sf);const lQe=Sf,IF=he.getLogger("esri.geometry.support.meshUtils.normalProjection");function cQe(e,t,i,r,s){return DF(r)?($F(nm.TO_PCPF,Ti.fromTypedArray(e),jr.fromTypedArray(t),jr.fromTypedArray(i),r,Ti.fromTypedArray(s)),s):(IF.error("Cannot convert spatial reference to PCPF"),s)}function Jpt(e,t,i,r,s){return DF(r)?($F(nm.FROM_PCPF,Ti.fromTypedArray(e),jr.fromTypedArray(t),jr.fromTypedArray(i),r,Ti.fromTypedArray(s)),s):(IF.error("Cannot convert to spatial reference from PCPF"),s)}function Kpt(e,t,i){return _r(e,t,0,i,KL(t),0,e.length/3),i}function eft(e,t,i){return _r(e,KL(i),0,t,i,0,e.length/3),t}function uQe(e,t,i){if(O(e))return t;const r=jr.fromTypedArray(e),s=jr.fromTypedArray(t);return nO(s,r,i),t}function hQe(e,t,i){if(O(e))return t;OT(Vs,i);const r=Ti.fromTypedArray(e),s=Ti.fromTypedArray(t);return I1(s,r,Vs),Xj(Vs)||YH(s,s),t}function dQe(e,t,i){if(O(e))return t;OT(Vs,i);const r=Ti.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s=Ti.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if(I1(s,r,Vs),Xj(Vs)||YH(s,s),e!==t)for(let n=3;n<e.length;n+=4)t[n]=e[n];return t}function pQe(e,t,i,r,s){if(!DF(r))return IF.error("Cannot convert spatial reference to PCPF"),s;$F(nm.TO_PCPF,Ti.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),jr.fromTypedArray(t),jr.fromTypedArray(i),r,Ti.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function tft(e,t,i,r,s){if(!DF(r))return IF.error("Cannot convert to spatial reference from PCPF"),s;$F(nm.FROM_PCPF,Ti.fromTypedArray(e,16),jr.fromTypedArray(t),jr.fromTypedArray(i),r,Ti.fromTypedArray(s,16));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function $F(e,t,i,r,s,n){if(!t)return;const o=i.count,a=KL(s);if($0e(s))for(let l=0;l<o;l++)r.getVec(l,oP),t.getVec(l,ld),Gh(a,oP,aP,a),Eu(Vs,aP),e===nm.FROM_PCPF&&Au(Vs,Vs),rl(ld,ld,Vs),n.setVec(l,ld);else for(let l=0;l<o;l++){r.getVec(l,oP),t.getVec(l,ld),Gh(a,oP,aP,a),Eu(Vs,aP);const c=w$(i.get(l,1));let h=Math.cos(c);e===nm.TO_PCPF&&(h=1/h),Vs[0]*=h,Vs[1]*=h,Vs[2]*=h,Vs[3]*=h,Vs[4]*=h,Vs[5]*=h,e===nm.FROM_PCPF&&Au(Vs,Vs),rl(ld,ld,Vs),be(ld,ld),n.setVec(l,ld)}return n}function DF(e){return $0e(e)||fQe(e)}function $0e(e){return e.isWGS84||Tne(e)||wp(e)||xp(e)}function fQe(e){return e.isWebMercator}var nm;(function(e){e[e.TO_PCPF=0]="TO_PCPF",e[e.FROM_PCPF=1]="FROM_PCPF"})(nm||(nm={}));const oP=M(),ld=M(),aP=Te(),Vs=br();function mQe(e){const t=new Ri;return t.include(Un,{linearDepth:!1}),t.include(sb,e),t.include(Xye,me(I({},e),{stippleRequiresStretchMeasure:!1})),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.stippleEnabled&&(t.vertex.uniforms.add("ndcToPixel","vec2"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3")),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(x`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.vertex.code.add(x`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped||t.vertex.code.add(x`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(x`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?t.vertex.code.add(x`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.vertex.code.add(x`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(x`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.vertex.code.add(x`}`),e.output===j.Highlight&&t.include(Fm),t.include(Rr,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${x.float(zn)}) {
      discard;
    }

    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Highlight?x`outputHighlight();`:""}
  }
  `),t}const gQe=Object.freeze({__proto__:null,build:mQe});class LF extends Vi{constructor(t,i,r){super(t,i,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=t.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==j.Highlight}initializeProgram(t){const i=LF.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:r.stipplePreferContinuous});return new Oi(t.rctx,s,mi)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(xl(this.program,i.camera.projectionMatrix),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",i.camera.fullViewport[2]/2,i.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",t.color),this.program.setUniform1f("alphaCoverage",Math.min(1,t.width*i.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const r=t.stippleOffColor;this.program.setUniform4f("stippleOffColor",r[0],r[1],r[2],r.length>3?r[3]:1)}this.configuration.output===j.Highlight&&Pp(this.program,i)}bindDraw(t){Op(this.program,t),this.stippleEnabled&&!this.configuration.draped&&R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),rb(this.program,this.configuration,t),this.program.rebindTextures()}initializePipeline(){const t=this.configuration,i=Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),r=(s,n=null,o=null)=>Rt({blending:n,depthTest:KH,depthWrite:o,colorWrite:Ft,stencilWrite:t.sceneHasOcludees?vp:null,stencilTest:t.sceneHasOcludees?s?b0:P0:null});return t.output===j.Color?(this._occludeePipelineState=r(!0,t.transparent||this.stippleEnabled?i:null,Aa),r(!1,t.transparent||this.stippleEnabled?i:null,Aa)):r(!1)}get primitiveType(){return Tt.LINES}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}LF.shader=new Li(gQe,()=>import("./NativeLine.glsl.a840631a.js"));class Dd extends dr{constructor(){super(...arguments),this.output=j.Color,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}u([Y({count:j.COUNT})],Dd.prototype,"output",void 0),u([Y()],Dd.prototype,"slicePlaneEnabled",void 0),u([Y()],Dd.prototype,"vertexColors",void 0),u([Y()],Dd.prototype,"transparent",void 0),u([Y()],Dd.prototype,"draped",void 0),u([Y()],Dd.prototype,"stippleEnabled",void 0),u([Y()],Dd.prototype,"stippleOffColorEnabled",void 0),u([Y()],Dd.prototype,"stipplePreferContinuous",void 0),u([Y()],Dd.prototype,"sceneHasOcludees",void 0);const yQe=he.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var oL;(function(e){e[e.START=0]="START",e[e.END=1]="END"})(oL||(oL={}));class ite extends Zh{constructor(t){super(t,bQe),this._techniqueConfig=new Dd}getTechniqueConfig(t,i){this._techniqueConfig.output=t,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=i.slot===ye.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a,l,c){_(c)?aje(t,s,c,o,1,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||XR(i))return;if(!Jfe(r))return void yQe.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes.get(E.POSITION).data,a=s.camera,l=xQe;Fs(l,s.point);const c=2;oe(g2[0],l[0]-c,l[1]+c,0),oe(g2[1],l[0]+c,l[1]+c,0),oe(g2[2],l[0]+c,l[1]-c,0),oe(g2[3],l[0]-c,l[1]-c,0);for(let y=0;y<4;y++)if(!a.unprojectFromRenderScreen(g2[y],jp[y]))return;ro(a.eye,jp[0],jp[1],qU),ro(a.eye,jp[1],jp[2],WU),ro(a.eye,jp[2],jp[3],XU),ro(a.eye,jp[3],jp[0],YU);let h=Number.MAX_VALUE,p=0;for(let y=0;y<o.length-5;y+=3){if(Eo[0]=o[y]+r[12],Eo[1]=o[y+1]+r[13],Eo[2]=o[y+2]+r[14],Ao[0]=o[y+3]+r[12],Ao[1]=o[y+4]+r[13],Ao[2]=o[y+5]+r[14],er(qU,Eo)<0&&er(qU,Ao)<0||er(WU,Eo)<0&&er(WU,Ao)<0||er(XU,Eo)<0&&er(XU,Ao)<0||er(YU,Eo)<0&&er(YU,Ao)<0)continue;if(a.projectToRenderScreen(Eo,K0),a.projectToRenderScreen(Ao,ev),K0[2]<0&&ev[2]>0){de(cd,Eo,Ao);const b=a.frustum,w=-er(b[qi.NEAR],Eo)/_e(cd,b[qi.NEAR]);ae(cd,cd,w),pe(Eo,Eo,cd),a.projectToRenderScreen(Eo,K0)}else if(K0[2]>0&&ev[2]<0){de(cd,Ao,Eo);const b=a.frustum,w=-er(b[qi.NEAR],Ao)/_e(cd,b[qi.NEAR]);ae(cd,cd,w),pe(Ao,Ao,cd),a.projectToRenderScreen(Ao,ev)}else if(K0[2]<0&&ev[2]<0)continue;K0[2]=0,ev[2]=0;const v=u7(q_(K0,ev,nte),l);v<h&&(h=v,ne(rte,Eo),ne(ste,Ao),p=y/3)}const f=s.rayBegin,g=s.rayEnd;if(h<c*c){let y=Number.MAX_VALUE;if(Lle(q_(rte,ste,nte),q_(f,g,wQe),J0)){de(J0,J0,f);const v=Pe(J0);ae(J0,J0,1/v),y=v/xi(f,g)}n(y,J0,p,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(E.POSITION);return eH(s,null,!1,i)}requiresSlot(t){return t===ye.OPAQUE_MATERIAL||t===ye.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Highlight?new vQe(t):null}createBufferWriter(){const t=this.parameters.vertexColors?Lye:kWe;return O(this.parameters.stipplePattern)?new vF(t):new _Qe(t.clone().vec3f(E.AUXPOS1).vec2f(E.UV0))}}class vQe extends Nm{updateParameters(t){return this.ensureTechnique(LF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output===j.Color&&this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}class _Qe{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){sF(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s),this._writeAuxpos1(t,i,r,s),this._writeUV0(t,i,r,s)}_writeAuxpos1(t,i,r,s){const n=r.getField(E.AUXPOS1,Ti),o=i.indices.get(E.POSITION),a=i.vertexAttributes.get(E.POSITION).data,l=t.transformation,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const g=3*o[p+f],y=a[g],v=a[g+1],b=a[g+2],w=l[0]*y+l[4]*v+l[8]*b+l[12],S=l[1]*y+l[5]*v+l[9]*b+l[13],T=l[2]*y+l[6]*v+l[10]*b+l[14];h[s]=w,h[s+1]=S,h[s+2]=T,s+=c}}_writeUV0(t,i,r,s){var n;const o=r.getField(E.UV0,Ru),a=i.indices.get(E.POSITION),l=i.vertexAttributes.get(E.POSITION).data,c=(n=i.vertexAttributes.get(E.DISTANCETOSTART))==null?void 0:n.data,h=t.transformation,p=o.typedBufferStride,f=o.typedBuffer;let g=0;f[s*=p]=oL.START,f[s+1]=g,s+=p;const y=3*a[0],v=oe(Eo,l[y],l[y+1],l[y+2]);h&&Ue(v,v,h);const b=Ao,w=a.length-1;let S=1;const T=c?(C,R,L)=>g=c[L]:(C,R,L)=>g+=xi(C,R);for(let C=1;C<w;C+=2){const R=3*a[C];oe(b,l[R],l[R+1],l[R+2]),h&&Ue(b,b,h),T(v,b,S++);for(let L=0;L<2;++L)f[s]=1-L,f[s+1]=g,s+=p;ne(v,b)}const A=3*a[w];oe(b,l[A],l[A+1],l[A+2]),h&&Ue(b,b,h),T(v,b,S),f[s]=oL.END,f[s+1]=g}}const bQe=I({color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1},Du),Eo=M(),Ao=M(),cd=M(),J0=M(),K0=Nn(),ev=Nn(),rte=M(),ste=M(),nte=S0(),wQe=S0(),xQe=M(),g2=[Nn(),Nn(),Nn(),Nn()],jp=[M(),M(),M(),M()],qU=ii(),WU=ii(),XU=ii(),YU=ii(),TQe=["mesh"];class SQe extends $p{constructor(t,i,r,s){super(t,i,r,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){hi.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new ite({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new ite({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),t=>t.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,TQe,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(i,new xc),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(t,i){const r=this._getLayerOpacity();return this._materials.forEach(s=>{s.material.setParameters({layerOpacity:r});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),t.forEach(s=>{const n=i(s);_(n)&&n.layerOpacityChanged(r,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,_0)}slicePlaneEnabledChanged(t,i){return this._materials.forEach(r=>{r.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t=this._usePBR();return this._materials.forEach(i=>i.material.setParameters({usePBR:t})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(t){return O(t)?"-":t instanceof Qe?t.toHex():t.contentHash}_materialPropertiesDefault(t,i){const r=this._requiresSymbolVertexColors(),s=!!t.vertexAttributes.color,n=!!t.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${i},svc:${r}`}}_materialProperties(t,i,r){const s=this._materialPropertiesDefault(t,r);if(!i.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=i.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),g=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${g},ds:${l},ac:${c},am:${h}`,i.material instanceof I0e){const{metallic:y,roughness:v,metallicRoughnessTexture:b,emissiveColor:w,emissiveTexture:S,occlusionTexture:T}=i.material,A=this._colorOrTextureUid(b),C=this._colorOrTextureUid(w),R=this._colorOrTextureUid(S),L=this._colorOrTextureUid(T);s.metallic=y,s.roughness=v,s.metallicRoughnessTexture=b,s.emissiveColor=w,s.emissiveTexture=S,s.occlusionTexture=T,s.uid=`${s.uid},mrm:${y},mrr:${v},mrt:${A},emuid:${C},etmuid:${R},otmuid:${L}`}return s}_setInternalColorValueParameters(t,i){i.diffuse=Qe.toUnitRGB(t),i.opacity=t.a}_getLoadableTextureResource(t){return t.data?t.data:t.url}_getInternalTextureId(t){const i=this._getInternalTexture(t,Ai.Opaque);return _(i)?i.id:null}_getInternalTexture(t,i){const r=this._getLoadableTextureResource(t);if(!r)return null;const s=`${t.contentHash}/${i}`;let n=this._textures.get(s);return n||(n=new Kr(r,{mipmap:!0,wrap:this._castTextureWrap(t.wrap),noUnpackFlip:!0,preMultiplyAlpha:i!==Ai.Opaque}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(t="repeat"){if(typeof t=="string"){const i=this._castTextureWrapIndividual(t);return{s:i,t:i}}return{s:this._castTextureWrapIndividual(t.horizontal),t:this._castTextureWrapIndividual(t.vertical)}}_castTextureWrapIndividual(t){switch(t){case"clamp":return lt.CLAMP_TO_EDGE;case"mirror":return lt.MIRRORED_REPEAT;default:return lt.REPEAT}}_setInternalMaterialParameters(t,i){if(_(t.color)&&this._setInternalColorValueParameters(t.color,i),_(t.colorTexture)){const r=this._getInternalTexture(t.colorTexture,i.textureAlphaMode);_(r)?(i.textureId=r.id,i.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):i.textureId=void 0}_(t.normalTexture)&&(i.normalTextureId=this._getInternalTextureId(t.normalTexture)),_(t.emissiveColor)&&(i.emissiveFactor=Qe.toUnitRGB(t.emissiveColor)),_(t.emissiveTexture)&&(i.emissiveTextureId=this._getInternalTextureId(t.emissiveTexture)),_(t.occlusionTexture)&&(i.occlusionTextureId=this._getInternalTextureId(t.occlusionTexture)),_(t.metallicRoughnessTexture)&&(i.metallicRoughnessTextureId=this._getInternalTextureId(t.metallicRoughnessTexture))}_setExternalMaterialParameters(t){const i=this._drivenProperties.color;let r=_(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(i)t.externalColor=Zd;else{const s=_(this.symbolLayer.material)?this.symbolLayer.material.color:null;_(s)?t.externalColor=Qe.toUnitRGBA(s):(r=null,t.externalColor=Zd)}r&&(t.colorMixMode=r),t.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(t){const i=t.vertexAttributes.color;if(O(i))return!1;for(let r=3;r<i.length;r+=4)if(i[r]!==255)return!0;return!1}_getOrCreateMaterial(t,i){var r,s,n;const o=(r=i.material)==null?void 0:r.color,a=(s=i.material)==null?void 0:s.colorTexture,l=(n=i.material)==null?void 0:n.alphaMode,c=l==="blend",h=l!=="opaque"&&(this._hasTransparentVertexColors(t)||_(o)&&o.a<1||_(a)&&a.transparent||c),p=this._materialProperties(t,i,h),f=this._materials.get(p.uid);if(f)return f.material;const g={material:null,isComponentTransparent:h,alphaMode:i.material?i.material.alphaMode:"opaque"},y=p.metallicRoughnessTexture==null&&p.metallic==null&&p.roughness==null,v={usePBR:this._usePBR(),isSchematic:y,vertexColors:p.hasVertexColors,symbolColors:p.hasSymbolVertexColors,vertexTangents:p.hasVertexTangents,ambient:cl,diffuse:Kd,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:$i.None,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};y||(v.mrrFactors=[p.metallic!=null?p.metallic:1,p.roughness!=null?p.roughness:1,.5]),i.material&&(v.doubleSided=i.material.doubleSided,v.cullFace=i.material.doubleSided?$i.None:$i.Back,v.textureAlphaCutoff=i.material.alphaCutoff),this._setExternalMaterialParameters(v),this._setMaterialTransparentParameter(v,g),this._setInternalMaterialParameters(p,v);const b=new L1(v);return g.material=b,this._materials.set(p.uid,g),this._context.stage.add(b),b}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(t,i){t.transparent=this.needsDrivenTransparentPass||i.isComponentTransparent||t.layerOpacity<1||t.opacity<1||t.externalColor&&t.externalColor[3]<1,i.alphaMode==="auto"?t.textureAlphaMode=t.transparent?Ai.MaskBlend:Ai.Opaque:t.textureAlphaMode=i.alphaMode==="opaque"?Ai.Opaque:i.alphaMode==="mask"?Ai.Mask:Ai.Blend}_addDebugNormals(t,i,r,s){const n=i.length,o=t.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(t.extent.width*o,t.extent.height*o,t.extent.zmax-t.extent.zmin),l=[],c=[],h=[],p=[];for(let y=0;y<n;y++){const v=i[y],b=v.vertexAttributes.get(E.POSITION),w=v.vertexAttributes.get(E.NORMAL),S=v.indices.get(E.POSITION),T=v.indices.get(E.NORMAL),A=b.data,C=w.data;for(let R=0;R<S.length;R++){const L=3*S[R],U=3*T[R];for(let N=0;N<3;N++)l.push(A[L+N]);for(let N=0;N<3;N++)l.push(A[L+N]+C[U+N]*a);if(c.push(c.length),c.push(c.length),R%3==0){this._calculateFaceNormal(A,S,R,Db),this._getFaceVertices(A,S,R,Tn,Ib,$b),pe(Tn,Tn,Ib),pe(Tn,Tn,$b),ae(Tn,Tn,1/3);for(let N=0;N<3;N++)h.push(Tn[N]);for(let N=0;N<3;N++)h.push(Tn[N]+Db[N]*a);p.push(p.length),p.push(p.length)}}}const f=new or([[E.POSITION,{data:l,size:3,exclusive:!0}]],[[E.POSITION,new Uint32Array(c)]],wa.Line);i.push(f),r.push(this._debugVertexNormalMaterial),s.push(j_(s[0]));const g=new or([[E.POSITION,{data:h,size:3,exclusive:!0}]],[[E.POSITION,new Uint32Array(p)]],wa.Line);i.push(g),r.push(this._debugFaceNormalMaterial),s.push(j_(s[0]))}_createAs3DShape(t,i,r,s){const n=t.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,i);if(!o)return null;const{geometries:a,materials:l,transformations:c,objectTransformation:h}=o;hi.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a,l,c);const p=new Bm({geometries:a,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});p.transformation=h;const f=this._createEdgeMaterial(),g=_(f)?{baseMaterial:l[0],edgeMaterials:[f],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,y=new Ip(this,p,a,null,null,YC,r,g);return y.needsElevationUpdates=_0(r.mode),y.useObjectOriginAsAttachmentOrigin=!0,y.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(p),y.alignedSampledElevation=YC(y,y.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),y}_getCenterPointInElevationSR(t){const i=zm(0,0,0,this._context.elevationProvider.spatialReference);return ale([t.transformation[12],t.transformation[13],t.transformation[14]],this._context.renderCoordsHelper.spatialReference,i),i}_createComponentNormals(t,i,r,s){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(t,i,r,s);case"flat":return this._createComponentNormalsFlat(t,s);case"smooth":return this._createComponentNormalsSmooth(t,s);default:return}}_createComponentNormalsSource(t,i,r,s){if(O(i))return this._createComponentNormalsFlat(t,s);let n=!1;if(!r.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(t,s,o,Db);for(let a=0;a<3;a++){const l=3*s[o+a];Tn[0]=i[l+0],Tn[1]=i[l+1],Tn[2]=i[l+2],_e(Db,Tn)<0&&(i[l+0]=-i[l+0],i[l+1]=-i[l+1],i[l+2]=-i[l+2],n=!0)}}return{normals:i,indices:s,didFlipNormals:n}}_createComponentNormalsFlat(t,i){const r=new Float32Array(i.length),s=new Uint32Array(3*i.length);for(let n=0;n<i.length;n+=3){const o=this._calculateFaceNormal(t,i,n,Db);for(let a=0;a<3;a++)r[n+a]=o[a],s[n+a]=n/3}return{normals:r,indices:s,didFlipNormals:!1}}_createComponentNormalsSmooth(t,i){const r={};for(let o=0;o<i.length;o+=3){const a=this._calculateFaceNormal(t,i,o,Db);for(let l=0;l<3;l++){const c=i[o+l];let h=r[c];h||(h={normal:M(),count:0},r[c]=h),pe(h.normal,h.normal,a),h.count++}}const s=new Float32Array(3*i.length),n=new Uint32Array(3*i.length);for(let o=0;o<i.length;o++){const a=r[i[o]];a.count!==1&&(be(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return{normals:s,indices:n,didFlipNormals:!1}}_getFaceVertices(t,i,r,s,n,o){const a=3*i[r+0],l=3*i[r+1],c=3*i[r+2];s[0]=t[a+0],s[1]=t[a+1],s[2]=t[a+2],n[0]=t[l+0],n[1]=t[l+1],n[2]=t[l+2],o[0]=t[c+0],o[1]=t[c+1],o[2]=t[c+2]}_calculateFaceNormal(t,i,r,s){return this._getFaceVertices(t,i,r,Tn,Ib,$b),de(Ib,Ib,Tn),de($b,$b,Tn),dt(Tn,Ib,$b),be(s,Tn),s}_getOrCreateComponents(t){return gt(t.components,EQe)}_createPositionBuffer(t,i){let r=t.vertexAttributes.position;const s=i.reprojection===Ul.ECEF?i.transformBeforeProject:null;if(_(s)&&(r=uQe(r,new Float64Array(r.length),s)),i.reprojection===Ul.NONE)return i.needsBufferCopy?new Float64Array(r):r;const n=_(s)?r:new Float64Array(r.length);return _r(r,t.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,r.length/3),n}_createNormalBuffer(t,i,r){let s=t.vertexAttributes.normal;if(O(s))return null;const n=r.reprojection===Ul.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=hQe(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Ul.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return cQe(s,o,i,t.spatialReference,a)}_createTangentBuffer(t,i,r){let s=t.vertexAttributes.tangent;if(O(s))return null;const n=r.reprojection===Ul.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=dQe(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Ul.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return pQe(s,o,i,t.spatialReference,a)}_createColorBuffer(t){return t.vertexAttributes.color}_createSymbolColorBuffer(t){if(this._requiresSymbolVertexColors()){const i=this._getVertexOpacityAndColor(t),r=lYe(bs(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return h0e(i,r,s),s}return null}_createBuffers(t,i){const r=t.vertexAttributes&&t.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=t.vertexAttributes.normal,n=t.vertexAttributes.uv,o=t.vertexAttributes.tangent;if(_(s)&&s.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(_(o)&&o.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(_(n)&&n.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(t),l=this._createPositionBuffer(t,a),c=this._createColorBuffer(t),h=this._createSymbolColorBuffer(i),p=this._createNormalBuffer(t,l,a),f=this._createTangentBuffer(t,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===Ul.NONE&&_(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(t,l,p,f),geometryTransformation:a.reprojection===Ul.NONE&&_(a.geometryTransformation)?a.geometryTransformation:Te()}}_computeReprojectionInfo(t){const i=_(t.transform),r=i&&t.transform.geographic||this._context.renderCoordsHelper.viewingMode===$e.Local?Ul.NONE:Ul.ECEF;if(i){if(r===Ul.NONE){const n=Te();return Gh(t.spatialReference,t.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:r,objectTransformation:n,geometryTransformation:j_(t.transform.localMatrix),needsBufferCopy:!1}}const s=iN(Te(),t.transform.origin);return ur(s,s,t.transform.localMatrix),{reprojection:r,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(t,i,r,s){const n=this._context.renderCoordsHelper.spatialReference,o=t.anchor;lP[0]=o.x,lP[1]=o.y,lP[2]=o.z;const a=Te();Gh(t.spatialReference,lP,a,n);const l=jr.fromTypedArray(i);if(hr(ote,a),nO(l,l,ote),_(r)||_(s)){if(Eu(y2,a),Au(y2,y2),_(r)){const c=Ti.fromTypedArray(r);I1(c,c,y2)}if(_(s)){const c=Ti.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);I1(c,c,y2)}}return a}_validateFaces(t,i){const r=t.vertexAttributes.position.length/3,s=i.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(r<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(t,i){return i.faces?i.faces:UT(t.vertexAttributes.position.length/3)}_isOutsideClippingArea(t){if(!this._context.clippingExtent)return!1;const i=t.vertexAttributes&&t.vertexAttributes.position;if(!i)return!1;const r=this._context.elevationProvider.spatialReference;let s;const n=i.length/3;return t.spatialReference.equals(r)?s=i:(s=new Float64Array(i.length),_r(t.vertexAttributes.position,t.spatialReference,0,s,r,0,n)),Ui(ZU),ic(ZU,s,0,n),!Ah(ZU,this._context.clippingExtent)}_createGeometryInfo(t,i){if(!hT(t.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(t))return null;const r=this._createBuffers(t,i);if(O(r))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:o,symbolColorBuffer:a,normalBuffer:l,tangentBuffer:c,objectTransformation:h,geometryTransformation:p}=r,f=this._getOrCreateComponents(t),g=[],y=[],v=[];let b=!1;for(const w of f){if(!this._validateFaces(t,w))return null;const S=this._getOrCreateFaces(t,w);if(S.length===0)continue;const T=this._createComponentNormals(s,l,w,S);T.didFlipNormals&&(b=!0);const A=[[E.POSITION,{size:3,data:s,exclusive:!0}],[E.NORMAL,{size:3,data:T.normals,exclusive:!0}]],C=[[E.POSITION,S],[E.NORMAL,T.indices]];_(o)&&(A.push([E.COLOR,{size:4,data:o,exclusive:!0}]),C.push([E.COLOR,S])),_(a)&&(A.push([E.SYMBOLCOLOR,{size:4,data:a,exclusive:!0}]),C.push([E.SYMBOLCOLOR,new Uint16Array(S.length)])),_(n)&&(A.push([E.UV0,{size:2,data:n,exclusive:!0}]),C.push([E.UV0,S])),_(c)&&(A.push([E.TANGENT,{size:4,data:c,exclusive:!0}]),C.push([E.TANGENT,S]));const R=new or(A,C);g.push(R),y.push(p),v.push(this._getOrCreateMaterial(t,w))}return b&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:g,transformations:y,materials:v,objectTransformation:h}}_createEdgeMaterial(){const t={opacity:this._getLayerOpacity()};return vye(this.symbolLayer,t)}}const lP=M(),Tn=M(),Ib=M(),$b=M(),Db=M(),ote=Te(),y2=br(),ZU=os(),EQe=[new lQe];var Ul;(function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF"})(Ul||(Ul={}));class AQe{constructor(t,i,r,s){this.graphics3DSymbolLayer=t,this.instanceIndex=i,this.elevationAligner=r,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(t){const i=this.lodRenderer.instanceData;t!==i.getVisible(this.instanceIndex)&&i.setVisible(this.instanceIndex,t)}destroy(){this.instanceIndex!=null&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(t,i,r){if(this.elevationAligner){VH(this.elevationContext.featureExpressionInfoContext,r);const s=this.elevationAligner(this,this.elevationContext,t,i);_(s)&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(t=M()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,ud),Ue(t,this.lodRenderer.baseBoundingSphere.center,ud)}getBoundingBoxObjectSpace(t=os()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,ud);const i=this.lodRenderer.baseBoundingBox;Ui(t);for(let r=0;r<8;++r)oe(Mc,(1&r)==0?i[0]:i[3],(2&r)==0?i[1]:i[4],(4&r)==0?i[2]:i[5]),Ue(Mc,Mc,ud),hp(t,Mc);return t}computeAttachmentOrigin(t){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,ud),t.render.origin[0]+=ud[12],t.render.origin[1]+=ud[13],t.render.origin[2]+=ud[14],t.render.num++}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=CQe,l=VL(o)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,ud);for(let h=0;h<l;h++){const p=a[h];Mc[0]=o[p[0]],Mc[1]=o[p[1]],Mc[2]=o[p[2]],Ue(Mc,Mc,ud),tv[3*h+0]=Mc[0],tv[3*h+1]=Mc[1],tv[3*h+2]=Mc[2]}if(!t(tv,0,l))return null;Ui(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],tv[h+p]),o[p+3]=Math.max(o[p+3],tv[h+p]);c&&r.push({location:tv.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&(Eh(o,QU),this.elevationContext.mode!=="absolute-height")){let h;const p=zH(o,i);try{h=await i.service.queryElevation(QU[0],QU[1],s,p,"ground")}catch{}_(h)&&Poe(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(t,i){if(t===vm.Highlight){const r=new ZD(t);this._addHighlightId(r),i.addExternal(s=>{this._removeHighlightId(s)},r)}}removeObjectState(t){this._highlights.forEach(i=>t.remove(i))}_addHighlightId(t){this._highlights.add(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(t){this._highlights.delete(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const tv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Mc=M(),QU=M(),CQe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],ud=Te();function RQe(e){const t=[];return e.stageResources.geometries.forEach((i,r)=>{const s=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:s,geometry:i,textures:n})}),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function OQe(e){return{levels:e.map(t=>RQe(t))}}function MQe(e,t=IQe){const i=Uqe(e);return Math.sqrt(i/(t*Math.PI))}function PQe(e){e.levels.forEach(t=>{t.minScreenSpaceRadius||(t.minScreenSpaceRadius=MQe(t))})}const IQe=.05;function ift(e){return e=e||globalThis.location.hostname,DQe.some(t=>{var i;return((i=e)==null?void 0:i.match(t))!=null})}function $Qe(e,t){return e&&(t=t||globalThis.location.hostname)?t.match(D0e)!=null||t.match(N0e)!=null?e.replace("static.arcgis.com","staticdev.arcgis.com"):t.match(L0e)!=null||t.match(F0e)!=null?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}const D0e=/^devext.arcgis.com$/,L0e=/^qaext.arcgis.com$/,N0e=/^[\w-]*\.mapsdevext.arcgis.com$/,F0e=/^[\w-]*\.mapsqa.arcgis.com$/,DQe=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,D0e,L0e,/^jsapps.esri.com$/,N0e,F0e];function LQe(e,t,i){if(e.count!==t.count)return void dF.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=i[9],y=i[10],v=i[11],b=i[12],w=i[13],S=i[14],T=i[15],A=e.typedBuffer,C=e.typedBufferStride,R=t.typedBuffer,L=t.typedBufferStride;for(let U=0;U<r;U++){const N=U*C,z=U*L,V=R[z],B=R[z+1],J=R[z+2],Z=R[z+3];A[N]=s*V+l*B+f*J+b*Z,A[N+1]=n*V+c*B+g*J+w*Z,A[N+2]=o*V+h*B+y*J+S*Z,A[N+3]=a*V+p*B+v*J+T*Z}}function U0e(e,t,i){if(e.count!==t.count)return void dF.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,b=t.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,A=v[T],C=v[T+1],R=v[T+2],L=v[T+3];g[S]=s*A+a*C+h*R,g[S+1]=n*A+l*C+p*R,g[S+2]=o*A+c*C+f*R,g[S+3]=L}}function i9(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2],s[c+3]=i*o[h+3]}}function NQe(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i,s[c+3]=o[h+3]>>i}}Object.freeze({__proto__:null,transformMat4:LQe,transformMat3:U0e,scale:i9,shiftRight:NQe});function FQe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:FQe});function UQe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:UQe});function kQe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],l+=s,c+=o}function UI(e,t){const i=e.count;t||(t=new e.TypedArrayConstructor(i));for(let r=0;r<i;r++)t[r]=e.get(r);return t}Object.freeze({__proto__:null,copy:kQe,makeDense:UI});function k0e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],l+=s,c+=o}function z0e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;if(yVe(t.elementType)){const h=vVe(t.elementType);if(gVe(t.elementType))for(let p=0;p<a;++p)r[l]=Math.max(n[c]/h,-1),r[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)r[l]=n[c]/h,r[l+1]=n[c+1]/h,l+=s,c+=o}else k0e(e,t,i);return e}function zQe(e,t,i,r){var s,n;const o=e.typedBuffer,a=e.typedBufferStride,l=(s=r==null?void 0:r.count)!=null?s:e.count;let c=((n=r==null?void 0:r.dstIndex)!=null?n:0)*a;for(let h=0;h<l;++h)o[c]=t,o[c+1]=i,c+=a}Object.freeze({__proto__:null,copy:k0e,normalizeIntegerBuffer:z0e,fill:zQe});function lq(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],l+=s,c+=o}function BQe(e,t,i,r,s){var n,o;const a=e.typedBuffer,l=e.typedBufferStride,c=(n=s==null?void 0:s.count)!=null?n:e.count;let h=((o=s==null?void 0:s.dstIndex)!=null?o:0)*l;for(let p=0;p<c;++p)a[h]=t,a[h+1]=i,a[h+2]=r,h+=l}Object.freeze({__proto__:null,copy:lq,fill:BQe});function B0e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],r[l+3]=n[c+3],l+=s,c+=o}function V0e(e,t,i,r,s,n){var o,a;const l=e.typedBuffer,c=e.typedBufferStride,h=(o=n==null?void 0:n.count)!=null?o:e.count;let p=((a=n==null?void 0:n.dstIndex)!=null?a:0)*c;for(let f=0;f<h;++f)l[p]=t,l[p+1]=i,l[p+2]=r,l[p+3]=s,p+=c}Object.freeze({__proto__:null,copy:B0e,fill:V0e});function x_(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Xfe(e.ElementType)))}class G0e{constructor(t){this.streamDataRequester=t}async loadJSON(t,i){return this._load("json",t,i)}async loadBinary(t,i){return Sp(t)?(Jt(i),Hoe(t)):this._load("binary",t,i)}async loadImage(t,i){return this._load("image",t,i)}async _load(t,i,r){if(O(this.streamDataRequester))return(await Ci(i,{responseType:VQe[t]})).data;const s=await Bh(this.streamDataRequester.request(i,t,r));if(s.ok===!0)return s.value;throw Em(s.error),new Q("",`Request for resource failed: ${s.error}`)}}const VQe={image:"image",binary:"array-buffer",json:"json"},GQe=he.getLogger("esri.views.3d.glTF");class jQe{error(t){throw new Q("gltf-loader-error",t)}errorUnsupported(t){throw new Q("gltf-loader-unsupported-feature",t)}errorUnsupportedIf(t,i){t&&this.errorUnsupported(i)}assert(t,i){t||this.error(i)}warn(t){GQe.warn(t)}warnUnsupported(t){this.warn("[Unsupported Feature] "+t)}warnUnsupportedIf(t,i){t&&this.warnUnsupported(i)}}function HQe(e={}){return I({color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply"},e)}function qQe(e,t={}){return{data:e,parameters:I({wrap:I({s:lt.REPEAT,t:lt.REPEAT},t.wrap),noUnpackFlip:!0,mipmap:!1},t)}}class F1{constructor(t,i,r=""){this.major=t,this.minor=i,this._context=r}lessThan(t,i){return this.major<t||t===this.major&&this.minor<i}since(t,i){return!this.lessThan(t,i)}validate(t){if(this.major!==t.major){const i=this._context&&this._context+":",r=this._context&&this._context+" ";throw new Q(i+"unsupported-version",`Required major ${r}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:t})}}clone(){return new F1(this.major,this.minor,this._context)}static parse(t,i=""){const[r,s]=t.split("."),n=/^\s*\d+\s*$/;if(!r||!r.match||!r.match(n))throw new Q((i&&i+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:t});if(!s||!s.match||!s.match(n))throw new Q((i&&i+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:t});const o=parseInt(r,10),a=parseInt(s,10);return new F1(o,a,i)}}class ate{constructor(t){this.data=t,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const t=this.offset4;return this.offset4+=1,this.dataUint32[t]}readUint8Array(t){const i=4*this.offset4;return this.offset4+=t/4,new Uint8Array(this.data,i,t)}remainingBytes(){return this.data.byteLength-4*this.offset4}}var kA,lte;(function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"})(kA||(kA={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(lte||(lte={}));const j0e={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},WQe={pbrMetallicRoughness:j0e,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},XQe={ESRI_externalColorMixMode:"tint"},cte=(e={})=>{const t=I(I({},j0e),e.pbrMetallicRoughness),i=YQe(I(I({},XQe),e.extras));return me(I(I({},WQe),e),{pbrMetallicRoughness:t,extras:i})};function YQe(e){switch(e.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:e.ESRI_externalColorMixMode,e.ESRI_externalColorMixMode="tint"}return e}const ZQe={magFilter:Ve.LINEAR,minFilter:Ve.LINEAR_MIPMAP_LINEAR,wrapS:lt.REPEAT,wrapT:lt.REPEAT},QQe=e=>I(I({},ZQe),e);function JQe(e){let t,i;return e.replace(/^(.*\/)?([^/]*)$/,(r,s,n)=>(t=s||"",i=n||"","")),{dirPart:t,filePart:i}}const cP={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};class Lf{constructor(t,i,r,s,n){this.context=t,this.errorContext=i,this.uri=r,this.json=s,this.glbBuffer=n,this.bufferLoaders=new Map,this.textureLoaders=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=JQe(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.errorUnsupportedIf(s.scenes==null,"Scenes must be defined."),i.errorUnsupportedIf(s.meshes==null,"Meshes must be defined"),i.errorUnsupportedIf(s.nodes==null,"Nodes must be defined."),this._computeNodeParents()}static async load(t,i,r,s){if(Sp(r)){const a=HL(r);if(a.mediaType!=="model/gltf-binary")try{const c=JSON.parse(a.isBase64?atob(a.data):a.data);return new Lf(t,i,r,c)}catch{}const l=Hoe(r);if(Lf._isGLBData(l))return this._fromGLBData(t,i,r,l)}if(r.endsWith(".gltf")){const a=await t.loadJSON(r,s);return new Lf(t,i,r,a)}const n=await t.loadBinary(r,s);if(Lf._isGLBData(n))return this._fromGLBData(t,i,r,n);const o=await t.loadJSON(r,s);return new Lf(t,i,r,o)}static _isGLBData(t){const i=new ate(t);return i.remainingBytes()>=4&&i.readUint32()===cP.MAGIC}static async _fromGLBData(t,i,r,s){const n=await Lf._parseGLBData(i,s);return new Lf(t,i,r,n.json,n.binaryData)}static async _parseGLBData(t,i){const r=new ate(i);t.assert(r.remainingBytes()>=12,"GLB binary data is insufficiently large.");const s=r.readUint32(),n=r.readUint32(),o=r.readUint32();t.assert(s===cP.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),t.assert(i.byteLength>=o,"GLB binary data is smaller than header specifies."),t.errorUnsupportedIf(n!==2,"An unsupported GLB container version was detected. Only version 2 is supported.");let a,l,c=0;for(;r.remainingBytes()>=8;){const h=r.readUint32(),p=r.readUint32();c===0?(t.assert(p===cP.CHUNK_TYPE_JSON,"First GLB chunk must be JSON."),t.assert(h>=0,"No JSON data found."),a=await sJe(r.readUint8Array(h))):c===1?(t.errorUnsupportedIf(p!==cP.CHUNK_TYPE_BIN,"Second GLB chunk expected to be BIN."),l=r.readUint8Array(h)):t.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return a||t.error("No GLB JSON chunk detected."),{json:a,binaryData:l}}async getBuffer(t,i){const r=this.json.buffers[t],s=this.errorContext;if(r.uri==null)return s.assert(this.glbBuffer!=null,"GLB buffer not present"),this.glbBuffer;const n=await this._getBufferLoader(t,i);return s.assert(n.byteLength===r.byteLength,"Buffer byte lengths should match."),n}async _getBufferLoader(t,i){const r=this.bufferLoaders.get(t);if(r)return r;const s=this.json.buffers[t],n=this.context.loadBinary(this._resolveUri(s.uri),i).then(o=>new Uint8Array(o));return this.bufferLoaders.set(t,n),n}async getAccessor(t,i){const r=this.errorContext;r.errorUnsupportedIf(!this.json.accessors,"Accessors missing.");const s=this.json.accessors[t];r.errorUnsupportedIf((s==null?void 0:s.bufferView)==null,"Some accessor does not specify a bufferView."),r.errorUnsupportedIf(s.type in[kA.MAT2,kA.MAT3,kA.MAT4],`AttributeType ${s.type} is not supported`);const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,i),a=tJe[s.type],l=iJe[s.componentType],c=a*l,h=n.byteStride||c;return{raw:o.buffer,byteStride:h,byteOffset:o.byteOffset+(n.byteOffset||0)+(s.byteOffset||0),entryCount:s.count,isDenselyPacked:h===c,componentCount:a,componentByteSize:l,componentType:s.componentType,min:s.min,max:s.max,normalized:!!s.normalized}}async getIndexData(t,i){if(t.indices==null)return null;const r=await this.getAccessor(t.indices,i);if(r.isDenselyPacked)switch(r.componentType){case nt.UNSIGNED_BYTE:return new Uint8Array(r.raw,r.byteOffset,r.entryCount);case nt.UNSIGNED_SHORT:return new Uint16Array(r.raw,r.byteOffset,r.entryCount);case nt.UNSIGNED_INT:return new Uint32Array(r.raw,r.byteOffset,r.entryCount)}else switch(r.componentType){case nt.UNSIGNED_BYTE:return UI(this._wrapAccessor(_m,r));case nt.UNSIGNED_SHORT:return UI(this._wrapAccessor(S1,r));case nt.UNSIGNED_INT:return UI(this._wrapAccessor(A1,r))}}async getPositionData(t,i){const r=this.errorContext;r.errorUnsupportedIf(t.attributes.POSITION==null,"No POSITION vertex data found.");const s=await this.getAccessor(t.attributes.POSITION,i);return r.errorUnsupportedIf(s.componentType!==nt.FLOAT,"Expected type FLOAT for POSITION vertex attribute, but found "+hP[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"POSITION vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Ti,s)}async getNormalData(t,i){const r=this.errorContext;r.assert(t.attributes.NORMAL!=null,"No NORMAL vertex data found.");const s=await this.getAccessor(t.attributes.NORMAL,i);return r.errorUnsupportedIf(s.componentType!==nt.FLOAT,"Expected type FLOAT for NORMAL vertex attribute, but found "+hP[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"NORMAL vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Ti,s)}async getTangentData(t,i){const r=this.errorContext;r.assert(t.attributes.TANGENT!=null,"No TANGENT vertex data found.");const s=await this.getAccessor(t.attributes.TANGENT,i);return r.errorUnsupportedIf(s.componentType!==nt.FLOAT,"Expected type FLOAT for TANGENT vertex attribute, but found "+hP[s.componentType]),r.errorUnsupportedIf(s.componentCount!==4,"TANGENT vertex attribute must have 4 components, but found "+s.componentCount.toFixed()),new Js(s.raw,s.byteOffset,s.byteStride,s.byteOffset+s.byteStride*s.entryCount)}async getTextureCoordinates(t,i){const r=this.errorContext;r.assert(t.attributes.TEXCOORD_0!=null,"No TEXCOORD_0 vertex data found.");const s=await this.getAccessor(t.attributes.TEXCOORD_0,i);return r.errorUnsupportedIf(s.componentCount!==2,"TEXCOORD_0 vertex attribute must have 2 components, but found "+s.componentCount.toFixed()),s.componentType===nt.FLOAT?this._wrapAccessor(Ru,s):(r.errorUnsupportedIf(!s.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),rJe(s))}async getVertexColors(t,i){const r=this.errorContext;r.assert(t.attributes.COLOR_0!=null,"No COLOR_0 vertex data found.");const s=await this.getAccessor(t.attributes.COLOR_0,i);if(r.errorUnsupportedIf(s.componentCount!==4&&s.componentCount!==3,"COLOR_0 attribute must have 3 or 4 components, but found "+s.componentCount.toFixed()),s.componentCount===4){if(s.componentType===nt.FLOAT)return this._wrapAccessor(Js,s);if(s.componentType===nt.UNSIGNED_BYTE)return this._wrapAccessor(Ca,s);if(s.componentType===nt.UNSIGNED_SHORT)return this._wrapAccessor(d0,s)}else if(s.componentCount===3){if(s.componentType===nt.FLOAT)return this._wrapAccessor(Ti,s);if(s.componentType===nt.UNSIGNED_BYTE)return this._wrapAccessor(h0,s);if(s.componentType===nt.UNSIGNED_SHORT)return this._wrapAccessor(E1,s)}r.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+hP[s.componentType])}hasPositions(t){return t.attributes.POSITION!==void 0}hasNormals(t){return t.attributes.NORMAL!==void 0}hasVertexColors(t){return t.attributes.COLOR_0!==void 0}hasTextureCoordinates(t){return t.attributes.TEXCOORD_0!==void 0}hasTangents(t){return t.attributes.TANGENT!==void 0}async getMaterial(t,i,r){let s=this.materialCache.get(t.material);if(!s){const n=t.material!=null?cte(this.json.materials[t.material]):cte(),o=n.pbrMetallicRoughness,a=this.hasVertexColors(t),l=this.getTexture(o.baseColorTexture,i),c=this.getTexture(n.normalTexture,i),h=r?this.getTexture(n.occlusionTexture,i):null,p=r?this.getTexture(n.emissiveTexture,i):null,f=r?this.getTexture(o.metallicRoughnessTexture,i):null,g=t.material!=null?t.material:-1;s={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:o.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await l,normalTexture:await c,name:n.name,id:g,occlusionTexture:await h,emissiveTexture:await p,emissiveFactor:n.emissiveFactor,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,metallicRoughnessTexture:await f,vertexColors:a,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return s}async getTexture(t,i){if(!t)return null;this.errorContext.errorUnsupportedIf((t.texCoord||0)!==0,"Only TEXCOORD with index 0 is supported.");const r=t.index,s=this.errorContext,n=this.json.textures[r],o=QQe(n.sampler!=null?this.json.samplers[n.sampler]:{});s.errorUnsupportedIf(n.source==null,"Source is expected to be defined for a texture.");const a=this.json.images[n.source],l=await this._loadTextureImageData(r,n,i);return kse(this.textureCache,r,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>(s.error(`Unexpected TextureSampler WrapMode: ${p}. Using default REPEAT(10497).`),10497);return{data:l,wrapS:c(o.wrapS)?o.wrapS:h(o.wrapS),wrapT:c(o.wrapT)?o.wrapT:h(o.wrapT),minFilter:o.minFilter,name:a.name,id:r}})}getNodeTransform(t){if(t===void 0)return eJe;let i=this.nodeTransformCache.get(t);if(!i){const r=this.getNodeTransform(this._getNodeParent(t)),s=this.json.nodes[t];s.matrix?i=ur(Te(),r,s.matrix):s.translation||s.rotation||s.scale?(i=j_(r),s.translation&&Vo(i,i,s.translation),s.rotation&&(uP[3]=Rfe(uP,s.rotation),nl(i,i,uP[3],uP)),s.scale&&eN(i,i,s.scale)):i=r,this.nodeTransformCache.set(t,i)}return i}_wrapAccessor(t,i){return new t(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*(i.entryCount-1)+i.componentByteSize*i.componentCount)}_resolveUri(t){return yu(t,this.baseUri)}_getNodeParent(t){return this.nodeParentMap.get(t)}_checkVersionSupported(){const t=F1.parse(this.json.asset.version,"glTF");KQe.validate(t)}_checkRequiredExtensionsSupported(){const t=this.json,i=this.errorContext;t.extensionsRequired&&t.extensionsRequired.length!==0&&i.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+t.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((t,i)=>{t.children&&t.children.forEach(r=>{this.nodeParentMap.set(r,i)})})}async _loadTextureImageData(t,i,r){const s=this.textureLoaders.get(t);if(s)return s;const n=this._createTextureLoader(i,r);return this.textureLoaders.set(t,n),n}async _createTextureLoader(t,i){const r=this.json.images[t.source];if(r.uri)return this.context.loadImage(this._resolveUri(r.uri),i);const s=this.errorContext;s.errorUnsupportedIf(r.bufferView==null,"Image bufferView must be defined."),s.errorUnsupportedIf(r.mimeType==null,"Image mimeType must be defined.");const n=this.json.bufferViews[r.bufferView],o=await this.getBuffer(n.buffer,i);return s.errorUnsupportedIf(n.byteStride!=null,"byteStride not supported for image buffer"),nJe(new Uint8Array(o.buffer,o.byteOffset+(n.byteOffset||0),n.byteLength),r.mimeType)}}const KQe=new F1(2,0,"glTF"),eJe=Wae(Te(),Math.PI/2),uP=T0(),tJe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},iJe={[nt.BYTE]:1,[nt.UNSIGNED_BYTE]:1,[nt.SHORT]:2,[nt.UNSIGNED_SHORT]:2,[nt.FLOAT]:4,[nt.UNSIGNED_INT]:4};function rJe(e){switch(e.componentType){case nt.BYTE:return new C1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case nt.UNSIGNED_BYTE:return new T1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case nt.SHORT:return new R1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case nt.UNSIGNED_SHORT:return new LT(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case nt.UNSIGNED_INT:return new NT(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case nt.FLOAT:return new Ru(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:return void(e.componentType,void 0)}}async function sJe(e){return new Promise((t,i)=>{const r=new Blob([e]),s=new FileReader;s.onload=()=>{const n=s.result;t(JSON.parse(n))},s.onerror=n=>{i(n)},s.readAsText(r)})}async function nJe(e,t){return new Promise((i,r)=>{const s=new Blob([e],{type:t}),n=URL.createObjectURL(s),o=new Image;o.addEventListener("load",()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>i(o),()=>i(o)):i(o)}),o.addEventListener("error",a=>{URL.revokeObjectURL(n),r(a)}),o.src=n})}const hP={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let oJe=0;async function H0e(e,t,i={},r=!0){const s=await Lf.load(e,kI,t,i),n="gltf_"+oJe++,o={lods:[],materials:new Map,textures:new Map,meta:aJe(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await lJe(s,async(c,h,p,f)=>{var g;const y=(g=l.get(p))!=null?g:0;l.set(p,y+1);const v=c.mode!==void 0?c.mode:Tt.TRIANGLES,b=v===Tt.TRIANGLES||v===Tt.TRIANGLE_STRIP||v===Tt.TRIANGLE_FAN?v:null;if(O(b))return void kI.warnUnsupported("Unsupported primitive mode ("+dJe[v]+"). Skipping primitive.");if(!s.hasPositions(c))return void kI.warn("Skipping primitive without POSITION vertex attribute.");const w=s.getPositionData(c,i),S=s.getMaterial(c,i,r),T=s.hasNormals(c)?s.getNormalData(c,i):null,A=s.hasTangents(c)?s.getTangentData(c,i):null,C=s.hasTextureCoordinates(c)?s.getTextureCoordinates(c,i):null,R=s.hasVertexColors(c)?s.getVertexColors(c,i):null,L=s.getIndexData(c,i),U={transform:j_(h),attributes:{position:await w,normal:T?await T:null,texCoord0:C?await C:null,color:R?await R:null,tangent:A?await A:null},indices:await L,primitiveType:b,material:uJe(o,await S,n)};let N=null;_(o.meta)&&_(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(N=o.meta.ESRI_lod.thresholds[p]),o.lods[p]=o.lods[p]||{parts:[],name:f,lodThreshold:N},o.lods[p].parts[y]=U});for(const c of o.lods)c.parts=c.parts.filter(h=>!!h);return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{}}}function aJe(e){const t=e.json;let i=null;return t.nodes.forEach(r=>{const s=r.extras;_(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(i=s)}),i}async function lJe(e,t){const i=e.json,r=i.scenes[i.scene||0].nodes,s=r.length>1,n=[];for(const a of r){const l=i.nodes[a];n.push(o(a,0)),cJe(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=i.nodes[a],h=e.getNodeTransform(a);if(kI.warnUnsupportedIf(c.weights!=null,"Morph targets are not supported."),c.mesh!=null){const p=i.meshes[c.mesh];for(const f of p.primitives)n.push(t(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function cJe(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function uJe(e,t,i){const r=n=>{const o=`${i}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!e.textures.has(o)){const a=qQe(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:hJe.some(l=>l===n.minFilter),noUnpackFlip:!0});e.textures.set(o,a)}return o},s=`${i}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const n=HQe({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,n)}return s}const kI=new jQe,hJe=[Ve.LINEAR_MIPMAP_LINEAR,Ve.LINEAR_MIPMAP_NEAREST],dJe=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];function pJe(e,t=UT){return typeof e=="number"?t(e):r$(e)||a_(e)?new Uint32Array(e):e}function fJe(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;n+=1)n%2==0?(r[s++]=n,r[s++]=n+1,r[s++]=n+2):(r[s++]=n+1,r[s++]=n,r[s++]=n+2)}else{let s=0;for(let n=0;n<i;n+=1)if(n%2==0){const o=e[n],a=e[n+1],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}else{const o=e[n+1],a=e[n],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}}return r}function mJe(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;++n)r[s++]=0,r[s++]=n+1,r[s++]=n+2;return r}{const s=e[0];let n=e[1],o=0;for(let a=0;a<i;++a){const l=e[a+2];r[o++]=s,r[o++]=n,r[o++]=l,n=l}return r}}const Ef=he.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function q0e(e,t){const i=await gJe(e,t);return{resource:i,textures:await wJe(i.textureDefinitions,t)}}async function gJe(e,t){const i=_(t)&&t.streamDataRequester;if(i)return yJe(e,i,t);const r=await Bh(Ci(e,t));if(r.ok===!0)return r.value.data;Em(r.error),W0e(r.error)}async function yJe(e,t,i){const r=await Bh(t.request(e,"json",i));if(r.ok===!0)return r.value;Em(r.error),W0e(r.error.details.url)}function W0e(e){throw new Q("",`Request for object resource failed: ${e}`)}function vJe(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(Ef.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=t.faces;if(n){if(t.vertexAttributes)for(const o in t.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(Ef.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),r=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(Ef.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),r=!1)):(Ef.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else Ef.warn("Indexed geometries must specify faces"),r=!1;break}default:Ef.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(Ef.warn("Geometry requires material"),r=!1);const s=e.params.vertexAttributes;for(const n in s)s[n].values||(Ef.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function _Je(e,t){const i=[],r=[],s=[],n=[],o=e.resource,a=F1.parse(o.version||"1.0","wosr");TJe.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions,p=e.textures;let f=0;const g=new Map;for(let y=0;y<c.length;y++){const v=c[y];if(!vJe(v))continue;const b=xJe(v),w=v.params.vertexAttributes,S=[];for(const N in w){const z=w[N],V=z.values;S.push([N,{data:V,size:z.valuesPerElement,exclusive:!0}])}const T=[];if(v.params.topology!=="PerAttributeArray"){const N=v.params.faces;for(const z in N)T.push([z,new Uint32Array(N[z].values)])}const A=p&&p[b.texture];if(A&&!g.has(b.texture)){const{image:N,params:z}=A,V=new Kr(N,z);n.push(V),g.set(b.texture,V)}const C=g.get(b.texture),R=C?C.id:void 0;let L=s[b.material]?s[b.material][b.texture]:null;if(!L){const N=h[b.material.substring(b.material.lastIndexOf("/")+1)].params;N.transparency===1&&(N.transparency=0);const z=A&&A.alphaChannelUsage,V=N.transparency>0||z==="transparency"||z==="maskAndTransparency",B=A?X0e(A.alphaChannelUsage):void 0,J={ambient:aa(N.diffuse),diffuse:aa(N.diffuse),opacity:1-(N.transparency||0),transparent:V,textureAlphaMode:B,textureAlphaCutoff:.33,textureId:R,initTextureTransparent:!0,doubleSided:!0,cullFace:$i.None,colorMixMode:N.externalColorMixMode||"tint",textureAlphaPremultiplied:!!A&&!!A.params.preMultiplyAlpha};_(t)&&t.materialParamsMixin&&Object.assign(J,t.materialParamsMixin),L=new L1(J),s[b.material]||(s[b.material]={}),s[b.material][b.texture]=L}r.push(L);const U=new or(S,T);f+=T.position?T.position.length:0,i.push(U)}return{name:l,stageResources:{textures:n,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:bJe(i),numberOfVertices:f,lodThreshold:null}}function bJe(e){const t=Ui();return e.forEach(i=>{const r=i.boundingInfo;_(r)&&(hp(t,r.getBBMin()),hp(t,r.getBBMax()))}),t}async function wJe(e,t){const i=[];for(const n in e){const o=e[n],a=o.images[0].data;if(!a){Ef.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:lt.REPEAT,t:lt.REPEAT},preMultiplyAlpha:X0e(h)!==Ai.Opaque},f=_(t)&&t.disableTextures?Promise.resolve(null):Cu(l,t);i.push(f.then(g=>({refId:c,image:g,params:p,alphaChannelUsage:h})))}const r=await Promise.all(i),s={};for(const n of r)s[n.refId]=n;return s}function X0e(e){switch(e){case"mask":return Ai.Mask;case"maskAndTransparency":return Ai.MaskBlend;case"none":return Ai.Opaque;default:return Ai.Blend}}function xJe(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const TJe=new F1(1,2,"wosr"),Lb=2.1;async function Y0e(e,t){const i=Z0e($Qe(e));if(i.fileType==="wosr"){const l=await(t.cache?t.cache.loadWOSR(i.url,t):q0e(i.url,t)),c=_Je(l,t);return{lods:[c],referenceBoundingBox:c.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:l.remove}}const r=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):H0e(new G0e(t.streamDataRequester),i.url,t,t.usePBR)),s=bs(r.model.meta,"ESRI_proxyEllipsoid");r.meta.isEsriSymbolResource&&_(s)&&r.meta.uri.indexOf("/RealisticTrees/")!==-1&&AJe(r,s);const n=r.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:r.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},o=me(I({},t.materialParamsMixin),{treeRendering:r.customMeta.esriTreeRendering});if(i.specifiedLodIndex!=null){const l=zI(r,n,o,i.specifiedLodIndex);let c=l[0].boundingBox;return i.specifiedLodIndex!==0&&(c=zI(r,n,o,0)[0].boundingBox),{lods:l,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}const a=zI(r,n,o);return{lods:a,referenceBoundingBox:a[0].boundingBox,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}function Z0e(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function zI(e,t,i,r){const s=e.model,n=br(),o=new Array,a=new Map,l=new Map;return s.lods.forEach((c,h)=>{if(r!==void 0&&h!==r)return;const p={name:c.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:_(c.lodThreshold)?c.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:Ui()};o.push(p),c.parts.forEach(f=>{const g=f.material+(f.attributes.normal?"_normal":"")+(f.attributes.color?"_color":"")+(f.attributes.texCoord0?"_texCoord0":"")+(f.attributes.tangent?"_tangent":""),y=s.materials.get(f.material),v=_(f.attributes.texCoord0),b=_(f.attributes.normal),w=SJe(y.alphaMode);if(!a.has(g)){if(v){if(_(y.textureColor)&&!l.has(y.textureColor)){const ie=s.textures.get(y.textureColor),$=me(I({},ie.parameters),{preMultiplyAlpha:w!==Ai.Opaque});l.set(y.textureColor,new Kr(ie.data,$))}if(_(y.textureNormal)&&!l.has(y.textureNormal)){const ie=s.textures.get(y.textureNormal);l.set(y.textureNormal,new Kr(ie.data,ie.parameters))}if(_(y.textureOcclusion)&&!l.has(y.textureOcclusion)){const ie=s.textures.get(y.textureOcclusion);l.set(y.textureOcclusion,new Kr(ie.data,ie.parameters))}if(_(y.textureEmissive)&&!l.has(y.textureEmissive)){const ie=s.textures.get(y.textureEmissive);l.set(y.textureEmissive,new Kr(ie.data,ie.parameters))}if(_(y.textureMetallicRoughness)&&!l.has(y.textureMetallicRoughness)){const ie=s.textures.get(y.textureMetallicRoughness);l.set(y.textureMetallicRoughness,new Kr(ie.data,ie.parameters))}}const N=y.color[0]**(1/Lb),z=y.color[1]**(1/Lb),V=y.color[2]**(1/Lb),B=y.emissiveFactor[0]**(1/Lb),J=y.emissiveFactor[1]**(1/Lb),Z=y.emissiveFactor[2]**(1/Lb),te=_(y.textureColor)&&v?l.get(y.textureColor):null;a.set(g,new L1(I(me(I({},t),{transparent:w===Ai.Blend,customDepthTest:_1.Lequal,textureAlphaMode:w,textureAlphaCutoff:y.alphaCutoff,diffuse:[N,z,V],ambient:[N,z,V],opacity:y.opacity,doubleSided:y.doubleSided,doubleSidedType:"winding-order",cullFace:y.doubleSided?$i.None:$i.Back,vertexColors:!!f.attributes.color,vertexTangents:!!f.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,fillLightsEnabled:!0,textureId:_(te)?te.id:void 0,colorMixMode:y.colorMixMode,normalTextureId:_(y.textureNormal)&&v?l.get(y.textureNormal).id:void 0,textureAlphaPremultiplied:_(te)&&!!te.params.preMultiplyAlpha,occlusionTextureId:_(y.textureOcclusion)&&v?l.get(y.textureOcclusion).id:void 0,emissiveTextureId:_(y.textureEmissive)&&v?l.get(y.textureEmissive).id:void 0,metallicRoughnessTextureId:_(y.textureMetallicRoughness)&&v?l.get(y.textureMetallicRoughness).id:void 0,emissiveFactor:[B,J,Z],mrrFactors:[y.metallicFactor,y.roughnessFactor,t.mrrFactors[2]],isSchematic:!1}),i)))}const S=EJe(f.indices||f.attributes.position.count,f.primitiveType),T=f.attributes.position.count,A=x_(Ti,T);nO(A,f.attributes.position,f.transform);const C=[[E.POSITION,{data:A.typedBuffer,size:A.elementCount,exclusive:!0}]],R=[[E.POSITION,S]];if(_(f.attributes.normal)){const N=x_(Ti,T);OT(n,f.transform),I1(N,f.attributes.normal,n),C.push([E.NORMAL,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),R.push([E.NORMAL,S])}if(_(f.attributes.tangent)){const N=x_(Js,T);OT(n,f.transform),U0e(N,f.attributes.tangent,n),C.push([E.TANGENT,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),R.push([E.TANGENT,S])}if(_(f.attributes.texCoord0)){const N=x_(Ru,T);z0e(N,f.attributes.texCoord0),C.push([E.UV0,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),R.push([E.UV0,S])}if(_(f.attributes.color)){const N=x_(Ca,T);if(f.attributes.color.elementCount===4)f.attributes.color instanceof Js?i9(N,f.attributes.color,255):f.attributes.color instanceof Ca?B0e(N,f.attributes.color):f.attributes.color instanceof d0&&i9(N,f.attributes.color,1/256);else{V0e(N,255,255,255,255);const z=new h0(N.buffer,0,4);f.attributes.color instanceof Ti?j8(z,f.attributes.color,255):f.attributes.color instanceof h0?lq(z,f.attributes.color):f.attributes.color instanceof E1&&j8(z,f.attributes.color,1/256)}C.push([E.COLOR,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),R.push([E.COLOR,S])}const L=new or(C,R);p.stageResources.geometries.push(L),p.stageResources.materials.push(a.get(g)),v&&(_(y.textureColor)&&p.stageResources.textures.push(l.get(y.textureColor)),_(y.textureNormal)&&p.stageResources.textures.push(l.get(y.textureNormal)),_(y.textureOcclusion)&&p.stageResources.textures.push(l.get(y.textureOcclusion)),_(y.textureEmissive)&&p.stageResources.textures.push(l.get(y.textureEmissive)),_(y.textureMetallicRoughness)&&p.stageResources.textures.push(l.get(y.textureMetallicRoughness))),p.numberOfVertices+=T;const U=L.boundingInfo;_(U)&&(hp(p.boundingBox,U.getBBMin()),hp(p.boundingBox,U.getBBMax()))})}),o}function SJe(e){switch(e){case"BLEND":return Ai.Blend;case"MASK":return Ai.Mask;case"OPAQUE":case null:case void 0:return Ai.Opaque}}function EJe(e,t){switch(t){case Tt.TRIANGLES:return pJe(e);case Tt.TRIANGLE_STRIP:return fJe(e);case Tt.TRIANGLE_FAN:return mJe(e)}}function AJe(e,t){for(let i=0;i<e.model.lods.length;++i){const r=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const s of r.parts){const n=s.attributes.normal;if(O(n))return;const o=s.attributes.position,a=o.count,l=M(),c=M(),h=M(),p=x_(Ca,a),f=x_(Ti,a),g=hr(Te(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),Ue(c,c,s.transform),de(h,c,t.center),_$(h,h,t.radius);const v=h[2],b=Pe(h),w=Math.min(.45+.55*b*b,1);_$(h,h,t.radius),Ue(h,h,g),be(h,h),i+1!==e.model.lods.length&&e.model.lods.length>1&&Ss(h,h,l,v>-1?.2:Math.min(-4*v-3.8,1)),f.setVec(y,h),p.set(y,0,255*w),p.set(y,1,255*w),p.set(y,2,255*w),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}var rft=Object.freeze(Object.defineProperty({__proto__:null,fetch:Y0e,gltfToEngineResources:zI,parseUrl:Z0e},Symbol.toStringTag,{value:"Module"})),Ji;function CJe(e){let t=Nr().mat4f64(E.LOCALTRANSFORM).mat4f64(E.GLOBALTRANSFORM).vec4f64(E.BOUNDINGSPHERE).vec3f64(E.MODELORIGIN).mat3f(E.MODEL).mat3f(E.MODELNORMAL).vec2f(E.MODELSCALEFACTORS);return e.indexOf("color")>=0&&(t=t.vec4f(E.COLOR)),e.indexOf("featureAttribute")>=0&&(t=t.vec4f(E.FEATUREATTRIBUTE)),t=t.u8(E.STATE).u8(E.LODLEVEL).alignTo(8),t}(function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"})(Ji||(Ji={}));class RJe{constructor(t){this.localTransform=t.getField(E.LOCALTRANSFORM,u0),this.globalTransform=t.getField(E.GLOBALTRANSFORM,u0),this.modelOrigin=t.getField(E.MODELORIGIN,jr),this.model=t.getField(E.MODEL,qh),this.modelNormal=t.getField(E.MODELNORMAL,qh),this.modelScaleFactors=t.getField(E.MODELSCALEFACTORS,Ru),this.boundingSphere=t.getField(E.BOUNDINGSPHERE,x1),this.color=t.getField(E.COLOR,Js),this.featureAttribute=t.getField(E.FEATUREATTRIBUTE,Js),this.state=t.getField(E.STATE,_m),this.lodLevel=t.getField(E.LODLEVEL,_m)}}class OJe extends wr{constructor(t,i){super(),this._capacity=0,this._size=0,this._next=0,this._layout=CJe(t),this._shaderTransformation=i}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,Ji.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const i=this._view.state;ot(t>=0&&t<this._capacity&&i.get(t)&Ji.ALLOCATED,"invalid instance handle"),this._getStateFlag(t,Ji.ACTIVE)?this._setStateFlags(t,Ji.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})}freeInstance(t){const i=this._view.state;ot(t>=0&&t<this._capacity&&i.get(t)&Ji.ALLOCATED,"invalid instance handle"),i.set(t,0),this._size--}setLocalTransform(t,i,r=!0){this._view.localTransform.setMat(t,i),r&&this.updateModelTransform(t)}getLocalTransform(t,i){this._view.localTransform.getMat(t,i)}setGlobalTransform(t,i,r=!0){this._view.globalTransform.setMat(t,i),r&&this.updateModelTransform(t)}getGlobalTransform(t,i){this._view.globalTransform.getMat(t,i)}updateModelTransform(t){const i=this._view,r=og,s=Vu;i.localTransform.getMat(t,ute),i.globalTransform.getMat(t,JU);const n=ur(JU,JU,ute);oe(r,n[12],n[13],n[14]),i.modelOrigin.setVec(t,r),Eu(s,n),i.model.setMat(t,s);const o=Mxe(og,n);o.sort(),i.modelScaleFactors.set(t,0,o[1]),i.modelScaleFactors.set(t,1,o[2]),w1(s,s),Au(s,s),i.modelNormal.setMat(t,s),this._setStateFlags(t,Ji.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})}getModelTransform(t,i){const r=this._view;r.model.getMat(t,Vu),r.modelOrigin.getVec(t,og),i[0]=Vu[0],i[1]=Vu[1],i[2]=Vu[2],i[3]=0,i[4]=Vu[3],i[5]=Vu[4],i[6]=Vu[5],i[7]=0,i[8]=Vu[6],i[9]=Vu[7],i[10]=Vu[8],i[11]=0,i[12]=og[0],i[13]=og[1],i[14]=og[2],i[15]=1}applyShaderTransformation(t,i){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i)}getCombinedModelTransform(t,i){return this.getModelTransform(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedLocalTransform(t,i){return this._view.localTransform.getMat(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedMaxScaleFactor(t){let i=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(og,this,t);i*=Math.max(r[0],r[1],r[2])}return i}getCombinedMedianScaleFactor(t){let i=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(og,this,t);r.sort(),i*=r[1]}return i}getModel(t,i){this._view.model.getMat(t,i)}setFeatureAttribute(t,i){this._view.featureAttribute.setVec(t,i)}getFeatureAttribute(t,i){this._view.featureAttribute.getVec(t,i)}setColor(t,i){this._view.color.setVec(t,i)}getColor(t,i){this._view.color.getVec(t,i)}setVisible(t,i){i!==this.getVisible(t)&&(this._setStateFlag(t,Ji.VISIBLE,i),this.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,Ji.VISIBLE)}setHighlight(t,i){i!==this.getHighlight(t)&&(this._setStateFlag(t,Ji.HIGHLIGHT,i),this.emit("instance-highlight-changed",{index:t}))}getHighlight(t){return this._getStateFlag(t,Ji.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let i=0;for(let r=0;r<this._capacity;++r)this.getState(r)&t&&++i;return i}_setStateFlags(t,i){const r=this._view.state;i=r.get(t)|i,r.set(t,i)}_clearStateFlags(t,i){const r=this._view.state;i=r.get(t)&~i,r.set(t,i)}_setStateFlag(t,i,r){r?this._setStateFlags(t,i):this._clearStateFlags(t,i)}_getStateFlag(t,i){return!!(this._view.state.get(t)&i)}_grow(){const t=Math.max(MJe,Math.floor(this._capacity*PJe)),i=this._layout.createBuffer(t);if(this._buffer){const r=new Uint8Array(this._buffer.buffer);new Uint8Array(i.buffer).set(r)}this._capacity=t,this._buffer=i,this._view=new RJe(this._buffer)}_findSlot(){const t=this._view.state;let i=this._next;for(;t.get(i)&Ji.ALLOCATED;)i=(i+1)%this._capacity;return this._next=(i+1)%this._capacity,i}}const MJe=1024,PJe=2,og=M(),Vu=br(),ute=Te(),JU=Te();class IJe extends Gye{constructor(t,i){super(r=>this._instanceData.view.boundingSphere.getVec(r,this._tmpSphere),{maximumDepth:25}),this._tmpSphere=vn(),this._tmpMat4=Te(),this._instanceData=t,this._boundingSphere=i}addInstance(t){const i=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);Ue(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*r1(r),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class $Je{constructor(t,i){this.thresholdScale=1,this._camera=new wi,this._worldSpaceRadius=t,this._thresholds=i.map(r=>r)}updateCamera(t){this._camera.copyFrom(t)}selectLevel(t,i){const r=this._camera.computeScreenPixelSizeAt(t),s=this._worldSpaceRadius*i/r,n=this._thresholds;let o=-1;for(let a=0;a<n.length;++a)s>=n[a]*this.thresholdScale&&(o=a);return o}}class DJe{constructor(t,i){const r=t.renderContext.rctx,{geometry:s,material:n}=i;this._materialRepository=t.materialRep,n.setParameters({instancedDoublePrecision:!0});const o=n.createBufferWriter(),a=o.vertexBufferLayout,l=o.elementCount(s),c=o.allocate(l);o.write({},s,c,0),this.geometry=s,this.material=n,this.glMaterials=new $ye(n,this._materialRepository),this.vertexBufferLayout=a,this.vbo=jt.createVertex(r,ri.STATIC_DRAW,c.buffer),this.vao=new as(r,mi,{geometry:wl(a)},{geometry:this.vbo}),this.vertexCount=l}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,i,r,s,n,o){const a=this.geometry.id;this.material.intersect(this.geometry,null,t.transform.transform,t,r,s,(l,c,h,p,f)=>{if(l>=0){if(i!=null&&!i(t.rayBegin,t.rayEnd,l))return;const g={layerUid:o.layerUid,graphicUid:o.graphicUid(n),geometryId:a,triangleNr:h};if((t.results.min.drapedLayerOrder==null||f>=t.results.min.drapedLayerOrder)&&(t.results.min.dist==null||l<t.results.min.dist)&&t.results.min.set(lr.LOD,g,l,c,t.transform.transform,f),t.options.store!==Bn.MIN&&(t.results.max.drapedLayerOrder==null||f>=t.results.max.drapedLayerOrder)&&(t.results.max.dist==null||l>t.results.max.dist)&&t.results.max.set(lr.LOD,g,l,c,t.transform.transform,f),t.options.store===Bn.ALL){const y=YN(t.results.min.ray);y.set(lr.LOD,g,l,c,t.transform.transform,f),t.results.all.push(y)}}})}}class cq{constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}static async create(t,i,r){const s=await Promise.allSettled(i.components.map(o=>t.schedule(()=>new DJe(t,o),r))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Ls(r)||n.length!==s.length){n.forEach(o=>o.destroy()),Jt(r);for(const o of s)if(o.status==="rejected")throw o.reason}return new cq(i.minScreenSpaceRadius,n)}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,r,s,n,o){this.components.forEach(a=>a.intersect(t,i,r,s,n,o))}get boundingBox(){if(O(this._boundingBox)){const t=Ui();this.components.forEach(i=>{_(i.boundingInfo)&&(hp(t,i.boundingInfo.bbMin),hp(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(O(this._boundingSphere)){const t=this.boundingBox,i=M();Eh(t,i),this._boundingSphere={center:i,radius:.5*MSe(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}}class LJe{constructor(t,i,r){this._elementSize=i,this._buffer=jt.createVertex(t,ri.STATIC_DRAW),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(t,i,r,s=0){const n=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(r.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){const r=t*this._elementSize,s=i*this._elementSize;this._buffer.setSubData(this._array,r,r,s)}resize(t){const i=t*this._elementSize,r=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=r,this._buffer.setSize(i),this._capacity=t}}class NJe{constructor(t){this.modelOriginHi=t.getField(E.MODELORIGINHI,Ti),this.modelOriginLo=t.getField(E.MODELORIGINLO,Ti),this.model=t.getField(E.MODEL,qh),this.modelNormal=t.getField(E.MODELNORMAL,qh),this.color=t.getField(E.INSTANCECOLOR,Js),this.featureAttribute=t.getField(E.INSTANCEFEATUREATTRIBUTE,Js)}}class hte{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){ot(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){ot(this._updating,"not updating"),this.size<UJe*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){ot(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),ot(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){ot(this._updating,"not updating"),ot(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(dte,Math.floor(this._capacity*FJe));this._resize(t)}_shrink(){const t=Math.max(dte,Math.floor(this._capacity*kJe));this._resize(t)}_resize(t){if(ot(this._updating,"not updating"),t===this._capacity)return;const i=new LJe(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const r=this.size,s=this._compactInstances(i);ot(s===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new NJe(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,r=this._tailIndex;return r<i?(this._buffer.copyRange(r,i,t),i-r):r>i?(this._buffer.copyRange(r,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-r),i+(this._capacity-r)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const dte=1024,FJe=2,UJe=.3,kJe=.5;let zJe=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map(r=>r.minScreenSpaceRadius);return new $Je(t,i)};class BJe{constructor(t,i,r,s){this.type=lr.LOD,this.isGround=!1,this._inverseViewport=Xe(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new wi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[ye.OPAQUE_PLUGIN,ye.TRANSPARENT_PLUGIN],this.canRender=!0,this._symbol=t,this._optionalFields=i,this._metadata=r,this._instanceBufferLayout=b0e({instancedDoublePrecision:!0,instanced:i}),this._glInstanceBufferLayout=wl(this._instanceBufferLayout,1),this._instanceData=new OJe(this._optionalFields,s),this._instanceData.on("instance-added",()=>this._requestUpdateCycle()),this._instanceData.on("instance-removed",()=>this._requestUpdateCycle()),this._instanceData.on("instance-transform-changed",n=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(n.index)}),this._instanceData.on("instance-visibility-changed",n=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(n.index)}),this._instanceData.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0)),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const t={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),this._highlightRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),t}get renderStats(){const t=this._instanceData.size,i=[];return this._levels.forEach((r,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=r.triangleCount;i.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:t,renderedInstances:i.reduce((r,s)=>r+s.renderedInstances,0),renderedTriangles:i.reduce((r,s)=>r+s.renderedTriangles,0),levels:i}}async initializeRenderContext(t,i){this._context=t;const r=t.renderContext.rctx,s=await Promise.allSettled(this._symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new hte(r,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new hte(r,this._instanceBufferLayout)),cq.create(t,o,i)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Ls(i)||n.length!==s.length){n.forEach(o=>o.destroy()),Jt(i);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=zJe(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceData.forEach(t=>t.destroy())}get needsTransparentPass(){return this._levels.some(t=>t.components.some(i=>i.material.requiresSlot(ye.TRANSPARENT_MATERIAL)))}get needsHighlight(){return this._highlightRenderInstanceData.some(t=>t.size>0)}prepareRender(t,i){if(hi.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const s=i.equals(this._lastCamera);this._lastCamera.copyFrom(i),s||this._requestUpdateCycle()}const r=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(i,r),this.needsUpdates&&this._context.requestRender()}render(t){var i,r,s,n;const o=t.slot===ye.OPAQUE_PLUGIN?ye.OPAQUE_MATERIAL:t.slot===ye.TRANSPARENT_PLUGIN?ye.TRANSPARENT_MATERIAL:null;if(!o||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(t.pass))return;const a=t.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const l={slot:o,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:t.shadowMap,shadowMappingEnabled:t.shadowMap.enabled,ssaoHelper:t.ssaoHelper,ssaoEnabled:t.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:t.sliceHelper&&t.sliceHelper.plane,hudVisibilityTexture:(i=(r=t.offscreenRenderingHelper)==null?void 0:r.hudVisibilityTexture)!=null?i:null,highlightDepthTexture:(s=(n=t.offscreenRenderingHelper)==null?void 0:n.depthTexture)!=null?s:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ss,ssrEnabled:!1,lighting:t.scenelightingData,transparencyPassType:t.transparencyPassType,terrainLinearDepthTexture:t.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:t.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:t.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:t.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:t.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:t.hasFillLights};t.rctx.bindVAO();const c=t.pass!==De.MATERIAL_HIGHLIGHT&&t.pass!==De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,h=t.pass!==De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;c&&this._renderComponents(t,o,l,this._defaultRenderInstanceData),h&&this._renderComponents(t,o,l,this._highlightRenderInstanceData)}intersect(t,i,r,s){if(!this.baseMaterial.isVisible())return;const n=M();de(n,s,r);const o=a=>{this._instanceData.getCombinedModelTransform(a,mte),t.transform.set(mte),Ue(gte,r,t.transform.inverse),Ue(yte,s,t.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a);ot(l&Ji.ACTIVE,"invalid instance state"),ot(c>=0&&c<this._levels.length,"invaid lod level"),this._levels[c].intersect(t,i,gte,yte,a,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(r,n,o)}queryDepthRange(t){return this._queryDepthRangeOctree(t)}notifyShaderTransformationChanged(){this._invalidateOctree()}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,t&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this._buildOctree()),this._octree}_invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}_buildOctree(){const t=new IJe(this._instanceData,this.baseBoundingSphere),i=this._instanceData,r=i.view?i.view.state:null;for(let s=0;s<this._instanceData.capacity;++s)r.get(s)&Ji.ACTIVE&&t.addInstance(s);return t}_queryDepthRangeOctree(t){const i=t.eye,r=t.viewForward,s=this.octree.findClosest(r,rc.FRONT_TO_BACK,t.frustum),n=this.octree.findClosest(r,rc.BACK_TO_FRONT,t.frustum);if(s!=null&&n!=null){this._instanceData.view.boundingSphere.getVec(s,hd),de(hd,hd,i);const o=_e(hd,r)-hd[3];this._instanceData.view.boundingSphere.getVec(n,hd),de(hd,hd,i);const a=_e(hd,r)+hd[3];return{near:Math.max(t.near,o),far:Math.min(t.far,a)}}return{near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this.needsUpdates&&this._context.requestRender()}_updateInstances(t,i){const r=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(t),this._defaultRenderInstanceData.forEach(h=>{h.beginUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.beginUpdate()});const n=this._instanceData,o=this._instanceData.view,a=n.size,l=n.capacity;let c=this._instanceIndex;i=Math.min(a,i);for(let h=0;h<i;++h){c===0&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&Ji.ALLOCATED)){c=(c+1)%l,i++;continue}const g=o.lodLevel.get(c);if(p&Ji.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[g].freeTail(),p&Ji.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[g].freeTail(),p&Ji.REMOVE)n.freeInstance(c);else if(p&Ji.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,fte),y=s.selectLevel(fte,n.getCombinedMedianScaleFactor(c))),f=p&~(Ji.ACTIVE|Ji.TRANSFORM_CHANGED),y>=0&&(p&Ji.HIGHLIGHT?(pte(this._highlightRenderInstanceData[y],o,c),f|=Ji.HIGHLIGHT_ACTIVE):(pte(this._defaultRenderInstanceData[y],o,c),f|=Ji.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(Ji.ACTIVE|Ji.TRANSFORM_CHANGED),o.state.set(c,f);if(this._octree){const y=!!(p&Ji.ACTIVE),v=!!(f&Ji.ACTIVE);!y&&v?this._octree.addInstance(c):y&&!v?this._octree.removeInstance(c):y&&v&&p&Ji.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%l}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>{h.endUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.endUpdate()})}_renderComponents(t,i,r,s){this.levels.forEach((n,o)=>{n.components.forEach(a=>{this._renderComponent(t,i,r,s[o],a,o)})})}_renderComponent(t,i,r,s,n,o){if(s.size===0||!n.material.requiresSlot(i))return;const{rctx:a,pass:l}=t,c=n.glMaterials.load(a,l);if(O(c))return;const h=c.beginSlot(r),p=a.useTechnique(h,i);c.bind(r,h),a.bindVAO(n.vao),h.ensureAttributeLocations(n.vao),t.isHighlightPass&&Pp(p,r),h.bindDraw(r),hi.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.pass===De.MATERIAL&&(p.setUniform4fv("externalColor",vte[Math.min(o,vte.length-1)]),p.setUniform1i("colorMixMode",V8.replace));const f=a.capabilities.instancing,g=s.capacity,y=s.headIndex,v=s.tailIndex,b=s.firstIndex,w=this._glInstanceBufferLayout,S=(T,A)=>{Nj(a,mi,s.buffer,w,T),f.drawArraysInstanced(h.primitiveType,0,n.vertexCount,A-T),Fj(a,mi,s.buffer,w)};n.material.parameters.transparent&&b!=null?y>v?(ot(b>=v&&b<=y,"invalid firstIndex"),S(b,y),S(v,b)):y<v&&(b<=y?(ot(b>=0&&b<=y,"invalid firstIndex"),S(b,y),S(v,g),S(0,b)):(ot(b>=v&&b<=g,"invalid firstIndex"),S(b,g),S(0,y),S(v,b))):y>v?S(v,y):y<v&&(S(0,y),S(v,g)),a.bindVAO(null)}}function pte(e,t,i){const r=e.allocateHead();VJe(t,i,e.view,r)}function VJe(e,t,i,r){j8e(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}const fte=M(),hd=ni(),mte=Te(),gte=M(),yte=M(),vte=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];class GJe extends $p{constructor(t,i,r,s){super(t,i,r,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled}getCachedSize(){const[t,i,r]=_(this._resources)?this._resources.symbolSize:[1,1,1];return{width:t,depth:i,height:r}}async doLoad(t){if(!this._drivenProperties.size&&cF(this.symbolLayer))throw new Error;const i=this.symbolLayer;if(this.isPrimitive){const r=i.resource?i.resource.primitive:nae;this._resources=await this._createResourcesForPrimitive(r,t)}else this._resources=await this._createResourcesForUrl(i.resource.href,t);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return _(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return bs(this._resources,"lodRenderer")}_setMaterialTransparencyParams(t,i=bs(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;return t.transparent=s,t.opacity=r,t.cullFace=s?$i.None:$i.Back,t}async _createResourcesForPrimitive(t,i){if(!Aqe(t))throw new Error(`Unknown object symbol primitive: ${t}`);const r=this.symbolLayer,s=os(USe(t)),n=aa(OO(s)),o=aa(S4(n,r)),a=Pe(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:Kd,diffuse:Kd,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:w,minWorldLength:S,maxWorldLength:T}=f.verticalOffset;h.verticalOffset={screenLength:ao(w),minWorldLength:S||0,maxWorldLength:T!=null?T:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=Zd;else{const w=_(r.material)&&r.material.color,S=_(w)?Qe.toUnitRGBA(w):Zd;h.externalColor=S}this._fastUpdates=tR(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,Tg)),this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));const g=new L1(h),y=yye(t,g);if(!y)throw new Error(`Unknown object symbol primitive: ${t}`);const v=WM(y).map(w=>({opacity:1,transparent:w.parameters.transparent})),b=await this._createStageResources(y,p);return{lodResources:y,lodRenderer:await this._createLodRenderer(y,i),stageResources:b,symbolSize:o,extentPadding:a,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:v,physicalBasedRenderingEnabled:p,resourceBoundingBox:s,resourceSize:n,dispose:Tg,pivotOffset:Tg}}async _createResourcesForUrl(t,i){const r=["transformation"],s={materialParamsMixin:{instanced:r,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=tR(this._context.renderer,this._fastVisualVariableConvertOptions(Tg,Tg,Tg,Tg)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:z,minWorldLength:V,maxWorldLength:B}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:ao(z),minWorldLength:V||0,maxWorldLength:B!=null?B:1/0},s.materialParamsMixin.castShadows=!1}s.signal=i,s.usePBR=this._context.physicalBasedRenderingEnabled;const o=s.usePBR,a=await Y0e(t,s),l=a.isEsriSymbolResource,c=a.isWosr,h=a.remove,p=OQe(a.lods);PQe(p),p.levels.sort((z,V)=>z.minScreenSpaceRadius-V.minScreenSpaceRadius),p.levels[0].minScreenSpaceRadius=Math.min(2,p.levels[0].minScreenSpaceRadius);const f=this._context,g=this.symbolLayer.material,y=this._getExternalColorParameters(g),v=bs(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(v,{hasIntrinsicColor:!0}),w=this.needsDrivenTransparentPass,S=WM(p),T=WM(p).map(z=>({opacity:z.parameters.opacity||1,transparent:z.parameters.transparent}));S.forEach(z=>{const V=z.parameters;z.setParameters(y);const B=V.opacity*b,J=B<1||w||V.transparent;z.setParameters({opacity:B,transparent:J}),f.screenSizePerspectiveEnabled&&z.setParameters({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})});const A=a.referenceBoundingBox,C=aa(OO(A)),R=aa(p.levels[0].pivotOffset),L=aa(S4(C,this.symbolLayer)),U=Pe(L);iR(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(A,L,C,R))&&S.forEach(z=>z.setParameters(this._fastUpdates.materialParameters));const N=await this._createStageResources(p,o);return{lodResources:p,lodRenderer:await this._createLodRenderer(p,i),stageResources:N,symbolSize:L,extentPadding:U,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:T,physicalBasedRenderingEnabled:o,resourceBoundingBox:A,resourceSize:C,dispose:h,pivotOffset:R}}async _createStageResources(t,i){const r=this._context.stage,s=WM(t);i!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s);const n=Nqe(t);r.addMany(n),await r.load(n);const o=Fqe(t);return r.addMany(o),{materials:s,textures:n,geometries:o}}async _createLodRenderer(t,i){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,dP),Lr(c,Q8(this._fastUpdates.materialParameters,dP,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,dP),KYe(a,this._fastUpdates.materialParameters,dP))}:null,o=new BJe(t,this._optionalFields,s,n);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,await r.addRenderPlugin(o.slots,o,i),o}_getExternalColorParameters(t){const i={};return this._drivenProperties.color?i.externalColor=Zd:_(t)&&_(t.color)?i.externalColor=Qe.toUnitRGBA(t.color):(i.externalColor=Zd,i.colorMixMode="ignore"),i}destroy(){if(super.destroy(),_(this._resources)){const t=this._context.stage;t.removeRenderPlugin(this._resources.lodRenderer);const i=this._resources.stageResources;t.removeMany(i.materials),t.removeMany(i.textures),t.removeMany(i.geometries),_(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;const r=QC(i.geometry);if(O(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const s=this.setGraphicElevationContext(i,new xc),n=t.renderingInfo;return this._createAs3DShape(i,r,n,s,i.uid)}notifyDestroyGraphicLayer(t){this._instanceIndexToGraphicUid.delete(t.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(O(this._resources))return!0;const t=this._drivenProperties.opacity,i=!this.isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<r.length;n++){const o=r[n],a=bs(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:i})*l.opacity,h=c<1||t||l.transparent;o.setParameters({opacity:c,transparent:h}),this.isPrimitive&&o.setParameters({cullFace:h?$i.None:$i.Back})}return!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,_0)}slicePlaneEnabledChanged(){if(O(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const t of this._resources.stageResources.materials)t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(O(this._resources))return!0;const{stageResources:t,isWosr:i}=this._resources;for(const r of t.materials)this.isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):i||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this.hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(t,i){if(O(this._resources))return xs.Recreate_Symbol;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in t.diff){if(c!=="visualVariables"||!iR(this._fastUpdates,i,this._fastVisualVariableConvertOptions(n,o,a,l)))return xs.Recreate_Symbol;for(const h of r)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return xs.Fast_Update}computeComplexity(){return O(this._resources)?super.computeComplexity():{primitivesPerFeature:jH(this._resources.lodResources.levels[0]).reduce((t,i)=>t+i.indices.get(E.POSITION).length,0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:bye(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return _(this._resources)}_createAs3DShape(t,i,r,s,n){if(!this._hasLodRenderer()||O(this._resources))return null;const o=this.getFastUpdateAttrValues(t),a=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?$A(r.color,r.opacity):null,l=this._context.clippingExtent;if(Qs(i,Nb,this._context.elevationProvider.spatialReference),_(l)&&!RG(l,Nb))return null;const c=this._requiresTerrainElevation(s),h=this._computeGlobalTransform(i,s,KU,pP),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,_te),f=this._resources.lodRenderer.instanceData,g=f.addInstance();this._instanceIndexToGraphicUid.set(g,n),f.setLocalTransform(g,p,!1),f.setGlobalTransform(g,h),o&&f.setFeatureAttribute(g,o),a&&f.setColor(g,a);const y=new AQe(this,g,vqe,s);return c&&(y.alignedSampledElevation=pP.sampledElevation),y.needsElevationUpdates=_0(s.mode),ZC(y,i,this._context.elevationProvider),y}_computeGlobalTransform(t,i,r,s){return bm(t,this._context.elevationProvider,i,this._context.renderCoordsHelper,s),Nb[0]=t.x,Nb[1]=t.y,Nb[2]=s.z,Gh(t.spatialReference,Nb,r,this._context.renderCoordsHelper.spatialReference),r}_computeLocalTransform(t,i,r,s){return pp(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(i,!0,s),this._applyObjectScale(t,r,s),this._applyAnchor(t,i,s),s}_applyObjectScale(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&i.size?i.size:t.symbolSize,n=tee(s,t.symbolSize,t.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||eN(r,r,n)}prepareSymbolLayerPatch(t){if(t.diff.type!=="partial")return;const i=t.diff.diff;this._preparePatchTransform(t,i),this._preparePatchColor(t,i)}updateGeometry(t,i){if(O(this._resources))return!0;const r=i&&QC(i);if(O(r))return!1;const s=this.getGeometryElevationMode(i);return t.elevationContext.mode===s&&(this._computeGlobalTransform(r,t.elevationContext,KU,pP),this._requiresTerrainElevation(t.elevationContext)&&(t.alignedSampledElevation=pP.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,KU,!0),ZC(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(t,i){if(!(i.heading||i.tilt||i.roll||i.width||i.height||i.depth||i.anchor||i.anchorPosition)||O(this._resources))return;const r=(y,v,b)=>gt(y!=null&&y.type==="complete"?y.newValue:v,b),s=r(i.heading,this.symbolLayer.heading,0),n=r(i.tilt,this.symbolLayer.tilt,0),o=r(i.roll,this.symbolLayer.roll,0),a=r(i.width,this.symbolLayer.width,void 0),l=r(i.height,this.symbolLayer.height,void 0),c=r(i.depth,this.symbolLayer.depth,void 0),h=r(i.anchor,this.symbolLayer.anchor,void 0),p=r(i.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete i.heading,delete i.tilt,delete i.roll,delete i.width,delete i.height,delete i.depth,delete i.anchor,delete i.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},g=this._resources;this.loadStatus===Xl.LOADED&&t.symbolLayerStatePatches.push(()=>{g.symbolSize=aa(S4(g.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),t.graphics3DGraphicPatches.push((y,v)=>{const b=this._computeLocalTransform(g,f,v,_te),w=y.instanceIndex;g.lodRenderer.instanceData.setLocalTransform(w,b,!0)})}_preparePatchColor(t,i){if(!i.material||i.material.type!=="partial")return;const r=i.material.diff;if(!r.color||r.color.type!=="complete"||r.color.newValue==null||r.color.oldValue==null)return;const s=r.color.newValue,n=_(s)?Qe.toUnitRGBA(s):Zd;delete r.color;const o=this._resources;O(o)||t.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(t){return t.mode!=="absolute-height"}_applyObjectRotation(t,i,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&i))return aqe(t.heading,t.tilt,t.roll,r)}_computeAnchor(t,i,r){const s=M();switch(r.anchor){case"center":ne(s,Eh(t)),lo(s,s);break;case"top":{const n=Eh(t);oe(s,-n[0],-n[1],-t[5]);break}case"bottom":{const n=Eh(t);oe(s,-n[0],-n[1],-t[2]);break}case"relative":{const n=Eh(t),o=OO(t),a=r.anchorPosition,l=a?je(a.x,a.y,a.z):cl;W9(s,o,l),pe(s,s,n),lo(s,s);break}default:_(i)?lo(s,i):ne(s,cl)}return s}_applyAnchor(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(t.resourceBoundingBox,t.pivotOffset,i);s&&Vo(r,r,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(t,i,r,s){const n=_(t)?aa(OO(t)):Kd,o=_(t)?this._computeAnchor(t,s,this.symbolLayer):cl,a=this._context.renderCoordsHelper.unitInMeters,l=tee(_(i)?i:void 0,i,r,a),c=je(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:_(i)?i:Kd,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}}const Nb=M(),_te=Te(),KU=Te(),dP=ni(),pP=new sO;function jJe(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function HJe(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function uq(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function qJe(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function WJe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*n-s*r;return o?(o=1/o,e[0]=n*o,e[1]=-r*o,e[2]=-s*o,e[3]=i*o,e):null}function XJe(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e}function YJe(e){return e[0]*e[3]-e[2]*e[1]}function Q0e(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*a+n*l,e[1]=s*a+o*l,e[2]=r*c+n*h,e[3]=s*c+o*h,e}function ZJe(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*a,e[1]=s*l+o*a,e[2]=r*-a+n*l,e[3]=s*-a+o*l,e}function QJe(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1];return e[0]=r*a,e[1]=s*a,e[2]=n*l,e[3]=o*l,e}function JJe(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e}function KJe(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function eKe(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function tKe(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function iKe(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]}function rKe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function J0e(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function sKe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function nKe(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=wt*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=wt*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=wt*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=wt*Math.max(1,Math.abs(n),Math.abs(c))}function oKe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function aKe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}const lKe=Q0e,cKe=J0e;Object.freeze({__proto__:null,copy:jJe,identity:HJe,set:uq,transpose:qJe,invert:WJe,adjoint:XJe,determinant:YJe,multiply:Q0e,rotate:ZJe,scale:QJe,fromRotation:JJe,fromScaling:KJe,str:eKe,frob:tKe,LDU:iKe,add:rKe,subtract:J0e,exactEquals:sKe,equals:nKe,multiplyScalar:oKe,multiplyScalarAndAdd:aKe,mul:lKe,sub:cKe});class uKe extends or{constructor(t,i,r,s,n,o){super(t,i),this.path=r,this.geometrySR=s,this.upVectorAlignment=n,this.stencilWidth=o}}function K0e(e){return"upVectorAlignment"in e}function eve(){return[1,0,0,1]}function hKe(e){return[e[0],e[1],e[2],e[3]]}function dKe(e,t,i,r){return[e,t,i,r]}function pKe(e,t){return new Float64Array(e,t,4)}Object.freeze({__proto__:null,create:eve,clone:hKe,fromValues:dKe,createView:pKe});function r9(){return{up:M(),right:M()}}function fKe(e,t,i){Ue(e.up,t.up,i),Ue(e.right,t.right,i)}function mKe(e,t,i){tr(e,_e(i,t.right),_e(i,t.up))}class gKe{constructor(){this.pos=M(),this.posES=M(),this.posGS=M(),this.vRight=M(),this.vLeft=M(),this.frame=r9(),this.rotationFrame=r9(),this.rotationRight=Xe(),this.rotationAngle=0,this.miterStretch=eve()}setFrameFromUpVector(t){ne(this.frame.up,t),pe(Wc,this.vLeft,this.vRight),be(Wc,Wc),ae(hh,this.frame.up,_e(Wc,this.frame.up)),de(mP,Wc,hh),be(mP,mP),dt(this.frame.right,mP,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){ne(this.rotationFrame.up,this.frame.up),ne(this.rotationFrame.right,this.frame.right),tr(this.rotationRight,1,0),ae(hh,this.frame.up,_e(this.frame.up,this.vLeft)),de(hh,this.vLeft,hh),lo(hh,hh),be(hh,hh),ae(Wc,this.frame.up,_e(this.frame.up,this.vRight)),de(Wc,this.vRight,Wc),be(Wc,Wc),dt(s9,this.rotationFrame.up,this.vLeft);const t=Math.sign(_e(s9,this.vRight));if(this.rotationAngle=t*(Math.PI-Es(_e(hh,Wc))),Math.abs(this.rotationAngle)>0){const r=pz(Math.cos(.5*this.rotationAngle));uq(this.miterStretch,r-1+1,0,0,1)}const i=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*i))}}class sR{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(t,i){return this.vertices.push(dE(t)),this.vertexNormals.push(dE(i)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,i=null){return this.poles.push({position:dE(t),normal:i?dE(i):null}),this.poles.length-1}addSegment(t,i=null,r=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),i&&(this.uvIndices.push(i.v0),this.uvIndices.push(i.v1)),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return this.uvs!=null}translate(t,i){for(const r of this.vertices)r[0]+=t,r[1]+=i;for(const r of this.poles)r.position[0]+=t,r.position[1]+=i}static circle(t=20){const r=new sR,s={v0:0,v1:0};r.addPole(vi(0,0));for(let a=0;a<t;++a){const l=2*a*Math.PI/t,c=Math.cos(l),h=Math.sin(l),p=vi(c*.5,h*.5),f=vi(c,h);r.addVertex(p,f),r.addUV(a/t)}r.addUV(1);for(let a=0;a<t-1;++a){const l={v0:a,v1:a+1},c=l;r.addSegment(l,c,s)}const n={v0:t-1,v1:0},o={v0:t-1,v1:t};return r.addSegment(n,o,s),r}static rect(){const r=new sR,s=vi(.5*-1,.5*-1),n=vi(.5*1,.5*-1),o=vi(.5*1,.5*1),a=vi(.5*-1,.5*1),l=vi(0,-1),c=vi(1,0),h=vi(0,1),p=vi(-1,0);r.addUV(0),r.addUV(1),r.addPole(vi(0,.5*1),h),r.addPole(vi(0,.5*1)),r.addPole(vi(0,.5*-1)),r.addPole(vi(0,.5*-1),l);const f={v0:0,v1:1};return r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:0,v1:1},f,{v0:3,v1:3}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:2,v1:3},f,{v0:2,v1:1}),r.addVertex(o,h),r.addVertex(a,h),r.addSegment({v0:4,v1:5},f,{v0:0,v1:0}),r.addVertex(a,p),r.addVertex(s,p),r.addSegment({v0:6,v1:7},f,{v0:1,v1:2}),r}}class yKe{constructor(t){this.vertices=[],this.offset=M(),this.xform=Te(),this.vertices=t;const i=Math.floor((t.length-1)/2);ne(this.offset,this.vertices[i].pos);for(const r of this.vertices)de(r.pos,r.pos,this.offset);Vo(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const t=this.vertices.length;let i=this.vertices[0];i.index=0,oe(i.vLeft,0,0,0),i.vLeftLength=0,de(i.vRight,this.vertices[1].pos,i.pos),i.vRightLength=Pe(i.vRight),be(i.vRight,i.vRight);let r=i;for(let s=1;s<t;++s)i=this.vertices[s],i.index=s,ne(i.vLeft,r.vRight),i.vLeftLength=r.vRightLength,s<t-1?(de(i.vRight,this.vertices[s+1].pos,i.pos),i.vRightLength=Pe(i.vRight),be(i.vRight,i.vRight)):(ne(i.vRight,i.vLeft),i.vRightLength=i.vLeftLength),r=i}}function vKe(e,t){let i=null;const r=e.vertices.length,s=.99619469809,n=M(),o=M(),a=M(),l=M(),c=M(),h=M(),p=ii();let f=e.vertices[0];ne(o,t),oe(n,0,1,0),Wa.makeOrthoBasisDirUpFallback(f.vRight,o,n,n,a,o,s),ne(f.frame.up,o),ne(f.frame.right,a),i=f;for(let g=1;g<r;++g){f=e.vertices[g],pe(c,f.vLeft,f.vRight);let y=Pe(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),pe(h,i.pos,i.frame.up),mT(f.pos,c,p),X1(p,fc(h,f.vLeft),l)?(de(l,l,f.pos),be(o,l),dt(a,c,o),be(a,a)):Wa.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,n,a,o,s),ne(f.frame.up,o),ne(f.frame.right,a),i=f}}class _Ke{numProfilesPerJoin(){return 1}extrude(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],!1)}}class ek{constructor(t=.8*Math.PI,i=1){this.cutoffAngle=t,this.numBendSubdivisions=i}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,i,r){const s=AKe;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){yl(xte,.5*-t.rotationAngle+n*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),fKe(s,t.frame,xte);for(let o=0;o<i.vertices.length;++o)ps(i.vertices[o],t.rotationRight)*t.rotationAngle>=0?r(t.index,s,i.vertices[o],i.vertexNormals[o],!1):(w8(F_,i.vertices[o],t.miterStretch),r(t.index,t.frame,F_,i.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<i.vertices.length;++o){const a=ps(i.vertices[o],t.rotationRight)*t.rotationAngle>=0;w8(F_,i.vertices[o],t.miterStretch),r(t.index,t.frame,F_,i.vertexNormals[o],!a)}}}const bKe={generateUV:!1};class hq{rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],0,0)}}class bte extends hq{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class fP extends hq{constructor(t,i=0,r=!1){super(),this.profile=t,this.profilePlaneOffset=i,this.flip=r}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(t,i){const r=dq;tr(r,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)i(t.index,t.frame,this.profile.vertices[n],r,this.profilePlaneOffset,s)}buildTopology(t,i){const r=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?i(l,a,r):i(r,a,l)}}}class wte extends hq{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let i=0;i<this.profile.numSegments;++i){const r=this.profile.vertexIndices[2*i+0],s=this.profile.vertexIndices[2*i+1];this.profile.poleIndices[r]===this.profile.poleIndices[s]?t+=1:t+=2}return 3*t}rebuildCapGeometry(t,i){const r=t.frame,s=.5*this.sign,n=F_,o=dq;tr(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?i(t.index,r,l.position,l.normal,s,0):i(t.index,r,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)i(t.index,r,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];Qd(n,this.profile.vertices[p],f.position),tl(n,n,c),f.normal?(_h(n,n,f.position),i(t.index,r,n,f.normal,s*h,0)):(TC(o,n),tl(o,o,c),_h(n,n,f.position),i(t.index,r,n,o,s*h,this.sign*h))}}}buildTopology(t,i){const r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=r+o,p=r+a;for(let f=0;f<this.numSegments-1;++f){const g=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(i(g,p,h),i(p,g,y)):(i(h,p,g),i(y,g,p)),h=g,p=y}this.flip?(i(l,p,h),l!==c&&i(l,c,p)):(i(h,p,l),l!==c&&i(p,c,l))}}}class wKe{constructor(t,i,r,s,n,o=bKe){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=i,this.path=t,this.extruder=r,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*a+2,this.numVerticesTotal=i.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(t,i,r,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,n){const o=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(t,i,r,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}emitTriangle(t,i,r){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=i,this.vertexIndices[3*this._triangleCount+2]=r,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[i],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[r],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=i,this.normalIndices[3*this._triangleCount+2]=r,++this._triangleCount}_rebuildGeometry(){const t=(r,s,n,o,a)=>this.emitVertex(r,s,n,o,a),i=(r,s,n,o,a,l)=>this.emitCapVertex(r,s,n,o,a,l);this._extrusionVertexCount=0;for(const r of this.path.vertices)this.originData[3*r.index+0]=r.pos[0],this.originData[3*r.index+1]=r.pos[1],this.originData[3*r.index+2]=r.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,i);for(let r=1;r<this.path.vertices.length-1;++r)this.extruder.extrude(this.path.vertices[r],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,i),this.startCap.rebuildCapGeometry(this.path.vertices[0],i),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],i),this.profile.hasUV()&&this.options.generateUV)for(let r=0;r<this.profile.uvs.length;++r)this.uvData[2*r+0]=this.profile.uvs[r],this.uvData[2*r+1]=0}buildTopology(){const t=(o,a,l)=>this.emitTriangle(o,a,l);this._triangleCount=0;const i=this.profile.vertices.length,r=this.profile.numSegments,s=this.numExtrusionProfiles-1;let n=3*(2*(r*s));this.startCap.indexBufferStart=n,this.startCap.firstProfileVertexIndex=0,n+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=n,this.endCap.firstProfileVertexIndex=i*(this.numExtrusionProfiles-1),n+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(n),this.normalIndices=new Uint32Array(n),this.pathVertexIndices=new Uint32Array(n),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(n));for(let o=0;o<r;++o){const a=this.profile.vertexIndices[2*o],l=this.profile.vertexIndices[2*o+1];for(let c=0;c<s;++c){const h=c*i+a,p=(c+1)*i+l,f=c*i+l;t(h,(c+1)*i+a,p),t(h,p,f)}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t)}onPathChanged(){this._rebuildGeometry()}}class tve{constructor(t){this.builder=t}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class ive extends tve{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)}bake(t){this.size=t;for(let i=0;i<this.builder.numVerticesTotal;++i){let r=this.builder.pathVertexData[i];const s=r===0||r===this.builder.path.vertices.length-1;r*=3;const n=TKe;oe(n,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);const o=4*i,a=hh,l=F_,c=Wc,h=s9,p=EKe;let f=0,g=0;if(oe(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),oe(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),tr(l,this.builder.profileVertexAndNormalData[o]*t[0],this.builder.profileVertexAndNormalData[o+1]*t[1]),s)dt(c,p,h),f=this.builder.profileRightAxisData[o+3]*t[0],g=this.builder.profileUpAxisData[o+3];else{const v=dq,b=SKe;tr(v,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const w=Ij(v);TC(v,v);const S=ps(l,v);if(Math.abs(S)>w){tr(b,-v[1],v[0]);const T=ps(l,b);tl(v,v,w*Math.sign(S)),tl(b,b,T),_h(l,v,b)}oe(c,0,0,0)}oe(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*i+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*i+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*i+2]=n[2]+a[2]+c[2]*f;const y=F_;tr(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*i+0]=h[0]*y[0]+p[0]*y[1]+c[0]*g,this.vertexAttributeNormal[3*i+1]=h[1]*y[0]+p[1]*y[1]+c[1]*g,this.vertexAttributeNormal[3*i+2]=h[2]*y[0]+p[2]*y[1]+c[2]*g}}createGeometryData(){const t=[[E.POSITION,this.builder.vertexIndices],[E.NORMAL,this.builder.normalIndices]],i=[[E.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[E.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const r=this.builder.vertexIndices.length;t.push([E.COLOR,new Uint32Array(r)]),i.push([E.COLOR,{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:i,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(t,i,r){const s=this.builder.vertexIndices,n={size:3,data:this.vertexAttributePosition},o=s.length/3;QR(t,i,0,o,s,n,void 0,void 0,r)}}class xKe extends tve{constructor(t,i,r,s){super(t),this.sizeAttributeValue=i,this.colorAttributeValue=r,this.opacityAttributeValue=s,this.vvData=null,this.baked=new ive(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=i,this.vvData[4*n+1]=r,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[[E.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[E.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[E.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[E.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[E.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[E.POSITION,this.builder.pathVertexIndices],[E.PROFILERIGHT,this.builder.vertexIndices],[E.PROFILEUP,this.builder.vertexIndices],[E.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[E.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const TKe=M(),F_=Xe(),dq=Xe(),SKe=Xe(),hh=M(),Wc=M(),s9=M(),EKe=M(),mP=M(),AKe=r9(),xte=Te();function CKe(e,t){e.attributes.add(E.FEATUREVALUE,"vec4"),e.vertex.code.add(x`bool isCapVertex() {
return featureValue.w == 1.0;
}`),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(x`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):e.vertex.code.add(x`vec2 getSize(){
return size.xy;
}`),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):e.vertex.code.add(x`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):e.vertex.code.add(x`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(SF),e.attributes.add(E.PROFILERIGHT,"vec4"),e.attributes.add(E.PROFILEUP,"vec4"),e.attributes.add(E.PROFILEVERTEXANDNORMAL,"vec4"),e.vertex.code.add(x`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),e.vertex.code.add(x`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),e.vertex.code.add(x`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),e.vertex.code.add(x`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function RKe(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function OKe(e){const t=new Ri;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(CKe,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(Un,{linearDepth:!1}),e.receiveShadows&&t.include(wm,e),t.include(aO,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${e.output===j.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),e.output===j.Alpha&&(t.include(Rr,e),t.fragment.uniforms.add("cameraPosition","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),e.output===j.Color&&(t.include(Rr,e),t.include(D1,e),t.include(AF,e),e.receiveShadows&&t.include(wm,e),t.include(l0e,e),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(Rp),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===$e.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==j.Depth&&e.output!==j.Shadow||(t.include(Un,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(x`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(Rr,e),t.include(M0,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),e.output===j.Normal&&(t.include(Un,{linearDepth:!1}),t.include(ky,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Rr,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),e.output===j.Highlight&&(t.include(Un,{linearDepth:!1}),t.include(ky,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Rr,e),t.include(Fm),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const MKe=Object.freeze({__proto__:null,build:OKe}),rve=new Map([[E.POSITION,0],[E.PROFILERIGHT,1],[E.PROFILEUP,2],[E.PROFILEVERTEXANDNORMAL,3],[E.FEATUREVALUE,4]]);class NF extends Vi{initializeProgram(t){const i=NF.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===at.Color,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,pbrMode:xt.Disabled,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:r.receiveSSAO,doubleSidedMode:r.doubleSidedMode,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,rve)}bindPass(t,i){var r,s;xl(this.program,i.camera.projectionMatrix),this.program.setUniform3fv("size",t.size),i.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i)),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||this.program.setUniform1f("opacity",t.opacity),this.configuration.output===j.Color?(i.lighting.setUniforms(this.program,!1,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform3fv("specular",t.specular),this.program.setUniform1f("opacity",t.opacity)):this.configuration.output!==j.Depth&&this.configuration.output!==j.Shadow||this.program.setUniform2fv("nearFar",i.camera.nearFar),RKe(this.program,t),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(t){Op(this.program,t),rb(this.program,this.configuration,t),this.program.rebindTextures(),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Color&&OWe(this.program,t),this.configuration.output===j.Normal&&dYe(this.program,t.camera.viewInverseTransposeMatrix)}_setPipelineState(t){const i=this.configuration,r=t===at.NONE,s=t===at.FrontFace,n=o=>!o.slicePlaneEnabled&&!(o.transparent||o.doubleSidedMode===cr.None);return Rt({blending:i.output!==j.Color&&i.output!==j.Alpha||!i.transparent?null:r?dl:km(t),culling:n(i)&&pfe,depthTest:{func:O0(t)},depthWrite:r||s?Aa:null,colorWrite:Ft,stencilWrite:i.sceneHasOcludees?vp:null,stencilTest:i.sceneHasOcludees?P0:null,polygonOffset:r||s?null:aF})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}NF.shader=new Li(MKe,()=>import("./Path.glsl.d9600481.js"));class Ba extends dr{constructor(){super(...arguments),this.output=j.Color,this.doubleSidedMode=cr.None,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],Ba.prototype,"output",void 0),u([Y({count:cr.COUNT})],Ba.prototype,"doubleSidedMode",void 0),u([Y()],Ba.prototype,"receiveShadows",void 0),u([Y()],Ba.prototype,"receiveSSAO",void 0),u([Y()],Ba.prototype,"vvSize",void 0),u([Y()],Ba.prototype,"vvColor",void 0),u([Y()],Ba.prototype,"vvOpacity",void 0),u([Y()],Ba.prototype,"slicePlaneEnabled",void 0),u([Y()],Ba.prototype,"transparent",void 0),u([Y()],Ba.prototype,"sceneHasOcludees",void 0),u([Y({count:at.COUNT})],Ba.prototype,"transparencyPassType",void 0),u([Y()],Ba.prototype,"multipassTerrainEnabled",void 0),u([Y()],Ba.prototype,"cullAboveGround",void 0);class pq extends Zh{constructor(t){super(t,IKe),this.supportsEdges=!0,this._vertexAttributeLocations=rve,this.techniqueConfig=new Ba,this.vertexBufferLayout=pq.getVertexBufferLayout(this.parameters)}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,t!==j.Color&&t!==j.Alpha||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?cr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?cr.WindingOrder:cr.None,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!i.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(t){return t!==De.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;return!!super.isVisible()&&t.opacity>0}intersect(t,i,r,s,n,o,a){const l=t;if(!K0e(l))return;const c=l.path,h=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const w=this.parameters.vvSizeOffset,S=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,A=this.parameters.vvSizeMaxSize,C=c.sizeAttributeValue;h[0]*=ze(w[0]+C*S[0],T[0],A[0]),h[1]*=ze(w[2]+C*S[2],T[2],A[2])}const p=Math.max(h[0],h[1]),f=t.boundingInfo;if(O(f))return void this._intersectTriangles(c,h,n,o,a);const g=c1(f.bbMin[0]-p,f.bbMin[1]-p,f.bbMin[2]-p,f.bbMax[0]+p,f.bbMax[1]+p,f.bbMax[2]+p),y=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],v=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]),b=[v/y[0],v/y[1],v/y[2]];CH(g,n,b,s.tolerance)&&this._intersectTriangles(c,h,n,o,a)}_intersectTriangles(t,i,r,s,n){t.baked.size&&t.baked.size[0]===i[0]&&t.baked.size[1]===i[1]||t.baked.bake(i),t.baked.intersect(r,s,n)}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=r.get(E.POSITION);return eH(s,null,!1,i)}createBufferWriter(){return new $Ke(this.vertexBufferLayout)}requiresSlot(t){return t===(this.parameters.transparent?ye.TRANSPARENT_MATERIAL:ye.OPAQUE_MATERIAL)||t===ye.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Depth||t.output===j.Normal||t.output===j.Highlight||t.output===j.Shadow&&this.parameters.castShadows?new PKe(t):null}static getVertexBufferLayout(t){let i=Nr().vec3f(E.POSITION).vec4f(E.PROFILERIGHT).vec4f(E.PROFILEUP).vec4f(E.PROFILEVERTEXANDNORMAL);return(t.vvColorEnabled||t.vvSizeEnabled||t.vvOpacityEnabled)&&(i=i.vec4f(E.FEATUREVALUE)),i}}class PKe extends Nm{updateParameters(t){return this.ensureTechnique(NF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}_updateShadowState(t){(O(this.technique)||t.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:t.shadowMappingEnabled})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const IKe=I(I({size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1},JH),Du);class $Ke{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){const n=o=>{if(i.vertexAttributes.has(o)){const a=i.vertexAttributes.get(o),l=i.indices.get(o);ot(a.size===4);const c=r.getField(o,Js);if(!c)throw new Error("unable to acquire view for "+o);BT(l,a.data,c,s)}};n(E.PROFILERIGHT),n(E.PROFILEUP),n(E.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(E.FEATUREVALUE)&&n(E.FEATUREVALUE),sF(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}const DKe=["polyline"];class LKe extends $p{constructor(t,i,r,s){super(t,i,r,s),this._intrinsicSize=vi(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const t=_(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,i=_(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=tR(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path",this.symbolLayer.profileRotation==="heading"&&(this.upVectorAlignment="world");const s=this.symbolLayer.profile||"circle";switch(s){case"circle":default:this._profile=sR.circle(zKe);break;case"quad":this._profile=sR.rect()}let n=[0,0];switch(r!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new ek(0,kKe);break;case"bevel":this._extruder=new ek(0,1);break;case"miter":this._extruder=new ek(.8*Math.PI,1);break;default:this._extruder=new _Ke}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new bte,this._endCap=new bte;break;case"butt":default:this._startCap=new fP(this._profile,0),this._endCap=new fP(this._profile,0,!0);break;case"square":this._startCap=new fP(this._profile,-.5),this._endCap=new fP(this._profile,.5,!0);break;case"round":{const g=s==="quad";this._startCap=new wte({profile:this._profile,flip:!1,breakNormals:g,subdivisions:Ete}),this._endCap=new wte({profile:this._profile,flip:!0,breakNormals:g,subdivisions:Ete});break}}const a=bs(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=aa(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?$i.None:$i.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(tr(this._intrinsicSize,t,i),!YD(this._intrinsicSize[0])||!YD(this._intrinsicSize[1])))throw new Q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||tl(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new pq(f)):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new L1(f)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,DKe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new xc),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(){const t=bs(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:i,transparent:r}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,_0)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!iR(this._fastUpdates,i,this._vvConvertOptions))return xs.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return xs.Fast_Update}getVertexData(t){let i=0;const r=t.paths,s=[],n=t.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const g of r)i+=g.length;const l=new Float64Array(3*i),c=new Float64Array(3*i),h=new Float64Array(3*i);let p=0;for(const g of r){s.push({index:p,numVertices:g.length});for(const y of g)l[p++]=y[0],l[p++]=y[1],l[p++]=t.hasZ?y[2]:0}let f=!0;return n.equals(o)?this._copyVertices(l,0,c,0,i):f=_r(l,n,0,c,o,0,i),o.equals(a)?this._copyVertices(c,0,h,0,i):_r(c,o,0,h,a,0,i),{pathVertexDataInfos:s,vertexDataGS:l,vertexDataES:c,vertexDataRS:h,projectionSuccess:f,terrainElevation:0}}_copyVertices(t,i,r,s,n){i*=3,s*=3;for(let o=0;o<n;++o)r[s++]=t[i++],r[s++]=t[i++],r[s++]=t[i++]}_createAs3DShape(t,i,r,s){const n=t.geometry,o=new Array,a=new Array,l=new Array,c=n.spatialReference,h=os(),p=this._context.renderCoordsHelper;nve.spatialReference=c;const f=this.getVertexData(n);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let g=0;g<f.pathVertexDataInfos.length;++g){const y=f.pathVertexDataInfos[g],v=y.index,b=y.numVertices;if(b<2||_(this._context.clippingExtent)&&(Ui(h),ic(h,f.vertexDataES,3*v,b),!Ah(h,this._context.clippingExtent)))continue;const w=[];for(let U=v;U<v+3*b;){const N=U++,z=U++,V=U++,B=new gKe;oe(B.posGS,f.vertexDataGS[N],f.vertexDataGS[z],f.vertexDataGS[V]),oe(B.posES,f.vertexDataES[N],f.vertexDataES[z],f.vertexDataES[V]);const J=lqe(B.posES,this._context.elevationProvider,r,p);oe(mu,f.vertexDataRS[N],f.vertexDataRS[z],f.vertexDataRS[V]),p.setAltitude(mu,J),oe(B.pos,mu[0],mu[1],mu[2]),w.push(B)}const S=new yKe(w);sve(S,this.upVectorAlignment,this._context.renderCoordsHelper);const T=new wKe(S,this._profile,this._extruder,this._startCap,this._endCap);let A=null;if(this._fastUpdates.enabled){const U=this._fastUpdates.visualVariables,N=U.size?sm(U.size.field,t):0,z=U.color?sm(U.color.field,t):0,V=U.opacity?sm(U.opacity.field,t):0;A=new xKe(T,N,z,V)}else{const U=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(U[0]*=Tte(i.size[0],i.size[2]==="symbol-value"?this.symbolLayer.height||0:i.size[2],this.symbolLayer.width||0),U[1]*=Tte(i.size[2],i.size[0]==="symbol-value"?this.symbolLayer.width||0:i.size[0],this.symbolLayer.height||0));let N=null;this._drivenProperties.color&&(N=i.color),this._drivenProperties.opacity&&i.opacity!=null&&(N=N?[N[0],N[1],N[2],i.opacity]:[1,1,1,i.opacity]);const z=new ive(T);z.bake(U),N&&z.bakeVertexColors(N),A=z}const{vertexAttributes:C,indices:R}=A.createGeometryData(),L=new uKe(C,R,A,c,this.upVectorAlignment,this.stencilWidth);o.push(L),a.push(this._material),l.push(A.xform)}if(o.length>0){const g={layerUid:this._context.layer.uid,graphicUid:s},y=new Bm({geometries:o,materials:a,transformations:l,metadata:g}),v=new Ip(this,y,o,null,null,FKe,r);return v.alignedSampledElevation=f.terrainElevation,v.needsElevationUpdates=_0(r.mode),v}}else n.paths.length!==0&&n.paths.some(g=>g.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function sve(e,t,i){switch(t){case"world":for(const r of e.vertices)pe(dd,r.pos,e.offset),i.worldUpAtPosition(dd,mu),r.setFrameFromUpVector(mu),r.computeRotationAxisAndAngleFromUpVector();break;case"path":pe(dd,e.vertices[0].pos,e.offset),i.worldUpAtPosition(dd,mu),vKe(e,mu);for(const r of e.vertices){const s=Math.sign(_e(r.frame.right,r.vRight));dt(r.rotationFrame.up,r.vRight,r.vLeft),ae(r.rotationFrame.up,r.rotationFrame.up,s),be(r.rotationFrame.up,r.rotationFrame.up);const n=_e(r.rotationFrame.up,r.frame.up),o=_e(r.rotationFrame.up,r.frame.right);if(ae(dd,r.frame.up,-o),ae(Ste,r.frame.right,n),pe(dd,dd,Ste),be(r.rotationFrame.right,dd),mKe(r.rotationRight,r.frame,r.rotationFrame.right),lo(dd,r.vLeft),r.rotationAngle=-s*(Math.PI-Es(_e(dd,r.vRight))),Math.abs(r.rotationAngle)>0){const l=pz(Math.cos(.5*r.rotationAngle));uq(r.miterStretch,1+(l-1)*r.rotationRight[0]*r.rotationRight[0],(l-1)*r.rotationRight[0]*r.rotationRight[1],(l-1)*r.rotationRight[0]*r.rotationRight[1],1+(l-1)*r.rotationRight[1]*r.rotationRight[1])}const a=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(Math.min(r.vLeftLength,r.vRightLength)*pz(Math.cos(.5*a)))}}}function Tte(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function NKe(e,t,i,r){let s=0;for(const n of e.vertices)bm(n.posES,i,t,r,tk),s+=tk.sampledElevation,pe(mu,n.pos,e.offset),r.setAltitude(mu,tk.z),de(n.pos,mu,e.offset);return e.updatePathVertexInformation(),s/e.vertices.length}function FKe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;UKe.spatialReference=r.spatialReference;for(const a of n){const l=a.geometry;if(!K0e(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;nve.spatialReference=p,o+=NKe(h,t,i,r),l.upVectorAlignment!=="world"&&sve(h,l.upVectorAlignment,r),c.onPathChanged(),l.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(a)}return o/n.length}const UKe=zm(0,0,0,null),nve=zm(0,0,0,null),mu=M(),dd=fi(),Ste=fi(),tk=new sO,kKe=3,Ete=3,zKe=10;function BKe(e,t,i,r,s=1){if(i.isGeographic&&r===$e.Global){const a=new Float64Array(t.typedBuffer.length),l=3*t.count,c=di(i);for(let h=0;h<l;h+=3)t7(t.typedBuffer,h,a,h,c);t=jr.fromTypedArray(a)}tr(ms,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let a=0;a<t.count;a++)t.getVec(a,Ka),ms[0]=Math.min(ms[0],Ka[0]),ms[1]=Math.min(ms[1],Ka[1]);const n=ms[0]%s,o=ms[1]%s;cu[0]=ms[0]-n,cu[1]=ms[1]-o;for(let a=0;a<t.count;a++)t.getVec(a,Ka),e.setValues(a,(Ka[0]-cu[0])/s,(Ka[1]-cu[1])/s,cu[0]/s,cu[1]/s)}function ove(e,t,i,r,s=1){oe(iv,1,0,0),oe(rv,0,1,0),oe(Fb,0,0,1),jKe(ik,t),VKe(t,Ate)&&GKe(Ate,iv,rv,Fb,i,ik),tr(ms,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),tr(sv,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let l=0;l<t.count;l++){t.getVec(l,Ka);const c=_e(iv,Ka),h=_e(rv,Ka);ms[0]=Math.min(ms[0],c),ms[1]=Math.min(ms[1],h),sv[0]=Math.max(sv[0],c),sv[1]=Math.max(sv[1],h)}const n=_e(Fb,ik);sk(ag,ms[0],ms[1],n,iv,rv,Fb),sk(nv,sv[0],ms[1],n,iv,rv,Fb),sk(ov,ms[0],sv[1],n,iv,rv,Fb),de(nv,nv,ag),ae(nv,nv,.5),de(ov,ov,ag),ae(ov,ov,.5),pe(ag,ag,nv),pe(ag,ag,ov);const o=ms[0]%s,a=ms[1]%s;cu[0]=ms[0]-o,cu[1]=ms[1]-a;for(let l=0;l<t.count;l++){t.getVec(l,Ka),e.setValues(l,(_e(iv,Ka)-cu[0])/s,(_e(rv,Ka)-cu[1])/s,cu[0]/s,cu[1]/s);for(let c=0;c<3;c++)r.set(l,c,ag[c]),r.set(l,c+3,nv[c]),r.set(l,c+6,ov[c])}}const ik=M(),Ka=M(),Ate=ii(),iv=M(),rv=M(),Fb=M(),ms=Xe(),sv=Xe(),cu=Xe(),ag=M(),nv=M(),ov=M();function VKe(e,t){const i=e.count-1;return qle(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}function GKe(e,t,i,r,s,n){_(s)?(s.basisMatrixAtPosition(n,pd),oe(gP,pd[0],pd[1],pd[2]),oe(yP,pd[4],pd[5],pd[6]),oe(rk,pd[8],pd[9],pd[10])):(oe(gP,1,0,0),oe(yP,0,1,0),oe(rk,0,0,1));const o=e;_e(o,rk)<0&&ae(o,o,-1),ne(r,o);const a=_e(o,yP),l=_e(o,gP);Math.abs(a)<Math.abs(l)?(hz(t,gP,o,-l),be(t,t),dt(i,t,o),be(i,i),ae(i,i,-1)):(hz(i,yP,o,-a),be(i,i),dt(t,i,o),be(t,t))}const pd=Te(),gP=M(),yP=M(),rk=M();function jKe(e,t){oe(vP,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,Ka),pe(vP,vP,Ka);ae(e,vP,1/(t.count-1))}const vP=M();function sk(e,t,i,r,s,n,o){oe(e,t*s[0]+i*n[0]+r*o[0],t*s[1]+i*n[1]+r*o[1],t*s[2]+i*n[2]+r*o[2])}function HKe(e){const t=new Ri,i=e.output===j.Depth;return t.include(Un,{linearDepth:i}),t.include(sb,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(M0,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(x`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(Rr,e),t.fragment.include(Rp),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.uniforms.add("eColor","vec4"),e.output===j.Highlight&&t.include(Fm),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${x.float(zn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(fColor.a);`:""}

    ${e.output===j.Color?x`gl_FragColor = highlightSlice(fColor, vpos); ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${e.output===j.Highlight?x`outputHighlight();`:""};
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""};
  }
  `),t}const qKe=Object.freeze({__proto__:null,build:HKe});class FF extends Vi{initializeProgram(t){const i=FF.shader.get(),r=this.configuration,s=i.build({output:r.output,oitEnabled:r.transparencyPassType===at.Color,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,mi)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("eColor",t.color),this.configuration.output===j.Highlight&&Pp(this.program,i),(this.configuration.output===j.Depth||i.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i))}bindDraw(t){Op(this.program,t),this.program.rebindTextures(),rb(this.program,this.configuration,t)}_createPipeline(t,i){const r=this.configuration,s=t===at.NONE,n=t===at.FrontFace;return Rt({blending:r.output!==j.Color&&r.output!==j.Alpha||!r.transparent?null:s?dl:km(t),culling:zN(r.cullFace),depthTest:{func:O0(t)},depthWrite:s||n?r.writeDepth&&Aa:null,colorWrite:Ft,stencilWrite:r.sceneHasOcludees?vp:null,stencilTest:r.sceneHasOcludees?i?b0:P0:null,polygonOffset:s||n?r.polygonOffset&&WKe:lF(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}FF.shader=new Li(qKe,()=>import("./ColorMaterial.glsl.903e98b9.js"));const WKe={factor:1,units:1};class Ll extends dr{constructor(){super(...arguments),this.output=j.Color,this.cullFace=$i.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],Ll.prototype,"output",void 0),u([Y({count:$i.COUNT})],Ll.prototype,"cullFace",void 0),u([Y()],Ll.prototype,"slicePlaneEnabled",void 0),u([Y()],Ll.prototype,"vertexColors",void 0),u([Y()],Ll.prototype,"transparent",void 0),u([Y()],Ll.prototype,"polygonOffset",void 0),u([Y()],Ll.prototype,"enableOffset",void 0),u([Y()],Ll.prototype,"writeDepth",void 0),u([Y()],Ll.prototype,"sceneHasOcludees",void 0),u([Y({count:at.COUNT})],Ll.prototype,"transparencyPassType",void 0),u([Y()],Ll.prototype,"multipassTerrainEnabled",void 0),u([Y()],Ll.prototype,"cullAboveGround",void 0);class Cte extends Zh{constructor(t){super(t,YKe),this.supportsEdges=!0,this.techniqueConfig=new Ll}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<oF,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a){rF(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===ye.DRAPED_MATERIAL?!0:$1(i)===j.Highlight?t===ye.OPAQUE_MATERIAL:t===(this.parameters.transparent?this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:ye.OPAQUE_MATERIAL)}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth&&this.parameters.writeLinearDepth?new XKe(t):null}createBufferWriter(){return new vF(Lye)}}class XKe extends Nm{updateParameters(t){return this.ensureTechnique(FF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const YKe=I({color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:$i.None,sceneHasOcludees:!1},Du);var dn;(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"})(dn||(dn={}));const n9=.70710678118,Rte=n9,ZKe=.08715574274;function QKe(e){const t=new Ri;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=e.output===j.Depth;t.include(Un,{linearDepth:i}),t.include(sb,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(M0,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("cameraPosition","vec3"),t.attributes.add(E.BOUNDINGRECT,"mat3")),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UVMAPSPACE,"vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const r=e.style===dn.ForwardDiagonal||e.style===dn.BackwardDiagonal||e.style===dn.DiagonalCross;return r&&t.vertex.code.add(x`
      const mat2 rotate45 = mat2(${x.float(n9)}, ${x.float(-Rte)},
                                 ${x.float(Rte)}, ${x.float(n9)});
    `),e.draped||(t.vertex.code.add(x`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),t.vertex.code.add(x`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),t.vertex.code.add(x`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${x.float(ZKe)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),t.vertex.code.add(x`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${r?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${r?" * rotate45":""};

      ${e.draped?"":x`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${x.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),t.vertex.code.add(x`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(Rr,e),t.fragment.include(Rp),t.fragment.uniforms.add("uColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),e.output===j.Highlight&&t.include(Fm),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),e.output!==j.Highlight&&(t.fragment.code.add(x`
      const float lineWidth = ${x.float(e.lineWidth)};
      const float spacing = ${x.float(e.patternSpacing)};
      const float spacingINV = ${x.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(x`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),t.fragment.code.add(x`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${e.output!==j.Highlight?x`color.a *= ${JKe(e)};`:""}

      if (color.a < ${x.float(zn)}) {
        discard;
      }

      ${e.output===j.Alpha?x`gl_FragColor = vec4(color.a);`:""}

      ${e.output===j.Color?x`gl_FragColor = color; ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${e.output===j.Highlight?x`outputHighlight();`:""}
      ${e.output===j.Depth?x`outputDepth(linearDepth);`:""};
    }
  `),t}function JKe(e){function t(i){return e.draped?x`coverage(vuv.${i}, texelSize)`:x`sample(vuv.${i})`}switch(e.style){case dn.ForwardDiagonal:case dn.Horizontal:return t("y");case dn.BackwardDiagonal:case dn.Vertical:return t("x");case dn.DiagonalCross:case dn.Cross:return x`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}const KKe=Object.freeze({__proto__:null,build:QKe});class UF extends Vi{initializeProgram(t){const i=UF.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:r.style,patternSpacing:r.patternSpacing,lineWidth:r.lineWidth,draped:r.draped,oitEnabled:r.transparencyPassType===at.Color,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,ave)}bindPass(t,i){xl(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("uColor",t.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio),this.program.setUniform1f("texelSize",1/i.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.output===j.Highlight&&Pp(this.program,i),(this.configuration.output===j.Depth||i.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Um(this.program,i))}bindDraw(t){Op(this.program,t),R0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),rb(this.program,this.configuration,t),this.program.rebindTextures()}_setPipelineState(t,i){const r=this.configuration,s=t===at.NONE,n=t===at.FrontFace;return Rt({blending:r.output===j.Color||r.output===j.Alpha?s?dl:km(t):null,culling:zN(r.cullFace),depthTest:{func:O0(t)},depthWrite:s?r.writeDepth&&Aa:nF(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?vp:null,stencilTest:r.sceneHasOcludees?i?b0:P0:null,polygonOffset:s||n?r.polygonOffset&&eet:lF(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}UF.shader=new Li(KKe,()=>import("./Pattern.glsl.02c370e9.js"));const eet={factor:1,units:1};class Co extends dr{constructor(){super(...arguments),this.output=j.Color,this.cullFace=$i.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=at.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],Co.prototype,"output",void 0),u([Y({count:$i.COUNT})],Co.prototype,"cullFace",void 0),u([Y()],Co.prototype,"slicePlaneEnabled",void 0),u([Y()],Co.prototype,"vertexColors",void 0),u([Y()],Co.prototype,"polygonOffset",void 0),u([Y()],Co.prototype,"writeDepth",void 0),u([Y()],Co.prototype,"sceneHasOcludees",void 0),u([Y({count:dn.COUNT})],Co.prototype,"style",void 0),u([Y()],Co.prototype,"patternSpacing",void 0),u([Y()],Co.prototype,"lineWidth",void 0),u([Y()],Co.prototype,"enableOffset",void 0),u([Y()],Co.prototype,"draped",void 0),u([Y({count:at.COUNT})],Co.prototype,"transparencyPassType",void 0),u([Y()],Co.prototype,"multipassTerrainEnabled",void 0),u([Y()],Co.prototype,"cullAboveGround",void 0);const ave=new Map([[E.POSITION,0],[E.COLOR,3],[E.UVMAPSPACE,4],[E.BOUNDINGRECT,5]]);class fq extends Zh{constructor(t){super(t,ret),this.supportsEdges=!0,this._vertexAttributeLocations=ave,this.techniqueConfig=new Co}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<oF,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a){rF(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===ye.DRAPED_MATERIAL?!0:$1(i)===j.Highlight?t===ye.OPAQUE_MATERIAL:t===(this.parameters.writeDepth?ye.TRANSPARENT_MATERIAL:ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth&&this.parameters.writeLinearDepth?new tet(t):null}createBufferWriter(){const t=Nr().vec3f(E.POSITION).vec4u8(E.COLOR).vec4f(E.UVMAPSPACE);return this.parameters.draped||t.mat3f(E.BOUNDINGRECT),new iet(t)}}class tet extends Nm{updateParameters(t){return this.ensureTechnique(UF,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}class iet extends vF{write(t,i,r,s){for(const n of this.vertexBufferLayout.fieldNames){const o=i.vertexAttributes.get(n),a=i.indices.get(n);if(o&&a)switch(n){case E.POSITION:{ot(o.size===3);const l=r.getField(n,Ti);l&&KR(a,o.data,t.transformation,l,s);break}case E.COLOR:{ot(o.size===3||o.size===4);const l=r.getField(n,Ca);l&&HD(a,o.data,o.size,l,s);break}case E.UVMAPSPACE:{ot(o.size===4);const l=r.getField(n,Js);l&&BT(a,o.data,l,s);break}case E.BOUNDINGRECT:{ot(o.size===9);const l=r.getField(n,qh);l&&this.writeBoundingRect(a,o.data,t.transformation,l,s);break}}}}writeBoundingRect(t,i,r,s,n){const o=r,a=s.typedBuffer,l=s.typedBufferStride,c=t.length;n*=l;for(let h=0;h<c;++h){const p=9*t[h],f=i[p],g=i[p+1],y=i[p+2];a[n]=o[0]*f+o[4]*g+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*g+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*g+o[10]*y+o[14];for(let v=3;v<9;++v)a[n+v]=i[p+v];n+=l}}}const ret=I({color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:$i.None,sceneHasOcludees:!1,style:dn.Cross,patternSpacing:10,lineWidth:1,draped:!0},Du);function set(e,t,i){return oet(net(e),t,i)}function net(e){return e&&e.pattern||null}function oet(e,t,i){return _(e)?e.style==="none"||e.style==="solid"?(e.style==="none"&&(t.color=yi(0,0,0,0),t.transparent=!0),new Cte(t)):(t.style=aet(e.style),t.draped=i.isDraped,new fq(t)):new Cte(t)}function aet(e){switch(e){case"horizontal":return dn.Horizontal;case"vertical":return dn.Vertical;case"cross":return dn.Cross;case"forward-diagonal":return dn.ForwardDiagonal;case"backward-diagonal":return dn.BackwardDiagonal;case"diagonal-cross":return dn.DiagonalCross;default:return}}function cet(e){return e.material instanceof fq&&!e.material.parameters.draped}function uet(e,t){if(cet(e)){const i=e.geometry.vertexAttributes,r=i.get(E.POSITION).data,s=i.get(E.UVMAPSPACE).data,n=i.get(E.BOUNDINGRECT).data;ove(Js.fromTypedArray(s),jr.fromTypedArray(r),t,c0.fromTypedArray(n))}}function het(e,t,i,r){const s=hye(e,t,i,r),n=e.stageObject.geometryRecords;for(let o=0;o<n.length;o++)uet(n[o],r);return s}const det=["polyline","polygon","extent"];class kF extends $p{constructor(t,i,r,s){super(t,i,r,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(_(this._material))return;const t=bs(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._material=set(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof fq,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const t=this.symbolLayer.outline;if(_(this._outlineMaterial)||!this._isValidOutline(t))return;this._hasOutline=!0;const i=r=>{const s=M0e(t.pattern);return new mx({width:r,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:K8(t.patternCap||"butt")})};this._outlineMaterial=i(ao(t.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(t){return _(t)&&t.size&&t.size>0&&_(t.color)&&(O(t.pattern)||t.pattern.type!=="style"||t.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,det,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new xc);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(i,r):this._createAs3DShape(i,r,s)}layerOpacityChanged(){if(_(this._material)){const t=this._material.parameters.color,i=bs(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameters({color:[t[0],t[1],t[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(_(this._outlineMaterial)){const t=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[t[0],t[1],t[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=rO(kF.elevationModeChangeTypes,r,s);if(n!==yr.UPDATE)return n;const o=Mu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){if(_(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),_(this._outlineMaterial)){const t={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(t)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=KC(t.geometry);if(O(s))return null;Ms.renderData=rq(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),Ms.color=i;const n=Ms.renderData.position.length/3;if(this._needsUV&&(Ms.uvMapSpace=new Float32Array(4*n),Ms.boundingRect=new Float64Array(9*n)),Ms.outNum=0,Ms.outGeometries=[],Ms.outTransforms=[],Ms.outMaterials=[],this._createAs3DShapeFill(Ms),this._hasOutline&&this._createAs3DShapeOutline(Ms),this._logGeometryCreationWarnings(Ms.renderData,s.rings,"rings","FillSymbol3DLayer"),Ms.outNum===0)return null;this._needsUV&&ove(Js.fromTypedArray(Ms.uvMapSpace),jr.fromTypedArray(Ms.renderData.position),this._context.renderCoordsHelper,c0.fromTypedArray(Ms.boundingRect));const o=new Bm({geometries:Ms.outGeometries,materials:Ms.outMaterials,transformations:Ms.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:t.uid}}),a=new Ip(this,o,Ms.outGeometries,null,null,het,r);return a.alignedSampledElevation=Ms.renderData.sampledElevation,a.needsElevationUpdates=Mu(r.mode),a}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:r,mapPosition:s,holeIndices:n,index:o,count:a}of i){if(_(this._context.clippingExtent)&&(Ui(yo),ic(yo,s),!Ah(yo,this._context.clippingExtent)))continue;const l=jT(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=Dee({indices:c,attributeData:{position:r,color:t.color,mapPosition:s,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*o*t.uvMapSpace.BYTES_PER_ELEMENT,4*a):null,boundingRect:this._needsUV?new Float64Array(t.boundingRect.buffer,9*o*t.boundingRect.BYTES_PER_ELEMENT,9*a):null}});t.outGeometries.push(h),t.outMaterials.push(this._material),t.outTransforms.push(ss),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{mapPosition:s,position:n}=i[r];if(_(this._context.clippingExtent)&&(Ui(yo),ic(yo,s),!Ah(yo,this._context.clippingExtent)))continue;const o=J8({overlayInfo:null,removeDuplicateStartEnd:N1.REMOVE,attributeData:{position:n,mapPosition:s}}),a=o.vertexAttributes.get(E.POSITION);a.data===n&&(a.data=new Float64Array(n)),t.outGeometries.push(o),t.outMaterials.push(this._outlineMaterial),t.outTransforms.push(ss),t.outNum++}}_createAsOverlay(t,i){const r=KC(t.geometry);if(O(r))return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,_(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Sn.renderData=n0e(r,this._context.overlaySR),Sn.color=i;const s=Sn.renderData.position.length/3;return this._needsUV&&(Sn.uvMapSpace=new Float32Array(4*s)),Sn.outNum=0,Sn.outGeometries=[],Sn.outBoundingBox=Ui(),Sn.layerUid=this._context.layer.uid,Sn.graphicsUid=t.uid,this._createAsOverlayFill(Sn),this._hasOutline&&this._createAsOverlayOutline(Sn),this._logGeometryCreationWarnings(Sn.renderData,r.rings,"rings","FillSymbol3DLayer"),Sn.outNum===0?null:(this._needsUV&&BKe(Js.fromTypedArray(Sn.uvMapSpace),jr.fromTypedArray(Sn.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),Sn.outNum>0?new RF(this,Sn.outGeometries,Sn.outBoundingBox):null)}_createAsOverlayFill(t){const i=t.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:o}of i){if(Ui(yo),ic(yo,r),!Ah(yo,this._context.clippingExtent))continue;const a=jT(r,s,3);if(a.length===0)continue;nT(t.outBoundingBox,yo);const l=new Uint32Array(a),c=Dee({indices:l,attributeData:{position:r,color:t.color,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*n*t.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),h=new qT(c,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),p=yo;zo(h.boundingSphere,.5*(p[0]+p[3]),.5*(p[1]+p[4]),0,.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1]))),t.outGeometries.push(h),t.outNum++}}_createAsOverlayOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{position:s}=i[r];if(Ui(yo),ic(yo,s),!Ah(yo,this._context.clippingExtent))continue;nT(t.outBoundingBox,yo);const n=J8({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:N1.REMOVE,attributeData:{position:s}}),o=new qT(n,this._outlineMaterial,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),a=yo;zo(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),t.outGeometries.push(o),t.outNum++}}_getOutlineOpacity(){const t=bs(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(_(t)?t.a:0)}_getOutlineColor(){const t=bs(this.symbolLayer,"outline","color"),i=this._getOutlineOpacity();return $A(_(t)?Qe.toUnitRGB(t):null,i)}get test(){return{createAsOverlay:(t,i)=>this._createAsOverlay(t,i),createAs3DShape:(t,i,r)=>this._createAs3DShape(t,i,r)}}}kF.elevationModeChangeTypes={definedChanged:yr.RECREATE,staysOnTheGround:yr.NONE,onTheGroundChanged:yr.RECREATE};const yo=os(),Ms={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Sn={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},pet=he.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters");class zF{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=this._colorToRGBA(t.color),this.haloStyle=this._colorToRGB(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?this._colorToRGBA(t.background.color):null}fontString(t){const i=this.definition.font;return`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`}_colorToRGB(t){return`rgb(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()})`}_colorToRGBA(t){return`rgba(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()},${t[3]})`}static async fromSymbol(t,i=1){const r=bs(t,"material","color"),s=Qa(r,H_,Qe.toUnitRGBA),n=Qa(t.size,12,ao),o=t.lineHeight,a=_(t.background)?Qe.toUnitRGBA(t.background.color):H_,l={family:Qa(t.font,"sans-serif",g=>g.family),decoration:Qa(t.font,"none",g=>g.decoration),weight:Qa(t.font,"normal",g=>g.weight),style:Qa(t.font,"normal",g=>g.style)},c=t.halo,h=_(c)&&_(c.color)&&c.size>0?{size:ao(c.size),color:Qe.toUnitRGBA(c.color)}:{size:0,color:H_},p=new zF({color:s,size:n,background:{color:a,padding:_(t.background)?[.65*n,.5*n]:[0,0],borderRadius:_(t.background)?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:i}),f=p.fontString(n);try{await document.fonts.load(f)}catch{pet.warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}return p}}class fet{constructor(t,i,r){this._renderer=new w0e(t,i,r)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const t=LI(met,this._renderer.renderedWidth,this._renderer.renderedHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,0),i.restore(),new Kr(t,{wrap:{s:lt.CLAMP_TO_EDGE,t:lt.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:Wy.PAD})}}const met={canvas:null},get=[0,0,1];class yet extends $p{constructor(t,i,r,s){super(t,i,r,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=cF(this.symbolLayer.size);if(t)throw new Q("graphics3dtextsymbollayer:invalid-size",t)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const t=this._context.graphicsCoreOwner.view.pixelRatio;this._textRenderParameters=await zF.fromSymbol(this.symbolLayer,t)}destroy(){super.destroy()}createGraphics3DGraphic(t){const i=t.graphic,r=QC(i.geometry);if(O(r))return this.logger.warn(`unsupported geometry type for text symbol: ${i.geometry.type}`),null;const s=this.symbolLayer.text;if(O(s)||s==="")return null;const n=jG(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(_(n)&&!uae(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=me(I({},bet),{verticalOffset:n,horizontalPlacement:jYe(this.symbolLayer.horizontalAlignment),verticalPlacement:HYe(this.symbolLayer.verticalAlignment)});return this._createAs3DShape(i,r,s,o)}createLabel(t,i,r,s){const n=t.graphic,o=QC(n.geometry);if(O(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=i.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,i,r,s)}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(t,i){return Ote(t,i,(r,s)=>{this.updateGraphicElevationContext(s,r)}),yr.UPDATE}slicePlaneEnabledChanged(t,i){return Ote(t,i,r=>{for(const s of r.stageObject.geometryRecords)s.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=Mu(i.elevationContext.mode)||i.elevationContext.mode==="absolute-height"}_defaultElevationInfoNoZ(){return _et}_createAs3DShape(t,i,r,s,n,o){const a=this.setGraphicElevationContext(t,new xc,s.elevationOffset),l=bs(t.geometry,"type")==="polyline",c=t.uid;let h=null,p=null;if(O(o)){const B=T0e(s.horizontalPlacement);h=new fet(r,B,this._textRenderParameters);let J=null;p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{_(J)&&J.release()});const Z=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(O(Z)||_c(Z))return p.release(),null;J=Z}const f=vet(h,s),g={occlusionTest:!0,screenOffset:s.screenOffset,anchorPos:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,debugDrawLabelBorder:s.debugDrawLabelBorder,drawInSecondSlot:!0};if(_(p)&&(g.textureId=p.texture.id),_(o)&&(g.textureId=o.id),_(s.verticalOffset)){const{screenLength:B,minWorldLength:J,maxWorldLength:Z}=s.verticalOffset;g.verticalOffset={screenLength:ao(B),minWorldLength:J||0,maxWorldLength:Z!=null?Z:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:B,screenSizePerspectiveSettingsLabels:J}=this._context.sharedResources;g.screenSizePerspective=J.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),g.screenSizePerspectiveAlignment=B}let y;if(l&&(g.shaderPolygonOffset=1e-4),g.slicePlaneEnabled=this._context.slicePlaneEnabled,_(n)){const B=JSON.stringify(g);y=n.get(B),O(y)&&(y=new VT(g),n.add(B,y))}else y=new VT(g);const v=[y],b=s.translation,w=_(h)?[h.displayWidth,h.displayHeight]:[0,0],S=s.centerOffset,T=get,A=[0,0],C=[Wa.createPointGeometry(T,b,null,w,S,A,null)],R=this._context.layer.uid,L=WH(this._context,i,C,v,a,R,c);if(L===null)return null;const U=new Ip(this,L.object,C,O(n)?v:null,p,YC,a);U.alignedSampledElevation=L.sampledElevation,U.needsElevationUpdates=Mu(a.mode)||a.mode==="absolute-height";const{displayWidth:N,displayHeight:z}=_(h)?h:s;U.getScreenSize=(B=Xe())=>(B[0]=N,B[1]=z,B);const V={labelText:r,elevationOffset:s.elevationOffset};return U.metadata=V,ZC(U,i,this._context.elevationProvider),U}}function Ote(e,t,i){e&&e.forEach(r=>{const s=t(r);_(s)&&i(s,r.graphic)})}function vet(e,t){if(t.verticalPlacement==="baseline"){const r=BYe[t.horizontalPlacement],s=_(e)?e.baselineAnchorY:0;return vi(r,s)}const i=GYe(t.horizontalPlacement,t.verticalPlacement);return NI[i]}const _et={mode:"relative-to-ground",offset:0},bet={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0},wet=["polyline","polygon","extent"];class Wd extends $p{constructor(t,i,r,s){super(t,i,r,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,wet,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new xc);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(i):this._createAs3DShape(i,r,i.uid)}ensureMaterial(){if(_(this._material))return;const t=I({},Nye),i=this.symbolLayer.color;_(i)&&(t.color=Qe.toUnitRGBA(i));const r=this._getCombinedOpacity(i,{hasIntrinsicColor:!0});t.color=[t.color[0],t.color[1],t.color[2],r],t.transparent=r<1||this.needsDrivenTransparentPass,t.waveDirection=_(this.symbolLayer.waveDirection)?Wd.headingVectorFromAngle(this.symbolLayer.waveDirection):vi(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=BWe[s];t.waveStrength=n.waveStrength,t.waveTextureRepeat=n.textureRepeat,t.waveVelocity=n.waveVelocity,t.flowStrength=n.perturbationStrength,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t.isDraped=this.draped,this._material=new Fye(t),this._context.stage.add(this._material)}layerOpacityChanged(){if(O(this._material))return!0;const t=this._material.parameters.color,i=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[t[0],t[1],t[2],i],transparent:r}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=rO(Wd.elevationModeChangeTypes,r,s);if(n!==yr.UPDATE)return n;const o=Mu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return _(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=KC(t.geometry);if(O(s))return null;Zn.renderData=rq(s,this._context.elevationProvider,this._context.renderCoordsHelper,i);const n=Zn.renderData.position.length/3;if(Zn.uvCoords=new Float64Array(2*n),Zn.outNum=0,Zn.outGeometries=[],Zn.outTransforms=[],Zn.outMaterials=[],this._create3DShapeGeometries(Zn),this._logGeometryCreationWarnings(Zn.renderData,s.rings,"rings","WaterSymbol3DLayer"),Zn.outNum===0)return null;this._createUVCoordsFromVertices(Zn.uvCoords,Zn.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new Bm({geometries:Zn.outGeometries,materials:Zn.outMaterials,transformations:Zn.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),a=new Ip(this,o,Zn.outGeometries,null,null,hye,i);return a.alignedSampledElevation=Zn.renderData.sampledElevation,a.needsElevationUpdates=Mu(i.mode),a}_createUVCoordsFromVertices(t,i,r,s){const n=bl(s);Tu(lg);for(let l=0;l<r;l++)tr(Mte,i[3*l+0],i[3*l+1]),Ooe(lg,Mte);wR(lg,lg,n);const o=lg[0]%Wd.unitSizeOfTexture,a=lg[1]%Wd.unitSizeOfTexture;_P[0]=lg[0]-o,_P[1]=lg[1]-a;for(let l=0;l<r;l++)t[2*l+0]=(i[3*l+0]*n-_P[0])/Wd.unitSizeOfTexture,t[2*l+1]=(i[3*l+1]*n-_P[1])/Wd.unitSizeOfTexture}_create3DShapeGeometries(t){const i=t.renderData.polygons,r=t.uvCoords;for(const{count:s,index:n,position:o,mapPosition:a,holeIndices:l}of i){if(_(this._context.clippingExtent)&&(Ui(cg),ic(cg,a),!Ah(cg,this._context.clippingExtent)))continue;const c=jT(a,l,3);if(c.length===0)continue;const h=new Uint32Array(c),p=new Float64Array(r.buffer,2*n*r.BYTES_PER_ELEMENT,2*s),f=Lee({indices:h,attributeData:{position:o,uv0:p,mapPosition:a}});t.outGeometries.push(f),t.outMaterials.push(this._material),t.outTransforms.push(ss),t.outNum++}}_createAsOverlay(t){const i=KC(t.geometry);if(O(i))return null;this._material.renderPriority=this._renderPriority,vo.renderData=n0e(i,this._context.overlaySR);const r=vo.renderData.position.length/3;return vo.uvCoords=new Float64Array(2*r),vo.outNum=0,vo.outGeometries=[],vo.outBoundingBox=Ui(),vo.layerUid=this._context.layer.uid,vo.graphicsUid=t.uid,this._createAsOverlayWater(vo),this._logGeometryCreationWarnings(vo.renderData,i.rings,"rings","WaterSymbol3DLayer"),vo.outNum===0?null:(this._createUVCoordsFromVertices(vo.uvCoords,vo.renderData.position,r,this._context.overlaySR),vo.outNum>0?new RF(this,vo.outGeometries,vo.outBoundingBox):null)}_createAsOverlayWater(t){const i=t.uvCoords,r=t.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of r){if(Ui(cg),ic(cg,s),!Ah(cg,this._context.clippingExtent))continue;nT(t.outBoundingBox,cg);const l=jT(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=new Float64Array(i.buffer,2*o*i.BYTES_PER_ELEMENT,2*a),p=Lee({indices:c,attributeData:{position:s,uv0:h}}),f=new qT(p,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),g=cg;zo(f.boundingSphere,.5*(g[0]+g[3]),.5*(g[1]+g[4]),0,.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]))),t.outGeometries.push(f),t.outNum++}}static headingVectorFromAngle(t){const i=Xe(),r=IL(t);return i[0]=Math.sin(r),i[1]=Math.cos(r),i}get test(){return{create3DShape:t=>this._createAs3DShape(t.graphic,t.elevationContext,t.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}Wd.unitSizeOfTexture=100,Wd.elevationModeChangeTypes={definedChanged:yr.RECREATE,staysOnTheGround:yr.NONE,onTheGroundChanged:yr.RECREATE};const _P=Xe(),lg=Dt(),Mte=Xe(),cg=os(),Zn={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},vo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},xet=he.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Tet(e,t,i,r){const s=Pte[e.type]&&Pte[e.type][t.type]||Eet[t.type];return s?new s(e,t,i,r):(xet.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Eet={icon:rR,object:GJe,line:PF,path:LKe,fill:kF,extrude:RYe,text:yet,water:Wd},Pte={"mesh-3d":{fill:SQe}};class Aet extends GH{constructor(t,i,r){super(i.schedule),this._symbol=t,this._context=i,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(t){this._symbol=t;for(let i=0;i<t.symbolLayers.length;i++){const r=this.symbolLayers[i];O(r)||(r.symbol=t,r.symbolLayer=t.symbolLayers.items[i])}}get symbol(){return this._symbol}async doLoad(t){let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const r=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const s=[];for(let n=0;n<r;n++){const o=i.getItemAt(n);if(o.enabled===!1)continue;bP.renderPriority=1-(1+n)/r,bP.renderPriorityStep=1/r,bP.ignoreDrivers=o._ignoreDrivers;const a=Tet(this.symbol,o,this._context,bP);s.push(OL(t,()=>{this.symbolLayers[n]=null,a.destroy()})),this.symbolLayers[n]=a}await ZL(this.symbolLayers,async(n,o)=>{if(_(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}});for(const n of s)n==null||n.remove();if(s.length=0,Jt(t),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(t){const i=this.symbolLayers[t];return _(i)?i.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(t,i){const r=t.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=_(a)?a.createGraphics3DGraphic(t):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new aWe(r,i||this,s,t.layer,n)}get complexity(){return qH(this.symbolLayers.map(t=>bs(t,"complexity")))}globalPropertyChanged(t,i){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const n=this.symbolLayers[s],o=a=>{const l=a.graphics[s];return l instanceof Ip?l:null};if(_(n)&&!n.globalPropertyChanged(t,i,o))return!1}return!0}applyRendererDiff(t,i){return this.loadStatus!==Xl.LOADED?xs.Recreate_Symbol:this.symbolLayers.reduce((r,s)=>r!==xs.Recreate_Symbol&&_(s)?Math.min(r,s.applyRendererDiff(t,i)):r,xs.Fast_Update)}prepareSymbolPatch(t){if(this.loadStatus===Xl.FAILED||t.diff.type!=="partial")return;const i=t.diff.diff;if(!i.symbolLayers||i.symbolLayers.type!=="partial")return;const r=i.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(O(s))return;const o=r[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),t.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push((l,c)=>{const h=l.graphics[n];_(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(t,i){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(O(s))continue;const n=t.graphics[r];if(O(n)||!s.updateGeometry(n,i))return!1}return!0}onRemoveGraphic(t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(O(r))continue;const s=t.graphics[i];_(s)&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let t=0,i=0,r=0;return this.symbolLayers.forEach(s=>{O(s)||(s.loadStatus===Xl.LOADING?t++:s.isFastUpdatesEnabled()?r++:i++)}),{loading:t,slow:i,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const t of this.symbolLayers)_(t)&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const bP={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class Cet extends GH{constructor(t,i,r){super(i),this.symbol=t,this.convert=r,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(t):null}get symbolLayers(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(t){const i=await this.symbol.fetchSymbol({signal:t});i.id=this.symbol.id,this.graphics3DSymbol=this.convert(i),_(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(t,this):null}get complexity(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:HH}globalPropertyChanged(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(t,i)}applyRendererDiff(t,i){return _(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(t,i):xs.Recreate_Symbol}prepareSymbolPatch(t){_(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(t)}updateGeometry(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(t,i)}onRemoveGraphic(){}getFastUpdateStatus(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){_(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}}function mq(e){return e instanceof Cet?e.graphics3DSymbol:e instanceof Aet?e:null}const nR=he.getLogger("esri.views.3d.layers.graphics.labelPlacement");function Ret(e){const t=Fet(e);if(O(t))return null;const i=Oet(e,t);if(O(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return Pet({anchor:r,verticalOffset:t.verticalOffset,screenOffset:Xe(),centerOffset:yi(0,0,0,-1),centerOffsetUnits:"world",translation:M(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Oet(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Ph[i],s=r||aL(e);return i&&!r&&nR.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),Met(s,e)}function gq(e){const t=e.graphics3DGraphic.graphics3DSymbol,i=mq(t);return _(i)?i.symbol.symbolLayers.getItemAt(0):null}function Met(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(O(i))return null;if(_(t.disablePlacement))return t.labelClass.labelPlacement?(nR.warnOncePerTick(Ite(e.placement,t.disablePlacement.logEntityDescription)),aL(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return nR.warnOncePerTick(Ite(e.placement,`'${r}' geometries`)),aL(t);break;case"point":case"mesh":return e}return e}function Ite(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function aL(e){const t=e.graphics3DGraphic.graphic.geometry;if(O(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const i=gq(e);return _(i)&&i.type==="extrude"?Ph["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Ph["above-center"];default:return}}function Pet(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(O(r))return null;switch(r.type){case"point":$et(e,t,i);break;case"polygon":Iet(e,t,i);break;case"mesh":yq(e,t,i.graphics3DGraphic.graphics[0])}return e}function Iet(e,t,i){const r=gq(i);if(!O(r))switch(r.type){case"extrude":{const s=i.graphics3DGraphic.graphics[0];_(s)?(s.getBoundingBoxObjectSpace(zA),Eh(zA,e.translation),e.translation[2]=j1(zA)/2):oe(e.translation,0,0,0),yq(e,t,s);break}}}function $et(e,t,i){const r=gq(i);if(O(r))return;const s=i.graphics3DGraphic.graphics[0];switch(_(s)?s.getCenterObjectSpace(e.translation):oe(e.translation,0,0,0),r.type){case"icon":case"text":Det(e,t,i,s);break;case"object":yq(e,t,s)}}function Det(e,t,i,r){const{graphics3DGraphic:s}=i,n=_(r)?r.getScreenSize():null;if(!s.isDraped&&_(n)){const o=Let(i);v2[0]=n[0]/2*(t.normalizedOffset[0]-o[0]),v2[1]=n[1]/2*(t.normalizedOffset[1]-o[1]),e.screenOffset[0]=v2[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=v2[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=v2[1]}else e.hasLabelVerticalOffset||e.anchor==="center"||(Ph[i.labelClass.labelPlacement]&&nR.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function Let(e,t=Uet){const{graphics3DGraphic:i}=e,r=i.graphics[0],s=_(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof VT){const n=s.parameters.anchorPos;t[0]=2*(n[0]-.5),t[1]=2*(n[1]-.5)}else t[0]=0,t[1]=0;return t}function yq(e,t,i){const r=_(i)?i.getBoundingBoxObjectSpace(zA):zA,s=je(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const o=e.translation[2],a=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+a;const l=Pe(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Net(e){return e==="above-center"}function Fet(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=mq(r.graphics3DSymbol),n=oo(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=Ph[t]||aL(e);return _(n)&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:$te(n.verticalOffset),anchor:null,normalizedOffset:null}:i&&i.hasVisibleVerticalOffset()&&(O(n)||!n.supportsCallout()||!n.verticalOffset||r.isDraped)?Net(o.placement)?{placement:"above-center",verticalOffset:$te(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(nR.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function $te(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Ph={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Dte={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Dte){const t=Dte[e],i=Ph[e];t.forEach(r=>{Ph[r]=i})}Object.freeze&&(Object.freeze(Ph),Object.keys(Ph).forEach(function(e){Object.freeze(Ph[e]),Object.freeze(Ph[e].normalizedOffset)}));const v2=[0,0],Uet=[0,0],zA=os();class Lte{constructor(t){this._stage=t,this._materials=new Map}get(t){return this._materials.get(t)}add(t,i){this._materials.set(t,i),this._stage.add(i)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var o9;const nk=512,ok=4096,ket=.85,zet=.95;let Gw=o9=class extends we{constructor(e){super(e),this.type=Wh.Texture,this.id=va(),this.events=new wr,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this._create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=et(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,flipped:!0,samplingMode:Ve.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return _(this._glTexture)||(this._glTexture=new Ze(e,this._createDescriptor(e),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(ut.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=Ys(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=et(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",nk.toString()),e.setAttribute("height",nk.toString()),e}_update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}_createAtlasRegion(e=nk){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=Zx(i),i=Math.min(i,ok),i}_resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,_(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this.atlas;e.cursor.x=_2,e.cursor.y=_2+Nte,e.lineHeight=0,this.needsClear=!0}_getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this._getAtlasUsage()/i*(i+t-e)}_addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:n,renderedHeight:o,displayWidth:a,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=n,e.placement.size.height=o,e.placement.size.displayWidth=a,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+o)/s.size.height,(e.placement.offset.x+n)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}_removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}_ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get(E.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,o=s+_2,a=n+_2+Nte;if(i.cursor.x+o<i.size.width&&i.cursor.y+a<i.size.height)this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+a+i.lineHeight<i.size.height)){const l=this._getExpectedAtlasUsage(),c=l>ket&&i.size.width<ok;return c&&this._resizeAtlas(2*i.size.width,2*i.size.height),!t||!c&&l>zet&&i.size.width===ok?(this._processRemovals(),gx.OK):(this._repack(),gx.REPACK)}i.cursor.x=_2,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return gx.OK}_processRemovals(){this.elementsToRemove.forEach((e,t)=>{const i=this.stageObjects.get(t);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this.stageObjects.delete(t)}),this.elementsToRemove.clear()}_repack(){this._processRemovals(),this.elements.forEach((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)}),this.elements.clear(),this._resetAtlasCursor(),this.elementsToRender.clear()}_processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach(i=>{i.geometries[0].vertexAttributes.get(E.UV0).data=new Float32Array(e.placement.uvMinMax),i.geometries[0].vertexAttributes.get(E.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],i.geometryVertexAttrsUpdated(i.geometryRecords[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this._glTexture)return;let i=!1;if(Vr(this.elementsToAddOrUpdate,(s,n)=>{const o=this.elements.get(n);if(o&&o.rendered){const a=this.stageObjects.get(n);return a&&a.forEach(l=>{const c=l.geometries[0].vertexAttributes,h=this.elements.get(n);c.get(E.UV0).data=new Float32Array(h.placement.uvMinMax),c.get(E.SIZE).data=new Float32Array([h.placement.size.displayWidth,h.placement.size.displayHeight]),l.geometryVertexAttrsUpdated(l.geometryRecords[0])}),this.elementsToAddOrUpdate.delete(n),!1}return this._processAddition(this.elementsToAddOrUpdate.get(n),t)===gx.REPACK&&(i=!0,!0)}),i)return void this.runTask(_S,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),Vr(this.elementsToRender,(s,n)=>(this._processRenderingRequest(s),this.elementsToRender.delete(n),r=!0,e.madeProgress(),e.done)),r&&_(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&o9.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this._removeStageObject(i,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this.elements.size===0)return;const e=[];this.elements.forEach((i,r)=>e.push({element:i,key:r}));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort((i,r)=>i.key.localeCompare(r.key)),this.elements.clear();for(const{element:i,key:r}of e)this.elements.set(r,i);this._repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,_resizeAtlas:(n,o)=>s._resizeAtlas(n,o),run:(n,o)=>s.runTask(n,o)}}};Gw.test={orderedRepackingEnabled:!1},u([d({constructOnly:!0})],Gw.prototype,"view",void 0),u([d({type:Boolean})],Gw.prototype,"updating",void 0),Gw=o9=u([P("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Gw);const _2=2,Nte=2;var gx;(function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"})(gx||(gx={}));const Bet=Gw,Fte=he.getLogger("esri.views.3d.layers.graphics.Labeler");let Kv=class extends we{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new Bt,this._handles.add([this.view.watch("state.camera",()=>this.setDirty()),this.view.watch("pixelRatio",()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(ut.LABELER,this)]),this._textTextureAtlas=new Bet({view:this.view}),this._hudMaterialCollection=new Lte(this.view._stage),this._calloutMaterialCollection=new Lte(this.view._stage)}dispose(){this._handles=it(this._handles),this._textTextureAtlas=et(this._textTextureAtlas),this._hudMaterialCollection=et(this._hudMaterialCollection),this._calloutMaterialCollection=et(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach((t,i)=>{this._labels.set(i,t),t.graphics3DGraphic.setVisibilityFlag(Kl.USER_SETTING,!0,hn.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach((t,i)=>{t.graphics3DGraphic.setVisibilityFlag(Kl.USER_SETTING,!1,hn.LABEL),this.setLabelGraphicVisibility(t.graphics3DGraphic,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){var e;return this.view.ready&&(this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(Vet(t)){if(!Ute(t)){if(Get(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),ak(t)){this._dirty=!0;continue}if(!Ute(t))continue}Vr(t.labelsToInitialize,(i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textTextureResources.initialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(t=>this._removeLabelTextureFromAtlas(t)),this._labelsToAdd.forEach(t=>this._addLabelTextureToAtlas(t)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),Jt(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter(a=>!!a.symbol);if(!s||s.length===0)return;const n=new Array(s.length);let o=!1;await ZL(s,async(a,l)=>{const c=a.symbol,h=mq(i.getOrCreateGraphics3DSymbol(c));if(O(h))return void Fte.error("Failed to create Graphics3DSymbol for label");await h.load(),Jt(t);let p=null;jG(c)&&c.hasVisibleCallout()&&(p=rWe(c,i.symbolCreationContext),await p.load(),Jt(t));const f=await Bh(aye(a,e.layer.fieldsIndex,this.view.spatialReference));if(Jt(t),f.ok===!0){const g=await this._createTextRenderParameters(h.symbol);Jt(t),n[l]={labelClass:a,labelFunction:f.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:p,calloutSymbolLayerIndex:0,textRenderParameters:g}}else Fte.error(`Label expression failed to evaluate: ${f.error}`),o=!0}),Jt(t),o||(e.labelClassContexts=n)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(vr(t))throw t;e.labelClassContexts=null}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&t.type==="text"?zF.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced,i.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const n={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,centerOffsetUnits:i.centerOffsetUnits,horizontalPlacement:Yee(i.anchor),verticalPlacement:VYe(i.anchor),verticalOffset:i.verticalOffset,debugDrawLabelBorder:hi.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return ug.graphic=t,ug.renderingInfo=null,ug.layer=r,s.createLabel(ug,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const n={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return ug.graphic=e,ug.renderingInfo=n,ug.layer=s,i.createGraphics3DGraphic(ug)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const{textTextureResources:i}=e,r=e.labelingContext,s=r.labelClassContexts;if(!s||s.length===0||!r.emptySymbolLabelSupported&&t.graphics.length===0)return!1;let n=!1;const o=t.graphic,a=r.layer,l=hB(r.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const p=i.textRenderers[h],f=i.labelPlacements[h];if(O(p)||O(f))continue;const g=s[h],y=g.graphics3DSymbol,v=y.symbol&&y.symbol.type==="label-3d"?y.symbol:null,b=y.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(r.elevationInfoOverride);const w=this._createTextSymbolGraphic(p,o,f,a,b);if(!w)return!1;w._labelClass=g.labelClass,w._labelIndex=h,t.addLabelGraphic(w,c,r.stageLayer),t.setVisibilityFlag(Kl.USER_SETTING,l,hn.LABEL),t.clearVisibilityFlag(Kl.SCALE_RANGE,hn.LABEL),t.setVisibilityFlag(Kl.DECONFLICTION,!1,hn.LABEL),n=!0;const S=g.graphics3DCalloutSymbolLayer;if(S&&f.hasLabelVerticalOffset){S.setElevationInfoOverride(r.elevationInfoOverride);const T=this._createLineCalloutGraphic(o,v,S,f,a);_(T)&&(g.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(T,c,r.stageLayer))}break}return r.scaleVisibility&&n&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(i._labelClass==null)continue;const r=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];r!=null&&r.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){const{textTextureResources:t}=e;if(t.initialized)return;const i=e.labelingContext,r=i.labelClassContexts;if(!r||r.length===0)return;const s=e.graphics3DGraphic.graphic;for(let n=0;n<r.length;n++){const o=r[n];if(t.textRenderers[n]=null,t.labelPlacements[n]=null,!o.textRenderParameters)continue;const a=o.labelFunction;let l;if(a.type==="arcade")try{const w=a.needsHydrationToEvaluate()?JHe(s,i.layer):s;l=a.evaluate(w)}catch{l=null}else l=a.evaluate(s);if(O(l)||l===""||/^\s+$/.test(l))continue;const c=o.graphics3DSymbol,h=c.symbol&&c.symbol.type==="label-3d"?c.symbol:null;if(!c.symbolLayers[0])continue;const p=e.graphics3DGraphic,f=o.labelClass,g=i.disablePlacement,y=Ret({graphics3DGraphic:p,labelSymbol:h,labelClass:f,disablePlacement:g});if(O(y))continue;const v=Yee(y.anchor),b=T0e(v);t.textRenderers[n]=new w0e(l,b,o.textRenderParameters),t.labelPlacements[n]=y}t.initialized=!0}_destroyTextTextureResources(e){const{textTextureResources:t}=e;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]}_addGraphic(e,t){const i={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.labels.get(i);r&&(this._removeGraphic(e,r.graphics3DGraphic),this._addGraphic(e,r.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach(n=>{const o=n.graphics3DGraphic;r.set(o.graphic.uid,o)});const s=n=>n.labelGraphics[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const n=o=>o.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,a={graphics3DCore:e,layer:o,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:n,active:o.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new qye({isPickable:!0},o.uid)};return this.view._stage.add(a.stageLayer),this._labelingContexts.push(a),this.setDirty(),{addGraphic:l=>this._addGraphic(a,l),removeGraphic:l=>this._removeGraphic(a,l),featureReductionChange:()=>{},layerLabelsEnabled:()=>hB(a.layer),labelingInfoChange:l=>this._labelingInfoChange(a,l),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic)),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.textTextureResources.initialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>ak(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(ak(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function Vet(e){return e.active&&hB(e.layer)}function ak(e){return e.labelClassPromise&&!!e.labelClassAbortController}function Ute(e){return e.labelClassContexts&&e.labelClassContexts.length}function Get(e){return e.labelClassContexts===null}u([d({constructOnly:!0})],Kv.prototype,"view",void 0),u([d({constructOnly:!0})],Kv.prototype,"deconflictor",void 0),u([d()],Kv.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],Kv.prototype,"updating",null),Kv=u([P("esri.views.3d.layers.graphics.Labeler")],Kv);const ug=new nWe(null,null,null);class jet{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new Bt}loadGLTF(t,i,r){const s=r?`gltfPBR:${t}`:`gltf:${t}`;return this._fromCache(this.gltfCache,s,n=>H0e(new G0e(n.streamDataRequester),t,n,r),i)}loadWOSR(t,i){const r=`wosr:${t}:${i.disableTextures}`;return this._fromCache(this.wosrCache,r,s=>q0e(t,s),i)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}_fromCache(t,i,r,s){return new Promise((n,o)=>{if(Ls(s))return void o(pi());const a=co(s,()=>{this._remove(t,i),o(pi())}),l=t.get(i);if(l)return this.evictHandles.remove(i),l.refCount++,void l.item.then(n,o);const c=new AbortController,h=me(I({},s),{signal:c.signal}),p={refCount:1,abortController:c,item:r(h).then(f=>(p.abortController=null,f.remove=()=>this._remove(t,i),f))};t.set(i,p),p.item.then(f=>{_(a)&&a.remove(),n(f)},f=>{_(a)&&a.remove(),o(f)})})}_remove(t,i){const r=t.get(i);r&&(r.refCount--,r.refCount===0&&this.evictHandles.add(Z1e(()=>{t.delete(i),_(r.abortController)&&r.abortController.abort()},qet),i))}}const Het=1e4;let qet=Het;class Th{constructor(t,i,r,s=null){this.lij=[0,0,0],this.extent=Dt(),this.resolution=0,this.loadPriority=0,this.measures={visibility:to.VISIBLE_ON_SURFACE,screenRect:Dt(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(t,i,r,s)}acquire(t,i,r,s){this.tilingScheme=s,this.id=Th.id(t,i,r),this.lij[0]=t,this.lij[1]=i,this.lij[2]=r,s.getExtent(t,i,r,this.extent),this.resolution=s.resolutionAtLevel(t)}release(){this.tilingScheme=null}getChildren(t){const i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return t?(t[0].acquire(i,r,s,this.tilingScheme),t[1].acquire(i,r+1,s,this.tilingScheme),t[2].acquire(i,r,s+1,this.tilingScheme),t[3].acquire(i,r+1,s+1,this.tilingScheme),t):[new Th(i,r,s,this.tilingScheme),new Th(i,r+1,s,this.tilingScheme),new Th(i,r,s+1,this.tilingScheme),new Th(i,r+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(t){this.measures.visibility=t.measures.visibility,this.measures.shouldSplit=t.measures.shouldSplit,this.measures.distance=t.measures.distance,i0(t.measures.screenRect,this.measures.screenRect)}static id(t,i,r){return`${t}/${i}/${r}`}}var to;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",e[e.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(to||(to={}));class vy{constructor(t){this.renderCoordsHelper=t,this.frustum=GC(),this._points=bme(),this.lines=new Array(12),this._origin=M(),this._direction=M(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:M(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(t){wme(t.viewMatrix,t.projectionMatrix,this.frustum,this._points),ne(this._origin,t.eye),ne(this._direction,t.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(t){for(let i=0;i<this._points.length;i++)ne(this._points[i],t[i]);xme(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(t){return Ny(this.frustum,t)}intersectsRay(t){return L9e(this.frustum,t)}intersectsLineSegment(t,i){return N9e(this.frustum,t,i)}intersectsPoint(t){return Tme(this.frustum,t)}_updateLines(){const t=this._points;for(let i=0;i<4;i++){const r=i+4;lk(this.lines[i],t[i],t[r]),lk(this.lines[i+4],t[i],i===3?t[0]:t[i+1]),lk(this.lines[i+8],t[r],i===3?t[4]:t[r+1])}}}function lk(e,t,i){e.origin=t,e.endpoint=i,Am(e.direction,t,i)}vy.planePointIndices=U9e,vy.nearFarLineIndices=[[We.NEAR_BOTTOM_LEFT,We.FAR_BOTTOM_LEFT],[We.NEAR_BOTTOM_RIGHT,We.FAR_BOTTOM_RIGHT],[We.NEAR_TOP_RIGHT,We.FAR_TOP_RIGHT],[We.NEAR_TOP_LEFT,We.FAR_TOP_LEFT]];const lve=.5*Math.PI,Wet=lve/Math.PI*180;class Xet{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:M(),direction:M()};for(let i=0;i<4;i++)this.extent[i]={origin:M(),direction:M(),cap:{next:null,direction:M()}},this.planes[i]=ii();this.planes[qi.NEAR]=ii(),this.planes[qi.FAR]=ii(),this.planesWithoutFar=this.planes.slice(0,5)}update(t,i,r,s=!0){const n=this.extent;this._toRenderBoundingExtent(t,i,r),pe(this.center.origin,n[0].origin,n[2].origin),ae(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),s||ae(this.center.direction,this.center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this.renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,Am(a.cap.direction,a.origin,l.origin),uC(a.direction,a.cap.direction,a.origin,this.planes[o]),s||ae(a.direction,a.direction,-1)}uC(n[0].cap.direction,n[1].cap.direction,n[0].origin,this.planes[qi.NEAR]),s?aB(this.planes[qi.NEAR],this.planes[qi.FAR]):(lN(this.planes[qi.FAR],this.planes[qi.NEAR]),aB(this.planes[qi.NEAR],this.planes[qi.NEAR])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=i,this.minGlobalAltitude=.9*di(this.maxSpanSpatialReference).radius}isVisibleInFrustum(t,i,r=!1){if(t==null)return!1;if(this.renderCoordsHelper.viewingMode===$e.Global){const n=this.maxSpanSpatialReference.isGeographic?Wet:lve*i;if(this.maxSpan>n)return!0;if(t.altitude>=this.minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(this.maxSpan===0){const n=this.extent[0];return!(r||!t.intersectsRay(fc(n.origin,n.direction)))}for(let n=0;n<this.extent.length;n++){const o=this.extent[n];if(!r&&t.intersectsRay(fc(o.origin,o.direction))||t.intersectsLineSegment(q_(o.origin,o.cap.next,Zet),o.cap.direction))return!0}const s=r?this.planes:this.planesWithoutFar;for(let n=0;n<t.lines.length;n++){const o=t.lines[n];if(f8e(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,i,r){AG(t,Gu),Gu[2]=r,Gh(i,Gu,ck,this.renderCoordsHelper.spatialReference),hr(kte,ck),Ui(Pa);for(const{x0:n,x1:o,y0:a,y1:l}of Yet)for(let c=0;c<5;c++){const h=c/4;Gu[0]=qt(t[n],t[o],h),Gu[1]=qt(t[a],t[l],h),Gu[2]=r,yn(Gu,i,Gu,this.renderCoordsHelper.spatialReference),Ue(Gu,Gu,kte),hp(Pa,Gu)}oe(this.extent[0].origin,Pa[0],Pa[1],Pa[2]),oe(this.extent[1].origin,Pa[3],Pa[1],Pa[2]),oe(this.extent[2].origin,Pa[3],Pa[4],Pa[2]),oe(this.extent[3].origin,Pa[0],Pa[4],Pa[2]);for(let n=0;n<4;++n)Ue(this.extent[n].origin,this.extent[n].origin,ck)}_toRenderBoundingExtentLocal(t,i,r){sN(t,i,Hp,this.renderCoordsHelper.spatialReference),oe(this.extent[0].origin,Hp[0],Hp[1],r),oe(this.extent[1].origin,Hp[2],Hp[1],r),oe(this.extent[2].origin,Hp[2],Hp[3],r),oe(this.extent[3].origin,Hp[0],Hp[3],r)}_toRenderBoundingExtent(t,i,r){switch(this.renderCoordsHelper.viewingMode){case $e.Global:this._toRenderBoundingExtentGlobal(t,i,r);break;case $e.Local:this._toRenderBoundingExtentLocal(t,i,r);break;default:this.renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(t){if(_e(this.center.direction,t.direction)<0)return!0;for(let i=0;i<4;i++){const r=this.extent[i];if(_e(r.direction,t.direction)<0)return!0}return!1}}const Yet=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Gu=M(),ck=Te(),kte=Te(),Pa=os(),Hp=Dt(),Zet=S0();class Qet{constructor(t){this.renderCoordsHelper=t,this.surfaceElevation=0,this.cache=new Map,this.frustum=new vy(t),this.extendedFrustum=new vy(t),this.intersector=new Xet({renderCoordsHelper:t}),this.renderCoordsHelper=t}begin(t,i){this.surfaceElevation=i,this.aboveGround=this.renderCoordsHelper.getAltitude(t.eye)>i,this.frustum.update(t),this._shortenFrustumFarPlane(this.frustum),this._updateExtendedFrustum(t)}end(){this.cache.clear()}calculate(t){if(this.allTilesInvisible)return to.INVISIBLE;const i=this.renderCoordsHelper.viewingMode===$e.Global&&t.lij[0]>=Jet&&t.lij[0]<Ket,r=this._getOrCalculateSingleTileVisibility(t,!i);return r!==to.INVISIBLE&&i?this._calculateAggregatedChildrenVisibility(t):r}_shortenFrustumFarPlane(t){const i=vy.nearFarLineIndices,r=t.mutablePoints;for(const s of i){const[n,o]=s,a=r[n],l=r[o];de(Al,l,a),ae(Al,Al,ttt),pe(r[o],a,Al)}t.updatePoints(r)}_calculateAggregatedChildrenVisibility(t){let i=to.INVISIBLE;const r=this.cache.get(t.id);if(r!=null)return r;const s=Gte.acquire();t.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==to.INVISIBLE&&(i=o,o===to.VISIBLE_ON_SURFACE))break}return Gte.release(s),this.cache.set(t.id,i),i}_getOrCalculateSingleTileVisibility(t,i){const r=this.cache.get(t.id);if(r!=null)return r;const s=this._calculateSingleTileVisibility(t);return i&&this.cache.set(t.id,s),s}_calculateSingleTileVisibility(t){return!this.aboveGround&&this.renderCoordsHelper.viewingMode===$e.Global&&t.lij[0]<ett?this._calculateSingleTileVisibilitySided(t,!1)===to.INVISIBLE?this._calculateSingleTileVisibilitySided(t,!0):void 0:this._calculateSingleTileVisibilitySided(t,this.aboveGround)}_calculateSingleTileVisibilitySided(t,i){this.intersector.update(t.extent,t.tilingScheme.spatialReference,this.surfaceElevation,i);const r=di(t.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,r)?this.intersector.isVisibleInFrustum(this.frustum,r,!0)?to.VISIBLE_ON_SURFACE:to.VISIBLE_WHEN_EXTENDED:to.INVISIBLE}_updateExtendedFrustum(t){this.extendedFrustum.update(t),this._shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,Al);this.aboveGround||lo(i,i);const r=Es(-_e(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible||(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this.extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this.renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this.renderCoordsHelper.worldUpAtPosition(l,Al),a){case We.FAR_BOTTOM_LEFT:case We.FAR_TOP_LEFT:case We.NEAR_BOTTOM_LEFT:case We.NEAR_TOP_LEFT:lB(this.extendedFrustum.planes[qi.LEFT],Al,Al);break;case We.FAR_BOTTOM_RIGHT:case We.FAR_TOP_RIGHT:case We.NEAR_BOTTOM_RIGHT:case We.NEAR_TOP_RIGHT:lB(this.extendedFrustum.planes[qi.RIGHT],Al,Al)}ae(Al,Al,s.direction),this.renderCoordsHelper.intersectInfiniteManifold(fc(l,Al),s.zWithMargin,l)}}if(this.extendedFrustum.updatePoints(n),ro(n[We.NEAR_BOTTOM_LEFT],n[We.NEAR_BOTTOM_RIGHT],n[We.NEAR_TOP_RIGHT],Bte),ro(n[We.NEAR_BOTTOM_RIGHT],n[We.NEAR_TOP_RIGHT],n[We.NEAR_TOP_LEFT],Vte),_e(Bte,Vte)<0){const o=this.extendedFrustum.mutablePoints;this.aboveGround?[o[We.NEAR_BOTTOM_LEFT],o[We.NEAR_BOTTOM_RIGHT]]=[o[We.NEAR_BOTTOM_RIGHT],o[We.NEAR_BOTTOM_LEFT]]:[o[We.NEAR_TOP_LEFT],o[We.NEAR_TOP_RIGHT]]=[o[We.NEAR_TOP_RIGHT],o[We.NEAR_TOP_LEFT]],this.extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this.aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const t=this.surfaceElevation-zte;return{zWithMargin:t,pointIndices:vy.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:i=>i>t}}_extendedFrustumParametersBelowSurface(){const t=this.surfaceElevation+zte;return{zWithMargin:t,pointIndices:vy.planePointIndices.top,direction:1,needsAltitudeAdjustment:i=>i<t}}}const Jet=2,Ket=6,ett=12,ttt=.95,zte=1,Al=M(),Bte=ii(),Vte=ii(),Gte=new Gr(Array,e=>{e.length!==4&&(e[0]=new Th,e[1]=new Th,e[2]=new Th,e[3]=new Th)},e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()});class itt{constructor(t){this.camera=new wi,this.focusOnMap=[0,0],this.screenRect=Dt(),this.tileSize=t.tileSize,this.renderCoordsHelper=t.renderCoordsHelper,this.tilingScheme=t.tilingScheme,this.visibility=new Qet(t.renderCoordsHelper)}begin(t,i,r){this.camera.copyFrom(t),this.surfaceElevation=r,this.focusOnMap[0]=i.x,this.focusOnMap[1]=i.y,wSe(0,0,t.fullWidth,t.fullHeight,this.screenRect),this.visibility.begin(this.camera,r)}end(){this.visibility.end()}updateTile(t){t.measures.visibility=this.visibility.calculate(t),t.measures.distance=SSe(t.extent,this.focusOnMap),t.measures.visibility!==to.INVISIBLE&&this._updateScreenMeasure(t)}_updateScreenMeasure(t){const i=rtt,r=1<<i,s=t.measures.screenRect;Tu(s);let n=0;const o=t.lij[0]+i,a=t.lij[1]<<i,l=t.lij[2]<<i,c=this._tileSizeWithBias(t),h=c*c;for(let p=0;p<r;p++)for(let f=0;f<r;f++)if(n+=this._computeScreenArea(t,o,a+p,l+f,s),n>h)return void(t.measures.shouldSplit=!0);t.measures.shouldSplit=!1}_tileSizeWithBias(t){return t.measures.visibility===to.VISIBLE_WHEN_EXTENDED?this.tileSize*stt:this.tileSize}_computeScreenArea(t,i,r,s,n){const o=t.measures.visibility===to.VISIBLE_WHEN_EXTENDED;this._projectToScreen(i,r,s,o,hg),Tu(uk);for(let a=0;a<4;a++)Ooe(uk,hg[a]);return jy(n,uk,n),FJ(hg[0],hg[1],hg[2])+FJ(hg[0],hg[2],hg[3])}_projectToScreen(t,i,r,s,n){this.tilingScheme.ensureMaxLod(t),this.tilingScheme.getExtent(t,i,r,b2),this._toRenderCoords(b2,0,3,dg[0]),this._toRenderCoords(b2,2,3,dg[1]),this._toRenderCoords(b2,2,1,dg[2]),this._toRenderCoords(b2,0,1,dg[3]),s&&(this._projectToPlane(dg,this.camera.frustum[qi.NEAR]),this._projectToPlane(dg,this.camera.frustum[qi.TOP]),this._projectToPlane(dg,this.camera.frustum[qi.BOTTOM]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(dg[o],jte),this.camera.renderToScreen(jte,n[o])}_projectToPlane(t,i){for(let s=0;s<4;s++)x2[s]=er(i,t[s]);const r=Math.max(x2[0],x2[1],x2[2],x2[3]);if(r>0){const s=ae(w2,i,-r);for(let n=0;n<4;n++)pe(t[n],t[n],s)}}_toRenderCoords(t,i,r,s){return w2[0]=t[i],w2[1]=t[r],w2[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(w2,this.tilingScheme.spatialReference,s),s}}const uk=Dt(),rtt=2,stt=5,hg=[Cr(),Cr(),Cr(),Cr()],b2=Dt(),w2=M(),dg=[M(),M(),M(),M()],x2=[0,0,0,0],jte=Nn();function sft(e,t,i){if(O(e)||O(i))return!1;let r=!0;return fs[0]=e.xmin!=null?e.xmin:0,fs[1]=e.ymin!=null?e.ymin:0,fs[2]=e.zmin!=null?e.zmin:0,r=r&&_r(fs,e.spatialReference,0,t,i,0,1),fs[0]=e.xmax!=null?e.xmax:0,fs[1]=e.ymax!=null?e.ymax:0,fs[2]=e.zmax!=null?e.zmax:0,r=r&&_r(fs,e.spatialReference,0,t,i,3,1),e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.zmin==null&&(t[2]=-1/0),e.xmax==null&&(t[3]=1/0),e.ymax==null&&(t[4]=1/0),e.zmax==null&&(t[5]=1/0),r}function cve(e,t,i){if(O(e)||O(i))return!1;let r=!0;return fs[0]=e.xmin!=null?e.xmin:0,fs[1]=e.ymin!=null?e.ymin:0,fs[2]=e.zmin!=null?e.zmin:0,r=r&&_r(fs,e.spatialReference,0,fs,i,0,1),t[0]=fs[0],t[1]=fs[1],fs[0]=e.xmax!=null?e.xmax:0,fs[1]=e.ymax!=null?e.ymax:0,fs[2]=e.zmax!=null?e.zmax:0,r=r&&_r(fs,e.spatialReference,0,fs,i,0,1),t[2]=fs[0],t[3]=fs[1],e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.xmax==null&&(t[2]=1/0),e.ymax==null&&(t[3]=1/0),r}const fs=M(),ntt=he.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let An=class extends we{constructor(e){super(e),this.tiles=new pt,this.tileSize=512,this._idToTile=new Map,this._handles=new Bt,this._clients=new Set,this._dirty=!1,this._newTiles=new $t}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(_(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void ntt.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||_(t)&&e&&t.equals(e))return;const i=_(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(O(this.filterExtent)||!this.tilingScheme)return null;const e=Dt();return cve(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],()=>this._reset(),!0)),this._handles.add(Wt(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],()=>this._setDirty(),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(ut.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Ys(this._frameWorker),this._handles=it(this._handles)}addClient(){const e=att();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(_S))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),_(this._frameWorker)&&(this._frameWorker.priority=ut.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&_(this._frameWorker)&&(this._frameWorker.priority=ut.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new itt({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map(e=>new Th(e[0],e[1],e[2],this.tilingScheme))}_purgeHorizonTiles(e){e.sort((t,i)=>{const r=t.measures.screenRect,s=i.measures.screenRect;return r[1]+r[3]-(s[1]+s[3])}),Tu(wP);for(let t=0;t<e.length;t++)if(jy(wP,e.data[t].measures.screenRect,wP),l1(wP)>ltt)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!zL(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),t.measures.visibility!==to.INVISIBLE&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(r=>{const s=this._idToTile.get(r.id);return s?(s.copyMeasurementsFrom(r),s.used=!0):this._idToTile.set(r.id,r),!s}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===to.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};u([d({constructOnly:!0})],An.prototype,"scheduler",void 0),u([d({constructOnly:!0})],An.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],An.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],An.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],An.prototype,"focus",void 0),u([d({constructOnly:!0})],An.prototype,"viewState",void 0),u([d({constructOnly:!0})],An.prototype,"terrain",void 0),u([d()],An.prototype,"tiles",void 0),u([d()],An.prototype,"tileSize",void 0),u([d({readOnly:!0})],An.prototype,"tilingScheme",null),u([d()],An.prototype,"filterExtent",null),u([d({readOnly:!0})],An.prototype,"filterExtentRect",null),u([d({readOnly:!0})],An.prototype,"rootTileIds",null),u([d({value:!1})],An.prototype,"suspended",null),u([d({readOnly:!0})],An.prototype,"updating",null),An=u([P("esri.views.3d.layers.support.FeatureTileTree3D")],An);let ott=0;function att(){return ott++}const wP=Dt(),ltt=10,uve=An;class w0{constructor(t,i){this.owner=i,this.properties={},this.afterDispatchHandle=null;for(const r in t){const s=t[r],n=new Tse(s,null,null,2,2);this.properties[r]={pool:n,acquired:[]}}this.afterDispatchHandle=Use(()=>this._release())}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const t in this.properties){const i=this.properties[t];for(const r of i.acquired)gW(r)||i.pool.release(r);i.pool.destroy(),i.pool=null,i.acquired=null}this.properties=null,this.owner=null}get(t){const i=this.owner._get(t),r=this.properties[t];let s=r.pool.acquire();for(r.acquired.push(s);s===i;)r.acquired.push(s),s=r.pool.acquire();return s}_release(){for(const t in this.properties){const i=this.properties[t];let r=0;for(const s of i.acquired)gW(s)?i.acquired[r++]=s:i.pool.release(s);i.acquired.length=r}}}let Cn=class extends we{constructor(){super(...arguments),this._propertiesPool=new w0({camera:wi},this),this._lastSeenCameraProjectionValues=new wi,this.events=new wr,this.viewingMode=$e.Global,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Nze({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new w0({camera:wi},this)}createInitialCamera(){if(this.viewingMode===$e.Global){const e=di(this.spatialReference).radius;this.camera=new wi(je(4*e,0,0),je(e,0,0),je(0,0,1))}else this.camera=new wi(je(0,0,100),je(0,0,0),je(0,1,0))}get animation(){return this.cameraController instanceof jC&&_(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Pc&&Pc.copyFrom(e),Pc.computeUp(this.viewingMode),Hte.camera=Pc,this.events.emit("before-camera-change",Hte);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Pc)&&(this._lastSeenCameraProjectionValues.copyFrom(Pc),qte.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",qte)),(!t||!t.equals(Pc))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Pc)),this._cameraChanged=!t||!t.almostEquals(Pc),this._cameraChanged)){const i=Use(()=>{this._cameraChanged=!1,i.remove()})}}get contentCamera(){return _(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=_(e)?e.clone():null}get fixedContentCamera(){return!!_(this._contentCamera)}get isGlobal(){return this.viewingMode===$e.Global}get isLocal(){return this.viewingMode===$e.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",t=>{t!==ar.Finished&&t!==ar.Stopped||(this._set("cameraController",null),this.updateCamera(i=>e.onControllerEnd(i)))},!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ar.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ar.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this.updateQueue.length===0||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();Pc.copyFrom(this._get("camera")),e(Pc),this.camera=Pc,this.processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[bt.TOP]!==t.padding[bt.TOP]||e.padding[bt.RIGHT]!==t.padding[bt.RIGHT]||e.padding[bt.BOTTOM]!==t.padding[bt.BOTTOM]||e.padding[bt.LEFT]!==t.padding[bt.LEFT]}};u([d({readOnly:!0,type:ST})],Cn.prototype,"animation",null),u([d({type:wi})],Cn.prototype,"camera",null),u([d({})],Cn.prototype,"_contentCamera",void 0),u([d({type:wi})],Cn.prototype,"contentCamera",null),u([d({readOnly:!0})],Cn.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],Cn.prototype,"constraints",void 0),u([d({readOnly:!0})],Cn.prototype,"events",void 0),u([d({readOnly:!0})],Cn.prototype,"isGlobal",null),u([d({readOnly:!0})],Cn.prototype,"isLocal",null),u([d({readOnly:!0})],Cn.prototype,"viewingMode",void 0),u([d({readOnly:!0})],Cn.prototype,"spatialReference",void 0),u([d({readOnly:!0})],Cn.prototype,"navigating",null),u([d({readOnly:!0})],Cn.prototype,"stationary",null),u([d()],Cn.prototype,"_cameraChanged",void 0),u([d()],Cn.prototype,"cameraController",null),Cn=u([P("esri.views.3d.state.ViewState")],Cn);const ctt=Cn,Pc=new wi,Hte={camera:null},qte={camera:null};function utt(e,t,i){return e===$e.Global?new dtt(i):new htt(t,i)}class htt{constructor(t,i){this.elevationProvider=t,this._referenceEllipsoid=di(i),this.unitInMeters=bl(i,this._referenceEllipsoid.metersPerDegree)}compute(t,i,r,s,n){n||(n={near:0,far:0});let o=t[2]*this.unitInMeters;const a=o,l=o-s,c=this.elevationProvider?this.elevationProvider.elevationBounds:null;c&&(o=l>=0?a-this.unitInMeters*c.min:this.unitInMeters*c.max-a);const h={x:(r=_(r)?r:new Zt({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},p=Math.max(h.x,h.y,h.z);de(av,i,t),Ub[0]=av[0]>0?r.xmax:r.xmin,Ub[1]=av[1]>0?r.ymax:r.ymin,Ub[2]=av[2]>0?p/2:-p/2,de(Ub,Ub,t),be(av,av);const f=1.1*_e(Ub,av)*this.unitInMeters,g=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),v=y*mtt*this.unitInMeters,b=y*gtt*this.unitInMeters;let w=ze((o-b)/(v-b),0,1);w*=w*w;let S=qt(g,f,w);return S*=Math.max(Math.log(Math.abs(l)),1),S=Math.min(S,Math.max(34064e4,p)),S/=this.unitInMeters,hve(S,ptt,this.unitInMeters,n)}}class dtt{constructor(t){this._referenceEllipsoid=di(t)}compute(t,i,r,s,n){n||(n={near:0,far:0});const o=Pe(t)-this._referenceEllipsoid.radius,a=this._referenceEllipsoid.radius+Math.min(0,s),l=Math.abs(o-s),c=Math.max(l,Math.abs(o));return hve(1.2*Math.sqrt(c*(c+2*a)),ze(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function hve(e,t,i,r){const s=ftt/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const ptt=2e4,ftt=2,mtt=.001,gtt=1e-4,Ub=M(),av=M();let BI=class extends we{constructor(e){super(e),this.handles=new Bt}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;ume(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>{wS(this.view,e,_u.EYE_AND_CENTER)})}};u([d({constructOnly:!0})],BI.prototype,"view",void 0),BI=u([P("esri.views.3d.state.ElevationCollisionConstraint")],BI);const ytt=BI;let jE=class extends we{constructor(e){super(e),this._handles=new Bt,this.nearFarHeuristic=utt(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],()=>this._clipDistanceNearFarChanged()),this.view.watch("constraints.clipDistance.mode",()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e.camera)),this.view.watch("renderDataExtent",()=>this._updateNearFar(),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],()=>this._updateAltitude(),!0),this.view.watch("constraints.tilt.max",()=>this._updateTiltMax(),!0),this.view.watch("constraints.tilt.mode",()=>this._updateTilt(),!0),this.view.watch("state.camera",()=>this._updateTiltAutoMax(),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],()=>this._updateCollision(),!0)]),this.view.state.isLocal&&this._handles.add(Wt(this.view,"renderDataExtent",e=>this._updateLocalSurfaceDistance(e))),this._updateNearFar(),this.view.state.viewingMode!==$e.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new ytt({view:this.view}))}destroy(){this._handles=it(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var e;const t=(e=this.view.constraints)==null?void 0:e.clipDistance;t&&t.mode!=="auto"&&this.view.state.updateCamera(i=>(this._updateCameraNearFarManual(i,t),!0))}_updateNearFar(){this.view.state.updateCamera(e=>(this._updateCameraNearFar(e),!0))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,ZN(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e,t,i;const r=(e=this.view.map)==null||(t=e.ground)==null||(i=t.navigationConstraint)==null?void 0:i.type,s=!r||r==="stay-above",n=this.view.state.constraints.collision;if(s!==n.enabled){n.enabled=s,s&&this._reapplyConstraints(Xi.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==$e.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Ct(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(pl(i))}}_updateLocalSurfaceDistance(e){if(O(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=Xi.ALL){this.view.state.updateCamera(t=>Dr(this.view,t,{selection:e,interactionType:Ot.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:Zs.TUMBLE}))}};u([d({constructOnly:!0})],jE.prototype,"view",void 0),u([d({readOnly:!0})],jE.prototype,"surfaceCollisionConstraint",void 0),jE=u([P("esri.views.3d.state.ConstraintsManager")],jE);const vtt=jE;let yx=class extends $_{constructor(e){super(e),this.handles=new Bt}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ar.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){ume(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),wS(this.view,e,_u.EYE_AND_CENTER)||this.constraintEnabled||(this.state=ar.Stopped)})}};u([d({constructOnly:!0})],yx.prototype,"view",void 0),u([d({constructOnly:!0})],yx.prototype,"desiredCamera",null),yx=u([P("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],yx);const _tt=.66;function dve(e){return 360-nG.normalize(e)}function BF(e){return nG.normalize(360-e)}function xP(e){return _(e)&&e.resolver&&e.resolver.reject(),null}function btt(e,t){return _(e)&&e.resolver&&e.resolver.resolve(t),t}function pve(e,t,i,r=null){if(!t)return xP(r);const s=e.spatialReference||tt.WGS84;if(_(t.camera)){const c=z1(t.camera.position,s);if(O(c))return xP(r);const h=t.camera.clone();return h.position=c,btt(r,h)}if(O(t.targetGeometry))return xP(r);const n=t.get("targetGeometry.spatialReference");if(n&&!Jf(n,s))return xP(r);const o=zT(e,e.state.camera);let a=kn.ADJUST;if(t.rotation!=null&&(o.heading=dve(t.rotation),a=kn.LOCKED),i!=null&&(o.tilt=i),t.targetGeometry.type==="point"){const c=t.targetGeometry;let h;const p=t.targetGeometry.clone();return h=t.scale!=null?SH(e,t.scale,c.latitude):e.state.camera.distance,Kme(e,p,h,o,a,r)}const l=t.targetGeometry.extent;return OA(e,l,o.heading,o.tilt,a,r)}function wtt(e,t,i=null){return O(i)&&(i=new Vh),bq(e,null,t.clone(),i)}async function xtt(e,t,i){const r=Itt(e,t);if(!r)throw new Q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new ml({fov:e.camera.fov}),n=new Vh({camera:s});if(r.target instanceof Vh)return lv(await Ett(e,r.target,r,i,n));if(r.target instanceof ml)return lv(mve(e,r.target,n));const o=r.scale!=null||r.zoom!=null;if(r.target instanceof Zt){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return lv(o||c?await a9(e,r,r.target.center,s,i,n):await Ott(e,r,r.target,s,i,n))}const a={boundingBox:Ui(),hasZ:!1,screenSpaceObjects:[]},l=o?Ttt(e,r):void 0;if(await fve(e,r.target,l,a),isFinite(a.boundingBox[0])){let c;if(Eh(a.boundingBox,$r),Hl.x=$r[0],Hl.y=$r[1],Hl.z=$r[2],Hl.spatialReference=e.spatialReference,isFinite(Hl.z)&&a.hasZ?c=VL(a.boundingBox):(Hl.z=void 0,c=ESe(OG(a.boundingBox,Dtt))),o||c)return lv(await a9(e,r,Hl,s,i,n));const h=$tt(e,a.screenSpaceObjects);return lv(await Ptt(e,r,Hl,a.boundingBox,h,s,i,n))}return r.position?lv(Ctt(e,r,s,n)):lv(await Rtt(e,r,s,i,n))}function vq(e,t){return t.scale==null&&t.zoom!=null?ige(e,t.zoom):t.scale}function Ttt(e,t){return o7e(e,vq(e,t))}function _q(e,t){let i=!1;return t.heading!=null?(e.heading=t.heading,i=!0):t.rotation!=null&&(e.heading=dve(t.rotation),i=!0),t.tilt!=null&&(e.tilt=t.tilt,i=!0),t.fov!=null&&(e.fov=t.fov),i}function bq(e,t,i,r){const s=e.spatialReference||tt.WGS84;return t=_(t)?t:Df(e,i),O(t)||(r.targetGeometry=n0(t.center,e.renderSpatialReference,s),r.scale=rge(e,t),r.rotation=BF(i.heading),r.camera=i),r}function lL(e,t,i){if(!t)return;if(!Jf(t.spatialReference,e.spatialReference))throw new Q("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let o;switch(t.type){case"point":o=t;break;case"multipoint":case"polyline":o=t.extent.center;break;case"mesh":o=t.origin;break;case"extent":o=t.center;break;case"polygon":o=t.centroid}o&&Jf(o,e.basemapTerrain.spatialReference)?$r[2]=gt(Mh(e.elevationProvider,o),0):$r[2]=0}(0,Ltt[t.type])(t,o=>{r.push(o[0],o[1],o[2])},$r);const s=r.length/3;if(s===0)return;const n=new Array(r.length);if(_r(r,t.spatialReference,0,n,e.spatialReference,0,s)){t.hasZ&&(i.hasZ=!0);for(let o=0;o<n.length;o+=3)t.hasZ?($r[0]=n[o+0],$r[1]=n[o+1],$r[2]=n[o+2]):($r[0]=n[o+0],$r[1]=n[o+1]),hp(i.boundingBox,$r)}}async function Stt(e,t,i,r){const s=await Bh(e.whenViewForGraphic(t));if(s.ok===!1||O(s.value)||!("whenGraphicBounds"in s.value))return void lL(e,t.geometry,r);const n=s.value,o=await Bh(n.whenGraphicBounds(t,{minDemResolution:i}));if(o.ok===!1)return void lL(e,t.geometry,r);const{screenSpaceObjects:a,boundingBox:l}=o.value;nT(r.boundingBox,l),a&&a.forEach(c=>{r.screenSpaceObjects.push(c)}),isFinite(l[2])&&(r.hasZ=!0)}async function fve(e,t,i,r){if(Array.isArray(t)&&t.length===2){const s=t[0],n=t[1];if(typeof s=="number"&&typeof n=="number")return Hl.x=s,Hl.y=n,Hl.z=void 0,Hl.spatialReference=e.spatialReference.isGeographic?e.spatialReference:tt.WGS84,void lL(e,Hl,r)}t&&typeof t.map=="function"?await Sa(t.map(s=>fve(e,s,i,r))):t instanceof fl?lL(e,t,r):t instanceof Bo&&await Stt(e,t,i,r)}async function Ett(e,t,i,r,s){if(_(t.camera))return mve(e,t.camera,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=_(t.targetGeometry)?t.targetGeometry.clone():null,s.camera=null,i.heading!=null?s.rotation=BF(i.heading):i.rotation!=null&&(s.rotation=i.rotation);const n=vq(e,i);n!=null&&(s.scale=n);const o=new SS(r);return pve(e,s,i.tilt,o),s.camera=await o.resolver.promise,s}function mve(e,t,i){const r=e.spatialReference,s=z1(t.position,r);return O(s)?null:((t=t.clone()).fov=e.camera.fov,t.position=s,bq(e,null,t,i))}function Att(e,t,i,r,s,n){const o=e.renderSpatialReference;return Qs(i.position,SP,o),Qs(t,hk,o),n.targetGeometry=new Ke(t),s.position=new Ke(i.position),de(cL,hk,SP),KN(e,SP,cL,r.up,s),n.scale=M1(e,xi(SP,hk),n.targetGeometry.latitude),n.rotation=BF(s.heading),n.camera=s,n}async function a9(e,t,i,r,s,n){if(O(i))throw new Q("createfromcenter","invalid point");n.targetGeometry=i.clone();const o=ib(e);if(t.position)return Att(e,n.targetGeometry,t,o,r,n);if(t.zoomFactor){const l=o.distance/t.zoomFactor,c=ae($r,o.viewForward,-l);o.eye=pe($r,o.center,c),n.scale=M1(e,l,i.latitude)}zT(e,o,r);const a=_q(r,t)?kn.LOCKED:kn.ADJUST;if(!t.zoomFactor){n.scale=vq(e,t),n.scale==null&&(Qs(i,$r,e.renderSpatialReference),Tme(o.frustum,$r)?n.scale=M1(e,xi(o.eye,$r),i.latitude):n.scale=rge(e,o));const l=new SS(s);Jme(e,n.targetGeometry,n.scale,r,a,l),n.camera=await l.resolver.promise}return n}function Ctt(e,t,i,r){const s=ib(e);return ne(cL,s.viewForward),KN(e,s.eye,cL,s.up,dk),i.position=new Ke(t.position),i.heading=t.heading!=null?t.heading:dk.heading,i.tilt=t.tilt!=null?t.tilt:dk.tilt,bq(e,null,i,r)}async function Rtt(e,t,i,r,s){const n=ib(e);return a9(e,t,n0(n.center,e.renderSpatialReference,e.spatialReference),i,r,s)}async function Ott(e,t,i,r,s,n){n.targetGeometry=i.clone();const o=ib(e);zT(e,o,r);const a=_q(r,t)?kn.LOCKED:kn.ADJUST,l=new SS(s);return OA(e,i,r.heading,r.tilt,a,l),n.camera=await l.resolver.promise,n}function Mtt(e,t,i,r,s){let n=0;i.hasZ?n=i.z:e.basemapTerrain&&(n=Mh(e.elevationProvider,i)),oe($r,i.x,i.y,n),Gh(e.spatialReference,$r,Wte,e.renderSpatialReference),Eu(TP,Wte),Au(TP,TP),Ui(T2);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const v=o[y];let b=r[v[2]];isFinite(b)||(b=n),oe($r,r[v[0]],r[v[1]],b),yn($r,e.spatialReference,$r,e.renderSpatialReference),hp(T2,rl($r,$r,TP))}const a=KT(T2),l=j1(T2),c=eS(T2),h=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,g=.5*l*p+.5*Math.max(a,c);return Math.max(f,g)/s}async function Ptt(e,t,i,r,s,n,o,a){a.targetGeometry=i.clone();const l=ib(e),c=Mtt(e,l,i,r,s);zT(e,l,n);const h=_q(n,t)?kn.LOCKED:kn.ADJUST;a.scale=M1(e,c,a.targetGeometry.latitude);const p=new SS(o);return Jme(e,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function Itt(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const r in t)i[r]=t[r];t.center&&!i.target&&(i.target=t.center)}return i}function lv(e){return e&&_(e.camera)&&(e.rotation=BF(e.camera.heading)),e}function $tt(e,t){const i=_tt;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){const n=t[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return i-r/Math.min(e.width,e.height)*2}const $r=M(),Wte=Te(),TP=br(),T2=os(),Dtt=Dt(),cL=M(),SP=M(),hk=M(),dk={heading:0,tilt:0},Hl=new Ke,Ltt={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),t(i)},extent(e,t,i){e.hasZ?(t(oe(i,e.xmin,e.ymin,e.zmin)),t(oe(i,e.xmax,e.ymin,e.zmin)),t(oe(i,e.xmin,e.ymax,e.zmin)),t(oe(i,e.xmax,e.ymax,e.zmin)),t(oe(i,e.xmin,e.ymin,e.zmax)),t(oe(i,e.xmax,e.ymin,e.zmax)),t(oe(i,e.xmin,e.ymax,e.zmax)),t(oe(i,e.xmax,e.ymax,e.zmax))):(t(oe(i,e.xmin,e.ymin,i[2])),t(oe(i,e.xmax,e.ymin,i[2])),t(oe(i,e.xmin,e.ymax,i[2])),t(oe(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let s=0;s<r.length;s+=3)t(oe(i,r[s+0],r[s+1],r[s+2]))}};class Ntt{constructor(t,i,r){this.target=t,this.options=i,this.view=r,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise((s,n)=>{this.resolveCallback=s,this.rejectCallback=n;const o=new AbortController;_(this.options.signal)&&co(this.options.signal,()=>{this.abort()}),this.abortController=o,this.waitForReady()})}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(pi());break;case"wait-for-animation-finish":!t&&_(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(pi())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():kce(this.view,"ready",this.abortController.signal).then(()=>{this.createViewPoint()},t=>{this.reject(t)})}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this._getAnimationController():null,xtt(this.view,this.target,this.abortController.signal).then(t=>{if(this.state==="finished")return;const i=this._getCameraFromViewpoint(t);if(!O(i))if(this.options.animate){if(O(this.animationController))return;this.startAnimation(i,this.animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},t=>{this.reject(t)}))}_getCameraFromViewpoint(t){const i=!!(this.target instanceof Vh&&this.target.camera||this.target instanceof ml),r=t.camera;if(O(r))return null;if(!this.view.stateManager.isCompatible(r)){const n=r.position,o=n&&n.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference.wkid;return this.reject(new Q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:r})),null}const s=Df(this.view,r);return O(s)?(this.reject(new Q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:t,camera:s,isFullySpecified:i}}startAnimation(t,i){this.state="wait-for-animation-finish";const r=i.viewAnimation;if(O(r))return void this.reject(new Q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(t.viewpoint,"running"),!i.active||O(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let s;t.isFullySpecified?(s=new yx({view:this.view,desiredCamera:t.camera}),wS(this.view,t.camera,_u.EYE_AND_CENTER)):Dr(this.view,t.camera),i.begin(t.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof Zf&&_(a.viewAnimation)&&a.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=s):_(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&i.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!O(this.view.state))switch(i.state){case ar.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case ar.Ready:case ar.Rejected:case ar.Running:case ar.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};r.when(n,a=>o(a)),i.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let t,i=null;const r=this.view.state.cameraController;return r instanceof Zf&&(r.updateStateFromViewAnimation(),r.active&&(t=r,i=t.viewAnimation)),t!=null||(t=new Zf({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(_(i)&&i.stop(),this.reject(new Q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const Ic=he.getLogger("esri.views.3d.state.ViewStateManager");let Kn=class extends we{constructor(e){super(e),this.propertiesPool=new w0({frustum:vy},this),this.handles=new Bt,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=zT(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(Df(this.view,e),{applyConstraints:!1})||Ic.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=zT(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Df(this.view,e);O(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=aa(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())}),this.watch("zoom",n=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}),this.view.state.watch("camera",n=>{const o=ko(r,n.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Ic.error("#center=","Invalid center",e):Ic.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Ic.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=t7e(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return _(t)?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Ic.error("#extent=","Invalid extent",e):Ic.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Ic.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return M1(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Ic.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[bt.TOP]/i),n=Math.round(t[bt.RIGHT]/i),o=Math.round(t[bt.BOTTOM]/i),a=Math.round(t[bt.LEFT]/i);return r!=null&&r.top===s&&r.right===n&&r.bottom===o&&r.left===a?r:{top:s,right:n,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,EP),this.view.state.updateCamera(t=>t.padding=EP))}_paddingToArray(e,t,i){e?zo(i,e.top||0,e.right||0,e.bottom||0,e.left||0):zo(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return zh((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?wtt(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Ic.error("#viewpoint=","Invalid viewpoint",e);else{const t=_(e.camera)?e.camera.position:e.targetGeometry,i=_(t)&&t.spatialReference;Ic.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else Ic.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?tge(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Ic.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([mp(this.view,"state.events","before-camera-change",e=>this._updateElevation(e.camera))]),pMe(this.view.state,"camera",e=>this._updateElevation(e),!0),this.handles.add(e1({prepare:()=>this._prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",()=>{this.cameraSetByUser=!0,this.handles.remove(AP)})),this.handles.add(mp(this.view,"state.events","camera-projection-changed",()=>this.notifyChange("scale")))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new vtt({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const t=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===$e.Local&&this.handles.add(kce(this.view.basemapTerrain,"ready",()=>{this.handles.remove(AP),this._setInitialView(this.view.dataExtent)}),AP)}}deinit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(AP),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i=I({animate:!0},t);return _(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new Ntt(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(ib(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera(r=>{i.stepController(e,r)}),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){_(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of ktt){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(O(e)||this.cameraSetByUser)return;if(e instanceof ml)return void this.setStateCamera(Df(this.view,e),{applyConstraints:!1});if(e instanceof Vh){if(e.targetGeometry instanceof Zt){const s=OA(this.view,e.targetGeometry,0,.5,kn.LOCKED);return void(_(s)&&this.setStateCamera(Df(this.view,s),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=OA(this.view,e,0,.5,kn.LOCKED);_(t)&&this.setStateCamera(Df(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Utt.indexOf(e)!==-1&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!O(e)&&(e instanceof Vh?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof ml?this.isCompatible(e.position):e.spatialReference&&Jf(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=ztt){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=pg){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=qC(this.view,r,s,e,t,kn.ADJUST);return O(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=OA(this.view,e,t,i,kn.ADJUST,Btt);return _(r)?Df(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=SH(this.view,e,r);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(ige(this.view,e))}_viewpointToCamera(e){return Df(this.view,pve(this.view,e))}setStateCamera(e,t){return!(O(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&Dr(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new yx({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;_(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(r!==0&&s!==0&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const n=this.view.state.camera;n.fullWidth===r&&n.fullHeight===s&&n.pixelRatio===i||(pg.copyFrom(n),pg.pixelRatio!==i&&(this._paddingToArray(this.padding,i,EP),pg.padding=EP),pg.fullWidth=r,pg.fullHeight=s,pg.pixelRatio=i,this.view.state.camera=pg)}}_updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?ZN(this.view,e.eye):0;e.relativeElevation=i-r}};u([d({type:ml,dependsOn:["view.state.camera","ready"]})],Kn.prototype,"camera",null),u([d({type:ml,dependsOn:["view.state.contentCamera","ready"]})],Kn.prototype,"contentCamera",null),u([d({type:Ke})],Kn.prototype,"center",null),u([d({type:Zt})],Kn.prototype,"extent",null),u([d({readOnly:!0})],Kn.prototype,"frustum",null),u([d({readOnly:!0})],Kn.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],Kn.prototype,"ready",void 0),u([d({type:Number})],Kn.prototype,"scale",null),u([d()],Kn.prototype,"padding",null),u([d({readOnly:!0})],Kn.prototype,"screenCenter",null),u([d({constructOnly:!0})],Kn.prototype,"view",void 0),u([d({type:Vh})],Kn.prototype,"viewpoint",null),u([d({type:Number})],Kn.prototype,"zoom",null),u([d({constructOnly:!0})],Kn.prototype,"updateDevicePixelRatio",void 0),Kn=u([P("esri.views.3d.state.ViewStateManager")],Kn);const Ftt=Kn,Utt=["camera","viewpoint","extent","scale","center","zoom"],ktt=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],ztt={heading:0,tilt:0},Btt=new ml,pg=new wi,EP=ni(),AP="pending-initial-view";class Vtt{constructor(t,i,r){this.viewingMode=t,this._forEachLayer=i,this.view=r,this.externalIntersectionHandlers=new $t,this.tolerance=kT,this.tmpRay=Fn(),this.validateHUDIntersector=Ou(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(t,i){return this.intersectRay(this._getPickRay(t,this.tmpRay),Xte(this.viewingMode),i)}intersectScreenFreePointFallback(t,i){return this.intersectRayFreePointFallback(this._getPickRay(t,this.tmpRay),i)}intersectRayFreePointFallback(t,i){return this.intersectRay(t,Xte(this.viewingMode),i)||this._intersectRayFreePointLocal(t,i)}intersectRay(t,i,r,s){return i.options.selectionMode=!1,i.options.store=Bn.MIN,this.computeIntersection(t,i,s),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(t,i,r=.5,s=.5){return t.getRenderCenter(OP,r,s),OP[0]+=.0466,OP[1]-=.0123,yH(t,OP,i)}intersectIntersectorScreen(t,i,r){this.computeIntersection(this._getPickRay(t,this.tmpRay),i,r)}intersectToolIntersectorScreen(t,i,r){const s=this._getPickRay(t,this.tmpRay);this.intersectToolIntersectorRay(s,i,r)}intersectToolIntersectorRay(t,i,r){i.options.selectionMode=!0,this.computeIntersection(t,i,r);const s=i.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||Mp(s)&&s.intersector!==lr.TERRAIN||(i.options.selectionMode=!1,this.computeIntersection(t,i,r))}setTolerance(t=kT){this.tolerance=t}addIntersectionHandler(t){this.externalIntersectionHandlers.push(t),this.externalIntersectionHandlers.sort((i,r)=>i.type===lr.TERRAIN?1:r.type===lr.TERRAIN?-1:0)}removeIntersectionHandler(t){this.externalIntersectionHandlers.removeUnordered(t),this.externalIntersectionHandlers.sort((i,r)=>i.type===lr.TERRAIN?1:r.type===lr.TERRAIN?-1:0)}_getPickRay(t,i){const r=this.view.state.camera;return Ame(r,t,i)}_intersectRayFreePointLocal(t,i){if(this.viewingMode!==$e.Local||O(t))return!1;const r=this.view.renderDataExtent;if(O(r))return pe(i,t.origin,be(Le.get(),t.direction)),!0;const s={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},n=Math.max(s.x,s.y,s.z);if(n===0)return pe(i,t.origin,be(Le.get(),t.direction)),!0;const o=this.view.state.camera,a=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),c=Math.sqrt(a*a+l*l),h=Math.abs(o.relativeElevation)+Number.MIN_VALUE,p=Math.max(0,Math.log(n/h))**2;let f=n/Math.max(1,p);f=Math.max(f,Math.min(c,n));const g=ae(Le.get(),t.direction,f/Pe(t.direction));return pe(i,t.origin,g),!0}intersectElevationFromScreen(t,i,r=0,s=null){return this._intersectElevation(this._getPickRay(t,this.tmpRay),i,r,s)}_intersectElevation(t,i,r=0,s=null){if(O(t))return null;const n=_(i)?i.mode:"absolute-height",o=_(i)?gt(i.offset,0):0,a=n!=="on-the-ground"?o+r:0,l=a/this.view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this.view.renderCoordsHelper.intersectInfiniteManifold(t,a,RP)){const S=this.view.computeMapPointFromVec3d(RP);return S.z-=o,S}return null}const c=this.view.state.camera,h=Le.get();c.projectToRenderScreen(t.origin,h);const p=new Yte(null,this._forEachLayer),f=this.view.slicePlane,g=_(f)?rK(f):null,y=Ou(this.viewingMode);y.options.store=Bn.MIN,y.options.verticalOffset=l;const v=t.origin,b=pe(Le.get(),v,t.direction);y.reset(v,b,c),y.point=h;const w=_(s)?"type"in s&&s.type==="graphics"?S=>S.metadata.layerUid!==s.uid:S=>S.metadata.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":{const S=T=>(O(w)||w(T))&&T.metadata&&T.metadata.isElevationSource;y.intersect(p.layers,h,this.tolerance,null,S),this.externalIntersectionHandlers.forAll(T=>{if(T.type===lr.I3S||T.type===lr.TERRAIN){const A=T.slicePlaneEnabled?g:null;T.intersect(y,A,y.rayBegin,y.rayEnd,h)}})}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll(S=>{if(S.isGround){const T=S.slicePlaneEnabled?g:null;S.intersect(y,T,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint(RP)){const S=this.view.computeMapPointFromVec3d(RP);return S.z=r,S}return null}computeIntersection(t,i,r){if(O(t))return;const s=this.view.state.camera,n=Le.get();s.projectToRenderScreen(t.origin,n);const o=new Yte(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const a=t.origin,l=pe(Le.get(),t.origin,t.direction);i.reset(a,l,s),i.intersect(o.layers,n,this.tolerance);const c=this.view.slicePlane,h=_(c)?rK(c):null;i.intersect(o.sliceableLayers,n,this.tolerance,h);const p=r&&(r.requiresGroundFeedback||r.enableDraped);this.externalIntersectionHandlers.forAll(y=>{if(i.options.isFiltered=!o.filterLayerUid(y.layerUid),y.isGround&&p||!i.options.isFiltered){const v=y.slicePlaneEnabled?h:null;y.intersect(i,v,a,l,n)}});const f=Le.get();if(r&&r.enableDraped&&i.results.ground.getIntersectionPoint(f)){const y=this.view.basemapTerrain.overlayManager.renderer,v=this.view.renderCoordsHelper.spatialReference,b=Le.get();this.view.renderCoordsHelper.fromRenderCoords(f,b,this.view.spatialReference),b[2]=gt(this.view.elevationProvider.getElevation(f[0],f[1],f[2],v,"ground"),0),y.intersect(i,b,i.results.ground,w=>o.filterRenderGeometry(w))}i.sortResults();const g=i.results.hud;if(oH(g)){const y=Le.get(),v=Le.get(),b=Le.get();this._unprojectHUDResultRay(g.target.center,y,v,b);const w=xi(g.target.center,v)/xi(v,b)*.99;this.validateHUDIntersector.reset(v,b,s),this.validateHUDIntersector.intersect(o.layers,y,this.tolerance),this.validateHUDIntersector.intersect(o.sliceableLayers,y,this.tolerance,h),this.externalIntersectionHandlers.forAll(T=>{if(!o.filterLayerUid(T.layerUid))return;const A=T.slicePlaneEnabled?h:null;T.intersect(this.validateHUDIntersector,A,v,b,y)});const S=this.validateHUDIntersector.results.min;(S.dist==null||w<=S.dist)&&(i.results.min.copy(g),i.results.all.splice(0,0,g))}}_unprojectHUDResultRay(t,i,r,s){const n=this.view.state.camera;n.projectToRenderScreen(t,i);const o=Le.get();o[0]=i[0],o[1]=i[1],o[2]=0,n.unprojectFromRenderScreen(o,r),o[2]=1,n.unprojectFromRenderScreen(o,s)}}let CP;function Xte(e){return CP&&CP.viewingMode===e||(CP=Ou(e)),CP}class Yte{constructor(t,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=t==null?void 0:t.include,this.exclude=t==null?void 0:t.exclude,i(r=>{r.isPickable&&this.filterLayerUid(r.apiLayerUid)&&(r.isSliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(t){const{include:i,exclude:r}=this;return O(t)?i==null&&r==null:(i==null||i.has(t))&&(r==null||!r.has(t))}filterRenderGeometry(t){return this.filterLayerUid(t.layerUid)}}function Zte(e){return typeof e=="object"&&"intersect"in e}const RP=M(),OP=Nn();class nft{constructor(t,i){this.spatialReference=t,this.view=i}getElevation(t,i,r){return this.view.elevationProvider.getElevation(t,i,0,this.spatialReference,r)}async queryElevation(t,i,r,s,n){return this.view.elevationProvider.queryElevation(t,i,0,this.spatialReference,n,r,s)}}class Gtt{constructor(t,i,r,s){this.spatialReference=i,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions=me(I({},s),{ignoreInvisibleLayers:!0}),this._frameTask=t.registerTask(ut.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(t,i,r,s=0){return new Promise((n,o)=>{const a={x:t,y:i,minDemResolution:s,result:{resolve:n,reject:o},signal:r};this._queries.push(a),co(r,()=>{I9(this._queries,a),o(pi())})})}get running(){return this._queries.length>0}runTask(){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return void t.forEach(c=>c.result.reject());const r=t.map(c=>[c.x,c.y]),s=t.reduce((c,h)=>Math.min(c,h.minDemResolution),1/0),n=new B1({points:r,spatialReference:this.spatialReference}),o=t.length>1&&t.some(c=>!!c.signal)?new AbortController:null,a=_(o)?o.signal:t[0].signal;if(_(o)){let c=0;t.forEach(h=>co(h.signal,()=>{c++,h.result.reject(pi()),c===t.length&&o.abort()}))}const l=me(I({},this._queryOptions),{minDemResolution:s,signal:a});i.queryElevation(n,l).then(c=>{t.forEach((h,p)=>{_(h.signal)&&h.signal.aborted?h.result.reject(pi()):h.result.resolve(c.geometry.points[p][2])})}).catch(c=>{t.forEach(h=>h.result.reject(c))})}get test(){const t=this;return{update:()=>t._queries.length>0&&t.runTask()}}}let HE=class extends wr.EventedMixin(we){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=it(this._elevationQuery)}get elevationQuery(){return O(this._elevationQuery)&&(this._elevationQuery=new Gtt(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&i===o.z&&r.equals(o.spatialReference)&&s===o.queryContext)return o.result}let n=null;return n=MP(n,this.im,e,t,i,r,s),O(n)&&(n=MP(n,this.ground,e,t,i,r,s)),s==="scene"&&(n=MP(n,this.scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}queryElevation(e,t,i,r,s,n=null,o=0){const a=um();return this.elevationQuery.queryElevation(e,t,n,o).then(l=>{s==="scene"&&(l=MP(l,this.scene,e,t,i,r,s)),a.resolve(l)}).catch(l=>{vr(l)?a.reject(l):a.resolve(this.getElevation(e,t,i,r,s))}),a.promise}register(e,t){this.handles.set(t,t.on("elevation-change",i=>this.emit("elevation-change",i))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function MP(e,t,i,r,s,n,o){for(const a of t){const l=a.getElevation(i,r,s,n,o);_(l)&&(e=_(e)?Math.max(l,e):l)}return e}u([d({constructOnly:!0})],HE.prototype,"view",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],HE.prototype,"spatialReference",void 0),HE=u([P("esri.views.3d.support.CombinedElevationProvider")],HE);class zy{static isValidProfile(t){return t in zy.profiles}static getDefaultProfile(){return ue("trident")||ue("esri-iPhone")?"low":"medium"}static apply(t,i){const r=zy.profiles[t];i.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,i.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable;{const s=i.sceneService["3dObject"],n=r.sceneService["3dObject"];s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration}i.sceneService.point.lodFactor=r.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=r.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,i.heatmap.pixelRatio=r.heatmap.pixelRatio,i.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,i.antialiasingEnabled=r.antialiasingEnabled,i.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,i.highQualityTransparency=r.highQualityTransparency,i.memoryLimit=r.memoryLimit,i.additionalCacheMemory=r.additionalCacheMemory,i.frameRate=r.frameRate,i.maximumRenderResolution=r.maximumRenderResolution,i.maximumPixelRatio=r.maximumPixelRatio}}function Qte(){const e=!!ue("esri-mobile"),t=!!ue("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ue("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ue("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}zy.debug={reset(){const e=Qte();for(const t in e)zy.profiles[t]=e[t]}},function(e){e.profiles=Qte()}(zy||(zy={}));const VI=zy;function wq(){return new Float32Array(4)}function jtt(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function xa(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Htt(e,t){return new Float32Array(e,t,4)}function gve(){return wq()}function yve(){return xa(1,1,1,1)}function vve(){return xa(1,0,0,0)}function _ve(){return xa(0,1,0,0)}function bve(){return xa(0,0,1,0)}function wve(){return xa(0,0,0,1)}const qtt=gve(),Wtt=yve(),Xtt=vve(),Ytt=_ve(),Ztt=bve(),Qtt=wve();Object.freeze({__proto__:null,create:wq,clone:jtt,fromValues:xa,createView:Htt,zeros:gve,ones:yve,unitX:vve,unitY:_ve,unitZ:bve,unitW:wve,ZEROS:qtt,ONES:Wtt,UNIT_X:Xtt,UNIT_Y:Ytt,UNIT_Z:Ztt,UNIT_W:Qtt});let Ld=class extends we{constructor(){super(...arguments),this.color=new Qe([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new Qe([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=Qe.toUnitRGBA(e.color),i=_(e.haloColor)?Qe.toUnitRGBA(e.haloColor):t,r=Qe.toUnitRGBA(e.shadowColor);return{color:xa(t[0],t[1],t[2],t[3]),haloColor:xa(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:xa(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};u([d({type:Qe})],Ld.prototype,"color",void 0),u([d({type:Qe})],Ld.prototype,"haloColor",void 0),u([d()],Ld.prototype,"haloOpacity",void 0),u([d()],Ld.prototype,"fillOpacity",void 0),u([d()],Ld.prototype,"shadowOpacity",void 0),u([d({type:Qe})],Ld.prototype,"shadowColor",void 0),u([d()],Ld.prototype,"shadowDifference",void 0),Ld=u([P("esri.views.3d.support.HighlightOptions")],Ld);const l9=Ld;function oft(e){return{geometryType:x0(e[0]),geometries:e.map(t=>t.toJSON())}}function Jtt(e,t,i){const r=Wne(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}let e_=class extends ve{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(function(r){return r.toJSON()}),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:x0(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],e_.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],e_.prototype,"outSpatialReference",void 0),u([d()],e_.prototype,"transformation",void 0),u([d()],e_.prototype,"transformForward",void 0),e_=u([P("esri.rest.support.ProjectParameters")],e_);const xq=e_,Ktt=ns(xq);async function xve(e,t,i){t=Ktt(t);const r=wc(e),s=I(me(I({},r.query),{f:"json"}),t.toJSON()),n=t.outSpatialReference,o=x0(t.geometries[0]),a=F3e(s,i);return Ci(r.path+"/project",a).then(({data:{geometries:l}})=>Jtt(l,o,n))}async function Tq(e=null,t){var i,r;if(zi.geometryServiceUrl)return zi.geometryServiceUrl;if(!e)throw new Q("internal:geometry-service-url-not-configured");let s;s="portal"in e?e.portal||gl.getDefault():e,await s.load({signal:t});const n=(i=s.helperServices)==null||(r=i.geometry)==null?void 0:r.url;if(!n)throw new Q("internal:geometry-service-url-not-configured");return n}async function eit(e,t,i=null,r){const s=await Tq(i,r),n=new xq;n.geometries=[e],n.outSpatialReference=t;const o=await xve(s,n,{signal:r});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new Q("internal:geometry-service-projection-failed")}var tit=Object.freeze(Object.defineProperty({__proto__:null,getGeometryServiceURL:Tq,projectGeometry:eit},Symbol.toStringTag,{value:"Module"}));class iit{constructor(t,i){this.spatialReference=i,this.unitInMeters=bl(this.spatialReference,di(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=Tq(t&&t.get("portalItem")).catch(()=>{throw new Q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(t){const i=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(t[0])&&typeof t[0]!="number"?r=t:(r=[t],s=!1);const n=r.map(l=>l instanceof Ke?l:new Ke(l,this.spatialReference)),o=new xq({geometries:n,outSpatialReference:tt.WGS84}),a=(await xve(i,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0);return s?a:a[0]}}let Vd=class extends we{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};u([d()],Vd.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Vd.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Vd.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Vd.prototype,"snapshotAvailable",void 0),u([d()],Vd.prototype,"polygonLodFactor",void 0),u([d()],Vd.prototype,"polylineLodFactor",void 0),Vd=u([P("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Vd);let np=class extends we{constructor(){super(...arguments),this.lodFactor=1}};u([d()],np.prototype,"lodFactor",void 0),np=u([P("esri.views.3d.support.QualitySettings.LoDFactorSettings")],np);let uL=class extends np{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};uL=u([P("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],uL);let Nf=class extends we{constructor(){super(...arguments),this["3dObject"]=new uL,this.point=new np,this.integratedMesh=new np,this.pointCloud=new np,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:uL})],Nf.prototype,"3dObject",void 0),u([d({type:np})],Nf.prototype,"point",void 0),u([d({type:np})],Nf.prototype,"integratedMesh",void 0),u([d({type:np})],Nf.prototype,"pointCloud",void 0),u([d()],Nf.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Nf=u([P("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Nf);let hy=class extends we{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};u([d()],hy.prototype,"lodBias",void 0),u([d()],hy.prototype,"angledSplitBias",void 0),u([d()],hy.prototype,"reduceTileLevelDifferences",void 0),u([d()],hy.prototype,"textureFadeDuration",void 0),hy=u([P("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],hy);let vx=class extends we{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],vx.prototype,"pixelRatio",void 0),u([d()],vx.prototype,"maxTotalNumberOfFeatures",void 0),vx=u([P("esri.views.3d.support.QualitySettings.HeatmapSettings")],vx);let ea=class extends we{constructor(){super(...arguments),this.graphics3D=new Vd,this.sceneService=new Nf,this.tiledSurface=new hy,this.heatmap=new vx,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};u([d({type:Vd})],ea.prototype,"graphics3D",void 0),u([d({type:Nf})],ea.prototype,"sceneService",void 0),u([d({type:hy})],ea.prototype,"tiledSurface",void 0),u([d({type:vx})],ea.prototype,"heatmap",void 0),u([d()],ea.prototype,"antialiasingEnabled",void 0),u([d()],ea.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],ea.prototype,"highQualityTransparency",void 0),u([d()],ea.prototype,"memoryLimit",void 0),u([d()],ea.prototype,"additionalCacheMemory",void 0),u([d()],ea.prototype,"frameRate",void 0),u([d()],ea.prototype,"maximumRenderResolution",void 0),u([d()],ea.prototype,"maximumPixelRatio",void 0),ea=u([P("esri.views.3d.support.QualitySettings.QualitySettings")],ea);const Jte=ea;class hL{constructor(t,i,r,s){this.viewingMode=t,this.spatialReference=i,this.unitInMeters=r,this.coordinateSystem=s,this._coordinateSystem=xRe(s)}set extent(t){t&&TRe(this.coordinateSystem,t,this.coordinateSystem)}getAltitude(t){return PRe(this.coordinateSystem,t)}setAltitude(t,i,r=t){return ace(this.coordinateSystem,r,i,t)}setAltitudeOfTransformation(t,i){IRe(this.coordinateSystem,i,t,i)}worldUpAtPosition(t,i){return CRe(this.coordinateSystem,t,i)}worldBasisAtPosition(t,i,r){return RRe(this.coordinateSystem,t,i,r)}basisMatrixAtPosition(t,i){const r=this.worldBasisAtPosition(t,ac.X,Le.get()),s=this.worldBasisAtPosition(t,ac.Y,Le.get()),n=this.worldBasisAtPosition(t,ac.Z,Le.get());return Ep(i,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),i}intersectManifoldClosestSilhouette(t,i,r){return N4(this.coordinateSystem,i,this._coordinateSystem),MRe(this._coordinateSystem,t,r),r}intersectManifold(t,i,r){N4(this.coordinateSystem,i,this._coordinateSystem);const s=Le.get();return ORe(this._coordinateSystem,t,s)?ne(r,s):null}intersectInfiniteManifold(t,i,r){if(this.viewingMode===$e.Global)return this.intersectManifold(t,i,r);N4(this.coordinateSystem,i,this._coordinateSystem);const s=this._coordinateSystem.value,n=Le.get();return X1(s.plane,t,n)?ne(r,n):null}toRenderCoords(t,i,r){return _D(t)?Qs(t,i,this.spatialReference):yn(t,i,r,this.spatialReference)}fromRenderCoords(t,i,r=null){return _D(i)?(_(r)&&(i.spatialReference=r),ale(t,this.spatialReference,i)):i instanceof tt?n0(t,this.spatialReference,i):yn(t,this.spatialReference,i,r)?i:null}static create(t,i){switch(t){case $e.Local:return new hL($e.Local,i,bl(i),ARe());case $e.Global:return new hL($e.Global,i,1,ERe(i))}}static renderUnitScaleFactor(t,i){return Kte(t)/Kte(i)}}function Kte(e){if(BD(e,$e.Global))return 1;const t=lce(!1,e);return bl(t)}var Jd;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"})(Jd||(Jd={}));const rit=(()=>{const e=new Array;return e[Jd.ELEVATION]=10,e[Jd.BASEMAP]=10,e[Jd.I3S_INDEX]=10,e[Jd.I3S_DATA]=10,e[Jd.SYMBOLOGY]=5,e})(),sit=30;function Tve(e){return typeof e.getUsedMemory=="function"}const nit=he.getLogger("esri.views.3d.support.MemoryController");function oit(e){return new cit(e)}const PP=1,pk=1,ait=.75,lit=.6,eie=1.3;class cit{constructor(t){this._view=t,this.events=new wr,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new uj,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}newCache(t,i){return new ZNe(t,this._cacheStorage,i)}set maxMemory(t){t!=null&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(PP),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){t!=null&&t>=0&&(this._additionalCacheMemory=t)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<lit&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(PP);else if(t)(this._memoryPredicted>1.1*pk||this._memoryUsed>pk)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/eie),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>pk)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/eie),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<ait&&this._quality<PP){this._stableQuality=this._quality;const i=.05;t=this._updateQuality(this._quality+i)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating))}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),PP))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some(t=>!!t.updating)}_updateMemory(){let t=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const r=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;_(r)&&(t+=r.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach(a=>{if(Tve(a)){const l=a.ignoresMemoryFactor()?this._quality:1;t+=a.getUsedMemory()*l,i+=a.getUnloadedMemory()*l}});const s=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this._maxMemory;if(t>n&&s){this._warnMemoryUsage=t;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);nit.warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(t)} Projected: ${a(t+i)} Quality: ${l}%`)}this._memoryUsed=t/n,this._memoryPredicted=(t+i)/n;const o=n-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const i=t._numQualityChanges;return t._numQualityChanges=0,i}}}}class uit{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0}}class hit{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new dit}}class dit{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class pit{constructor(t,i,r,s){this._workerFunc=t,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(n=>new hit(n))}hasQuota(t){const i=this._clients[t];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(t){const i=this._clients[t.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,(r,s)=>this._taskCallback(r,s))):i.tasks.push(t))}cancel(t){this._taskFinished(t),t._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(t){const i=this._clients[t.client];this._totalNumWorkers--,i.numWorkers--,i.statistics.requests++,i.statistics.size+=t.size||0,i.statistics.duration+=t.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,ot(i.numWorkers>=0),this._next()}_next(){for(const t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(const t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return t.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(t,i){t._cancelled||(this._callbackFunc(t,i),this._taskFinished(t))}getStatsForType(t){const i=this._clients[t];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){const t=this;return{set workerFunc(i){t._workerFunc=i}}}}let GI=class extends we{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new pit((r,s)=>this._startLoading(r,s),(r,s)=>this._doneLoadingCB(r,s),e,t),i&&(this._frameTask=i.registerTask(ut.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Ys(this._frameTask),this._tasks.forEach(e=>xu(e.abortController)),this._loadQueue=it(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=um();s.__signal=_(r)?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,s);return co(r,()=>this._cancelRequest(n,s)),s.promise}_createTask(e,t,i,r,s,n){const o=new git(e,t,i,r,s);return this._updateTask(o,n),this._tasks.set(s,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){xL(e.resolvers,t),t.reject(pi()),e.resolvers.length===0&&(e.status===Jc.DOWNLOADING&&(e.status=Jc.CANCELLED,this._loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=Jc.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=yit(_(r)&&r.uid||e,t,i),o=this._tasks.get(n);return o?(this._updateTask(o,s),o):this._createTask(e,r,t,i,n,s)}_doneLoadingCB(e,t){this._loadQueue&&(ot(e.status===Jc.DOWNLOADING),e.status=Jc.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();Jt(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==Jc.DOWNLOADED&&(t.err=t.err||pi()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!vr(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)vr(t)?r.reject(t):r.reject(new Q("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const s=i<=0?e.result:se(e.result);r.resolve(s)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===Jc.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=Jc.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=Ci(e.url,me(I({},e.options),{responseType:r,timeout:i,signal:s}));let n=()=>{};const o=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=l=>{e.status===Jc.DOWNLOADING&&t(e,l),n()};return e.docType!=="image+type"?(e.request.then(l=>o(l.data),a),!0):(e.request.then(l=>{const c=l.data,h=mit(c);if(r="image",e.size=c.byteLength,h==="unknown")return e.request=Ci(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then(g=>o(g.data),a);const p=new Blob([c],{type:h}),f=window.URL.createObjectURL(p);n=()=>window.URL.revokeObjectURL(f),e.request=Ci(f,{responseType:r,timeout:i,signal:s}),e.request.then(g=>o(new oR(g.data,h,n)),a)},a),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],GI.prototype,"updating",void 0),GI=u([P("esri.views.3d.support.StreamDataLoader")],GI);const fit={numRetries:0};function mit(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return t[0]===137&&t[1]===80?"image/png":t[0]===71&&t[1]===73?"image/gif":t[0]===66&&t[1]===77?"image/bmp":t[0]===255&&t[1]===216?"image/jpeg":"unknown"}class oR{constructor(t,i,r){this.image=t,this.type=i,this.release=r}get isOpaque(){return this.type==="image/jpeg"}}class git extends uit{constructor(t,i,r,s,n){super(s),this.url=t,this.options=i,this.docType=r,this.key=n,this.result=null,this.status=Jc.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=fit.numRetries}}function yit(e,t,i){return`${e}:${t}:${i}`}var Jc;(function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"})(Jc||(Jc={}));let IP=class extends we{constructor(){super(...arguments),this.updating=!1}};function vit(e,t=()=>performance.now()){return new c9.ResourceController({view:e,now:t})}var c9;u([d({readOnly:!0})],IP.prototype,"updating",void 0),IP=u([P("esri.views.3d.support.ResourceController")],IP),function(e){let t=class extends IP{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new Bt,this._frameTask=null,this._scheduleTask=TT,this._state=js.IDLE}initialize(){this._cameraChangeTime=this.now(),this._scheduler=cze(this.now),this._memoryController=oit(this.view),this._streamDataLoader=new GI,this._streamDataLoader.setup(sit,rit,this._scheduler),this._handles.add([this.view.watch("state.camera",(r,s)=>this._cameraChangedHandler(r,s),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]),this._frameTask=e1({update:r=>this._frame(r)}),this._scheduleTask=this._scheduler.registerTask(ut.RESOURCE_CONTROLLER)}destroy(){this._handles=it(this._handles),this._scheduleTask.remove(),this._frameTask=Ys(this._frameTask),this._streamDataLoader=it(this._streamDataLoader),this._memoryController=it(this._memoryController),this._scheduler=it(this._scheduler)}get updating(){var r,s;return!!((r=this._memoryController)!=null&&r.updating||(s=this._streamDataLoader)!=null&&s.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(r,s,n){return this._scheduleTask.schedule(r,s,n)}createStreamDataRequester(r){const s=this._streamDataLoader;return{request:(n,o,a)=>s.request(n,o,r,a),get busy(){return!s.hasDownloadSlots(r)}}}_frame(r){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Rse(r.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(r)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(r,s){r&&s&&r.almostEquals(s)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=js.ANIMATING:this.view.interacting?this._state=js.INTERACTING:(this._state===js.ANIMATING&&(this._cameraChangeTime=0),this._scheduler.now-this._cameraChangeTime<=i?this._state=js.INTERACTING:this._state=js.IDLE)}get test(){return{getQueueStats:r=>this._streamDataLoader.test.loadQueue.getStatsForType(r),state:this._state}}};u([d({constructOnly:!0})],t.prototype,"view",void 0),u([d({constructOnly:!0})],t.prototype,"now",void 0),u([d()],t.prototype,"_scheduler",void 0),u([d()],t.prototype,"_memoryController",void 0),u([d()],t.prototype,"_streamDataLoader",void 0),u([d({readOnly:!0})],t.prototype,"updating",null),t=u([P("esri.views.3d.support.ResourceController")],t),e.ResourceController=t;const i=300}(c9||(c9={}));function _it(e){return"performanceInfo"in e}const kb=M(),bit=M(),qp=M(),Wp=M();function wit(e,t,i=0){const r=e.extent;if(O(r))return!1;if(i===0)return CG(r,t);const s=Math.min(r[2]-r[0],r[3]-r[1]);return TSe(r,t,i*s)}function $P(e,t,i,r){ne(kb,i),kb[r]=t[r];const s=de(kb,kb,t),n=de(bit,e,t),o=_e(n,s),a=_e(s,s);let l;l=o<=0?t:a<=o?i:pe(kb,t,ae(s,s,o/a));const c=de(kb,e,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function xit(e,t,i){const r=e.extent;if(O(r))return 0;qp[0]=r[0],qp[1]=r[1],qp[2]=i,Wp[0]=r[2],Wp[1]=r[3],Wp[2]=i;let s=1/0,n=1/0;return t[0]<qp[0]?s=$P(t,qp,Wp,0):t[0]>Wp[0]&&(s=$P(t,Wp,qp,0)),t[1]<qp[1]?n=$P(t,qp,Wp,1):t[1]>Wp[1]&&(n=$P(t,Wp,qp,1)),Math.min(s,n)}function Tit(e,t,i){if(O(e))return Oj();if(e.spatialReference.isGeographic&&!f1(e.spatialReference))return new Q("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=sr.checkUnsupported(e);if(_(r))return r;const s=Sit(e,i);if(s)return s;const n=e.spatialReference;return t&&!(n.equals(t)||t.isWGS84&&n.isWebMercator)?new Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function Sit(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],o=Roe(t),a=Dt();sr.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>ox){const c=i[0].scale*2**i[0].level;let h=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*c/r;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new Q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:ox})}return null}const Eit=Object.freeze({__proto__:null,isInsideExtent:wit,tiltToExtentEdge:xit,checkIfTileInfoSupportedForViewSR:Tit});function Ait(){return!0}function Cit(){return 0}function Rit(e,t){if(O(e))return Oj();const i=e.lods.length-1,r=e.spatialReference,s=f1(r)||wp(r)||xp(r);if(r.isWebMercator){if(!sr.makeWebMercatorAuxiliarySphere(i).compatibleWith(e))return new Q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new Q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!sr.makeGCSWithTileSize(e.spatialReference,e.size[0],i).compatibleWith(e))return e.spatialReference.isWGS84?new Q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new Q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return t&&!e.spatialReference.equals(t)?new Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const Oit=Object.freeze({__proto__:null,isInsideExtent:Ait,tiltToExtentEdge:Cit,checkIfTileInfoSupportedForViewSR:Rit}),Sve={[$e.Global]:Oit,[$e.Local]:Eit};function yh(e,t){e||console.warn("Terrain: "+t)}const Mit=1.2,Pit=80/180*Math.PI,Iit=110/180*Math.PI;function $it(e,t,i){const r=Sve[e.viewingMode];let s;if(r.isInsideExtent(e,t))s=gt(e.getElevation(t[0],t[1],t[1],e.spatialReference),0);else{if(!r.isInsideExtent(e,t,Mit))return 0;const o=e.getTileWithElevation(t[0],t[1],t[1],e.spatialReference);s=.5*((_(o)?o.elevationBounds[0]:e.elevationBounds.min)+(_(o)?o.elevationBounds[1]:e.elevationBounds.max));const a=r.tiltToExtentEdge(e,t,s);if(a>Pit&&a<Iit)return 0}const n=t[2]-s;return Math.abs(n)<i?0:n<0?-1:1}function u9(e){return Sq(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function Eve(e){return(e==null?void 0:e.type)==="vector-tile"}function dL(e){return(e==null?void 0:e.type)==="imagery-tile"||(e==null?void 0:e.type)==="wcs"}function Sq(e){return(e==null?void 0:e.type)==="imagery-tile-3d"}function Ave(e){return(e==null?void 0:e.type)==="tile-3d"}function pL(e){return(e==null?void 0:e.type)==="vector-tile-3d"}function Dit(e){return(e==null?void 0:e.type)==="wmts-3d"}function jI(e){return(e==null?void 0:e.type)==="elevation-3d"}function Nx(e){return e&&(Ave(e)||Sq(e)||jI(e)||pL(e)||Dit(e))}function Lit(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="raster-tile"}function Nit(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="vector-tile"}function Fit(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="tile-texture"}function Uit(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return i instanceof HTMLImageElement||i instanceof oR||i instanceof HTMLCanvasElement||i instanceof ImageData}function Fx(e){return _(e)&&"release"in e&&e.release(),null}function tie(e){return e.fetchTile&&e.hasOverriddenFetchTile!==!1}function VF(e,t,i,r){return Sve[r].checkIfTileInfoSupportedForViewSR(e,i,t)}function GF(e,t,i){let r=null,s=null;if(zRe(e)){const n=kit(e,t,i);r=n.tileInfo,s=n.fullExtent}else{s=dL(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=i===$e.Local;if(dL(e))r=e.getCompatibleTileInfo(t,s,n);else if(Eve(e)){const o=n&&!zit(t)||Bit.force512VTL,a=e.tileInfo.spatialReference.isGeographic;r=o?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,a?1:2)}else r=e.tileInfo}return _(r)&&_(s)&&VF(r,s,t,i)==null?{tileInfo:r,fullExtent:s}:null}function kit(e,t,i){const r=BRe(e);if(_(r)){if(!pt.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const s=r.find(n=>VF(n.tileInfo,n.fullExtent,t,i)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function zit(e){return e.isWGS84||e.isWebMercator||Tne(e)||!ZA(e)}const Bit={force512VTL:!1};class Vit{constructor(t,i){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=Nx(t)?i.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),_it(t)){const r=t.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}}}class Git{constructor(t){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const i=t.resourceController.memoryController;this.totalMemory=i.maxMemory*pT.MEGABYTES,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=i.memoryFactor,this.load=t.resourceController.scheduler.load,this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;const r=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=_(r)?r.usedMemory:0,t.allLayerViews.items.forEach(s=>{(Tve(s)||Nx(s))&&this.layerPerformanceInfos.push(new Vit(s,t))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}}class jit extends ax{constructor(t,i,r,s){super(i,s),this._streamDataRequester=t,this._parameters=r}async fromUrl(t,i,r){Jt(r);const s=_(r)&&r.signal,n=this.makeUid(t,i);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(t,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a},this._textureRequests.set(n,o),o.textureAsync=l.then(async c=>{const h=this._createTexture(t,c,i);return o.texture=h,o.abortController=null,this._stage.add(h),await this._stage.load(h),{uid:n,texture:h,release:()=>this._release(n)}},c=>{throw o.abortController=null,c})}return o.referenceCount++,new Promise((a,l)=>{co(s,()=>{l(pi())}),o.textureAsync.then(a,l)}).catch(a=>{throw this._release(n),a})}_createTexture(t,i,r){const s=me(I({},this._parameters),{powerOfTwoResizeMode:Wy.PAD});if(FG(t)){if(r||i.width===0&&i.height===0){const n=i.width?i.height/i.width:1;r=r||64,n>1?(i.width=Math.round(r/n),i.height=r):(i.width=r,i.height=Math.round(r*n))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=i.width,s.height=i.height,new Kr(i,s)}}class Hit{constructor(t){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=t.viewState,this.view=t.view,this.pointsOfInterest=t.pointsOfInterest,this.objectResourceCache=t.objectResourceCache,this.streamDataRequester=t.resourceController.createStreamDataRequester(Jd.SYMBOLOGY),this.textures=new jit(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:lt.CLAMP_TO_EDGE,t:lt.CLAMP_TO_EDGE}},t.resourceController.scheduler);const i=di(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=fge(t.viewingMode,i),this.screenSizePerspectiveSettingsLabels=Z7e(t.viewingMode,i)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(t){if(!t)return{remove(){}};this.graphicsOwners.push(t);const i="layer"in t?t.watch("layer.screenSizePerspectiveEnabled",()=>this._updateScreenSizePerspectiveEnabled()):null;return this._updateScreenSizePerspectiveEnabled(),{remove:()=>{i&&(i.remove(),xL(this.graphicsOwners,t),this._updateScreenSizePerspectiveEnabled())}}}_updateScreenSizePerspectiveEnabled(){const t=this.graphicsOwners.some(i=>i.get("layer.screenSizePerspectiveEnabled")===!0);if(t&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new Bt;const i=()=>this._updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",i,!0),this.viewState.events.on("camera-projection-changed",i)]),this._updateScreenSizePerspectiveSettings()}else!t&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}_updateScreenSizePerspectiveSettings(){const t=this.pointsOfInterest;DP.distance=t.centerOnSurfaceInfrequent.distance,DP.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(DP),this.screenSizePerspectiveSettingsLabels.update(DP),this.view._stage.renderView.requestRender()}}const DP={distance:0,fovY:0};class Qg{constructor(t,i,r=""){this.graphics=t,this._symbol=new Sy({symbolLayers:[new qf({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new H1({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})]})}show(t,i){if(O(i))return;this.hide();const r=new Ke({x:t[0],y:t[1],z:t[2],spatialReference:i});this._graphic=new Bo({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){_(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let _y=class extends we{constructor(e){super(e),this.handles=new Bt}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],_y.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],_y.prototype,"surface",void 0),u([d({constructOnly:!0})],_y.prototype,"state",void 0),_y=u([P("esri.views.3d.support.PointOfInterest")],_y);const qit=Array;let Xc=class extends _y{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new w0({location:Ke,renderLocation:qit},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=M(),this.tmpPoint=new Ke}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(mp(this.map,"ground.layers","change",e,e,e))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=xi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return M1(i,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then(t=>this._updateSurfaceAltitude(t.geometry.z)).catch(t=>{vr(t)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null}),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(fk,this._estimatedSurfaceAltitude,this._camera.eye),sl(this._get("renderLocation"),fk)||this._set("renderLocation",ne(this._propertiesPool.get("renderLocation"),fk))}};u([d({constructOnly:!0})],Xc.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Xc.prototype,"cache",void 0),u([d({constructOnly:!0})],Xc.prototype,"task",void 0),u([d({constructOnly:!0})],Xc.prototype,"cameraName",void 0),u([d({readOnly:!0})],Xc.prototype,"location",null),u([d({constructOnly:!0})],Xc.prototype,"map",void 0),u([d({readOnly:!0})],Xc.prototype,"renderLocation",void 0),u([d({readOnly:!0})],Xc.prototype,"scale",null),u([d({readOnly:!0})],Xc.prototype,"updating",null),Xc=u([P("esri.views.3d.support.CameraOnSurface")],Xc);const fk=M(),iie=Xc,Wit=Array;let dh=class extends _y{constructor(e){super(e),this._propertiesPool=new w0({location:Ke,renderLocation:Wit},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=M(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Ys(this._frameWorker),this._propertiesPool=it(this._propertiesPool)}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=Yit;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=Zit;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(ne(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=xi(this._camera.eye,e):(ae(e,this._camera.viewForward,this._get("distance")),pe(e,e,this._camera.eye)),sl(this._get("renderLocation"),e)||this._set("renderLocation",ne(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=di(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=Fo(i.eye),o=n<s*s,a=xi(i.eye,t);if(o&&a>r/4){const l=s-Math.sqrt(n);return ae(t,i.viewForward,l),pe(t,t,i.eye),!0}}else{const r=this.surface.ready?this.surface.extent:null;_(r)&&sN(r,this.surface.spatialReference,S2,this.renderCoordsHelper.spatialReference)&&(t[0]=ze(t[0],S2[0],S2[2]),t[1]=ze(t[1],S2[1],S2[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(hi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=xi(i,e),s=xi(i,t);if(Math.abs(s-r)/r>Xit)return!0}return!1}};u([d({constructOnly:!0})],dh.prototype,"scheduler",void 0),u([d({constructOnly:!0})],dh.prototype,"task",void 0),u([d({constructOnly:!0})],dh.prototype,"cameraName",void 0),u([d()],dh.prototype,"distance",void 0),u([d({constructOnly:!0})],dh.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],dh.prototype,"location",null),u([d({readOnly:!0})],dh.prototype,"renderLocation",void 0),u([d()],dh.prototype,"updating",void 0),dh=u([P("esri.views.3d.support.CenterOnSurface")],dh);const Xit=.05,Yit=M(),Zit=M(),S2=Dt(),LP=dh;class Qit{constructor(t){this.handles=new Bt,this.events=new wr,this.contentLayerViews=t.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",i=>this._layerViewsChanged(i))),this._layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_layerViewsChanged(t){t.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this.handles.add(i.on("visible-geometry-changed",()=>this._contentChanged()),i.uid)}),t.removed.forEach(i=>this.handles.remove(i.uid))}_contentChanged(){this.events.emit("request-update",Jit)}}const Jit={},Kit=Array;let Nd=class extends _y{constructor(e){super(e),this._propertiesPool=new w0({location:Ke,renderLocation:Kit},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",()=>this.updateRenderLocation()),this.state.watch("contentCamera",()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(ut.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,rie);const s=Math.max(0,(Math.acos(_e(rie,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!Yx(e,t)){const l=this._propertiesPool.get("renderLocation");ne(l,t),this._set("renderLocation",l)}return}const n=1-ze(s/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(sie);const a=this._propertiesPool.get("renderLocation");Ss(a,t,sie,o),e&&Yx(e,a)||this._set("renderLocation",a)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(Nn());if(i[1]=t.aboveGround?t.padding[bt.BOTTOM]:t.fullHeight-t.padding[bt.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,E2)){de(E2,E2,t.eye);const s=be(E2,E2);if(this.renderCoordsHelper.intersectManifold(fc(t.eye,s),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],Nd.prototype,"_dirty",void 0),u([d({constructOnly:!0})],Nd.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Nd.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],Nd.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],Nd.prototype,"updating",null),u([d({readOnly:!0})],Nd.prototype,"location",null),u([d({readOnly:!0})],Nd.prototype,"renderLocation",void 0),Nd=u([P("esri.views.3d.support.CenterOnSurface")],Nd);const rie=M(),E2=M(),sie=M(),ert=Nd;let Af=class extends we{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new Bt}get renderLocation(){if(!this.location)return null;const e=M();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],()=>this._update()),mp(this,"surface.layers","change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||O(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=AG(this.surfaceView.extent),t=new Ke({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{vr(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",t)}};u([d({constructOnly:!0})],Af.prototype,"view",void 0),u([d({constructOnly:!0})],Af.prototype,"cache",void 0),u([d({readOnly:!0,aliasOf:"view.map.ground"})],Af.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain"})],Af.prototype,"surfaceView",void 0),u([d({readOnly:!0})],Af.prototype,"location",void 0),u([d({readOnly:!0})],Af.prototype,"renderLocation",null),Af=u([P("esri.views.3d.terrain.StableSurfaceCenter")],Af);let Cf=class extends we{constructor(){super(...arguments),this.handles=new Bt,this._tileGeometryUpdateExtent=Tu(),this._tileGeometryUpdateSpatialReference=null,this.events=new wr,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ut.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles=it(this.handles)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",trt),Tu(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,jy(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=irt,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,cv,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,uv,t),cv[0]<uv[0]?(r[0]=cv[0],r[2]=uv[0]):(r[0]=uv[0],r[2]=cv[0]),cv[1]<uv[1]?(r[1]=cv[1],r[3]=uv[1]):(r[1]=uv[1],r[3]=cv[1]),zL(r,e)}};u([d({constructOnly:!0})],Cf.prototype,"state",void 0),u([d({constructOnly:!0})],Cf.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],Cf.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Cf.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Cf.prototype,"surface",void 0),u([d({readOnly:!0})],Cf.prototype,"updating",void 0),Cf=u([P("esri.views.3d.support.SurfaceGeometryUpdates")],Cf);const trt={},cv=M(),uv=M(),irt=Tu();let Ro=class extends we{constructor(e){super(e),this._handles=new Bt,this._tmpRay=Fn(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new w0({renderPointOfView:rrt},this),this.renderPointOfView=M(),this._pois=new Array,this._debugCenters=new Map}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=Ou(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Bn.MIN,this._contentIntersector=Ou(t.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=(e=this.view.basemapTerrain)==null?void 0:e.elevationQueryCache,l={state:t,scheduler:o,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new LP(me(I({},l),{task:ut.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("centerOnSurfaceFrequent",new LP(me(I({},l),{task:ut.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("contentCenterOnSurface",new LP(me(I({},l),{task:ut.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n,cameraName:"contentCamera"}))),this._set("centerOnContent",new LP(me(I({},l),{task:ut.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new iie(me(I({},l),{cache:a,task:ut.POINT_OF_INTEREST_INFREQUENT,map:s}))),this._set("contentCameraOnSurface",new iie(me(I({},l),{cache:a,task:ut.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"}))),this._set("surfaceGeometryUpdates",new Cf(me(I({},l),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new Qit({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new Af({cache:a,view:this.view})),this._set("focus",new ert({state:t,scheduler:o,surface:i,renderCoordsHelper:r,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(h,p)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Qg(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Qg(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Qg(c,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new Qg(c,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Qg(c,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new Qg(c,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new Qg(c,"green","Focus")),this._handles.add([t.watch("camera",h=>this._cameraChanged(h),!0),i.watch("extent",()=>this._updateCenterPointsOfInterest()),X$(i,"updating",()=>this._updateCenterPointsOfInterest(),!0),this.surfaceGeometryUpdates.events.on("request-update",()=>this._updateCenterPointsOfInterest()),this.contentGeometryUpdates.events.on("request-update",()=>this._updateCenterOnContent()),Wt(hi,"SHOW_POI",h=>this._setDebug(h))]),this._cameraChanged(this.view.state.camera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!!((e=this.surfaceGeometryUpdates)!=null&&e.updating||this._pois.some(t=>t.updating))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return O(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,zb,nrt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(zb):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(O(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=pe(zb,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(zb)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(zb)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=yH(t,e,srt);if(O(r))return null;const s=r.origin,n=pe(zb,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;sl(this.renderPointOfView,t)||this._set("renderPointOfView",ne(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(Wt(t,"renderLocation",i=>this._debugCenters.get(t).show(i,t.renderCoordsHelper.spatialReference)),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],Ro.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],Ro.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],Ro.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],Ro.prototype,"contentCenterOnSurface",void 0),u([d({readOnly:!0})],Ro.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],Ro.prototype,"contentCameraOnSurface",void 0),u([d({readOnly:!0})],Ro.prototype,"focus",void 0),u([d({readOnly:!0})],Ro.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],Ro.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],Ro.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],Ro.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],Ro.prototype,"view",void 0),u([d({readOnly:!0})],Ro.prototype,"updating",null),Ro=u([P("esri.views.3d.support.PointsOfInterest")],Ro);const rrt=Array,zb=M(),srt=Fn(),nrt={exclude:new Set([v_])},Cve=Ro;class ort{constructor(t){this.store=t}destroy(){this.store.destroy()}get(t){return this.store.get(t)}put(t,i){this.store.put(t,i,i.values.byteLength+256)}}const art=he.getLogger("esri.core.workers.WorkerHandle");class Rve{constructor(t,i,r,s={}){this._mainMethod=i,this._listeners=[],this._promise=$ae(t,me(I({},s),{schedule:r})).then(n=>{if(this._thread===void 0){this._thread=n,this._promise=null,s.hasInitialize&&this.broadcast({},"initialize");for(const o of this._listeners)this._connectListener(o)}else n.close()}),this._promise.catch(n=>art.error(`Failed to initialize ${t} worker: ${n}`))}on(t,i){const r={removed:!1,eventName:t,callback:i,threadHandle:null};return this._listeners.push(r),this._connectListener(r),Sm(()=>{r.removed=!0,I9(this._listeners,r),this._thread&&_(r.threadHandle)&&r.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(t,i){return this.invokeMethod(this._mainMethod,t,i)}invokeMethod(t,i,r){if(this._thread){const s=this.getTransferList(i,t);return this._thread.invoke(t,i,{transferList:s,signal:r})}return this._promise?this._promise.then(()=>(Jt(r),this.invokeMethod(t,i,r))):Promise.reject(null)}broadcast(t,i){return this._thread?Promise.all(this._thread.broadcast(i,t)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(t,i)):Promise.reject()}get promise(){return this._promise}_connectListener(t){this._thread&&this._thread.on(t.eventName,t.callback).then(i=>{t.removed||(t.threadHandle=i)})}}class nie extends Rve{constructor(t=null){super("LercWorker","_decode",t,{strategy:"dedicated"}),this.schedule=t,this.ref=0}decode(t,i,r){return t&&t.byteLength!==0?this.invoke({buffer:t,options:i},r):Promise.resolve(null)}getTransferList(t){return[t.buffer]}release(){--this.ref<=0&&(BA.forEach((t,i)=>{t===this&&BA.delete(i)}),this.destroy())}}const BA=new Map;function lrt(e=null){let t=BA.get(e);return t||(_(e)?(t=new nie(i=>e.schedule(i)),BA.set(e,t)):(t=new nie,BA.set(null,t))),++t.ref,t}function om(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function Ove(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function crt(e,t,i,r,s,n,o,a,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function urt(e,t){return new Float32Array(e,t,9)}Object.freeze({__proto__:null,create:om,clone:Ove,fromValues:crt,createView:urt});var oie,Za,aie,lie,cie;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FILL_VERTEX=1]="FILL_VERTEX",e[e.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",e[e.FILL_INDEX=3]="FILL_INDEX",e[e.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",e[e.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",e[e.OUTLINE_INDEX=6]="OUTLINE_INDEX",e[e.LINE_VERTEX=7]="LINE_VERTEX",e[e.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",e[e.LINE_INDEX=9]="LINE_INDEX",e[e.ICON_VERTEX=10]="ICON_VERTEX",e[e.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",e[e.ICON_INDEX=12]="ICON_INDEX",e[e.TEXT_VERTEX=13]="TEXT_VERTEX",e[e.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",e[e.TEXT_INDEX=15]="TEXT_INDEX",e[e.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",e[e.CIRCLE_INDEX=17]="CIRCLE_INDEX"})(oie||(oie={})),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(Za||(Za={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.OPAQUE=1]="OPAQUE",e[e.TRANSLUCENT=2]="TRANSLUCENT",e[e.SYMBOLS=3]="SYMBOLS",e[e.HITTEST=4]="HITTEST"}(aie||(aie={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(lie||(lie={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(cie||(cie={}));class hrt{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class aft{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function lft(e,t,i,r,s,n){const o=i-s;if(o>=0)return(t>>o)+(r-(n<<o))*(e>>o);const a=-o;return t-(n-(r<<a))*(e>>a)<<a}class cft{constructor(t,i,r){this._rows=Math.ceil(i/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(t,i){const r=Math.min(Math.max(Math.floor(i/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][s]||null}getCellSpan(t,i,r,s){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function drt(e,t,i,r,s,n){const o=t[r++];for(let a=0;a<o;a++){const l=new hrt(n);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++];const c=t[r++];for(let f=0;f<c;f++){const g=t[r++],y=t[r++],v=t[r++],b=t[r++],w=!!t[r++],S=t[r++],T=i[r++],A=i[r++],C=t[r++],R=t[r++];l.colliders.push({xTile:g,yTile:y,dxPixels:v,dyPixels:b,hard:w,partIndex:S,width:C,height:R,minLod:T,maxLod:A})}const h=e[r++];for(let f=0;f<h;f++)l.textVertexRanges.push([e[r++],e[r++]]);const p=e[r++];for(let f=0;f<p;f++)l.iconVertexRanges.push([e[r++],e[r++]]);s.push(l)}return r}function uft(e,t,i){for(const[r,s]of e.symbols)prt(e,t,i,s,r)}function prt(e,t,i,r,s){const n=e.layerData.get(s);if(n.type===Za.SYMBOL){for(const o of r){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=t,n.opacityChanged=!0}}class jF{constructor(t,i){this.layerUIDs=[],this.isDestroyed=!1,this.data=t,this.memoryUsed=t.byteLength;let r=1;const s=new Uint32Array(t);this.layerUIDs=[];const n=s[r++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[r++];this.bufferDataOffset=r,i&&(this.layer=i.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return O(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(t){O(this.data)||(this.doPrepareForRendering(t,this.data,this.bufferDataOffset),this.data=null)}}class frt extends jF{constructor(t,i){super(t,i),this.type=Za.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.lineIndexStart=r[s++],this.lineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){_(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),_(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),_(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.lineVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.lineIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new as(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class mrt extends jF{constructor(t,i){super(t,i),this.type=Za.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.fillIndexStart=r[s++],this.fillIndexCount=r[s++],this.outlineIndexStart=r[s++],this.outlineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){_(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),_(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),_(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,_(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),_(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),_(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.fillVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.fillIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.outlineVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.outlineIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new as(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new as(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class grt extends jF{constructor(t,i,r){super(t,i),this.type=Za.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(t),n=new Int32Array(t),o=new Float32Array(t);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const g=s[a++],y=s[a++],v=s[a++];this.iconPerPageElementsMap.set(g,[y,v])}const c=s[a++];for(let f=0;f<c;f++){const g=s[a++],y=s[a++],v=s[a++];this.glyphPerPageElementsMap.set(g,[y,v])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=drt(s,n,o,a,this.symbols,r),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[i,r]of this.iconPerPageElementsMap)t+=r[1];for(const[i,r]of this.glyphPerPageElementsMap)t+=r[1];return t/3}doDestroy(){_(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),_(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),_(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),_(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,_(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),_(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),_(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),_(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,i=this.iconOpacityBuffer;t.length>0&&t.byteLength===i.size&&i.setSubData(t);const r=this.textOpacity,s=this.textOpacityBuffer;r.length>0&&r.byteLength===s.size&&s.setSubData(r)}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.iconVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.iconIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.textVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.textIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c,this.iconOpacityBuffer=jt.createVertex(t,ri.STATIC_DRAW,this.iconOpacity.buffer),this.textOpacityBuffer=jt.createVertex(t,ri.STATIC_DRAW,this.textOpacity.buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new as(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new as(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class yrt extends jF{constructor(t,i){super(t,i),this.type=Za.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.circleIndexStart=r[s++],this.circleIndexCount=r[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){_(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),_(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),_(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.circleVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.circleIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new as(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}const hft=!0,dft=32,uie=200,vrt=1/ue("mapview-transitions-duration");class _rt extends wr{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(t){this._clips=t,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(this._opacity=Math.min(1,Math.max(t,0)),this.requestRender())}get stage(){return this._stage}set stage(t){if(this._stage===t)return;const i=this._stage;this._stage=t,t?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return O(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(t){this._visible!==t&&(this._visible=t,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=um(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=um(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(t){this.updateTransitionProperties(t.deltaTime,t.state.scale)}afterRender(t){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var t;(t=this.parent)==null||t.removeChild(this)}setTransform(t){}processRender(t){this.stage&&this.computedVisible&&this.doRender(t)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(t,i){if(this.fadeTransitionEnabled){const r=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===r)this.computedVisible=this.visible;else{const n=t*vrt;this.computedOpacity=s>r?Math.max(r,s-n):Math.min(r,s+n),this.computedVisible=this.computedOpacity>0;const o=r===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(t){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}class Xd{constructor(t,i,r,s){this.set(t,i,r,s)}static getId(t,i,r,s){return typeof t=="object"?`${t.level}/${t.row}/${t.col}/${t.world}`:`${t}/${i}/${r}/${s}`}get key(){return this}get id(){return this.toString()}set id(t){this.set(t)}get hash(){const t=4095&this.row,i=4095&this.col,r=63&this.level;return(3&this.world)<<30|i<<22|t<<8|r}acquire(t,i,r,s){this.set(t,i,r,s)}contains(t){const i=t.level-this.level;return this.row===t.row>>i&&this.col===t.col>>i&&this.world===t.world}equals(t){return this.level===t.level&&this.row===t.row&&this.col===t.col&&this.world===t.world}clone(){return new Xd(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(t,i,r,s){if(t==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof t=="object")this.level=t.level||0,this.row=t.row||0,this.col=t.col||0,this.world=t.world||0;else if(typeof t=="string"){const[n,o,a,l]=t.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+t,this.row=+i,this.col=+r,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new Xd(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const t=this.level+1,i=this.row<<1,r=this.col<<1,s=this.world;return[new Xd(t,i,r,s),new Xd(t,i,r+1,s),new Xd(t,i+1,r,s),new Xd(t,i+1,r+1,s)]}compareRowMajor(t){return this.row<t.row?-1:this.row>t.row?1:this.col<t.col?-1:this.col>t.col?1:0}}Xd.pool=new Gr(Xd,null,null,25,50);class brt extends _rt{constructor(t,i,r,s,n,o=s,a=n){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new Xd(t),this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=o,this.rangeY=a}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(t,i){const r=i/(t.resolution*t.pixelRatio),s=this.transforms.tileMat3,[n,o]=t.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*r,l=this.height/this.rangeY*r;Gj(s,a,0,0,0,l,0,n,o,1),jN(this.transforms.dvs,t.displayViewMat3,s)}}class fL extends brt{constructor(t,i,r,s,n,o,a=null){super(t,i,r,s,n,4096,4096),this._memCache=a,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=o,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<uie}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<uie)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(t){let i=!1;for(const r of t)if(this.layerData.has(r)){const s=this.layerData.get(r);this._memoryUsedByLayerData-=s.memoryUsed,s.type===Za.SYMBOL&&this.symbols.has(r)&&(this.symbols.delete(r),i=!0),s.destroy(),this.layerData.delete(r),this.layerCount--}_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),i&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(Mve.delete(this),fL._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(t){let i=!1;if(t){const{bucketsWithData:r,emptyBuckets:s}=t,n=this._createRenderBuckets(r);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===Za.SYMBOL&&(this.symbols.set(o,a.symbols),i=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[r,s]of this.layerData)s.type===Za.SYMBOL&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(i){i.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t,i){super.setTransform(t,i);const r=i/(t.resolution*t.pixelRatio),s=this.width/this.rangeX*r,n=this.height/this.rangeY*r,o=[0,0];t.toScreen(o,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;jj(a),AD(a,a,o),Hj(a,a,Math.PI*t.rotation/180),qj(a,a,[s,n,1])}_createTransforms(){return{dvs:om(),tileMat3:om(),tileUnitsToPixels:om()}}static _destroyRenderBuckets(t){if(!t)return;const i=new Set;t.forEach(r=>{i.has(r)||(r.destroy(),i.add(r))}),t.clear()}_createRenderBuckets(t){const i=new Map,r=new Map;for(const s of t){const n=this._deserializeBucket(s,r);for(const o of n.layerUIDs)i.set(o,n)}return i}_deserializeBucket(t,i){let r=i.get(t);if(r)return r;switch(new Uint32Array(t)[0]){case Za.FILL:r=new mrt(t,this.styleRepository);break;case Za.LINE:r=new frt(t,this.styleRepository);break;case Za.SYMBOL:r=new grt(t,this.styleRepository,this);break;case Za.CIRCLE:r=new yrt(t,this.styleRepository)}return i.set(t,r),r}_deleteLayerData(t){if(!this.layerData.has(t))return;const i=this.layerData.get(t);this._memoryUsedByLayerData-=i.memoryUsed,i.destroy(),this.layerData.delete(t),this.layerCount--}}const Mve=new Map;function wrt(){Mve.forEach((e,t)=>{console.log(`
${t.key}:`),e[0].forEach(i=>console.log(i)),console.log("========"),e[1].forEach(i=>console.log(i))})}const xrt=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(i){super.postscript(i),jpe(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const i=zce(this.view.defaultsFromMap,"heightModelInfoReady");this.handles.add(i),await i;const r=Sze(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(r)throw r}canResume(){const i=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!i||!i.minScale||!i.maxScale||i.minScale>=i.maxScale)}getSuspendInfo(){const i=super.getSuspendInfo(),r=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return r&&r.minScale&&r.maxScale&&r.minScale<r.maxScale&&(i.outsideScaleRange=!0),i}};return u([d()],t.prototype,"view",void 0),u([d()],t.prototype,"slicePlaneEnabled",void 0),t=u([P("esri.views.3d.layers.LayerView3D")],t),t},Trt={value:.5,readOnly:!0},Pve={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},Srt=e=>{let t=class extends e{get imageFormatIsOpaque(){return!1}get fullExtent(){return this.layer.fullExtent}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const i=this.tileInfo.lods,r=i[0].scale,s=i[i.length-1].scale;return this.levelRangeFromScaleRange(r,s)}get displayLevelRange(){const i=this.tileInfo.lods,r=this.layer.minScale||i[0].scale,s=this.layer.maxScale||i[i.length-1].scale,n=this.levelRangeFromScaleRange(r,s);return this.layer.maxScale&&n.maxLevel++,n}getTileUrl(i,r,s){return this.layer.getTileUrl(i,r,s)}_addTilingSchemeMatchPromise(){if(O(this.fullExtent))return this.addResolvingPromise(Promise.reject(new Q("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const i=this._getTileInfoSupportError(this.tileInfo,this.fullExtent);if(_(i))return this.addResolvingPromise(Promise.reject(i));const r=zce(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{const s=this.view.basemapTerrain.tilingScheme,n=this._getTileInfoCompatibilityError(this.tileInfo,s);if(n)throw n});this.addResolvingPromise(r)}_getTileInfoSupportError(i,r){const s=VF(i,r,this.view.spatialReference,this.view.state.viewingMode);if(s){const n={layer:this.layer,error:s};let o;switch(s.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":o=new Q("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",n);break;default:o=new Q("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",n)}return o}return null}_getTileInfoCompatibilityError(i,r){return r.compatibleWith(i)?null:new Q("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(i,r){const s={minLevel:0,maxLevel:1/0},n=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!n)return s;const o=n.levels[0],a=l=>{const c=Math.log(o.scale/l)/Math.LN2;return .5-Math.abs(.5-c%1)<1e-9?Math.round(c):Math.ceil(c)};return i!=null&&i>0&&(s.minLevel=Math.max(0,a(i))),r!=null&&r>0&&(s.maxLevel=Math.max(0,a(r))),s}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return u([d({readOnly:!0})],t.prototype,"imageFormatIsOpaque",null),u([d({readOnly:!0})],t.prototype,"updating",void 0),u([d(Pve)],t.prototype,"updatingProgress",void 0),u([d(Trt)],t.prototype,"updatingProgressValue",void 0),u([d()],t.prototype,"fullExtent",null),u([d({readOnly:!0})],t.prototype,"isOpaque",null),u([d({readOnly:!0})],t.prototype,"dataLevelRange",null),u([d({readOnly:!0})],t.prototype,"displayLevelRange",null),u([d()],t.prototype,"layer",void 0),u([d()],t.prototype,"tileInfo",void 0),t=u([P("esri.views.3d.layers.TiledLayerView3D")],t),t};let Nl=class extends Rm(NL(AR(wr.EventedMixin(we)))){constructor(e){super(e),this.layer=null,this.parent=null}initialize(){this.when().catch(e=>{if(e.name!=="layerview:create-error"){const t=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw he.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e),e}})}get fullOpacity(){return gt(this.get("layer.opacity"),1)*gt(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&this.layer.legendEnabled===!0}get updating(){var e;return!!((e=this.updatingHandles)!=null&&e.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var e;return((e=this.layer)==null?void 0:e.visible)===!0}set visible(e){e!==void 0?this._override("visible",e):this._clearOverride("visible")}canResume(){var e,t,i;return this.visible&&((e=this.layer)==null?void 0:e.loaded)&&!((t=this.parent)!=null&&t.suspended)&&((i=this.view)==null?void 0:i.ready)||!1}getSuspendInfo(){const e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{},t=this;return t.view&&t.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};u([d()],Nl.prototype,"fullOpacity",null),u([d()],Nl.prototype,"layer",void 0),u([d()],Nl.prototype,"parent",void 0),u([d({readOnly:!0})],Nl.prototype,"suspended",null),u([d({readOnly:!0})],Nl.prototype,"suspendInfo",null),u([d({readOnly:!0})],Nl.prototype,"legendEnabled",null),u([d({type:Boolean,readOnly:!0})],Nl.prototype,"updating",null),u([d({readOnly:!0})],Nl.prototype,"updatingProgress",null),u([d()],Nl.prototype,"visible",null),u([d()],Nl.prototype,"view",void 0),Nl=u([P("esri.views.layers.LayerView")],Nl);const Ert=Nl;let qE=class extends Srt(xrt(Ert)){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){var e,t,i,r,s;const n=(e=this.view)==null||(t=e.map)==null?void 0:t.allLayers,o=n&&n.includes(this.layer),a=(i=this.view)==null||(r=i.map)==null||(s=r.ground)==null?void 0:s.layers,l=a&&a.includes(this.layer);if(o&&!l){const c=new Q("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added to layers in map.ground");this.addResolvingPromise(Promise.reject(c))}this._addTilingSchemeMatchPromise()}};u([d()],qE.prototype,"layer",void 0),u([d({readOnly:!0,aliasOf:"layer.tileInfo"})],qE.prototype,"tileInfo",void 0),qE=u([P("esri.views.3d.layers.ElevationLayerView3D")],qE);const Ive=qE;var Art=Object.freeze(Object.defineProperty({__proto__:null,default:Ive},Symbol.toStringTag,{value:"Module"}));class Eq{constructor(t=0,i=0){this.min=t,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(t){this.min=t.min,this.max=t.max,this.level=t.level,this.hasNoDataValues=t.hasNoDataValues}}class Crt{constructor(t,i,r){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=i;const s=r.noDataValue,n=r.values;let o=1/0,a=-1/0,l=!0,c=!1;for(let h=0;h<n.length;h++){const p=n[h];p!==s?(o=p<o?p:o,a=p>a?p:a,l=!1):c=!0}l&&(o=0,a=0),a=a>-3e38?a:0,this.samplerData={pixelData:r.values,width:r.width,height:r.height,noDataValue:s,safeWidth:.99999999*(r.width-1),dx:(r.width-1)/(i[2]-i[0]),dy:(r.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]},this.bounds=[o,a],this.hasNoDataValues=c}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,i,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=t-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(i/o)===this.i&&Math.floor(r/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.width,h=this.samplerData.pixelData,p=.5*wC;let f=(c-1)/o,g=(r-this.j*o)*f,y=(i-this.i*o)*f;if(f<1){const v=Math.floor(g),b=Math.floor(y),w=v+b*c,S=h[w],T=h[w+1],A=h[w+c],C=h[w+c+1];if(S+T+A+C<p){const R=g-v,L=y-b,U=AO(S,T,A,C,R,L),N=AO(S,T,A,C,R+f,L),z=AO(S,T,A,C,R,L+f),V=AO(S,T,A,C,R+f,L+f);return s.min=Math.min(U,N,z,V),s.max=Math.max(U,N,z,V),s}g=v,y=b,f=1}else g=Math.floor(g),y=Math.floor(y),f=Math.ceil(f);for(let v=g;v<=g+f;v++)for(let b=y;b<=y+f;b++){const w=h[v+b*c];w<p?(a=Math.min(a,w),l=Math.max(l,w)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}}function Aq(e,t,i){if(O(i))return null;for(const r of i){if(!r)continue;const s=r.safeWidth;let n=ze(r.dy*(r.y1-t),0,s),o=ze(r.dx*(e-r.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=r.width,h=a*c+l,p=r.pixelData,f=p[h],g=p[h+1],y=h+c,v=p[y],b=p[y+1];if(f+v+g+b<.5*wC){n-=a,o-=l;const w=f+(g-f)*o;return w+(v+(b-v)*o-w)*n}}return null}let Qc=class extends we{constructor(e){super(e),this._handles=new Bt}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const r=$ve(i.fullExtent,this.viewSpatialReference);_(r)&&e.push(Roe(r))}}),e}};function Rrt(e,t){return e===$e.Global?new h9(t):new d9(t)}u([d({readOnly:!0})],Qc.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],Qc.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],Qc.prototype,"stencilEnabledExtents",null),u([d()],Qc.prototype,"viewSpatialReference",void 0),u([d()],Qc.prototype,"tilingScheme",void 0),u([d()],Qc.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],Qc.prototype,"layers",void 0),u([d({constructOnly:!0})],Qc.prototype,"layerViews",void 0),Qc=u([P("esri.views.3d.terrain.ExtentHelper")],Qc);let h9=class extends Qc{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Mpe:Pke}};h9=u([P("esri.views.3d.terrain.ExtentHelperGlobal")],h9);let d9=class extends Qc{_computeLayerViewsExtent(){const e=Tu(),t=this.viewSpatialReference;this.layerViews.forEach(s=>{const n=s.layer;if(s.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=$ve("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);jy(e,o,e)}});const i=t6(e)?e:null,r=this._get("layerViewsExtent");return z_(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=Tu();this.layers.forEach(n=>{if(n.loaded&&yA(n)){const o=GF(n,t,$e.Local);if(O(o))return;const{tileInfo:a,fullExtent:l}=o;(_(a)&&dL(n)&&_(l)||_(a)&&e.compatibleWith(a)&&_(l)&&l.spatialReference.equals(e.spatialReference))&&jy(i,l,i)}}),jy(i,this.defaultTiledLayersExtent,i);const r=t6(i)?i:null,s=this._get("tiledLayersExtent");return z_(r,s)?s:r}};function $ve(e,t){return _(e)&&!e.spatialReference.equals(t)?sle(e,e.spatialReference,t):e}d9=u([P("esri.views.3d.terrain.ExtentHelperLocal")],d9);var Lt;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"})(Lt||(Lt={}));const t_=[Lt.ELEVATION,Lt.MAP];function Dve(){var e;const t=(e=globalThis.require)==null?void 0:e.modules;if(t){const i=Object.keys(t);for(const r of i)r.search(".glsl")!==-1&&delete t[r]}}const Ort=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let fg,Oo=class extends we{constructor(e){super(e),this._handles=new Bt,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=ue("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||hi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return _(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?di(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new uh({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=Ou(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",t=>{var i;return(i=e._stage)==null?void 0:i.renderView.setRenderParameters({hasOverlayWater:t})}),this.renderer.events.on("renders-occluded",()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this._setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateDrapeTargets()),e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setPlacementDirty()),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),e.watch("graphicsView",()=>this._layerViewsDirty=!0),e.on("resize",()=>this.setPlacementDirty()),e1({preRender:t=>{this._contentUpdated=!1,this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(t),this._drawOverlayTextures(this.renderer.overlays,ts.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(ut.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",t=>{this._updateOverlays(t,ts.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,ts.BACKGROUND,t)})]),this._updateLayerViews()}destroy(){this._drapeSources.forEach((e,t)=>this.unregisterDrapeSource(t)),this._drapeTargets.forEach(e=>this._unregisterDrapeTarget(e)),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),_(fg)&&(fg.hide(),fg=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;_(e)&&_(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new e0(-20037508342787e-6,20037508342787e-6):new e0(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const i of this.view.allLayerViews.items)e.add(i.uid),"drapeSourceType"in i&&!this._drapeSources.has(i)&&this._registerDrapeSource(i,fx.LAYER_VIEW),"drapeTargetType"in i&&!this._drapeTargets.has(i)&&this._registerDrapeTarget(i);const t=this.view.graphicsView;_(t)&&!this._drapeSources.has(t)&&(this._registerDrapeSource(t,fx.LAYER_VIEW),e.add(t.uid)),this._drapeSources.forEach((i,r)=>{i!==fx.LAYER_VIEW||e.has(r.uid)||this.unregisterDrapeSource(r)}),this._drapeTargets.forEach(i=>{e.has(i.uid)||this._unregisterDrapeTarget(i)}),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,fx.EXTERNAL)}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running")}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&_(e.setDrapingExtent)&&_(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateDrapeTargets(){this._drapeTargets.forEach(e=>this._updateDrapeTarget(e))}_updateDrapeTarget(e){e.setDrapingTextures(this.renderer.overlays)}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,ts.UPDATE)}_updateOverlays(e,t){if(!this._spatialReference)return;this._updateLayerViews();const i=bWe(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,i,Xp);const r=Bf(Xp.inner)/Bf(Xp.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(Jr.INNER,Xp.inner,i,1*Xp.pixelRatioAdjustment,Xp.mapUnitsPerPixel),n=this._updateOverlay(Jr.OUTER,Xp.outer,i,r*Xp.pixelRatioAdjustment,Xp.mapUnitsPerPixel);s!==Gd.EXTENT&&n!==Gd.EXTENT||(this._drapeSources.forEach((o,a)=>this._updateDrapeSourceExtent(a)),this.surface.updateTileOverlayParams(t)),s===Gd.NONE&&n===Gd.NONE||this._setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(e,t,i,r,s){if(this.renderer.overlays.length===0)return Gd.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,Mrt(t,n.extent)&&i===n.resolution)return o===s?Gd.NONE:Gd.RERENDER_ONLY;i0(n.extent,t),n.resolution=i;const a=AG(n.extent);return n.renderLocalOrigin=LA(a[0],a[1],0,"OV_"+this._latestOriginId++),Gd.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Jr.INNER],r=this.renderer.overlays[Jr.OUTER],s=R3(e.extent,this.surface.extent,hie);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,Jr.INNER,t),this._setTileOverlayData(s,Jr.OUTER,t)):(this._clearTileOverlayData(Jr.INNER,t),this._clearTileOverlayData(Jr.OUTER,t))}else this._clearTileOverlayData(Jr.INNER,t),this._clearTileOverlayData(Jr.OUTER,t)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const t=this.renderer.overlays[Jr.INNER],i=this.renderer.overlays[Jr.OUTER],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,s=Bf(r),n=l1(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const a=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>a&&(o=a-(e[2]-e[0]))}i.setScale(t,Bf(e)/s,l1(e)/n),i.setOffset(t,(o-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){Dve(),await this.renderer.reloadShaders(),this._setDrawTexturesDirty(),this.runTask()}_dispatchAnimationUpdate(e){const t=e.time-this._animationTimeLast;(t>=this.surface.view._stage.renderView.animationTimestep||_(this.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty)&&(this.renderer.updateAnimation({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e.time)}_setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Irt,t,i);if(O(s))return!1;const n=s.origin,o=pe(NP,s.origin,s.direction);return this._groundIntersector.reset(n,o,e),this._groundIntersector.intersect([],null),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=ze(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+o,e.aboveGround?s-o:1/0),l=e.aboveGround;if(this.view.viewingMode==="global"){const c=NP;cS(di(this.view.spatialReference).radius+a,fc(e.eye,e.viewForward),c),de(c,c,e.eye);const h=t0.normalize(zCe(e.viewForward,c,e.viewRight))/e.fovY+.5,p=h<=0||h>=1?.5:r;i=l?p*h:h+p*(1-h)}else{const c=.5*Math.PI-Math.acos(-e.viewForward[2]),h=Math.tan(c),p=yi(0,h,1,0),f=bu(p,p,e.projectionMatrix)[1],g=ze(.5+.5*f,0,1);i=g===1||g===0?.5:l?g*r:1-(1-g)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&Y9(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=M();this._findHorizonBasedPointOfInterest(e,s)||ne(s,r);const n=Math.max(.1,xi(e.eye,s)),o=f0(this.view.renderCoordsHelper,r,e.eye),a=Math.PI/2-Math.abs(o-Math.PI/2);hi.OVERLAY_SHOW_CENTER?(O(fg)&&(fg=new Qg(this.view.graphics,"red")),fg.show(s,this._renderSR)):_(fg)&&fg.hide(),this._overlaySREqualsRenderSR||yn(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&_(this._spatialReference)&&this._spatialReference.isGeographic,h=c&&_(this._spatialReference)?1/di(this._spatialReference).metersPerDegree:1,p=e.perRenderPixelRatio*n*h;i.mapUnitsPerPixel=p/this._worldToPCSRatio;let f=t*p/2,g=!1,y=c?90:1/0;this._isSpherical&&_(l)&&_(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos(w$(s[1])),y=l[3]):(g=!0,f/=di(this._spatialReference).metersPerDegree,y=90),f>=y&&(f=y,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let v=1;g&&(v=1/Math.max(.2,Math.cos(Math.abs(Ct(s[1])))),f*v>180&&(v=180/f),i.mapUnitsPerPixel*=v);const b=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/b)*b);const w=f*v,S=32,T=.5*t/(S*w),A=.5*t/(S*f);s[0]=Math.round(s[0]*T)/T,s[1]=Math.round(s[1]*A)/A;const C=i.inner;C[0]=s[0]-w,C[1]=s[1]-f,C[2]=s[0]+w,C[3]=s[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,y);const R=i.outer;if(6*w>Bf(l))i0(R,l);else if(a<=.25*Math.PI)R[0]=C[0]-w,R[1]=C[1]-f,R[2]=C[2]+w,R[3]=C[3]+f;else{yn(e.eye,this._renderSR,NP,this._spatialReference),Qd(hv,s,NP);let U=-Math.atan2(hv[1],hv[0])+.125*Math.PI;U<0&&(U+=2*Math.PI);const N=Math.floor(U/(.25*Math.PI));wR(hv,Ort[N],2*f),hv[0]*=v,hv[2]*=v,Q9(R,C,hv)}if(this._isSpherical)R[0]=this._longitudeCyclical.clamp(R[0]),R[2]=this._longitudeCyclical.clamp(R[2]),R[1]=Math.max(R[1],-y),R[3]=Math.min(R[3],y);else{const U=R3(C,l,hie),N=R3(R,l,Prt);WW(U,N)&&(R[2]=R[0],R[3]=R[1])}const L=Math.abs(C[2]-C[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,L),i.pixelRatioAdjustment=i.mapUnitsPerPixel/L}_drawOverlayTextures(e,t,i=this.view.state.camera){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[Jr.INNER],i),n=this._drawOverlay(e[Jr.OUTER],i);s!==RT.CHANGED&&n!==RT.CHANGED||this.surface.updateTileOverlayParams(ts.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),r?(this.surface.requestRender(t),t===ts.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(ts.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!O(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):zL(e,t))}_rectInsideRect(e,t){return!O(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:WW(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),A$(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};function Mrt(e,t){const r=hi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}u([d()],Oo.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],Oo.prototype,"running",null),u([d()],Oo.prototype,"_placementDirty",void 0),u([d()],Oo.prototype,"_contentUpdated",void 0),u([d()],Oo.prototype,"_layerViewsDirty",void 0),u([d()],Oo.prototype,"_isSpherical",null),u([d()],Oo.prototype,"_worldToPCSRatio",null),u([d()],Oo.prototype,"renderer",void 0),u([d({constructOnly:!0})],Oo.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"surface.suspended"})],Oo.prototype,"suspended",void 0),u([d({readOnly:!0})],Oo.prototype,"updating",null),u([d({type:Boolean})],Oo.prototype,"hasHighlights",null),u([d({type:Boolean})],Oo.prototype,"rendersOccluded",null),Oo=u([P("esri.views.3d.terrain.OverlayManager")],Oo);const hv=ni(),NP=M(),Xp={inner:Dt(),outer:Dt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},hie=Dt(),Prt=Dt(),Irt=Fn();var Gd;(function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"})(Gd||(Gd={}));class aR{constructor(t,i){this._factoryCallback=t,this._lengthCallback=i,this._pool=new Map}acquire(t){if(!aR.test.disabled){const i=this._pool.get(t);if(i&&i.length!==0)return i.pop()}try{return this._factoryCallback(t)}catch(i){const r=window.performance&&window.performance.memory;let s="";throw r&&(s=`
  totalJSHeapSize: ${r.totalJSHeapSize}, usedJSHeapSize: ${r.usedJSHeapSize}, jsHeapSizeLimit: ${r.jsHeapSizeLimit}`),console.log("Array allocation of size "+t+" failed: "+i+s),i}}release(t){if(aR.test.disabled)return;const i=this._lengthCallback(t);let r=this._pool.get(i);r||(r=new $t({shrink:!0}),this._pool.set(i,r)),r.push(t)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}aR.test={disabled:!1};const $rt=Nr().vec3f(E.POSITION).vec2f(E.UV0),HF=new aR(e=>$rt.createBuffer(e),e=>e.count);class Drt{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Ui(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=ni()}}class Lrt{constructor(t,i,r){this.values=t,this.numSurfaceIndices=i,this.numSkirtIndices=r}}function Nrt(){HF.clear(),p9.clear()}function Frt(e){HF.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const Urt=65536;function krt(e,t,i,r,s,n,o,a){const l=s[0],c=s[1],h=s[2],p=s[3],f=.1*o.radius*(p-c),g=e.numVertsPerSide-1,y=e.numVertsPerSide*e.numVertsPerSide,v=4*g,b=n&&(a===so.HAS_SOUTH_POLE||a===so.HAS_BOTH_POLES),w=n&&(a===so.HAS_NORTH_POLE||a===so.HAS_BOTH_POLES),S=HF.acquire(y+v),T=S.position.typedBuffer,A=S.uv0.typedBuffer,C=r.geometryInfo.boundingBox;Ui(C);const R=t[2]-t[0],L=t[3]-t[1],U=h-l,N=i[0],z=i[1],V=i[2];for(let te=0;te<=g;te++){const ie=te/g,$=l+ie*U;die[te]=Math.sin($),pie[te]=Math.cos($),fie[te]=ie,mie[te]=t[0]+ie*R}let B=0;const J=e.samplerData,Z=_(J)&&J.some(te=>_(te))?(te,ie)=>Aq(mie[te],ie,J):()=>0;for(let te=0;te<=g;te++){let ie=te/g;const $=qt(c,p,ie),F=Math.cos($),k=Math.sin($);let G;n?(G=o.halfSemiMajorAxis*Math.log((1+k)/(1-k)),ie=(G-t[1])/L):G=180*$/Math.PI;for(let q=0;q<=g;q++){const K=fie[q],H=die[q],ee=pie[q],ge=o.radius+Z(q,G),Ae=ee*F*ge-N,Be=H*F*ge-z,Se=k*ge-V;f9(Ae,Be,Se,C);const xe=bD*B;T[xe+0]=Ae,T[xe+1]=Be,T[xe+2]=Se,A[xe+0]=K,A[xe+1]=ie;const Re=Cq(q,te,g);if(_(Re)){const ke=bD*(y+Re),Gi=b&&te===0?-1:w&&te===g?1:0,Hr=Gi===0?Ae:-N,Cs=Gi===0?Be:-z,Rs=Gi===0?Se:o.radius*Gi-V;T[ke+0]=Hr,T[ke+1]=Cs,T[ke+2]=Rs,A[ke+0]=Gi===0?Nve(K,ie):K,A[ke+1]=Gi===0?f:ie,Gi!==0&&f9(Hr,Cs,Rs,C)}++B}}r.geometryInfo.numVertsPerRow=e.numVertsPerSide,r.geometryInfo.vertexAttributes=S,r.geometryInfo.skirtLength=f,zo(r.geometryInfo.uvOffsetAndScale,0,0,1,1),Lve(r.geometryInfo,e.numVertsPerSide,n?a:so.REGULAR,e.wireframe),r.intersectionData=null,r.skirtIntersectionData=null}function zrt(e,t,i,r,s,n){const o=t[0],a=t[1],l=t[2]-o,c=t[3]-a,h=e.clippingArea,p=_(h)?Math.max(0,(h[0]-t[0])/l):0,f=_(h)?Math.max(0,(h[1]-t[1])/c):0,g=_(h)?Math.min(1,(h[2]-t[0])/l):1,y=_(h)?Math.min(1,(h[3]-t[1])/c):1,v=g>p?1/(g-p):1,b=y>f?1/(y-f):1,w=-p*v,S=-f*b,T=l*r*.1,A=e.numVertsPerSide-1,C=e.numVertsPerSide*e.numVertsPerSide,R=4*A,L=HF.acquire(C+R),U=L.position.typedBuffer,N=L.uv0.typedBuffer,z=n.geometryInfo.boundingBox;Ui(z);let V=0;const B=ai.radius,J=e.samplerData,Z=_(J)&&J.some(te=>_(te))?(te,ie)=>Aq(te,ie,J):()=>0;for(let te=0;te<=A;te++){const ie=te/A;let $=S+ie*b,F=a+ie*c;_(h)&&(F<h[1]?(F=h[1],$=0):F>h[3]&&(F=h[3],$=1));const k=F,G=(s?(Math.PI/2-2*Math.atan(Math.exp(-k/B)))*B:k*r)-i[1];for(let q=0;q<=A;q++){const K=q/A;let H=w+K*v,ee=o+K*l;_(h)&&(ee<h[0]?(ee=h[0],H=0):ee>h[2]&&(ee=h[2],H=1));const ge=Z(ee,k),Ae=ee*r-i[0],Be=ge-i[2];f9(Ae,G,Be,z);const Se=bD*V;U[Se+0]=Ae,U[Se+1]=G,U[Se+2]=Be,N[Se+0]=H,N[Se+1]=$;const xe=Cq(q,te,A);if(_(xe)){const Re=bD*(C+xe);U[Re+0]=Ae,U[Re+1]=G,U[Re+2]=Be,N[Re+0]=Nve(H,$),N[Re+1]=T}++V}}n.geometryInfo.numVertsPerRow=e.numVertsPerSide,n.geometryInfo.vertexAttributes=L,n.geometryInfo.skirtLength=T,zo(n.geometryInfo.uvOffsetAndScale,p,f,g-p,y-f),Lve(n.geometryInfo,e.numVertsPerSide,so.REGULAR,e.wireframe),n.intersectionData=null,n.skirtIntersectionData=null}const p9=new Map;function Lve(e,t,i,r){const s=i===so.HAS_NORTH_POLE||i===so.HAS_BOTH_POLES,n=t+(r?1024:0)+(s?2048:0);let o=p9.get(n);o||(o=Brt(t,s,r),p9.set(n,o)),e.indices=o.values,e.numSurfaceIndices=o.numSurfaceIndices,e.numSkirtIndices=o.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i===so.REGULAR?0:6*(t-1)*(r?2:1))}function Brt(e,t,i){const r=e-1,s=e*e,n=4*r;let o=2*s*3,a=6*n,l=6*(2*r+r-1);i&&(o*=2,a*=2,l*=2);const c=s+n>Urt?new Uint32Array(o+a):new Uint16Array(o+a);let h=0,p=0,f=o;for(let g=0;g<=r;g++){let y=0;t&&(y=g===0?l:g===r?-l:0),f+=y;for(let v=0;v<=r;v++){const b=Cq(v,g,r);if(_(b)){const w=Vrt(v,g,r);if(w!==0){const S=h,T=s+b,A=s+(v===0&&g===1?0:b+1),C=h+w;i?(c[f++]=S,c[f++]=T,c[f++]=T,c[f++]=A,c[f++]=A,c[f++]=S,c[f++]=A,c[f++]=C,c[f++]=C,c[f++]=S,c[f++]=S,c[f++]=A):(c[f++]=S,c[f++]=T,c[f++]=A,c[f++]=A,c[f++]=C,c[f++]=S)}}if(++h,v<r&&g<r){const w=g*(r+1)+v,S=w+1,T=S+(r+1),A=T-1;i?(c[p++]=w,c[p++]=S,c[p++]=S,c[p++]=T,c[p++]=T,c[p++]=w,c[p++]=T,c[p++]=A,c[p++]=A,c[p++]=w,c[p++]=w,c[p++]=T):(c[p++]=w,c[p++]=S,c[p++]=T,c[p++]=T,c[p++]=A,c[p++]=w)}}f-=y}return new Lrt(c,o,a)}function f9(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function Nve(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function Cq(e,t,i){return t===0?e:e===i?i+t:t===i?3*i-e:e===0&&t>0?4*i-t:null}function Vrt(e,t,i){return t===0&&e!==i?1:e===i&&t!==i?i+1:t===i&&e!==0?-1:e===0&&t!==0?-(i+1):0}function Grt(e,t,i,r,s,n,o,a,l,c){const h=n.position,p=n.uv0,f=e[0],g=e[1],y=e[2],v=t[0]-f,b=t[1]-g,w=t[2]-y;r*=3;for(let S=i*=3;S<r;S+=3){const T=s[S],A=s[S+1],C=s[S+2];let R=h.get(T,0),L=h.get(T,1),U=h.get(T,2),N=h.get(A,0),z=h.get(A,1),V=h.get(A,2),B=h.get(C,0),J=h.get(C,1),Z=h.get(C,2);if(p.get(T,0)>=2){const Cs=R+a[0],Rs=L+a[1],cs=U+a[2],Os=o/Math.sqrt(Cs*Cs+Rs*Rs+cs*cs);R+=Cs*Os,L+=Rs*Os,U+=cs*Os}if(p.get(A,0)>=2){const Cs=N+a[0],Rs=z+a[1],cs=V+a[2],Os=o/Math.sqrt(Cs*Cs+Rs*Rs+cs*cs);N+=Cs*Os,z+=Rs*Os,V+=cs*Os}if(p.get(C,0)>=2){const Cs=B+a[0],Rs=J+a[1],cs=Z+a[2],Os=o/Math.sqrt(Cs*Cs+Rs*Rs+cs*cs);B+=Cs*Os,J+=Rs*Os,Z+=cs*Os}_(l)&&([R,L,U]=l.applyToVertex(R,L,U),[N,z,V]=l.applyToVertex(N,z,V),[B,J,Z]=l.applyToVertex(B,J,Z));const te=N-R,ie=z-L,$=V-U,F=B-R,k=J-L,G=Z-U,q=b*G-k*w,K=w*F-G*v,H=v*k-F*b,ee=te*q+ie*K+$*H;if(Math.abs(ee)<=Number.EPSILON)continue;const ge=f-R,Ae=g-L,Be=y-U,Se=ge*q+Ae*K+Be*H;if(ee>0){if(Se<0||Se>ee)continue}else if(Se>0||Se<ee)continue;const xe=Ae*$-ie*Be,Re=Be*te-$*ge,ke=ge*ie-te*Ae,Gi=v*xe+b*Re+w*ke;if(ee>0){if(Gi<0||Se+Gi>ee)continue}else if(Gi>0||Se+Gi<ee)continue;const Hr=(F*xe+k*Re+G*ke)/ee;Hr>=0&&c(Hr,JR(te,ie,$,F,k,G,Fve))}}function jrt(e,t,i,r,s,n){const o=r.position,a=r.uv0,l=new Map,c=3*t,h=3*i-c,p=new Uint32Array(h);let f=0;for(let y=0;y<h;++y){const v=e[y+c];if(l.has(v))p[y]=l.get(v);else{const b=f++;l.set(v,b),p[y]=b}}const g=new Float64Array(3*f);return l.forEach((y,v)=>{let b=o.get(v,0),w=o.get(v,1),S=o.get(v,2);if(a.get(v,0)>=2){const T=b+n[0],A=w+n[1],C=S+n[2],R=s/Math.sqrt(T*T+A*A+C*C);b+=T*R,w+=A*R,S+=C*R}g[3*y+0]=b,g[3*y+1]=w,g[3*y+2]=S}),{vertices:g,indices:p}}function Hrt(e,t,i,r,s,n,o,a,l){const c=n.position,h=n.uv0,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;r*=3;for(let w=i*=3;w<r;w+=3){const S=s[w],T=s[w+1],A=s[w+2];let C=c.get(S,0),R=c.get(S,1),L=c.get(S,2),U=c.get(T,0),N=c.get(T,1),z=c.get(T,2),V=c.get(A,0),B=c.get(A,1),J=c.get(A,2);h.get(S,0)>=2&&(L+=o),h.get(T,0)>=2&&(z+=o),h.get(A,0)>=2&&(J+=o),_(a)&&([C,R,L]=a.applyToVertex(C,R,L),[U,N,z]=a.applyToVertex(U,N,z),[V,B,J]=a.applyToVertex(V,B,J));const Z=U-C,te=N-R,ie=z-L,$=V-C,F=B-R,k=J-L,G=v*k-F*b,q=b*$-k*y,K=y*F-$*v,H=Z*G+te*q+ie*K;if(Math.abs(H)<=Number.EPSILON)continue;const ee=p-C,ge=f-R,Ae=g-L,Be=ee*G+ge*q+Ae*K;if(H>0){if(Be<0||Be>H)continue}else if(Be>0||Be<H)continue;const Se=ge*ie-te*Ae,xe=Ae*Z-ie*ee,Re=ee*te-Z*ge,ke=y*Se+v*xe+b*Re;if(H>0){if(ke<0||Be+ke>H)continue}else if(ke>0||Be+ke<H)continue;const Gi=($*Se+F*xe+k*Re)/H;Gi>=0&&l(Gi,JR(Z,te,ie,$,F,k,Fve))}}const die=new Array(GR+1),pie=new Array(GR+1),fie=new Array(GR+1),mie=new Array(GR+1),Fve=M();class Uve{constructor(){this._queue=new $t,this._last=null,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null}reset(t=null){this._queue.clear(),_(t)&&this._queue.pushArray(t),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class qrt{constructor(){this.q=new $t}get done(){return this.q.length===0}reset(t){if(this.q.clear(),!O(t)){this.q.pushArray(t);for(let i=0;i<this.q.length;++i){const r=this.q.data[i];r.isLeaf||this.q.pushArray(r.children)}}}next(){return this.q.pop()}}function VA(e,t,i){if(O(t)||O(t.fullExtent))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=e.surface.tilingScheme.levels[e.level].scale;return!(t.minScale>0&&n>1.00000001*t.minScale)&&!(t.maxScale>0&&n<.99999999*t.maxScale)}function kve(e,t){t.sort((i,r)=>zve(i,r,e))}function zve(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:0}function Wrt(e,t){const i=new Map;e.forAll(r=>i.set(r.lij,r.distanceToSquared(t))),e.sort((r,s)=>i.get(r.lij)-i.get(s.lij))}function Xrt(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),(1&e.lij[1])==0&&(n+=.5),(e=e.parent)==null)throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function Yrt(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==i&&n.loadable)return!0}}return!1}function pft(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}class Rq{get updating(){return!!this._tileRequested}init(t,i,r,s){this.tile=t,this._layerIdx=i,this._layerClass=r,this._suspended=s,this._tileLayerInfo=t.getLayerInfo(i,r),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(t){t!==this._suspended&&(this._suspended=t,t?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const t=this._findAncestorWithData();return this._setUpsampleTile(t),this._requestNext()}dataArrived(t){this._setUpsampleTile(t),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,Xs.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return _(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const t=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(t,i),s=u9(r),{minLevel:n,maxLevel:o}=r.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?VA:()=>!0;let h=this.tile;const p=h.level;let f;const g=this._tileLayerInfo.upsampleInfo,y=g?g.tile.level:-1,v=bs(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const b=h.level,w=p-b,S=h.layerInfo[i][t];if(S.data&&w>=a){b>y&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}if((O(v)||v.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&b<=o&&!S.data&&!S.dataMissing&&((O(f)||h.level===n||b%Ope==0||p-f.level<a)&&(f=h),w>=l))break;h=h.parent}return _(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const t=this.tile.vlevel,i=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(t-s.level>=i)return s;r=s}return r}_setUpsampleTile(t){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,Xs.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class Zrt extends Rq{get _desiredMinLevelDelta(){throw gie}get _progressiveLevelModulo(){throw gie}dispose(){}}const gie=new Error("Abstract method called on TileAgent"),Ia=new Zrt;class Bve extends Rq{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return mI(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class Vve extends Rq{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Ope}}function Qrt(e,t,i="nearest",r=!1){var s;const n=!(r&&t.pixelType==="u8"),o=n?yt.FLOAT:yt.UNSIGNED_BYTE,a=t.pixels==null||t.pixels.length===0?null:n?t.getAsRGBAFloat():t.getAsRGBA(),l=(s=e.capabilities.textureFloat)==null?void 0:s.textureFloatLinear,c={width:t.width,height:t.height,target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:e.type===Kt.WEBGL2&&n?st.RGBA32F:Ie.RGBA,samplingMode:!l||i!=="bilinear"&&i!=="cubic"?Ve.NEAREST:Ve.LINEAR,dataType:o,wrapMode:lt.CLAMP_TO_EDGE,flipped:!1};return new Ze(e,c,a)}function Jrt(e,t){const{spacing:i,offsets:r,coefficients:s,size:[n,o]}=t,a=i[0]>1,l={width:a?4*n:n,height:o,target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:e.type===Kt.WEBGL2?st.RGBA32F:Ie.RGBA,dataType:yt.FLOAT,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,flipped:!1},c=new Float32Array(a?n*o*16:2*r.length);if(a)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),g=2*(p*o+h);c[f]=r[g],c[f+1]=r[g+1],c[f+3]=r[g]===-1?0:1}return new Ze(e,l,c)}function yie(e,t){const i={width:t.length/4,height:1,target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,flipped:!1};return new Ze(e,i,t)}function Krt(e,t,i,r=1,s=!0,n=!1){return{u_flipY:s,u_isFloatTexture:n,u_applyTransform:!!e,u_opacity:r,u_transformSpacing:e?e.spacing:null,u_transformGridSize:e?e.size:null,u_targetImageSize:t,u_srcImageSize:i}}function est(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:null}}function tst(e,t){return{u_scale:e,u_offset:t}}function ist(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function rst(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}function sst(e,t){const i=e.gl,r=t.glName,s=i.getProgramParameter(r,i.ACTIVE_UNIFORMS),n=new Map;let o;for(let a=0;a<s;a++)o=i.getActiveUniform(r,a),o&&n.set(o.name,{location:i.getUniformLocation(r,o.name),info:o});return n}function A2(e,t,i){Object.keys(i).forEach(r=>{const s=t.get(r)||t.get(r+"[0]");s&&nst(e,r,i[r],s)})}function nst(e,t,i,r){if(r===null||i==null)return!1;const{info:s}=r;switch(s.type){case Po.FLOAT:s.size>1?e.setUniform1fv(t,i):e.setUniform1f(t,i);break;case Po.FLOAT_VEC2:e.setUniform2fv(t,i);break;case Po.FLOAT_VEC3:e.setUniform3fv(t,i);break;case Po.FLOAT_VEC4:e.setUniform4fv(t,i);break;case Po.FLOAT_MAT3:e.setUniformMatrix3fv(t,i);break;case Po.FLOAT_MAT4:e.setUniformMatrix4fv(t,i);break;case Po.INT:s.size>1?e.setUniform1iv(t,i):e.setUniform1i(t,i);break;case Po.BOOL:e.setUniform1i(t,i?1:0);break;case Po.INT_VEC2:case Po.BOOL_VEC2:e.setUniform2iv(t,i);break;case Po.INT_VEC3:case Po.BOOL_VEC3:e.setUniform3iv(t,i);break;case Po.INT_VEC4:case Po.BOOL_VEC4:e.setUniform4iv(t,i);break;default:return!1}return!0}const vie={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class _ie{constructor(t,i,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=i,this.width=r||i.width,this.height=s||i.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?me(I({},vie),{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||vie}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){_(t)&&t.length>0?this._bandIds&&t.every((i,r)=>!!this._bandIds[r]&&i===this._bandIds[r])||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture){const i=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(i==="bilinear"?Ve.LINEAR:Ve.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Jrt(t,this.transformGrid))),!0)}getUniforms(){const t=tst(this.scale,this.offset),{symbolizerParameters:i,transformGrid:r,width:s,height:n,opacity:o}=this;return{basic:t,common:Krt(r,[s,n],[this.source.width,this.source.height],o),colormap:i.colormap?est(i.colormap,i.colormapOffset):null,stretch:this.symbolizerParameters.type==="stretch"?ist(this.symbolizerParameters):null,hillshade:this.symbolizerParameters.type==="hillshade"?rst(this.symbolizerParameters):null}}getTextures(){const t=new Array,i=[];return this._rasterTexture&&(i.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(i.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(i.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:i}}get memoryUsage(){if(O(this._memoryUsed)){const t=this.getTextures();if(t==null)return 0;this._memoryUsed=t.textures.map(i=>i.descriptor.width*i.descriptor.height*4).reduce((i,r)=>i+r,0)}return this._memoryUsed}release(){return this._rasterTexture=et(this._rasterTexture),this._transformGridTexture=et(this._transformGridTexture),this._colormapTexture=et(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,i){const r=this.source?this.source.extractBands(i):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const s=O(i)&&O(this.bandIds)||_(i)&&_(this.bandIds)&&i.join("")===this.bandIds.join("");if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTexture=null}const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Qrt(t,r,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"?"nearest":"bilinear"}_updateColormapTexture(t){const i=this._colormap,r=this.symbolizerParameters.colormap;return r?i?r.length!==i.length||r.some((s,n)=>s!==i[n])?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=yie(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=yie(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}class HI{constructor(){this.waitingAgents=new $t,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(t){const i=mk.acquire();return i._init(t),i}release(){this.dispose(),qI.delete(this),mk.release(this)}dispose(){this.loadingAgent=et(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Fx(this._data)}static prune(){mk.prune(0)}_init(t){this.waitingAgents.clear(),this._data=Fx(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=xu(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(t,i){if(t===i||O(i))this._unsetUpsampleInfo();else{if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===i)return;this._upsampleInfo.tile.unrefMapData()}i.refMapData(),Xrt(t,i,this._upsampleInfo)}}get data(){return this._data}set data(t){Fx(this._data),this._data=t}}const mk=new Gr(HI,null,()=>{}),qI=new Map;function ost(){qI.size>0&&(console.log(`${qI.size} live TilePerLayerInfo allocations:`),qI.forEach(e=>console.log(e,`
`)))}class dy{constructor(t){this._texture=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}var vt;(function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"})(vt||(vt={}));const gk=M(),Bb=M(),en=M(),ast=.1;class lst{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class Oq{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Dt(),this._elevationBounds=Xe(),this.layerInfo=[[],[]],this.extentInRadians=Dt(),this.centerAtSeaLevel=M(),this._center=[M(),vn(),M()],this.up=q9(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=C2,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){Mq.prune(0),Pq.prune(0),HI.prune()}get usedMemory(){return this._usedMemory===C2&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===C2&&this._updateMemoryUsed();let t=this._mapTileMemory;for(const{data:i}of this.layerInfo[Lt.MAP])i instanceof fL&&(t+=i.memoryUsage);return t}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Do.MIDDLE][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.computeVisibility(),this._visible}computeVisibility(){this._dirty=!1;const t=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setNeedsRender()),t}get shouldLoad(){if(!this.loadable)return!1;if(this._surface.lodSnapping===HT.ON){const t=this.level-this._surface.snapLevel;if(t===0)return!0;if(t===1)return!1}return this.isLeaf}init(t,i,r){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=di(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Do.MIDDLE][3]=0,this.vlevel=t?t[0]:0,i&&i.elevationBounds?Fs(this._elevationBounds,i.elevationBounds):tr(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=r,this.updateVisibility();for(const s of t_){const n=r.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=HI.acquire(this._surface.upsampleInfoPool),s===Lt.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,GR)}release(){yh(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const t of t_){for(const i of this.layerInfo[t])i.release();this.layerInfo[t].length=0}this._parent=null,this._surface=null,this._usedMemory=C2}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const t=this.cachedMemory;t>0&&(this._surface.upsampleMapCache.put(this.key,this,t),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=C2}get cpuImageMemorySize(){const i=this._surface.tilingScheme.pixelSize;return i*i*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const t=this.cpuImageMemorySize;for(const{data:i}of this.layerInfo[Lt.MAP])i instanceof dy?this._mapTileMemory+=Xy(i.texture):i instanceof HTMLImageElement||i instanceof oR?this._mapTileMemory+=t:i instanceof _ie&&(this._mapTileMemory+=i.memoryUsage);for(const i of this.layerInfo[Lt.ELEVATION])this._usedMemory+=i.data?t:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=Xy(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory)}getUsedMemoryForLayer(t,i){const r=this.layerInfo[t][i];if(!r||!r.data)return 0;if(t!==Lt.MAP||this.isCached){if(t===Lt.ELEVATION)return this.cpuImageMemorySize}else{const s=r.data;if(s instanceof dy)return Xy(s.texture);if(s instanceof HTMLImageElement||s instanceof oR)return this.cpuImageMemorySize;if(s instanceof fL||s instanceof _ie)return s.memoryUsage}return 0}updateScreenDepth(t){const i=this._center[Do.MIDDLE],r=t,s=i[0],n=i[1],o=i[2],a=r[2]*s+r[6]*n+r[10]*o+r[14];this._screenDepth=a<0?0:a/(r[3]*s+r[7]*n+r[11]*o+r[15])}shouldSplit(t,i,r){if(_(t.frustum)&&(!this._intersectsClippingArea||!this._isVisible(t.frustum)))return vt.NONE;const s=this.level;de(gk,this._center[Do.MIDDLE],i);let n=Fo(gk),o=Do.MIDDLE;de(Bb,this._center[Do.TOP],i);const a=Fo(Bb);a<n&&(n=a,o=Do.TOP),de(Bb,this._center[Do.BOTTOM],i);const l=Fo(Bb);if(l<n&&(n=l,o=Do.BOTTOM),this._edgeLen2>n&&s<t.maxLod)return vt.SPLIT;const c=Math.sqrt(n),h=t.fovX*c*2,p=this._edgeLen/h,f=()=>{const b=s+Math.ceil(-Math.log2(t.relativeWidthLimit/p));return b!==this.vlevel?(this.vlevel=b,vt.VSPLITMERGE):vt.NONE_HIT_MAXLOD};if(r===HT.ON&&this._surface.snapLevel-s===1)return s>=t.maxLod?f():vt.SPLIT;const g=_e(this.up,gk),y=this._elevationBounds[1]-this._elevationBounds[0],v=y/this.edgeLen;if(t.aboveGround&&g>0&&v<.001&&g/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return vt.NONE;if(p<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,vt.VSPLITMERGE):vt.NONE;if(s>=t.maxLod)return f();if(s>6){de(Bb,this._center[o],i),ae(en,this.up,g),de(en,en,Bb);const b=Fo(en);if(b>this.radius*this.radius){ae(en,en,this.radius/Math.sqrt(b)),pe(en,en,this._center[o]),de(en,i,en);const w=Math.min(1,(Math.abs(_e(en,this.up))+.5*y+this._curvatureHeight)/Pe(en)),S=ast/t.angledSplitBias,T=t.fovY*c*2;if(w*(this._edgeLen/T)<S*t.relativeHeightLimit)return vt.NONE}}return vt.SPLIT}setChildren(t,i,r,s){yh(!!(t&&i&&r&&s),"Null child passed"),this._children[0]=t,this._children[1]=i,this._children[2]=r,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(t){this.refMapData();for(const i of t_)this._createOrUpdateAgents(0,i);t.loadTile(this)}unload(t){t.unloadTile(this);for(const i of t_){const r=this.layerInfo[i];for(const s of r)s.loadingAgent&&s.loadingAgent!==Ia&&(FP(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(vt.GEOMETRY),this.resetPendingUpdate(vt.TEXTURE_NOFADING),this.resetPendingUpdate(vt.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const t=this.layerInfo[Lt.MAP];for(const i of t)i.loadingAgent&&i.loadingAgent!==Ia&&(FP(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(z_(t,this._clippingArea))return!1;const i=this._intersectsClippingArea,r=this._isWithinClippingArea;_(t)?(this._intersectsClippingArea=this.intersectsExtent(t),this._isWithinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=t,this.updateVisibility();const s=r&&this._isWithinClippingArea,n=!(r||i||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(vt.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,i){return this.layerInfo[i][t]}hasLayerData(t,i){const r=this.layerInfo[i][t];return!(!r||!r.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const t of t_){const i=this.layerInfo[t];for(const r of i)if(r.loadingAgent&&r.loadingAgent!==Ia&&r.loadingAgent.updating)return!0}return!1}_isSuspended(t){return!!this.hasPendingUpdate(vt.SPLIT)||t!==Lt.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){this._pendingUpdates|=t,t===vt.SPLIT||t===vt.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,i,r){const s=this.layerInfo[i][t];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),r.dataArrived(this),!0;if(s.requestPromise)return!0;xu(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,t,i,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(t){return this.lij[0]===t[0]&&this.lij[1]===t[1]&&this.lij[2]===t[2]}findByLij(t){return this.hasLij(t)?this:this.isLeaf?null:this._children[0].findByLij(t)||this._children[1].findByLij(t)||this._children[2].findByLij(t)||this._children[3].findByLij(t)||null}distanceToSquared(t){return Fo(de(en,this._center[Do.MIDDLE],t))}containsPoint(t){const i=this.extent;return t[0]>=i[0]&&t[1]>=i[1]&&t[0]<=i[2]&&t[1]<=i[3]}unrequestLayerData(t,i,r){const s=this.layerInfo[i][t],n=s.waitingAgents,o=n.removeUnordered(r)!=null;yh(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed())}dataArrived(t,i,r){const s=this.layerInfo[i][t];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(t,i,r){r.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${i}/${t} error ${r}`);const s=this.layerInfo[i][t];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(t,i){switch(t){case Lt.MAP:return this._updateTexture(i);case Lt.ELEVATION:return this._updateGeometry()}}_updateTexture(t){this.renderData&&(this.resetPendingUpdate(t===Xs.FADING?vt.TEXTURE_NOFADING:vt.TEXTURE_FADING),this.setPendingUpdate(t===Xs.FADING?vt.TEXTURE_FADING:vt.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(vt.GEOMETRY);for(const t of this.layerInfo[Lt.ELEVATION])t.pendingUpdates|=vt.GEOMETRY}invalidateLayerData(t,i){this.layerInfo[i][t].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){tr(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const t=this.layerInfo[Lt.ELEVATION];let i=!0;for(const r of t)_(r.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],r.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],r.elevationBounds.max),r.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const t=.5*(this._elevationBounds[0]+this._elevationBounds[1]);ae(en,this.up,t),pe(this._center[Do.MIDDLE],this.centerAtSeaLevel,en),ae(en,this.up,this._elevationBounds[0]),pe(this._center[Do.TOP],this.centerAtSeaLevel,en),ae(en,this.up,this._elevationBounds[1]),pe(this._center[Do.BOTTOM],this.centerAtSeaLevel,en)}findElevationBoundsForLayer(t,i){const r=this.layerInfo[Lt.ELEVATION][t];if(_(r.elevationBounds)&&r.elevationBounds.level>=i)return;const s=this._surface.layerViewByIndex(t,Lt.ELEVATION),n=u9(s);if(!VA(this,n,!1))return;const o=ust;let a=!1;if(r.data){const l=r.data;o.min=l.bounds[0],o.max=l.bounds[1],o.hasNoDataValues=l.hasNoDataValues,o.level=this.lij[0],a=!0}else{let l,c,h=0;for(let p=this._parent;p&&(!c||h<mI(this.level))&&(h=this.vlevel-p.level,l=c||l,c=p.layerInfo[Lt.ELEVATION][t].data,!(!c&&l&&h>=mI(this.level)));p=p.parent);c=c||l,c&&(c.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=c.level,a=!0))}a&&(O(r.elevationBounds)&&(r.elevationBounds=new Eq),r.elevationBounds.copyFrom(o))}modifyLayers(t,i,r){const s=this.layerInfo[r];for(const a of s)a.loadingAgent&&a.loadingAgent!==Ia&&(FP(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)t[a]===void 0&&s[a].release();const n=new Array(...s),o=i.length;s.length=o;for(let a=0;a<o;a++){const l=i[a];s[a]=l>-1?n[l]:HI.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,Xs.FADING))}updateAgents(t){if(this.renderData){const i=this.layerInfo[t];for(const r of i)r.loadingAgent===Ia&&(r.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(const t of t_){const i=this._isSuspended(t);for(const r of this.layerInfo[t])r.loadingAgent&&r.loadingAgent!==Ia&&(r.loadingAgent.setSuspension(i),r.loadingAgent===Ia&&this.updateRenderData(t,Xs.FADING))}}removeLayerAgent(t,i){const r=this.layerInfo[i][t];r.loadingAgent&&r.loadingAgent!==Ia&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(t,i){const r=this.layerInfo[i][t];r.loadingAgent=Ia,r.data||r.upsampleInfo||this._createOrUpdateAgents(t+1,i)}_createOrUpdateAgents(t,i){const r=this._isSuspended(i),s=this.layerInfo[i];for(let n=t;n<s.length;++n){const o=s[n];let a=!1;const l=this._surface.layerViewByIndex(n,i),c=u9(l);if(o.loadingAgent?VA(this,c,!1)?(o.loadingAgent!==Ia&&o.loadingAgent.setSuspension(r),o.loadingAgent!==Ia&&(a=o.loadingAgent.update())):o.dispose():VA(this,c,!1)&&(o.loadingAgent=cst(this,n,i,r),a=o.loadingAgent.startLoading(),a?o.loadingAgent===Ia&&this.setPendingUpdate(vt.GEOMETRY):(FP(o.loadingAgent),o.loadingAgent=Ia)),o.loadingAgent===Ia&&this.updateRenderData(i,Xs.FADING),a&&l.isOpaque)return}}_isWithinExtent(t){const i=this.extent;return i[0]>=t[0]&&t[2]>=i[2]&&i[1]>=t[1]&&t[3]>=i[3]}intersectsExtent(t){const i=this.extent;return i[2]>=t[0]&&t[2]>=i[0]&&i[3]>=t[1]&&t[3]>=i[1]}getElevationBasedVerticesPerRow(t){const i=this.vlevel-this.level,r=Math.max(this.level-t,mI(this.level)-i);return ze(1+(this.maxTesselation>>r),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}}function cst(e,t,i,r){const s=i===Lt.ELEVATION?Pq.acquire():Mq.acquire();return s.init(e,t,i,r),s}function FP(e){e.dispose(),e instanceof Bve?Pq.release(e):e instanceof Vve&&Mq.release(e)}const Mq=new Gr(Vve),Pq=new Gr(Bve),ust=new Eq,C2=-1;var Do;(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(Do||(Do={}));class hst extends Oq{constructor(t,i,r){super(),this.horizontalScaleFactor=1,this.isWebmercatorOnPlateeCaree=!1,this.extentInRenderSR=Dt(),t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r);const s=r.view.renderSpatialReference,n=r.spatialReference,o=_(s)&&Sne(s),a=o&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this.horizontalScaleFactor=a,this.isWebmercatorOnPlateeCaree=o&&n.isWebMercator;const l=this.extentInRenderSR,c=this.extent;if(this.isWebmercatorOnPlateeCaree){const h=je(c[0],c[1],0);yn(h,tt.WebMercator,h,tt.PlateCarree);const p=je(c[2],c[3],0);yn(p,tt.WebMercator,p,tt.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*a;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const t=this.extentInRenderSR,i=.5*(t[2]-t[0]),r=.5*(t[3]-t[1]),s=Math.sqrt(i*i+r*r),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[Do.MIDDLE][3]=o}_isVisible(t){return F9e(t,this._aabb())}_aabb(){const t=this.extentInRenderSR;return $Se(t[0],t[1],this.elevationBounds[0],t[2],t[3],this.elevationBounds[1])}intersectsRay(t,i,r,s,n){UP[0]=1/i[0],UP[1]=1/i[1],UP[2]=1/i[2];const o=n*(this.extent[2]-this.extent[0])*this.horizontalScaleFactor*.1;return RH(this._aabb(),t,UP,r+o,s)}createGeometry(t,i){zrt(t,this.extent,i,this.horizontalScaleFactor,this.isWebmercatorOnPlateeCaree,this.renderData),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<9?3:2}}const UP=M();var lR;(function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(lR||(lR={}));class dst extends Oq{constructor(t,i,r){super(),this.obb=new Array(8),this.isWebMercator=!1;for(let s=0;s<8;s++)this.obb[s]=M();t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r),this.isWebMercator=r.tilingScheme.spatialReference.isWebMercator;const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=t[0],h=qt(o,l,.5),p=qt(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),FS(this.centerAtSeaLevel,p,h,this.ellipsoid.radius,0);const g=aa(this.centerAtSeaLevel);be(g,g),this.up=g,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(this.lij[0]===0)oe(this._center[fh.MIDDLE],0,0,0),oe(this._center[fh.TOP],0,0,0),oe(this._center[fh.BOTTOM],0,0,0),this.ellipsoid||(this.ellipsoid=di(this.surface.spatialReference)),this._center[fh.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const t=Math.max(ko(this._center[fh.MIDDLE],this.obb[0]),ko(this._center[fh.MIDDLE],this.obb[1]));this._center[fh.MIDDLE][3]=Math.sqrt(t)}}_isVisible(t){if(!Ny(t,this._center[fh.MIDDLE]))return!1;if(this.lij[0]<10)return!0;const i=this.obb;for(let r=0;r<m0.NUM;r++){const s=r===qi.NEAR,n=t[r];s&&(R2[0]=n[0],R2[1]=n[1],R2[2]=n[2],R2[3]=n[3]-this.surface.view.state.camera.near);const o=s?R2:n;let a;for(a=0;a<8;a++){const l=i[a];if(o[0]*l[0]+o[1]*l[1]+o[2]*l[2]+o[3]<0)break}if(a===8)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(t,i){const r=this._getPatchType(this.lij[1],this.lij[0]);krt(t,this.extent,i,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,r),this.setMemoryDirty()}_updateOBB(){const t=this.extentInRadians,i=this.obb;for(let r=0;r<2;r++){const s=this.elevationBounds[r];let n=4*r;FS(i[n++],t[0],t[1],this.ellipsoid.radius,s),FS(i[n++],t[0],t[3],this.ellipsoid.radius,s),FS(i[n++],t[2],t[3],this.ellipsoid.radius,s),FS(i[n++],t[2],t[1],this.ellipsoid.radius,s)}if(this.isWebMercator)switch(this._getPatchType(this.lij[1],this.lij[0])){case so.HAS_NORTH_POLE:oe(i[1],0,0,this.ellipsoid.radius),oe(i[2],0,0,this.ellipsoid.radius),oe(i[5],0,0,this.ellipsoid.radius),oe(i[6],0,0,this.ellipsoid.radius);break;case so.HAS_SOUTH_POLE:oe(i[0],0,0,-this.ellipsoid.radius),oe(i[3],0,0,-this.ellipsoid.radius),oe(i[4],0,0,-this.ellipsoid.radius),oe(i[7],0,0,-this.ellipsoid.radius)}}_getPatchType(t,i){return t===(1<<i)-1?t===0?so.HAS_BOTH_POLES:so.HAS_SOUTH_POLE:t===0?so.HAS_NORTH_POLE:so.REGULAR}intersectsRay(t,i,r,s,n){const o=this._center[fh.MIDDLE],a=o[3]+r+.2*this.ellipsoid.radius*Math.abs(n*(this.extentInRadians[3]-this.extentInRadians[1])),l=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],c=o[0]-t[0],h=o[1]-t[1],p=o[2]-t[2],f=(c*i[0]+h*i[1]+p*i[2])/l,g=i[0]*f-c,y=i[1]*f-h,v=i[2]*f-p;return g*g+y*y+v*v<a*a}getDefaultVerticesPerRowOnLevel(){return this.level<bie.length?bie[this.level]+1:2}}const bie=[128,64,32,16,16,8,8,4],R2=ii();var fh;(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(fh||(fh={}));class yk{constructor(){this.numVertsPerSide=0,this.wireframe=!1}}class Ux{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=it(this._current),this._next=it(this._next),this._waiting=it(this._waiting),this._delayed=it(this._delayed)}get current(){if(O(this._current))return null;if(!this._isFadingEnabled){const i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let t=Ux.test.fadeMoment;if(_(this._delayed)&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,am.Immediate),this._delayed=null)),_(this._next)){t=t||performance.now();const i=this._fadeDuration,r=_(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==Xs.FADING,n=t-this._fadeStart>=i;(r||s||n)&&(it(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(O(this._next))return 1;const t=Ux.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return _(this._next)||_(this._delayed)}push(t,i=am.Immediate){this._delayed=it(this._delayed),this._push(t,i)}_push(t,i){if(this._isFadingEnabled||this.clear(),O(this._current))return void(this._current=t);const r=Ux.test.fadeMoment||performance.now();return i!==am.Immediate?(this._delayed=t,void(this._delayedTime=r+i)):O(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void(O(t)||(it(this._waiting),this._waiting=t))}get _fadeDuration(){return O(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const i=this._getFadeDuration();return t+i-t%i}get _isFadingEnabled(){return this._getFadeDuration()>0}}var am;Ux.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(am||(am={}));class pst{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(t,i,r){this._scales[2*t]=i,this._scales[2*t+1]=r}setOffset(t,i,r){this._offsets[2*t]=i,this._offsets[2*t+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}class fst{constructor(){this.geometryInfo=new Drt,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState=new yk,this._textureRef=new Ux(()=>this.tile.surface.textureFadeDuration),this.overlay=new pst}init(t){this.tile=t,this.clear();const i=this.geometryInfo;i.indices=null,i.vertexAttributes=null,Ui(i.boundingBox),i.numSurfaceIndices=0,i.numSkirtIndices=0,i.numWithoutSkirtIndices=0,i.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState=new yk,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(t,i){return!!this._updateGeometryState(i)&&(this._releaseGeometry(),this._createGeometry(t),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState=new yk,!0)}ensureTexture(t,i){return _(this._texture)&&this._texture.descriptor.width!==t&&this.releaseTexture(),O(this._texture)&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){_(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(t){const i=this._getElevationInfo(),r=i.samplerData?this.tile.getElevationBasedVerticesPerRow(i.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const n=this.geometryState;let o=!1;return n.numVertsPerSide!==r&&(n.numVertsPerSide=r,o=!0),i.changed&&(n.samplerData=i.samplerData,o=!0),J_(n.clippingArea,s)||(n.clippingArea=s,o=!0),n.wireframe!==t&&(n.wireframe=t,o=!0),o}_createGeometry(t){this.tile.createGeometry(this.geometryState,this.localOrigin);const i=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,s=t.gl;this._vao=new as(t,mi,{geometry:wl(i.layout)},{geometry:jt.createVertex(t,s.STATIC_DRAW,i.buffer)},jt.createIndex(t,s.STATIC_DRAW,r))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,Frt(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(t,i=am.Immediate){_(t)&&t.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(t,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const t=this.geometryState.samplerData,i=this.tile.layerInfo[Lt.ELEVATION],r=i.length;let s=new Array(r),n=0,o=0,a=!1;for(let l=0;l<r;l++){const c=i[l];if(c.upsampleInfo){const h=c.upsampleInfo.tile,p=h.layerInfo[Lt.ELEVATION][l].data,f=p&&p.samplerData;t&&t[n]===f||(a=!0),s[n++]=f,o=Math.max(o,h.lij[0])}else if(c.data){const h=this.tile.surface.layerViewByIndex(l,Lt.ELEVATION);if(VA(this.tile,h.layer,!1)){const p=c.data;t&&t[n]===p.samplerData||(a=!0),s[n++]=p.samplerData,o=this.tile.level}}}return _(t)&&t.length!==n&&(a=!0),n>0?s.length=n:s=null,{changed:a,samplerData:s,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){const t=Qa(this.intersectionData,0,i=>i.estimatedMemoryUsage)+Qa(this.skirtIntersectionData,0,i=>i.estimatedMemoryUsage+i.vertexPositionBuffer.byteLength);return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+t}get textureDescriptor(){return _(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}}class mst{constructor(){this.extent=ni(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class gst{constructor(){this._queries=new $t({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new $t({initialSize:30}),this._queryPool=new Gr(mst)}queryVisibleLevelRange(t,i,r,s){const n=this._queryPool.acquire();fa(n.extent,t),n.minLevel=i||-Number.MAX_VALUE,n.maxLevel=r!=null?r:Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n)}hasPendingQueries(){return this._queryQueue.length!==0}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const t=this._queryQueue.pop();this._queries.push(t)}this._queriesInvPtr=this._queries.length}processQueries(){for(let t=0;t<this._queries.length;t++){const i=this._queries.data[t];this._queryPool.release(i),i.callback(t>=this._queriesInvPtr),i.callback=null}this._queries.clear()}scaleQueriesForTile(t){const i=t.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],n=s.extent;i>=s.minLevel&&i<=s.maxLevel&&n[0]<=t.extent[2]&&n[2]>=t.extent[0]&&n[1]<=t.extent[3]&&n[3]>=t.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}}var lm,U1;(function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"})(lm||(lm={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(U1||(U1={}));function yst(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function vst(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function _st(e,t,i,r,s,n,o){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e}function Gve(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let l=i*n-r*s;return l?(l=1/l,e[0]=n*l,e[1]=-r*l,e[2]=-s*l,e[3]=i*l,e[4]=(s*a-n*o)*l,e[5]=(r*o-i*a)*l,e):null}function bst(e){return e[0]*e[3]-e[1]*e[2]}function jve(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1],p=i[2],f=i[3],g=i[4],y=i[5];return e[0]=r*c+n*h,e[1]=s*c+o*h,e[2]=r*p+n*f,e[3]=s*p+o*f,e[4]=r*g+n*y+a,e[5]=s*g+o*y+l,e}function Iq(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=Math.sin(i),h=Math.cos(i);return e[0]=r*h+n*c,e[1]=s*h+o*c,e[2]=r*-c+n*h,e[3]=s*-c+o*h,e[4]=a,e[5]=l,e}function Hve(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r*c,e[1]=s*c,e[2]=n*h,e[3]=o*h,e[4]=a,e[5]=l,e}function $q(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=r*c+n*h+a,e[5]=s*c+o*h+l,e}function wst(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e[4]=0,e[5]=0,e}function xst(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e}function Dq(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e}function Tst(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}function Sst(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+1)}function Est(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e}function qve(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e}function Ast(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e}function Cst(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e}function Rst(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]}function Ost(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=t[0],c=t[1],h=t[2],p=t[3],f=t[4],g=t[5];return Math.abs(i-l)<=wt*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=wt*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(s-h)<=wt*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=wt*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=wt*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-g)<=wt*Math.max(1,Math.abs(a),Math.abs(g))}const Mst=jve,Pst=qve;Object.freeze({__proto__:null,copy:yst,identity:vst,set:_st,invert:Gve,determinant:bst,multiply:jve,rotate:Iq,scale:Hve,translate:$q,fromRotation:wst,fromScaling:xst,fromTranslation:Dq,str:Tst,frob:Sst,add:Est,subtract:qve,multiplyScalar:Ast,multiplyScalarAndAdd:Cst,exactEquals:Rst,equals:Ost,mul:Mst,sub:Pst});function Wve(){const e=new Float32Array(6);return e[0]=1,e[3]=1,e}function Ist(e){const t=new Float32Array(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function $st(e,t,i,r,s,n){const o=new Float32Array(6);return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function Dst(e,t){return new Float32Array(e,t,6)}function Xve(e,t,i,r){const s=t[r],n=t[r+1];e[r]=i[0]*s+i[2]*n+i[4],e[r+1]=i[1]*s+i[3]*n+i[5]}function Lst(e,t,i,r=0,s=0,n=2){const o=s||t.length/n;for(let a=r;a<o;a++)Xve(e,t,i,a*n)}Object.freeze({__proto__:null,create:Wve,clone:Ist,fromValues:$st,createView:Dst,transform:Xve,transformMany:Lst});function WI(){return[1,0,0,1,0,0]}function Nst(e){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function Fst(e,t,i,r,s,n){return[e,t,i,r,s,n]}function Ust(e,t){return new Float64Array(e,t,6)}Object.freeze({__proto__:null,create:WI,clone:Nst,fromValues:Fst,createView:Ust});function kst(e){return e instanceof Float32Array&&e.length>=2}function zst(e){return Array.isArray(e)&&e.length>=2}function vk(e){return kst(e)||zst(e)}const Bst=96,Vst=39.37;function Lq(e,t){return t.type?tr(e,t.x,t.y):Fs(e,t)}function Gst(e){return bl(e)}function jst(e,t){const i=e.targetGeometry,r=t.targetGeometry;return i.x=r.x,i.y=r.y,i.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}const Hst=function(){const e=Xe();return function(t,i,r){const s=i.targetGeometry;Lq(e,s);const n=.5*qF(i);return t.xmin=e[0]-n*r[0],t.ymin=e[1]-n*r[1],t.xmax=e[0]+n*r[0],t.ymax=e[1]+n*r[1],t.spatialReference=s.spatialReference,t}}();function qF(e){return e.scale*qst(e.targetGeometry)}function qst(e){return _(e)&&hc(e.spatialReference)?1/(Gst(e.spatialReference)*Vst*Bst):1}function Wst(e){return IL(e.rotation)||0}const Nq=function(){const e=Xe(),t=Xe(),i=Xe();return function(r,s,n,o,a,l){return $j(e,s),tl(t,n,.5*l),tr(i,1/o*l,-1/o*l),Dq(r,t),a&&Iq(r,r,a),Hve(r,r,i),$q(r,r,e),r}}(),Xst=function(){const e=Xe();return function(t,i,r,s){const n=qF(i),o=Wst(i);return Lq(e,i.targetGeometry),Nq(t,e,r,n,o,s)}}(),Yst=function(){const e=Xe();return function(t,i,r,s){const n=qF(i);return Lq(e,i.targetGeometry),Nq(t,e,r,n,0,s)}}();function Zst(e){if(e.isWrappable){const t=Gy(e);return t.valid[1]-t.valid[0]}return 0}function Qst(e,t){return Math.round(Zst(e)/t)}var m9;const Yp=[0,0];let Jg=m9=class extends ve{constructor(e){super(e),this._viewpoint2D={center:Xe(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new Zt,this.id=0,this.inverseTransform=WI(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=WI(),this.transformNoRotation=WI(),this.displayMat3=om(),this.displayViewMat3=om(),this.viewMat3=om(),this.viewMat2d=Wve(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(e){this._set("pixelRatio",e),this._update()}set size(e){this._set("size",e),this._update()}set viewpoint(e){if(e){const t=this._viewpoint2D,i=e.targetGeometry;t.center[0]=i.x,t.center[1]=i.y,t.rotation=e.rotation,t.scale=e.scale,t.spatialReference=i.spatialReference}this._update()}copy(e){const t=this.size,i=this.viewpoint;return i&&t?(this.viewpoint=jst(i,e.viewpoint),this._set("size",Fs(t,e.size))):(this.viewpoint=e.viewpoint.clone(),this._set("size",[e.size[0],e.size[1]])),this._set("pixelRatio",e.pixelRatio),this}clone(){return new m9({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(e,t,i){return vk(t)?Yv(e,t,this.inverseTransform):(Yp[0]=t,Yp[1]=i,Yv(e,Yp,this.inverseTransform))}toScreen(e,t,i){return vk(t)?Yv(e,t,this.transform):(Yp[0]=t,Yp[1]=i,Yv(e,Yp,this.transform))}toScreenNoRotation(e,t,i){return vk(t)?Yv(e,t,this.transformNoRotation):(Yp[0]=t,Yp[1]=i,Yv(e,Yp,this.transformNoRotation))}getScreenTransform(e,t){const{center:i}=this._viewpoint2D,r=this._get("pixelRatio")||1,s=this._get("size");return Nq(e,i,s,t,0,r),e}_update(){const{center:e,spatialReference:t,scale:i,rotation:r}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new Vh({targetGeometry:new Ke(e[0],e[1],t),scale:i,rotation:r});if(this._set("viewpoint",o),!n||!t||!i)return;this.resolution=qF(o),this.rotation=r,this.scale=i,this.spatialReference=t,Fs(this.center,e);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;Gj(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=jj(this.viewMat3),h=lu(n[0]/2,n[1]/2),p=lu(-n[0]/2,-n[1]/2),f=IL(r);AD(c,c,h),Hj(c,c,f),AD(c,c,p),jN(this.displayViewMat3,this.displayMat3,c);const g=Dq(this.viewMat2d,h);return Iq(g,g,f),$q(g,g,p),Hst(this.extent,o,n),Xst(this.transform,o,n,s),Gve(this.inverseTransform,this.transform),Yst(this.transformNoRotation,o,n,s),this.worldScreenWidth=Qst(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],Jg.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],Jg.prototype,"pixelRatio",null),u([d({json:{write:!0}})],Jg.prototype,"size",null),u([d()],Jg.prototype,"spatialReference",void 0),u([d({type:Vh,json:{write:!0}})],Jg.prototype,"viewpoint",null),Jg=m9=u([P("esri.views.2d.ViewState")],Jg);const Jst=Jg,Kst=.125;class ent{constructor(){this._renderParams={context:null,drawPhase:1,state:new Jst({viewpoint:new Vh({targetGeometry:new Ke(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(t,i,r,s,n,o,a,l,c,h){const p=o.adjustLevel(i[0]),f=this._renderParams;f.context=t,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const g=o.getScale(i[0]),[y,v]=o.getShift(i,a*g),b=Kst*a*g/c,w=r.transforms.dvs;w[0]=b,w[4]=-b,w[6]=-1-y-l[0]*a*2,w[7]=1+v+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,r.stage||r.attachWithContext(t),r.triangleCount=0,s.drawTile(f,r,n)}}var Pu;(function(e){e[e.NoAlpha=0]="NoAlpha",e[e.SourceAlpha=1]="SourceAlpha",e[e.OneMinusSourceAlpha=2]="OneMinusSourceAlpha",e[e.COUNT=3]="COUNT"})(Pu||(Pu={}));function tnt(){const e=new Ri;return e.attributes.add(E.POSITION,"vec2"),e.attributes.add(E.UV0,"vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(x`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),e}const int=Object.freeze({__proto__:null,build:tnt});class cR extends Vi{initializeProgram(t){const i=cR.shader.get().build();return new Oi(t.rctx,i,mi)}initializePipeline(){const t=this.configuration.mode===Pu.OneMinusSourceAlpha?gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):this.configuration.mode===Pu.SourceAlpha?gc(Ee.ZERO,Ee.SRC_ALPHA):null;return Rt({blending:t,colorWrite:Ft})}}cR.shader=new Li(int,()=>import("./BlendLayers.glsl.55a09a2c.js"));class g9 extends dr{constructor(){super(...arguments),this.mode=Pu.NoAlpha}}u([Y({count:Pu.COUNT})],g9.prototype,"mode",void 0);function rnt(e){e.attributes.add(E.POSITION,"vec2"),e.attributes.add(E.UV0,"vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(x`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function snt(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(x`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function nnt(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(x`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function ont(e){e.include(nnt),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(x`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function ant(e){const t=new Ri;return t.include(rnt),t.include(ont),t.include(snt),e.output===lm.Stretch?cnt(t,e):e.output===lm.Lut?lnt(t):e.output===lm.Hillshade&&unt(t,e),t}function lnt(e){e.fragment.code.add(x`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}function cnt(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(x`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?x`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:x`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(x`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===U1.Noop?x`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:x`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`)}function unt(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(Rp),e.fragment.code.add(x`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),e.fragment.code.add(x`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t.applyColormap?x`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:x`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;e.fragment.code.add(x`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const hnt=Object.freeze({__proto__:null,build:ant});class WF extends Vi{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=sst(this._context,this.program)),this._uniformLocationInfos}initializeProgram(t){const i=WF.shader.get(),r=this.configuration,s=i.build({output:r.colorizerType,applyColormap:r.applyColormap,stretchType:r.stretchType});return this._context=t.rctx,new Oi(t.rctx,s,mi)}initializePipeline(){const t=this.configuration.mode===Pu.OneMinusSourceAlpha?gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):this.configuration.mode===Pu.SourceAlpha?gc(Ee.ZERO,Ee.SRC_ALPHA):null;return Rt({blending:t,colorWrite:Ft})}bindPass(t){A2(this.program,this.uniformLocationInfos,t.basic),A2(this.program,this.uniformLocationInfos,t.common),_(t.colormap)&&A2(this.program,this.uniformLocationInfos,t.colormap),this.configuration.colorizerType===lm.Stretch&&_(t.stretch)?A2(this.program,this.uniformLocationInfos,t.stretch):this.configuration.colorizerType===lm.Hillshade&&_(t.hillshade)&&A2(this.program,this.uniformLocationInfos,t.hillshade)}}WF.shader=new Li(hnt,()=>import("./RasterColorizer.glsl.79e932eb.js"));class WE extends dr{constructor(){super(...arguments),this.mode=Pu.OneMinusSourceAlpha,this.colorizerType=lm.Stretch,this.stretchType=U1.Noop,this.applyColormap=!0}}u([Y({count:Pu.COUNT})],WE.prototype,"mode",void 0),u([Y({count:lm.COUNT})],WE.prototype,"colorizerType",void 0),u([Y({count:U1.COUNT})],WE.prototype,"stretchType",void 0),u([Y()],WE.prototype,"applyColormap",void 0);class _k{constructor(t,i,r,s,n,o,a){this.texture=t,this.type=i,t.retain(),this.offsetAndScale=yi(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=je(s,a?o:0,n)}destroy(){this.texture.release()}}class dnt{constructor(t){this._rctx=t,this._pools=new Map}acquire(t){return this._getPool(t).acquire()}release(t){this._getPool(t.width).release(t)}clear(){this._pools.forEach(t=>t.destroy()),this._pools.clear()}_getPool(t){let i=this._pools.get(t);if(!i){const r=ki.bind(ki,this._rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.DEPTH_RENDER_BUFFER,width:t,height:t});i=new Gr(r),this._pools.set(t,i)}return i}}class pnt{constructor(t,i,r){this._rctx=t,this.tileSize=i,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new ent,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=fo(this._rctx,jR),this._blackTex=new dy(AJ(this._rctx,[0,0,0,1])),this._fboPool=new dnt(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=et(this._vaoQuad),this._backgroundTexture=Wi(this._backgroundTexture),this._blackTex=Wi(this._blackTex),this._blendLayersTechnique=Wi(this._blendLayersTechnique),this._applyOpacityTechnique=Wi(this._applyOpacityTechnique),this._vectorTileHelper=et(this._vectorTileHelper)}get blendLayersTechnique(){if(O(this._blendLayersTechnique)){const t=new g9;t.mode=Pu.OneMinusSourceAlpha,this._blendLayersTechnique=this._techniqueRepository.acquire(cR,t)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(O(this._applyOpacityTechnique)){const t=new g9;t.mode=Pu.SourceAlpha,this._applyOpacityTechnique=this._techniqueRepository.acquire(cR,t)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(t,i){const r=t.layerInfo[Lt.MAP];for(const v of r)v.pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING);if(!t.renderData)return;const s=t.surface,n=s.baseOpacity;let o=0,a=0,l=this.tileSize,c=!1;const h=s.view.pixelRatio;let p=r.length,f=0;for(;f<r.length&&!c;f++){const v=s.layerViewByIndex(f,Lt.MAP),b=v.fullOpacity;if(wk[f]=b,dce(v.layer)&&p>=r.length&&(p=f),b===0)continue;++a;const w=bk(t,f,xk);w&&(pL(v)?l=Math.max(l,this.tileSize*h):n===1&&b===1&&(v.isOpaque||this._dataToTexture(w)&&w.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++o)}this._cleanupFBOPool(h,r.length),l=fnt(l);const g=l/this.tileSize,y=f-1;o!==0?o===1&&(c||this._backgroundIsGrid||_(this._backgroundColor))&&this._useLayerTexture(t,y,p,wk[y])||this._composeMapLayers(t,i,y,p,c,wk,l,g):this._useBackgroundTexture(t,a)}_useBackgroundTexture(t,i){let r=am.Immediate;(t.surface.view.layerViewManager.updating||i>0)&&(r=am.Delayed),this._backgroundTexture&&O(t.renderData.textureReference)&&(r=am.Immediate),t.renderData.setTextureReference(_(this._backgroundTexture)?new _k(this._backgroundTexture,Xs.FADING,wie,t.surface.baseOpacity,1,1,!1):null,r)}_useLayerTexture(t,i,r,s){const n=i<r,o=n?1:t.surface.baseOpacity,a=n?t.surface.baseOpacity:1,l=bk(t,i,xk);return!!this._dataToTexture(l)&&(t.renderData.setTextureReference(new _k(l.sourceLayerInfo.data,Xs.FADING,l,o,s,a,!0)),!0)}_composeMapLayers(t,i,r,s,n,o,a,l){const c=this._rctx,h=this._fboPool.acquire(a);c.bindFramebuffer(h),c.setViewport(0,0,a,a),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT);let p=!1;!n&&_(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,rB);const f=t.surface.baseOpacity;let g=!1,y=Ve.LINEAR_MIPMAP_LINEAR;for(let T=r;T>=0;T--){const A=bk(t,T,xk);A&&(T<s&&f<1&&!g&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,rB,f),g=!0),o[T]!==0&&(Nit(A)?p=this._drawVectorData(this.blendLayersTechnique,A,l,o[T],a,h,p):Lit(A)?(this._drawImageryTileData(A,o[T]),this._hasNearestInterpolation(A)&&(y=Ve.NEAREST)):this._dataToTexture(A)&&this._drawRasterData(this.blendLayersTechnique,A.sourceLayerInfo.data.texture,A.scale,A.offset,o[T])))}const v=t.renderData.ensureTexture(a,()=>this._buildTexture(a,y)),b=c.bindTexture(v.texture,Ze.TEXTURE_UNIT_FOR_UPDATES),w=v.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,w.pixelFormat,0,0,w.width,w.height,0),v.generateMipmap(),c.bindTexture(b,Ze.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h);const S=g?1:f;t.renderData.setTextureReference(new _k(v,i,wie,S,1,1,!1))}_drawQuad(t){this._rctx.bindVAO(this._vaoQuad),t.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this._vaoQuad,"geometry"))}_drawRasterData(t,i,r,s,n=1){if(O(i))return;const o=this._rctx.useTechnique(t);o.bindTexture(i,"tex"),o.setUniform1f("scale",r),o.setUniform2f("offset",s[0],s[1]),o.setUniform1f("opacity",n),this._drawQuad(o)}_hasNearestInterpolation(t){const i=t.sourceLayerInfo.data;return!!i.source&&i.interpolation==="nearest"}_drawImageryTileData(t,i=1){const r=t.sourceLayerInfo.data;if(!r.source)return;t.tile.surface.layerViewByIndex(t.layerIndex,Lt.MAP).ensureSymbolizerParameters(r);const s=this._getRasterColorizerTechnique(r),n=this._rctx,o=n.useTechnique(s);if(!r.bind(n))return;r.opacity=i,r.scale=t.scale,r.offset=t.offset;const{names:a,textures:l}=r.getTextures();a.forEach((c,h)=>o.bindTexture(l[h],c)),s.bindPass(r.getUniforms()),this._drawQuad(o),n.bindVAO()}_getRasterColorizerTechnique(t){const i=t.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(i.type);return O(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new WE,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!i.colormap,this._rasterColorizerConfig.stretchType=t.hasStretchTypeNone()?U1.Noop:U1.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(WF,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(t,i,r,s,n,o,a){const l=this._rctx,c=i.sourceLayerInfo.data,h=i.tile.surface.layerViewByIndex(i.layerIndex,Lt.MAP);let p;return t.bindPipelineState(l),s<1?(p=this._fboPool.acquire(n),l.bindFramebuffer(p),l.setClearColor(1,1,1,0),l.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT)):a&&l.clearSafe(bi.DEPTH_BUFFER_BIT),this._vectorTileHelper.render(l,i.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/i.scale),i.offset,this.tileSize,r),!_(p)||(l.bindFramebuffer(o),this._drawRasterData(t,p.colorTexture,1,[0,0],s),this._fboPool.release(p),a)}_dataToTexture(t){return Uit(t)&&this._rasterDataToTexture(t),Fit(t)}_rasterDataToTexture(t){const i=t.sourceLayerInfo;i.data=this._buildTexture(i.data),t.tile.setMemoryDirty()}setBackground(t,i){Wi(this._backgroundTexture),this._backgroundIsGrid=i,t instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(t),this._backgroundColor=null):(this._backgroundTexture=new dy(AJ(this._rctx,yi(t[0]||0,t[1]||0,t[2]||0,1))),this._backgroundColor=je(t[0]||0,t[1]||0,t[2]||0))}_buildTexture(t,i=Ve.LINEAR_MIPMAP_LINEAR){if(O(t))return null;const r={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:i,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof t=="number")r.width=r.height=t,n=new dy(new Ze(s,r));else if(t instanceof oR)r.isOpaque=t.isOpaque,n=new dy(new Ze(s,r,t.image)),t.release();else try{n=new dy(new Ze(s,r,t))}catch{n=new dy(Efe(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,Ze.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,Ze.TEXTURE_UNIT_FOR_UPDATES),n}_cleanupFBOPool(t,i){t===this._lastPixelRatio&&i===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=t,this._lastNumLayers=i)}get test(){return{backgroundTexture:this._backgroundTexture}}}function fnt(e){const t=Zx(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}function bk(e,t,i){i.layerIndex=t;const r=e.layerInfo[Lt.MAP][t];if(r.data)return tr(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const n=s.tile.layerInfo[Lt.MAP][t];return i.tile=s.tile,Fs(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=n,i}return null}const wk=new Array,xk={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},wie={offset:[0,0],scale:1},y9=40,xie=20,mnt=.8,gnt=15,XE=1e-6;function ynt(e,t,i){const r=t,s=i;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=e[a];if(r[a]<l){if(s[a]<=XE)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-XE){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=e[a+3];if(r[a]>l){if(s[a]>=-XE)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]>=XE){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}class Tie{constructor(t,i,r,s,n){this.aabb=t,this.axis=i,this.d=r,this.midStartIndex=s,this.rightStartIndex=n}}class k1{constructor(t,i,r,s){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=i,this.positionAttribute=s,this.rayDirection=M(),this.bspNodeTree=new Array,this.vertexPositionBuffer=s.data,this.vertexPositionStride=s.stride;const n=r-i,o=n<=Yve?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=xnt(t,i,r,s.data,s.stride),l=(c,h,p)=>{const f=bnt(o,a,c,h),g=h-c;if(g<=xie){const T=new Tie(f,void 0,0,c,h);return this.bspNodeTree.push(T),T}const{axis:y,midValue:v}=wnt(f),b=_nt(o,a,c,h,y,v),w=(T,A)=>{if(p>gnt)return;const C=A-T;return C<xie||C>=mnt*g?void 0:l(T,A,p+1)},S=new Tie(f,y,v,b.next,b.mid);return this.bspNodeTree.push(S),S.leftNode=w(c,b.next),S.rightNode=w(b.mid,h),S};l(0,n,0),this.triangleVertexIndices=Tnt(o,t,i,r)}}intersectRayTriangleRange(t,i){{if(t>=i)return;const r=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],l=o[1],c=o[2],h=this.rayDirection,p=h[0],f=h[1],g=h[2];for(let y=t,v=3*t;y<i;++y){const b=r[v]*n,w=s[b],S=s[b+1],T=s[b+2],A=r[v+1]*n,C=s[A],R=s[A+1],L=s[A+2],U=r[v+2]*n,N=s[U],z=s[U+1],V=s[U+2];v+=3;const B=C-w,J=R-S,Z=L-T,te=N-w,ie=z-S,$=V-T,F=f*$-ie*g,k=g*te-$*p,G=p*ie-te*f,q=B*F+J*k+Z*G;if(Math.abs(q)<=Number.EPSILON)continue;const K=a-w,H=l-S,ee=c-T,ge=K*F+H*k+ee*G;if(q>0){if(ge<0||ge>q)continue}else if(ge>0||ge<q)continue;const Ae=H*Z-J*ee,Be=ee*B-Z*K,Se=K*J-B*H,xe=p*Ae+f*Be+g*Se;if(q>0){if(xe<0||ge+xe>q)continue}else if(xe>0||ge+xe<q)continue;const Re=(te*Ae+ie*Be+$*Se)/q;if(Re>=0){const ke=this.indices[y]+this.firstTriangleIndex,Gi=JR(B,J,Z,te,ie,$,vnt);this.callback(Re,Gi,ke,!1)}}}k1.numFacesTested+=i-t}intersectRay(t,i){k1.numFacesTested=0;const r=je(t.r0[0],t.r0[1],t.r0[2]),s=je(t.r1[0],t.r1[1],t.r1[2]),n=s[0]-r[0],o=s[1]-r[1],a=s[2]-r[2];if(n*n+o*o+a*a<XE)return;this.rayOrigin=r;const l=this.rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this.callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(t,i,r){const s=this.rayOrigin,n=this.rayDirection;if(!ynt(t.aabb,s,n))return;const o=t.axis,a=t.d;if(s[o]<a||n[o]<0){const l=i,c=t.midStartIndex;if(l<c){const h=t.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),s[o]>a||n[o]>0){const l=t.rightStartIndex,c=r;if(l<c){const h=t.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}k1.numFacesTested=0;const vnt=M(),Vb=[1/0,1/0,1/0],Gb=[-1/0,-1/0,-1/0];function _nt(e,t,i,r,s,n){let o=i,a=r;for(;o<a;){const c=e[o];t[6*c+s+3]<=n?++o:(--a,e[o]=e[a],e[a]=c)}let l=o;for(a=r;l<a;){const c=e[a-1];t[6*c+s]>=n?--a:(e[a-1]=e[l],e[l]=c,++l)}return{next:o,mid:l}}function bnt(e,t,i,r){if(r<=i)return c1(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*e[i];for(let n=0;n<3;++n)Vb[n]=t[s+0+n],Gb[n]=t[s+3+n]}for(let s=i+1;s<r;++s){const n=6*e[s];for(let o=0;o<3;++o)Vb[o]=Math.min(Vb[o],t[n+0+o]),Gb[o]=Math.max(Gb[o],t[n+3+o])}return c1(Vb[0],Vb[1],Vb[2],Gb[0],Gb[1],Gb[2])}function wnt(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}function xnt(e,t,i,r,s){const n=i-t,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+t),c=e[l+0]*s,h=e[l+1]*s,p=e[l+2]*s;for(let f=0;f<3;++f){const g=r[c+f],y=r[h+f],v=r[p+f];o[6*a+f]=Math.min(g,y,v),o[6*a+3+f]=Math.max(g,y,v)}}return o}function Tnt(e,t,i,r){const s=r-i;let n=0;for(let a=i;a<r;++a)for(let l=0;l<3;++l)n=Math.max(t[3*a+l],n);const o=n<=Yve?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(e[a]+i);for(let c=0;c<3;++c){const h=t[l+c];o[3*a+c]=h}}return o}const Yve=65535;var uu;function v9(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==xt.Water&&t.pbrMode!==xt.WaterOnIntegratedMesh||e.include(Dye,t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(x`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),e.fragment.uniforms.add("ovColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(x`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.fragment.code.add(x`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),t.pbrMode!==xt.Water&&t.pbrMode!==xt.WaterOnIntegratedMesh||(e.include(BN),e.fragment.code.add(x`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(uu||(uu={}));function Snt(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.viewingMode===$e.Global?e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(x`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function Ent(e){e.vertex.code.add(x`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function Ant(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("textureOpacities","vec3"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("nextTexOpacities","vec3"),e.fragment.uniforms.add("fadeFactor","float")),e.vertex.code.add(x`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?x`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:x``}
  }`),t.useGrid?(e.fragment.code.add(x`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):t.hasBackgroundColor?(e.fragment.uniforms.add("backgroundColor","vec3"),e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),t.textureFadingEnabled?e.fragment.code.add(x`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):e.fragment.code.add(x`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}function Cnt(e){const t=new Ri;if(t.include(_0e,{name:"Terrain Shader",output:e.output}),t.include(Ent),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),t.fragment.uniforms.add("origin","vec3"),e.output===j.Color){t.include(Un,{linearDepth:!1}),t.include(ky,e),t.include(Ant,e),t.include(D1,e);const i=e.overlayMode!==uu.Disabled,r=e.overlayMode===uu.EnabledWithWater;i&&t.include(v9,{pbrMode:xt.Water,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),r&&t.include(Snt,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(x`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?x`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${e.tileBorders?x`vuv = uv;`:""}
        ${e.screenSizePerspective?x`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?x`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?x`setOverlayVTC(uv);`:""}
        ${r?x`forwardVertexTangent(vnormal);`:x``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(Rr,e),t.include(D1,e),t.fragment.uniforms.add("cameraPosition","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(t.fragment.uniforms.add("ovWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(x`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),t.fragment.code.add(x`
      void main() {
        ${e.receiveShadows?x`float shadow = readShadowMap(vpos, linearDepth);`:x`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${i?x`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${e.atmosphere?x`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${e.atmosphere?x`atm + tileColor.rgb;`:x`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?x`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + origin);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?x`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?x`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return e.output!==j.Depth&&e.output!==j.Shadow||(t.include(Un,{linearDepth:!0}),t.include(M0,{output:e.output}),t.include(ky,e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),t.fragment.code.add(x`void main() {
outputDepth(linearDepth);
}`)),e.output===j.Normal&&(t.include(Un,{linearDepth:!1}),t.include(ky,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),t.fragment.code.add(x`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),e.output===j.Highlight&&(t.include(Un,{linearDepth:!1}),t.include(ky,e),t.include(v9,{pbrMode:xt.Disabled}),t.vertex.code.add(x`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Fm),t.fragment.code.add(x`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}const Rnt=Object.freeze({__proto__:null,build:Cnt});class XF extends Vi{constructor(){super(...arguments),this.useStencil=!1}initializeProgram(t){const i=XF.shader.get(),r=this.configuration,s=i.build({overlayMode:r.overlayMode,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:r.textureFadingEnabled&&!r.renderOccluded,hasBackgroundColor:r.hasBackgroundColor,useGrid:r.useGrid,receiveShadows:r.receiveShadows&&!r.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:r.atmosphere,tileBorders:r.tileBorders,screenSizePerspective:r.screenSizePerspective,pbrMode:xt.Disabled,ssrEnabled:r.ssrEnabled,highStepCount:!1});return new Oi(t.rctx,s,mi)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(t){const i=this.configuration,r=i.backfaceCullingEnabled&&!i.renderOccluded;return Rt({blending:i.renderOccluded?gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):null,culling:r&&Dj,depthTest:!i.renderOccluded&&{func:Di.LESS},depthWrite:!i.renderOccluded&&Aa,colorWrite:Ft,stencilTest:t?PXe(ba.IntegratedMeshMaskExcluded):null})}getPipelineState(t,i){return this.useStencil?this._stencilPipelineState:super.getPipelineState(t,i)}}XF.shader=new Li(Rnt,()=>import("./Terrain.glsl.39d12f59.js"));class ta extends dr{constructor(){super(...arguments),this.output=j.Color,this.overlayMode=uu.Disabled,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}u([Y({count:j.COUNT})],ta.prototype,"output",void 0),u([Y({count:uu.COUNT})],ta.prototype,"overlayMode",void 0),u([Y()],ta.prototype,"atmosphere",void 0),u([Y()],ta.prototype,"receiveShadows",void 0),u([Y()],ta.prototype,"slicePlaneEnabled",void 0),u([Y()],ta.prototype,"backfaceCullingEnabled",void 0),u([Y()],ta.prototype,"stencilEnabled",void 0),u([Y()],ta.prototype,"textureFadingEnabled",void 0),u([Y()],ta.prototype,"hasBackgroundColor",void 0),u([Y()],ta.prototype,"useGrid",void 0),u([Y()],ta.prototype,"renderOccluded",void 0),u([Y()],ta.prototype,"ssrEnabled",void 0),u([Y()],ta.prototype,"tileBorders",void 0),u([Y()],ta.prototype,"screenSizePerspective",void 0);const Tk=7,Ont=10,kP=os(),zP=ni();let Mo=class extends we{constructor(e){super(e),this.type=lr.TERRAIN,this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new gst,this.renderDataPool=new Gr(fst),this._patchGroups=new Map,this.patchGroupsDirty=!0,this.tileIterator=new Uve,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=Ar.Occlude}get isGlobal(){return this.stage.viewingMode===$e.Global}initialize(){const e=[ye.OPAQUE_TERRAIN,ye.TRANSPARENT_TERRAIN,ye.OCCLUDED_TERRAIN];this.stage.addRenderPlugin(e,this)}destroy(){this.stage.removeRenderPlugin(this),Nrt()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}get needsLinearDepth(){return this.overlayRenderer.hasWater}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return v_}get slicePlaneEnabled(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlaneEnabled(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?tL:Ar.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e,vt.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e,t===vt.TEXTURE_FADING?Xs.FADING:Xs.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometry(e){for(const t of e.layerInfo[Lt.ELEVATION])t.pendingUpdates&=~vt.GEOMETRY;e.resetPendingUpdate(vt.GEOMETRY),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Ont-Tk,i=Math.max(0,Math.floor((e.level-t)/Tk)*Tk);if(this.isGlobal&&i===0)return cl;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll(t=>{var i;return(i=t.renderData)==null?void 0:i.updateGeometry(this.rctx,e)}),this.setNeedsRender())}setNeedsRender(e=ts.UPDATE){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRepository,this.shaderTechniqueConfig=new ta,this.tileRenderer=new pnt(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=Efe(this.rctx)}uninitializeRenderContext(){this.emptyTex!=null&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=Pnt,n=Int;de(s,r,i),oe(n,1/s[0],1/s[1],1/s[2]);const o=e.results.min,a=e.results.max,l=e.results.ground,c=e.options.store===Bn.MIN,h=!!e.results.ground.target,p=B8e(e.verticalOffset),f=this._skirtScale,g=e.tolerance;let y,v=c&&_(o.dist)?o.dist:1/0;const b=S=>{const T=S.renderData;if(T==null)return;const A=T.geometryInfo;BL(kP,A.boundingBox);const C=T.localOrigin;_(p)&&(p.localOrigin=C,p.applyToAabb(kP));const R=-f*A.skirtLength;if(R!==0){const te=S.up;RSe(kP,R*te[0],R*te[1],R*te[2])}const L=kP;if(Zp[0]=i[0]-C[0],Zp[1]=i[1]-C[1],Zp[2]=i[2]-C[2],!RH(L,Zp,n,g,v))return;const U=(te,ie,$)=>{te.set(this.type,S,ie,$,ss),v=c&&_(o.dist)?o.dist:1/0},N=(te,ie)=>{if(_(ie)&&te>=0&&(e.options.backfacesTerrain||_e(ie,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||t==null||t(i,r,te))){if((l.dist==null||te<l.dist)&&U(l,te,ie),e.options.isFiltered)return;e.options.store===Bn.ALL&&(O(y)?(y=YN(e.ray),U(y,te,ie),e.results.all.push(y)):te<y.dist&&U(y,te,ie)),(o.dist==null||te<o.dist)&&U(o,te,ie),e.options.store!==Bn.MIN&&(a.dist==null||te>a.dist)&&U(a,te,ie)}},z=$nt;de(z,r,C);const V=A.indices,B=A.vertexAttributes,J={data:B.getField(E.POSITION,Ti).typedBuffer,size:3,stride:B.stride/4},Z=A.numWithoutSkirtIndices/3;if(!_(p)&&Z>y9){const te=S.renderData;_(te.intersectionData)||(te.intersectionData=new k1(V,0,Z,J)),te.intersectionData.intersectRay({r0:Zp,r1:z},N)}else QR(Zp,z,0,Z,V,J,null,p,N);if(R!==0){const te=V.length/3;if(this.isGlobal){const ie=te-Z;if(!_(p)&&ie>y9){const $=S.renderData;if(!_($.skirtIntersectionData)){const F=jrt(V,Z,te,B,R,C);$.skirtIntersectionData=new k1(F.indices,0,ie,{data:F.vertices,stride:3})}$.skirtIntersectionData.intersectRay({r0:Zp,r1:z},N)}else Grt(Zp,z,Z,te,V,B,R,C,p,N)}else Hrt(Zp,z,Z,te,V,B,R,p,N)}},w=this._rootTiles;_(w)&&(()=>{const S=this.tileIterator;S.reset(w);const T=e.options.invisibleTerrain;for(;!S.done;){const A=S.next();!(A.visible||T&&A.intersectsClippingArea)||!_(p)&&!A.intersectsRay(i,s,g,v,f)||h&&this._useStencilForTile(A)?S.skipSubtree():b(A)}})()}prepareTechnique(e){if(e.slot===ye.OCCLUDED_TERRAIN){if((e.renderOccludedMask&tL)==0)return null}else{const t=this.opaque?ye.OPAQUE_TERRAIN:ye.TRANSPARENT_TERRAIN;if(e.slot!==t)return null}switch(e.pass){case De.MATERIAL:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?uu.Disabled:this.overlayRenderer.hasWater?uu.EnabledWithWater:uu.Enabled;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const r=e.slot===ye.OCCLUDED_TERRAIN?On.Occluded:On.ColorAndWater;return this._updateTechnique(j.Color,r===On.Occluded)}case De.MATERIAL_DEPTH_SHADOWMAP_ALL:case De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this.castShadows&&e.scenelightingData.globalFactor===1?this._updateTechnique(j.Shadow,!1):null;case De.MATERIAL_DEPTH:return this.isTransparent&&this.overlayRenderer.isEmpty()?null:this._updateTechnique(j.Depth,!1);case De.MATERIAL_NORMAL:return this._updateTechnique(j.Normal,!1);case De.MATERIAL_HIGHLIGHT:return this.needsHighlight?this._updateTechnique(j.Highlight,!1):null}return null}render(e,t){const i=e.pass,r=e.scenelightingData.globalFactor===1;switch(this._updatePatchGroups(),t.useStencil=!1,i){case De.MATERIAL:{const s=e.slot===ye.OCCLUDED_TERRAIN?On.Occluded:On.ColorAndWater;this._renderMaterialPass(e,t,s);break}case De.MATERIAL_DEPTH_SHADOWMAP_ALL:case De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this.castShadows&&r&&this._renderAuxiliaryPass(e,t,On.None);break;case De.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,On.None);break;case De.MATERIAL_NORMAL:this._renderAuxiliaryPass(e,t,On.None);break;case De.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(e,t,On.Highlight),e.rctx.clearSafe(bi.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r,camera:s}=e;this._ssrEnabled=e.ssrParams.ssrEnabled;const n=r.useTechnique(t,e.slot);this.shaderTechniqueConfig.overlayMode!==uu.Disabled&&i===On.ColorAndWater&&e.ssrParams&&QH(n,e.ssrParams),e.shadowMap.bind(n),e.ssaoHelper.bind(n,e.camera),this._bindOverlayData(n,i),n.setUniformMatrix4fv("viewNormal",s.viewInverseTransposeMatrix),xl(n,s.projectionMatrix),e.scenelightingData.setUniforms(n,!0,!1);const o=s.viewMatrix;oe(BP,o[12],o[13],o[14]),be(BP,BP),n.setUniform3fv("viewDirection",BP),this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,t,i):e.offscreenRenderingHelper.renderToTargets(()=>this._renderPatchGroups(e,t,i),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx.useTechnique(t,e.slot);if(e.pass===De.MATERIAL_HIGHLIGHT){const s=e.offscreenRenderingHelper;r.bindTexture(s.depthTexture,"depthTex"),r.setUniform4f("highlightViewportPixelSz",0,0,1/s.width,1/s.height)}else r.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),e.pass!==De.MATERIAL_DEPTH&&e.pass!==De.MATERIAL_DEPTH_SHADOWMAP_ALL&&e.pass!==De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT||r.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,t,i)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!_(this.tileRenderer.backgroundColor),this.allTiles.forAll(t=>this.tileRenderer.updateTileTexture(t,Xs.FADING)),this.setNeedsRender()};if(typeof this.tileBackground=="string"){const t=this.tileBackground;Cu(t).then(i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Ppe),e())})}else{const t=this.tileBackground?Qe.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){if(this.patchGroupsDirty){if(this.highestVisibleLODTile=null,this._rebuildPatchGroups(),this.renderOrder!==lR.NONE){const e=Array.from(this._patchGroups.values());e.forEach(t=>kve(this.renderOrder,t)),e.sort((t,i)=>zve(t[0],i[0],this.renderOrder)),this._patchGroups=new Map(e.map(t=>[t[0].renderData.localOrigin,t]))}this.patchGroupsDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!O(e)){this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this.tileIterator;for(t.resetOne(e);!t.done;){const i=t.next(),r=i.renderData;if(!r||i.visible)if(i.rendered){if(r){const s=this._patchGroups.get(r.localOrigin)||new Array;this._patchGroups.set(r.localOrigin,s),s.push(i),(!this.highestVisibleLODTile||i.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=i),t.skipSubtree()}}else this.numTilesCulled++;else this.numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){t.program.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.program.setUniform1f("skirtScale",this._skirtScale),i!==On.None&&this._bindOverlayData(t.program,i);const r=this.stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(s=>{const n=s[0].renderData.localOrigin;this._bindPatchGroupData(t.program,n,e.camera.eye,e.camera.viewMatrix);for(let o=0;o<s.length;o++)this._renderPatch(e,t,s[o],Tt.TRIANGLES,r,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const r=e.rctx,s=e.camera,n=s.viewMatrix,o=t.program;if(this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const f=fge(this.stage.viewingMode,this.ellipsoidRadius),g=this.pointsOfInterest.centerOnSurfaceFrequent.distance;f.update({distance:g,fovY:s.fovY}),WC(f,o,"screenSizePerspective")}const a=this.stencilEnabledLayerExtents.length>0,l=i===On.Occluded;l&&(o.bindTexture(this.emptyTex,"tex"),o.setUniform1f("blend",1),o.setUniform4fv("texOffsetAndScale",H_));const c=_(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:cl;this.shaderTechniqueConfig.hasBackgroundColor&&o.setUniform3fv("backgroundColor",c);const h=l?0:this._skirtScale;o.setUniform1f("skirtScale",h);const p=this.wireframe?Tt.LINES:Tt.TRIANGLES;this.shaderTechniqueConfig.textureFadingEnabled&&o.bindTexture(this.emptyTex,"texNext"),this._patchGroups.forEach(f=>{const g=f[0].renderData.localOrigin;this._bindPatchGroupData(o,g,s.eye,n);const y=e.sliceHelper&&e.sliceHelper.plane;v0(o,t.configuration,y,{origin:g}),e.shadowMap&&e.shadowMap.bindView(o,g),this.numOriginsRendered++;for(let v=0;v<f.length;v++){const b=f[v],w=b.renderData.textureReference;if(!O(w)){if(!l){this._scaleRangeQueries.scaleQueriesForTile(b),Sie(b.renderData.geometryInfo.uvOffsetAndScale,w.offsetAndScale,zP),o.setUniform4fv("texOffsetAndScale",zP),o.bindTexture(w.texture.texture,"tex");const S=b.renderData.textureFadeFactor,T=S<1?b.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&_(T)&&S<1?(Sie(b.renderData.geometryInfo.uvOffsetAndScale,T.offsetAndScale,zP),o.setUniform1f("fadeFactor",S),o.setUniform4fv("nextTexOffsetAndScale",zP),o.setUniform3fv("nextTexOpacities",T.opacities),o.bindTexture(T.texture.texture,"texNext")):o.setUniform1f("fadeFactor",1),b.renderData.textureIsFading&&this.setNeedsRender(),o.setUniform3fv("textureOpacities",w.opacities)}this._renderPatch(e,t,b,p,a,i),b.renderOrder=this.numTilesRendered,this.numTilesRendered++}}}),r.bindVAO(null)}_renderPatch(e,t,i,r,s,n){if(O(i.renderData.vao.indexBuffer))return;const o=t.program;n!==On.None&&this._bindOverlayPatchData(o,i.renderData.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.slot));const a=this._skirtScale===0?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;e.rctx.bindVAO(i.renderData.vao),o.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.rctx.drawElements(r,a,i.renderData.vao.indexBuffer.indexType,0)}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t),Vo(Eie,r,t),e.setUniformMatrix4fv("view",Eie),e.setUniform3f("cameraPosition",i[0]-t[0],i[1]-t[1],i[2]-t[2])}_bindOverlayData(e,t){if(this.shaderTechniqueConfig.overlayMode===uu.Disabled)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>Jr.INNER){const r=i[Jr.INNER],s=r.getColorTexture(t);if(e.bindTexture(_(s)?s:this.emptyTex,"ovColorTex"),this.shaderTechniqueConfig.overlayMode===uu.EnabledWithWater){const n=r.getNormalTexture(t);e.bindTexture(_(n)?n:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this.shaderTechniqueConfig.output=e,e===j.Color&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(XF,this.shaderTechniqueConfig,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this.tileRenderer}}};u([d()],Mo.prototype,"tileBackgroundInitialized",void 0),u([d()],Mo.prototype,"tileBackgroundUpdating",void 0),u([d({constructOnly:!0})],Mo.prototype,"overlayRenderer",void 0),u([d({constructOnly:!0})],Mo.prototype,"stage",void 0),u([d({readOnly:!0})],Mo.prototype,"isGlobal",null),u([d({constructOnly:!0})],Mo.prototype,"allTiles",void 0),u([d({constructOnly:!0})],Mo.prototype,"ellipsoidRadius",void 0),u([d({readOnly:!0})],Mo.prototype,"updating",null),u([d({value:!1})],Mo.prototype,"renderingDisabled",null),u([d()],Mo.prototype,"renderPatchBorders",null),u([d()],Mo.prototype,"cullBackFaces",null),u([d({value:lR.FRONT_TO_BACK})],Mo.prototype,"renderOrder",null),u([d()],Mo.prototype,"wireframe",null),Mo=u([P("esri.views.3d.terrain.TerrainRenderer")],Mo);const Mnt=Mo;function Sie(e,t,i){i[0]=e[0]*t[2]+t[0],i[1]=e[1]*t[3]+t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3]}const Eie=Te(),BP=M(),Pnt=M(),Int=M(),Zp=M(),$nt=M();class Dnt{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let Fd=class extends we{constructor(e){super(e),this._handles=new Bt}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=it(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!yA(t)||t.isRejected())&&!(t.isFulfilled()&&!Lnt(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!Eve(t)&&!dL(t))),e)if(e.isResolved()){const t=GF(e,this.viewSpatialReference,this.viewingMode);if(_(t)){const i=new sr(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===$e.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=sr.makeWebMercatorAuxiliarySphere(t):f1(e.spatialReference)&&(e=sr.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===$e.Global){const e=this.extentHelper.viewSpatialReference,t=f1(e)||wp(e)||xp(e);e.isWebMercator?this.tilingScheme=sr.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=sr.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;_(e)&&!z_(e,this.extent)&&(this.tilingScheme=sr.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function Lnt(e,t,i){return _(GF(e,t,i))}u([d()],Fd.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Fd.prototype,"extent",void 0),u([d({value:!1})],Fd.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],Fd.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],Fd.prototype,"layers",void 0),u([d({constructOnly:!0})],Fd.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],Fd.prototype,"viewingMode",void 0),Fd=u([P("esri.views.3d.terrain.TilingSchemeLogic")],Fd);class Nnt{constructor(){this.offset=Xe(),this.scale=0,this.tile=null}init(t,i,r,s){this.tile=t,this.offset[0]=i,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const ju=he.getLogger("esri.views.3d.terrain.TerrainSurface"),Fnt=.25;let kt=class extends wr.EventedMixin(we){constructor(e){super(e),this._elevationBounds=new Eq,this._iteratorPool=new Gr(Uve,t=>t.remove=()=>this._iteratorPool.release(t)),this._postorderIterator=new qrt,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=O2,this._performanceInfo=new Dnt,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=M(),this._eyePosSurfaceSR=M(),this._splitLimits=new lst,this._snapLevel=1/0,this._frustum=GC(),this._viewProjectionMatrix=Te(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new Bt,this._watchUpdatingTracking=new rp,this._frameTask=TT,this._allTiles=new $t,this._upsampleInfoPool=new Gr(Nnt),this._rootTilesExtent=Dt(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=Ppe,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=lrt(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Gr(hst):new Gr(dst);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",s=>s.unloadMapData()),this._elevationQueryCache=new ort(e.newCache("elevation-query")),this._set("overlayManager",new Oo({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",s=>this._renderer.setNeedsHighlight(s)),this.watch("overlayManager.rendersOccluded",s=>this._renderer.setRenderOccludedOverlay(s))],"overlayManager"),this._renderer=new Mnt({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:di(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([Wt(this,"baseOpacity",s=>{this._handleLayerViewChanges(),this._updateBaseOpacity(s)},!0),Wt(this,"_background",()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",s=>{this._renderer.pointsOfInterest=s,this._watchUpdatingTracking.removeAll(),s&&this._watchUpdatingTracking.add(()=>s.focus.renderLocation,()=>()=>this._allTilesSorted=!1)}),Wt(hi,"TERRAIN_TILE_TREE_SHOW_TILES",s=>{s&&!this._treeDebugger?import("./TerrainTileTree3DDebugger.5e143983.js").then(({TerrainTileTree3DDebugger:n})=>{!this._treeDebugger&&hi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new n({view:this.view}))}):s||(this._treeDebugger=it(this._treeDebugger))})]),this._extentHelper=Rrt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const t=this.view.defaultsFromMap?new Mx({getCollections:()=>{var s,n,o;return(s=this.view)==null||(n=s.defaultsFromMap)==null||(o=n.mapCollections)==null?void 0:o.map(({layers:a})=>a)},getChildrenFunction:s=>s&&"layers"in s?s.layers:null}):this.view.map.allLayers,i=new Fd({layers:t,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Jd.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Jd.BASEMAP);const r=this.view.resourceController.scheduler;this._frameTask=r.registerTask(ut.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate()),this._handles.add([Wt(this._extentHelper,"stencilEnabledExtents",s=>this._renderer.setStencilEnabledLayerExtents(s)),this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingScheme(),!0),Wt(this,"extent",()=>this._updateRootTiles()),this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",()=>this._viewChangeUpdate(),!0),this.view.watch("state.contentCamera",()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate(),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",()=>this._viewChangeUpdate()),Wt(this.view,"qualitySettings.tiledSurface.textureFadeDuration",s=>this._renderer.textureFadingEnabled=s>0),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),Nt(()=>this._userClippingExtent,()=>this._updateClippingExtent(),ph)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=Wi(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=it(this._upsampleMapCache),this._elevationQueryCache=it(this._elevationQueryCache),this._set("tilingSchemeLogic",it(this.tilingSchemeLogic)),this._extentHelper=it(this._extentHelper),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",it(this.overlayManager)),this._tilePool=it(this._tilePool),Oq.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=it(this._renderer),this._iteratorPool=it(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=it(this._upsampleInfoPool),wrt(),ost()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=(e=this.view.pointsOfInterest)==null||(t=e.contentCameraOnSurface)==null?void 0:t.scale;if(i){const r=this.view.state.contentCamera;let s=KN(this.view,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,o=tge(this.view,i)-n;Math.abs(this._snapLevel-o)>Fnt&&(Math.round(o)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=o)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?HT.ON:HT.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(O(t)||O(e))return null;const i=Dt(),r=cve(t,i,e)?i:null,s=this._get("extent");return z_(r,s)?s:r}get extent(){const e=R3(this.groundExtent,this._userClippingExtent,Dt()),t=this._get("extent");return z_(e,t)?t:e}get groundExtent(){return _(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return(e=this.tilingSchemeLogic)==null?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return _(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return(e=(t=this.tilingScheme)==null?void 0:t.spatialReference)!=null?e:null}get _background(){return this.backgroundColor!=null?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),(t=this.view)==null||(i=t._stage)==null||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this.getTileWithElevation(e,t,i,r,Hu);return O(s)?null:Aq(Hu[0],Hu[1],s.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=Hu){var n;const o=this.rootTiles;if(O(o)||!o.length||o[0].layerInfo[Lt.ELEVATION].length===0)return null;if(s[0]=e,s[1]=t,s[2]=i,!yn(s,r,s,(n=this.tilingScheme)==null?void 0:n.spatialReference))return ju.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let a of o){if(!a.containsPoint(s))continue;for(;a&&!a.rendered&&!a.isLeaf;){let c=0;s[0]>.5*(a.extent[0]+a.extent[2])&&(c+=1),s[1]<.5*(a.extent[1]+a.extent[3])&&(c+=2),a=a.children[c]}const l=a.renderData;return l&&l.geometryState.samplerData?a:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!Qs(e,Hu,this.spatialReference))return ju.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(_(t)){for(let i of t)if(i.containsPoint(Hu)){for(;i.children[0]!=null;){let r=0;Hu[0]>i.children[0].extent[2]&&(r+=1),Hu[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.level)}}}return 1e100}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!Qs(e,Hu,this.spatialReference))return ju.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Hu[3]=t;let i=null;const r=n=>{if(n&&xSe(n.extent,Hu))if(n.children[0]!=null)for(const o of n.children)r(o);else{const o=this._getLodBiasCorrectedScale(n.level);i=i==null?o:Math.min(i,o)}},s=this.rootTiles;if(_(s))for(const n of s)r(n);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,o=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+o,n+o,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t===this._renderer.opaque?Xs.UNFADED:Xs.IMMEDIATE;var r,s;i===Xs.IMMEDIATE&&((r=this.view)==null||(s=r._stage)==null||s.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(yh(!!e,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return VP[0]=e,VP[1]=t,VP[2]=i,s.init(VP,r,this),s}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=znt;let r=t.rootTilesInExtent(e,i,5*ox);if(_(this.rootTiles)){if(r.length>ox)return void ju.warn(Ike);const s=this.rootTiles.map(o=>o.lij),n=N1e(s,r,Aie);if(n.removed.length>0||n.added.length>0){const o=this.rootTiles.filter(a=>!(n.removed.findIndex(l=>Aie(l,a.lij))>-1)||(this._purgeTile(a),!1));n.added.forEach(a=>o.push(this._newRootTile(a))),this._setRootTiles(o)}}else r.length>ox&&(ju.warn($ke),r=t.rootTilesInExtent(e,i,ox)),this._setRootTiles(r.map(s=>this._newRootTile(s)));z_(i,this._rootTilesExtent)||(this._rootTilesExtent=Dt(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&t.setPendingUpdate(vt.SPLIT),this._loadTile(t),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),_(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(e)}_updateTilesVisibility(e){if(O(e))return;const t=Yrt(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,n=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){const l=a.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(l),l.setPendingUpdate(vt.RENDERDATA);const c=l.computeVisibility();s||c?(l.updateScreenDepth(o),l.renderData&&(i=Math.min(l.elevationBounds[0],i),r=Math.max(l.elevationBounds[1],r))):a.skipSubtree()}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(O(this._splitLimits.frustum)&&(this._splitLimits.frustum=GC()),$D(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,$D(this._frustum,e.frustum),ur(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),ne(this._eyePosRenderSR,t.eye),yn(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=$it(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(YE(e)?this._loadChildren(e):knt(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=O2}_updateTileTexture(e,t){const i=e.resetPendingUpdate(vt.TEXTURE_FADING)?vt.TEXTURE_FADING:!!e.resetPendingUpdate(vt.TEXTURE_NOFADING)&&vt.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=O2,t.madeProgress())}_elevationUpdate(e){GP.spatialReference=this.spatialReference,GP.tile=e,GP.extent=e.extent,this.emit("elevation-change",GP),CG(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run(()=>this._updateElevation(e)),e.run(()=>this._updateTextures(e)),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const i=t.next();if(i.loadable){const r=i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(r===vt.SPLIT){i.resetPendingUpdate(vt.MERGE),i.isLeaf&&(i.setPendingUpdate(vt.SPLIT),t.skipSubtree());continue}i.resetPendingUpdate(vt.SPLIT)&&i.updateAgentSuspension(),r===vt.VSPLITMERGE&&i.updateAgents(Lt.ELEVATION)}if(t.skipSubtree(),!i.isLeaf){i.setPendingUpdate(vt.MERGE),i.resetPendingUpdate(vt.SPLIT);const r=this._iteratorPool.acquire();r.resetOne(i);for(let s=r.next();!r.done;s=r.next())this._updateClippingStatus(s),s.updateVisibility(),s.loadable&&s.updateScreenDepth(this._viewProjectionMatrix);r.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(Wrt(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some(n=>{if(i+=n.usedMemory,n.resetPendingUpdate(vt.MERGE)){if(!t)return n.setPendingUpdate(vt.MERGE),e.done;this._mergeTile(n),r=!0,e.madeProgress()}else n.resetPendingUpdate(vt.SPLIT)&&(this._splitTile(n),r=!0,e.madeProgress());return!e.done&&n.resetPendingUpdate(vt.RENDERDATA)&&(this._updateRenderData(n),e.madeProgress()),e.done});if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}i===0&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some(t=>(t.resetPendingUpdate(vt.GEOMETRY)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done)),e.hasProgressed}_updateTextures(e){return this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done)),e.hasProgressed}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(ts.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Oke}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=ze(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){_(this.rootTiles)&&(this.rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){yh(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(vt.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){jP.spatialReference=this.spatialReference,jP.extent=e.extent,jP.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",jP)}_createTile(e,t,i,r){yh(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&s.setPendingUpdate(vt.SPLIT)),s}_mergeTile(e){yh(!e.hasPendingUpdate(vt.SPLIT),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(yh(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){yh(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(vt.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new Crt(e.lij,e.extent,i);e.dataArrived(t,Lt.ELEVATION,r);const s=[e],n=e.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const a=o.next();a.findElevationBoundsForLayer(t,n),a.computeElevationBounds()}o.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=_S){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),Nx(s))if(this._basemapLayerViewHandles.has(s.uid)){const n=this._layerClassFromLayerView(s),o=this._layerIndexByUid[n].get(s.uid);o<r&&(t=!0),r=o}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach((s,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)}),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){var e,t;let i=((e=this.view.map)==null||(t=e.ground)==null?void 0:t.opacity)===0;for(const r of this.view.allLayerViews.items)if(Nx(r)&&!jI(r)&&!dce(r.layer)&&r.fullOpacity!==0)return i=!1,i;return i}_layerClassFromLayerView(e){return jI(e)?Lt.ELEVATION:Lt.MAP}_registerTiledLayerView(e){const t=[],i=this._layerClassFromLayerView(e);t.push(e.watch("suspended",()=>this._updateTiledLayers())),t.push(e.watch("fullOpacity",()=>this._updateTileTextures(Xs.UNFADED))),t.push(e.layer.watch("effectiveScaleRange",()=>this._restartAllAgents(i))),e.on("data-changed",()=>{const r=this._layerIndexByUid[i].get(e.uid);r!=null&&this._invalidateLayerData(r,i)}),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let i=0;i<t.length;i++)t[i].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=Tu();e.forEach(s=>{const n=s.layer;if(!n||s.suspended||!Nx(s))return;const o=s.fullExtent;if(!o)return void ju.warn("Terrain: Map or elevation layer does not have fullExtent: "+n.id);jy(r,o,r);const a=this._layerClassFromLayerView(s);if(a===Lt.MAP){const l=s.displayLevelRange;l.maxLevel!==1/0&&(i===null||l.maxLevel>i)&&(i=l.maxLevel)}t[a].push(s)});for(const s of t_){const n=this._layerViews[s],o=t[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const g=n.indexOf(o[p]);c[p]=g,p!==g&&(l=!0),g>-1&&(h[g]=p)}if(l){const p=this._postorderIterator;for(p.reset(this.rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===Lt.ELEVATION&&i.computeElevationBounds()}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(Lt.MAP),e===Xs.IMMEDIATE?this.renderer.updateTileTexture(t,vt.TEXTURE_NOFADING):t.updateRenderData(Lt.MAP,e)}),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=ts.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||pL(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],me(I({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(o=>{throw--this._asyncWorkItems,vr(o)||this._dataMissing(e,i,s,{notInTilemap:!0}),o}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,s,r),r.signal)))}_requestTileData(e,t,i,r){return t===Lt.ELEVATION?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!jI(t))return void yh(!1,"_requestElevationTileData can only be called for elevation layer views");const r=o=>{if(--this._asyncWorkItems,Ls(i))return;const a=this._layerIndexByUid[Lt.ELEVATION].get(t.uid);a!=null?(this._usedMemory=O2,this.requestUpdate(),this._elevationDataArrived(e,a,o)):ju.warn("TerrainSurface: received data from unknown layer %d %s",Lt.ELEVATION,e.lij.toString())},s=o=>{--this._asyncWorkItems,vr(o)||(this._dataMissing(e,Lt.ELEVATION,t,o),this.requestUpdate())};if(++this._asyncWorkItems,tie(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:wC,signal:i.signal}).then(o=>{if(Ls(i))return ju.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(pi());this._frameTask.schedule(()=>r(o),i.signal,s)},s);const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then(o=>this._lercDecoder.decode(o,{noDataValue:wC},i.signal)).then(o=>{r({values:o.pixelData,width:o.width,height:o.height,noDataValue:o.noDataValue,minValue:o.minValue,maxValue:o.maxValue})},s)}_requestMapTileData(e,t,i){if(t instanceof Ive)return Promise.reject();++this._asyncWorkItems;const r=(c,h)=>{--this._asyncWorkItems,Fx(h),Ls(i)||(this._dataMissing(e,Lt.MAP,t,c),this.requestUpdate())},s=c=>h=>r(h,c),n=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Ls(i)?Fx(c):this._mapTileDataArrived(e,t,c)},i.signal,s(c)).catch(s(c)),o=(c,h=null)=>this._frameTask.schedule(()=>r(c,h));if(pL(t)){const c=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(c[0],c[1],c[2],i).then(n,o)}if(Sq(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,o);if(Ave(t)&&tie(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(c=>{if(Ls(i))return ju.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o(pi());n(c)},o);let a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);c5e(t.layer)&&t.layer.refreshTimestamp&&(a+=`${a.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(a,l,i).then(n,o)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[Lt.MAP].get(t.uid);r!=null?e.dataArrived(r,Lt.MAP,i):(Fx(i),ju.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);s!=null?e.dataMissing(s,t,r):ju.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(t=>{t.renderData&&this.overlayManager.setTileParameters(t)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===O2&&(this._usedMemory=0,this._allTiles.forAll(e=>this._usedMemory+=e.usedMemory)),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll(s=>t+=s.getUsedMemoryForLayer(i,r)),t}getTile(e){if(O(e)||O(this.rootTiles))return null;const t=e.split("/").map(o=>+o);if(t[0]===0)return this.rootTiles.find(o=>o.lij[1]===t[1]&&o.lij[2]===t[2]);const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this.rootTiles.some(o=>o.lij[1]===r&&o.lij[2]===s&&(n=o,!0)),n){let o=1<<t[0]-1;for(;n.lij[0]<t[0];){let a=t[1]&o?2:0;if((t[2]&o)>0&&a++,!n.children[a])return null;n=n.children[a],o>>=1}return yh(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{_(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){Sk.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&Sk.push(i)});const t=Sk.toArray();return kve(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}};u([d()],kt.prototype,"_renderer",void 0),u([d()],kt.prototype,"_hasPendingUpdates",void 0),u([d()],kt.prototype,"_asyncWorkItems",void 0),u([d()],kt.prototype,"_allTilesDirty",void 0),u([d()],kt.prototype,"_allTilesSorted",void 0),u([d()],kt.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],kt.prototype,"_watchUpdatingTracking",void 0),u([d()],kt.prototype,"_frameTask",void 0),u([d({readOnly:!0})],kt.prototype,"snapLevel",null),u([d({readOnly:!0})],kt.prototype,"lodSnapping",null),u([d({constructOnly:!0})],kt.prototype,"view",void 0),u([d()],kt.prototype,"_userClippingExtent",null),u([d()],kt.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],kt.prototype,"extent",null),u([d({readOnly:!0})],kt.prototype,"groundExtent",null),u([d({readOnly:!0})],kt.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],kt.prototype,"updating",null),u([d(Pve)],kt.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],kt.prototype,"updatingProgressValue",null),u([d()],kt.prototype,"_maxNumUpdating",void 0),u([d({aliasOf:"view.map.ground.opacity"})],kt.prototype,"baseOpacity",void 0),u([d({readOnly:!0})],kt.prototype,"overlayManager",void 0),u([d({readOnly:!0})],kt.prototype,"viewingMode",null),u([d()],kt.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],kt.prototype,"ready",null),u([d({value:lR.FRONT_TO_BACK})],kt.prototype,"renderOrder",null),u([d({readOnly:!0})],kt.prototype,"rootTiles",void 0),u([d({readOnly:!0})],kt.prototype,"spatialReference",null),u([d()],kt.prototype,"backgroundImage",void 0),u([d({type:Qe,aliasOf:"view.map.ground.surfaceColor"})],kt.prototype,"backgroundColor",void 0),u([d()],kt.prototype,"_background",null),u([d({value:!1})],kt.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],kt.prototype,"tilingScheme",void 0),u([d({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],kt.prototype,"tilingSchemeLocked",void 0),u([d({readOnly:!0})],kt.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],kt.prototype,"velvetOverground",null),u([mt("_renderer.wireframe")],kt.prototype,"wireframe",void 0),u([d({value:!1})],kt.prototype,"suspended",null),u([d({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],kt.prototype,"textureFadeDuration",void 0),u([d()],kt.prototype,"_layerViewsDirty",void 0),u([mt("_renderer.renderPatchBorders")],kt.prototype,"renderPatchBorders",void 0),u([mt("_renderer.renderingDisabled")],kt.prototype,"renderingDisabled",void 0),kt=u([P("esri.views.3d.terrain.TerrainSurface")],kt);const Unt=kt;function Aie(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function YE(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||YE(e.children[0])||YE(e.children[1])||YE(e.children[2])||YE(e.children[3]))}function knt(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const O2=-1,Hu=ni(),znt=Dt(),VP=[0,0,0],Sk=new $t,GP={spatialReference:null,tile:null,extent:null,context:"ground"},jP={spatialReference:null,extent:null,scale:0};let ZE=class extends we{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach((t,i)=>this.commitLayer(i,e))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((r,s)=>{const n=this._ensureGeomRecord(e,s);r.forEach((o,a)=>{const l=o[0],c=o[1],h=o[2];let p=!1;if(c&Gt.Geometry.UPDATE){const f=n.get(a);if(f){const g=f[1];if(h&Gt.State.TRANSFORMATION){const y=this.model.getObject(s);this.model.updateRenderGeometryTransformation(y,l,g)&&(p=!0)}p||t.updates.push({renderGeometry:g,updateType:h})}else ot(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(c&Gt.Geometry.REMOVE||p){const f=n.get(a);f?(t.removes.push(f[1]),n.delete(a),f[0].disposed&&P1.pool.release(f[0])):c===Gt.Geometry.REMOVE&&ot(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(c&Gt.Geometry.ADD||p){const f=this.model.getObject(s);if(_(f)){const g=this.model.getRenderGeometry(f,l),y=[l,g];t.adds.push(g),n.set(a,y)}}}),n.size===0&&this._residentGeomRecords.get(e).delete(s)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach(r=>r.forEach(s=>t.push(s[1])))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,e)}visibilityChanged(e){this._objectStateChanged(Gt.State.VISIBILITIES,e)}highlightChanged(e){this._objectStateChanged(Gt.State.HIGHLIGHTS,e)}occlusionChanged(e){this._objectStateChanged(Gt.State.OCCLUDEES,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,Gt.State.VERTEXATTRS)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryRemoved(t,r,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach((i,r)=>{const s=this.model.getObject(r);s&&s.hasVolativeTransformation()&&i.forEach(n=>{n[1].shaderTransformationChanged()})})}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{this._updateOrCreateDirtyRecord(e,r[0],t,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,Gt.State.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Gt.Geometry.ADD,Gt.Geometry.REMOVE,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Gt.Geometry.REMOVE,Gt.Geometry.ADD,Gt.Geometry.UPDATE,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,n,o,a,l){i=gt(i,this._getParentLayerId(e));const c=e.id,h=t.id,p=this._ensureDirtyRecord(i,c),f=p.get(h);if(f){const g=f[1];g&s?(p.delete(h),f[0].disposed&&P1.pool.release(f[0])):g&n?(f[1]=r,f[2]=l):g&o?f[2]|=l:g&a||ot(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else p.set(h,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return Vr(this._dirtyGeomRecords,e=>Vr(e,t=>t&&t.size>0))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return _(e.parentLayer)?e.parentLayer.id:Ibe}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((s,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const o=[];s.forEach(a=>{const l=a[1];o[l]||(o[l]=[]),o[l].push(a[0].geometry.id)});for(let a=0;a<o.length;a++)if(o[a]){t+=" "+e[a-1]+": ";for(let l=0;l<o[a].length;l++)t+=o[a][l]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((t,i)=>t+i.size,0)}}}};u([d({constructOnly:!0})],ZE.prototype,"model",void 0),u([d()],ZE.prototype,"dirty",void 0),ZE=u([P("esri.views.3d.webgl-engine.lib.ModelDirtySet")],ZE);const Bnt=ZE;let XI=class extends we{constructor(){super(...arguments),this.dirtySet=new Bnt({model:this}),this._content=new Map,this._originFactory=new eq(null,75e4)}getObject(e){return this._content.get(e)}add(e){const t=e.id;ot(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),JD(e)&&this.dirtySet.layerAdded(e)}remove(e){ot(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),JD(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)_(t)&&(ot(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)ot(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:n,origin:o,instanceParameters:a}=t,l=new qT(i,r,{id:s,boundingInfo:i.boundingInfo,calculateShaderTransformation:n,castShadow:e.castShadow});return l.updateTransformation(c=>e.getCombinedStaticTransformation(t,c)),l.origin=o||this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=a,l}updateRenderGeometryTransformation(e,t,i){if(O(e))return!1;i.updateTransformation(s=>e.getCombinedStaticTransformation(t,s));const r=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<Wh.COUNT;++i)e[i]=t.filter(r=>r.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],XI.prototype,"dirtySet",void 0),XI=u([P("esri.views.3d.webgl-engine.parts.Model")],XI);function Vnt(){const e=new Float32Array(4);return e[3]=1,e}function Zve(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Gnt(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Qve(e,t){return new Float32Array(e,t,4)}Object.freeze({__proto__:null,create:Vnt,clone:Zve,fromValues:Gnt,createView:Qve});const WT=1e-6,M2=[0,0,0],HP=[0,0,0];function jnt(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const n=new Knt(e);YI(M2,n.minProj,n.maxProj),T_(M2,M2,.5),hu(HP,n.maxProj,n.minProj);const o=_9(HP),a=new eot;a.quality=o,s<14&&(e={data:new Float64Array(n.buffer,112,42),size:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],g=[0,0,0],y=[0,0,0];switch(Hnt(n,e,y,l,c,h,p,f,g,a)){case 1:return void Mie(M2,HP,t);case 2:return void Jnt(e,p,t)}qnt(e,y,l,c,h,p,f,g,a),Jve(e,a.b0,a.b1,a.b2,zx,Bx);const v=[0,0,0];hu(v,Bx,zx),a.quality=_9(v),a.quality<o?Kve(a.b0,a.b1,a.b2,zx,Bx,v,t):Mie(M2,HP,t)}function Hnt(e,t,i,r,s,n,o,a,l,c){return Wnt(e,r,s),b9(r,s)<WT?1:(hu(o,r,s),Pn(o,o),Xnt(t,r,o,n)<WT?2:(hu(a,s,n),Pn(a,a),hu(l,n,r),Pn(l,l),du(i,a,o),Pn(i,i),i_(t,i,o,a,l,c),0))}const P2=[0,0,0],I2=[0,0,0],$c=[0,0,0],Dc=[0,0,0],Lc=[0,0,0],mg=[0,0,0],gg=[0,0,0],yg=[0,0,0];function qnt(e,t,i,r,s,n,o,a,l){Ynt(e,t,i,P2,I2),P2[0]!==void 0&&(hu($c,P2,i),Pn($c,$c),hu(Dc,P2,r),Pn(Dc,Dc),hu(Lc,P2,s),Pn(Lc,Lc),du(mg,Dc,n),Pn(mg,mg),du(gg,Lc,o),Pn(gg,gg),du(yg,$c,a),Pn(yg,yg),i_(e,mg,n,Dc,$c,l),i_(e,gg,o,Lc,Dc,l),i_(e,yg,a,$c,Lc,l)),I2[0]!==void 0&&(hu($c,I2,i),Pn($c,$c),hu(Dc,I2,r),Pn(Dc,Dc),hu(Lc,I2,s),Pn(Lc,Lc),du(mg,Dc,n),Pn(mg,mg),du(gg,Lc,o),Pn(gg,gg),du(yg,$c,a),Pn(yg,yg),i_(e,mg,n,Dc,$c,l),i_(e,gg,o,Lc,Dc,l),i_(e,yg,a,$c,Lc,l))}function Wnt(e,t,i){let r=b9(e.maxVert[0],e.minVert[0]),s=0;for(let n=1;n<7;++n){const o=b9(e.maxVert[n],e.minVert[n]);o>r&&(r=o,s=n)}ll(t,e.minVert[s]),ll(i,e.maxVert[s])}const Nc=[0,0,0];function Xnt(e,t,i,r){const{data:s,size:n}=e;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){Nc[0]=s[l]-t[0],Nc[1]=s[l+1]-t[1],Nc[2]=s[l+2]-t[2];const c=i[0]*Nc[0]+i[1]*Nc[1]+i[2]*Nc[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],p=Nc[0]*Nc[0]+Nc[1]*Nc[1]+Nc[2]*Nc[2]-c*c/h;p>o&&(o=p,a=l)}return ll(r,s,a),o}const Ds=[0,0];function Ynt(e,t,i,r,s){Qnt(e,t,Ds,s,r);const n=t_e(i,t);Ds[1]-WT<=n&&(r[0]=void 0),Ds[0]+WT>=n&&(s[0]=void 0)}const Cie=[0,0,0],Rie=[0,0,0],Oie=[0,0,0],jb=[0,0,0],Hb=[0,0,0],qP=[0,0,0];function i_(e,t,i,r,s,n){if(e_e(t)<WT)return;du(Cie,i,t),du(Rie,r,t),du(Oie,s,t),kx(e,t,Ds),Hb[1]=Ds[0],jb[1]=Ds[1],qP[1]=jb[1]-Hb[1];const o=[i,r,s],a=[Cie,Rie,Oie];for(let l=0;l<3;++l){kx(e,o[l],Ds),Hb[0]=Ds[0],jb[0]=Ds[1],kx(e,a[l],Ds),Hb[2]=Ds[0],jb[2]=Ds[1],qP[0]=jb[0]-Hb[0],qP[2]=jb[2]-Hb[2];const c=_9(qP);c<n.quality&&(ll(n.b0,o[l]),ll(n.b1,t),ll(n.b2,a[l]),n.quality=c)}}const Znt=[0,0,0];function kx(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<r.length;n+=s){const o=r[n]*t[0]+r[n+1]*t[1]+r[n+2]*t[2];i[0]=Math.min(i[0],o),i[1]=Math.max(i[1],o)}}function Qnt(e,t,i,r,s){const{data:n,size:o}=e;ll(r,n),ll(s,r),i[0]=t_e(Znt,t),i[1]=i[0];for(let a=o;a<n.length;a+=o){const l=n[a]*t[0]+n[a+1]*t[1]+n[a+2]*t[2];l<i[0]&&(i[0]=l,ll(r,n,a)),l>i[1]&&(i[1]=l,ll(s,n,a))}}function Mie(e,t,i){ll(i.center,e),T_(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const Qp=[0,0,0],qb=[0,0,0],$2=[0,0,0],zx=[0,0,0],Bx=[0,0,0],Pie=[0,0,0];function Jnt(e,t,i){ll(Qp,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?Qp[0]=0:Math.abs(t[1])>Math.abs(t[2])?Qp[1]=0:Qp[2]=0,e_e(Qp)<WT&&(Qp[0]=Qp[1]=Qp[2]=1),du(qb,t,Qp),Pn(qb,qb),du($2,t,qb),Pn($2,$2),Jve(e,t,qb,$2,zx,Bx),hu(Pie,Bx,zx),Kve(t,qb,$2,zx,Bx,Pie,i)}function Jve(e,t,i,r,s,n){kx(e,t,Ds),s[0]=Ds[0],n[0]=Ds[1],kx(e,i,Ds),s[1]=Ds[0],n[1]=Ds[1],kx(e,r,Ds),s[2]=Ds[0],n[2]=Ds[1]}const WP=[0,0,0],fd=[1,0,0,0,1,0,0,0,1],Wb=[0,0,0];function Kve(e,t,i,r,s,n,o){fd[0]=e[0],fd[1]=e[1],fd[2]=e[2],fd[3]=t[0],fd[4]=t[1],fd[5]=t[2],fd[6]=i[0],fd[7]=i[1],fd[8]=i[2],tot(o.quaternion,fd),YI(Wb,r,s),T_(Wb,Wb,.5),T_(o.center,e,Wb[0]),T_(WP,t,Wb[1]),YI(o.center,o.center,WP),T_(WP,i,Wb[2]),YI(o.center,o.center,WP),T_(o.halfSize,n,.5)}const Cl=7;class Knt{constructor(t){this.minVert=new Array(Cl),this.maxVert=new Array(Cl);const i=64*Cl;this.buffer=new ArrayBuffer(i);let r=0;this.minProj=new Float64Array(this.buffer,r,Cl),r+=8*Cl,this.maxProj=new Float64Array(this.buffer,r,Cl),r+=8*Cl;for(let l=0;l<Cl;++l)this.minVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<Cl;++l)this.maxVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<Cl;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(Cl),n=new Array(Cl),{data:o,size:a}=t;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<Cl;++l){let c=s[l];ll(this.minVert[l],o,c),c=n[l],ll(this.maxVert[l],o,c)}}}class eot{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function _9(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function YI(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function hu(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function T_(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function ll(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function du(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o}function Pn(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function e_e(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function b9(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function t_e(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function tot(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);const s=(r+1)%3,n=(r+2)%3;let o=Math.sqrt(t[3*r+r]-t[3*s+s]-t[3*n+n]+1);e[r]=.5*o,o=.5/o,e[3]=(t[3*s+n]-t[3*n+s])*o,e[s]=(t[3*s+r]+t[3*r+s])*o,e[n]=(t[3*n+r]+t[3*r+n])*o}}const GA=T0(),U_=M(),iot=M(),rot=br();class fft{constructor(t){const o=t*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(t);for(let a=0;a<t;a++)this.obbs[a]={center:H9(this.buffer,56*a+0),halfSize:Dfe(this.buffer,56*a+24),quaternion:Qve(this.buffer,56*a+36)}}}function i_e(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Ts(e),halfSize:ED(t),quaternion:Zve(i)}}function sot(e){return i_e(e.center,e.halfSize,e.quaternion)}function mft(e,t){ne(t.center,e.center),ne(t.halfSize,e.halfSize),Pfe(t.quaternion,e.quaternion)}function gft(e,t){return t=t||i_e(),jnt(e,t),t}function r_(e,t){const i=er(t,e.center),r=YF(e,t);return i>r?1:i<-r?-1:0}function yft(e,t){t||(t=os());const i=Wj(rot,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),n=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-n,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+n,t}function vft(e,t){return er(t,e.center)-YF(e,t)}function _ft(e,t){return er(t,e.center)+YF(e,t)}function bft(e,t){return r_(e,t[0])<=0&&r_(e,t[1])<=0&&r_(e,t[2])<=0&&r_(e,t[3])<=0&&r_(e,t[4])<=0&&r_(e,t[5])<=0}function wft(e,t,i,r=0){HR(GA,e.quaternion),de(U_,t,e.center);const s=Ky(U_,U_,GA),n=Ky(iot,i,GA);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(r+e.halfSize[l]-s[l])/n[l],h=(-r-e.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>e.halfSize[l]+r||s[l]<-e.halfSize[l]-r)return!1;return o<=a}(()=>{const e=new Int8Array(162);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=6};return i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4]),e})();function YF(e,t){HR(GA,e.quaternion),Ky(U_,t,GA);const i=e.halfSize;return Math.abs(U_[0]*i[0])+Math.abs(U_[1]*i[1])+Math.abs(U_[2]*i[2])}function xft(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],Ky(r,r,e.quaternion),pe(r,r,e.center)}}function not(e){return Z9(e.halfSize)}class oot{constructor(t){this._totalCount=t,this._indexRanges=[0,t]}componentCount(){const t=this._indexRanges;let i=0;for(let r=0;r<t.length;r+=2)i+=t[r+1];return i}reset(t){t==="all"||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=aot(t)}forEachComponent(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1];for(let o=s;o<n;o++)if(!t(o))return!1}return!0}forEachComponentRange(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r];if(!t(s,s+i[r+1]))return!1}return!0}computeOffsetRanges(t){const i=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const n=r[s],o=n+r[s+1],a=t[n],l=t[o];i[s]=a,i[s+1]=l-a}return i}}function aot(e){const t=new Array;if(e.length===0)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}class lot extends mF{constructor(t,i){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=$9(i);const r=this.count;this.visibility=new oot(r),this.materialDataBuffer=t.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])}get count(){return this.offsets.length-1}get geometryRanges(){return O(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return O(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return O(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((O(this.cachedHighlightRanges)||O(this.cachedDefaultRanges))&&_(this.highlightCounts)){const{highlightRanges:t,defaultRanges:i}=cot(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=i}}}function cot(e,t,i){const r=[],s=[];let n=i.length,o=i.length;return t.forEachComponent(a=>(e[a]>0?(n!==a-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[a])),n=a):(o!==a-1&&(s.length&&s.push(i[o+1]-s[s.length-1]),s.push(i[a])),o=a),!0)),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[o+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}class w9 extends mF{constructor(){super(...arguments),this.visible=Vx.Hidden}}var Vx;u([Mn()],w9.prototype,"renderable",void 0),u([Mn()],w9.prototype,"components",void 0),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(Vx||(Vx={}));function uot(e){return typeof e=="function"}function hot(e,t,i,r){if(i>=t)return e;e==null&&(e=dot());const s=e.isVisibleBit;let n=e.data;const o=s_e(n),a=i/o|0,l=i-o*a,c=(t-1)/o|0,h=n,p=r===s;if(!(i<h.length*o)&&p){const g=a+1,y=Math.ceil(h.length*1.5),v=c+1;let b=Math.max(g,y);b=Math.min(b,v),n=new Uint32Array(b),n.set(h)}return a<n.length&&(n[a]=fot(n[a],l,p)),e.data=n,e}function r_e(e,t){if(e==null)return!0;const{isVisibleBit:i,data:r}=e,s=s_e(r);return t<r.length*s?pot(i,r,t,s):!e.isVisibleBit}function dot(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}function pot(e,t,i,r){const s=i/r|0,n=i-s*r;return mot(t[s],n)===e}function s_e(e){return e.BYTES_PER_ELEMENT*8}function fot(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function mot(e,t){return(e&1<<t)!=0}class got{constructor(t,i){this._indices=_(t.indices)?t.indices:UT(t.positions.length/3),this._positions=new Ti(t.positions),this._components=i,this._componentIntersectionData=new Array(i.count)}getComponentAabb(t,i){if(_(this._perComponentAabbs)){for(let r=0;r<6;r++)i[r]=this._perComponentAabbs[6*t+r];return i}return this._computePerComponentAabbs(),this.getComponentAabb(t,i)}getComponentPositions(t,i){i.indices=this._indices,i.data=this._positions.typedBuffer,i.stride=this._positions.typedBufferStride,i.startIndex=this._components.offsets[t],i.endIndex=this._components.offsets[t+1]}intersect(t,i,r,s,n,o){const a={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,c=this._components.offsets,h=wge(t,i,yot);this._components.visibility.forEachComponent(p=>{if(!r_e(this._components.pickability,p))return!0;const f=this.getComponentAabb(p,vot);if(_(n)&&n.applyToAabb(f),!CH(f,t,h,r))return!0;const g=c[p]/3,y=c[p+1]/3,v=(w,S,T)=>{o(p,w,rl(S,S,s),T)},b=y-g;return O(n)&&b>y9?(this._componentIntersectionData[p]==null&&(this._componentIntersectionData[p]=new k1(this._indices,g,y,a)),this._componentIntersectionData[p].intersectRay({r0:t,r1:i},v)):QR(t,i,g,y,l,a,void 0,n,v),!0})}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let i=0;i<t;i++)this._computeAABB(i)}_computeAABB(t){const i=this._indices,r=this._positions,s=this._components.offsets,n=s[t],o=s[t+1],a=[0,0,0],l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let p=n;p<o;p++){const f=i[p];r.getVec(f,a),une(l,l,a),hne(c,c,a)}let h=6*t;this._perComponentAabbs[h++]=l[0],this._perComponentAabbs[h++]=l[1],this._perComponentAabbs[h++]=l[2],this._perComponentAabbs[h++]=c[0],this._perComponentAabbs[h++]=c[1],this._perComponentAabbs[h]=c[2]}get positions(){return this._positions}get indices(){return this._indices}}const yot=M(),vot=os();class _ot{constructor(t,i,r,s){this.material=t,this.drawParameters=i,this.geometry=r,this.meta=s}dispose(){this.material.dispose(),this.geometry.dispose()}}class n_e extends mF{constructor(t,i,r,s){super(),this.primitiveType=i,this.parameters=r,this.indexed=s,this.vao=t}}u([Mn()],n_e.prototype,"vao",void 0);function bot(e,t){return{near:e,far:t}}function uO(e){return e?uR(e,1/0,-1/0):bot(1/0,-1/0)}function uR(e,t,i){return e.near=t,e.far=i,e}function XT(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function XP(e,t){return e.near<=t&&t<=e.far}const x9={near:0,far:0};function wot(e,t){const i=uO(),{eye:r,frustum:s,viewForward:n}=e;t.forAll(o=>{const a=o.obb,l=_e(lp(Fl,a.center,r),n),c=YF(a,n);if(XP(i,l-c)&&XP(i,l+c))return;const h=Aot(a,s);if(h===-1)return;if(h===0)return Jp.far=l+c,Jp.near=l-c,void XT(i,Jp);const p=YP.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<YP.length;o++){const a=YP.data[o];if(XP(i,a.near)&&XP(i,a.far))continue;Jp.far=a.far,Jp.near=1/0,Eot(a.object.obb,r,xot,c=>{let h=Tot;for(let p=0;p<o_e&&c.length>0;p++){if((a.mask&1<<p)==0)continue;Sot(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){oe(na,c.data[p+0],c.data[p+1],c.data[p+2]);const f=_e(lp(na,na,r),n);Jp.near=Math.min(Jp.near,f)}})===0&&(Jp.near=0),XT(i,Jp)}return YP.length=0,i}const YP=new $t({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),Jp=uO(),na=M(),dv=M(),xot=new $t({deallocator:null}),Tot=new $t({deallocator:null});function Sot(e,t,i){i.length=0;const r=t.length-3;Ek(na,t,r);const s=er(e,na);s<=0&&(i.push(na[0]),i.push(na[1]),i.push(na[2]));let n=0,o=s;for(;n<r;n+=3){Ek(dv,t,n);const a=er(e,dv);o*a<0&&(Ss(na,dv,na,a/(a-o)),oa(i,na)),a<=0&&oa(i,dv),o=a,ne(na,dv)}o*s<0&&(Ek(dv,t,r),Ss(na,dv,na,s/(s-o)),oa(i,na))}function Ek(e,t,i){return oe(e,t.data[i+0],t.data[i+1],t.data[i+2])}function oa(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function Eot(e,t,i,r){HR($ie,e.quaternion),lp(Fl,t,e.center),Ky(Fl,Fl,$ie);const s=8*((Fl[0]<-e.halfSize[0]?-1:Fl[0]>e.halfSize[0]?1:0)+3*(Fl[1]<-e.halfSize[1]?-1:Fl[1]>e.halfSize[1]?1:0)+9*(Fl[2]<-e.halfSize[2]?-1:Fl[2]>e.halfSize[2]?1:0)+13),n=Iie[s];if(n===0)return n;Wj(ZP,e.quaternion),qj(ZP,ZP,e.halfSize);const o=(a,l)=>{const c=Iie[s+l+1];return oe(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),rl(a,a,ZP),pe(a,e.center,a)};return i.length=0,oa(i,o(Ak,0)),oa(i,o(Die,1)),oa(i,o(Fl,2)),oa(i,o(Lie,3)),r(i),n===1||(i.length=0,oa(i,Ak),oa(i,Lie),oa(i,o(Fl,4)),oa(i,o(Nie,5)),r(i),n===2||(i.length=0,oa(i,Ak),oa(i,Nie),oa(i,o(Fl,6)),oa(i,Die),r(i))),n}const Iie=(()=>{const e=new Int8Array(216);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),o_e=4;function Aot(e,t){let i=0;for(let r=0;r<o_e;r++){const s=r_(e,t[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}const ZP=br(),$ie=T0(),Fl=M(),Ak=M(),Die=M(),Lie=M(),Nie=M();class Cot{constructor(t){this._objects=t}submit(t,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(t,r))}queryShadowCasterDepthRange(t){return this._objects.visibleObjects.length?wot(t,this._objects.visibleObjects):null}}function Rot(e){const t=Nr().vec3f(E.POSITION);return e.normals&&t.vec2i16(E.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===mn.Default?t.vec2f(E.UV0):e.textureCoordinates===mn.Atlas&&(t.vec2f(E.UV0),t.vec4u16(E.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(E.COLOR,{glNormalized:!0}),t.alignTo(4)}var _p;function Oot(e,t){t.componentData===_p.Varying&&(e.vertex.uniforms.add("componentColorTex","sampler2D"),e.vertex.uniforms.add("componentColorTexInvDim","vec2"),e.attributes.add(E.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(d0e),e.vertex.code.add(x`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return texture2D(componentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),e.fragment.code.add(x`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),t.componentData===_p.Uniform&&(e.vertex.uniforms.add("externalColor","vec4"),e.fragment.uniforms.add("externalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(x`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),e.fragment.code.add(x`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}`))}(function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"})(_p||(_p={}));var gu;function Mot(e,t){const i=e.vertex;switch(i.code.add(x`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case gu.None:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) {}`);break;case gu.Opaque:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case gu.Transparent:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(gu||(gu={}));function Fie(e,t){e.include(sb,t),e.fragment.include(eR);const i=e.fragment;i.uniforms.add("baseColor","vec4"),i.uniforms.add("objectOpacity","float"),t.attributeColor?i.code.add(x`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(x`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(x`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function Uie(e,t){const i=e.fragment;switch(t.doubleSidedMode){case cr.None:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case cr.View:e.include(Lx,t),i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case cr.WindingOrder:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:t.doubleSidedMode;case cr.COUNT:}switch(t.normalType){case Or.Attribute:case Or.CompressedAttribute:e.include(EF,t),i.code.add(x`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Or.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(Lx,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Or.Ground:t.viewingMode===$e.Global?(e.include(Lx,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):t.viewingMode===$e.Local&&i.code.add(x`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:t.normalType;case Or.COUNT:}}function Pot(e,t){const i=e.fragment;t.baseColorTexture?(e.include(zj,t),i.uniforms.add("baseColorTexture","sampler2D"),i.uniforms.add("baseColorTextureSize","vec2"),t.attributeTextureCoordinates===mn.Atlas?(e.include(kfe),i.code.add(x`vec4 readBaseColorTexture() {
return textureAtlasLookup(
baseColorTexture,
baseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(x`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)):i.code.add(x`vec4 readBaseColorTexture() { return vec4(1.0); }`)}var op;function Tft(e){return e&&wp(e)?op.Mars:e&&xp(e)?op.Moon:op.Earth}(function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"})(op||(op={}));const a_e=new Map([[E.POSITION,0],[E.NORMAL,1],[E.NORMALCOMPRESSED,1],[E.COLOR,2],[E.UV0,3],[E.UVREGION,4],[E.COMPONENTINDEX,5]]);function Iot(e){const t=new Ri;t.include(Lx,e),t.include(EF,e),t.include(sb,e),t.include(tm,e),t.include(aO,e),t.include(Oot,e),t.include(rm,e),t.include(Rr,e),t.include(Pot,e),t.include(Mot,e),t.fragment.uniforms.add("view","mat4"),e.pbrMode!==xt.Normal&&e.pbrMode!==xt.Schematic||(t.include(Bj,e),e.hasNormalTexture&&t.include(v0e,e)),e.output===j.Shadow&&e.componentData===_p.Varying?t.vertex.code.add(x`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.vertex.code.add(x`#define discardShadows(castShadows) {}`);const i=e.overlayEnabled&&e.output===j.Color&&e.pbrMode===xt.WaterOnIntegratedMesh;return e.overlayEnabled&&(t.include(D1,e),t.include(v9,e),e.viewingMode===$e.Global?t.vertex.code.add(x`
      const float invEllipsoidRadius = ${x.float(1/(e.ellipsoidMode===op.Earth?ai.radius:e.ellipsoidMode===op.Mars?ip.radius:hm.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(x`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(x`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${x.float(zn)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?x`
        positionView = position_view();
        ${e.viewingMode===$e.Global?x`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:x`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?x`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),e.output===j.Alpha&&(t.fragment.include(As),e.multipassTerrainEnabled&&t.include(yc,e),t.include(Fie,e),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),e.output===j.Color&&(t.fragment.include(As),e.multipassTerrainEnabled&&t.include(yc,e),t.include(Fie,e),t.include(Uie,e),t.include(D1,e),i&&t.fragment.uniforms.add("ovNormalTex","sampler2D"),e.receiveShadows?(t.include(wm,e),t.fragment.code.add(x`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):t.fragment.code.add(x`float evaluateShadow() { return 0.0; }`),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?(t.fragment.code.add(x`
        ${e.pbrMode===xt.Normal?x`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(x`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):t.fragment.code.add(x`vec3 shadingNormal = normalVertex;`),t.fragment.code.add(x`${e.viewingMode===$e.Global?x`vec3 normalGround = normalize(positionWorld());`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(x`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(e.receiveShadows?t.fragment.code.add(x`float shadow = evaluateShadow();`):e.viewingMode===$e.Global?t.fragment.code.add(x`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):t.fragment.code.add(x`float shadow = 0.0;`),t.fragment.code.add(x`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?x`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView, positionWorld());
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(x`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==j.Depth&&e.output!==j.Shadow||(t.include(M0,e),t.fragment.code.add(x`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===j.Normal&&(t.include(Uie,e),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${e.normalType===Or.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===j.Highlight&&(t.include(Fm),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?x`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}const $ot=Object.freeze({__proto__:null,attributeLocations:a_e,build:Iot});var ys,Br;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"})(ys||(ys={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.Depth=2]="Depth",e[e.Normal=3]="Normal"}(Br||(Br={}));class Fq{constructor(){this.viewTransform=new f0e,this.slicePlane=Y1()}}class Dot extends Fq{constructor(){super(...arguments),this.identifier=ys.Material,this.slicePlaneEnabled=!0,this.transparent=!1,this.integratedMesh=!1,this.transformNormalViewFromGlobal=br(),this.nearFar=Xe(),this.inverseViewport=Xe(),this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.hasFillLights=!0,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE}}class Lot extends Fq{constructor(){super(...arguments),this.identifier=ys.ShadowMap,this.nearFar=Xe()}}class Not extends Fq{constructor(){super(...arguments),this.identifier=ys.Highlight,this.inverseViewport=Xe(),this.viewport=ni()}}class ZF extends Vi{bindPass(t){const i=this.program;g0e(i,t.viewTransform),v0(this.program,this.configuration,t.slicePlane),t.identifier===ys.Material&&(t.ssrParams!==void 0&&QH(this.program,t.ssrParams),i.setUniformMatrix3fv("transformNormalViewFromGlobal",t.transformNormalViewFromGlobal),t.subPass===Br.Depth&&i.setUniform2fv("nearFar",t.nearFar),t.subPass===Br.Color&&t.lighting.setUniforms(this.program,t.integratedMesh,t.hasFillLights)),t.identifier===ys.ShadowMap&&this.program.setUniform2fv("nearFar",t.nearFar)}bindMaterial(t,i){this._material=t;const r=this.program;r.setUniform4fv("baseColor",t.baseColor),r.setUniform1f("objectOpacity",t.objectOpacity),r.setUniform1f("textureAlphaCutoff",t.alphaCutoff),t.componentParameters.type===_p.Varying?t.componentParameters.texture.bind(r,"componentColorTex","componentColorTexInvDim"):(r.setUniform4fv("externalColor",t.componentParameters.externalColor),r.setUniform1i("externalColorMixMode",t.componentParameters.externalColorMixMode)),_(t.baseColorTexture)&&t.baseColorTexture.bind(r,"baseColorTexture","baseColorTextureSize"),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||(zfe(this.program,t,this.configuration.isSchematic),_(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(r,"texMetallicRoughness","texMetallicRoughnessSize"),_(t.emissionTexture)&&t.emissionTexture.bind(r,"texEmission","texEmissionSize"),_(t.occlusionTexture)&&t.occlusionTexture.bind(r,"texOcclusion","texOcclusionSize"),_(t.normalTexture)&&t.normalTexture.bind(r,"normalTexture","normalTextureSize")),t.isIntegratedMesh&&(i.identifier===ys.Material&&i.subPass===Br.Color?(r.bindTexture(t.overlayColor,"ovColorTex"),r.bindTexture(t.overlayNormal,"ovNormalTex")):i.identifier===ys.Highlight&&r.bindTexture(t.overlayHighlight,"ovColorTex"),r.setUniform1f("overlayOpacity",1)),i.identifier===ys.Highlight&&Pp(this.program,i),i.identifier===ys.Material&&i.subPass===Br.Color&&(i.ambientOcclusionEnabled&&i.bindAmbientOcclusion(r),i.shadowsEnabled&&i.bindShadowMap(r)),i.identifier!==ys.Material||i.subPass!==Br.Color&&i.subPass!==Br.Alpha||!i.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("nearFar",i.nearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),i.multipassTerrainParams.terrainLinearDepthTexture&&r.bindTexture(i.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(t){if(m0e(this.program,t),this.program.setUniformMatrix3fv("transformNormalGlobalFromModel",t.transformNormalGlobalFromModel),this.program.rebindTextures(),_(this._material)&&this._material.isIntegratedMesh){const i=this._material.overlayTexScale,r=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[t.toMapSpace[0]*i[0]+r[0],t.toMapSpace[1]*i[1]+r[1],t.toMapSpace[0]*i[2]+r[2],t.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[t.toMapSpace[2]*i[0],t.toMapSpace[3]*i[1],t.toMapSpace[2]*i[2],t.toMapSpace[3]*i[3]])}}initializeProgram(t){const i=ZF.shader.get(),r=this.configuration,s=i.build({multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,oitEnabled:r.transparencyPassType===at.Color,output:r.output,normalType:r.integratedMeshMode===ec.None?r.hasNormals?Or.CompressedAttribute:Or.ScreenDerivative:Or.Ground,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:t.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:r.integratedMeshMode===ec.ColorOverlayWithWater?xt.WaterOnIntegratedMesh:r.usePBR?r.isSchematic?xt.Schematic:xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:xF(t.rctx),overlayEnabled:r.integratedMeshMode===ec.ColorOverlay||r.integratedMeshMode===ec.ColorOverlayWithWater,ssrEnabled:r.ssrEnabled,highStepCount:!1,ellipsoidMode:r.ellipsoidMode});return new Oi(t.rctx,s,i.attributeLocations)}_setPipelineState(t){const i=this.configuration,r=i.integratedMeshMode!==ec.None,s=t===at.NONE,n=t===at.FrontFace;return Rt({blending:i.output!==j.Color&&i.output!==j.Alpha||!i.blendingEnabled?null:s?dl:km(t),culling:zN(i.cullFace),depthTest:{func:O0(t)},depthWrite:s||n?Aa:null,colorWrite:Ft,stencilWrite:r||i.sceneHasOcludees?vp:null,stencilTest:r?IXe(ba.IntegratedMeshMaskExcluded):i.sceneHasOcludees?P0:null,polygonOffset:s||n?i.polygonOffsetEnabled?{factor:2,units:2}:null:aF})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}ZF.shader=new Li($ot,()=>import("./ComponentShader.glsl.a7f6650e.js"));class l_e extends hYe{constructor(){super(...arguments),this.transformNormalGlobalFromModel=br(),this.toMapSpace=ni()}}var kie,ec;(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(kie||(kie={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(ec||(ec={}));class ir extends dr{constructor(){super(...arguments),this.output=j.Color,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=mn.None,this.componentData=_p.Uniform,this.slicePlaneEnabled=!1,this.cullFace=$i.Back,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=gu.None,this.doubleSidedMode=cr.WindingOrder,this.blendingEnabled=!0,this.alphaDiscardMode=Ai.Opaque,this.integratedMeshMode=ec.None,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=at.NONE,this.ellipsoidMode=op.Earth,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y({count:j.COUNT})],ir.prototype,"output",void 0),u([Y()],ir.prototype,"hasVertexColors",void 0),u([Y()],ir.prototype,"hasNormals",void 0),u([Y({count:mn.COUNT})],ir.prototype,"vertexTextureCoordinates",void 0),u([Y({count:_p.COUNT})],ir.prototype,"componentData",void 0),u([Y()],ir.prototype,"slicePlaneEnabled",void 0),u([Y({count:$i.COUNT})],ir.prototype,"cullFace",void 0),u([Y()],ir.prototype,"baseColorTexture",void 0),u([Y()],ir.prototype,"receiveAmbientOcclusion",void 0),u([Y()],ir.prototype,"receiveShadows",void 0),u([Y({count:gu.COUNT})],ir.prototype,"vertexDiscardMode",void 0),u([Y({count:cr.COUNT})],ir.prototype,"doubleSidedMode",void 0),u([Y()],ir.prototype,"blendingEnabled",void 0),u([Y({count:Ai.COUNT})],ir.prototype,"alphaDiscardMode",void 0),u([Y({count:ec.COUNT})],ir.prototype,"integratedMeshMode",void 0),u([Y()],ir.prototype,"ssrEnabled",void 0),u([Y()],ir.prototype,"polygonOffsetEnabled",void 0),u([Y()],ir.prototype,"usePBR",void 0),u([Y()],ir.prototype,"isSchematic",void 0),u([Y()],ir.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([Y()],ir.prototype,"hasEmissionTexture",void 0),u([Y()],ir.prototype,"hasOcclusionTexture",void 0),u([Y()],ir.prototype,"hasNormalTexture",void 0),u([Y()],ir.prototype,"sceneHasOcludees",void 0),u([Y({count:at.COUNT})],ir.prototype,"transparencyPassType",void 0),u([Y({count:op.COUNT})],ir.prototype,"ellipsoidMode",void 0),u([Y()],ir.prototype,"multipassTerrainEnabled",void 0),u([Y()],ir.prototype,"cullAboveGround",void 0);class Fot{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const t of this._parameterBlocks)this[t]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const t of this._parameterBlocks)if(this[t].dirty)return!0;return!1}}class Uq{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function Ni(e={}){return(t,i)=>{var r;const s=(r=t._parameterCount)!=null?r:0;if(t._parameterCount=s+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(o){const a=this[s];if(a==null)this[s]=o;else{if(n.equals(a,o))return;n.copy(a,o)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(n){this[s]!==n&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=n,this._setDirty())}})}}function zie(){return(e,t)=>{var i;const r=(i=e._parameterCount)!=null?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(s){this[r]!==s&&(this[r]=s,this._setDirty())}})}}class Pr extends Fot{constructor(){super(...arguments),this.baseColor=xa(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Ht(1,1,.5),this.emissiveFactor=Ht(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=yi(-1,-1,-1,-1),this.overlayTexScale=yi(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new ZI,this.componentParameters=new Gx,this.alphaCutoff=WD,this.alphaDiscardMode=Ai.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=op.Earth,this.sceneHasOcludees=!1,this._techniqueConfig=new ir}dispose(){this._technique=Wi(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}prepareTechnique(t,i,r){const s=this._techniqueConfig;if(s.hasVertexColors=r.colors,s.hasNormals=r.normals,s.vertexTextureCoordinates=r.textureCoordinates,s.usePBR=this.usePBR,s.hasMetalnessAndRoughnessTexture=_(this.metallicRoughnessTexture),s.hasEmissionTexture=_(this.emissionTexture),s.hasOcclusionTexture=_(this.occlusionTexture),s.hasNormalTexture=_(this.normalTexture),s.transparencyPassType=i.identifier===ys.Material&&i.transparencyPassType!=null?i.transparencyPassType:at.NONE,s.multipassTerrainEnabled=i.identifier===ys.Material&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.multipassTerrainEnabled,s.cullAboveGround=i.identifier===ys.Material&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,this.dirty){s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?cr.View:cr.None,s.baseColorTexture=_(this.baseColorTexture),s.isSchematic=this.hasParametersFromSource&&!_(this.baseColorTexture);const n=this._computeWhichMaterialPass();s.blendingEnabled=n===Io.Transparent||n===Io.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?ec.ColorOverlayWithWater:ec.ColorOverlay:ec.NoOverlay:ec.None,s.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return s.slicePlaneEnabled=i.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,i.identifier===ys.ShadowMap?(s.output=j.Shadow,s.vertexDiscardMode=gu.None):i.identifier===ys.Highlight?(s.output=j.Highlight,s.vertexDiscardMode=gu.None):(this._computeWhichMaterialPass()===Io.OpaqueAndTransparent?s.vertexDiscardMode=i.transparent?gu.Opaque:gu.Transparent:s.vertexDiscardMode=gu.None,s.output=Uot(i.subPass),i.subPass===Br.Alpha&&(s.sceneHasOcludees=i.sceneHasOcludees),i.subPass===Br.Color?(s.receiveAmbientOcclusion=i.ambientOcclusionEnabled,s.sceneHasOcludees=i.sceneHasOcludees,s.receiveShadows=i.shadowsEnabled,s.ssrEnabled=i.ssrParams.ssrEnabled):(s.receiveAmbientOcclusion=!1,s.receiveShadows=!1)),this._technique=t.releaseAndAcquire(ZF,s,this._technique),this._technique}submit(t,i){if(this.objectOpacity===0)return;const r=i.renderable.geometry,s=i.components,n=i.renderable.drawParameters,o=i.renderable.meta.cameraDepthSquared,a=s.geometryRanges,l=s.highlightRanges,c=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case Io.Opaque:t.materialOpaque.submitDraw(this,r,a,n,o);break;case Io.Transparent:t.materialTransparent.submitDraw(this,r,a,n,o);break;case Io.OpaqueAndTransparent:t.materialOpaque.submitDraw(this,r,a,n,o),t.materialTransparent.submitDraw(this,r,a,n,o);break;case Io.IntegratedMesh:t.materialIntegratedMesh.submitDraw(this,r,a,n,o),this.overlayHighlight&&t.highlightIntegratedMesh.submitDraw(this,r,a,n,o)}const h=this.componentParameters.castShadows!==is.None;h&&t.shadowMap.submitDraw(this,r,a,n,o),_(l)&&(t.highlight.submitDraw(this,r,l,n,o),h&&t.highlightShadowMap.submitDraw(this,r,l,n,o)),h&&_(c)&&t.defaultShadowMap.submitDraw(this,r,c,n,o)}get attributeLocations(){return a_e}_computeWhichMaterialPass(){return this.isIntegratedMesh?Io.IntegratedMesh:this.objectOpacity<1?Io.Transparent:this.componentParameters.opaqueOverride===is.All?Io.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===Ai.Blend||this.alphaDiscardMode===Ai.MaskBlend?Io.Transparent:this.componentParameters.transparent===is.None?Io.Opaque:this.componentParameters.transparent===is.All?Io.Transparent:Io.OpaqueAndTransparent}}var Bie,Io,is;u([Ni({vectorOps:_ne})],Pr.prototype,"baseColor",void 0),u([Ni()],Pr.prototype,"usePBR",void 0),u([Ni()],Pr.prototype,"hasParametersFromSource",void 0),u([Ni({vectorOps:EW})],Pr.prototype,"mrrFactors",void 0),u([Ni({vectorOps:EW})],Pr.prototype,"emissiveFactor",void 0),u([Ni({dispose:!0})],Pr.prototype,"baseColorTexture",void 0),u([Ni({dispose:!0})],Pr.prototype,"metallicRoughnessTexture",void 0),u([Ni({dispose:!0})],Pr.prototype,"emissionTexture",void 0),u([Ni({dispose:!0})],Pr.prototype,"occlusionTexture",void 0),u([Ni({dispose:!0})],Pr.prototype,"normalTexture",void 0),u([Ni({vectorOps:{equals:t1,copy:fa}})],Pr.prototype,"overlayTexOffset",void 0),u([Ni({vectorOps:{equals:t1,copy:fa}})],Pr.prototype,"overlayTexScale",void 0),u([Ni()],Pr.prototype,"overlayColor",void 0),u([Ni()],Pr.prototype,"overlayHighlight",void 0),u([Ni()],Pr.prototype,"overlayNormal",void 0),u([Ni()],Pr.prototype,"objectOpacity",void 0),u([zie()],Pr.prototype,"commonMaterialParameters",void 0),u([zie()],Pr.prototype,"componentParameters",void 0),u([Ni()],Pr.prototype,"alphaCutoff",void 0),u([Ni()],Pr.prototype,"alphaDiscardMode",void 0),u([Ni()],Pr.prototype,"isIntegratedMesh",void 0),u([Ni()],Pr.prototype,"polygonOffsetEnabled",void 0),u([Ni()],Pr.prototype,"ellipsoidMode",void 0),u([Ni()],Pr.prototype,"sceneHasOcludees",void 0),function(e){e[e.VERTEX=0]="VERTEX",e[e.GROUND=1]="GROUND",e[e.SCREEN_DERIVATIVE=2]="SCREEN_DERIVATIVE"}(Bie||(Bie={})),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(Io||(Io={}));class ZI extends Uq{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=$i.Back,this.slicePlaneEnabled=!0}}u([Ni()],ZI.prototype,"doubleSided",void 0),u([Ni()],ZI.prototype,"cullFace",void 0),u([Ni()],ZI.prototype,"slicePlaneEnabled",void 0);class Gx extends Uq{constructor(){super(...arguments),this.externalColor=xa(1,1,1,1),this.externalColorMixMode=vs.Multiply,this.castShadows=is.All}get transparent(){return this.externalColor[3]<1?is.All:is.None}get opaqueOverride(){return this.externalColorMixMode===vs.Replace&&this.externalColor[3]===1?is.All:is.None}get visible(){return this.externalColor[3]>0?is.All:is.None}get type(){return _p.Uniform}}u([Ni({vectorOps:_ne})],Gx.prototype,"externalColor",void 0),u([Ni()],Gx.prototype,"externalColorMixMode",void 0),u([Ni()],Gx.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(is||(is={}));class QE extends Uq{constructor(){super(...arguments),this.texture=null,this.transparent=is.None,this.opaqueOverride=is.None,this.castShadows=is.None}get type(){return _p.Varying}}function Uot(e){switch(e){case Br.Color:return j.Color;case Br.Alpha:return j.Alpha;case Br.Depth:return j.Depth;case Br.Normal:return j.Normal}}u([Ni()],QE.prototype,"texture",void 0),u([Ni()],QE.prototype,"transparent",void 0),u([Ni()],QE.prototype,"opaqueOverride",void 0),u([Ni()],QE.prototype,"castShadows",void 0);class QF{constructor(t){this._low=fi(),this._high=fi(),t&&this.set(t)}get low(){return this._low}get high(){return this._high}set(t){const i=this._low,r=this._high;ne(i,t),lp(r,t,i)}setElements(t,i,r){oe(Vie,t,i,r),this.set(Vie)}get(t){return pe(t,this._low,this._high)}getLowScaled(t){return ae(t,this._low,1)}}const Vie=M();class kot{constructor(t){this.maxCount=t,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(t){this.recycledIndices.push(t)}}class zot{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.textureWidth=4096,this.dirty=!0,this.texture=new Ze(this.rctx,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this.data=new Ca(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(t,i,r,s,n,o){const a=t*this.fieldCount+i;this.dirty=!0,this.data.set(a,0,r),this.data.set(a,1,s),this.data.set(a,2,n),this.data.set(a,3,o)}setDataElement(t,i,r,s){const n=t*this.fieldCount+i;this.dirty=!0,this.data.set(n,r,s)}resizeToFit(t){const i=t*this.fieldCount;if(i>=this.data.count){const r=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new Ca(new ArrayBuffer(4*r));s.typedBuffer.set(this.data.typedBuffer),this.data=s}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width,i=this.texture.descriptor.height;this.data.count>t*i&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(t,i,r){t.bindTexture(this.texture,i),t.setUniform2f(r,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}const c_e=65536;class Bot{constructor(t,i=1){this.textureBuffer=new zot(t,i),this.indexManager=new kot(c_e)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const t=this.indexManager.acquire();return this.textureBuffer.resizeToFit(t),t}releaseIndex(t){this.indexManager.release(t)}}class u_e{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter(t=>t.activeCount!==0||(t.dispose(),!1))}destroy(){this.buffers.forEach(t=>t.dispose()),this.buffers=[]}getBuffer(t){for(const r of this.buffers)if(r.availableCount>=t)return r;if(t>c_e)return null;const i=new Bot(this.rctx,this.fieldCount);return this.buffers.push(i),i}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture()}}const Gie=he.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class Vot{constructor(t){this._renderManager=t,this._objects=[new $t,new $t],this._renderSubmit=new Cot(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new u_e(t.rctx)}dispose(){ot(this._objects[Vx.Hidden].length===0&&this._objects[Vx.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(t){const i=new w9;return i.toMapSpace=t.toMapSpace.slice(),i.transform=t.transform,i.obb=sot(t.obb),i.components=new lot(this._componentBufferManager,t.geometry.componentOffsets),i.renderable=this._createRenderable(t,i.components),i.intersectionGeometry=new got(t.geometry.positionData,i.components),this._objects[i.visible].push(i),i}destroyObject(t){const i=t;this._objects[i.visible].removeUnordered(i),i.dispose(),this._notifyDirty()}setObjectVisibility(t,i){const r=t;i!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[i].push(r),r.visible=i,this._notifyDirty())}preSubmit(t){const i=t.camera.eye;this.visibleObjects.forAll(r=>{const s=ko(i,r.obb.center);r.renderable.meta.cameraDepthSquared=s})}getMaterial(t){return t.renderable.material}updateMaterial(t,i){const r=t.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(t,i){const r=t;r.components.visibility.reset(i),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(t,i){return t.components.visibility.forEachComponent(i)}getComponentCount(t){const i=t,r=i.components.visibility.componentCount();return{visible:r,invisible:i.components.count-r}}setComponentData(t,i){const r=t,s=r.renderable.material;if(uot(i)){const n=r.components,o=n.materialDataBuffer,a=n.materialDataIndices,l={castShadows:!0,pickable:!0,externalColor:wq(),externalColorMixMode:vs.Multiply},c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,g=0,y=0,v=!1,b=0;for(let w=0;w<n.count;w++)i(w,l),f+=+(l.externalColor[3]<1),g+=+(l.externalColorMixMode===vs.Replace&&l.externalColor[3]===1),y+=+l.castShadows,h0e(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[w],0,h[0],h[1],h[2],h[3]),v=v||w>0&&b!==p[0],b=p[0],l.pickable!==r_e(n.pickability,w)&&(n.pickability=hot(n.pickability,n.count,w,l.pickable));v?(s.componentParameters=new QE,s.componentParameters.castShadows=Ck(y,n.count),s.componentParameters.transparent=Ck(f,n.count),s.componentParameters.opaqueOverride=Ck(g,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new Gx,s.componentParameters.castShadows=l.castShadows?is.All:is.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode)}else s.componentParameters=new Gx,s.componentParameters.castShadows=i.castShadows?is.All:is.None,s.componentParameters.externalColor=i.externalColor,s.componentParameters.externalColorMixMode=i.externalColorMixMode;this._notifyDirty()}getComponentAabb(t,i,r){return t.intersectionGeometry.getComponentAabb(i,r)}getComponentObb(t){return t.obb}getObjectTransform(t){return t.transform}getComponentPositions(t,i,r){return t.intersectionGeometry.getComponentPositions(i,r)}intersect(t,i,r,s,n,o){const a=t;_(n)&&(n.localOrigin=a.transform.position);const l=w1(jie,a.transform.rotationScale);lp(QP,i,a.transform.position),lp(JP,r,a.transform.position),rl(QP,QP,l),rl(JP,JP,l);const c=Au(jie,l);return a.intersectionGeometry.intersect(QP,JP,s,c,n,o)}addEdges(t,i,r,s){const n=t,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return i.addComponentObject(t,n.transform,{center:n.obb.center,radius:not(n.obb)},a,o,l,r,s)}addComponentHighlight(t,i){const r=t.components;O(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[i]++===0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(t,i){const r=t.components;if(O(r.highlightCounts))return void Gie.warn("Removing non-existing highlight.");const s=r.highlightCounts[i],n=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[i]=s-1,void(r.highlightCounts[r.count]=n-1);r.highlightCounts[i]=0,r.highlightsDirty(),this._notifyDirty(),n===1?r.highlightCounts=null:r.highlightCounts[r.count]=n-1}else Gie.warn("Removing non-existing highlight.")}clearHighlights(t){const i=t.components;_(i.highlightCounts)&&(i.highlightCounts=null,i.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(t){return t.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[Vx.Visible]}_createRenderable(t,i){const r=this._renderManager.rctx,s=t.geometry,n=s.vertices.layoutParameters,o=jt.createVertex(r,ri.STATIC_DRAW,s.vertices.data),a=oo(s.indices,S=>jt.createIndex(r,ri.STATIC_DRAW,S)),l=wl(Rot(n)),c=new Uint16Array(s.vertices.count);for(let S=0;S<i.count;S++){const T=i.offsets[S],A=i.offsets[S+1],C=i.materialDataIndices[S];if(_(s.indices))for(let R=T;R<A;R++)c[s.indices[R]]=C;else for(let R=T;R<A;R++)c[R]=C}const h=jt.createVertex(r,ri.STATIC_DRAW,c.buffer),p=new QF(t.transform.position),f=Ove(t.transform.rotationScale);w1(f,f),Au(f,f);const g=new l_e;ne(g.transformWorldFromModelTL,p.low),ne(g.transformWorldFromModelTH,p.high),RC(g.transformWorldFromModelRS,t.transform.rotationScale),RC(g.transformNormalGlobalFromModel,f),fa(g.toMapSpace,t.toMapSpace);const y=new Pr,v=new as(r,y.attributeLocations,{data:l,componentIndices:Got},{data:o,componentIndices:h},a),b=new n_e(v,Tt.TRIANGLES,n,_(a)),w={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(_(a)?a.byteSize:0)};return new _ot(y,g,b,w)}_notifyDirty(){this._renderManager.notifyDirty()}}const Got=wl(Nr().u16(E.COMPONENTINDEX));function Ck(e,t){return e===t?is.All:e===0?is.None:is.Some}const jie=om(),QP=M(),JP=M();class jot{constructor(t,i){this._rctx=t,this._techniqueRepository=i}dispose(){this._vao=et(this._vao)}compositeTransparent(t,i,r,s=1){const n=this._rctx;Kp.alphaMode=Ln.Alpha,Kp.function=ya.Transparency,Kp.hasOpacityFactor=s!==1;const o=this._techniqueRepository.acquire(JC,Kp),a=n.useTechnique(o);a.bindTexture(t,"colorTexture"),a.bindTexture(i,"alphaTexture"),a.bindTexture(r,"frontFaceTexture");const l=this._ensureVAO();n.bindVAO(l),n.drawArrays(Tt.TRIANGLE_STRIP,0,fn(l,"geometry")),o.release()}composite(t,i=Ln.None,r=1,s=ya.Standard,n=Jr.INNER){const o=this._rctx;Kp.alphaMode=i,Kp.function=s,Kp.hasOpacityFactor=r!==1;const a=this._techniqueRepository.acquire(JC,Kp),l=o.useTechnique(a);l.bindTexture(t,"tex"),Kp.hasOpacityFactor&&l.setUniform1f("opacity",r),s===ya.OverlayWithTransparency&&l.setUniform1i("overlayIdx",n);const c=this._ensureVAO();o.bindVAO(c),o.drawArrays(Tt.TRIANGLE_STRIP,0,fn(c,"geometry")),a.release()}_ensureVAO(){return O(this._vao)&&(this._vao=fo(this._rctx)),this._vao}}const Kp=new DI,Hot=1e4,T9=100,qot=500,Wot=500,Xot=.1;function Yot(e,t,i){return IH(t,e)*(i[1]-i[0])+i[0]}function Zot(e,t,i){if(t.size<Hot)return sat.compute(e,t);const r=uO();return i.forAll(s=>{s.isVisible&&XT(r,Qot(e,s))}),r}function Qot(e,t){if(!t.isVisible)return;const i=uO(),r=t.getSpatialQueryAccelerator();return _(r)?Jot(i,e,r):Kot(i,e,t.objects),i}function Jot(e,t,i){const r=t.eye,s=t.viewForward,n=t.frustum,o=l=>l.isVisible,a=i.objectCount;if(a<qot)uR(ru,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,rc.FRONT_TO_BACK,ru,(l,c)=>{S9(e,t,l),ru.far=e.near,c.setRange(ru)},n,o),uR(ru,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,rc.BACK_TO_FRONT,ru,(l,c)=>{S9(e,t,l),ru.near=e.far,c.setRange(ru)},n,o);else{const l=Math.max(Math.min(a,Wot),Math.ceil(a*Xot)),c=i.findClosest(s,rc.FRONT_TO_BACK,n,o,l),h=i.findClosest(s,rc.BACK_TO_FRONT,n,o,l);c&&h&&(Hie(e,t,c.boundingVolumeWorldSpace.bounds),Hie(e,t,h.boundingVolumeWorldSpace.bounds))}}function Kot(e,t,i){Xb.clear(),i.forAll(r=>{r.isVisible&&r.geometryRecords.length!==0&&Xb.add(r)}),Xb.empty||(Xb.sort(t),uR(ru,t.near,Math.min(e.near,t.far)),Xb.forEachInDepthRange(ru,rc.FRONT_TO_BACK,(r,s)=>{s<e.near&&S9(e,t,r)}),uR(ru,Math.max(e.far,t.near),t.far),Xb.forEachInDepthRange(ru,rc.BACK_TO_FRONT,(r,s,n)=>{e.far=Math.max(e.far,n)}))}function S9(e,t,i){if(!i.isVisible||!Ny(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=rat;i.geometryRecords.forEach(n=>{ur(s,r,n.getShaderTransformation());const o=r1(s);h_e(e,t,n.geometry.boundingInfo,s,o)})}function h_e(e,t,i,r,s){if(O(i))return;const n=t.eye,o=t.viewForward;Ue(In,i.center,r);const a=o[0]*(In[0]-n[0])+o[1]*(In[1]-n[1])+o[2]*(In[2]-n[2]);if(In[3]=i.radius*s,!(a-In[3]>e.near&&a+In[3]<e.far)&&Ny(t.frustum,In))if(i.radius>T9&&i.getChildren()){const l=i.getChildren();for(let c=0;c<8;++c)l[c]&&h_e(e,t,l[c],r,s)}else E9.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function Hie(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}class eat{constructor(){this._items=new $t({allocator:t=>t||{obj:null,distance:0,near:0,far:0},deallocator:t=>(t.obj=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(t){this._items.pushNew().obj=t}sort(t){const i=t.eye,r=t.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-i[0])*r[0]+(n[1]-i[1])*r[1]+(n[2]-i[2])*r[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(t,i,r){if(i===rc.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}}}class tat{constructor(){this.view=Te(),this.viewProj=Te(),this.frustum=GC(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(t,i){this._reset(),Lr(this.view,t.viewMatrix),ur(this.viewProj,t.projectionMatrix,this.view),$D(this.frustum,t.frustum);const r=this.view,s=r[2],n=r[6],o=r[10],a=r[14],l=this.range;let c=0;if(i.forEach(g=>{if(!g.instanceParameters.visible||!g.castShadow)return;let y;g.hasShaderTransformation?(g.computeBoundingSphere(g.getShaderTransformation(),In,1),y=In):y=g.boundingSphere;const v=s*y[0]+n*y[1]+o*y[2]+a,b=v-y[3],w=v+y[3];this.geometries[c]=g,this.near[c]=-w,this.far[c]=-b,++c}),this.geometries.length===0)return l;for(let g=0;g<this.geometries.length;++g)this.near[g]>l.far&&(l.far=this.near[g]),this.near[g]>2&&this.far[g]<l.near&&(l.near=this.far[g]);const h=this.looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let p=0,f=0;for(let g=0;g<this.geometries.length;++g)this.near[g]<l.near&&(this.near[g]>=h.near?l.near=this.near[g]:this.nearCandidates[p++]=g),this.far[g]>l.far&&(this.far[g]<=h.far?l.far=this.far[g]:this.farCandidates[f++]=g);if(this.nearCandidates.length===0&&this.farCandidates.length===0)return l;this.nearCandidates.sort((g,y)=>this.near[g]<this.near[y]?-1:this.near[g]>this.near[y]?1:0),this.farCandidates.sort((g,y)=>this.far[g]<this.far[y]?1:this.far[g]>this.far[y]?-1:0);for(let g=0;g<this.nearCandidates.length;++g){const y=this.nearCandidates[g];if(this.near[y]<l.near){const v=this.geometries[y],b=v.boundingInfo;this._includeNearBoundingInfoRec(b,v.getShaderTransformation())}}for(let g=0;g<this.farCandidates.length;++g){const y=this.farCandidates[g];if(this.far[y]>l.far){const v=this.geometries[y],b=v.boundingInfo;this._includeFarBoundingInfoRec(b,v.getShaderTransformation())}}return l}_reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}_includeNearBoundingInfoRec(t,i){if(O(t))return;const r=t.getCenter();Ue(In,r,i);const s=r1(i),n=In[0],o=In[1],a=In[2],l=t.getBSRadius()*s,c=this.frustum;if(c[0][0]*n+c[0][1]*o+c[0][2]*a+c[0][3]>l||c[1][0]*n+c[1][1]*o+c[1][2]*a+c[1][3]>l||c[2][0]*n+c[2][1]*o+c[2][2]*a+c[2][3]>l||c[3][0]*n+c[3][1]*o+c[3][2]*a+c[3][3]>l)return;const h=this.view[2]*n+this.view[6]*o+this.view[10]*a+this.view[14],p=h+l;if(!(-(h-l)<2||-p>=this.range.near))if(-p>this.looseRange.near)this.range.near=-p;else{if(l>T9){const f=t.getChildren();if(f!==void 0){for(let g=0;g<8;++g)f[g]!==void 0&&this._includeNearBoundingInfoRec(f[g],i);return}}E9.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}_includeFarBoundingInfoRec(t,i){if(O(t))return;let r=t.getBSRadius();const s=t.getCenter();Ue(In,s,i);const n=r1(i),o=In[0],a=In[1],l=In[2];r*=n;const c=this.frustum;if(c[0][0]*o+c[0][1]*a+c[0][2]*l+c[0][3]>r||c[1][0]*o+c[1][1]*a+c[1][2]*l+c[1][3]>r||c[2][0]*o+c[2][1]*a+c[2][2]*l+c[2][3]>r||c[3][0]*o+c[3][1]*a+c[3][2]*l+c[3][3]>r)return;const h=this.view[2]*o+this.view[6]*a+this.view[10]*l+this.view[14]-r;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(r>T9){const p=t.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&this._includeFarBoundingInfoRec(p[f],i);return}}E9.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}}class iat{constructor(){this.modelViewProj=Te(),this.clipPosition=[ni(),ni(),ni(),ni(),ni(),ni(),ni(),ni()]}unionDepthRangeWithAABB(t,i,r,s,n){const o=this.modelViewProj;ur(o,i,r);let a=!1;for(let l=0;l<8;++l){const c=this.clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this.clipPosition[Rk[l][0]],h=this.clipPosition[Rk[l][1]],p=this.clipPosition[Rk[l][2]],f=this._clipTriangle(c,h,p);let g=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){g=!1;break}if(!g){a=!0;for(let y=0;y<f.length;++y){const v=f[y][3];v<t.near&&(t.near=v),v>t.far&&(t.far=v)}}}return a}_inside(t,i){return i===0?t[0]>=-t[3]:i===1?t[1]>=-t[3]:i===2?t[0]<=t[3]:i===3?t[1]<=t[3]:void ot(!1)}_intersect(t,i,r){let s=0;return r===0?s=(-t[3]-t[0])/(i[0]-t[0]+i[3]-t[3]):r===1?s=(-t[3]-t[1])/(i[1]-t[1]+i[3]-t[3]):r===2?s=(t[3]-t[0])/(i[0]-t[0]-i[3]+t[3]):r===3&&(s=(t[3]-t[1])/(i[1]-t[1]-i[3]+t[3])),eG(ni(),t,i,s)}_clipTriangle(t,i,r){let s=[t,i,r];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}}const Rk=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],In=vn(),rat=Te(),ru=uO(),Xb=new eat,sat=new tat,E9=new iat;function nat(){const e=new Ri;return e.attributes.add(E.POSITION,"vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(x`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(x`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}async function oat(e){const t=import("./mask-svg.318fc328.js"),i=import("./overlay-svg.5292dcb7.js"),r=Cu((await t).default,{signal:e}),s=Cu((await i).default,{signal:e}),n={mask:await r,overlay:await s};return Jt(e),n}let jw=class extends we{constructor(){super(...arguments),this._handles=new Bt,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new wr,this.attributeLocations=new Map([[E.POSITION,0]]),this.tmpScreenPoint=Cr(),this.tmpRenderPoint=aSe()}get updating(){return O(this._imageSources)&&_(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};_(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return _(this._validMagnifier)}get _validMagnifier(){return _(this._magnifier)&&this._magnifier.visible&&_(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return _(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),_(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(O(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),O(this._resources))return;const n=this._resources.program;e.useProgram(n);const o=this._resources.textures,a=Math.ceil(1/this.factor*s);o.input.resize(a,a);const l=t.camera.fullWidth,c=t.camera.fullHeight;zf(i.position,this.tmpScreenPoint);const h=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),p=.5*a,f=.5*a;h[0]=ze(h[0],p,l-p-1),h[1]=ze(h[1],f,c-f-1);const g=Math.floor(h[0]-p),y=Math.floor(h[1]-f);n.bindTexture(o.input,"textureInput"),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,g,y,a,a,0);const v=i.offset.x*r,b=i.offset.y*r,w=(h[0]+v)/l*2-1,S=(h[1]-b)/c*2-1,T=s/l*2,A=s/c*2;e.bindVAO(this._resources.vao),n.bindTexture(o.overlay,"textureOverlay"),n.bindTexture(o.mask,"textureMask"),n.setUniform4f("drawPosition",w,S,T,A),n.setUniform1b("maskEnabled",i.maskEnabled),n.setUniform1b("overlayEnabled",i.overlayEnabled),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Tt.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(O(e))return;const t=e.maskUrl,i=e.overlayUrl;!_(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),_(this._imageSources)||_(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:yR(async r=>{const s=O(t)||O(i)?oat(r):null,n=_(t)?Cu(t,{signal:r}):s.then(a=>a.mask),o=_(i)?Cu(i,{signal:r}):s.then(a=>a.overlay);this._imageSources={mask:await n,overlay:await o},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(_(this._resources)){if(this._resources.textures.size!==t){const r=this._createTextureResources(e,t);if(O(r))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=r}return}const i=this._createTextureResources(e,t);O(i)||(this._resources={textures:i,program:this._createProgram(e),vao:fo(e,Lj,this.attributeLocations,0,1),pipelineState:Rt({blending:gc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Ft})})}_disposeResources(){O(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(O(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!0,preMultiplyAlpha:!FG(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.ALPHA,internalFormat:Ie.ALPHA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!0},this._imageSources.mask);return{input:new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR,flipped:!1}),mask:r,overlay:i,size:t}}_createProgram(e){const t=nat();return new Oi(e,t,this.attributeLocations)}};u([d()],jw.prototype,"_imageSources",void 0),u([d()],jw.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],jw.prototype,"updating",null),jw=u([P("esri/views/3d/webgl-engine/lib/MagnifierHelper")],jw);const aat=.5,lat=1e3/30;var hR;(function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"})(hR||(hR={}));class vg{constructor(t,i,r=hR.FrontToBack){this._rctx=t,this._techniqueRepository=i,this._sorting=r,this._draws=new $t({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(t,i,r,s,n){const o=this._draws.pushNew();o.geometry=i,o.geometryRanges=r,o.material=t,o.bindDrawParams=s,o.depthSquaredHint=n,o.indexType=i.indexed?i.vao.indexBuffer.indexType:0}dispatch(t){const i=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let r=null;const s=this._draws.map(o=>o.material.prepareTechnique(this._techniqueRepository,t,o.geometry.parameters)),n=this._draws.length;for(let o=0;o<n;o++){const a=s[o];a===r&&a.configuration.transparencyPassType===at.NONE||(i.useTechnique(a,t.slot),r=a),this._passBoundTechniques.has(a)||(a.bindPass(t),this._passBoundTechniques.add(a));const l=this._draws.data[o],c=l.geometry;i.bindVAO(c.vao),this._previouslyBoundMaterials.get(a)!==l.material&&(a.bindMaterial(l.material,t),this._previouslyBoundMaterials.set(a,l.material)),this._previouslyBoundDraw.get(a)!==l.bindDrawParams&&(a.bindDraw(l.bindDrawParams),this._previouslyBoundDraw.set(a,l.bindDrawParams));const h=l.geometryRanges,p=h.length;if(l.indexType!==0){const f=QI.get(l.indexType);for(let g=0;g<p;g+=2){const y=h[g],v=h[g+1];i.drawElements(c.primitiveType,v,l.indexType,y*f)}}else for(let f=0;f<p;f+=2){const g=h[f],y=h[f+1];i.drawArrays(c.primitiveType,g,y)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=this._sorting===hR.FrontToBack?1:-1;this._draws.sort((i,r)=>{const s=t*(i.depthSquaredHint-r.depthSquaredHint);return s!==0?s:i.geometry.vao.size-r.geometry.vao.size})}get count(){return this._draws.length}}const QI=new Map;QI.set(nt.UNSIGNED_BYTE,1),QI.set(nt.UNSIGNED_SHORT,2),QI.set(nt.UNSIGNED_INT,4);class cat{constructor(t,i){this.rctx=t,this.shaderTechniqueRepository=i,this.canRender=!0,this._materialPassParams=new Dot,this._shadowPassParams=new Lot,this._highlightPassParams=new Not,this._systems=new Set,this._passes={materialOpaque:new vg(t,this.shaderTechniqueRepository),materialTransparent:new vg(t,this.shaderTechniqueRepository,hR.BackToFront),materialIntegratedMesh:new vg(t,this.shaderTechniqueRepository),shadowMap:new vg(t,this.shaderTechniqueRepository),highlight:new vg(t,this.shaderTechniqueRepository),highlightIntegratedMesh:new vg(t,this.shaderTechniqueRepository),highlightShadowMap:new vg(t,this.shaderTechniqueRepository),defaultShadowMap:new vg(t,this.shaderTechniqueRepository)}}register(t){this._systems.add(t)}prepareRender(t){if(this._systems.size!==0){for(const i of Object.values(this._passes))i.prepareSubmit();this._systems.forEach(i=>i.submit(this._passes,{camera:t}));for(const i of Object.values(this._passes))i.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(t){if(this._systems.size!==0)switch(this._configure(t),t.slot){case ye.OPAQUE_PLUGIN:switch(t.pass){case De.MATERIAL:return this._materialPassParams.subPass=Br.Color,this._configureMaterialColorPass(t),this._passes.materialOpaque.dispatch(this._materialPassParams);case De.MATERIAL_DEPTH:return this._materialPassParams.subPass=Br.Depth,this._passes.materialOpaque.dispatch(this._materialPassParams);case De.MATERIAL_NORMAL:return this._materialPassParams.subPass=Br.Normal,this._passes.materialOpaque.dispatch(this._materialPassParams);case De.MATERIAL_HIGHLIGHT:return this._passes.highlight.dispatch(this._highlightPassParams);case De.MATERIAL_DEPTH_SHADOWMAP_ALL:return this._passes.shadowMap.dispatch(this._shadowPassParams);case De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return;case ye.TRANSPARENT_PLUGIN:switch(t.pass){case De.MATERIAL:return this._materialPassParams.subPass=Br.Color,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case De.MATERIAL_ALPHA:return this._materialPassParams.subPass=Br.Alpha,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case De.MATERIAL_DEPTH:return this._materialPassParams.subPass=Br.Depth,this._passes.materialTransparent.dispatch(this._materialPassParams);case De.MATERIAL_NORMAL:return this._materialPassParams.subPass=Br.Normal,this._passes.materialTransparent.dispatch(this._materialPassParams)}return;case ye.INTEGRATED_MESH:switch(t.pass){case De.MATERIAL:return this._materialPassParams.subPass=Br.Color,this._configureMaterialColorPass(t),this._materialPassParams.ssrParams=t.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case De.MATERIAL_DEPTH:return this._materialPassParams.subPass=Br.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case De.MATERIAL_NORMAL:return this._materialPassParams.subPass=Br.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case De.MATERIAL_HIGHLIGHT:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return}}notifyDirty(){this._context.requestRender()}slots(){return[ye.OPAQUE_PLUGIN,ye.TRANSPARENT_PLUGIN,ye.INTEGRATED_MESH]}initializeRenderContext(t){this._context=t}uninitializeRenderContext(){}queryDepthRange(t){const i={near:1/0,far:-1/0};return this._systems.forEach(r=>{const s=r.queryShadowCasterDepthRange(t);_(s)&&XT(i,s,i)}),i}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(t){this._materialPassParams.shadowsEnabled=t}get fillLightsEnabled(){return this._materialPassParams.hasFillLights}set fillLightsEnabled(t){this._materialPassParams.hasFillLights=t}get screenSpaceReflectionsEnabled(){return _(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(t){this._materialPassParams.ssrParams.ssrEnabled=!!t}_configureMaterialColorPass(t){this._materialPassParams.bindShadowMap=i=>{t.shadowMap.bind(i);const r=this._materialPassParams.viewTransform;pe(D2,r.transformWorldFromViewTL,r.transformWorldFromViewTH),t.shadowMap.bindView(i,D2)},this._materialPassParams.bindAmbientOcclusion=i=>t.ssaoHelper.bind(i,t.camera),this._materialPassParams.ambientOcclusionEnabled=!!t.ssaoHelper&&t.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=t.hasOccludees}_configure(t){const i=t.pass===De.MATERIAL_DEPTH_SHADOWMAP_ALL||t.pass===De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||t.pass===De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT?this._shadowPassParams:t.pass===De.MATERIAL_HIGHLIGHT?this._highlightPassParams:this._materialPassParams;this._updateParameters(t,i)}_updateParameters(t,i){const r=t.camera,s=r.viewInverseTransposeMatrix;oe(D2,s[3],s[7],s[11]),Ok.set(D2),ne(i.viewTransform.transformWorldFromViewTH,Ok.high),ne(i.viewTransform.transformWorldFromViewTL,Ok.low),Eu(i.viewTransform.transformViewFromCameraRelativeRS,r.viewMatrix),Lr(i.viewTransform.transformProjFromView,r.projectionMatrix),i.identifier===ys.Material?(this._materialPassParams.transparent=t.slot===ye.TRANSPARENT_PLUGIN,this._materialPassParams.integratedMesh=t.slot===ye.INTEGRATED_MESH,this._materialPassParams.lighting=t.scenelightingData,Au(qie,i.viewTransform.transformViewFromCameraRelativeRS),w1(i.transformNormalViewFromGlobal,qie),Fs(i.nearFar,r.nearFar)):i.identifier===ys.ShadowMap?Fs(i.nearFar,r.nearFar):i.identifier===ys.Highlight&&(i.highlightDepthTexture=t.highlightDepthTexture,fa(i.viewport,r.fullViewport)),i.identifier!==ys.Material&&i.identifier!==ys.Highlight||(i.inverseViewport[0]=1/r.fullViewport[2],i.inverseViewport[1]=1/r.fullViewport[3]),Yle(t.sliceHelper.plane,i.slicePlane),de(i.slicePlane.origin,i.slicePlane.origin,D2),i.slicePlaneEnabled=t.sliceHelper.isEnabled,this._materialPassParams.slot=t.slot,this._materialPassParams.transparencyPassType=t.transparencyPassType,this._materialPassParams.multipassTerrainParams=t.multipassTerrainParams}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}}const D2=M(),qie=br(),Ok=new QF;var il;function uat(e){const t=new Ri,i=t.vertex.code,r=t.fragment.code;return t.attributes.add(E.POSITION,"vec2"),e.highlightStage===il.Downsample&&(i.add(x`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(x`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),e.highlightStage===il.Blur&&(t.attributes.add(E.UV0,"vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(x`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?x`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:x`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),r.add(x`
    void main() {
      ${e.gridOptimization?x`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:x`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),e.highlightStage===il.Apply&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(x`
      void main() {
        ${e.gridOptimization?x`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("uColor","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),r.add(x`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`)),t}(function(e){e[e.Blur=0]="Blur",e[e.Apply=1]="Apply",e[e.Downsample=2]="Downsample",e[e.COUNT=3]="COUNT"})(il||(il={}));const hat=Object.freeze({__proto__:null,get HighlightCompositionPass(){return il},build:uat}),dat=8.6,pat=.4;class by extends Vi{initializeProgram(t){const i=by.shader.get().build(this.configuration);return new Oi(t.rctx,i,mi)}bindApplyPass(t){this.program.setUniform4fv("uColor",t.color),this.program.setUniform4fv("haloColor",t.haloColor),this.program.setUniform1f("outlineSize",dat),this.program.setUniform1f("blurSize",pat),this.program.setUniform4f("opacities",t.haloOpacity,t.haloOpacityOccluded,t.fillOpacity,t.fillOpacityOccluded)}initializePipeline(){return this.configuration.highlightStage===il.Apply?Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft}):Rt({colorWrite:Ft})}get primitiveType(){return this.configuration.gridOptimization?Tt.TRIANGLES:Tt.TRIANGLE_STRIP}}by.shader=new Li(hat,()=>import("./HighlightComposition.glsl.6b67ec74.js"));class A9 extends dr{constructor(){super(...arguments),this.highlightStage=il.Blur,this.gridOptimization=!1}}u([Y({count:il.COUNT})],A9.prototype,"highlightStage",void 0),u([Y()],A9.prototype,"gridOptimization",void 0);const fat=32;class mat{constructor(t,i){this._techniqueRep=t,this._rctx=i,this.viewportToRestore=ni(),this.defaultOptions={color:xa(1,0,1,1),haloColor:xa(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:xa(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this.quadVAO)return;this.quadVAO=fo(this._rctx);const t={colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},i={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:0,height:0};this.blur0Fbo=new ki(this._rctx,t,i),this.blur1Fbo=new ki(this._rctx,t,i);const r=new A9;r.highlightStage=il.Blur,r.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(by,r),r.highlightStage=il.Blur,r.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(by,r),r.highlightStage=il.Apply,r.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(by,r),r.highlightStage=il.Apply,r.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(by,r),r.highlightStage=il.Downsample,r.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(by,r)}dispose(){if(this._grid.coverageMipmap)for(let t=1;t<this._grid.coverageMipmap.length;t++)this._grid.coverageMipmap[t].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=et(this.blur0Fbo),this.blur1Fbo=et(this.blur1Fbo)}get profilingCallback(){return hi.HIGHLIGHTS_PROFILE_TO_CONSOLE?t=>console.log(t):null}setDefaultOptions(t){this.defaultOptions=t}render(t,i,r){const s=t.pixelRatio,n=hi.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,o=this._rctx;this._assertResources(),fa(this.viewportToRestore,t.fullViewport);const a=t.fullWidth,l=t.fullHeight,c=Math.ceil(a/s),h=Math.ceil(l/s);this.blur0Fbo.resize(c,h),this.blur1Fbo.resize(c,h),o.bindVAO(this.quadVAO);let p=null;const f=n?this.blurGridTechnique:this.blurTechnique,g=o.useTechnique(f);n?(this._gridUpdateResources(i,fat),this._gridComputeMipmap(),p=this._grid.vao,g.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):p=this.quadVAO,o.bindVAO(p),o.bindFramebuffer(this.blur0Fbo),o.setViewport(0,0,c,h),o.setClearColor(0,0,0,0),o.clear(bi.COLOR_BUFFER_BIT),g.bindTexture(i.colorTexture,"tex"),g.setUniform2f("blurSize",1/c,0),o.drawArrays(f.primitiveType,0,fn(p,"geometry")),o.bindFramebuffer(this.blur1Fbo),o.clear(bi.COLOR_BUFFER_BIT),g.bindTexture(this.blur0Fbo.colorTexture,"tex"),g.setUniform2f("blurSize",0,1/h),o.drawArrays(f.primitiveType,0,fn(p,"geometry")),o.bindFramebuffer(r),o.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);const y=n?this.applyGridTechnique:this.applyTechnique,v=o.useTechnique(y);if(v.bindTexture(this.blur1Fbo.colorTexture,"tex"),v.bindTexture(i.colorTexture,"origin"),n){const b=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;v.bindTexture(b,"coverageTex")}y.bindApplyPass(this.defaultOptions),o.drawArrays(y.primitiveType,0,fn(p,"geometry")),o.bindVAO(null)}_gridUpdateResources(t,i){const r=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[t],n=!0),s.viewportWidth===t.width&&s.viewportHeight===t.height||(n=!0,s.viewportWidth=t.width,s.viewportHeight=t.height),s.coverageMipmap[0]=t,s.cellPixelSize!==i&&(s.cellPixelSize=i,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:rt.TEXTURE_2D,pixelFormat:Ie.RGB,dataType:yt.UNSIGNED_SHORT_5_6_5,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new ki(r,p,h)}}const o=Math.ceil(t.height/s.cellPixelSize),a=Math.ceil(t.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,g=4,y=new Float32Array(f*g*l*c);let v=0;for(let b=0;b<l;b++)for(let w=0;w<c;w++)y[v+0]=(w-.5)*p*2-1,y[v+1]=(b-.5)*h*2-1,y[v+2]=w*p,y[v+3]=b*h,y[v+4]=(w+.5)*p*2-1,y[v+5]=(b-.5)*h*2-1,y[v+6]=w*p,y[v+7]=b*h,y[v+8]=(w-.5)*p*2-1,y[v+9]=(b+.5)*h*2-1,y[v+10]=w*p,y[v+11]=b*h,y[v+12]=(w-.5)*p*2-1,y[v+13]=(b+.5)*h*2-1,y[v+14]=w*p,y[v+15]=b*h,y[v+16]=(w+.5)*p*2-1,y[v+17]=(b-.5)*h*2-1,y[v+18]=w*p,y[v+19]=b*h,y[v+20]=(w+.5)*p*2-1,y[v+21]=(b+.5)*h*2-1,y[v+22]=w*p,y[v+23]=b*h,v+=f*g;s.vao&&s.vao.dispose(!0),s.vao=new as(r,mi,{geometry:jR},{geometry:jt.createVertex(r,ri.STATIC_DRAW,y)})}}_gridComputeMipmap(){const t=this._rctx,i=this._grid,r=t.useTechnique(this.downsampleTechnique);t.bindVAO(this.quadVAO);for(let s=0;s<i.mipmapLevels;s++){t.bindFramebuffer(i.coverageMipmap[s+1]),r.bindTexture(i.coverageMipmap[s].colorTexture,"tex");const n=i.coverageMipmap[s+1].width,o=i.coverageMipmap[s+1].height;r.setUniform2f("invFramebufferDim",1/n,1/o),t.setViewport(0,0,n,o),t.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let t=(_(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(_(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)t+=i.gpuMemoryUsage;return t}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const gat={dataType:yt.UNSIGNED_BYTE,internalFormat:Ie.RGBA},yat={};class vat{constructor(t){this.rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(t=>t.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(t=>t.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(t=>t.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(t=>t.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(t){const i=t.id;this._activeTargets.has(i)&&(this._activeTargets.delete(i),this._disposeWithFramebuffers(this._depthTextures,i),this._disposeWithFramebuffers(this._depthBuffers,i),this._disposeWithFramebuffers(this._colorTextures,i))}_disposeWithFramebuffers(t,i){const r=t.get(i);r&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==r&&s.depthStencilAttachment!==r||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),r.dispose(),t.delete(i))}getDepthTexture(t,i){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(t.id);return!r||r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null),r||(r=new Ze(this.rctx,{target:rt.TEXTURE_2D,pixelFormat:Ie.DEPTH_STENCIL,dataType:yt.UNSIGNED_INT_24_8,samplingMode:Ve.NEAREST,wrapMode:lt.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._depthTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedDepthTexture(t){return this._depthTextures.get(t.id)}getDepthBuffer(t,i){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(t.id);return r?r.descriptor.width===i.width&&r.descriptor.height===i.height||r.resize(i.width,i.height):(r=new kw(this.rctx,I({internalFormat:Lo.DEPTH_STENCIL},i)),this._depthBuffers.set(t.id,r),this._activeTargets.add(t.id)),r}getColorTexture(t,i){let r=this._colorTextures.get(t.id);return r&&(r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null)),r||(r=new Ze(this.rctx,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,internalFormat:t.internalFormat,dataType:t.dataType,samplingMode:t.samplingMode!=null?t.samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._colorTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedColorTexture(t){return this._colorTextures.get(t.id)}registerDepthTarget(t={}){return I(I({id:va()},yat),t)}registerColorTarget(t={}){return I(I({id:va()},gat),t)}getFramebuffer(t,i,r){const s=this._getKey(i,r);let n=this._framebuffers.get(s);const o=this.getColorTexture(i,t);if(this.depthTextureSupported){const l=r?this.getDepthTexture(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=_(r)?new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.DEPTH_STENCIL_TEXTURE},o,l):new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},o),this._framebuffers.set(s,n),n)}const a=r?this.getDepthBuffer(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:r?ti.DEPTH_STENCIL_RENDER_BUFFER:ti.NONE},o,a),this._framebuffers.set(s,n),n)}_getKey(t,i){return`${t.id}_${i?i.id:"X"}_${t.name}${i?"_"+i.name:""}`}get gpuMemoryUsage(){let t=0;const i=new Set,r=s=>{i.has(s)||(i.add(s),t+=Xy(s))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),t}}class _at{constructor(t,i){this._rctx=t,this._compositingHelper=i,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const r=t.type===Kt.WEBGL2;this._renderTargetHelper=new vat(t);const s=this._renderTargetHelper;this.mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:yt.FLOAT,internalFormat:r?st.RGBA32F:Ie.RGBA,samplingMode:Ve.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:Ve.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?st.RGBA4:Ie.RGBA,dataType:yt.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?st.RGBA4:Ie.RGBA,dataType:yt.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(t){this._background=t}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(t,i){return this._renderTargetHelper.getFramebuffer(this._dimensions,t,i)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=this._mainColorTarget===0&&this._needLastFrameColorTexture?1:0}initializeFrame(t){const i=this._rctx;this._dimensions.width=t.fullWidth,this._dimensions.height=t.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),i.setClearStencil(0);const r=this._background.color;i.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),i.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT|bi.STENCIL_BUFFER_BIT)}composite(){_(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,Ln.None)}renderTmpAndCompositeToMain(t,i,r=!1){this.renderToTargets(t,this.tmpColor,r?this.tmpDepth:this.mainDepth,bat),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(t,i=!1){this.renderToTargets(t,this.hudVisibility,i?this.tmpDepth:this.mainDepth,wat)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets(()=>this._compositingHelper.composite(this._getColorTexture(this.tmpColor),Ln.None,1,ya.TransparentToHUDVisibility),this.hudVisibility,this.tmpDepth)}renderOITPass(t,i,r){let s,n;switch(i){case at.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case at.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case at.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0]}r?this.renderToTargets(t,s,this.tmpDepth,n,!0,!0):this.renderToTargets(t,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),Ln.PremultipliedAlpha)}compositeOccludedOntoMain(t){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),Ln.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(bi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(t){this.bindTarget(this.currentColorTarget),t(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(t){this._renderTargetHelper.disposeTargetResource(t)}set needLastFrameColorTexture(t){!t&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=t}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(t,i,r,s,n=!1,o=!1){const a=this._rctx,l=this.bindTarget(i,r);let c=0;if(s){const p=Math.max(1e-13,s[3]);a.setClearColor(s[0],s[1],s[2],p),c|=bi.COLOR_BUFFER_BIT}return n&&(c|=bi.DEPTH_BUFFER_BIT),o===!1?o=0:(o===!0&&(o=255),c|=bi.STENCIL_BUFFER_BIT),c&&a.clearSafe(c,o),t(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),l}bindTarget(t,i){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,t,i);return this._rctx.bindFramebuffer(r),r}_getColorTexture(t){return this._renderTargetHelper.getColorTexture(t,this._dimensions)}get gpuMemoryUsage(){let t=0;return this._renderTargetHelper&&(t+=this._renderTargetHelper.gpuMemoryUsage),t}}const bat=[0,0,0,0],wat=[0,1,0,1];class xat{constructor(t){this.context=t,this.renderPlugins=new Array,this.slots=[];for(let i=0;i<ye.MAX_SLOTS;++i)this.slots[i]=[]}add(t,i,r){const s=()=>{this.renderPlugins.push(i);for(const o of t)this.slots[o].push(i);this.context.requestRender()},n=i.initializeRenderContext(this.context,r);if(_c(n))return n.then(s);s()}remove(t){const i=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter(r=>r!==t),ot(this.renderPlugins.length<i,"Removing non-added render plugin");for(let r=0;r<this.slots.length;++r)this.slots[r]=this.slots[r].filter(s=>s!==t);t.uninitializeRenderContext(),this.context.requestRender()}prepareRender(t,i){for(const r of this.renderPlugins)r.prepareRender&&r.prepareRender(t,i)}updateAnimation(t){let i=!1;return this.renderPlugins.forEach(r=>{r.updateAnimation&&(i=r.updateAnimation(t)||i)}),i}render(){const t=this.slots[this.context.renderContext.slot],i=new Array;t.filter(r=>{if(!r.canRender)return!1;if(Tat(r)){const s=r.prepareTechnique(this.context.renderContext);return!!s&&(i.push(s),!0)}return i.push(null),!0}).forEach((r,s)=>r.render(this.context.renderContext,i[s]))}queryDepthRange(t){const i=Sat;i.near=1/0,i.far=-1/0;for(const r of this.renderPlugins)if(r.queryDepthRange){const s=r.queryDepthRange(t);s&&XT(i,s,i)}return i}get needsTransparentPass(){return this.renderPlugins.some(t=>t.needsTransparentPass)}get needsHighlight(){return this.renderPlugins.some(t=>t.needsHighlight)}get needsLinearDepth(){return this.renderPlugins.some(t=>t.needsLinearDepth)}get needsLaserlineWithContrastControl(){const t=this.slots[ye.LASERLINES_CONTRAST_CONTROL];return!!t&&t.length>0}get renderOccludedFlags(){let t=0;return this.renderPlugins.forEach(i=>{i.renderOccludedFlags&&(t|=i.renderOccludedFlags)}),t}}function Tat(e){return"prepareTechnique"in e}const Sat={near:0,far:0};function kq(e){e.fragment.uniforms.add("projInfo","vec4"),e.fragment.uniforms.add("zScale","vec2"),e.fragment.code.add(x`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}var Dn,xm;(function(e){e[e.Accumulate=0]="Accumulate",e[e.Visualize=1]="Visualize",e[e.VisualizeCurrent=2]="VisualizeCurrent",e[e.COUNT=3]="COUNT"})(Dn||(Dn={})),function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold"}(xm||(xm={}));const JF=255,Eat=1/JF;function Aat(e){const t=new Ri;t.fragment.include(Yh),t.fragment.include(As),t.include(kq),t.include(C0);const{pass:i}=e;if(i===Dn.Visualize){const{visualization:r,bandsEnabled:s}=e;t.fragment.constants.add("inverseSampleValue","float",JF),t.fragment.uniforms.add("shadowCastMap","sampler2D"),t.fragment.uniforms.add("sampleScale","float"),t.fragment.uniforms.add("opacityFromElevation","float");const n=r===xm.Gradient,o=r===xm.Threshold;t.fragment.uniforms.add("uColor","vec4"),n?s&&t.fragment.uniforms.add("bandSize","float"):o&&t.fragment.uniforms.add("threshold","float"),t.fragment.code.add(x`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?x`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?x`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?x`* strength`:""});
      }
    `)}else i!==Dn.Accumulate&&i!==Dn.VisualizeCurrent||(t.include(wm),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("inverseViewMatrix","mat4"),t.fragment.uniforms.add("nearFar","vec2"),i===Dn.Accumulate?t.fragment.constants.add("sampleValue","float",Eat):t.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),t.fragment.code.add(x`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= numCascades) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${i===Dn.Accumulate?x`vec4(sampleValue)`:x`shadowColor`};
      }
    `));return t}const Cat=Object.freeze({__proto__:null,get ShadowCastPass(){return Dn},get ShadowCastVisualization(){return xm},shadowCastMaxSamples:JF,build:Aat});class hO extends Vi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=hO.shader.get().build(this.configuration);return new Oi(t.rctx,i,mi)}initializePipeline(t){switch(this.configuration.pass){case Dn.Accumulate:return Rt({blending:Vn(Ee.ONE,Ee.ONE,Ee.ONE,Ee.ONE),colorWrite:Ft,depthTest:null,depthWrite:null});case Dn.Visualize:case Dn.VisualizeCurrent:return Rt({blending:dl,colorWrite:Ft,depthTest:null,depthWrite:null})}return Rt({})}bindPass(t){if(this.configuration.pass===Dn.Accumulate||this.configuration.pass===Dn.VisualizeCurrent){const i=t;this.program.bindTexture(i.linearDepthTexture,"depthMap"),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseViewMatrix",i.inverseViewMatrix),this.program.setUniform4fv("projInfo",i.projInfo),this.program.setUniform2fv("zScale",i.zScale)}else if(this.configuration.pass===Dn.Visualize){const i=t;if(this.program.bindTexture(i.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",i.sampleScale),this.program.setUniform1f("opacityFromElevation",i.opacityFromElevation),this.program.setUniform4fv("uColor",i.color),this.configuration.visualization===xm.Gradient&&this.configuration.bandsEnabled){const r=t;this.program.setUniform1f("bandSize",r.bandSize)}else if(this.configuration.visualization===xm.Threshold){const r=t;this.program.setUniform1f("threshold",r.threshold)}}}get primitiveType(){return Tt.TRIANGLE_STRIP}}hO.shader=new Li(Cat,()=>import("./ShadowCast.glsl.e2f97b05.js"));class jA extends dr{constructor(){super(...arguments),this.pass=Dn.Accumulate,this.visualization=xm.Gradient,this.bandsEnabled=!1}}u([Y({count:Dn.COUNT})],jA.prototype,"pass",void 0),u([Y()],jA.prototype,"visualization",void 0),u([Y()],jA.prototype,"bandsEnabled",void 0);const Rat=yi(.01,0,.25,1),Oat=4e4,Mat=5e4,d_e=1/512;let JI=class extends we{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=r,this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:Rat,threshold:.5,bandSize:.1,opacityFromElevation:1},this._techniqueConfig=new jA,this._enabled=!1,this._vao=fo(t),this._techniqueConfig.pass=Dn.Visualize,this._techniqueConfig.visualization=xm.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=et(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(hO,this._techniqueConfig,this._technique),this._technique}render(){if(!this._isRenderingVisualization)return;this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao);const e=this.visualizeShadowCastTechnique;this._rctx.useTechnique(e),e.bindPass(this._visualizationParams),this._rctx.drawArrays(e.primitiveType,0,fn(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(e){this._visualizationParams.opacityFromElevation!==e&&(this._visualizationParams.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>d_e}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(e){this._visualizationParams.sampleScale=e}get _threshold(){return this._visualizationParams.threshold}set _threshold(e){this._threshold!==e&&(this._visualizationParams.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(e){e!==this._bandSize&&(this._visualizationParams.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._visualizationParams.color;t1(e,t)||(fa(this._visualizationParams.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],JI.prototype,"opacityFromElevation",null),JI=u([P("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],JI);class Pat{constructor(){this.camera=new wi,this.lightMat=Te()}}class p_e{constructor(t,i,r=0){this.rctx=t,this.viewingMode=i,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let s=0;s<4;++s)this.cascades.push(new Pat);this.snapshotCount=r}dispose(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(t){this.maxNumCascades=ze(Math.floor(t),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const i=this._snapshots.length;if(t>i){const r=t-i;this._snapshots.length=t;for(let s=0;s<r;++s)this._snapshots[i+s]=null}else if(t<this.snapshotCount){const r=i-t;for(let s=0;s<r;++s)this._discardSnapshot(t+s);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)Pk[t]=this.cascades[t];return Pk.length=this.numCascades,Pk}start(t,i,r){ot(this.enabled),this.textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:s,far:n}=this._clampNearFar(r);this._computeCascadeDistances(n,s),this._setupMatrices(t,i);const o=t.viewMatrix,a=t.projectionMatrix;for(let l=0;l<this.numCascades;++l)this._constructCascade(l,a,o,i);this.lastOrigin=null,this.clear()}finish(t){ot(this.enabled),this.rctx.bindFramebuffer(t)}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"shadowMapTex"),t.setUniform1f("depthHalfPixelSz",.5/this.textureSize),t.setUniform1i("numCascades",this.numCascades),t.setUniform4f("cascadeDistances",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("depthHalfPixelSz",-1)}bindView(t,i){if(!this.enabled)return;const r=this.lastOrigin;if(!(r&&r[0]===i[0]&&r[1]===i[1]&&r[2]===i[2])){this.lastOrigin=this.lastOrigin||M(),ne(this.lastOrigin,i);for(let s=0;s<this.numCascades;++s){Vo(ire,this.cascades[s].lightMat,i);for(let n=0;n<16;++n)rre[16*s+n]=ire[n]}}t.setUniformMatrix4fv("shadowMapMatrix",rre)}takeCascadeSnapshotTo(t,i){ot(this.enabled),this._ensureSnapshot(i),this._bindFbo();const r=this.rctx,s=r.bindTexture(this._snapshots[i],Ze.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(rt.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),r.bindTexture(s,Ze.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT)}_computeTextureSize(t,i){const r=.5*Math.log(t*t+i*i)*Math.LOG2E,s=.35,n=2**Math.round(r+s);return Math.min(this.maxTextureSize,2*n)}_ensureDepthTexture(){if(this._depthTexture!=null&&this._depthTexture.descriptor.width===this.textureSize)return;this._discardDepthTexture();const t={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new Ze(this.rctx,t),this.fbo=new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.DEPTH_RENDER_BUFFER,width:this.textureSize,height:this.textureSize},this._depthTexture)}_ensureSnapshot(t){const i=this._snapshots[t];if(_(i)&&i.descriptor.width===this.textureSize)return;this._discardSnapshot(t);const r={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new Ze(this.rctx,r)}_discardDepthTexture(){this.fbo=et(this.fbo),this._depthTexture=et(this._depthTexture)}_discardSnapshot(t){this._snapshots[t]=et(this._snapshots[t])}_discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)}_bindFbo(){const t=this.rctx;_(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)}_constructCascade(t,i,r,s){const n=this.cascades[t],o=-this.cascadeDistances[t],a=-this.cascadeDistances[t+1],l=(i[10]*o+i[14])/Math.abs(i[11]*o+i[15]),c=(i[10]*a+i[14])/Math.abs(i[11]*a+i[15]);ot(l<c);for(let p=0;p<8;++p){zo(Zie,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:c,1),bu(Va[p],Zie,Yie);for(let f=0;f<3;++f)Va[p][f]/=Va[p][3]}lo(Mk,Va[0]),Vo(Wie,tre,Mk),n.camera.viewMatrix=Wie;for(let p=0;p<8;++p)Ue(Va[p],Va[p],n.camera.viewMatrix);ne(md,Va[0]),ne(gd,Va[0]);for(let p=1;p<8;++p)for(let f=0;f<3;++f)md[f]=Math.min(md[f],Va[p][f]),gd[f]=Math.max(gd[f],Va[p][f]);md[2]-=200,gd[2]+=200,n.camera.near=-gd[2],n.camera.far=-md[2],this.warp?this._constructTrapezoidalProjection(r,s,n):this._constructOrthogonalProjection(n),ur(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this.textureSize/2;n.camera.viewport[0]=t%2==0?0:h,n.camera.viewport[1]=Math.floor(t/2)===0?0:h,n.camera.viewport[2]=h,n.camera.viewport[3]=h}_constructOrthogonalProjection(t){QG(t.camera.projectionMatrix,md[0],gd[0],md[1],gd[1],t.camera.near,t.camera.far)}_constructTrapezoidalProjection(t,i,r){const s=1/Va[0][3],n=1/Va[4][3];ot(s<n);let o=s+Math.sqrt(s*n);const a=Math.sin(Es(t[2]*i[0]+t[6]*i[1]+t[10]*i[2]));o/=a,$at(Va,o,a,Qie,Jie,Iat,Kie,ere),Dat(Qie,Jie,Kie,ere,r.camera.projectionMatrix),r.camera.projectionMatrix[10]=2/(md[2]-gd[2]),r.camera.projectionMatrix[14]=-(md[2]+gd[2])/(md[2]-gd[2])}_setupMatrices(t,i){ur(Xie,t.projectionMatrix,t.viewMatrix),hr(Yie,Xie);const r=this.viewingMode===$e.Global?t.eye:oe(Mk,0,0,1);rN(tre,[0,0,0],[-i[0],-i[1],-i[2]],r)}_clampNearFar(t){let{near:i,far:r}=t;return i<2&&(i=2),r<2&&(r=2),i>=r&&(i=2,r=4),{near:i,far:r}}_computeCascadeDistances(t,i){this.numCascades=Math.min(1+Math.floor(bVe(t/i,4)),this.maxNumCascades);const r=(t-i)/this.numCascades,s=(t/i)**(1/this.numCascades);let n=i,o=i;for(let a=0;a<this.numCascades+1;++a)this.cascadeDistances[a]=qt(n,o,this.splitSchemeLambda),n*=s,o+=r}get gpuMemoryUsage(){var t,i;return this._snapshots.reduce((r,s)=>r+Xy(s),(t=(i=this.fbo)==null?void 0:i.gpuMemoryUsage)!=null?t:0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(i){t.splitSchemeLambda=i},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(i){t.warp=i},get warp(){return t.warp}}}}const Wie=Te(),Xie=Te(),Yie=Te(),Zie=ni(),Va=[];for(let e=0;e<8;++e)Va.push(ni());const md=M(),gd=M(),Qie=Xe(),Jie=Xe(),Iat=Xe(),Kie=Xe(),ere=Xe(),tre=Te(),Mk=M(),Pk=[],ire=Te(),rre=new Float32Array(64),Rl=Xe(),Yb=Xe(),pv=[Xe(),Xe(),Xe(),Xe()],Ps=Xe(),Ik=Xe(),_g=Xe(),L2=Xe(),Zb=Xe(),Qb=Xe(),KP=Xe();function $at(e,t,i,r,s,n,o,a){tr(Rl,0,0);for(let C=0;C<4;++C)_h(Rl,Rl,e[C]);tl(Rl,Rl,.25),tr(Yb,0,0);for(let C=4;C<8;++C)_h(Yb,Yb,e[C]);tl(Yb,Yb,.25),Fw(pv[0],e[4],e[5],.5),Fw(pv[1],e[5],e[6],.5),Fw(pv[2],e[6],e[7],.5),Fw(pv[3],e[7],e[4],.5);let l=0,c=SD(pv[0],Rl);for(let C=1;C<4;++C){const R=SD(pv[C],Rl);R<c&&(c=R,l=C)}Qd(Ps,pv[l],e[l+4]);const h=Ps[0];let p,f;Ps[0]=-Ps[1],Ps[1]=h,Qd(Ik,Yb,Rl),ps(Ik,Ps)<0&&$j(Ps,Ps),Fw(Ps,Ps,Ik,i),TC(Ps,Ps),p=f=ps(Qd(_g,e[0],Rl),Ps);for(let C=1;C<8;++C){const R=ps(Qd(_g,e[C],Rl),Ps);R<p?p=R:R>f&&(f=R)}Fs(r,Rl),tl(_g,Ps,p-t),_h(r,r,_g);let g=-1,y=1,v=0,b=0;for(let C=0;C<8;++C){Qd(L2,e[C],r),TC(L2,L2);const R=Ps[0]*L2[1]-Ps[1]*L2[0];R>0?R>g&&(g=R,v=C):R<y&&(y=R,b=C)}mb(g>0,"leftArea"),mb(y<0,"rightArea"),tl(Zb,Ps,p),_h(Zb,Zb,Rl),tl(Qb,Ps,f),_h(Qb,Qb,Rl),KP[0]=-Ps[1],KP[1]=Ps[0];const w=vM(r,e[b],Qb,_h(_g,Qb,KP),1,s),S=vM(r,e[v],Qb,_g,1,n),T=vM(r,e[v],Zb,_h(_g,Zb,KP),1,o),A=vM(r,e[b],Zb,_g,1,a);mb(w,"rayRay"),mb(S,"rayRay"),mb(T,"rayRay"),mb(A,"rayRay")}function Xt(e,t){return 3*t+e}const sre=Xe();function $a(e,t){return tr(sre,e[t],e[t+3]),sre}const Yo=Xe(),qe=br();function Dat(e,t,i,r,s){Qd(Yo,i,r),tl(Yo,Yo,.5),qe[0]=Yo[0],qe[1]=Yo[1],qe[2]=0,qe[3]=Yo[1],qe[4]=-Yo[0],qe[5]=0,qe[6]=Yo[0]*Yo[0]+Yo[1]*Yo[1],qe[7]=Yo[0]*Yo[1]-Yo[1]*Yo[0],qe[8]=1,qe[Xt(0,2)]=-ps($a(qe,0),e),qe[Xt(1,2)]=-ps($a(qe,1),e);let n=ps($a(qe,0),i)+qe[Xt(0,2)],o=ps($a(qe,1),i)+qe[Xt(1,2)],a=ps($a(qe,0),r)+qe[Xt(0,2)],l=ps($a(qe,1),r)+qe[Xt(1,2)];n=-(n+a)/(o+l),qe[Xt(0,0)]+=qe[Xt(1,0)]*n,qe[Xt(0,1)]+=qe[Xt(1,1)]*n,qe[Xt(0,2)]+=qe[Xt(1,2)]*n,n=1/(ps($a(qe,0),i)+qe[Xt(0,2)]),o=1/(ps($a(qe,1),i)+qe[Xt(1,2)]),qe[Xt(0,0)]*=n,qe[Xt(0,1)]*=n,qe[Xt(0,2)]*=n,qe[Xt(1,0)]*=o,qe[Xt(1,1)]*=o,qe[Xt(1,2)]*=o,qe[Xt(2,0)]=qe[Xt(1,0)],qe[Xt(2,1)]=qe[Xt(1,1)],qe[Xt(2,2)]=qe[Xt(1,2)],qe[Xt(1,2)]+=1,n=ps($a(qe,1),t)+qe[Xt(1,2)],o=ps($a(qe,2),t)+qe[Xt(2,2)],a=ps($a(qe,1),i)+qe[Xt(1,2)],l=ps($a(qe,2),i)+qe[Xt(2,2)],n=-.5*(n/o+a/l),qe[Xt(1,0)]+=qe[Xt(2,0)]*n,qe[Xt(1,1)]+=qe[Xt(2,1)]*n,qe[Xt(1,2)]+=qe[Xt(2,2)]*n,n=ps($a(qe,1),t)+qe[Xt(1,2)],o=ps($a(qe,2),t)+qe[Xt(2,2)],a=-o/n,qe[Xt(1,0)]*=a,qe[Xt(1,1)]*=a,qe[Xt(1,2)]*=a,s[0]=qe[0],s[1]=qe[1],s[2]=0,s[3]=qe[2],s[4]=qe[3],s[5]=qe[4],s[6]=0,s[7]=qe[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=qe[6],s[13]=qe[7],s[14]=0,s[15]=qe[8]}var JE;let eo=JE=class extends we{constructor(e,t,i,r,s,n){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._cachedCamera=new wi,this._contentCamera=new wi,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=x9,this._previewing=!1,this._handles=new Bt,this._cameraForcedForScreenshot=!1,this._shadowMap=new p_e(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=fo(e);const o={colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},a={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new ki(e,o,a),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseViewMatrix:Te(),projInfo:ni(),zScale:Xe()},this._accumulationRenderer=new JI(t,e,this,n);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(ut.SHADOW_ACCUMULATOR,this)),this._handles.add(Nt(()=>i.renderView,c=>{this._handles.remove(JE.renderViewHandleKey),O(c)||this._handles.add(c.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),JE.renderViewHandleKey)},Yl))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(O(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode},t=new jA;t.pass=Dn.Accumulate,this._accumulationTechnique=new hO(e,t)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return this._accumulationParams.linearDepthTexture!==null&&this._depthRange!==x9&&this._opacityFromElevation>d_e}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(J_(t,e,Yx))return;const i=e.length;t.length=i,this._sampleCount=Math.min(JF,i);for(let r=0;r<i;++r){const s=e[r],n=t[r]||M();ne(n,s),t[r]=n}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseViewMatrix}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this._canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(JE.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=et(this._accumulationRenderer),this._shadowMap=et(this._shadowMap),this._fbo=et(this._fbo),this._vao=et(this._vao),this._accumulationTechnique=Wi(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.previewing!==void 0&&this.setPreviewing(e.previewing),e.lightDirections!==void 0&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,r){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=r,this.notifyChange("_canAccumulate")}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=Lat;return this._fbo.readPixels(e,t,1,1,Ie.RGBA,yt.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(bi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useTechnique(i),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,fn(this._vao,"geometry")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:r,viewMatrix:s,center:n}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),Kj(r,t,i,this._projInfo,this._zScale),Vo(this._inverseView,s,n),hr(this._inverseView,this._inverseView),this._opacityFromElevation=1-Jx(Oat,Mat,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};eo.previewSamples=6,eo.renderViewHandleKey="renderView",u([d()],eo.prototype,"_progress",void 0),u([d()],eo.prototype,"_sampleCount",void 0),u([d()],eo.prototype,"_enabled",void 0),u([d()],eo.prototype,"_depthRange",void 0),u([d()],eo.prototype,"_previewing",void 0),u([d()],eo.prototype,"_accumulationRenderer",void 0),u([d()],eo.prototype,"_isRefining",null),u([d()],eo.prototype,"_isActive",null),u([d()],eo.prototype,"_canAccumulate",null),u([d()],eo.prototype,"_isDoneAccumulating",null),u([d()],eo.prototype,"_opacityFromElevation",null),u([d()],eo.prototype,"running",null),eo=JE=u([P("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],eo);const Lat=new Uint8Array(4);function Nat(e){const t=new Ri;return t.include(wm),t.fragment.include(Yh),t.fragment.include(As),t.include(kq),t.include(C0),t.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("uColor","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseViewMatrix","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),t.fragment.constants.add("unoccludedHighlightFlag","vec4",kge).add("highlightedThreshold","float",e.highlightedThreshold).add("selfShadowThreshold","float",e.selfShadowThreshold),t.fragment.code.add(x`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.fragment.code.add(x`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),t}const Fat=Object.freeze({__proto__:null,build:Nat}),f_e=0,m_e=1;class KF extends Vi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=KF.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new Oi(t.rctx,i,mi)}initializePipeline(t){return Rt({blending:Vn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){if(O(i.linearDepthTexture))return;this.program.bindTexture(i.linearDepthTexture,"depthMap"),this.program.bindTexture(i.highlightColorTexture,"highlightMap"),Ue(e3,i.lighting.lightingMainDirection,i.camera.viewInverseTransposeMatrix),be(e3,e3),Kj(i.camera.projectionMatrix,i.camera.fullWidth,i.camera.fullHeight,ore,nre),Vo(t3,i.camera.viewMatrix,i.camera.center),hr(t3,t3),this.program.setUniform4fv("uColor",t.shadowColor),this.program.setUniform1f("opacity",t.shadowOpacity),this.program.setUniform1f("occludedOpacity",t.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",t.opacityElevation*t.dayNightTerminator),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseViewMatrix",t3),this.program.setUniform4fv("projInfo",ore),this.program.setUniform2fv("zScale",nre),this.program.setUniform3fv("lightingMainDirectionView",e3),this.program.setUniform2f("texelSize",1/i.linearDepthTexture.descriptor.width,1/i.linearDepthTexture.descriptor.height),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center);let r=i.shadowMap.getSnapshot(f_e);_(r)&&this.program.bindTexture(r,"highlightDepthTex"),r=i.shadowMap.getSnapshot(m_e),_(r)&&this.program.bindTexture(r,"defaultDepthTex")}get primitiveType(){return Tt.TRIANGLE_STRIP}}KF.shader=new Li(Fat,()=>import("./ShadowHighlight.glsl.8667568b.js"));const e3=M(),nre=Xe(),ore=ni(),t3=Te(),Uat=.001953125,kat=4e4,zat=5e4;class Bat{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:xa(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=fo(this._rctx)}get technique(){return O(this._technique)&&(this._technique=new KF({rctx:this._rctx,viewingMode:this._viewingMode})),this._technique}render(t,i){if(!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const r=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useTechnique(r),r.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,fn(this._vao,"geometry"))}get gpuMemoryUsage(){var t,i;return(t=(i=this._vao)==null?void 0:i.size)!=null?t:0}setDefaultOptions(t){this._parameters=I(I({},this._parameters),t),this._updateMaxOpacity()}updateParameters(t,i){this._parameters.opacityElevation=1-Jx(kat,zat,t.relativeElevation);const r=this._viewingMode===$e.Global?be(are,t.center):oe(are,0,0,1),s=_e(r,i);this._parameters.dayNightTerminator=Jx(0,1,ze(30*s,0,1))}dispose(){this._vao=et(this._vao),this._technique=Wi(this._technique)}get isVisible(){const{opacityElevation:t,dayNightTerminator:i}=this._parameters;return this._maxOpacity*t*i>=Uat}_updateMaxOpacity(){const t=this._parameters,i=t.shadowColor,r=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=r*i[3]}}const are=M(),$k=Y1();class Vat{constructor(){this._worldPlane=$k}get isEnabled(){return this.plane!==$k}get plane(){return this._worldPlane}set plane(t){this._worldPlane=t||$k}}var Nh;function Gat(e){const t=new Ri;return e.output===Nh.EdgeDetector&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(x`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.code.add(x`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${x.float(e.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${x.float(e.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),e.output===Nh.BlendWeight&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(x`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * resolution.zw;
        fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${x.int(e.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("resolution","vec4"),t.fragment.code.add(x`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * resolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${x.int(e.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * resolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * resolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),e.output===Nh.Blur&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(x`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add("tBlendWeights","sampler2D"),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.uniforms.add("resolution","vec4"),t.fragment.code.add(x`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * resolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}(function(e){e[e.EdgeDetector=0]="EdgeDetector",e[e.BlendWeight=1]="BlendWeight",e[e.Blur=2]="Blur",e[e.COUNT=3]="COUNT"})(Nh||(Nh={}));const jat=Object.freeze({__proto__:null,get SMAAOutput(){return Nh},build:Gat});class e4 extends Vi{initializeProgram(t){const i=e4.shader.get(),r=this.configuration,s=i.build({output:r.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new Oi(t.rctx,s,mi)}initializePipeline(){return Rt({colorWrite:Ft})}}e4.shader=new Li(jat,()=>import("./SMAA.glsl.1a8d4db0.js"));class g_e extends dr{constructor(){super(...arguments),this.output=Nh.EdgeDetector}}u([Y({count:Nh.COUNT})],g_e.prototype,"output",void 0);let KE=class extends we{constructor(e,t){super({}),this.rctx=e,this._techniqueRep=t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=xu(this._abortController),this.disable()}_loadResources(e){if(_(this._abortController))return!1;if(_(this._searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return import("./SmaaRenderPassData.69c5bfba.js").then(i=>this._loadTextures(i,t)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,t){return Jt(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,Ve.LINEAR,Ie.RGB),this._loadTextureFromBase64(e.searchTexure,Ve.NEAREST,Ie.LUMINANCE)]).then(([i,r])=>{Ls(t)?(i.dispose(),r.dispose(),Jt(t)):(this._areaTexture=i,this._searchTexture=r)})}get updating(){return _(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const t=new g_e,i=(r,s)=>this._techniqueRep.releaseAndAcquire(e4,r,s);t.output=Nh.EdgeDetector,this._edgeDetectTechnique=i(t,this._edgeDetectTechnique),t.output=Nh.BlendWeight,this._blendWeightsTechnique=i(t,this._blendWeightsTechnique),t.output=Nh.Blur,this._blurTechnique=i(t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=K6e(this.rctx),this._edges=new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,pixelFormat:Ie.RGB,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:4,height:4}),this._blend=new ki(this.rctx,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=et(this._vao),this._areaTexture=et(this._areaTexture),this._searchTexture=et(this._searchTexture),this._blend=et(this._blend),this._edges=et(this._edges),this._isEnabled=!1)}render(e){if(!this._isEnabled)return;const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),t.setViewport(r.x,r.y,r.width,r.height),this._edges.resize(r.width,r.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(bi.COLOR_BUFFER_BIT);const s=t.useTechnique(this._edgeDetectTechnique);s.bindTexture(e,"tColor"),s.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(Tt.TRIANGLES,0,3),this._blend.resize(r.width,r.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(bi.COLOR_BUFFER_BIT);const n=t.useTechnique(this._blendWeightsTechnique);n.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),n.bindTexture(this._searchTexture,"tSearch"),n.bindTexture(this._areaTexture,"tArea"),n.bindTexture(this._edges.colorTexture,"tEdges"),t.drawArrays(Tt.TRIANGLES,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(bi.COLOR_BUFFER_BIT);const o=t.useTechnique(this._blurTechnique);o.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),o.bindTexture(e,"tColor"),o.bindTexture(this._blend.colorTexture,"tBlendWeights"),t.drawArrays(Tt.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,i){const r=new Ze(this.rctx,{pixelFormat:i,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:t},null);return Cu(e).then(s=>(r.resize(s.width,s.height),r.setData(s),r))}};u([d()],KE.prototype,"_abortController",void 0),u([d({readOnly:!0})],KE.prototype,"updating",null),KE=u([P("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],KE);var Tm;function Hat(e){const t=new Ri;return t.include(C0),e.output===Tm.Blur&&(t.fragment.include(As),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),t.fragment.code.add(x`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${x.float(e.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),t.fragment.code.add(x`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${x.int(e.filterRadius)}; r <= ${x.int(e.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),e.output===Tm.SSAO&&(t.fragment.include(As),t.include(kq),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(x`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),t.fragment.code.add(x`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),t.fragment.code.add(x`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${x.int(e.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${x.int(e.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),t}(function(e){e[e.SSAO=0]="SSAO",e[e.Blur=1]="Blur",e[e.COUNT=2]="COUNT"})(Tm||(Tm={}));const qat=Object.freeze({__proto__:null,get SSAOOutput(){return Tm},build:Hat});class tp extends Vi{initializeProgram(t){const i=tp.shader.get(),r=this.configuration,s=(tp.filterRadius+1)/2,n=1/(2*s*s),o=i.build({output:r.output,samples:tp.samples,filterRadius:tp.filterRadius,blurFalloff:n});return new Oi(t.rctx,o,mi)}initializePipeline(){return Rt({colorWrite:Ft})}}tp.shader=new Li(qat,()=>import("./SSAO.glsl.dc58db5d.js")),tp.samples=16,tp.filterRadius=4;class y_e extends dr{constructor(){super(...arguments),this.output=Tm.SSAO}}u([Y({count:Tm.COUNT})],y_e.prototype,"output",void 0);class Wat{constructor(t,i,r){this._techniqueRep=t,this._rctx=i,this._requestRender=r,this._enabled=!1,this._ssaoTechniqueConfig=new y_e,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=et(this.quadVAO)}disposeOffscreenBuffers(){oo(this._ssaoFBO,t=>t.resize(0,0)),oo(this._blur0FBO,t=>t.resize(0,0)),oo(this._blur1FBO,t=>t.resize(0,0))}set enabled(t){t?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&_(this._noiseTexture)&&_(this._ssaoFBO)&&_(this._blur0FBO)&&_(this._blur1FBO)}computeSSAO(t,i,r){if(!this.enabled||O(i)||O(r)||O(this._noiseTexture)||O(this._ssaoFBO)||O(this._blur0FBO)||O(this._blur1FBO))return;const s=this._rctx,n=t.fullViewport,o=n[2],a=n[3],l=o/this._blurSizePx,c=a/this._blurSizePx;this._ssaoFBO.resize(o,a),this._blur0FBO.resize(l,c),this._blur1FBO.resize(l,c);const h=1,p=1,f=o*h,g=a*p;s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,o,a);const y=s.useTechnique(this._ssaoTechnique);y.setUniform2f("rnmScale",o/this._noiseTexture.descriptor.width,a/this._noiseTexture.descriptor.height),Kj(t.projectionMatrix,t.fullWidth,t.fullHeight,cre,lre),y.setUniform4fv("projInfo",cre),y.setUniform2fv("zScale",lre),y.setUniform2fv("nearFar",t.nearFar);let v=1/t.computeRenderPixelSizeAtDist(1);y.setUniform1f("projScale",v*h),y.setUniform2f("screenDimensions",f,g);const b=xi(t.eye,t.center);let w=20*t.computeRenderPixelSizeAtDist(b);w=Math.max(.1,w),y.setUniform1f("radius",w),y.setUniform1f("intensity",4*this._attenuation/w**6),y.bindTexture(this._noiseTexture,"rnm"),y.bindTexture(r,"normalMap"),y.bindTexture(i,"depthMap"),O(this.quadVAO)&&(this.quadVAO=fo(this._rctx)),s.bindVAO(this.quadVAO),s.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this.quadVAO,"geometry"));const S=s.useTechnique(this._blurTechnique);S.bindTexture(this._ssaoFBO.colorTexture,"tex"),S.bindTexture(r,"normalMap"),S.bindTexture(i,"depthMap"),s.setViewport(0,0,f/this._blurSizePx,g/this._blurSizePx),s.bindFramebuffer(this._blur0FBO),S.setUniform2f("screenDimensions",f,g),S.setUniform2f("blurSize",0,this._blurSizePx*h/g),S.setUniform2fv("nearFar",t.nearFar),b>5e4&&(v=Math.max(0,v-(b-5e4))),S.setUniform1f("projScale",v),s.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this.quadVAO,"geometry")),S.setUniform2f("blurSize",this._blurSizePx*p/f,0),s.bindFramebuffer(this._blur1FBO),S.bindTexture(this._blur0FBO.colorTexture,"tex"),s.drawArrays(Tt.TRIANGLE_STRIP,0,fn(this.quadVAO,"geometry")),s.setViewport(n[0],n[1],n[2],n[3])}bind(t,i){this.enabled&&_(this._blur1FBO)&&_(this._ssaoFBO)?(t.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),t.setUniform4f("viewportPixelSz",i.fullViewport[0],i.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):t.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=Tm.SSAO,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(tp,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=Tm.Blur,this._blurTechnique=this._techniqueRep.releaseAndAcquire(tp,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))}_loadResources(t){this._data?t():import("./SSAOHelperData.256ae0c1.js").then(i=>{this._data=i,t()})}_initialize(){const t={target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.LINEAR,wrapMode:lt.CLAMP_TO_EDGE,width:0,height:0},i={colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE};Cu(this._data.noiseTexture).then(r=>{this._enabled&&(this._ssaoFBO=new ki(this._rctx,i,t),this._blur0FBO=new ki(this._rctx,i,t),this._blur1FBO=new ki(this._rctx,i,t),this._noiseTexture=new Ze(this._rctx,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,hasMipmap:!0,width:r.width,height:r.height},r),this._requestRender())}),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=et(this._noiseTexture),this._blur1FBO=et(this._blur1FBO),this._blur0FBO=et(this._blur0FBO),this._ssaoFBO=et(this._ssaoFBO)}get gpuMemoryUsage(){return(_(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(_(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(_(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const lre=Xe(),cre=ni();function Xat(e,t){const i=t,r=-e[0],s=-e[1],n=-e[2],o=i[3],a=i[7],l=i[11],c=i[15];i[0]+=o*r,i[1]+=o*s,i[2]+=o*n,i[4]+=a*r,i[5]+=a*s,i[6]+=a*n,i[8]+=l*r,i[9]+=l*s,i[10]+=l*n,i[12]+=c*r,i[13]+=c*s,i[14]+=c*n}function Yat(e,t){const i=t,r=e[0],s=e[1],n=e[2];i[12]+=r*i[0]+s*i[4]+n*i[8],i[13]+=r*i[1]+s*i[5]+n*i[9],i[14]+=r*i[2]+s*i[6]+n*i[10],i[14]+=r*i[3]+s*i[7]+n*i[11]}class Zat{constructor(t){this.factory=t,this.originData=new Map}acquire(t){return this.register(this.factory.getOrigin(t))}register(t){const i=this.originData.get(t.id);return i?(i.refCount++,i.origin):(this.originData.set(t.id,{refCount:1,viewMatrix:Te(),origin:t}),t)}release(t){const i=this.originData.get(t.id);i&&(i.refCount--,i.refCount===0&&this.originData.delete(t.id))}updateViewMatrices(t){this.originData.forEach(i=>{Lr(i.viewMatrix,t),Yat(i.origin.vec3,i.viewMatrix)})}getViewMatrix(t){return this.originData.get(t.id).viewMatrix}}const mL=Nr().vec3f(E.POSITION).u16(E.COMPONENTINDEX).u16(E.U16PADDING),v_e=Nr().vec2u8(E.SIDENESS),ure=wl(v_e),__e=Nr().vec3f(E.POSITION0).vec3f(E.POSITION1).u16(E.COMPONENTINDEX).u8(E.VARIANTOFFSET,{glNormalized:!0}).u8(E.VARIANTSTROKE).u8(E.VARIANTEXTENSION,{glNormalized:!0}).u8(E.U8PADDING,{glPadding:!0}).u16(E.U16PADDING,{glPadding:!0}),C9=__e.clone().vec3f(E.NORMAL),R9=__e.clone().vec3f(E.NORMALA).vec3f(E.NORMALB),O9=new Map([[E.POSITION0,0],[E.POSITION1,1],[E.COMPONENTINDEX,2],[E.VARIANTOFFSET,3],[E.VARIANTSTROKE,4],[E.VARIANTEXTENSION,5],[E.NORMAL,6],[E.NORMALA,6],[E.NORMALB,7],[E.SIDENESS,8]]);class b_e{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?Jat:Qat}write(t,i,r){const s=this.edgeHashFunction(r);r3.seed=s;const n=r3.getIntRange(0,255),o=r3.getIntRange(0,this.settings.variants-1),a=.7,l=r3.getFloat(),c=255*(.5*Kat(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);t.position0.setVec(i,r.position0),t.position1.setVec(i,r.position1),t.componentIndex.set(i,r.componentIndex),t.variantOffset.set(i,n),t.variantStroke.set(i,o),t.variantExtension.set(i,c)}trim(t,i){return t.slice(0,i)}}const zq=new Float32Array(6),gL=new Uint32Array(zq.buffer),By=new Uint32Array(1);function Qat(e){const t=zq;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],By[0]=5381;for(let i=0;i<gL.length;i++)By[0]=31*By[0]+gL[i];return By[0]}function Jat(e){const t=zq;t[0]=Jb(e.position0[0]),t[1]=Jb(e.position0[1]),t[2]=Jb(e.position0[2]),t[3]=Jb(e.position1[0]),t[4]=Jb(e.position1[1]),t[5]=Jb(e.position1[2]),By[0]=5381;for(let i=0;i<gL.length;i++)By[0]=31*By[0]+gL[i];return By[0]}const hre=1e4;function Jb(e){return Math.round(e*hre)/hre}function Kat(e,t){const i=e<0?-1:1;return Math.abs(e)**t*i}class yL{constructor(){this.commonWriter=new b_e}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return C9.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),pe(i3,r.faceNormal0,r.faceNormal1),be(i3,i3),t.normal.setVec(i,i3)}trim(t,i){return this.commonWriter.trim(t,i)}}yL.Layout=C9,yL.glLayout=wl(C9,1);class vL{constructor(){this.commonWriter=new b_e}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return R9.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),t.normalA.setVec(i,r.faceNormal0),t.normalB.setVec(i,r.faceNormal1)}trim(t,i){return this.commonWriter.trim(t,i)}}vL.Layout=R9,vL.glLayout=wl(R9,1);const i3=M(),r3=new nu,s_=-1;var _L;function elt(e,t,i,r=olt){const s=e.vertices.position,n=e.vertices.componentIndex,o=Ct(r.anglePlanar),a=Ct(r.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=M9.edge,p=h.position0,f=h.position1,g=h.faceNormal0,y=h.faceNormal1,v=nlt(e),b=slt(e),w=b.length/4,S=t.allocate(w);let T=0;const A=w,C=i.allocate(A);let R=0,L=0,U=0;const N=k1e(0,w),z=new Float32Array(w);G1e(z,(te,ie,$)=>{s.getVec(b[4*ie+0],p),s.getVec(b[4*ie+1],f),$[ie]=xi(p,f)}),N.sort((te,ie)=>z[ie]-z[te]);const V=new Array,B=new Array;for(let te=0;te<w;te++){const ie=N[te],$=z[ie],F=b[4*ie+0],k=b[4*ie+1],G=b[4*ie+2],q=b[4*ie+3],K=q===s_;if(s.getVec(F,p),s.getVec(k,f),K)oe(g,v[3*G+0],v[3*G+1],v[3*G+2]),ne(y,g),h.componentIndex=n.get(F),h.cosAngle=_e(g,y);else{if(oe(g,v[3*G+0],v[3*G+1],v[3*G+2]),oe(y,v[3*q+0],v[3*q+1],v[3*q+2]),h.componentIndex=n.get(F),h.cosAngle=_e(g,y),ilt(h,c))continue;h.cosAngle<-.9999&&ne(y,g)}L+=$,U++,K||tlt(h,l)?(t.write(S,T++,h),V.push($)):rlt(h,o)&&(i.write(C,R++,h),B.push($))}const J=new Float32Array(V.reverse()),Z=new Float32Array(B.reverse());return{regular:{instancesData:t.trim(S,T),lodInfo:{lengths:J}},silhouette:{instancesData:i.trim(C,R),lodInfo:{lengths:Z}},averageEdgeLength:L/U}}function tlt(e,t){return e.cosAngle<t}function ilt(e,t){return e.cosAngle>t}function rlt(e,t){const i=Es(e.cosAngle),r=M9.fwd,s=M9.ortho;return Am(r,e.position1,e.position0),i*(_e(dt(s,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function slt(e){const t=e.faces.length/3,i=e.faces,r=e.neighbors;let s=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];s+=l===s_||p<f?1:0,s+=c===s_||f<g?1:0,s+=h===s_||g<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];(l===s_||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===s_||f<g)&&(n[o++]=f,n[o++]=g,n[o++]=a,n[o++]=c),(h===s_||g<p)&&(n[o++]=g,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function nlt(e){const t=e.faces.length/3,i=e.vertices.position,r=e.faces,s=Dk.v0,n=Dk.v1,o=Dk.v2,a=new Float32Array(3*t);for(let l=0;l<t;l++){const c=r[3*l+0],h=r[3*l+1],p=r[3*l+2];i.getVec(c,s),i.getVec(h,n),i.getVec(p,o),de(n,n,s),de(o,o,s),dt(s,n,o),be(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"})(_L||(_L={}));const M9={edge:{position0:M(),position1:M(),faceNormal0:M(),faceNormal1:M(),componentIndex:0,cosAngle:0},ortho:M(),fwd:M()},Dk={v0:M(),v1:M(),v2:M()},olt={anglePlanar:4,angleSignificantEdge:35};function alt(e){const t=x`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}function llt(e,t){e.vertex.include(alt),e.include(Lx,t);const i=e.vertex;i.uniforms.add("depthBias","vec2"),i.uniforms.add("inverseViewport","vec2"),t.legacy?(i.uniforms.add("view","mat4"),i.uniforms.add("proj","mat4")):i.uniforms.add("transformNormalViewFromGlobal","mat3"),t.legacy?i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
float offsetZ  = depthBias.y;
vec4 projNormal = proj * view * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`):i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
float offsetZ  = depthBias.y;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`),i.code.add(x`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function clt(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(x`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(x`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function ult(e,t){const i=e.vertex;t.silhouette?(i.code.add(x`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function w_e(e,t){const i=e.vertex;i.uniforms.add("distanceFalloffFactor","float"),i.code.add(x`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("componentDataTex","sampler2D"),i.uniforms.add("componentDataTexInvDim","vec2"),e.attributes.add(E.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(x`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * componentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(componentDataTex, colorIndex);
vec4 otherValue = texture2D(componentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),t.legacy?i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (view * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("transformNormalGlobalFromModel","mat3"),i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(E.NORMALA,"vec3"),e.attributes.add(E.NORMALB,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add(E.NORMAL,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
return (model * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (view * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return proj * vec4(position, 1.0);
}`):(e.vertex.include(sq,t),i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return transformViewFromCameraRelativeRS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`)),i.code.add(x`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function x_e(e){return e.mode===rs.SKETCH||e.mode===rs.MIXED}var rs;(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"})(rs||(rs={}));function hlt(e,t){const i=e.vertex;switch(t.mode){case rs.SKETCH:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case rs.MIXED:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case rs.SOLID:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function Bq(e,t){const i=e.vertex;switch(e.include(w_e,t),e.attributes.add(E.SIDENESS,"vec2"),t.mode===rs.MIXED?i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case rs.MIXED:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case rs.SKETCH:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case rs.SOLID:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case rs.COUNT:break;default:t.mode}}function dlt(e,t){const i=e.vertex;switch(e.include(Bq,t),x_e(t)&&i.uniforms.add("strokesAmplitude","float"),t.mode){case rs.SOLID:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case rs.SKETCH:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case rs.MIXED:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function plt(e,t){const i=e.vertex;e.include(Bq,t);const r=e.fragment;switch(x_e(t)&&(i.uniforms.add("strokesTextureScale","vec2"),i.uniforms.add("strokesLog2Resolution","float"),i.uniforms.add("strokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add("strokesTexture","sampler2D"),r.uniforms.add("strokesNormalizationScale","float"),i.code.add(x`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * strokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(Yh),r.code.add(x`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case rs.SOLID:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(x`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case rs.SKETCH:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(x`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case rs.MIXED:e.varyings.add("vType","float"),i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(x`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function flt(e){const t=new Ri,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add("model","mat4"),e.antialiasing&&(i.code.add(x`#define ANTIALIASING 1`),r.code.add(x`#define ANTIALIASING 1`)),t.include(llt,e),t.include(dlt,e),t.include(w_e,e),t.include(Bq,e),t.include(plt,e),t.include(Rr,e),t.include(ult,e),t.include(clt,e),t.include(hlt,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("pixelToNDC","vec2"),i.uniforms.add("ndcToPixel","vec2"),i.uniforms.add("pixelRatio","float"),t.attributes.add(E.POSITION0,"vec3"),t.attributes.add(E.POSITION1,"vec3"),t.attributes.add(E.VARIANTOFFSET,"float"),t.attributes.add(E.VARIANTSTROKE,"float"),t.attributes.add(E.VARIANTEXTENSION,"float"),i.code.add(x`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),e.multipassTerrainEnabled&&(t.fragment.include(As),t.include(yc,e)),t.fragment.code.add(x`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}const mlt=Object.freeze({__proto__:null,build:flt}),glt=-4e-4,ylt=.5;class dR extends Vi{bindPass(t){const i=this.program,{edgeRenderParameters:r,bindParameters:s}=t;g0e(i,r.viewProjectionTransform),i.setUniformMatrix3fv("transformNormalViewFromGlobal",r.transformNormalViewFromGlobal),i.setUniformMatrix4fv("proj",s.camera.projectionMatrix),i.setUniform2f("depthBias",ylt,glt),i.setUniform2f("pixelToNDC",2/s.camera.fullViewport[2],2/s.camera.fullViewport[3]),i.setUniform2f("ndcToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2),i.setUniform1f("distanceFalloffFactor",r.distanceFalloffFactor),i.setUniform2f("inverseViewport",1/s.camera.fullViewport[2],1/s.camera.fullViewport[3]),i.setUniform1f("pixelRatio",s.camera.pixelRatio||1)}initializeProgram(t){const i=dR.shader.get(),r=this.configuration,s=i.build({slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:r.silhouette,legacy:r.legacy,antialiasing:r.antialiasing,mode:r.mode,doublePrecisionRequiresObfuscation:r.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Oi(t.rctx,s,O9)}initializePipeline(t){const i=t.rctx.capabilities.blendMinMax;return Rt(i?{blending:Vn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ONE,fp.ADD,i.MAX),depthTest:{func:Di.LEQUAL},colorWrite:Ft}:{depthTest:{func:Di.LEQUAL},depthWrite:Aa,colorWrite:Ft})}}dR.shader=new Li(mlt,()=>import("./EdgeShaderProgram.glsl.6b1e454d.js"));class Rf extends dr{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=rs.SOLID,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Y()],Rf.prototype,"slicePlaneEnabled",void 0),u([Y()],Rf.prototype,"silhouette",void 0),u([Y()],Rf.prototype,"legacy",void 0),u([Y()],Rf.prototype,"antialiasing",void 0),u([Y({count:rs.COUNT})],Rf.prototype,"mode",void 0),u([Y()],Rf.prototype,"doublePrecisionRequiresObfuscation",void 0),u([Y()],Rf.prototype,"multipassTerrainEnabled",void 0),u([Y()],Rf.prototype,"cullAboveGround",void 0);const vlt=8,Lk=128,_lt={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class blt{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const wlt={solid:rs.SOLID,sketch:rs.SKETCH,uber:rs.MIXED};class HA{constructor(t,i,r){this.rctx=t,this.shaderTechniqueRepository=i,this.config=new Rf,this.technique=null,this.refCount=new blt,this.renderables=new Set,this.sortedRenderables={[At.TRANSPARENT]:{[At.TRANSPARENT]:new $t,[At.OPAQUE]:new $t},[At.OPAQUE]:{[At.TRANSPARENT]:new $t,[At.OPAQUE]:new $t}},this.renderablesDirty=!1,this.settings=I(I({},_lt),r),this.key=HA.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const s=this.settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:hi.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=wlt[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=xF(t)}dispose(){this.technique=Wi(this.technique)}addRenderable(t){this.renderables.add(t),this.renderablesDirty=!0}removeRenderable(t){this.renderables.delete(t),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(t,i){this.renderablesDirty&&this._sortRenderables(),this.sortedRenderables[i][At.TRANSPARENT].forAll(t),this.sortedRenderables[i][At.OPAQUE].forAll(t)}setMultipassParameters(t){this.config.multipassTerrainEnabled=!!t.multipassTerrainEnabled&&t.multipassTerrainEnabled,this.config.cullAboveGround=!!t.cullAboveGround&&t.cullAboveGround}bindRegularEdges(t,i){this.setMultipassParameters(t),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(dR,this.config,this.technique),this.rctx.useTechnique(this.technique,t.slot),this.technique.bindPass({bindParameters:t,edgeRenderParameters:i})}bindSilhouetteEdges(t,i){this.setMultipassParameters(t),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(dR,this.config,this.technique),this.rctx.useTechnique(this.technique,t.slot),this.technique.bindPass({bindParameters:t,edgeRenderParameters:i})}renderRegularEdges(t,i,r){this._render(t,t.regular.vao,i,r)}renderSilhouetteEdges(t,i,r){this._render(t,t.silhouette.vao,i,r)}_render(t,i,r,s){this._setUniforms(t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(Tt.TRIANGLE_FAN,0,4,s)}_setUniforms(t,i){const r=this.technique.program;if(t.components.buffer.textureBuffer.bind(r,xlt,Tlt),i.multipassTerrainEnabled&&(r.setUniform2fv("nearFar",i.camera.nearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),Um(r,i)),"origin"in t.transform)r.setUniformMatrix4fv("view",i.localViewMatrixForEdges),r.setUniformMatrix4fv("model",t.transform.modelMatrix),v0(r,this.settings,i.slicePlane,{origin:t.transform.origin.vec3});else{const s=new QF(t.transform.position),n=Au(dre,w1(dre,t.transform.rotationScale)),o=new l_e;ne(o.transformWorldFromModelTL,s.low),ne(o.transformWorldFromModelTH,s.high),RC(o.transformWorldFromModelRS,t.transform.rotationScale),RC(o.transformNormalGlobalFromModel,n),m0e(r,o),r.setUniformMatrix3fv("transformNormalGlobalFromModel",o.transformNormalGlobalFromModel);const a=i.camera.viewInverseTransposeMatrix,l=oe(Slt,a[3],a[7],a[11]);v0(r,this.settings,i.slicePlane,{origin:l})}this.settings.type!=="uber"&&this.settings.type!=="sketch"||this._setSketchUniforms(r)}_setSketchUniforms(t){const i=this.settings.strokesTexture,r=i.texture;O(r)||(t.bindTexture(r,"strokesTexture"),t.setUniform2f("strokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),t.setUniform1f("strokesLog2Resolution",Math.log2(i.resolution)),t.setUniform1f("strokesNormalizationScale",i.normalizationScale),t.setUniform1f("strokesAmplitude",i.amplitude),t.setUniform1f("strokeVariants",i.variants))}_sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[At.TRANSPARENT][At.TRANSPARENT].clear(),this.sortedRenderables[At.TRANSPARENT][At.OPAQUE].clear(),this.sortedRenderables[At.OPAQUE][At.TRANSPARENT].clear(),this.sortedRenderables[At.OPAQUE][At.OPAQUE].clear(),this.renderables.forEach(i=>{i.objectTransparency!==At.INVISIBLE&&i.edgeTransparency!==At.INVISIBLE&&this.sortedRenderables[i.objectTransparency][i.edgeTransparency].push(i)});const t=(i,r)=>"origin"in i.transform&&"origin"in r.transform?i.transform.origin.id<r.transform.origin.id?-1:i.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[At.TRANSPARENT][At.TRANSPARENT].sort(t),this.sortedRenderables[At.TRANSPARENT][At.OPAQUE].sort(t),this.sortedRenderables[At.OPAQUE][At.TRANSPARENT].sort(t),this.sortedRenderables[At.OPAQUE][At.OPAQUE].sort(t)}static getKey(t,i,r){return`edges-t:${t}:${i}:${r}`}}const xlt="componentDataTex",Tlt="componentDataTexInvDim",dre=om(),Slt=M();function pre(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:Elt(e.layout)}}function fre(e){return Alt(e.layout).createView(e.buffer)}function Elt(e){const t=new Array;return e.fields.forEach((i,r)=>{const s=me(I({},i),{constructor:T_e(i.constructor)});t.push([r,s])}),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}function Alt(e){const t=Nr();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach(i=>t.fields.set(i[0],me(I({},i[1]),{constructor:Rlt(i[1].constructor)}))),t}const Clt=[qR,Ru,Ti,Js,qh,IT,$T,DT,jr,x1,c0,u0,_m,T1,h0,Ca,S1,LT,E1,d0,A1,NT,MC,PC,FT,C1,IC,$C,DC,R1,LC,NC,FC,UC,kC,zC];function T_e(e){return`${e.ElementType}_${e.ElementCount}`}function Rlt(e){return S_e.get(e)}const S_e=new Map;Clt.forEach(e=>S_e.set(T_e(e),e));function mre(e,t,i){const r=t/3,s=new Uint32Array(i+1),n=new Uint32Array(i+1),o=(w,S)=>{w<S?s[w+1]++:n[S+1]++};for(let w=0;w<r;w++){const S=e[3*w],T=e[3*w+1],A=e[3*w+2];o(S,T),o(T,A),o(A,S)}let a=0,l=0;for(let w=0;w<i;w++){const S=s[w+1],T=n[w+1];s[w+1]=a,n[w+1]=l,a+=S,l+=T}const c=new Uint32Array(6*r),h=s[i],p=(w,S,T)=>{if(w<S){const A=s[w+1]++;c[2*A]=S,c[2*A+1]=T}else{const A=n[S+1]++;c[2*h+2*A]=w,c[2*h+2*A+1]=T}};for(let w=0;w<r;w++){const S=e[3*w],T=e[3*w+1],A=e[3*w+2];p(S,T,w),p(T,A,w),p(A,S,w)}const f=(w,S)=>{const T=2*w,A=S-w;for(let C=1;C<A;C++){const R=c[T+2*C],L=c[T+2*C+1];let U=C-1;for(;U>=0&&c[T+2*U]>R;U--)c[T+2*U+2]=c[T+2*U],c[T+2*U+3]=c[T+2*U+1];c[T+2*U+2]=R,c[T+2*U+3]=L}};for(let w=0;w<i;w++)f(s[w],s[w+1]),f(h+n[w],h+n[w+1]);const g=new Int32Array(3*r),y=(w,S)=>w===e[3*S]?0:w===e[3*S+1]?1:w===e[3*S+2]?2:-1,v=(w,S)=>{const T=y(w,S);g[3*S+T]=-1},b=(w,S,T,A)=>{const C=y(w,S);g[3*S+C]=A;const R=y(T,A);g[3*A+R]=S};for(let w=0;w<i;w++){let S=s[w];const T=s[w+1];let A=n[w];const C=n[w+1];for(;S<T&&A<C;){const R=c[2*S],L=c[2*h+2*A];R===L?(b(w,c[2*S+1],L,c[2*h+2*A+1]),S++,A++):R<L?(v(w,c[2*S+1]),S++):(v(L,c[2*h+2*A+1]),A++)}for(;S<T;)v(w,c[2*S+1]),S++;for(;A<C;)v(c[2*h+2*A],c[2*h+2*A+1]),A++}return g}async function Olt(e){const t=Mlt(e),i=Vq(t),r=[t.data.buffer];return{result:Plt(i,r),transferList:r}}function Vq(e){const t=Ilt(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return gre.updateSettings(e.writerSettings),yre.updateSettings(e.writerSettings),elt(t,gre,yre)}function Mlt(e){return{data:mL.createView(e.dataBuffer),indices:e.indicesType==="Uint32Array"?new Uint32Array(e.indicesBuffer):e.indicesType==="Uint16Array"?new Uint16Array(e.indicesBuffer):void 0,indicesLength:e.indicesLength,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate}}function Plt(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:pre(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:pre(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}function Ilt(e,t,i,r){if(t)return{faces:i,facesLength:r,neighbors:mre(i,r,e.count),vertices:e};const s=Rye(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:r}),n=mre(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:mL.createView(s.buffer)}}const gre=new yL,yre=new vL;var $lt=Object.freeze(Object.defineProperty({__proto__:null,work:Vq,wrappedWork:Olt},Symbol.toStringTag,{value:"Module"}));class Dlt extends Rve{constructor(t){super("EdgeProcessingWorker","wrappedWork",t)}async process(t,i,r){if(r)return Vq(t);const s=this._packInput(t),n=await this.invoke(s,i);return this._unpackOutput(n)}getTransferList(t){return[t.dataBuffer]}_packInput(t){return{dataBuffer:t.data.buffer,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate,indicesBuffer:t.indices.buffer,indicesType:s$(t.indices)?"Uint32Array":"Uint16Array",indicesLength:t.indicesLength}}_unpackOutput(t){return{regular:{instancesData:fre(t.regular.instancesData),lodInfo:{lengths:new Float32Array(t.regular.lodInfo.lengths)}},silhouette:{instancesData:fre(t.silhouette.instancesData),lodInfo:{lengths:new Float32Array(t.silhouette.lodInfo.lengths)}},averageEdgeLength:t.averageEdgeLength}}}function Llt(e){const i=N2.resolution,r=i/2,s=new Uint8Array(4*i*i),n=4*i*r,o=N2.amplitude,a=2*o,l=4*i,c=Math.log2(i)+1,h=N2.strokes.length;let p=(c-1)*h*l;for(const{distance:g,pressure:y}of N2.strokes){let v=g,b=y,w=p;for(let S=0;S<c;S++){S!==0&&(v=vre(v,pR.DISTANCE),b=vre(b,pR.PRESSURE));for(let T=0;T<N2.resolution;T++){const A=.5+(v?v[T%v.length]/a:0),C=b?b[T%b.length]:1;qD(A,s,w),qD(C,s,w+n),w+=4}w-=l*(h+1)}p+=l}const f=new Ze(e,{pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:Ve.LINEAR,width:i,height:i,wrapMode:lt.REPEAT},s);return new Flt(i,a,o,h,f)}function vre(e,t){if(!e)return null;const i=e.length/2,r=Nlt*i,s=new Array(i);let n=0;const o=t===pR.PRESSURE;for(let a=0;a<e.length;a+=2){const l=(e[a]+e[a+1])/2;s[n++]=o?Math.min(r,1-(1-l)*_re):Math.min(r,l*_re)}return s}var pR;(function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"})(pR||(pR={}));const Nlt=.1,_re=.5;class Flt{constructor(t,i,r,s,n){this.resolution=t,this.normalizationScale=i,this.amplitude=r,this.variants=s,this.texture=n}dispose(){this.texture=et(this.texture)}}const N2={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function bre(e){let t=null;for(const i of e){const r=i.type;if(Ult(i)){if(O(t))t=r;else if(t!==r)return"uber"}}return _(t)?t:"uber"}function Nk(e){let t=At.INVISIBLE;for(const{material:i}of e)if(E_e(i)){if(i.color[3]*i.opacity<1)return At.TRANSPARENT;t=At.OPAQUE}return t}function Fk(e){let t=At.INVISIBLE;for(const{material:i}of e)if(E_e(i)){switch(i.objectTransparency){case At.TRANSPARENT:case At.INVISIBLE:return At.TRANSPARENT;case At.OPAQUE:if(i.opacity<1)return At.TRANSPARENT}t=At.OPAQUE}return t}function E_e(e){return e.size*e.color[3]*e.opacity>0}function Ult(e){return e.size*e.color[3]>0}function klt(e,t){const i=z1e(e,t,!0);return i===-1?t<e[0]?0:e.length:i}function wre(e,t,i){return e.length-klt(e,t*i.minimumEdgeLength)}function xre(e,t,i,r){for(let s=0;s<e.length;s++){const n=e[s].index,o=t[s],a=t[s+1];if(r)for(let l=o;l<a;l++){const c=r[l];i.set(c,n)}else for(let l=o;l<a;l++)i.set(l,n)}}const zlt=he.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let Ud=class extends we{constructor(e){super(e),this.updatingHandles=new rp,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges={[At.TRANSPARENT]:0,[At.OPAQUE]:0},this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=M(),this.localOrigins=new Zat(new eq(e.renderSR))}initialize(){this.worker=new Dlt(this.schedule),this.componentColorManager=new u_e(this.rctx,2);const e=v_e.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,t===0||t===3?0:1),e.sideness.set(t,1,t===0||t===1?0:1);this.verticesBufferObject=jt.createVertex(this.rctx,ri.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach(e=>this._discardObjectEntry(e)),this.perObjectData.clear(),this.strokesTexture=et(this.strokesTexture),this.componentColorManager=it(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=et(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges[At.TRANSPARENT]+this.numberOfRenderedEdges[At.OPAQUE]}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,n,o,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let l;const c=new Tre(new Promise(p=>l=p),i.center,i.radius);this.perObjectData.set(e,c);const h=await this.updatingHandles.addPromise(this._addComponentGeometry(t,c,r,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void zlt.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(e);let n;(s==null?void 0:s.renderables.length)>0&&this.perObjectDataEvictionCache.add(s);const o=e.boundingVolumeWorldSpace.bounds,a=new Tre(new Promise(c=>n=c),mc(o),aN(o));this.perObjectData.set(e,a);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&Vlt(e))l.push(this._addObjectMergedGeometries(e,a,t,i,r));else for(let c=0;c<e.geometries.length;c++){const h=e.geometryRecords[c];if(!h.material.supportsEdges)continue;const p=e.geometries[c];l.push(this._addGeometry(e,a,p,h,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach(t=>this._removeRenderable(t)),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?r=>t[r]:()=>t;(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(r=>{const s=r.components.meta.length;for(let n=0;n<s;n++){const o=i(n),a=r.components.meta[n],l=a.index;a.material.opacity=o,r.components.buffer.textureBuffer.setDataElement(l,1,3,255*o)}this._updateTransparency(r)}),this.setNeedsRender()}async getObjectMemoryUsage(e){return(await this._getObjectEntry(e)).renderables.reduce((t,i)=>t+i.statistics.gpuMemoryUsage,0)}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof Bm,n=!!i.slicePlaneEnabled,o=bre(t),a=HA.getKey(o,n,s);(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(l=>{if(a!==l.rendererKey){const c=this.renderers.get(l.rendererKey),h=this._acquireRenderer(o,n,s);c.removeRenderable(l),c.refCount.decrement(),l.rendererKey=a,h.addRenderable(l)}for(let c=0;c<t.length;c++)l.components.meta[c].material=t[c];r&&this._updateComponentBuffer(l.components),this._updateTransparency(l)}),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(i=>i.visible=t),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach((e,t)=>this.removeObject(t))}render(e,t){if(this.numberOfRenderedEdges[t]=0,O(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=M(),s=new QF,n=new f0e,o=br();oe(r,i[3],i[7],i[11]),s.set(r),ne(n.transformWorldFromViewTH,s.high),ne(n.transformWorldFromViewTL,s.low),Eu(n.transformViewFromCameraRelativeRS,e.camera.viewMatrix),Lr(n.transformProjFromView,e.camera.projectionMatrix);const a=br();Au(a,n.transformViewFromCameraRelativeRS),w1(o,a);let l=0,c=0;if(this.renderers.forEach(p=>{p.refCount.value===0?(this.renderers.delete(p.key),p.dispose()):p.forEachRenderable(f=>{f.visible&&(l+=f.statistics.averageEdgeLength,c++)},t)}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),c===0)return;const h={distanceFalloffFactor:40*l/c,minimumEdgeLength:e.camera.perScreenPixelRatio,transparency:t,viewProjectionTransform:n,transformNormalViewFromGlobal:o};this._updateObjectCameraDistances(e),this.renderers.forEach(p=>{this._renderRegularEdges(p,e,h),this._renderSilhouetteEdges(p,e,h)})}_updateTransparency(e){const t=Nk(e.components.meta),i=Fk(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),_(t.origin))this.localOrigins.register(t.origin);else{const r=oe(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(r)}return Xat(t.origin.vec3,i),t.origin}_updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let r=0;r<t.length;r++){const s=t[r].material,n=t[r].index,o=ze(Math.round(s.size*vlt),0,255),a=ze(s.extensionLength,-Lk,255-Lk)+Lk,l=s.type==="solid"?_L.SOLID:_L.SKETCH,c=255*s.opacity,h=s.color,p=255*h[0],f=255*h[1],g=255*h[2],y=255*h[3];i.textureBuffer.setData(n,0,p,f,g,y),i.textureBuffer.setData(n,1,o,a,l,c)}}_createComponentBuffers(e){if(O(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let s=0;s<e.length;s++){const n=e[s],o=i.acquireIndex();t.push({index:o,material:n})}const r={meta:t,buffer:i};return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,n=s.length){return this.worker.process({data:t,indices:s,indicesLength:n,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}_createEdgeResources(e){const t={};if(O(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new as(this.rctx,O9,{vertices:ure,instances:yL.glLayout},{vertices:this.verticesBufferObject,instances:jt.createVertex(this.rctx,ri.STATIC_DRAW,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new as(this.rctx,O9,{vertices:ure,instances:vL.glLayout},{vertices:this.verticesBufferObject,instances:jt.createVertex(this.rctx,ri.STATIC_DRAW,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async _addGeometry(e,t,i,r,s,n,o){const a=i.vertexAttributes.get(E.POSITION),l=i.indices.get(E.POSITION),c=Te(),h={position:a,indices:l,modelTransform:c,origin:this._computeModelTransformWithLocalOrigin(e,r,c)};return this._addPositionData(t,h,i.edgeIndicesLength,s,n,o)}async _addPositionData(e,t,i,r,s,n=!1){if(e.loaded==null)return;const o=this._createComponentBuffers([r]);if(O(o)||i<=0)return;const a=this._acquireRenderer(r.type,!!s.slicePlaneEnabled),{modelTransform:l,origin:c}=t,h=t.indices,p=t.position,f=p.data.length/p.size,g=mL.createBuffer(f);for(let T=0;T<f;T++)g.position.set(T,0,p.data[T*p.size+0]),g.position.set(T,1,p.data[T*p.size+1]),g.position.set(T,2,p.data[T*p.size+2]);xre(o.meta,[0,g.componentIndex.count],g.componentIndex);const y=await this.updatingHandles.addPromise(this._extractEdges(a.writerSettings,g,!1,n,h,i));if(e.loaded==null)return;const{regular:v,silhouette:b}=this._createEdgeResources(y),w=(v?v.vao.size:0)+(b?b.vao.size:0),S={regular:v,silhouette:b,transform:{modelMatrix:l,origin:c},statistics:{gpuMemoryUsage:w,externalMemoryUsage:!1,averageEdgeLength:y.averageEdgeLength},components:o,visible:!0,edgeTransparency:Nk(o.meta),objectTransparency:Fk(o.meta),distanceToCamera:0,rendererKey:a.key};e.renderables.push(S),a.addRenderable(S),this.gpuMemoryUsage+=w}async _addComponentGeometry(e,t,i,r,s,n,o){if(t.loaded==null)return 0;const a=this._createComponentBuffers(n);if(O(a))return 0;const l=bre(n),c=this._acquireRenderer(l,o.slicePlaneEnabled||!1,!1),h=mL.createBuffer(i.count);lq(h.position,i),xre(a.meta,s,h.componentIndex,r);const p=!0,f=c.writerSettings,g=await this.updatingHandles.addPromise(this._extractEdges(f,h,p,!1,r));if(t.loaded==null)return 0;const{regular:y,silhouette:v}=this._createEdgeResources(g),b=(y?y.vao.size:0)+(v?v.vao.size:0),w={regular:y,silhouette:v,transform:e,statistics:{gpuMemoryUsage:b,externalMemoryUsage:!0,averageEdgeLength:g.averageEdgeLength},components:a,visible:!0,edgeTransparency:Nk(a.meta),objectTransparency:Fk(a.meta),distanceToCamera:0,rendererKey:c.key};return t.renderables.push(w),c.addRenderable(w),b}async _addObjectMergedGeometries(e,t,i,r,s){const n=new Map;let o=0,a=null,l=0;for(let w=0;w<e.geometries.length;w++){const S=e.geometries[w],T=e.geometryRecords[w];if(!T.material.supportsEdges)continue;!a&&T.origin&&(a=T);const A=S.vertexAttributes.get(E.POSITION);l+=A.data.length/A.size,o+=S.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let w=0;w<e.geometries.length;w++){const S=e.geometries[w];if(!e.geometryRecords[w].material.supportsEdges)continue;const T=S.vertexAttributes.get(E.POSITION),A=S.indices.get(E.POSITION);let C=n.get(T.data);if(C==null){C=p.length/3;for(let R=0;R<T.data.length;R+=T.size)p.push(T.data[R+0]),p.push(T.data[R+1]),p.push(T.data[R+2]);n.set(T.data,C)}if(A)for(let R=0;R<S.edgeIndicesLength;R++)h[f++]=C+A[R]}const g=a||e.geometryRecords[0],y=Te(),v=this._computeModelTransformWithLocalOrigin(e,g,y);for(let w=0;w<e.geometryRecords.length;w++)e.geometryRecords[w].origin=v;const b={position:{data:p,size:3},indices:h,modelTransform:y,origin:v};await this.updatingHandles.addPromise(this._addPositionData(t,b,h.length,i[0],r,s))}_acquireRenderer(e,t,i=!0){const r=HA.getKey(e,t,i);let s=this.renderers.get(r);return O(this.strokesTexture)&&(this.strokesTexture=Llt(this.rctx)),s||(s=new HA(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}_removeRenderable(e){Blt(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const i of e.components.meta)e.components.buffer.releaseIndex(i.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=M(),s=n=>{const{center:o,radius:a}=n;lp(r,o,t);const l=_e(r,i),c=l<-a?1/0:l<a?0:l-a;n.renderables.forEach(h=>h.distanceToCamera=c)};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable(s=>{if(!s.visible||!s.regular)return;const n=wre(s.regular.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderRegularEdges(s,t,n),this.numberOfRenderedEdges[r]+=n},r)}_renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable(s=>{if(!s.visible||!s.silhouette)return;const n=wre(s.silhouette.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderSilhouetteEdges(s,t,n),this.numberOfRenderedEdges[r]+=n},r)}};function Blt(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function Vlt(e){let t=null,i=null;for(let s=0;s<e.geometries.length;s++){var r;const n=e.geometryRecords[s];if(n.material.supportsEdges){if(t){if(!J_(t,n.transformation))return!1}else t=n.transformation;if(!i&&_(n.origin))i=n;else if(_((r=i)==null?void 0:r.origin)&&_(n.origin)&&i.origin.id!==n.origin.id)return!1}}return!0}u([d({constructOnly:!0})],Ud.prototype,"rctx",void 0),u([d({constructOnly:!0})],Ud.prototype,"renderSR",void 0),u([d({constructOnly:!0})],Ud.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],Ud.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],Ud.prototype,"schedule",void 0),u([d({readOnly:!0})],Ud.prototype,"updatingHandles",void 0),u([d({readOnly:!0})],Ud.prototype,"updating",null),Ud=u([P("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Ud);class Tre{constructor(t,i,r){this.center=i,this.radius=r,this.renderables=new Array,this.loaded=t,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}function A_e(e){const t=e.capabilities.disjointTimerQuery;return O(t)?null:t.timestampBits()>0?new Glt(t):P9?null:new jlt(t)}class Glt{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start)}stop(t,i=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this._checkQueryResult(t,i)}_checkQueryResult(t,i){if(!this.timer.resultAvailable(this.end))return void setTimeout(()=>this._checkQueryResult(t,i),i);if(this.timer.disjoint())return void t(null);const r=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-r)/1e6)}}class jlt{constructor(t){this.timer=t,this.query=t.createQuery(),P9=!0,this.timer.beginTimeElapsed(this.query)}stop(t,i=50){this.timer.endTimeElapsed(),P9=!1,this._checkQueryResult(t,i)}_checkQueryResult(t,i){const r=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!r||s)s?t(null):setTimeout(()=>this._checkQueryResult(t,i),i);else{const n=this.timer.getResult(this.query);t(n/1e6)}}}let P9=!1;var Zr;(function(e){e[e.Prepare=0]="Prepare",e[e.Shadowmap=1]="Shadowmap",e[e.Lineardepth=2]="Lineardepth",e[e.Normals=3]="Normals",e[e.SSAO=4]="SSAO",e[e.Opaque=5]="Opaque",e[e.OpaqueEdges=6]="OpaqueEdges",e[e.Transparent=7]="Transparent",e[e.TransparentEdges=8]="TransparentEdges",e[e.Hudvisibility=9]="Hudvisibility",e[e.TransparentTerrain=10]="TransparentTerrain",e[e.Atmosphere=11]="Atmosphere",e[e.Laserline=12]="Laserline",e[e.Occluded=13]="Occluded",e[e.Antialiasing=14]="Antialiasing",e[e.Highlights=15]="Highlights",e[e.HudOccluded=16]="HudOccluded",e[e.HudNotoccluded=17]="HudNotoccluded"})(Zr||(Zr={}));const Hlt=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class qlt extends Vy{constructor(){super("total"),this.total=0,this.frameCount=0}}class Wlt{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new qlt,this.gpuTime=new Vy("gpu",9),this.renderPassTimings=Hlt.map(t=>new Vy(t))}get elapsedTime(){return performance.now()-this._startTime}enableGPUTimer(){return++this._enableGPUTimer,{remove:L9(()=>--this._enableGPUTimer)}}prerender(t){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=A_e(t))}advance(t){const i=performance.now();this.renderPassTimings[t].record(i-this._lastSample),this._lastSample=i}postrender(){_(this._gpuTimer)&&(this._gpuTimer.stop(i=>_(i)&&this.gpuTime.record(i),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++}}const Sre=.9;let Of=class extends we{constructor(e,t,i,r,s,n,o,a,l){super({}),this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=n,this._requestRender=o,this._stage=l,this._materialRenderers=new Map,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new Wlt,this._antialiasing=g_.SMAA,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new r0e,this._hasAnimations=!1,this._animationTimestep=0,this._handles=new Bt,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new KE(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new _at(this._rctx,this._compositingHelper),this._sliceHelper=new Vat,this._shadowMap=new p_e(this._rctx,l.viewingMode,2),this._ssaoHelper=new Wat(i,this._rctx,()=>this._requestRender()),this._highlightHelper=new mat(i,this._rctx),this._shadowHighlightHelper=new Bat(this._rctx,l.viewingMode),this._shadowAccumulator=new eo(this._rctx,i,l,(c,h)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(c,h),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled},(c,h,p,f)=>{c.start(p,h,f),this._renderShadowCascades(De.MATERIAL_DEPTH_SHADOWMAP_ALL,c),p.setGLViewport(this._rctx),this._ensureCameraBindParameters(p)},()=>this._requestRender()),this._bindParameters={slot:null,camera:null,inverseViewport:Xe(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:ss,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._renderContext=new VXe(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ss,ssrEnabled:!1},this._renderPlugins=new xat({renderContext:this._renderContext,shaderTechniqueRepository:i,textureRep:t,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:a}),this.renderPassManager=new cat(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([Wt(hi,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",c=>{this._renderHiddenTransparentEdges=c?()=>this._renderEdges(At.TRANSPARENT):()=>{},this._requestRender()}),Wt(this._stage,"camera",()=>this._requestRender(),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._edgeView=it(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=et(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),WN.prune(),this._content.clear()}disposeOffscreenBuffers(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing===g_.SMAA&&this._smaaPass.updating||_(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return O(this._edgeView)&&(this._edgeView=new Ud({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",()=>this._requestRender(),!0)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._bindParameters.reprojectionMatrix===null||j6(this._bindParameters.reprojectionMatrix,ss)}set _reprojectionMatrix(e){j6(this._bindParameters.reprojectionMatrix,e)||(this._bindParameters.reprojectionMatrix=e,this.notifyChange("isCameraFinal"))}get hasShadowsEnabled(){var e;return!((e=this._shadowMap)==null||!e.enabled)}setRenderParameters(e){const{renderPassManager:t,_shadowMap:i,_ssaoHelper:r}=this;e.screenSpaceReflectionsEnabled!==void 0&&t.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(t.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this._requestRender()),e.fillLightsEnabled!==void 0&&t.fillLightsEnabled!==e.fillLightsEnabled&&(t.fillLightsEnabled=e.fillLightsEnabled,this._requestRender()),e.shadowMap===void 0||i.enabled===e.shadowMap&&t.shadowCastingEnabled===e.shadowMap||(i.enabled=e.shadowMap,t.shadowCastingEnabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.ssao!==void 0&&r.enabled!==e.ssao&&(r.enabled=e.ssao,this._requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const s=e.antialiasingEnabled?g_.SMAA:g_.NONE;e.antialiasingEnabled!==void 0&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),e.highQualityTransparency!==void 0&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),e.defaultHighlightOptions!==void 0&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),e.slicePlane!==void 0&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),e.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=e.waterReflectionEnabled,this._requestRender()),e.fillLightsEnabled!==void 0&&this._hasFillLights!==e.fillLightsEnabled&&(this._hasFillLights=e.fillLightsEnabled,this._requestRender()),e.opaqueTerrain!==void 0&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this._requestRender()),e.hasOverlayWater!==void 0&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),e.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(t.length===0&&i.length===0&&r.length===0)return;i.forAll(({id:o})=>this._content.delete(o)),t.forAll(o=>this._content.set(o.id,o));const s=Iye(e);let n=!1;s.forEach((o,a)=>{let l=this._materialRenderers.get(a);if(!l){if(!(o.adds.length>0))return;l=new Uye(this._rctx,this._materialRepository,a),this._materialRenderers.set(a,l)}l.modify(o),l.isEmpty&&(n=!0)}),n&&this._materialRenderers.forEach((o,a)=>{o.isEmpty&&(this._materialRenderers.delete(a),o.dispose())}),this._hasHighlights=Vr(this._materialRenderers,o=>o.hasHighlights),this._hasOccludees=Vr(this._materialRenderers,o=>o.hasOccludees),this._hasWater=Vr(this._materialRenderers,o=>o.hasWater),this._needsTransparentPass=Vr(this._materialRenderers,o=>o.requiresSlot(ye.TRANSPARENT_MATERIAL,De.MATERIAL)),this._hasHUDElements=Vr(this._materialRenderers,o=>o.requiresSlot(ye.LINE_CALLOUTS_HUD_DEPTH,De.MATERIAL)||o.requiresSlot(ye.HUD_MATERIAL,De.MATERIAL)||o.requiresSlot(ye.LABEL_MATERIAL,De.MATERIAL)),this._requestRender()}updateAnimation(e){return this._hasAnimations=!1,this._materialRenderers.forEach(t=>this._hasAnimations=t.updateAnimation(e)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}get animationTimestep(){return this._animationTimestep}updateLightSources(e,t,i){this._lighting.groundLightingFactor=t,this._lighting.globalFactor=i,this._lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=this._bindParameters.transparencyPassType=at.NONE,this._renderContext.hasFillLights=this._bindParameters.hasFillLights=this._hasFillLights;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const n=this._sliceHelper.plane;r===b1.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(t,i),this.performanceInfo.advance(Zr.Prepare);const o=this._computeDepthRange(t);this._renderShadowMap(e,t,this._lighting.lightingMainDirection,o),this.performanceInfo.advance(Zr.Shadowmap),s.initializeFrame(t),this._ensureBindParameters(t),this._renderLinearDepth(),this.performanceInfo.advance(Zr.Lineardepth),this._accumulateShadows(o,t,i),this._renderNormal(),this.performanceInfo.advance(Zr.Normals),this._ensureBindParametersSSR(),this._ensureBindParametersCloudsReflections(),this._ssaoHelper.computeSSAO(t,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(Zr.SSAO),this._renderContext.pass=De.MATERIAL,s.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Zr.Opaque);const a=this._multipassTerrain&&!this._opaqueTerrain;this._renderTerrainLinearDepth(a),this._setMultipassFlags(a),this._setTerrainCulling(a),this._renderEdges(At.OPAQUE),this.performanceInfo.advance(Zr.OpaqueEdges),this._renderHiddenTransparentEdges();const l=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Zr.Transparent),this._renderGeometryLinearDepth(a);const c=this._renderHUDVisibility();a||this._renderInternalSlot(ye.LINE_CALLOUTS),this.performanceInfo.advance(Zr.Hudvisibility),this._renderEdges(At.TRANSPARENT,a),this.performanceInfo.advance(Zr.TransparentEdges),this._renderSlot(ye.VOXEL),this._renderTransparentTerrain(),!this._opaqueTerrain&&c&&(a?this._renderLineCallouts(iu.OCCLUDED):s.compositeTransparentTerrainOntoHUDVisibility(),this._renderHUD(iu.OCCLUDED,s.framebuffer),this.performanceInfo.advance(Zr.HudOccluded)),this.performanceInfo.advance(Zr.TransparentTerrain),this._setTerrainCulling(!1),this._opaqueTerrain||(s.compositeTransparentTerrainOntoMain(),a&&(this._renderEdges(At.OPAQUE),this.performanceInfo.advance(Zr.OpaqueEdges),l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Zr.Transparent),this._renderEdges(At.TRANSPARENT),this.performanceInfo.advance(Zr.TransparentEdges))),a&&this._renderLineCallouts(iu.NOTOCCLUDED),this._setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets(()=>{this._renderInternalSlot(ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(ye.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(ye.LASERLINES)},s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(Zr.Atmosphere),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain(()=>this._renderSlot(ye.LASERLINES_CONTRAST_CONTROL),Ln.PremultipliedAlpha),this.performanceInfo.advance(Zr.Laserline),this._renderOccluded(),this.performanceInfo.advance(Zr.Occluded);const h=r===b1.ON&&this._magnifierHelper.enabled,p=h&&O(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(p);const f=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,f)&&_(f)&&this._compositingHelper.composite(f,Ln.None),this.performanceInfo.advance(Zr.Antialiasing),this._renderHUD(iu.NOTOCCLUDED,p),this.performanceInfo.advance(Zr.HudNotoccluded),this._renderHighlights(p,this._bindParameters),this.performanceInfo.advance(Zr.Highlights),h&&this._magnifierHelper.render(this._rctx,this._bindParameters),p!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,Ln.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=n,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}finish(e){if(this._hasAnimations||(this._animationTimestep=0),e===ts.BACKGROUND){this._rctx.gl.getError();const t=this.performanceInfo.elapsedTime/aat;this._animationTimestep=Math.max(this._animationTimestep*Sre+t*(1-Sre),lat)}}readDepthPixels(e,t,i,r,s,n){const o=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT|bi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderGeometryAndTransparentTerrainPass(De.MATERIAL_DEPTH)}o.readPixels(t,i,r,s,Ie.RGBA,yt.UNSIGNED_BYTE,n)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}_setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}_setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}_renderSlot(e){this._renderContext.slot=e,this._renderPlugins.render()}_renderEdges(e,t=!1){const i=this._edgeView;_(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>i.render(this._bindParameters,e),Ln.Alpha,t)}_renderShadowMap(e,t,i,r){const s=this._shadowMap;s.enabled&&(s.start(t,i,r),this._shadowHighlightHelper.updateParameters(t,i),this.needsShadowHighlight?(this._renderShadowCascades(De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,f_e)),s.clear(),this._renderShadowCascades(De.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,m_e),this._renderGeometryAndTransparentTerrainPass(De.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)})):this._renderShadowCascades(De.MATERIAL_DEPTH_SHADOWMAP_ALL),s.finish(e),t.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap,i=r=>{}){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(r.camera),this._renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(De.MATERIAL_DEPTH),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const t=this._renderContext.pass;this._renderContext.pass=De.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const t=this._renderContext.pass;this._offscreenRendering.renderToTargets(()=>this._renderGeometryPass(De.MATERIAL_DEPTH),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}_renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(De.MATERIAL_NORMAL)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}_computeDepthRange(e){if(!this.needsDepthRange)return x9;const t=Zot(e,this._content,this._stage.layers);return XT(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.pass=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderOpaqueGeometry(){this._renderSlot(ye.INTEGRATED_MESH),this._renderSlot(ye.OPAQUE_TERRAIN),this._renderInternalSlot(ye.OPAQUE_MATERIAL),this._renderSlot(ye.OPAQUE_PLUGIN),this._renderSlot(ye.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(ye.TRANSPARENT_MATERIAL),this._renderSlot(ye.TRANSPARENT_PLUGIN)}_renderTransparentTerrain(){this._renderSlot(ye.TRANSPARENT_TERRAIN)}_renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(ye.OCCLUSION_PIXELS)},this._multipassTerrain&&!this._opaqueTerrain),e}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===iu.OCCLUDED?this._offscreenRendering.renderToTargets(()=>this._renderInternalSlot(ye.LINE_CALLOUTS),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(ye.LINE_CALLOUTS)}_renderHUD(e,t){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(e),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,Ln.PremultipliedAlpha)):e===iu.OCCLUDED?this._offscreenRendering.renderToTargets(()=>this._renderHUDElements(iu.OCCLUDED),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(ye.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(ye.HUD_MATERIAL),this._renderInternalSlot(ye.LABEL_MATERIAL)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}_renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&A_e(this._renderContext.rctx);this._renderContext.highlightDepthTexture=t.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(De.MATERIAL_HIGHLIGHT),this._rctx.clearSafe(bi.DEPTH_BUFFER_BIT),this._renderHUDElements(iu.BOTH)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(t,e),i.render(this._renderContext.camera,s,e),_(r)&&i.profilingCallback&&r.stop(n=>{i.profilingCallback&&i.profilingCallback(n)})}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,t,i){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,t,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}_renderOrderIndependentTransparency(e,t){const i=s=>{this._renderContext.transparencyPassType=s,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass(()=>e(),s,t)},r=this._renderContext.pass;this._renderContext.pass=De.MATERIAL_ALPHA,i(at.Alpha),this._renderContext.pass=De.MATERIAL,i(at.Color),i(at.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=at.NONE,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&o.renderOccluded===Ar.OccludeAndTransparentStencil&&(e|=o.renderOccluded,U2.push(o))});const t=this._offscreenRendering,i=(n,o,a,l,c)=>{(e&o)!=0&&(t.renderToTargets(a,t.tmpColor,t.mainDepth,[0,0,0,0],l,c),t.compositeOccludedOntoMain(n))};U2.length!==0&&(this._renderInternalSlot(ye.OCCLUDER_MATERIAL,U2),i(.5,Ar.OccludeAndTransparentStencil,()=>this._renderInternalSlot(ye.TRANSPARENT_OCCLUDER_MATERIAL,U2),!1,!1),U2.length=0),this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&(o.renderOccluded===Ar.OccludeAndTransparent||o.renderOccluded===Ar.Transparent||o.renderOccluded===Ar.Opaque)&&(e|=o.renderOccluded,F2.push(o))});const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=n=>{this._renderContext.renderOccludedMask=n,r>Ar.Occlude&&this._renderSlot(ye.OCCLUDED_TERRAIN),this._renderInternalSlot(ye.OPAQUE_MATERIAL,F2),this._renderInternalSlot(ye.TRANSPARENT_MATERIAL,F2),this._renderInternalSlot(ye.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,F2),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=De.MATERIAL,i(.5,Ar.OccludeAndTransparent,()=>s(Ar.OccludeAndTransparent),!0,ba.OutlineVisualElementMask),i(.5,Ar.Transparent,()=>s(Ar.Transparent),!0,ba.OutlineVisualElementMask),i(1,Ar.Opaque,()=>s(Ar.Opaque),!0,ba.OutlineVisualElementMask),F2.length=0}_renderAntiAliasing(e,t){if(e===g_.SMAA){if(this._smaaPass.enable(()=>this._requestRender())&&_(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}_ensureBindParameters(e){var t;this._ensureCameraBindParameters(e);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=(t=i.depthTexture)!=null?t:this._getFallbackDepthTexture()}_ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=ss:(Vo(Ere,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Vo(s3,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),hr(s3,s3),hr(Are,this._renderContext.camera.projectionMatrix),ur(Kb,s3,Are),ur(Kb,Ere,Kb),ur(Kb,this._renderContext.lastFrameCamera.projectionMatrix,Kb),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=Kb),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}_ensureBindParametersCloudsReflections(){this._bindParameters.cloudsCompositionParams=this._renderContext.cloudsCompositionParams}_renderInternalSlot(e,t){let i=!1;return this._bindParameters.slot=e,_(t)?t.forEach(r=>{if(!r.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(r);_(s)&&(i=s.render(e,this._renderContext.pass,this._bindParameters)||i)}):this._materialRenderers.forEach((r,s)=>{s.shouldRender(this._renderContext)&&(i=r.render(e,this._renderContext.pass,this._bindParameters)||i)}),i}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Afe(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var e,t,i,r,s,n,o,a,l,c;return{offscreen:(e=(t=this._offscreenRendering)==null?void 0:t.gpuMemoryUsage)!=null?e:0,highlights:((i=(r=this._highlightHelper)==null?void 0:r.gpuMemoryUsage)!=null?i:0)+((s=(n=this._shadowHighlightHelper)==null?void 0:n.gpuMemoryUsage)!=null?s:0),shadows:(o=(a=this._shadowMap)==null?void 0:a.gpuMemoryUsage)!=null?o:0,ssao:(l=(c=this._ssaoHelper)==null?void 0:c.gpuMemoryUsage)!=null?l:0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:t=>{var i;switch(t){case py.Color:return e._offscreenRendering.colorTexture;case py.LinearDepth:return e._offscreenRendering.linearDepthTexture;case py.Normals:return e._offscreenRendering.normalTexture;case py.ShadowMap:return(i=e._shadowMap)==null?void 0:i.test.depthTexture;case py.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case py.Highlight:return e._offscreenRendering.highlightTexture}}}}};var py;u([d()],Of.prototype,"_shadowAccumulator",void 0),u([d()],Of.prototype,"_smaaPass",void 0),u([d()],Of.prototype,"_antialiasing",void 0),u([d()],Of.prototype,"_edgeView",void 0),u([d()],Of.prototype,"updating",null),u([d()],Of.prototype,"isCameraFinal",null),Of=u([P("esri.views.3d.webgl-engine.lib.Renderer")],Of),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(py||(py={}));const F2=[],U2=[],Ere=Te(),Are=Te(),s3=Te(),Kb=Te(),Xlt=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var Cre,C_e={exports:{}};(Cre=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(C_e.exports=Cre);const Ylt=C_e.exports;var Rre,R_e={exports:{}};Rre=R_e,function(e){var t=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];t!==void 0&&(Rre.exports=t)}();const Ore=R_e.exports;var O_e={exports:{}};(function(e){(function(t){var i=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT"]}();i!==void 0&&(e.exports=i)})()})(O_e);const Zlt=O_e.exports;var qu=999,Mre=9999,Uk=0,kk=1,Pre=2,Ire=3,$re=4,n3=5,Qlt=6,Jlt=7,Klt=8,Dre=9,ect=10,Lre=11,tct=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function ict(){var e,t,i,r=0,s=0,n=qu,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,g="";return function(B){return a=[],B!==null?v(B.replace?B.replace(/\r\n/g,`
`):B):b()};function y(B){B.length&&a.push({type:tct[n],data:B,position:h,line:l,column:c})}function v(B){var J;for(r=0,i=(g+=B).length;e=g[r],r<i;){switch(J=r,n){case Uk:r=C();break;case kk:r=A();break;case Pre:r=T();break;case Ire:r=R();break;case $re:r=N();break;case Lre:r=U();break;case n3:r=z();break;case Mre:r=V();break;case Dre:r=S();break;case qu:r=w()}J!==r&&(g[J]===`
`?(c=0,++l):++c)}return s+=r,g=g.slice(r),a}function b(B){return o.length&&y(o.join("")),n=ect,y("(eof)"),a}function w(){return o=o.length?[]:o,t==="/"&&e==="*"?(h=s+r-1,n=Uk,t=e,r+1):t==="/"&&e==="/"?(h=s+r-1,n=kk,t=e,r+1):e==="#"?(n=Pre,h=s+r,r):/\s/.test(e)?(n=Dre,h=s+r,r):(p=/\d/.test(e),f=/[^\w_]/.test(e),h=s+r,n=p?$re:f?Ire:Mre,r)}function S(){return/[^\s]/g.test(e)?(y(o.join("")),n=qu,r):(o.push(e),t=e,r+1)}function T(){return e!=="\r"&&e!==`
`||t==="\\"?(o.push(e),t=e,r+1):(y(o.join("")),n=qu,r)}function A(){return T()}function C(){return e==="/"&&t==="*"?(o.push(e),y(o.join("")),n=qu,r+1):(o.push(e),t=e,r+1)}function R(){if(t==="."&&/\d/.test(e))return n=n3,r;if(t==="/"&&e==="*")return n=Uk,r;if(t==="/"&&e==="/")return n=kk,r;if(e==="."&&o.length){for(;L(o););return n=n3,r}if(e===";"||e===")"||e==="("){if(o.length)for(;L(o););return y(e),n=qu,r+1}var B=o.length===2&&e!=="=";if(/[\w_\d\s]/.test(e)||B){for(;L(o););return n=qu,r}return o.push(e),t=e,r+1}function L(B){for(var J,Z,te=0;;){if(J=Ore.indexOf(B.slice(0,B.length+te).join("")),Z=Ore[J],J===-1){if(te--+B.length>0)continue;Z=B.slice(0,1).join("")}return y(Z),h+=Z.length,(o=o.slice(Z.length)).length}}function U(){return/[^a-fA-F0-9]/.test(e)?(y(o.join("")),n=qu,r):(o.push(e),t=e,r+1)}function N(){return e==="."||/[eE]/.test(e)?(o.push(e),n=n3,t=e,r+1):e==="x"&&o.length===1&&o[0]==="0"?(n=Lre,o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=qu,r):(o.push(e),t=e,r+1)}function z(){return e==="f"&&(o.push(e),t=e,r+=1),/[eE]/.test(e)||e==="-"&&/[eE]/.test(t)?(o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=qu,r):(o.push(e),t=e,r+1)}function V(){if(/[^\d\w_]/.test(e)){var B=o.join("");return n=Ylt.indexOf(B)>-1?Klt:Zlt.indexOf(B)>-1?Jlt:Qlt,y(o.join("")),n=qu,r}return o.push(e),t=e,r+1}}function rct(e){var t=ict(),i=[];return i=(i=i.concat(t(e))).concat(t(null))}function sct(e){return rct(e)}function nct(e){return e.map(t=>t.type!=="eof"?t.data:"").join("")}const zk=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function oct(e,t="100",i="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if(s.type==="preprocessor"){const n=r.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===i)return o;if(o===t)return s.data="#version "+i,t;throw new Error("unknown glsl version: "+o)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function act(e,t){for(let i=t-1;i>=0;i--){const r=e[i];if(r.type!=="whitespace"&&r.type!=="block-comment"){if(r.type!=="keyword")break;if(r.data==="attribute"||r.data==="in")return!0}}return!1}function eA(e,t,i,r){r=r||i;for(const s of e)if(s.type==="ident"&&s.data===i)return r in t?t[r]++:t[r]=0,eA(e,t,r+"_"+t[r],r);return i}function M_e(e,t,i="afterVersion"){function r(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const g=l[f];if(g.type==="preprocessor"&&(g.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:g.data.match(/\#endif\s*.*/)&&--h),i!=="afterVersion"&&i!=="afterPrecision"||g.type==="preprocessor"&&/^#version/.test(g.data)&&(p=Math.max(p,f)),i==="afterPrecision"&&g.type==="keyword"&&g.data==="precision"){const y=r(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<e.length&&/[^\r\n]$/.test(e[l].data);let a=s(e);o(a-1)&&e.splice(a++,0,n);for(const l of t)e.splice(a++,0,l);o(a-1)&&o(a)&&e.splice(a,0,n)}function lct(e,t,i,r="lowp"){M_e(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function cct(e,t,i,r,s="lowp"){M_e(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function uct(e,t){let i,r,s=-1;for(let n=t;n<e.length;n++){const o=e[n];if(o.type==="operator"&&(o.data==="["&&(i=n),o.data==="]")){r=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return i&&r&&e.splice(i,r-i+1),s}function Nre(e,t){const i=hct();if(_(i))return i;const r=sct(e);if(oct(r,"100","300 es")==="300 es")return e;let s=null,n=null;const o={},a={};for(let l=0;l<r.length;++l){const c=r[l];switch(c.type){case"keyword":t===Ql.VERTEX_SHADER&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=t===Ql.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),t===Ql.FRAGMENT_SHADER&&c.data==="gl_FragColor"&&(s||(s=eA(r,o,"fragColor"),lct(r,s,"vec4")),c.data=s),t===Ql.FRAGMENT_SHADER&&c.data==="gl_FragData"){const h=uct(r,l+1),p=eA(r,o,"fragData");cct(r,p,"vec4",h,"mediump"),c.data=p}else t===Ql.FRAGMENT_SHADER&&c.data==="gl_FragDepthEXT"&&(n||(n=eA(r,o,"gl_FragDepth")),c.data=n);break;case"ident":if(Xlt.indexOf(c.data)>=0){if(t===Ql.VERTEX_SHADER&&act(r,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=eA(r,o,c.data)),c.data=a[c.data]}}}for(let l=r.length-1;l>=0;--l){const c=r[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&zk.indexOf(h[1].trim())>=0){const g=r[l+1];r.splice(l,g&&g.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&zk.indexOf(p[1].trim())>=0&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&zk.indexOf(f[1].trim())>=0&&(c.data="#if 0")}}return dct(e,nct(r))}function hct(e){return null}function dct(e,t){return t}const pct=4294967295;class fct{constructor(t,i,r,s,n=new Map){this._context=t,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v={},this._nameToUniform2={},this._nameToUniform3={},this._nameToUniform4={},this._nameToUniformMatrix3={},this._nameToUniformMatrix4={},t||console.error("RenderingContext isn't initialized!"),i.length===0&&console.error("Shaders source should not be empty!"),this._context.type===Kt.WEBGL2&&(i=Nre(i,Ql.VERTEX_SHADER),r=Nre(r,Ql.FRAGMENT_SHADER)),this._vShader=Fre(this._context,Ql.VERTEX_SHADER,i),this._fShader=Fre(this._context,Ql.FRAGMENT_SHADER,r),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(Ns.Shader,this),SC()&&(this.vertexShader=i,this.fragmentShader=r)}get glName(){if(_(this._glName))return this._glName;if(O(this._vShader))return null;const t=this._context.gl,i=t.createProgram();if(t.attachShader(i,this._vShader),t.attachShader(i,this._fShader),this._locations.forEach((r,s)=>t.bindAttribLocation(i,r,s)),t.linkProgram(i),SC()&&!t.getProgramParameter(i,t.LINK_STATUS)&&console.error(`Could not link shader
validated: ${t.getProgramParameter(i,t.VALIDATE_STATUS)}, gl error ${t.getError()}, vertex: ${t.getShaderParameter(this._vShader,t.COMPILE_STATUS)}, fragment: ${t.getShaderParameter(this._fShader,t.COMPILE_STATUS)}, info log: ${t.getProgramInfoLog(i)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===Kt.WEBGL2){const r=t;for(const[s,n]of this._uniformBlockBindings){const o=r.getUniformBlockIndex(i,s);o<pct&&r.uniformBlockBinding(i,o,n)}}return this._glName=i,this._context.instanceCounter.increment(Ns.Program,this),i}get hasGLName(){return _(this._glName)}get isCompiled(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return t==null?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const t=this._context.gl;this._vShader&&(t.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(Ns.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(Ns.Program,this))}ref(){++this._refCount}_getUniformLocation(t){return this._nameToUniformLocation[t]===void 0&&(this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this.glName,t)),this._nameToUniformLocation[t]}hasUniform(t){return this._getUniformLocation(t)!==null}setUniform1i(t,i){const r=this._nameToUniform1[t];(r===void 0||i!==r)&&(this._context.gl.uniform1i(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1iv(t,i){const r=this._nameToUniform1v[t];jd(r,i)&&(this._context.gl.uniform1iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform1v[t]=Array.from(i):yd(i,r))}setUniform2iv(t,i){const r=this._nameToUniform2[t];jd(r,i)&&(this._context.gl.uniform2iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform2[t]=Array.from(i):yd(i,r))}setUniform3iv(t,i){const r=this._nameToUniform3[t];jd(r,i)&&(this._context.gl.uniform3iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform3[t]=Array.from(i):yd(i,r))}setUniform4iv(t,i){const r=this._nameToUniform4[t];jd(r,i)&&(this._context.gl.uniform4iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform4[t]=Array.from(i):yd(i,r))}setUniform1f(t,i){const r=this._nameToUniform1[t];(r===void 0||i!==r)&&(this._context.gl.uniform1f(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1fv(t,i){const r=this._nameToUniform1v[t];jd(r,i)&&(this._context.gl.uniform1fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform1v[t]=Array.from(i):yd(i,r))}setUniform2f(t,i,r){const s=this._nameToUniform2[t];(s===void 0||i!==s[0]||r!==s[1])&&(this._context.gl.uniform2f(this._getUniformLocation(t),i,r),s===void 0?this._nameToUniform2[t]=[i,r]:(s[0]=i,s[1]=r))}setUniform2fv(t,i){const r=this._nameToUniform2[t];jd(r,i)&&(this._context.gl.uniform2fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform2[t]=Array.from(i):yd(i,r))}setUniform3f(t,i,r,s){const n=this._nameToUniform3[t];(n===void 0||i!==n[0]||r!==n[1]||s!==n[2])&&(this._context.gl.uniform3f(this._getUniformLocation(t),i,r,s),n===void 0?this._nameToUniform3[t]=[i,r,s]:(n[0]=i,n[1]=r,n[2]=s))}setUniform3fv(t,i){const r=this._nameToUniform3[t];jd(r,i)&&(this._context.gl.uniform3fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform3[t]=Array.from(i):yd(i,r))}setUniform4f(t,i,r,s,n){const o=this._nameToUniform4[t];(o===void 0||i!==o[0]||r!==o[1]||s!==o[2]||n!==o[3])&&(this._context.gl.uniform4f(this._getUniformLocation(t),i,r,s,n),o===void 0?this._nameToUniform4[t]=[i,r,s,n]:(o[0]=i,o[1]=r,o[2]=s,o[3]=n))}setUniform4fv(t,i){const r=this._nameToUniform4[t];jd(r,i)&&(this._context.gl.uniform4fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform4[t]=Array.from(i):yd(i,r))}setUniformMatrix3fv(t,i,r=!1){const s=this._nameToUniformMatrix3[t];yct(s,i)&&(this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),r,i),s===void 0?this._nameToUniformMatrix3[t]=Array.from(i):yd(i,s))}setUniformMatrix4fv(t,i,r=!1){const s=this._nameToUniformMatrix4[t];vct(s,i)&&(this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),r,i),s===void 0?this._nameToUniformMatrix4[t]=Array.from(i):yd(i,s))}stop(){}}function jd(e,t){if(O(e)||e.length!==t.length)return!0;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!0;return!1}function Fre(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),SC()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===Ql.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(mct(i)),e.type===Kt.WEBGL2&&(console.log("Shader source before transpilation:"),console.log(i))),s}function mct(e){let t=2;return e.replace(/\n/g,()=>`
`+gct(t++)+":")}function gct(e){return e>=1e3?e.toString():("  "+e).slice(-3)}function yd(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}function yct(e,t){return!!O(e)||(e.length!==9?jd(e,t):e.length!==9||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||e[4]!==t[4]||e[5]!==t[5]||e[6]!==t[6]||e[7]!==t[7]||e[8]!==t[8])}function vct(e,t){return!!O(e)||(e.length!==16?jd(e,t):e.length!==16||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||e[4]!==t[4]||e[5]!==t[5]||e[6]!==t[6]||e[7]!==t[7]||e[8]!==t[8]||e[9]!==t[9]||e[10]!==t[10]||e[11]!==t[11]||e[12]!==t[12]||e[13]!==t[13]||e[14]!==t[14]||e[15]!==t[15])}class _ct{constructor(t){this._rctx=t,this._store=new ZH}dispose(){this._store.forEach(t=>t.forEach(i=>i.dispose())),this._store.clear()}acquire(t,i,r,s){const n=this._store.get(t,i);if(_(n))return n.ref(),n;const o=new fct(this._rctx,t,i,r,s);return o.ref(),this._store.set(t,i,o),o}get test(){let t=0;return this._store.forEach(i=>i.forEach(r=>t+=r.hasGLName?2:1)),{cachedWebGLObjects:t}}}class Ure{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Ee.ONE,dstRGB:Ee.ZERO,srcAlpha:Ee.ONE,dstAlpha:Ee.ZERO},this.blendEquation={mode:fp.ADD,modeAlpha:fp.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=ma.BACK,this.frontFace=gT.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=Di.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:ma.FRONT_AND_BACK,func:Di.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:ma.FRONT_AND_BACK,fail:Fi.KEEP,zFail:Fi.KEEP,zPass:Fi.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class bct{constructor(t){this._allocations=new Map,t?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(t){this._allocations.set(t,new Error().stack)}remove(t){this._allocations.delete(t)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const t=new Map;this._allocations.forEach(i=>{var r;t.set(i,((r=t.get(i))!=null?r:0)+1)}),t.forEach((i,r)=>{const s=r.split(`
`);s.shift(),s.shift(),console.log(`${i}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}class wct{constructor(){this.RECORD_ALLOCATIONS=!1}}const xct=new wct;class Tct{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new bct(xct.RECORD_ALLOCATIONS);this._current.length<Ns.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(t,i){const r=++this._current[t];this._max[t]=Math.max(r,this._max[t]),this._allocations.add(i)}decrement(t,i){--this._current[t],this._allocations.remove(i)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((t,i)=>t+i,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let t=0;t<Ns.COUNT;++t){const i=this._current[t];i>0&&console.log(`${Ns[t]}: ${i}`)}}this._allocations.print()}}function kre(e,t){const i=new ki(e,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,wrapMode:lt.CLAMP_TO_EDGE,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:1,height:1});function r(w,S){const T=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,A=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,C=e.programCache.acquire(T,A,new Map([["position",0]])),R=new Float32Array(6);PD(w,R,3);const L=new Float32Array(6);return PD(S,L,3),e.useProgram(C),C.setUniform3f("u_highA",R[0],R[2],R[4]),C.setUniform3f("u_lowA",R[1],R[3],R[5]),C.setUniform3f("u_highB",L[0],L[2],L[4]),C.setUniform3f("u_lowB",L[1],L[3],L[5]),C}const s=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new as(e,new Map([["position",0]]),{geometry:[new gn("position",2,nt.UNSIGNED_SHORT,0,4)]},{geometry:s}),o=je(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=je(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=r(o,a),c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:g}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(n),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);i.readPixels(0,0,1,1,Ie.RGBA,yt.UNSIGNED_BYTE,y),l.dispose(),n.dispose(!1),s.dispose(),i.dispose(),e.setViewport(h,p,f,g),e.bindFramebuffer(c);const v=(o[2]-a[2])/25,b=IH(y);return Math.abs(v-b)}var zre,Bre,Vre,P_e={exports:{}};function Sct(e){var t,i,r,s,n;if(!e.gl)return!1;if(e.type===Kt.WEBGL1)return!((s=e.capabilities.textureFloat)==null||!s.textureFloat||(n=e.capabilities.colorBufferFloat)==null||!n.textureFloat);if(!(((t=e.capabilities.textureFloat)==null?void 0:t.textureFloat)&&((i=e.capabilities.colorBufferFloat)==null?void 0:i.textureFloat)&&((r=e.capabilities.colorBufferFloat)==null?void 0:r.floatBlend)))return!1;const o=new ki(e,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,wrapMode:lt.CLAMP_TO_EDGE,pixelFormat:Ie.RGBA,dataType:yt.FLOAT,internalFormat:st.RGBA32F,samplingMode:Ve.NEAREST,width:1,height:1}),a=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),l=new as(e,new Map([["a_pos",0]]),{geometry:[new gn("a_pos",2,nt.UNSIGNED_SHORT,0,4)]},{geometry:a}),c=`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,h=`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,p=e.programCache.acquire(c,h,new Map([["a_pos",0]]));e.useProgram(p);const f=e.getBoundFramebufferObject(),{x:g,y,width:v,height:b}=e.getViewport();e.bindFramebuffer(o),e.setViewport(0,0,1,1),e.bindVAO(l),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const w=Rt({blending:Gge});e.setPipelineState(w),e.drawArrays(Tt.TRIANGLE_STRIP,0,4),P_e.exports.init(e);const S=e.gl.getError();return e.setViewport(g,y,v,b),e.bindFramebuffer(f),p.dispose(),l.dispose(!1),a.dispose(),o.dispose(),S!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}zre=P_e,Bre=function(){var e=function(v){window.console&&window.console.log&&window.console.log(v)},t=function(v){window.console&&window.console.error?window.console.error(v):e(v)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,s=null;function n(v){if(r==null)for(var b in r={},s={},v)typeof v[b]=="number"&&(r[v[b]]=b,s[b]=v[b])}function o(){if(r==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(v){return o(),r[v]!==void 0}function l(v){o();var b=r[v];return b!==void 0?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+v.toString(16)}function c(v,b,w,S){var T;if((T=i[v])!==void 0&&(T=T[b])!==void 0&&T[w]){if(typeof T[w]=="object"&&T[w].enumBitwiseOr!==void 0){for(var A=T[w].enumBitwiseOr,C=0,R=[],L=0;L<A.length;++L){var U=s[A[L]];(S&U)!=0&&(C|=U,R.push(l(U)))}return C===S?R.join(" | "):l(S)}return l(S)}return S===null?"null":S===void 0?"undefined":S.toString()}function h(v,b){for(var w="",S=b.length,T=0;T<S;++T)w+=(T==0?"":", ")+c(v,S,T,b[T]);return w}function p(v,b,w){v.__defineGetter__(w,function(){return b[w]}),v.__defineSetter__(w,function(S){b[w]=S})}function f(v,b,w,S){S=S||v,n(v),b=b||function(U,N,z){for(var V="",B=z.length,J=0;J<B;++J)V+=(J==0?"":", ")+c(N,B,J,z[J]);t("WebGL error "+l(U)+" in "+N+"("+V+")")};var T={};function A(U,N){return function(){w&&w(N,arguments);var z=U[N].apply(U,arguments),V=S.getError();return V!=0&&(T[V]=!0,b(V,N,arguments)),z}}var C={};for(var R in v)if(typeof v[R]=="function")if(R!="getExtension")C[R]=A(v,R);else{var L=A(v,R);C[R]=function(){return f(L.apply(v,arguments),b,w,S)}}else p(C,v,R);return C.getError=function(){for(var U in T)if(T.hasOwnProperty(U)&&T[U])return T[U]=!1,U;return v.NO_ERROR},C}function g(v){var b=v.getParameter(v.MAX_VERTEX_ATTRIBS),w=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,w);for(var S=0;S<b;++S)v.disableVertexAttribArray(S),v.vertexAttribPointer(S,4,v.FLOAT,!1,0,0),v.vertexAttrib1f(S,0);v.deleteBuffer(w);var T=v.getParameter(v.MAX_TEXTURE_IMAGE_UNITS);for(S=0;S<T;++S)v.activeTexture(v.TEXTURE0+S),v.bindTexture(v.TEXTURE_CUBE_MAP,null),v.bindTexture(v.TEXTURE_2D,null);for(v.activeTexture(v.TEXTURE0),v.useProgram(null),v.bindBuffer(v.ARRAY_BUFFER,null),v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,null),v.bindFramebuffer(v.FRAMEBUFFER,null),v.bindRenderbuffer(v.RENDERBUFFER,null),v.disable(v.BLEND),v.disable(v.CULL_FACE),v.disable(v.DEPTH_TEST),v.disable(v.DITHER),v.disable(v.SCISSOR_TEST),v.blendColor(0,0,0,0),v.blendEquation(v.FUNC_ADD),v.blendFunc(v.ONE,v.ZERO),v.clearColor(0,0,0,0),v.clearDepth(1),v.clearStencil(-1),v.colorMask(!0,!0,!0,!0),v.cullFace(v.BACK),v.depthFunc(v.LESS),v.depthMask(!0),v.depthRange(0,1),v.frontFace(v.CCW),v.hint(v.GENERATE_MIPMAP_HINT,v.DONT_CARE),v.lineWidth(1),v.pixelStorei(v.PACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!1),v.pixelStorei(v.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),v.UNPACK_COLORSPACE_CONVERSION_WEBGL&&v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.BROWSER_DEFAULT_WEBGL),v.polygonOffset(0,0),v.sampleCoverage(1,!1),v.scissor(0,0,v.canvas.width,v.canvas.height),v.stencilFunc(v.ALWAYS,0,4294967295),v.stencilMask(4294967295),v.stencilOp(v.KEEP,v.KEEP,v.KEEP),v.viewport(0,0,v.canvas.width,v.canvas.height),v.clear(v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT|v.STENCIL_BUFFER_BIT);v.getError(););}function y(v){var b,w,S=[],T=[],A={},C=1,R=!1,L=[],U=0,N=0,z=!1,V=0,B={};function J(H){return typeof H=="function"?H:function(ee){H.handleEvent(ee)}}v.getContext=(w=v.getContext,function(){var H=w.apply(v,arguments);if(H instanceof WebGLRenderingContext){if(H!=b){if(b)throw"got different context";A=K(b=H)}return A}return H});var Z=function(H){S.push(J(H))},te=function(H){T.push(J(H))};function ie(H){var ee=H.addEventListener;H.addEventListener=function(ge,Ae,Be){switch(ge){case"webglcontextlost":Z(Ae);break;case"webglcontextrestored":te(Ae);break;default:ee.apply(H,arguments)}}}function $(){for(var H=Object.keys(B),ee=0;ee<H.length;++ee)delete B[H]}function F(){++N,R||U==N&&v.loseContext()}function k(H,ee){var ge=H[ee];return function(){if(F(),!R)return ge.apply(H,arguments)}}function G(){for(var H=0;H<L.length;++H){var ee=L[H];ee instanceof WebGLBuffer?b.deleteBuffer(ee):ee instanceof WebGLFramebuffer?b.deleteFramebuffer(ee):ee instanceof WebGLProgram?b.deleteProgram(ee):ee instanceof WebGLRenderbuffer?b.deleteRenderbuffer(ee):ee instanceof WebGLShader?b.deleteShader(ee):ee instanceof WebGLTexture&&b.deleteTexture(ee)}}function q(H){return{statusMessage:H,preventDefault:function(){z=!0}}}return ie(v),v.loseContext=function(){if(!R){for(R=!0,U=0,++C;b.getError(););$(),B[b.CONTEXT_LOST_WEBGL]=!0;var H=q("context lost"),ee=S.slice();setTimeout(function(){for(var ge=0;ge<ee.length;++ge)ee[ge](H);V>=0&&setTimeout(function(){v.restoreContext()},V)},0)}},v.restoreContext=function(){R&&T.length&&setTimeout(function(){if(!z)throw"can not restore. webglcontestlost listener did not call event.preventDefault";G(),g(b),R=!1,N=0,z=!1;for(var H=T.slice(),ee=q("context restored"),ge=0;ge<H.length;++ge)H[ge](ee)},0)},v.loseContextInNCalls=function(H){if(R)throw"You can not ask a lost contet to be lost";U=N+H},v.getNumCalls=function(){return N},v.setRestoreTimeout=function(H){V=H},v;function K(H){for(var ee in H)typeof H[ee]=="function"?A[ee]=k(H,ee):p(A,H,ee);A.getError=function(){if(F(),!R)for(;Re=b.getError();)B[Re]=!0;for(var Re in B)if(B[Re])return delete B[Re],Re;return A.NO_ERROR};for(var ge=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],Ae=0;Ae<ge.length;++Ae){var Be=ge[Ae];A[Be]=function(Re){return function(){if(F(),R)return null;var ke=Re.apply(H,arguments);return ke.__webglDebugContextLostId__=C,L.push(ke),ke}}(H[Be])}var Se=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(Ae=0;Ae<Se.length;++Ae)Be=Se[Ae],A[Be]=function(Re){return function(){return F(),R?null:Re.apply(H,arguments)}}(A[Be]);var xe=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(Ae=0;Ae<xe.length;++Ae)Be=xe[Ae],A[Be]=function(Re){return function(){return F(),!R&&Re.apply(H,arguments)}}(A[Be]);return A.checkFramebufferStatus=function(Re){return function(){return F(),R?A.FRAMEBUFFER_UNSUPPORTED:Re.apply(H,arguments)}}(A.checkFramebufferStatus),A.getAttribLocation=function(Re){return function(){return F(),R?-1:Re.apply(H,arguments)}}(A.getAttribLocation),A.getVertexAttribOffset=function(Re){return function(){return F(),R?0:Re.apply(H,arguments)}}(A.getVertexAttribOffset),A.isContextLost=function(){return R},A}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:g}},(Vre=Bre())!==void 0&&(zre.exports=Vre);const Ect=he.getLogger("esri.views.WebGLDriverTest");function Act(e){const t=new ki(e,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,wrapMode:lt.CLAMP_TO_EDGE,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:1,height:1}),i=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,r=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new as(e,new Map([["a_position",0]]),{geometry:[new gn("a_position",2,nt.SHORT,0,4)]},{geometry:n}),a=e.programCache.acquire(i,r,new Map([["a_pos",0]]));e.useProgram(a);const l=new Ze(e,{target:rt.TEXTURE_2D,wrapMode:lt.CLAMP_TO_EDGE,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));a.setUniform1i("u_texture",0),e.bindTexture(l,0);const c=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.useProgram(a);const{x:h,y:p,width:f,height:g}=e.getViewport();e.setViewport(0,0,1,1),e.bindVAO(o),e.drawArrays(Tt.TRIANGLE_STRIP,0,4),e.setViewport(h,p,f,g),t.readPixels(0,0,1,1,Ie.RGBA,yt.UNSIGNED_BYTE,s),a.dispose(),o.dispose(!1),n.dispose(),t.dispose();const y=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return y&&Ect.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),e.bindFramebuffer(c),y}new gn("a_pos",2,nt.BYTE,0,2);new gn("a_pos",2,nt.BYTE,0,4),new gn("a_tex",2,nt.BYTE,2,4);const Cct={geometry:[new gn("a_pos",2,nt.UNSIGNED_SHORT,0,4)]};async function Rct(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new ki(e,{colorTarget:gr.TEXTURE,depthStencilTarget:ti.NONE},{target:rt.TEXTURE_2D,wrapMode:lt.CLAMP_TO_EDGE,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ve.NEAREST,width:1,height:1}),r=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new as(e,new Map([["a_pos",0]]),Cct,{geometry:r}),n=`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,o=`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,a=e.programCache.acquire(n,o,new Map([["a_pos",0]]));e.useProgram(a);const l=new Ze(e,{dataType:yt.UNSIGNED_BYTE,pixelFormat:Ie.RGBA,preMultiplyAlpha:!1,wrapMode:lt.CLAMP_TO_EDGE,samplingMode:Ve.LINEAR},t);e.bindTexture(l,0),a.setUniform1i("u_texture",0);const c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:g}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.setClearColor(0,0,0,0),e.setBlendingEnabled(!1),e.clearSafe(bi.COLOR_BUFFER_BIT),e.bindVAO(s),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);return i.readPixels(0,0,1,1,Ie.RGBA,yt.UNSIGNED_BYTE,y),a.dispose(),s.dispose(!1),r.dispose(),i.dispose(),l.dispose(),e.setViewport(h,p,f,g),e.bindFramebuffer(c),t.src="",y[0]===255}class Oct{constructor(t){this.context=t,this._floatBufferBlendWorking=Sct(t),Rct(t).then(i=>this._svgAlwaysPremultipliesAlpha=!i)}get floatBufferBlendWorking(){if(O(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(O(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(O(this._doublePrecisionRequiresObfuscation)){const t=kre(this.context,!1),i=kre(this.context,!0);this._doublePrecisionRequiresObfuscation=t!==0&&(i===0||t/i>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return O(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Act(this.context)),this._ignoresSamplerPrecision}}class Gre{constructor(t,i,r,s,n,o,a,l){this.createQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}function Mct(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i&&Ws(e)?new Gre(()=>e.createQuery(),r=>e.getQueryParameter(r,e.QUERY_RESULT_AVAILABLE),r=>e.getQueryParameter(r,e.QUERY_RESULT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>e.beginQuery(i.TIME_ELAPSED_EXT,r),()=>e.endQuery(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=e.getExtension("EXT_disjoint_timer_query"),i?new Gre(()=>i.createQueryEXT(),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_AVAILABLE_EXT),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_EXT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,r),()=>i.endQueryEXT(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}function Pct(e,t){if(t.disjointTimerQuery)return null;if(Ws(e))return{drawBuffers:e.drawBuffers.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const i=e.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function Ict(e){if(Ws(e))return{drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e),vertexAttribDivisor:e.vertexAttribDivisor.bind(e)};const t=e.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}function $ct(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function Dct(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function Lct(e,t){if(Ws(e))return{MIN:e.MIN,MAX:e.MAX};if(t.blendMinMax)return null;{const i=e.getExtension("EXT_blend_minmax");return i?{MIN:i.MIN_EXT,MAX:i.MAX_EXT}:null}}function Nct(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function Fct(e,t){if(Ws(e))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e.HALF_FLOAT,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F};if(e instanceof WebGLRenderingContext){const i=!t.textureHalfFloat&&e.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!e.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}function Uct(e,t){if(Ws(e)){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}if(e instanceof WebGLRenderingContext){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("WEBGL_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:r?r.RGBA32F_EXT:void 0}:null}return null}function o3(e,t,i,r,s){if(r&&Ws(e))return!0;if(t[i])return!1;for(const n of s)if(e.getExtension(n))return!0;return!1}function kct(e,t){if(!Ws(e)||t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}function zct(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}function Bct(e,t){if(Ws(e))return{createVertexArray:e.createVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e)};if(t.vao)return null;const i=e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}class Vct{constructor(t,i){this.gl=t,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._disabledExtensions=i.disabledExtensions||{},this._debugWebGLExtensions=i.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=Pct(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=Ict(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=Bct(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=$ct(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=Dct(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=Nct(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=Mct(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=Fct(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=Uct(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=Lct(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=o3(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=o3(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=o3(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=o3(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=zct(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=kct(this.gl,this._disabledExtensions)),this._textureNorm16}enable(t){return this[t]}}class Gct{constructor(t,i){this.gl=t,this.instanceCounter=new Tct,this.programCache=new _ct(this),this._state=new Ure,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=Ws(t)?Kt.WEBGL2:Kt.WEBGL1,this._loadExtensions(),this.configure(i)}configure(t){this._capabilities=new Vct(this.gl,t),this._parameters=this._loadParameters(t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._state=new Ure,this._state.viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new W6e({setBlending:r=>{if(r){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(r.opRgb,r.opAlpha),this.setBlendFunctionSeparate(r.srcRgb,r.dstRgb,r.srcAlpha,r.dstAlpha);const s=r.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:r=>{r?(this.setFaceCullingEnabled(!0),this.setCullFace(r.face),this.setFrontFace(r.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:r=>{r?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(r.factor,r.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:r=>{r?(this.setDepthTestEnabled(!0),this.setDepthFunction(r.func)):this.setDepthTestEnabled(!1)},setStencilTest:r=>{if(r){this.setStencilTestEnabled(!0);const s=r.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=r.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:r=>{r?(this.setDepthWriteEnabled(!0),this.setDepthRange(r.zNear,r.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:r=>{r?this.setColorMask(r.r,r.g,r.b,r.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:r=>{r?this.setStencilWriteMask(r.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this._driverTest=new Oct(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(ft.ARRAY_BUFFER),this.unbindBuffer(ft.ELEMENT_ARRAY_BUFFER),Ws(this.gl)&&(this.unbindBuffer(ft.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(ft.PIXEL_PACK_BUFFER),this.unbindBuffer(ft.PIXEL_UNPACK_BUFFER),this.unbindBuffer(ft.COPY_READ_BUFFER),this.unbindBuffer(ft.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,eu()&&this.instanceCounter.printResourceCount()}setPipelineState(t){this._stateTracker.setPipeline(t)}setBlendingEnabled(t){this._state.blend!==t&&(t===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=t,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var t;(t=this._state.program)==null||t.stop(),this._state.program=null}externalTextureUnitUpdate(t,i){for(let r=0;r<t.length;++r)this._state.textureUnitMap[t[r]]=null;i>=0&&(this._state.activeTexture=i)}externalVertexArrayObjectUpdate(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(t,i,r,s){t===this._state.blendColor.r&&i===this._state.blendColor.g&&r===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(t,i,r,s),this._state.blendColor.r=t,this._state.blendColor.g=i,this._state.blendColor.b=r,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(t,i){t===this._state.blendFunction.srcRGB&&i===this._state.blendFunction.dstRGB||(this.gl.blendFunc(t,i),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=t,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(t,i,r,s){this._state.blendFunction.srcRGB===t&&this._state.blendFunction.srcAlpha===r&&this._state.blendFunction.dstRGB===i&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(t,i,r,s),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=r,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(t){this._state.blendEquation.mode!==t&&(this.gl.blendEquation(t),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(t,i){this._state.blendEquation.mode===t&&this._state.blendEquation.modeAlpha===i||(this.gl.blendEquationSeparate(t,i),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=i,this._stateTracker.invalidateBlending())}setColorMask(t,i,r,s){this._state.colorMask.r===t&&this._state.colorMask.g===i&&this._state.colorMask.b===r&&this._state.colorMask.a===s||(this.gl.colorMask(t,i,r,s),this._state.colorMask.r=t,this._state.colorMask.g=i,this._state.colorMask.b=r,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(t,i,r,s){this._state.clearColor.r===t&&this._state.clearColor.g===i&&this._state.clearColor.b===r&&this._state.clearColor.a===s||(this.gl.clearColor(t,i,r,s),this._state.clearColor.r=t,this._state.clearColor.g=i,this._state.clearColor.b=r,this._state.clearColor.a=s)}setFaceCullingEnabled(t){this._state.faceCulling!==t&&(t===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=t,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(t){this._state.polygonOffsetFill!==t&&(t===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=t,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(t,i){this._state.polygonOffset[0]===t&&this._state.polygonOffset[1]===i||(this._state.polygonOffset[0]=t,this._state.polygonOffset[1]=i,this.gl.polygonOffset(t,i),this._stateTracker.invalidatePolygonOffset())}setCullFace(t){this._state.cullFace!==t&&(this.gl.cullFace(t),this._state.cullFace=t,this._stateTracker.invalidateCulling())}setFrontFace(t){this._state.frontFace!==t&&(this.gl.frontFace(t),this._state.frontFace=t,this._stateTracker.invalidateCulling())}setScissorTestEnabled(t){this._state.scissorTest!==t&&(t===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=t)}setScissorRect(t,i,r,s){this._state.scissorRect.x===t&&this._state.scissorRect.y===i&&this._state.scissorRect.width===r&&this._state.scissorRect.height===s||(this.gl.scissor(t,i,r,s),this._state.scissorRect.x=t,this._state.scissorRect.y=i,this._state.scissorRect.width=r,this._state.scissorRect.height=s)}setDepthTestEnabled(t){this._state.depthTest!==t&&(t===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=t,this._stateTracker.invalidateDepthTest())}setClearDepth(t){this._state.clearDepth!==t&&(this.gl.clearDepth(t),this._state.clearDepth=t)}setDepthFunction(t){this._state.depthFunction!==t&&(this.gl.depthFunc(t),this._state.depthFunction=t,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(t){this._state.depthWrite!==t&&(this.gl.depthMask(t),this._state.depthWrite=t,this._stateTracker.invalidateDepthWrite())}setDepthRange(t,i){this._state.depthRange.zNear===t&&this._state.depthRange.zFar===i||(this.gl.depthRange(t,i),this._state.depthRange.zNear=t,this._state.depthRange.zFar=i,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(t){this._state.stencilTest!==t&&(t===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=t,this._stateTracker.invalidateStencilTest())}setClearStencil(t){t!==this._state.clearStencil&&(this.gl.clearStencil(t),this._state.clearStencil=t)}setStencilFunction(t,i,r){this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFunc(t,i,r),this._state.stencilFunction.face=ma.FRONT_AND_BACK,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(t,i,r,s){this._state.stencilFunction.face===t&&this._state.stencilFunction.func===i&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(t,i,r,s),this._state.stencilFunction.face=t,this._state.stencilFunction.func=i,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(t){this._state.stencilWriteMask!==t&&(this.gl.stencilMask(t),this._state.stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())}setStencilOp(t,i,r){this._state.stencilOperation.face===ma.FRONT_AND_BACK&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOp(t,i,r),this._state.stencilOperation.face=ma.FRONT_AND_BACK,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(t,i,r,s){this._state.stencilOperation.face===t&&this._state.stencilOperation.fail===i&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(t,i,r,s),this._state.stencilOperation.face=t,this._state.stencilOperation.fail=i,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(t,i=!1){const r=this._state.activeTexture;return t>=0&&(i||t!==this._state.activeTexture)&&(this.gl.activeTexture(F4+t),this._state.activeTexture=t),r}clear(t){t&&this.gl.clear(t)}clearSafe(t,i=255){t&&(t&bi.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),t&bi.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),t&bi.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(i),this.gl.clear(t))}drawArrays(t,i,r){if(eu()&&(this._numOfDrawCalls++,this._numOfTriangles+=jre(t,r)),this.gl.drawArrays(t,i,r),eu()){const s=EJ(this);s&&console.error("drawArrays:",s)}}drawElements(t,i,r,s){if(eu()&&(this._numOfDrawCalls++,this._numOfTriangles+=jre(t,i)),this.gl.drawElements(t,i,r,s),eu()){const o=EJ(this);if(o){var n;const a=this.getBoundVAO(),l=a==null?void 0:a.indexBuffer,c={indexBuffer:l,vertexBuffers:a==null?void 0:a.vertexBuffers},h={mode:t,count:i,type:r,offset:s},p=(n=oo(l,y=>y.size))!=null?n:0,f=s+i,g=p<f?`. Buffer is too small. Attempted to draw index ${f} of ${p}`:"";console.error(`drawElements: ${o}${g}`,{args:h,vao:c})}}}logIno(){eu()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(t,i,r,s){r=Math.max(Math.round(r),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===t&&n.y===i&&n.width===r&&n.height===s||(n.x=t,n.y=i,n.width=r,n.height=s,this.gl.viewport(t,i,r,s))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(t){var i,r;this._state.program!==t&&((i=this._state.program)==null||i.stop(),this._state.program=t,this.gl.useProgram((r=t==null?void 0:t.glName)!=null?r:null))}bindTexture(t,i,r=!1){(i>=this.parameters.maxTextureImageUnits||i<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[i];return O(t)||t.glName==null?(_(s)&&(this.setActiveTexture(i,r),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[i]=null,s):r||s!==t?(this.setActiveTexture(i,r),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._state.textureUnitMap[i]=t,s):(t.isDirty&&(this.setActiveTexture(i,r),t.applyChanges()),s)}unbindTextureAllUnits(t){for(let i=0;i<this.parameters.maxTextureImageUnits;i++)this._state.textureUnitMap[i]===t&&(this.bindTexture(null,i),this._state.textureUnitMap[i]=null)}bindFramebuffer(t,i=!1){if(i||this._state.readFramebuffer!==t||this._state.drawFramebuffer!==t){if(O(t))return this.gl.bindFramebuffer(Gs.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);t.initializeAndBind(Gs.FRAMEBUFFER),this._state.readFramebuffer=t,this._state.drawFramebuffer=t}}bindFramebufferSeparate(t,i,r=!1){const s=i===Gs.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(r||n!==t)&&(O(t)?this.gl.bindFramebuffer(i,null):t.initializeAndBind(i),s?this._state.readFramebuffer=gt(t,null):this._state.drawFramebuffer=gt(t,null))}blitFramebuffer(t,i,r=0,s=0,n=t.width,o=t.height,a=0,l=0,c=i.width,h=i.height,p=bi.COLOR_BUFFER_BIT,f=Ve.NEAREST){this.bindFramebufferSeparate(t,Gs.READ_FRAMEBUFFER),this.bindFramebufferSeparate(i,Gs.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(r,s,n,o,a,l,c,h,p,f)}bindBuffer(t,i){if(t)switch(i!=null||(i=t.bufferType),i){case ft.ARRAY_BUFFER:this._state.vertexBuffer=Da(this.gl,t,i,this._state.vertexBuffer);break;case ft.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Da(this.gl,t,i,this._state.indexBuffer);break;case ft.UNIFORM_BUFFER:this._state.uniformBuffer=Da(this.gl,t,i,this._state.uniformBuffer);break;case ft.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Da(this.gl,t,i,this._state.pixelPackBuffer);break;case ft.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Da(this.gl,t,i,this._state.pixelUnpackBuffer);break;case ft.COPY_READ_BUFFER:this._state.copyReadBuffer=Da(this.gl,t,i,this._state.copyReadBuffer);break;case ft.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Da(this.gl,t,i,this._state.copyWriteBuffer)}}bindRenderbuffer(t){const i=this.gl;t||(i.bindRenderbuffer(i.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==t&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glName),this._state.renderbuffer=t)}_getBufferBinding(t,i){if(i>=this.parameters.maxUniformBufferBindings||i<0)return console.error("Uniform buffer binding point is out of range!"),null;const r=this._state.uniformBufferBindingPoints;let s=r[i];return O(s)&&(s={buffer:null,offset:0,size:0},r[i]=s),s}bindBufferBase(t,i,r){const s=this._getBufferBinding(t,i);O(s)||s.buffer===r&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(t,i,r?r.glName:null),s.buffer=r,s.offset=0,s.size=0)}bindBufferRange(t,i,r,s,n){const o=this._getBufferBinding(t,i);if(!O(o)&&!(o.buffer===r&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(t,i,r.glName,s,n),o.buffer=r,o.offset=s,o.size=n}}bindUBO(t,i,r,s){O(i)?this.bindBufferBase(ft.UNIFORM_BUFFER,t,null):(eu()&&(s!=null?s:i.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),i.initialize(),r!==void 0&&s!==void 0?this.bindBufferRange(ft.UNIFORM_BUFFER,t,i.buffer,r,s):this.bindBufferBase(ft.UNIFORM_BUFFER,t,i.buffer))}unbindUBO(t){for(let i=0,r=this._state.uniformBufferBindingPoints.length;i<r;i++){const s=this._state.uniformBufferBindingPoints[i];_(s)&&s.buffer===t.buffer&&this.bindBufferBase(ft.UNIFORM_BUFFER,i,null)}}unbindBuffer(t){switch(t){case ft.ARRAY_BUFFER:this._state.vertexBuffer=Da(this.gl,null,t,this._state.vertexBuffer);break;case ft.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Da(this.gl,null,t,this._state.indexBuffer);break;case ft.UNIFORM_BUFFER:this._state.uniformBuffer=Da(this.gl,null,t,this._state.uniformBuffer);break;case ft.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Da(this.gl,null,t,this._state.pixelPackBuffer);break;case ft.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Da(this.gl,null,t,this._state.pixelUnpackBuffer);break;case ft.COPY_READ_BUFFER:this._state.copyReadBuffer=Da(this.gl,null,t,this._state.copyReadBuffer);break;case ft.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Da(this.gl,null,t,this._state.copyWriteBuffer)}}bindVAO(t=null){O(t)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==t&&(t.bind(),this._state.vertexArrayObject=t)}async clientWaitAsync(t=10){const i={};this.instanceCounter.increment(Ns.Sync,i);const r=this.gl,s=r.fenceSync(uB.SYNC_GPU_COMMANDS_COMPLETE,0);let n;r.flush();do await Wx(t),n=r.clientWaitSync(s,0,0);while(n===H$.TIMEOUT_EXPIRED);if(r.deleteSync(s),this.instanceCounter.decrement(Ns.Sync,i),n===H$.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(t=Gs.FRAMEBUFFER){return t===Gs.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(ft.ARRAY_BUFFER),this.unbindBuffer(ft.ELEMENT_ARRAY_BUFFER),Ws(this.gl)&&(this.unbindBuffer(ft.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(ft.PIXEL_PACK_BUFFER),this.unbindBuffer(ft.PIXEL_UNPACK_BUFFER),this.unbindBuffer(ft.COPY_READ_BUFFER),this.unbindBuffer(ft.COPY_WRITE_BUFFER));for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(Ee.ONE,Ee.ZERO),this.setBlendEquation(fp.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(ma.BACK),this.setFrontFace(gT.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(Di.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(Di.ALWAYS,0,0),this.setStencilOp(Fi.KEEP,Fi.KEEP,Fi.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var t,i;const r=this.gl,s=this.capabilities.vao;s&&s.bindVertexArray(null);for(let c=0;c<this.parameters.maxVertexAttributes;c++)r.disableVertexAttribArray(c);if(this._state.vertexBuffer?r.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):r.bindBuffer(ft.ARRAY_BUFFER,null),this._state.indexBuffer?r.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):r.bindBuffer(ft.ELEMENT_ARRAY_BUFFER,null),Ws(r)){var n,o;this._state.uniformBuffer?r.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):r.bindBuffer(ft.UNIFORM_BUFFER,null);for(let c=0;c<this._parameters.maxUniformBufferBindings;c++){const h=this._state.uniformBufferBindingPoints[c];if(_(h)&&h.buffer!==null){const{buffer:p,offset:f,size:g}=h;f===0&&g===0?r.bindBufferBase(ft.UNIFORM_BUFFER,c,p.glName):r.bindBufferRange(ft.UNIFORM_BUFFER,c,p.glName,f,g)}else r.bindBufferBase(ft.UNIFORM_BUFFER,c,null)}this._state.pixelPackBuffer?r.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):r.bindBuffer(ft.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?r.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):r.bindBuffer(ft.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?r.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):r.bindBuffer(ft.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?r.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):r.bindBuffer(ft.COPY_WRITE_BUFFER,null),r.bindFramebuffer(Gs.READ_FRAMEBUFFER,null),r.readBuffer(r.BACK),this._state.readFramebuffer&&(r.bindFramebuffer(Gs.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),r.readBuffer(kl.COLOR_ATTACHMENT0)),r.bindFramebuffer(Gs.DRAW_FRAMEBUFFER,(n=(o=this._state.drawFramebuffer)==null?void 0:o.glName)!=null?n:null)}else{var a,l;this._state.readFramebuffer=this._state.drawFramebuffer,r.bindFramebuffer(Gs.FRAMEBUFFER,(a=(l=this._state.drawFramebuffer)==null?void 0:l.glName)!=null?a:null)}if(s&&this._state.vertexArrayObject){const c=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(c)}r.useProgram((t=(i=this._state.program)==null?void 0:i.glName)!=null?t:null),r.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),r.bindRenderbuffer(r.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),r.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),r.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),r.clearDepth(this._state.clearDepth),r.clearStencil(this._state.clearStencil),r.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),r.cullFace(this._state.cullFace),r.depthFunc(this._state.depthFunction),r.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._state.depthWrite),r.frontFace(this._state.frontFace),r.lineWidth(1),this._state.faceCulling===!0?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),r.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._state.stencilWriteMask);for(let c=0;c<this.parameters.maxTextureImageUnits;c++){r.activeTexture(F4+c),r.bindTexture(rt.TEXTURE_2D,null),r.bindTexture(rt.TEXTURE_CUBE_MAP,null),Ws(r)&&(r.bindTexture(rt.TEXTURE_3D,null),r.bindTexture(rt.TEXTURE_2D_ARRAY,null));const h=this._state.textureUnitMap[c];_(h)&&r.bindTexture(h.descriptor.target,h.glName)}r.activeTexture(F4+this._state.activeTexture),r.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),eu()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadExtensions(){this.type===Kt.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(t){var i;const r=this.capabilities.textureFilterAnisotropic,s=(i=t.maxAnisotropy)!=null?i:1/0,n=Ws(this.gl),o=this.gl,a={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:r?Math.min(this.gl.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:n?o.getParameter(o.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:n?o.getParameter(o.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:n?o.getParameter(o.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:n?o.getParameter(o.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:n?o.getParameter(o.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:n?o.getParameter(o.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:n?o.getParameter(o.MAX_SAMPLES):1};return Ze.TEXTURE_UNIT_FOR_UPDATES=a.maxTextureImageUnits-1,a}}function Da(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function jre(e,t){switch(e){case Tt.POINTS:return 2*t;case Tt.TRIANGLES:return t/3;case Tt.TRIANGLE_STRIP:case Tt.TRIANGLE_FAN:return t-2;default:return 0}}class jct extends Gct{constructor(t,i,r){super(t,i),this.newCache=r,this._refCount=1}dispose(){--this._refCount>0||super.dispose()}ref(){++this._refCount}useTechnique(t,i=null,r){return this.useProgram(t.program),t.bindPipelineState(this,i,r),t.program}isTechniqueCompiled(t){return t.program.isCompiled}get test(){return this.programCache.test}}const I_e=he.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let Hw=class extends we{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new wr,this._frameTask=e.resourceController.scheduler.registerTask(ut.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(Wh.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return O(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(lO,new tq)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),gt(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{const i=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e&&this.events.emit("changed",ts.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(O(t))return ot(t!==void 0),null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),r=new Hct(e,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),_(t.glTexture)?(this._updateGLTexture(r,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const s=t.load(this._rctx,()=>this.textureTechnique),n=a=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,a),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r),o=a=>(this._loadingCount--,r.loadingPromise=null,vr(a)||I_e.error(a),null);return _c(s)?s.then(n,o):n(s)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",ts.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],Hw.prototype,"_loadingCount",void 0),u([d()],Hw.prototype,"_frameTask",void 0),u([d()],Hw.prototype,"updating",null),Hw=u([P("esri.views.3d.webgl-engine.lib.TextureRepository")],Hw);class Hct{constructor(t,i){this.id=t,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(I_e.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const qct=he.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let tA=class extends we{constructor(){super(...arguments),this._data=new Array,this.loadingState=ua.NOT_LOADED}dispose(){this.loadingState=ua.NOT_LOADED,this._data.forEach(e=>e.dispose()),this._data.length=0}get updating(){return this.loadingState===ua.LOADING}get ready(){return this.loadingState===ua.LOADED}loadTextures(e){const t=[ui("esri/images/materials/water/normals.jpg"),ui("esri/images/materials/water/perturbation.jpg")];this.loadingState=ua.LOADING,Promise.all(t.map(i=>Cu(i))).then(i=>{i.forEach(r=>this._data.push(new Ze(e,{target:rt.TEXTURE_2D,pixelFormat:Ie.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:lt.REPEAT,samplingMode:Ve.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8,width:r.width,height:r.height},r))),this.loadingState=ua.LOADED}).catch(i=>{qct.error("Failed to load textures for water material.",i),this.loadingState=ua.NOT_LOADED})}bind(e){this.ready&&(e.bindTexture(this._data[0],"texWaveNormal"),e.bindTexture(this._data[1],"texWavePerturbation"))}};u([d()],tA.prototype,"loadingState",void 0),u([d({type:Boolean,readOnly:!0})],tA.prototype,"updating",null),tA=u([P("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],tA);class Wct extends mF{constructor(t,i,r,s,n,o){super(),this._rctx=t,this._renderScene=i,this._requestRenderScene=r,this._renderOverlay=s,this._forceCameraHook=n,this._disposeOffscreenBuffers=o,this.supersample=!0,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(t){this._requestRenderScene(ts.BACKGROUND);const i=um();return this._screenshotQueue.push({settings:t,resolver:i}),i.promise}update(t){for(const i of this._screenshotQueue){if(this.isDisposed){i.resolver.reject();continue}const r=me(I({},i.settings),{pixelRatio:i.settings.pixelRatio*t.viewCamera.pixelRatio}),s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(t,r),o=VZe(n,r,s,{flipY:!0,premultipliedAlpha:!0});i.resolver(o)}this._screenshotQueue.length=0}_renderScreenshotOverlay(t,i,r){if(O(this._renderOverlay))return i;t.width=i.width,t.height=i.height;const s=t.getContext("2d"),n=r.pixelRatio;return s.save(),s.translate(0,i.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(n,n),i=this._renderOverlay(t,i),s.restore(),i}_readbackScreenshot(t,i){return t.resample?this._readbackScreenshotResampled(t,i):this._readbackScreenshotImmediate(t,i)}_readbackScreenshotResampled(t,i){const{framebufferWidth:r,framebufferHeight:s,region:n,resample:o}=t,a=this._ensureScreenshotEncodeCanvas();let l=GU(r,s,a);this._rctx.gl.readPixels(0,0,r,s,Ie.RGBA,nt.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),i(),l=this._renderScreenshotOverlay(a,l,me(I({},t),{region:null}));const c=GU(n.width,n.height,a);return HZe(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(t,i){const{framebufferHeight:r,region:s}=t,n=this._ensureScreenshotEncodeCanvas(),o=GU(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,Ie.RGBA,nt.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),i(),this._renderScreenshotOverlay(n,o,t)}_renderScreenshot(t,i){let r=null;const s=t.viewCamera,{framebufferWidth:n,framebufferHeight:o}=i;let a=!1;const l=i.disableDecorations&&t.frameHasDecorations,c=n!==s.fullWidth||o!==s.fullHeight,h=i.ignorePadding&&s.pixelRatio!==i.pixelRatio,p=c||l||h;if(p){const y=s.clone();if(i.ignorePadding){const w=oN(y.padding);for(let S=0;S<4;S++)w[S]=Math.round(w[S]/y.pixelRatio*i.pixelRatio);y.padding=w}y.fullWidth=n,y.fullHeight=o,y.pixelRatio=i.pixelRatio;const v=s.fovX-y.fovX,b=s.fovY-y.fovY;v<0&&v<b?y.fovX=s.fovX:b<0&&b<v&&(y.fovY=s.fovY),this._forceCameraHook(y),a=!0,r=new ki(this._rctx,{width:y.fullWidth,height:y.fullHeight,colorTarget:gr.TEXTURE,depthStencilTarget:ti.DEPTH_STENCIL_RENDER_BUFFER}),this._renderScene(r,y,i.disableDecorations?b1.OFF:b1.ON),this._disposeOffscreenBuffers()}const f=()=>{this._rctx.bindFramebuffer(null),et(r)},g=this._readbackScreenshot(i,f);if(f(),p&&!this._rctx.contextAttributes.alpha)for(let y=3;y<g.data.length;y+=4)g.data[y]=255;return a&&this._forceCameraHook(s),g}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const Hre=he.getLogger("esri.views.3d.webgl-engine.parts.View");let Rn=class extends fF(we){constructor(e){super({}),this.events=new wr,this.waterTextureRepository=new tA,this._magnifierHelper=new jw,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._initializeContext(e),Wt(this.waterTextureRepository,"loadingState",()=>this.requestRender()),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new s0e(this._rctx),this._shaderTechniqueRepository=new Mye({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new Hw(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",t=>this.requestRender(t)),this._materialRepository=new Vye(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new jot(this._rctx,this._shaderTechniqueRepository),this._renderer=new Of(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,t=>this.requestRender(t),(t,i)=>e.schedule(t,i),e),this._screenshotManager=new Wct(this._rctx,(t,i,r)=>this._renderer.render(t,i,i,r),t=>this.requestRender(t),e.options.screenshot.renderOverlay,t=>this.events.emit("force-camera-for-screenshot",t),()=>this._renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Ys(this._frameTask),this._shaderTechniqueRepository=et(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=ts.UPDATE){e===ts.UPDATE?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.requestRender()}setRenderParameters(e){e.idleSuspend!==void 0&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,i,r,s,n=s){const o=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),a=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],a);let l=Number.MAX_VALUE;for(let c=0;c<o[2]*o[3];c++){const h=Yot(4*c,a,r.nearFar);l>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(l=h)}if(_(e)){const c=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);_(c)&&l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(O(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){Dve(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}get animationTimestep(){return this._renderer.animationTimestep}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let r=!1,s=ts.BACKGROUND,n=!1;const o={preRender:a=>{r=this.updating,s=this._needsUpdate?ts.UPDATE:ts.BACKGROUND,e.processSyncLayers();const l=a.time-this._lastAnimationUpdate;(l>this.animationTimestep||_(this.forcedAnimationTime)||r||this._needsRender)&&(this._renderer.updateAnimation({camera:t.camera,dt:l,forcedTime:this.forcedAnimationTime})&&this.requestRender(ts.BACKGROUND),this._lastAnimationUpdate=a.time)},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const a=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,b1.ON),n=!0,a&&this._renderer.hasWaterReflection&&(this.requestRender(ts.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)},finish:()=>{n&&(this._renderer.finish(s),n=!1)}};this._frameTask=e1(o)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil==null||t.stencil,powerPreference:"high-performance"},r=LRe("3d",this._canvas,i);if(O(r)){const s=ue("esri-force-webgl");Hre.error(s)}else this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&Hre.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&ue("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},r=(s,n)=>t.resourceController.memoryController.newCache(s,n);return new jct(e,i,r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return O(this._componentObjectCollection)&&(this._componentObjectCollection=new Vot(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};u([d({type:Boolean,readOnly:!0})],Rn.prototype,"updating",null),u([Mn()],Rn.prototype,"_rctx",void 0),u([Mn()],Rn.prototype,"_container",void 0),u([Mn()],Rn.prototype,"_canvas",void 0),u([Mn()],Rn.prototype,"_stippleTextureRepository",void 0),u([Mn(),d()],Rn.prototype,"waterTextureRepository",void 0),u([Mn(),d()],Rn.prototype,"_magnifierHelper",void 0),u([Mn(),d()],Rn.prototype,"_textureRepository",void 0),u([Mn()],Rn.prototype,"_compositingHelper",void 0),u([Mn()],Rn.prototype,"_renderer",void 0),u([Mn()],Rn.prototype,"_screenshotManager",void 0),u([Mn()],Rn.prototype,"componentObjectCollection",null),u([Mn()],Rn.prototype,"_componentObjectCollection",void 0),u([d()],Rn.prototype,"_needsUpdate",void 0),u([d()],Rn.prototype,"_needsWaterReflectionUpdate",void 0),Rn=u([P("esri.views.3d.webgl-engine.parts.RenderView")],Rn);var KI;let ia=KI=class extends fF(we){constructor(e){super(e),this._handles=new Bt,this._model=new XI,this._layers=new $t,this._changeSet=new Pye,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Rn(this)),this._frameTask=this.resourceController.scheduler.registerTask(ut.STAGE,this),this._handles.add(this._frameTask)}destroy(){P1.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(e){this._model.add(e),JD(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){O(e)||(this.renderView.requestRender(),this._model.remove(e),JD(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){_(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){_(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e){O(e)||(Array.isArray(e)||(e=[e]),await U9(e.filter(t=>O(t.glTexture)).map(t=>this.schedule(()=>this._model.has(t)?t.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null))))}loadImmediate(e){return e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;KI.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),KI.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map(t=>t.id)),console.log("RGs remove: "+this._changeSet.removes.map(t=>t.id))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(t=>{(this._layerSyncSet.has(t.id)||t.updatePolicy===CT.SYNC)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))});for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some(t=>t===e)||this._layers.push(e)}_removeLayer(e){this._commit(),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{Zte(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(_c(r))return r.then(s);s()}removeRenderPlugin(e){Zte(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter(i=>i.type===t).length,model:e._model}}};ia.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},u([d({constructOnly:!0})],ia.prototype,"resourceController",void 0),u([d({constructOnly:!0})],ia.prototype,"options",void 0),u([d({constructOnly:!0})],ia.prototype,"state",void 0),u([d({constructOnly:!0})],ia.prototype,"sceneIntersectionHelper",void 0),u([d({readOnly:!0})],ia.prototype,"viewingMode",null),u([d({constructOnly:!0})],ia.prototype,"container",void 0),u([d({constructOnly:!0})],ia.prototype,"renderSR",void 0),u([d({constructOnly:!0})],ia.prototype,"_handles",void 0),u([d({readOnly:!0})],ia.prototype,"updating",null),u([d({constructOnly:!0})],ia.prototype,"_model",void 0),u([Mn(),d()],ia.prototype,"renderView",void 0),ia=KI=u([P("esri.views.3d.webgl-engine.Stage")],ia);function $_e(e){return Mp(e)&&e.intersector===lr.PCL&&!!e.target}function D_e(e){return Mp(e)&&e.intersector===lr.I3S&&!!e.target}function Xct(e){return Mp(e)&&e.intersector===lr.TERRAIN&&!!e.target}function L_e(e){return Mp(e)&&e.intersector===lr.OVERLAY&&!!e.target}function Yct(e){return Mp(e)&&e.intersector===lr.LOD&&!!e.target}function qre(e,t){return cme(e)||oH(e)?bL(e.target.object.metadata,t):Xct(e)?(i=t.map)==null?void 0:i.ground:$_e(e)||D_e(e)||L_e(e)?bL(e.target,t):null;var i}function Wre(e,t){return cme(e)||oH(e)?Xre(e.target.object.metadata,t):$_e(e)?e.target.createGraphic():L_e(e)||Yct(e)?Xre(e.target,t):D_e(e)?Zct(e.target,t):null}function Xre(e,t){if(O(e)||O(e.graphicUid))return null;const i=bL(e,t);if(O(i))return null;if(i===t.graphics)return _(t.graphicsView)?t.graphicsView.getGraphicFromGraphicUid(e.graphicUid):null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromGraphicUid"in r&&_(e.graphicUid)?r.getGraphicFromGraphicUid(e.graphicUid):null}function Zct(e,t){const i=bL(e,t);if(O(i))return null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?r.getGraphicFromIntersectorTarget(e):null}function bL(e,t){return O(e.layerUid)?null:_(t.graphicsView)&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}async function Qct(e,t){if(e.type==="2d")return e.hitTest(t);const i=await e.hitTest(t),r=i.results[0],s=i.results.findIndex(n=>n.distance!==r.distance);return s!==-1&&(i.results=i.results.slice(0,s)),i}let Bk,Vk;function Yre(e){switch(e){case Kt.WEBGL1:return Jct();case Kt.WEBGL2:return Kct()}}function Jct(){return Bk||(Bk=iut()),Bk}function Kct(){return Vk||(Vk=rut()),Vk}class N_e{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1}}class eut extends N_e{constructor(){super(...arguments),this.type=Kt.WEBGL1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1}}class tut extends N_e{constructor(){super(...arguments),this.type=Kt.WEBGL2}}function F_e(e,t){if(e===Kt.WEBGL1&&typeof WebGLRenderingContext===void 0||e===Kt.WEBGL2&&typeof WebGL2RenderingContext===void 0)return null;const i=document.createElement("canvas");if(!i)return null;let r=j$(i,e,{failIfMajorPerformanceCaveat:!0});if(O(r)&&(r=j$(i,e),_(r)&&(t.majorPerformanceCaveat=!0)),O(r))return r;if(e===Kt.WEBGL1){const n=r.getParameter(r.VERSION),o=n==null?void 0:n.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);t.available=a>=.94}}else t.available=!0;t.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),t.supportsVertexShaderSamplers=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT);return s&&(t.supportsHighPrecisionFragment=s.precision>0),r}function iut(){const e=new eut,t=F_e(Kt.WEBGL1,e);return O(t)||(e.supportsElementIndexUint=t.getExtension("OES_element_index_uint")!==null,e.supportsStandardDerivatives=t.getExtension("OES_standard_derivatives")!==null,e.supportsInstancedArrays=t.getExtension("ANGLE_instanced_arrays")!==null,e.supportsTextureFloat=t.getExtension("OES_texture_float")!==null),e}function rut(){const e=new tut,t=F_e(Kt.WEBGL2,e);return O(t),e}function sut(e){const t=nut(e);if(!t.available)return new Q("webgl:required","WebGL is required but not supported.");if(e==="3d"&&t.majorPerformanceCaveat)return new Q("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!t.supportsHighPrecisionFragment)return new Q("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!t.supportsVertexShaderSamplers)return new Q("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(t.type===Kt.WEBGL1){if(!t.supportsElementIndexUint)return new Q("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!t.supportsStandardDerivatives)return new Q("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!t.supportsInstancedArrays)return new Q("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function nut(e){const t=hce(e);for(;t.length>1;){const i=Yre(t.shift());if(i.available)return i}return Yre(t.shift())}function out(e){return e&&"nodeType"in e}function aut(e){return e&&typeof e.render=="function"}const Zre={component:"esri-component"};let n_=class extends we{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(Zre.component),t&&t.classList.remove(Zre.component),this._set("node",e))}castNode(e){return e?typeof e=="string"||out(e)?(this._set("widget",null),QL(e)):(aut(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],n_.prototype,"id",null),u([d()],n_.prototype,"node",null),u([It("node")],n_.prototype,"castNode",null),u([d({readOnly:!0})],n_.prototype,"widget",void 0),n_=u([P("esri.views.ui.Component")],n_);const e$=n_,lut={left:0,top:0,bottom:0,right:0},U_e={bottom:30,top:15,right:15,left:15},Gk="manual",Zo={ui:"esri-ui",corner:"esri-ui-corner",innerContainer:"esri-ui-inner-container",manualContainer:"esri-ui-manual-container",cornerContainer:"esri-ui-corner-container",topLeft:"esri-ui-top-left",topRight:"esri-ui-top-right",bottomLeft:"esri-ui-bottom-left",bottomRight:"esri-ui-bottom-right"};function cut(e){return e&&!e._started&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}function jk(e){const t=e,i=typeof t=="object"&&t!==null&&Object.getPrototypeOf(t);return(i===null||i===Object.prototype)&&("component"in t||"index"in t||"position"in t)?e:null}function Hk(e,{top:t,bottom:i,left:r,right:s}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=s}let Mf=class extends wr.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._handles=new Bt,this.view=null,this._applyViewPadding=()=>{const t=this.container;t&&Hk(t,this._toPxPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const t=this._innerContainer;t&&Hk(t,this._toPxPosition(this.padding))},this._initContainers()}initialize(){this._handles.add([Nt(()=>{var e;return[(e=this.view)==null?void 0:e.padding,this.container]},this._applyViewPadding,un),Nt(()=>this.padding,this._applyUIPadding,un)])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._handles.destroy(),this._componentToKey.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(Zo.ui),e.classList.add(_Pe()),this._attachContainers(e)),t&&(t.classList.remove(Zo.ui),Hk(t,{top:"",bottom:"",left:"",right:""}),Eae(t)),this._set("container",e))}get height(){const e=this.get("view.height")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.top+t.bottom;return Math.max(e-i,0)}get padding(){return this._get("padding")}set padding(e){e?this._override("padding",e):this._clearOverride("padding")}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:I(I({},U_e),e)}get width(){const e=this.get("view.width")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.left+t.right;return Math.max(e-i,0)}add(e,t){let i,r;if(Array.isArray(e))return void e.forEach(n=>this.add(n,t));const s=jk(e);s&&({index:i,position:t,component:e,key:r}=s),t&&typeof t=="object"&&({index:i,key:r,position:t}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i,r)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(r=>this.remove(r,t));const i=this._find(e);if(i){const r=this._componentToKey;if(r.has(e)&&r.get(e)!==t)return;const s=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(e),this._components.splice(s,1)[0]}}empty(e){return Array.isArray(e)?e.map(t=>this.empty(t)).reduce((t,i)=>t.concat(i)):(e=e||Gk)===Gk?Array.prototype.slice.call(this._manualContainer.children).filter(t=>!t.classList.contains(Zo.corner)).map(t=>this.remove(t)):this._isValidPosition(e)?Array.prototype.slice.call(this._cornerNameToContainerLookup[e].children).map(this.remove,this):null}move(e,t){if(Array.isArray(e)&&e.forEach(n=>this.move(n,t)),!e)return;let i;const r=jk(e)||jk(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r){e instanceof e$||(e=new e$({node:e})),this._place({component:e,position:t,index:i}),this._components.push(e),r&&this._componentToKey.set(e,r)}_find(e){return e?e instanceof e$?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.get("view.padding")||lut}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(Zo.innerContainer),e.classList.add(Zo.cornerContainer);const t=document.createElement("div");t.classList.add(Zo.innerContainer),t.classList.add(Zo.manualContainer);const i=document.createElement("div");i.classList.add(Zo.topLeft),i.classList.add(Zo.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(Zo.topRight),r.classList.add(Zo.corner),e.appendChild(r);const s=document.createElement("div");s.classList.add(Zo.bottomLeft),s.classList.add(Zo.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(Zo.bottomRight),n.classList.add(Zo.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const o=Py();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":o?r:i,"top-trailing":o?i:r,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup=I({manual:t},this._cornerNameToContainerLookup)}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.component,i=e.position||Gk,r=e.index,s=this._positionNameToContainerLookup[i],n=r>-1;if(cut(t.widget)&&t.widget.startup(),!n)return void s.appendChild(t.node);const o=Array.prototype.slice.call(s.children);if(r===0)return void(s.firstChild?dX(t.node,s.firstChild):s.appendChild(t.node));r>=o.length?s.appendChild(t.node):dX(t.node,o[r])}_toPxPosition(e){return{top:this._toPxUnit(e.top),left:this._toPxUnit(e.left),right:this._toPxUnit(e.right),bottom:this._toPxUnit(e.bottom)}}_toPxUnit(e){return e===0?"0":e+"px"}_findByComponent(e){let t,i=null;return this._components.some(r=>(t=r===e,t&&(i=r),t)),i}_findById(e){let t,i=null;return this._components.some(r=>(t=r.id===e,t&&(i=r),t)),i}_findByNode(e){let t,i=null;return this._components.some(r=>(t=r.node===e,t&&(i=r),t)),i}};u([d()],Mf.prototype,"container",null),u([d()],Mf.prototype,"height",null),u([d({value:U_e})],Mf.prototype,"padding",null),u([It("padding")],Mf.prototype,"castPadding",null),u([d()],Mf.prototype,"view",void 0),u([d()],Mf.prototype,"width",null),Mf=u([P("esri.views.ui.UI")],Mf);const uut=Mf;function Qre(e,t){return e&&"copyright"in e&&(!t||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function hut(e,t){return e.length!==t.length||e.some((i,r)=>i.text!==t[r].text)}function a3(e,t,i){!i||!t||e.find(r=>r.layerView===t&&r.text===i)||e.push({text:i,layerView:t})}function dut(e){return e.type==="bing-maps"}const bg=[];let qw=class extends aT{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new pt,this.view=null,this._allLayerViewsChange=t=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(r=>r.watch(["suspended","attributionVisible"],this._updateAttributionItems)),"suspension"),t&&t.removed&&t.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this._updateAttributionItems=()=>{const t=this.get("view.allLayerViews");bg.length=0,t?(t.forEach(i=>{if(i.suspended||!i.get("layer.attributionVisible"))return;const r=i.layer;if(Qre(r,"user"))return void a3(bg,i,r.copyright);if(r.hasAttributionData){if(this._fetchedAttributionData.has(i)){const n=this._fetchedAttributionData.get(i);return void(n?a3(bg,i,this._getDynamicAttribution(n,this.view,r)):Qre(r)&&a3(bg,i,r.copyright))}return void this._fetchAttributionData(i)}const s=r.get("portalItem.accessInformation");a3(bg,i,s||r.copyright)}),hut(this.items,bg)&&(this.items.removeAll(),this.items.addMany(bg)),bg.length=0,this.notifyChange("state")):this._clear()},this.handles.add([mp(this,"view.allLayerViews","change",this._allLayerViewsChange,this._allLayerViewsChange,this._clear),fMe(this,"view.stationary",()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await Bh(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,dut(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let s=0;s<i.length;s++){const n=i[s],o=n.coverageAreas;if(!o)return;for(const a of o){const l=a.bbox,c=a.zoomMin-(t&&a.zoomMin?1:0),h=a.zoomMax-(t&&a.zoomMax?1:0),p={xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:tt.WGS84},f={extent:Kf(p),attribution:n.attribution||"",score:a.score!=null?a.score:100,id:s};for(let g=c;g<=h;g++)r[g]=r[g]||[],r[g].push(f)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:s}=t;let n=i.tileInfo.scaleToZoom(s);if(n=Math.min(e.maxKey,Math.round(n)),!r||n==null||n<=-1)return"";const o=e[n],a=z1(r.center.clone().normalize(),t.spatialReference),l={};return o?o.filter(c=>{const h=!l[c.id]&&a&&xR(c.extent,a);return h&&(l[c.id]=!0),h}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:pt})],qw.prototype,"items",void 0),u([d({readOnly:!0})],qw.prototype,"state",null),u([d()],qw.prototype,"view",void 0),qw=u([P("esri.widgets.Attribution.AttributionViewModel")],qw);const k_e=qw,wg={base:"esri-attribution esri-widget",poweredBy:"esri-attribution__powered-by",sources:"esri-attribution__sources",open:"esri-attribution--open",sourcesOpen:"esri-attribution__sources--open",link:"esri-attribution__link",widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let ra=class extends Ra{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this.iconClass=wg.widgetIcon,this.itemDelimiter=" | ",this.label=void 0,this.messages=null,this.view=null,this.viewModel=new k_e}initialize(){this.own(mp(this,"viewModel.items","change",()=>this.scheduleRender()))}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.indexOf(t.text)===-1&&e.push(t.text),e),[]).join(this.itemDelimiter)}render(){const e={[wg.open]:this._isOpen};return le("div",{bind:this,class:this.classes(wg.base,e),onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return le("div",{class:wg.poweredBy},"Powered by"," ",le("a",{class:wg.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:-1,{attributionText:r}=this,s=t?"button":void 0,n={[wg.sourcesOpen]:e,[wg.interactive]:t};return le("div",{afterCreate:this._afterSourcesNodeCreate,afterUpdate:this._afterSourcesNodeUpdate,bind:this,class:this.classes(wg.sources,n),innerHTML:r,role:s,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth}_afterSourcesNodeUpdate(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=e,n=s>=r,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(t=!0),this._isOpen){const a=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,a&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],ra.prototype,"_isOpen",void 0),u([d()],ra.prototype,"_isInteractive",null),u([d()],ra.prototype,"_attributionTextOverflowed",void 0),u([d()],ra.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],ra.prototype,"attributionText",null),u([d()],ra.prototype,"iconClass",void 0),u([d()],ra.prototype,"itemDelimiter",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],ra.prototype,"label",void 0),u([d(),ul("esri/widgets/Attribution/t9n/Attribution")],ra.prototype,"messages",void 0),u([mt("viewModel.view")],ra.prototype,"view",void 0),u([d({type:k_e})],ra.prototype,"viewModel",void 0),u([Kc()],ra.prototype,"_toggleState",null),ra=u([P("esri.widgets.Attribution")],ra);const put=ra,fut="esri.widgets.CompassViewModel";let o_=class extends _pe(we){constructor(e){super(e),this._handles=new Bt,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(Wt(this,"view",this._updateRotationWatcher))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){if(!this.get("view.ready"))return;const e={};this.view.type==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this.orientation={x:0,y:0,z:t}}_updateRotationWatcher(e){this._handles.removeAll(),e&&(e.type==="2d"?this._handles.add(Wt(this,"view.rotation",this._updateForRotation)):this._handles.add(Wt(this,"view.camera",this._updateForCamera)))}};u([d({readOnly:!0})],o_.prototype,"canShowNorth",null),u([d()],o_.prototype,"orientation",void 0),u([d({readOnly:!0})],o_.prototype,"state",null),u([d()],o_.prototype,"view",void 0),o_=u([P(fut)],o_);const z_e=o_,xg={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let kd=class extends Ra{constructor(e,t){super(e,t),this.goToOverride=null,this.iconClass=xg.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new z_e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,i=t==="disabled",r=(t==="rotation"?"rotation":"compass")=="compass",s=i?-1:0,n={[xg.disabled]:i,[xg.interactive]:!i},o={[xg.northIcon]:r,[xg.rotationIcon]:!r},{messages:a}=this;return le("div",{bind:this,class:this.classes(xg.base,n),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:s,"aria-label":a.reset,title:a.reset},le("span",{"aria-hidden":"true",class:this.classes(xg.icon,o),styles:this._toRotationTransform(e)}),le("span",{class:xg.text},a.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([mt("viewModel.goToOverride")],kd.prototype,"goToOverride",void 0),u([d()],kd.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],kd.prototype,"label",void 0),u([d(),ul("esri/widgets/Compass/t9n/Compass")],kd.prototype,"messages",void 0),u([mt("viewModel.view")],kd.prototype,"view",void 0),u([d({type:z_e})],kd.prototype,"viewModel",void 0),u([Kc()],kd.prototype,"_reset",null),kd=u([P("esri.widgets.Compass")],kd);const mut=kd;let Ww=class extends we{constructor(e){super(e),this._handles=new Bt,this.navigationMode="pan",this.view=null}initialize(){this._handles.add(S7(this,"view.inputManager",this._setNavigationMode.bind(this)))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")&&this.view.type==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],Ww.prototype,"state",null),u([d()],Ww.prototype,"navigationMode",void 0),u([d()],Ww.prototype,"view",void 0),Ww=u([P("esri.widgets.NavigationToggleViewModel")],Ww);const B_e=Ww,Fc={base:"esri-navigation-toggle esri-widget",button:"esri-navigation-toggle__button esri-widget--button",activeButton:"esri-navigation-toggle__button--active",panButton:"esri-navigation-toggle__button--pan",rotateButton:"esri-navigation-toggle__button--rotate",isLayoutHorizontal:"esri-navigation-toggle--horizontal",rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let zd=class extends Ra{constructor(e,t){super(e,t),this.iconClass=Fc.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new B_e}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",t=this.get("viewModel.navigationMode")==="pan",i={[Fc.disabled]:e,[Fc.isLayoutHorizontal]:this.layout==="horizontal"},r={[Fc.activeButton]:t},s={[Fc.activeButton]:!t},n=e?-1:0,o=this.messages.toggle;return le("div",{bind:this,class:this.classes(Fc.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:n,"aria-label":o,title:o},le("div",{class:this.classes(Fc.button,Fc.panButton,r)},le("span",{class:Fc.panIcon})),le("div",{class:this.classes(Fc.button,Fc.rotateButton,s)},le("span",{class:Fc.rotationIcon})))}_toggle(){this.toggle()}};u([d()],zd.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],zd.prototype,"label",void 0),u([d({value:"vertical"})],zd.prototype,"layout",null),u([d(),ul("esri/widgets/NavigationToggle/t9n/NavigationToggle")],zd.prototype,"messages",void 0),u([mt("viewModel.view")],zd.prototype,"view",void 0),u([d({type:B_e})],zd.prototype,"viewModel",void 0),u([Kc()],zd.prototype,"_toggle",null),zd=u([P("esri.widgets.NavigationToggle")],zd);const gut=zd,k2={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let Kg=class extends Ra{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const e=this.enabled?0:-1,t={[k2.disabled]:!this.enabled,[k2.interactive]:this.enabled},i={[this.iconClass]:!!this.iconClass};return le("div",{bind:this,class:this.classes(k2.button,t),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:e,title:this.title},le("span",{"aria-hidden":"true",role:"presentation",class:this.classes(k2.icon,i)}),le("span",{class:k2.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],Kg.prototype,"action",void 0),u([d()],Kg.prototype,"enabled",void 0),u([d()],Kg.prototype,"iconClass",void 0),u([d()],Kg.prototype,"title",void 0),u([Kc()],Kg.prototype,"_triggerAction",null),Kg=u([P("esri.widgets.IconButton")],Kg);const Jre=Kg;let Xw=class extends we{get canZoomIn(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMaxScale");return t===0||e>t}get canZoomOut(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMinScale");return t===0||e<t}};u([d({readOnly:!0})],Xw.prototype,"canZoomIn",null),u([d({readOnly:!0})],Xw.prototype,"canZoomOut",null),u([d()],Xw.prototype,"view",void 0),Xw=u([P("esri.widgets.Zoom.ZoomConditions2D")],Xw);const yut=Xw;let Yw=class extends we{get canZoomIn(){return!!this.get("view.ready")}get canZoomOut(){return!!this.get("view.ready")}};u([d({readOnly:!0})],Yw.prototype,"canZoomIn",null),u([d({readOnly:!0})],Yw.prototype,"canZoomOut",null),u([d()],Yw.prototype,"view",void 0),Yw=u([P("esri.widgets.Zoom.ZoomConditions3D")],Yw);const vut=Yw;let ey=class extends we{constructor(e){super(e),this.canZoomIn=!1,this.canZoomOut=!1}destroy(){this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new yut({view:e}):e.type==="3d"&&(this._zoomConditions=new vut({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():Qk(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():Qk(e.goTo({zoomFactor:.5}))}};u([d()],ey.prototype,"_zoomConditions",void 0),u([d({aliasOf:"_zoomConditions.canZoomIn",readOnly:!0})],ey.prototype,"canZoomIn",void 0),u([d({aliasOf:"_zoomConditions.canZoomOut",readOnly:!0})],ey.prototype,"canZoomOut",void 0),u([d({readOnly:!0})],ey.prototype,"state",null),u([d()],ey.prototype,"view",null),ey=u([P("esri.widgets.Zoom.ZoomViewModel")],ey);const V_e=ey,z2={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let Pf=class extends Ra{constructor(e,t){super(e,t),this.iconClass=z2.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new V_e}initialize(){this._zoomInButton=new Jre({action:this.zoomIn.bind(this),iconClass:z2.zoomInIcon}),this._zoomOutButton=new Jre({action:this.zoomOut.bind(this),iconClass:z2.zoomOutIcon})}destroy(){this._zoomInButton.destroy(),this._zoomOutButton.destroy(),this._zoomInButton=null,this._zoomOutButton=null}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}render(){const e=this.viewModel,t={[z2.horizontalLayout]:this.layout==="horizontal"};return this._zoomInButton.enabled=e.state==="ready"&&e.canZoomIn,this._zoomOutButton.enabled=e.state==="ready"&&e.canZoomOut,this._zoomInButton.title=this.messages.zoomIn,this._zoomOutButton.title=this.messages.zoomOut,le("div",{class:this.classes(z2.base,t)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],Pf.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Pf.prototype,"label",void 0),u([d({value:"vertical"})],Pf.prototype,"layout",null),u([d(),ul("esri/widgets/Zoom/t9n/Zoom")],Pf.prototype,"messages",void 0),u([mt("viewModel.view")],Pf.prototype,"view",void 0),u([d({type:V_e})],Pf.prototype,"viewModel",void 0),Pf=u([P("esri.widgets.Zoom")],Pf);const _ut=Pf,G_e="esri.views.ui.DefaultUI";function but(e){return e&&e.view!==void 0}he.getLogger(G_e);let t$=class extends uut{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-leading","navigation-toggle":"top-leading",zoom:"top-leading"},this.components=[]}initialize(){this._handles.add([Nt(()=>this.components,this._componentsWatcher.bind(this),un),Nt(()=>this.view,this._updateViewAwareWidgets.bind(this),un)])}_add(e,t,i,r){if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;e=this._createComponent(e)}super._add(e,t,i,r)}_removeComponents(e){e.forEach(t=>{const i=this._find(t);i&&(this.remove(i),i.destroy())})}_updateViewAwareWidgets(e){this.components.forEach(t=>{const i=this._find(t),r=i&&i.widget;but(r)&&(r.view=e)})}_componentsWatcher(e,t){this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}_adjustPadding(e){if(e.indexOf("attribution")===-1&&!this._isOverridden("padding")){const{top:t}=this.padding;this.padding=t}}_addComponents(e){this.initialized&&e.forEach(t=>this.add(this._createComponent(t),this._defaultPositionLookup[t]))}_createComponent(e){const t=this._createWidget(e);if(t)return new e$({id:e,node:t})}_createWidget(e){return e==="attribution"?this._createAttribution():e==="compass"?this._createCompass():e==="navigation-toggle"?this._createNavigationToggle():e==="zoom"?this._createZoom():void 0}_createAttribution(){return new put({view:this.view})}_createCompass(){return new mut({view:this.view})}_createNavigationToggle(){return new gut({view:this.view})}_createZoom(){return new _ut({view:this.view})}};u([d()],t$.prototype,"components",void 0),t$=u([P(G_e)],t$);const wut=t$;let i$=class extends wut{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],i$.prototype,"components",void 0),i$=u([P("esri.views.ui.3d.DefaultUI3D")],i$);const j_e=i$,Ol=he.getLogger("esri.views.SceneView");let Je=class extends jRe(xke(Nke(Mze))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new w0({slicePlane:Xle},this),this._resourceController=vit(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new G8({view:this}),this.labeler=new Kv({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new yT,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new Qpe,this.environmentManager=new ch,this.extent=null,this.floors=new pt,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new $ze({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new ctt,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new j_e,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new l9,aAe(),e&&e.environment||(this._defaults.environment=new Nw,this.environment=this._defaults.environment);const t=(r=null)=>{_(r)&&r.type===Si.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async s=>{try{await s.when()}catch{}this._updatingChanged()}))};this.handles.add([Tx(()=>{var r;return(r=this.map)==null?void 0:r.allLayers},"after-changes",r=>t(r),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),this.watch("map",r=>{r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new H7e({view:this});const i=()=>{const r=window.devicePixelRatio;r!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=r,this.notifyChange("pixelRatio"))};this.stateManager=new Ftt({view:this,updateDevicePixelRatio:i})}initialize(){this.groundView=new Lke({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Tx(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,t=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=t)},un),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,t=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=t)},un),this.updatingHandles.add(()=>this.qualitySettings.frameRate,t=>Cbe(t>0?1e3/Math.ceil(t):0),un),this.updatingHandles.add(()=>hi.SCENEVIEW_LOCKING_LOG,t=>this.defaultsFromMap.logDebugInformation=t,un),this.updatingHandles.add(()=>{var t;return(t=this.map)==null?void 0:t.ground},e,Yl),this.updatingHandles.add(()=>{var t,i;return(t=this.map)==null||(i=t.ground)==null?void 0:i.opacity},()=>this._updateDefaultHitTestOptions(),Yl),this.handles.add(this.watch("spatialReference",()=>this.notifyChange("clippingArea"),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=it(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=it(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=it(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if(this.viewingMode==="global")return null;let e=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||O(e)?(this._clippingArea=null,null):e instanceof Zt?this.spatialReference&&(e=l3(e,this.spatialReference),O(e))?(Ol.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),O(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Ol.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&this.viewingMode==="global"&&_(e)?Ol.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===$e.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return O(t)||O(e)||t.spatialReference.equals(e)?t:l3(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||tt.WGS84,i=l3(this.clippingArea,t);_(i)&&(e=_(e)?e.intersection(i):i);const r=this._get("dataExtent");return _(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||tt.WGS84;let t;const i=n=>{const o=l3(n,e);O(o)||(_(t)?t.union(o):t=o.clone())},r=this.basemapTerrain;if(r!=null&&r.spatialReference){const n=r.groundExtent;i(new Zt({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const n=o=>{!_(o.fullExtent)||o.type==="graphics"&&o.internal||i(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(O(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof Nw?e:e instanceof sfe?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(e):Nw.fromWebsceneEnvironment(e):ns(Nw,e):new Nw}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){_(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(t!=null&&(e=Math.min(e,t)),i!=null){const r=i/Math.max(this.width,this.height);e=Math.min(e,r)}return e}set maximumPixelRatio(e){_(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||_(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(O(this.state)||this.state.stationary)}set qualityProfile(e){VI.isValidProfile(e)&&(VI.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||VI.getDefaultProfile()}set slicePlane(e){if(_(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),O(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");uS(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?uce(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return e!=null?lS.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return!1;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(o=>{if(o.isFulfilled()){if(o.updating){if(s=!0,o.suspended||Nx(o))return;++n,r+=o.updatingProgress}}else++n});for(const o of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])_(o)&&o.updating&&(n+=.1,r+=.5*.1);for(const o of[this.deconflictor,this.labeler,this.basemapTerrain])_(o)&&o.updating&&(++n,r+=o.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||(e=this.inputManager)!=null&&e.hasPendingInputs||(t=this.map)!=null&&(i=t.allLayers)!=null&&i.some(o=>!o.isFulfilled())),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const o=this._resourceController.scheduler.now;if(r<1){const a=Math.min((o-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-a)+r*a}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?o:0}return s}get viewingMode(){var e;const t=this._predeterminedViewingMode;if(_(t))return CA(t);const i=this.spatialReference;return i?_((e=this.defaultsFromMap)==null?void 0:e.viewingMode)&&i.equals(this.defaultsFromMap.spatialReference)?CA(this.defaultsFromMap.viewingMode):BD(i,$e.Global)?"global":"local":"global"}set viewingMode(e){this.ready?Ol.error("#viewingMode","viewingMode cannot be set once view is ready"):e?this._override("viewingMode",e):e===void 0&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new Git(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return Ol.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=_(i.graphics)&&(_(i.graphics.include)||_(i.graphics.exclude)),s=aJ(e)?oJ(this,e):e,n=zf(s);i.enableDraped=i.include&&!i.include.has(v_)||i.exclude&&i.exclude.has(v_);const o=this.sceneIntersectionHelper,a=Ou(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=r?Bn.ALL:Bn.MIN,o.intersectIntersectorScreen(n,a,i),r){for(const l of a.results.all){const c=Wre(l,this);if(O(c))return this._intersectResultToMapPoint(l);if(this._testGraphicUidFilter(i.graphics,c))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(e){if(!this.ready)return Ol.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=gt(e.z==null&&Mh(this.elevationProvider,e),0);return Qs(e,ew,this.renderSpatialReference,t),this.state.camera.projectToScreen(ew,qk),zh(qk[0],qk[1])}pixelSizeAt(e){return this.ready?e?(Qs(e,ew,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(ew)):0:(Ol.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return Ol.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=aJ(e)?oJ(this,e):e,r=Cr(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=Ou(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=Bn.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=qre(a,this),c=_(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Mp(a)?a.distanceInRenderSpace:0,layer:c}};return hi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return Qct(this,e).then(({results:t,ground:i})=>{let r=null;return!(t.length===0||Math.abs(gt(t[0].distance,0)-i.distance)<1e-5)||i.layer&&i.layer.type==="integrated-mesh"||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}})}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(await this.whenReady(),O(e.parent))throw new Q("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return e.parent.type==="analysis"?(await this.whenLayerView(e.parent)).whenAnalysisView(e):this.analysisViewManager.whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then(()=>{const t=BZe(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(qZe(t,this.supersampleScreenshotsEnabled,this.padding))})}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return gJ.importLayerView(e)}hasLayerViewModule(e){return gJ.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i,r;return this.map&&"initialViewProperties"in this.map&&((e=this.map)==null||(t=e.initialViewProperties)==null?void 0:t.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=sut(this.type);if(ue("safari")&&ue("safari")<9&&(e=new Q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:ue("safari")})),_(e))throw Ol.warn("#validate()",e.message),e}get _predeterminedViewingMode(){var e,t;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(e=this.map&&"initialViewProperties"in this.map?(t=this.map.initialViewProperties)==null?void 0:t.viewingMode:null)!=null?e:null;return _(i)?pJ(i):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(_(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,$e.Local),s=this._validateSpatialReferenceForViewingMode(e,t,$e.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,$e.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,$e.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!BD(e,i)&&(!!O(t)||!!QX(t)||(!yA(t)||!O(GF(t,e,i)))&&(!JX(t)||i!==$e.Global))}_makeSpatialReferenceConstraints(e,t,i){if(O(t))return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return QX(t)&&(r||s)?!s||i===$e.Local||VF(t.tileInfo,t.fullExtent,e,$e.Global)===null?[{spatialReference:e,viewingMode:i},{spatialReference:tt.WebMercator,viewingMode:i}]:[{spatialReference:r?tt.WGS84:tt.WebMercator,viewingMode:i}]:yA(t)||JX(t)||!r&&!s?yA(t)&&r&&i!==$e.Global?[{spatialReference:e,viewingMode:i},{spatialReference:tt.WGS84,viewingMode:$e.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?tt.WGS84:tt.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=_(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(_(i)?Ol.warnOnce(`Spatial reference defined on view not supported in ${CA(i)} viewing mode.`):e.isGeographic&&Ol.warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}computeMapPointFromVec3d(e,t){let i=this.spatialReference||tt.WGS84;return yn(e,this.renderSpatialReference,e,i)||(i=tt.WGS84,yn(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new Ke(e,i),t}trackGraphicState(e){if(!e.graphic)return Ol.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=n=>{var o;!r&&_(n)&&"processor"in n&&((o=n.processor)==null?void 0:o.type)==="graphics-3d"&&n.processor.graphicsCore&&(i=n.processor.graphicsCore.trackGraphicState(e))};return _(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return Hx(e.map(i=>this.highlight(i)));if(pt.isCollection(e))return Hx(e.toArray().map(i=>this.highlight(i)));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):Sm()}maskOccludee(e){if(!e)return Ol.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=n=>{!r&&_(n)&&oke(n)&&(i=n.maskOccludee(e))};return _(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find(t=>t.layer===e.layer):null}graphicChanged(e){_(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await P$(()=>this.graphicsView),this.graphicsView;if(!e.layer||!this.map)throw new Q("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((i,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.indexOf(e.layer)!==-1&&(s.remove(),this.whenLayerView(e.layer).then(i,r))})}):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,qA.INCLUDE),i=this._externalToInternalRenderItems(e.exclude,qA.EXCLUDE);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(ew)?(t=this.computeMapPointFromVec3d(ew,t),e.intersector===lr.TERRAIN&&this.basemapTerrain&&(t.z=gt(Mh(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n=e[s],o=qre(n,this);if(_(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=Wre(n,this);if(!_(a))continue;if(O(r)&&s!==e.length-1&&(r=new Set),_(r)){const h=this._getGraphicFilterUid(a);if(r.has(h))continue;r.add(h)}if(!this._testGraphicUidFilter(t,a))continue;const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;i.push({graphic:a,mapPoint:l,distance:c})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return O(e)||(O(e.include)||e.include.has(i))&&(O(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){if(!e)return i;if(e instanceof Bo)xut(i,this._getGraphicFilterUid(e)),t===qA.INCLUDE&&(_(this.graphicsView)&&e.layer===this?B2(i,this.graphicsView.processor.layer.id):e.layer&&B2(i,e.layer.uid));else if(AEe(e))for(const r of e)r===this.graphics&&_(this.graphicsView)?B2(i,this.graphicsView.processor.layer.id):r instanceof aC?r===this.map.ground&&B2(i,v_):this._externalToInternalRenderItems(r,t,i);else B2(i,e.uid);return i}_initBasemapTerrain(){this._set("basemapTerrain",new Unt({view:this})),this._set("elevationProvider",new HE({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Cve({view:this})),this._set("featureTiles",new uve({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const t=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const i=_(this.basemapTerrain.extent)?RR(kL(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;_(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>hi.FEATURE_TILE_TREE_SHOW_TILES,t=>{t&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./FeatureTileTree3DDebugger.dc04ee0f.js")).then(({FeatureTileTree3DDebugger:i})=>{!this.featureTreeDebugger&&hi.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new i({view:this}))}):t||!this.featureTreeDebugger||hi.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)},Yl),this.updatingHandles.add(()=>this.clippingArea,e,Yl),this.updatingHandles.add(()=>this.basemapTerrain.extent,e,Yl)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new iit(this.map,e));const t=this.state.isGlobal,i=lce(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",hL.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",r=>{const s=this.renderCoordsHelper.spatialReference;r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!sN(r,this.basemapTerrain.spatialReference,Kre,s)||(this.renderCoordsHelper.extent=Kre)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(kT/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){_(e)&&e.type===Si.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(t=>{t.destroyed||(this.handles.add([t.watch(["updating","updatingProgress"],()=>this._updatingChanged(),!0)],"updatingMonitors"),t.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(a,l)=>this._renderScreenshotOverlay(a,l)}},t=new Vtt(this.state.viewingMode,a=>this._stage.layers.forAll(a),this);this._set("sceneIntersectionHelper",t);const i=QL(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new ia({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:n}),this._stage.renderView.setRenderParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=gR(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new Q("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),un),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,()=>this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency}),un),Nt(()=>this.magnifier,a=>this._stage.renderView.magnifier=a,Yl)],"stage");const o=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:l9.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],o),"stage"),o(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(kT/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Hit({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new jet})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("./GraphicsView3D.f5bd8c9f.js")).default;Jt(e),await P$(()=>{var i;return((i=this.basemapTerrain)==null?void 0:i.ready)===!0},e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),_(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=pJ(this.viewingMode);if(e===$e.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(Tx(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(i=>i(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(v_);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(v_);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}getVoxelWasmPerSceneView(){return ex.getInstance().getVoxelWasmPerSceneView(this)}};function B2(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function xut(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function l3(e,t){return _(e)&&hT(e.spatialReference,t)?RR(e,t):null}var qA;u([d()],Je.prototype,"_userClippingArea",void 0),u([d()],Je.prototype,"_resourceController",void 0),u([d()],Je.prototype,"_stage",void 0),u([d({readOnly:!0})],Je.prototype,"deconflictor",void 0),u([d({readOnly:!0})],Je.prototype,"labeler",void 0),u([d(V6(yT,"analyses"))],Je.prototype,"analyses",void 0),u([d({type:ST,readOnly:!0,aliasOf:"state.animation"})],Je.prototype,"animation",void 0),u([d({readOnly:!0})],Je.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],Je.prototype,"elevationProvider",void 0),u([d({type:ml,aliasOf:"stateManager.camera"})],Je.prototype,"camera",void 0),u([d({type:ml,aliasOf:"stateManager.contentCamera"})],Je.prototype,"contentCamera",void 0),u([d({readOnly:!0})],Je.prototype,"canvas",void 0),u([d({type:Ke,aliasOf:"stateManager.center"})],Je.prototype,"center",void 0),u([d({type:Zt})],Je.prototype,"clippingArea",null),u([d({type:Qpe})],Je.prototype,"constraints",void 0),u([d({type:Zt,readOnly:!0})],Je.prototype,"renderDataExtent",null),u([d({type:Zt,readOnly:!0})],Je.prototype,"dataExtent",null),u([d({type:Zt,readOnly:!0})],Je.prototype,"groundAndLayersExtent",null),u([d({value:null,type:Nw})],Je.prototype,"environment",null),u([It("environment")],Je.prototype,"castEnvironment",null),u([d({readOnly:!0})],Je.prototype,"environmentManager",void 0),u([d({type:Zt,aliasOf:"stateManager.extent"})],Je.prototype,"extent",void 0),u([d()],Je.prototype,"floors",void 0),u([d({readOnly:!0,aliasOf:"stateManager.screenCenter"})],Je.prototype,"screenCenter",void 0),u([d({type:Number})],Je.prototype,"pixelRatio",null),u([d({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],Je.prototype,"maximumPixelRatio",null),u([d({aliasOf:"stateManager.frustum"})],Je.prototype,"frustum",void 0),u([d({type:Number,readOnly:!0})],Je.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],Je.prototype,"graphicsView",void 0),u([d({readOnly:!0})],Je.prototype,"analysisViewManager",void 0),u([d()],Je.prototype,"groundView",void 0),u([d({type:Boolean})],Je.prototype,"initialExtentRequired",null),u([d()],Je.prototype,"_defaultsFromMapSettings",null),u([d({type:Boolean,readOnly:!0})],Je.prototype,"interacting",null),u([d()],Je.prototype,"stationary",null),u([d({aliasOf:"state.navigating"})],Je.prototype,"navigating",void 0),u([d()],Je.prototype,"map",void 0),u([d({readOnly:!0})],Je.prototype,"mapCoordsHelper",void 0),u([d({aliasOf:"stateManager.padding"})],Je.prototype,"padding",void 0),u([d({type:Cve,readOnly:!0})],Je.prototype,"pointsOfInterest",void 0),u([d({type:uve,readOnly:!0})],Je.prototype,"featureTiles",void 0),u([d()],Je.prototype,"featureTreeDebugger",void 0),u([d({type:Boolean})],Je.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],Je.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],Je.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],Je.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],Je.prototype,"state",void 0),u([d({readOnly:!0})],Je.prototype,"inputManager",void 0),u([d({readOnly:!0})],Je.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],Je.prototype,"qualityProfile",null),u([d({type:Jte,get(){let e=this._get("qualitySettings");return e||(e=new Jte,VI.apply(this.qualityProfile,e)),e}})],Je.prototype,"qualitySettings",void 0),u([d()],Je.prototype,"slicePlane",null),u([d({readOnly:!0})],Je.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],Je.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],Je.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Je.prototype,"resolution",null),u([d({type:Number,aliasOf:"stateManager.scale"})],Je.prototype,"scale",void 0),u([d()],Je.prototype,"heightModelInfo",null),u([d()],Je.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],Je.prototype,"alphaCompositingEnabled",void 0),u([d({type:Boolean})],Je.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],Je.prototype,"type",void 0),u([d({type:j_e})],Je.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],Je.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],Je.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],Je.prototype,"viewingMode",null),u([d({type:Vh,aliasOf:"stateManager.viewpoint"})],Je.prototype,"viewpoint",void 0),u([d({type:Number,aliasOf:"stateManager.zoom"})],Je.prototype,"zoom",void 0),u([d({type:l9})],Je.prototype,"highlightOptions",void 0),Je=u([P("esri.views.SceneView")],Je),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(qA||(qA={}));const ew=M(),qk=Cr(),Kre=Dt(),Sft=Je;export{sCe as $,qpt as A,gj as B,JHe as C,vm as D,pa as E,pt as F,Nt as G,Sm as H,Upt as I,Zpt as J,Q as K,XNe as L,lpt as M,XL as N,cpt as O,un as P,CR as Q,upt as R,q1 as S,HG as T,Yl as U,ER as V,tpe as W,hSe as X,apt as Y,wr as Z,Npt as _,Sy as a,W1 as a$,vl as a0,gp as a1,Aet as a2,rWe as a3,Bh as a4,Jt as a5,I9 as a6,ue as a7,_ht as a8,he as a9,_S as aA,ut as aB,Ys as aC,qye as aD,Sa as aE,Vr as aF,Vut as aG,Kl as aH,hn as aI,Jy as aJ,bs as aK,Eh as aL,kce as aM,oe as aN,yn as aO,pe as aP,ae as aQ,Ke as aR,Xl as aS,oM as aT,Lpt as aU,DX as aV,Mpt as aW,nWe as aX,WL as aY,hT as aZ,Eut as a_,Ou as aa,Bn as ab,lT as ac,z4e as ad,gt as ae,Ui as af,OG as ag,ne as ah,hp as ai,Tu as aj,M as ak,os as al,w0 as am,Zt as an,TT as ao,$t as ap,jpt as aq,Gpt as ar,nft as as,eq as at,Vpt as au,Bpt as av,S7 as aw,mp as ax,X$ as ay,Wt as az,H1 as b,eit as b$,Cet as b0,kH as b1,cp as b2,pj as b3,xs as b4,vR as b5,Dt as b6,cve as b7,bht as b8,_r as b9,Srt as bA,xrt as bB,Ert as bC,Tx as bD,yR as bE,Ls as bF,Bf as bG,l1 as bH,Wa as bI,zL as bJ,or as bK,E as bL,Ase as bM,z_ as bN,ZL as bO,hi as bP,co as bQ,pi as bR,kut as bS,Gt as bT,Kr as bU,lt as bV,Jr as bW,qT as bX,wpt as bY,R3 as bZ,z1 as b_,sN as ba,bpt as bb,i0 as bc,fht as bd,jy as be,WW as bf,CG as bg,Xet as bh,di as bi,Iut as bj,ise as bk,ese as bl,Vht as bm,RR as bn,Tpt as bo,Roe as bp,bl as bq,Ese as br,Em as bs,B1 as bt,tc as bu,Z5e as bv,gD as bw,Ci as bx,gl as by,Gn as bz,rp as c,z1e as c$,Ri as c0,Un as c1,x as c2,Rr as c3,As as c4,yc as c5,j as c6,WD as c7,Rp as c8,gc as c9,oF as cA,rF as cB,ye as cC,$1 as cD,vF as cE,zWe as cF,MH as cG,AR as cH,Rm as cI,Pqe as cJ,vs as cK,oN as cL,oo as cM,Zne as cN,iht as cO,FTe as cP,$4e as cQ,Hx as cR,Pve as cS,uc as cT,TEe as cU,Gh as cV,Te as cW,Iqe as cX,Vnt as cY,i_e as cZ,qht as c_,Ee as ca,Y as cb,$i as cc,at as cd,dr as ce,Li as cf,Vi as cg,Oi as ch,mi as ci,xl as cj,Um as ck,Op as cl,rb as cm,Rt as cn,km as co,zN as cp,O0 as cq,Aa as cr,nF as cs,Ft as ct,vp as cu,b0 as cv,P0 as cw,lF as cx,Du as cy,Zh as cz,d,$Ae as d$,Lut as d0,$ut as d1,q1e as d2,W1e as d3,tt as d4,KL as d5,lYe as d6,Sne as d7,Pfe as d8,Wj as d9,G5e as dA,pse as dB,BL as dC,ZW as dD,ic as dE,Doe as dF,rl as dG,zm as dH,Rve as dI,xL as dJ,e1 as dK,UAe as dL,lr as dM,Apt as dN,wft as dO,YN as dP,pT as dQ,hB as dR,Cge as dS,wl as dT,Rot as dU,RS as dV,Ght as dW,sot as dX,Vx as dY,j_ as dZ,ur as d_,gft as da,xft as db,Ofe as dc,HR as dd,lp as de,Ky as df,hr as dg,ni as dh,br as di,Ue as dj,Ooe as dk,Fe as dl,mr as dm,spt as dn,ZZ as dp,mm as dq,B5e as dr,ape as ds,K5e as dt,G4e as du,vFe as dv,Wde as dw,UL as dx,ht as dy,si as dz,u as e,i1 as e$,Eu as e0,om as e1,Wht as e2,mn as e3,um as e4,zo as e5,nS as e6,At as e7,wde as e8,xde as e9,fa as eA,lqe as eB,bft as eC,Ny as eD,VCe as eE,ko as eF,xi as eG,_e as eH,Fo as eI,de as eJ,yI as eK,Jd as eL,xSe as eM,xpt as eN,sit as eO,Mht as eP,fm as eQ,_Ce as eR,bCe as eS,Ge as eT,jht as eU,ui as eV,$9 as eW,Qw as eX,rA as eY,bc as eZ,Jf as e_,kpt as ea,Bae as eb,J6 as ec,wSe as ed,x4 as ee,ze as ef,ai as eg,Q1 as eh,aht as ei,se as ej,ve as ek,l7 as el,Pe as em,_c as en,Wi as eo,Tft as ep,Spt as eq,Qx as er,Ai as es,Pht as et,yu as eu,OL as ev,GC as ew,xc as ex,zpt as ey,wme as ez,aS as f,JA as f$,$X as f0,hc as f1,OUe as f2,tht as f3,F7 as f4,dm as f5,xne as f6,Txe as f7,YY as f8,_dt as f9,UG as fA,u1 as fB,nC as fC,wy as fD,oc as fE,E2e as fF,oT as fG,SL as fH,vMe as fI,r0 as fJ,Cht as fK,_l as fL,_Ne as fM,bNe as fN,IR as fO,pS as fP,kue as fQ,Ipt as fR,D4e as fS,npt as fT,$1e as fU,hdt as fV,lht as fW,rht as fX,nht as fY,sht as fZ,oht as f_,Cdt as fa,Odt as fb,Jue as fc,ehe as fd,Zue as fe,LIe as ff,cht as fg,Cpt as fh,Gne as fi,Zxe as fj,Jut as fk,zxe as fl,qxe as fm,k_ as fn,the as fo,qne as fp,xR as fq,Qut as fr,x0 as fs,uj as ft,ZNe as fu,nT as fv,Sut as fw,Kut as fx,Aht as fy,Hse as fz,Bo as g,ii as g$,wu as g0,NTe as g1,JL as g2,sye as g3,Rpt as g4,YHe as g5,$pt as g6,yht as g7,Nut as g8,pft as g9,Oht as gA,XW as gB,Rdt as gC,Ydt as gD,Zoe as gE,h1 as gF,H8 as gG,yi as gH,ln as gI,ddt as gJ,pdt as gK,oi as gL,mft as gM,yft as gN,vht as gO,ISe as gP,r_ as gQ,fft as gR,ZD as gS,Yh as gT,Fm as gU,Di as gV,gn as gW,nt as gX,wht as gY,BR as gZ,fi as g_,pht as ga,kL as gb,$e as gc,D3e as gd,Dpt as ge,sr as gf,P$ as gg,$ue as gh,Gde as gi,uXe as gj,ph as gk,et as gl,ble as gm,Xht as gn,uce as go,Xpt as gp,$L as gq,bdt as gr,Rut as gs,Qs as gt,iq as gu,wa as gv,Si as gw,Ise as gx,Hne as gy,Uut as gz,we as h,jut as h$,lo as h0,Poe as h1,vft as h2,_ft as h3,RG as h4,LCe as h5,De as h6,Pp as h7,iN as h8,v0 as h9,_ie as hA,Yre as hB,rle as hC,q6 as hD,Ir as hE,H6 as hF,X6 as hG,k$ as hH,rCe as hI,Ze as hJ,Ie as hK,yt as hL,X_ as hM,$ae as hN,Xd as hO,cft as hP,dft as hQ,Ove as hR,uie as hS,lft as hT,uft as hU,aft as hV,fL as hW,K3 as hX,crt as hY,Ve as hZ,xa as h_,Tt as ha,as as hb,jt as hc,ri as hd,sft as he,Oue as hf,R3e as hg,Hle as hh,xbe as hi,ED as hj,yO as hk,ao as hl,po as hm,aj as hn,ANe as ho,Kt as hp,ex as hq,Mx as hr,cm as hs,ML as ht,KG as hu,Lxe as hv,je as hw,eX as hx,Wx as hy,zce as hz,NL as i,t1 as i$,XH as i0,lu as i1,lie as i2,zit as i3,Bit as i4,It as i5,Gr as i6,pG as i7,hG as i8,dG as i9,Fw as iA,ACe as iB,Fs as iC,Ss as iD,aa as iE,eG as iF,Gy as iG,J_ as iH,Qd as iI,Kze as iJ,Am as iK,h7 as iL,mT as iM,er as iN,TC as iO,ps as iP,mA as iQ,lN as iR,Qht as iS,Yx as iT,Jht as iU,n6e as iV,c6e as iW,Bht as iX,Vn as iY,Nm as iZ,Ar as i_,qD as ia,ypt as ib,kh as ic,BRe as id,cCe as ie,Zut as ig,lCe as ih,be as ii,dt as ij,f1 as ik,Xe as il,ac as im,Hht as io,Wut as ip,tr as iq,Xut as ir,Px as is,gz as it,jT as iu,Ct as iv,Mh as iw,Lae as ix,lAe as iy,vi as iz,rze as j,zn as j$,Qpt as j0,zTe as j1,Hut as j2,gs as j3,Nht as j4,Lht as j5,yAe as j6,mAe as j7,Pae as j8,Fht as j9,N1 as jA,dl as jB,Nr as jC,qut as jD,Cte as jE,eN as jF,Cut as jG,Zht as jH,Fn as jI,zf as jJ,Yht as jK,Ame as jL,D_e as jM,B$ as jN,Xct as jO,Wre as jP,X9 as jQ,Ts as jR,ght as jS,mht as jT,xu as jU,Tg as jV,Qk as jW,bp as jX,nG as jY,ou as jZ,S0 as j_,G6 as ja,zht as jb,kht as jc,Uht as jd,Nn as je,vN as jf,cdt as jg,udt as jh,adt as ji,ldt as jj,_h as jk,tl as jl,$j as jm,Ij as jn,aSe as jo,Cr as jp,Le as jq,Yut as jr,Pxe as js,Lr as jt,Bm as ju,cl as jv,wq as jw,jtt as jx,mx as jy,J8 as jz,DA as k,BB as k$,R0 as k0,aF as k1,nJ as k2,hL as k3,pl as k4,zCe as k5,Y1 as k6,uC as k7,gRe as k8,gm as k9,tft as kA,wAe as kB,Kpt as kC,cQe as kD,pQe as kE,uQe as kF,hQe as kG,dQe as kH,jue as kI,zue as kJ,mdt as kK,Edt as kL,Sdt as kM,Gue as kN,fI as kO,Kde as kP,edt as kQ,M3e as kR,rhe as kS,ihe as kT,xdt as kU,wdt as kV,uht as kW,hht as kX,dht as kY,mxe as kZ,Ppt as k_,uN as ka,OAe as kb,OR as kc,STe as kd,Eht as ke,ILe as kf,M5e as kg,P5e as kh,I5e as ki,Cfe as kj,Rfe as kk,T0 as kl,nl as km,Vo as kn,jr as ko,nO as kp,j6 as kq,ss as kr,lq as ks,sl as kt,qAe as ku,eft as kv,OT as kw,I1 as kx,Ti as ky,Jpt as kz,Qe as l,zh as l$,Opt as l0,va as l1,vIe as l2,lFe as l3,mTe as l4,tIe as l5,Mdt as l6,dIe as l7,GY as l8,Bue as l9,D9 as lA,cie as lB,wc as lC,o$e as lD,F3e as lE,Woe as lF,YT as lG,XFe as lH,J4e as lI,n5e as lJ,Lde as lK,lrt as lL,sC as lM,lS as lN,H4e as lO,Dut as lP,QNe as lQ,But as lR,oft as lS,ns as lT,Jtt as lU,xve as lV,U3e as lW,ON as lX,Tde as lY,Ih as lZ,kNe as l_,Adt as la,LEe as lb,Ap as lc,Xdt as ld,PQ as le,Y4 as lf,Z4 as lg,Zk as lh,nu as li,D1e as lj,Out as lk,Mut as ll,Qa as lm,fdt as ln,Ja as lo,Tdt as lp,wN as lq,Ht as lr,Ey as ls,$ht as lt,Iht as lu,h2e as lv,C$ as lw,NG as lx,hft as ly,Za as lz,Sft as m,ude as m$,HL as m0,eae as m1,zi as m2,ws as m3,Put as m4,zR as m5,GFe as m6,gFe as m7,Zdt as m8,qdt as m9,Wce as mA,UMe as mB,ndt as mC,sdt as mD,idt as mE,la as mF,ca as mG,io as mH,fl as mI,Cp as mJ,j3 as mK,gC as mL,sj as mM,hD as mN,U9 as mO,Zw as mP,Qr as mQ,tNe as mR,Hy as mS,No as mT,KLe as mU,Su as mV,XLe as mW,jLe as mX,GLe as mY,v1 as mZ,Wl as m_,g2e as ma,mFe as mb,rS as mc,Qdt as md,ift as me,$Qe as mf,oC as mg,uA as mh,A6 as mi,Jdt as mj,ul as mk,Ra as ml,le as mm,lf as mn,dB as mo,Cue as mp,nse as mq,xx as mr,Boe as ms,Tht as mt,gR as mu,jL as mv,Rht as mw,odt as mx,rdt as my,tdt as mz,P as n,a_e as n$,R$e as n0,FLe as n1,zLe as n2,zt as n3,cde as n4,sc as n5,eNe as n6,YLe as n7,J1 as n8,aG as n9,Hdt as nA,BLe as nB,VLe as nC,kLe as nD,ULe as nE,rx as nF,Cnt as nG,E6e as nH,IBe as nI,fu as nJ,nVe as nK,uVe as nL,Hh as nM,dVe as nN,Jl as nO,PVe as nP,zVe as nQ,Bge as nR,Kje as nS,XD as nT,pYe as nU,yYe as nV,GXe as nW,ya as nX,tYe as nY,tnt as nZ,ant as n_,iNe as na,rNe as nb,sNe as nc,ij as nd,oNe as ne,nNe as nf,aNe as ng,Koe as nh,mC as ni,$Le as nj,JLe as nk,ZLe as nl,HLe as nm,gNe as nn,pNe as no,dNe as np,Bdt as nq,fNe as nr,mNe as ns,qLe as nt,WLe as nu,k9 as nv,QLe as nw,uNe as nx,H7 as ny,mW as nz,it as o,Y4e as o$,Iot as o0,Nat as o1,rpt as o2,ipt as o3,OO as o4,S4 as o5,USe as o6,KBe as o7,Aye as o8,Xqe as o9,Tm as oA,Hat as oB,a$e as oC,NFe as oD,z3e as oE,cc as oF,DG as oG,Oc as oH,lQe as oI,yl as oJ,Wpt as oK,aXe as oL,flt as oM,FWe as oN,EZe as oO,mQe as oP,OKe as oQ,QKe as oR,HKe as oS,P4e as oT,h5e as oU,u5e as oV,woe as oW,zFe as oX,Sae as oY,opt as oZ,W4e as o_,mpt as oa,fpt as ob,dpt as oc,Jw as od,$Ue as oe,ppt as of,gpt as og,PUe as oh,TR as oi,DYe as oj,vpt as ok,_pt as ol,tpt as om,vc as on,mXe as oo,Lh as op,KD as oq,OXe as or,il as os,uat as ot,Dn as ou,xm as ov,Aat as ow,JF as ox,Nh as oy,Gat as oz,HW as p,V6 as p$,jFe as p0,yj as p1,qFe as p2,WFe as p3,s0 as p4,ize as p5,Kke as p6,HQ as p7,Ta as p8,QA as p9,_Ie as pA,Kbe as pB,Y5e as pC,UR as pD,Bi as pE,SNe as pF,vde as pG,XUe as pH,zNe as pI,YUe as pJ,Mde as pK,fD as pL,Gut as pM,fde as pN,mD as pO,HFe as pP,bR as pQ,eht as pR,Fut as pS,Kht as pT,F1 as pU,z9 as pV,fw as pW,W5e as pX,ql as pY,a$ as pZ,AA as p_,q4e as pa,Xh as pb,YL as pc,oS as pd,t5e as pe,I4e as pf,L4e as pg,f5e as ph,kW as pi,Yne as pj,k5e as pk,Xde as pl,Sj as pm,bQ as pn,aI as po,$de as pp,j4e as pq,Ej as pr,npe as ps,Ade as pt,mt as pu,V1 as pv,Xx as pw,Jk as px,vdt as py,wIe as pz,aT as q,ECe as q$,UW as q0,Rpe as q1,dp as q2,ap as q3,foe as q4,B_ as q5,Aut as q6,bFe as q7,cI as q8,mQ as q9,D5e as qA,L5e as qB,N5e as qC,Vdt as qD,zdt as qE,MZ as qF,Idt as qG,OZ as qH,cNe as qI,kdt as qJ,jdt as qK,Gdt as qL,y1 as qM,Ddt as qN,$dt as qO,Ldt as qP,Ndt as qQ,Udt as qR,NLe as qS,IZ as qT,Fdt as qU,lNe as qV,RN as qW,dde as qX,pde as qY,Sp as qZ,yBe as q_,rC as qa,dj as qb,Q4e as qc,Z4e as qd,ZT as qe,xae as qf,Kdt as qg,iS as qh,xht as qi,Jct as qj,X4e as qk,ept as ql,Rwe as qm,zut as qn,D as qo,Dht as qp,Ypt as qq,wst as qr,Wve as qs,jve as qt,Yv as qu,$q as qv,Iq as qw,Lst as qx,Pdt as qy,Dq as qz,_ as r,TCe as r0,Kd as r1,I0e as r2,kse as r3,aBe as r4,Sht as r5,G0e as r6,H0e as r7,UA as r8,x_ as r9,Fpt as rA,rft as rB,Js as ra,Ca as rb,Ru as rc,Lb as rd,BQe as re,U0e as rf,V0e as rg,z0e as rh,zQe as ri,i9 as rj,B0e as rk,d0 as rl,NQe as rm,h0 as rn,j8 as ro,E1 as rp,cWe as rq,mJe as rr,fJe as rs,pJe as rt,Ept as ru,W2e as rv,gdt as rw,ydt as rx,Wdt as ry,hpt as rz,qt as s,O as t,Bt as u,dc as v,CT as w,cFe as x,vr as y,Hpt as z};
